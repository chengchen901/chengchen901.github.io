<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>MapReduce | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="MapReduce简介什么是MapReduce？一种大规模数据处理的编程模型 源自于2004年Google发布的论文 MapReduce in Hadoop 开源社区实现版本，核心代码使用Java实现  MapReduce计算场景数据查找  分布式Grep  Web访问日志分析  词频统计 网站PV UV统计 Top K问题  倒排索引  建立搜索引擎索引  分布式排序 MapReduce优点和缺">
<meta property="og:type" content="article">
<meta property="og:title" content="MapReduce">
<meta property="og:url" content="http://example.com/2020/08/15/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/03-MapReduce/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="MapReduce简介什么是MapReduce？一种大规模数据处理的编程模型 源自于2004年Google发布的论文 MapReduce in Hadoop 开源社区实现版本，核心代码使用Java实现  MapReduce计算场景数据查找  分布式Grep  Web访问日志分析  词频统计 网站PV UV统计 Top K问题  倒排索引  建立搜索引擎索引  分布式排序 MapReduce优点和缺">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220141243.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211213164314.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128105346.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128110320.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128110623.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128112253.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128112413.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128113807.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114319.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114656.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114926.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128120545.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128120722.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/1638075688(1).jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128181135.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128191930.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192223.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192307.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192405.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232306.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232618.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232940.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205201605.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205203034.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204416.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204500.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204639.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204659.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211022.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211440.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211511.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211642.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211742.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207132715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207201017.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207204931.png">
<meta property="article:published_time" content="2020-08-15T08:50:45.000Z">
<meta property="article:modified_time" content="2022-02-20T06:13:05.686Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="MapReduce">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220141243.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-13-大数据/01-基础及安装/03-MapReduce" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/15/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/03-MapReduce/" class="article-date">
  <time class="dt-published" datetime="2020-08-15T08:50:45.000Z" itemprop="datePublished">2020-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      MapReduce
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="MapReduce简介"><a href="#MapReduce简介" class="headerlink" title="MapReduce简介"></a>MapReduce简介</h1><h2 id="什么是MapReduce？"><a href="#什么是MapReduce？" class="headerlink" title="什么是MapReduce？"></a>什么是MapReduce？</h2><p>一种大规模数据处理的编程模型</p>
<p>源自于2004年Google发布的论文</p>
<p><strong>MapReduce in Hadoop</strong></p>
<p>开源社区实现版本，核心代码使用Java实现</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220141243.png"></p>
<h2 id="MapReduce计算场景"><a href="#MapReduce计算场景" class="headerlink" title="MapReduce计算场景"></a>MapReduce计算场景</h2><p><strong>数据查找</strong></p>
<ul>
<li>分布式Grep</li>
</ul>
<p><strong>Web访问日志分析</strong></p>
<ul>
<li>词频统计</li>
<li>网站PV UV统计</li>
<li>Top K问题</li>
</ul>
<p><strong>倒排索引</strong></p>
<ul>
<li>建立搜索引擎索引</li>
</ul>
<p><strong>分布式排序</strong></p>
<h2 id="MapReduce优点和缺点"><a href="#MapReduce优点和缺点" class="headerlink" title="MapReduce优点和缺点"></a>MapReduce优点和缺点</h2><p><strong>优点</strong></p>
<ol>
<li>模型简单，Map + Reduce</li>
<li>高伸缩性，支持横向扩展</li>
<li>灵活，结构化和非结构化数据</li>
<li>速度快，高吞吐离线处理数据</li>
<li>并行处理，编程模型天然支持并行处理</li>
<li>容错能力强</li>
</ol>
<p><strong>缺点</strong></p>
<ol>
<li>流式数据-MapReduce处理模型就决定了需要静态数据</li>
<li>实时计算-不适合低延迟数据处理，需要毫秒级别响应</li>
<li>复杂算法-例如SVM支持向量机</li>
<li>迭代计算-例如斐波那契数列</li>
</ol>
<h1 id="MapReduce编程模型"><a href="#MapReduce编程模型" class="headerlink" title="MapReduce编程模型"></a>MapReduce编程模型</h1><h2 id="如何统计一个文本中单词的出现次数？"><a href="#如何统计一个文本中单词的出现次数？" class="headerlink" title="如何统计一个文本中单词的出现次数？"></a>如何统计一个文本中单词的出现次数？</h2><h3 id="Bash命令实现"><a href="#Bash命令实现" class="headerlink" title="Bash命令实现"></a>Bash命令实现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tr</span> -s <span class="string">&quot; &quot;</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="built_in">sort</span> file</span><br><span class="line"><span class="built_in">uniq</span> –c</span><br><span class="line"><span class="built_in">cat</span> wordcount.txt | <span class="built_in">tr</span> -s <span class="string">&quot; &quot;</span> <span class="string">&quot;\n&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure>

<h3 id="单机版实现"><a href="#单机版实现" class="headerlink" title="单机版实现"></a>单机版实现</h3><p>使用HashMap统计</p>
<h2 id="如果数据量极大如何在分布式的机器上计算？"><a href="#如果数据量极大如何在分布式的机器上计算？" class="headerlink" title="如果数据量极大如何在分布式的机器上计算？"></a>如果数据量极大如何在分布式的机器上计算？</h2><p>MapReduce使用了分治思想简化了计算处理模型为两步：</p>
<ol>
<li>Map阶段，获得输入数据，对输入数据进行转换并输出</li>
<li>Reduce阶段，对输出结果进行聚合计算</li>
</ol>
<h2 id="MapReduce-Map"><a href="#MapReduce-Map" class="headerlink" title="MapReduce-Map"></a>MapReduce-Map</h2><p>目标：∑sin(x)</p>
<p>对输入数据集的每个值都执行函数以创建新的结果集合</p>
<p>例如：</p>
<ul>
<li>输入数据[1,2,3,4,5,6,7,8,9,10]</li>
<li>定义Map方法需要执行的变换为f(x)&#x3D;sin(x)</li>
<li>则输出结果为[0.84,0.91,0.14,-0.76,-0.96,-0.28,0.66,0.99,0.41,-0.54]</li>
</ul>
<p>形式化的表达：</p>
<ul>
<li>each &lt;key, value&gt; in input</li>
<li>map &lt;key, value&gt; to &lt;intermediate key, intermediate value&gt;</li>
</ul>
<p>map(𝑥) &#x3D; sin 𝑥</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211213164314.png"></p>
<h2 id="MapReduce-Reduce"><a href="#MapReduce-Reduce" class="headerlink" title="MapReduce-Reduce"></a>MapReduce-Reduce</h2><p>对Map输出的结果进行聚合，输出一个或者多个聚合结果</p>
<p>例如：</p>
<ul>
<li>Map的输出结果为[0.84,0.91,0.14,-0.76,-0.96,-0.28,0.66,0.99,0.41,-0.54]</li>
<li>使用求和+作为聚合方法</li>
<li>则输出结果为[1.41]</li>
</ul>
<p>形式化的表达：</p>
<ul>
<li>each &lt;intermediate key, List&lt; intermediate value&gt;&gt; in input</li>
<li>reduce&lt;reduce key, reduce value&gt;</li>
</ul>
<p>reduce 𝑥 &#x3D; ∑𝑥𝑖</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128105346.png"></p>
<p>相同的key会被划分到同一个Reduce上</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128110320.png"></p>
<h2 id="Word-Count-Example"><a href="#Word-Count-Example" class="headerlink" title="Word Count Example"></a>Word Count Example</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128110623.png"></p>
<h2 id="Map-数据输入"><a href="#Map-数据输入" class="headerlink" title="Map 数据输入"></a>Map 数据输入</h2><p>Map阶段由一定的数量的Map Task组成</p>
<p>文件分片</p>
<ul>
<li>输入数据会被split切分为多份</li>
<li>HDFS默认Block大小<ul>
<li>Hadoop 1.0 &#x3D; 64MB</li>
<li>Hadoop 2.0 &#x3D; 128MB</li>
</ul>
</li>
<li>默认将文件解析为&lt;key, value&gt;对的实现是TextInputFormat<ul>
<li>key为偏移量</li>
<li>value为每一行内容</li>
</ul>
</li>
<li>因此有多少个Map Task任务?<ul>
<li>一个split一个Map Task，默认情况下一个block对应一个split</li>
<li>例如一个文件大小为10TB，block大小设置为128MB，则一共会有81920个Map Task任务（10 * 1024 * 1024 &#x2F; 128 &#x3D; 81920）</li>
</ul>
</li>
</ul>
<h2 id="Reduce-数据输入"><a href="#Reduce-数据输入" class="headerlink" title="Reduce 数据输入"></a>Reduce 数据输入</h2><ul>
<li>Partitioner决定了哪个Reduce会接收到Map输出的&lt;key, value&gt;对</li>
<li>在Hadoop中默认的Partitioner实现为HashPartitioner</li>
<li>计算公式<ul>
<li>Abs(Hash(key)) mod NR 其中 NR等于Reduce Task数目</li>
</ul>
</li>
<li>Partitioner可以自定义，例如，有3个Reduce Task，那么Partitioner会返回0 ~ 2</li>
</ul>
<h2 id="MapReduce-Shuffle"><a href="#MapReduce-Shuffle" class="headerlink" title="MapReduce-Shuffle"></a>MapReduce-Shuffle</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128112253.png"></p>
<h2 id="Word-Count中的shuffle"><a href="#Word-Count中的shuffle" class="headerlink" title="Word Count中的shuffle"></a>Word Count中的shuffle</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128112413.png"></p>
<h2 id="Shuffle"><a href="#Shuffle" class="headerlink" title="Shuffle"></a>Shuffle</h2><ul>
<li><p>为何需要shuffle</p>
<p>Reduce阶段的数据来源于不同的Map</p>
</li>
<li><p>Shuffle由Map端和Reduce端组成</p>
</li>
<li><p>Shuffle的核心机制</p>
<p>数据分区+排序</p>
</li>
<li><p>Map端</p>
<p>对Map输出结果进行spill（溢写）</p>
</li>
<li><p>Reduce端</p>
<p>拷贝Map端输出结果到本地</p>
<p>对拷贝的数据进行归并排序</p>
</li>
</ul>
<h2 id="Shuffle-Map端"><a href="#Shuffle-Map端" class="headerlink" title="Shuffle Map端"></a>Shuffle Map端</h2><p>Map端会源源不断的把数据输入到一个环形内存缓冲区</p>
<ul>
<li>MapTask.MapOutputBuffer</li>
</ul>
<p>达到一定阈值时</p>
<ul>
<li>默认0.8</li>
<li>唤醒后台溢出线程</li>
<li>内存缓冲区中的数据会溢出到磁盘</li>
</ul>
<p>在溢出的过程中</p>
<ul>
<li>调用Partitioner进行分组</li>
<li>对于每个组，按照Key进行排序</li>
</ul>
<p>Map处理完毕后</p>
<ul>
<li>对溢出到磁盘上的多个文件进行Merge操作</li>
<li>合并为一个大的文件和一个索引文件</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128113807.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114319.png"></p>
<h2 id="Shuffle-Reduce端"><a href="#Shuffle-Reduce端" class="headerlink" title="Shuffle Reduce端"></a>Shuffle Reduce端</h2><p>Map端完成之后会暴露一个Http Server共Reduce端获取数据</p>
<p>Reduce启动拷贝线程从各个Map端拷贝结果</p>
<ul>
<li>有大量的网络I&#x2F;O开销</li>
</ul>
<p>一边拷贝一边进行Merge操作（归并排序）</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114656.png"></p>
<h2 id="Combiner"><a href="#Combiner" class="headerlink" title="Combiner"></a>Combiner</h2><p>Map端本地Reducer</p>
<p>合并了Map端输出数据 &#x3D;&gt; 减少Http Traffic</p>
<p>Combiner可以自定义</p>
<p>例如Word Count中，对同一个Map输出的相同的key，直接对其value进行reduce</p>
<p>可以使用Combiner的前提</p>
<ul>
<li>满足结合律：求最大值、求和</li>
<li>不适用场景：计算平均数</li>
</ul>
<p>Combiner在Map什么阶段发生？</p>
<h2 id="Combiner-Example"><a href="#Combiner-Example" class="headerlink" title="Combiner Example"></a>Combiner Example</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128114926.png"></p>
<h1 id="MapReduce-应用-API介绍"><a href="#MapReduce-应用-API介绍" class="headerlink" title="MapReduce 应用 API介绍"></a>MapReduce 应用 API介绍</h1><h2 id="MapReduce-Java-API"><a href="#MapReduce-Java-API" class="headerlink" title="MapReduce Java API"></a>MapReduce Java API</h2><p>基于Hadoop 3.0.0版本</p>
<p>新版本API均在包org.apache.hadoop.mapreduce下面</p>
<p>编写MapReduce程序的核心</p>
<ul>
<li><p>继承Hadoop提供的Mapper类并实现其中的map方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mapper</span>&lt;KEYIN, VALUEIN, KEYOUT, VALUEOUT&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>继承Hadoop提供的Reducer类并实现其中的reduce方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reducer</span>&lt;KEYIN,VALUEIN, KEYOUT,VALUEOUT&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="WordCount-Mapper实现"><a href="#WordCount-Mapper实现" class="headerlink" title="WordCount Mapper实现"></a>WordCount Mapper实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TokenizerMapper</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, IntWritable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">IntWritable</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// StringTokenizer对读入的每行文本内容按空格进行切分</span></span><br><span class="line">        <span class="type">StringTokenizer</span> <span class="variable">itr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(value.toString());</span><br><span class="line">        <span class="comment">// 判断是否处理完一行文本</span></span><br><span class="line">        <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">            <span class="comment">// 处理每一个Token</span></span><br><span class="line">            word.set(itr.nextToken());</span><br><span class="line">            <span class="comment">// 每遇到一个单词就输出kv对，key=单词本身，value=出现次数1次</span></span><br><span class="line">            context.write(word, one);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128120545.png"></p>
<h2 id="WordCount-Reducer实现"><a href="#WordCount-Reducer实现" class="headerlink" title="WordCount Reducer实现"></a>WordCount Reducer实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">IntSumReducer</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, IntWritable, Text, IntWritable&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IntWritable</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span><br><span class="line"><span class="params">                       Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// Reduce进行累加即可获得统计结果</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">            sum += val.get();</span><br><span class="line">        &#125;</span><br><span class="line">        result.set(sum);</span><br><span class="line">        context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128120722.png"></p>
<h2 id="WordCount-Main方法实现"><a href="#WordCount-Main方法实现" class="headerlink" title="WordCount Main方法实现"></a>WordCount Main方法实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    <span class="comment">// 配置Job</span></span><br><span class="line">    <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;word count&quot;</span>);</span><br><span class="line">    job.setJarByClass(WordCount.class);</span><br><span class="line">    job.setMapperClass(TokenizerMapper.class);</span><br><span class="line">    <span class="comment">// 这里Combiner设置的类和Reducer一致</span></span><br><span class="line">    job.setCombinerClass(IntSumReducer.class);</span><br><span class="line">    job.setReducerClass(IntSumReducer.class);</span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(IntWritable.class);</span><br><span class="line">    <span class="comment">// 添加输入路径和输出路径</span></span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">    <span class="comment">// 向集群提交Job，并等待完成</span></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WordCount-编译和执行"><a href="#WordCount-编译和执行" class="headerlink" title="WordCount 编译和执行"></a>WordCount 编译和执行</h2><p>通过mvn compile package将code打包成jar</p>
<p>将example数据上传至HDFS</p>
<ul>
<li>hadoop fs -mkdir -p &#x2F;user&#x2F;cdh&#x2F;wordcount&#x2F;input</li>
<li>hadoop fs -put example.txt &#x2F;user&#x2F;cdh&#x2F;wordcount&#x2F;input</li>
</ul>
<p>使用hadoop jar命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar命令格式：hadoop jar &lt;job jar file path&gt; &lt;main class&gt; &lt;arg1&gt; &lt;arg2&gt; …</span><br><span class="line"></span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.WordCount /user/cdh/wordcount/input /user/cdh/wordcount/output</span><br></pre></td></tr></table></figure>

<h1 id="MapReduce-源代码解析"><a href="#MapReduce-源代码解析" class="headerlink" title="MapReduce 源代码解析"></a>MapReduce 源代码解析</h1><h2 id="Hadoop-Mapper-定义"><a href="#Hadoop-Mapper-定义" class="headerlink" title="Hadoop Mapper 定义"></a>Hadoop Mapper 定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mapper</span>&lt;KEYIN, VALUEIN, KEYOUT, VALUEOUT&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The &lt;code&gt;Context&lt;/code&gt; passed on to the &#123;<span class="doctag">@link</span> Mapper&#125; implementations.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Context</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">MapContext</span>&lt;KEYIN,VALUEIN,KEYOUT,VALUEOUT&gt; &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called once at the beginning of the task.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(Context context</span></span><br><span class="line"><span class="params">                       )</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">// NOTHING</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called once for each key/value pair in the input split. Most applications</span></span><br><span class="line"><span class="comment">   * should override this, but the default is the identity function.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(KEYIN key, VALUEIN value, </span></span><br><span class="line"><span class="params">                     Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    context.write((KEYOUT) key, (VALUEOUT) value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called once at the end of the task.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">(Context context</span></span><br><span class="line"><span class="params">                         )</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">// NOTHING</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Expert users can override this method for more complete control over the</span></span><br><span class="line"><span class="comment">   * execution of the Mapper.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    setup(context);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (context.nextKeyValue()) &#123;</span><br><span class="line">        map(context.getCurrentKey(), context.getCurrentValue(), context);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      cleanup(context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Hadoop-Reducer-定义"><a href="#Hadoop-Reducer-定义" class="headerlink" title="Hadoop Reducer 定义"></a>Hadoop Reducer 定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reducer</span>&lt;KEYIN,VALUEIN,KEYOUT,VALUEOUT&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The &lt;code&gt;Context&lt;/code&gt; passed on to the &#123;<span class="doctag">@link</span> Reducer&#125; implementations.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Context</span> </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">ReduceContext</span>&lt;KEYIN,VALUEIN,KEYOUT,VALUEOUT&gt; &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called once at the start of the task.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(Context context</span></span><br><span class="line"><span class="params">                       )</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">// NOTHING</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * This method is called once for each key. Most applications will define</span></span><br><span class="line"><span class="comment">   * their reduce class by overriding this method. The default implementation</span></span><br><span class="line"><span class="comment">   * is an identity function.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(KEYIN key, Iterable&lt;VALUEIN&gt; values, Context context</span></span><br><span class="line"><span class="params">                        )</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span>(VALUEIN value: values) &#123;</span><br><span class="line">      context.write((KEYOUT) key, (VALUEOUT) value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called once at the end of the task.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">(Context context</span></span><br><span class="line"><span class="params">                         )</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="comment">// NOTHING</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Advanced application writers can use the </span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> #run(org.apache.hadoop.mapreduce.Reducer.Context)&#125; method to</span></span><br><span class="line"><span class="comment">   * control how the reduce task works.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    setup(context);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (context.nextKey()) &#123;</span><br><span class="line">        reduce(context.getCurrentKey(), context.getValues(), context);</span><br><span class="line">        <span class="comment">// If a back up store is used, reset it</span></span><br><span class="line">        Iterator&lt;VALUEIN&gt; iter = context.getValues().iterator();</span><br><span class="line">        <span class="keyword">if</span>(iter <span class="keyword">instanceof</span> ReduceContext.ValueIterator) &#123;</span><br><span class="line">          ((ReduceContext.ValueIterator&lt;VALUEIN&gt;)iter).resetBackupStore();        </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      cleanup(context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Hadoop-Partitioner-定义和默认实现"><a href="#Hadoop-Partitioner-定义和默认实现" class="headerlink" title="Hadoop Partitioner 定义和默认实现"></a>Hadoop Partitioner 定义和默认实现</h2><p>Partitioner抽象类定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Partitioner</span>&lt;KEY, VALUE&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Get the partition number for a given key (hence record) given the total </span></span><br><span class="line"><span class="comment">   * number of partitions i.e. number of reduce-tasks for the job.</span></span><br><span class="line"><span class="comment">   *   </span></span><br><span class="line"><span class="comment">   * &lt;p&gt;Typically a hash function on a all or a subset of the key.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key the key to be partioned.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value the entry value.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> numPartitions the total number of partitions.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the partition number for the &lt;code&gt;key&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(KEY key, VALUE value, <span class="type">int</span> numPartitions)</span>;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认HashPartitioner实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashPartitioner</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">Partitioner</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Use &#123;<span class="doctag">@link</span> Object#hashCode()&#125; to partition. */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(K key, V value,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> numReduceTasks)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (key.hashCode() &amp; Integer.MAX_VALUE) % numReduceTasks;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Hadoop-InputFormat-定义和默认实现"><a href="#Hadoop-InputFormat-定义和默认实现" class="headerlink" title="Hadoop InputFormat 定义和默认实现"></a>Hadoop InputFormat 定义和默认实现</h2><table>
<thead>
<tr>
<th>输入格式</th>
<th>功能描述</th>
<th>键类型</th>
<th>值类型</th>
</tr>
</thead>
<tbody><tr>
<td>TextInputFormat</td>
<td>默认格式，读取文件行</td>
<td>行字节偏移量LongWritable</td>
<td>行的内容Text</td>
</tr>
<tr>
<td>KeyValueTextInputFormat</td>
<td>读取文件行把行解析成了键值对</td>
<td>第一个定义key&#x2F;value分隔符之前的所有字符Text</td>
<td>第一个定义key&#x2F;value分隔符之后的所有字符Text</td>
</tr>
<tr>
<td>SequenceFileInputFormat</td>
<td>Hadoop定义的高性能二进制格式</td>
<td>用户自定义</td>
<td>用户自定义</td>
</tr>
</tbody></table>
<h2 id="与-InputFormat-有关的类"><a href="#与-InputFormat-有关的类" class="headerlink" title="与 InputFormat 有关的类"></a>与 InputFormat 有关的类</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/1638075688(1).jpg"></p>
<h2 id="TextInputFormat处理流程"><a href="#TextInputFormat处理流程" class="headerlink" title="TextInputFormat处理流程"></a>TextInputFormat处理流程</h2><ol>
<li><p>划分split</p>
<p>调用父类FileInputFormat的getSplit方法把文件分割成splits</p>
</li>
<li><p>处理split</p>
<p>调用createRecordReader方法给每一个split分配一个LineRecordReader</p>
</li>
<li><p>生成record</p>
<p>LineRecordReader类实现RecordReader方法，并且依赖LineReader来读取每一行</p>
</li>
<li><p>处理record</p>
<p>调用map task的map方法</p>
</li>
</ol>
<h1 id="MapReduce执行机制"><a href="#MapReduce执行机制" class="headerlink" title="MapReduce执行机制"></a>MapReduce执行机制</h1><h2 id="MapReduce-on-Yarn"><a href="#MapReduce-on-Yarn" class="headerlink" title="MapReduce on Yarn"></a>MapReduce on Yarn</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128181135.png"></p>
<h2 id="MapReduce-容错性"><a href="#MapReduce-容错性" class="headerlink" title="MapReduce 容错性"></a>MapReduce 容错性</h2><p>Case 1. 如果Task运行失败</p>
<ul>
<li>Map Task失败<ul>
<li>MRAppMaster重启Map Task，Map Task没有依赖性</li>
</ul>
</li>
<li>Reduce Task失败<ul>
<li>MRAppMaster重启Reduce Task，Map Task的输出保存在磁盘上</li>
</ul>
</li>
<li>同一个Task运行多次失败（默认4次）则本次作业失败</li>
</ul>
<p>Case 2. 如果Task所在的Node节点挂了</p>
<ul>
<li>在另外一个节点上重启所有在挂掉节点上曾经运行过的任务</li>
</ul>
<p>Case 3. 如果Task运行缓慢</p>
<ul>
<li>通常由于硬件损坏、软件Bug或者配置错误导致</li>
<li>单个task运行缓慢会显著影响整体作业运行时间</li>
<li>解决方案：推测执行<ul>
<li>在另外一个节点上启动相同的任务，谁先完成就kill掉另外一个节点上的任务</li>
</ul>
</li>
<li>无法启动推测执行的情况：写入数据库</li>
</ul>
<h2 id="MapReduce-数据本地性问题"><a href="#MapReduce-数据本地性问题" class="headerlink" title="MapReduce 数据本地性问题"></a>MapReduce 数据本地性问题</h2><ul>
<li>在集群中网络资源是一种稀缺资源</li>
<li>文件在HDFS上存储在不同的DataNode节点上</li>
<li>如果Map Task任务从远程机器上拷贝数据会消耗大量的网络带宽</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128191930.png"></p>
<ul>
<li><p>HDFS上同一份文件会有多份拷贝（默认是3份）</p>
</li>
<li><p>MapReduce调度原则</p>
<ul>
<li>在包含副本的节点上启动Map Task任务</li>
<li>或者在就近的节点上启动Map Task任务</li>
</ul>
</li>
<li><p>因此数据本地性有三个级别</p>
<ul>
<li><p>Node Local</p>
<ul>
<li><p>Map Task和数据在同一个节点上</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192223.png"></p>
</li>
</ul>
</li>
<li><p>Rack Local</p>
<ul>
<li><p>Map Task和数据在同一个机架上</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192307.png"></p>
</li>
</ul>
</li>
<li><p>Different Rack</p>
<ul>
<li><p>Map Task和数据即不再同一个节点又不在同一个机架上</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128192405.png"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="案例介绍"><a href="#案例介绍" class="headerlink" title="案例介绍"></a>案例介绍</h1><h2 id="用户行为分析-PV-UV计算"><a href="#用户行为分析-PV-UV计算" class="headerlink" title="用户行为分析-PV&#x2F;UV计算"></a>用户行为分析-PV&#x2F;UV计算</h2><p>计算思路？</p>
<p>IP、URL、REF_URL、Cookie、Timestamp</p>
<h2 id="用户行为分析-PV-计算"><a href="#用户行为分析-PV-计算" class="headerlink" title="用户行为分析-PV 计算"></a>用户行为分析-PV 计算</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PVMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, IntWritable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">IntWritable</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 使用tab分隔符对nginx的日志进行切分</span></span><br><span class="line">        String[] rawLogFields = value.toString().split(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        <span class="comment">// 拿到访问的url： 例如 http://opencart.gp-bd.com/index.php?route=product/product/review&amp;product_id=41</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessURL</span> <span class="operator">=</span> rawLogFields[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(accessURL) &amp;&amp; accessURL.contains(<span class="string">&quot;opencart.com&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 使用UrlEncoded进行解析product_id</span></span><br><span class="line">            MultiMap&lt;String&gt; values = <span class="keyword">new</span> <span class="title class_">MultiMap</span>&lt;String&gt;();</span><br><span class="line">            UrlEncoded.decodeTo(accessURL, values, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">productId</span> <span class="operator">=</span> values.getValue(<span class="string">&quot;product_id&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 如果有product_id这个参数，说明访问了这个页面</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNumeric(productId)) &#123;</span><br><span class="line">                <span class="comment">// key为product_id，value为访问次数1次</span></span><br><span class="line">                word.set(productId);</span><br><span class="line">                context.write(word, one);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PVReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, IntWritable, Text, IntWritable&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IntWritable</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span><br><span class="line"><span class="params">                       Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 按照WordCount思路对相同key的value进行累加即可获得页面点击次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">            sum += val.get();</span><br><span class="line">        &#125;</span><br><span class="line">        result.set(sum);</span><br><span class="line">        context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;opencart user action pv count&quot;</span>);</span><br><span class="line">    job.setJarByClass(PVCount.class);</span><br><span class="line">    job.setMapperClass(PVMapper.class);</span><br><span class="line">    job.setCombinerClass(PVReducer.class);</span><br><span class="line">    job.setReducerClass(PVReducer.class);</span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(IntWritable.class);</span><br><span class="line">    FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">    System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="用户行为分析-UV-计算"><a href="#用户行为分析-UV-计算" class="headerlink" title="用户行为分析-UV 计算"></a>用户行为分析-UV 计算</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 第一个Job的Mapper</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UVDistinctMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, NullWritable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 按照tab切分每一行日志</span></span><br><span class="line">        String[] rawLogFields = value.toString().split(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        <span class="comment">// 获得productId</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessURL</span> <span class="operator">=</span> rawLogFields[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(accessURL) &amp;&amp; accessURL.contains(<span class="string">&quot;opencart.com&quot;</span>)) &#123;</span><br><span class="line">            MultiMap&lt;String&gt; values = <span class="keyword">new</span> <span class="title class_">MultiMap</span>&lt;String&gt;();</span><br><span class="line">            UrlEncoded.decodeTo(accessURL, values, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">productId</span> <span class="operator">=</span> values.getValue(<span class="string">&quot;product_id&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 获得userId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> rawLogFields[<span class="number">3</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> cookie.contains(<span class="string">&quot;uid=&quot;</span>) ? cookie.split(<span class="string">&quot;=&quot;</span>)[<span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNumeric(productId) &amp;&amp; StringUtils.isNotEmpty(userId)) &#123;</span><br><span class="line">                <span class="comment">// 使用productId和userId作为主键，value设置为null</span></span><br><span class="line">                word.set(productId + <span class="string">&quot;\t&quot;</span> + userId);</span><br><span class="line">                context.write(word, NullWritable.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 第一个Job的Reducer</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UVDistinctReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, NullWritable, Text, NullWritable&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;NullWritable&gt; values,</span></span><br><span class="line"><span class="params">                       Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 直接输出结果，MapReduce框架已经帮助我们对key去重了</span></span><br><span class="line">        context.write(key, NullWritable.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 第二个Job的Mapper</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UVCountMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, IntWritable&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">IntWritable</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 使用tab作为分隔符，切分第一个Job去重后的key：product_Id \t userId</span></span><br><span class="line">        String[] dataFields = value.toString().split(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        <span class="comment">// 只需要取出productId即可，因为我们统计的是产品的pv</span></span><br><span class="line">        word.set(dataFields[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">// 输出kv对，key为productId，value为1</span></span><br><span class="line">        context.write(word, one);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 第二个Job的Reducer</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UVCountReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, IntWritable, Text, IntWritable&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">IntWritable</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span><br><span class="line"><span class="params">                       Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 按照WordCount思路进行累加处理</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">            sum += val.get();</span><br><span class="line">        &#125;</span><br><span class="line">        result.set(sum);</span><br><span class="line">        context.write(key, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * main方法，需要传入三个参数，第一个job的输入路径，第一个job的输出路径，第二个job的输出路径</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    <span class="comment">// 配置Job1</span></span><br><span class="line">    <span class="type">Job</span> <span class="variable">job1</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;opencart uv phase1 distinct&quot;</span>);</span><br><span class="line">    job1.setJarByClass(UVCount.class);</span><br><span class="line">    job1.setMapperClass(UVDistinctMapper.class);</span><br><span class="line">    job1.setReducerClass(UVDistinctReducer.class);</span><br><span class="line">    job1.setOutputKeyClass(Text.class);</span><br><span class="line">    job1.setOutputValueClass(NullWritable.class);</span><br><span class="line">    FileInputFormat.addInputPath(job1, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">0</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job1, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">    job1.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置Job2，Job2的输入数据是Job1的输出</span></span><br><span class="line">    <span class="type">Job</span> <span class="variable">job2</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;opencart uv phase2 count&quot;</span>);</span><br><span class="line">    job2.setJarByClass(UVCount.class);</span><br><span class="line">    job2.setMapperClass(UVCountMapper.class);</span><br><span class="line">    job2.setReducerClass(UVCountReducer.class);</span><br><span class="line">    job2.setOutputKeyClass(Text.class);</span><br><span class="line">    job2.setOutputValueClass(IntWritable.class);</span><br><span class="line">    FileInputFormat.addInputPath(job2, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">    FileOutputFormat.setOutputPath(job2, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">2</span>]));</span><br><span class="line">    job2.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PV-UV-执行"><a href="#PV-UV-执行" class="headerlink" title="PV&#x2F;UV 执行"></a>PV&#x2F;UV 执行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -mkdir -p /user/cdh/pv/input</span><br><span class="line">hadoop fs -put nginx_sample.txt /user/cdh/wordcount/input</span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.PVCount /user/cdh/pv/input /user/cdh/pv/output</span><br><span class="line"></span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.UVCount /user/cdh/pv/input /user/cdh/uv/output-1 /user/cdh/uv/output-2</span><br></pre></td></tr></table></figure>

<h1 id="调优参数"><a href="#调优参数" class="headerlink" title="调优参数"></a>调优参数</h1><h2 id="Map-Task和Reduce-Task数目调整"><a href="#Map-Task和Reduce-Task数目调整" class="headerlink" title="Map Task和Reduce Task数目调整"></a>Map Task和Reduce Task数目调整</h2><p><strong>Map Task数目</strong></p>
<ul>
<li><p>Map读取文件时，通过InputFormat计算分割文件</p>
</li>
<li><p>split大小由以下三个参数决定</p>
<ul>
<li><p>dfs.blocksize HDFS Block大小</p>
</li>
<li><p>mapreduce.input.fileinputformat.split.minsize 划分最小字节数</p>
</li>
<li><p>mapreduce.input.fileinputformat.split.maxsize 划分最大字节数</p>
</li>
<li><p>计算公式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">long</span> <span class="title function_">computeSplitSize</span><span class="params">(<span class="type">long</span> blockSize, <span class="type">long</span> minSize, <span class="type">long</span> maxSize)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Math.max(minSize, Math.min(maxSize, blockSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>Reduce Task数目</strong></p>
<ul>
<li>默认每个作业Reduce Task数目可以通过mapreduce.job.reduces控制</li>
<li>在每个作业中也可以通过Job.setNumReduceTasks(Int number)进行控制</li>
</ul>
<h2 id="容错参数调整"><a href="#容错参数调整" class="headerlink" title="容错参数调整"></a>容错参数调整</h2><table>
<thead>
<tr>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mapreduce.map.maxattempts</td>
<td>Map最大尝试次数，默认是4</td>
</tr>
<tr>
<td>mapreduce.reduce.maxattempts</td>
<td>Reduce最大尝试次数，默认是4</td>
</tr>
<tr>
<td>mapreduce.am.max-attempts</td>
<td>MRApplication最大尝试次数，默认是2</td>
</tr>
</tbody></table>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232306.png"></p>
<h2 id="推测执行参数调整"><a href="#推测执行参数调整" class="headerlink" title="推测执行参数调整"></a>推测执行参数调整</h2><table>
<thead>
<tr>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mapreduce.map.speculative</td>
<td>是否对Map开启推测执行机制，默认为false</td>
</tr>
<tr>
<td>mapreduce.reduce.speculative</td>
<td>是否对Reduce开启推测执行机制，默认为false</td>
</tr>
<tr>
<td>mapreduce.job.speculative.speculative-cap-running-tasks</td>
<td>能够推测重跑正在运行任务的百分之几，默认是0.1</td>
</tr>
<tr>
<td>mapreduce.job.speculative.speculative-cap-total-tasks</td>
<td>能够推测重跑全部任务的百分之几，默认是0.01</td>
</tr>
</tbody></table>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232618.png"></p>
<h2 id="内存参数调整"><a href="#内存参数调整" class="headerlink" title="内存参数调整"></a>内存参数调整</h2><table>
<thead>
<tr>
<th>配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>mapreduce.map.memory.mb</td>
<td>控制分配给Map内存上限，如果超过会被kill</td>
</tr>
<tr>
<td>mapreduce.map.java.opts</td>
<td>控制Map堆内存大小</td>
</tr>
<tr>
<td>mapreduce.reduce.memory.mb</td>
<td>控制分配给Reduce内存上限，如果超过会被kill</td>
</tr>
<tr>
<td>mapreduce.reduce.java.opts</td>
<td>控制Reduce堆内存大小</td>
</tr>
<tr>
<td>yarn.app.mapreduce.am.resource.mb</td>
<td>控制分配给MRApplicationMaster内存上限</td>
</tr>
<tr>
<td>yarn.app.mapreduce.am.command-opts</td>
<td>控制MRApplicationMaster堆内存大小</td>
</tr>
<tr>
<td>mapreduce.job.heap.memory-mb.ratio</td>
<td>Heap大小占Container大小的比例，默认0.8</td>
</tr>
<tr>
<td>yarn.nodemanager.vmem-pmem-ratio</td>
<td>物理内存和虚拟内存比率，默认是2.1</td>
</tr>
</tbody></table>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211128232940.png"></p>
<h1 id="手动操作与思考"><a href="#手动操作与思考" class="headerlink" title="手动操作与思考"></a>手动操作与思考</h1><ol>
<li>Word Count Example运行</li>
<li>读MapReduce TextInputFormat源代码</li>
<li>实现PV和UV计算<ul>
<li>使用maven构建项目</li>
<li>实战了解Mapper、Reducer</li>
<li>打包提交CDH集群运行并输出结果</li>
</ul>
</li>
<li>实现Top K（例如：最热门的N个商品）<ul>
<li><p>思路</p>
<p>分2个mapreduce任务，第1个对数据中的商品进行频次统计，第2个任务对第1个任务的结果排序取前K个，关键在于第2个任务 reducer 只能有1个</p>
</li>
<li><p>完整的工程</p>
<p>com.study.sample.mapreducer.TopK</p>
</li>
<li><p>执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -mkdir -p /user/cdh/topK/input</span><br><span class="line">hadoop fs -put topK_sample.txt /user/cdh/topK/input</span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.TopK /user/cdh/topK/input /user/cdh/topK/output-1 /user/cdh/topK/output-2</span><br><span class="line"></span><br><span class="line">hadoop fs -ls /user/cdh/topK/output-1/</span><br><span class="line">hadoop fs -text /user/cdh/topK/output-1/part-r-*</span><br><span class="line"></span><br><span class="line">hadoop fs -rm -R /user/cdh/topK/output-1</span><br><span class="line">hadoop fs -rm -R /user/cdh/topK/output-2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>思考如何解决数据倾斜问题？</li>
<li>如何使用MR实现矩阵相乘？</li>
</ol>
<h2 id="实现Top-K（例如：最热门的N个商品）"><a href="#实现Top-K（例如：最热门的N个商品）" class="headerlink" title="实现Top K（例如：最热门的N个商品）"></a>实现Top K（例如：最热门的N个商品）</h2><ol>
<li>先数据进行清洗，得到每个商品频次</li>
<li>然后对商品频次读取，需要注意2个地方，第1个自定义对象实现 WritableComparable 接口实现 compareTo 排序接口，第2个只存在一个 reducer 进行输出，每输出一个计数器加1，直到不小于 k 完成 Top K。</li>
</ol>
<h2 id="MR实现矩阵相乘"><a href="#MR实现矩阵相乘" class="headerlink" title="MR实现矩阵相乘"></a>MR实现矩阵相乘</h2><h3 id="矩阵乘法的计算"><a href="#矩阵乘法的计算" class="headerlink" title="矩阵乘法的计算"></a>矩阵乘法的计算</h3><p>矩阵，是线性代数中的基本概念之一。一个m×n的矩阵就是m×n个数排成m行n列的一个数阵。</p>
<p>矩阵乘法是一种高效的算法可以把一些一维递推优化到log(n)，还可以求路径方案等，所以更是一种应用性极强的算法。必须注意的是，只有当矩阵A的列数与矩阵B的行数相等时A×B才有意义。</p>
<p>一般单说矩阵乘积时，指的便是一般矩阵乘积。若A为m×n矩阵，B为n×p矩阵，则他们的乘积AB(有时记做A·B）会是一个m×p矩阵。其乘积矩阵的元素如下面式子得出：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205201605.png"></p>
<p>上面是一个通过代数公式的方式说明这类乘法的抽象性质，有些抽象，下面从一个具体图的角度看看这种乘法：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205203034.png"></p>
<p>在上图中，A是个4×2矩阵，B是个2×3矩阵。分别计算AB的（1,2）和（3,3）元素的值，结果可以根据上图中箭头方向两两配对，把每一对中的两个元素相乘，再把这些乘积加起来，最后得到的值即为箭头相交位置的值。</p>
<p>这样在从直观的图中转换为稍微抽象点的公式中，则对应的计算方式为：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204416.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204500.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204639.png"></p>
<p>(AB)1,1 &#x3D; A1,1 * B1,1 + A1,2 * B2,1 &#x3D; 1 * 0 + 1 * 1 &#x3D; 1</p>
<p>(AB)1,3 &#x3D; A1,1 * B3,1 + A1,2 * B3,2 &#x3D; 1 * 3 + 1 * 2 &#x3D; 5</p>
<p>(AB)2,3 &#x3D; A2,1 * B3,1 + A2,2 * B3,2 &#x3D; 2 * 3 + 0 * 2 &#x3D; 6</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205204659.png"></p>
<h3 id="矩阵乘法的来源"><a href="#矩阵乘法的来源" class="headerlink" title="矩阵乘法的来源"></a>矩阵乘法的来源</h3><p>在矩阵的运算中，矩阵的加法、数与矩阵的积，都与实数或向量的对应运算一致，易于接受掌握。唯独矩阵乘法，与之相差悬殊。初学时感觉莫名其妙，难以接受。扬天哀呼，为啥这么算呢？</p>
<p>来举个简单的例子：</p>
<p>设A1,A2,…,Am是m个工厂，它们都生产着n种产品B1,B2,…,Bm，而Ai厂生产Bj的年产量为aij,i&#x3D;1,2…,m;j&#x3D;1,2,…,n。于是，对照每个工厂各种产品年产量的统计表和产量矩阵就出来了：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211022.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211048.png"></p>
<p>如果第二年各厂各种产品的产量都是前一年的λ倍,就是数乘矩阵λA的意义。如果计算各厂各种产品两年的总产量，就用到了矩阵的加法。</p>
<p>接上例，设产品B1,B2,…,Bn皆需p种原料C1,C2,…,Cp，而生存一件Bk所需原料Cj的数量为bkj，于是，统计各种产品每件所需的原料数表和单间原料矩阵为：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211440.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211511.png"></p>
<p>现在需要计算各厂每年所需各种原料的总是，设Ai厂一年所需原料Cj的总数为cij，则各厂一年所需各种原料总数统计表和原料总数矩阵为：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211642.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211701.png"></p>
<p>到这一步，基本上可以想到，cij（i厂需材料j的原料数量）等于i厂各个产品的年产量乘上该产品所需j原料的数量的和，简单点说就是一年所需总料数&#x3D;年产量×单间所需原料数，用公式表达就是：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211205211742.png"></p>
<p>从上面的例子可以看出，关于矩阵的乘法，并非空穴来风、无源之水，而是有它必然产生的缘由。充分说明了数学是来源于生活，之所以与生活相差较大，只是因为在语言、符号演化过程中，数学进化的方向是趋向于抽象和一般。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>矩阵乘法要求左矩阵的列数与右矩阵的行数相等。m×n的矩阵A，与n×p的矩阵B相乘，结果为m×p的矩阵C</p>
<ul>
<li>矩阵A的行数为m，列数为n，aij为矩阵A第i行j列的元素。</li>
<li>矩阵B的行数为n。列数为p。bij为矩阵B第i行j列的元素。</li>
</ul>
<p>由于分布式计算的特点，须要找到相互独立的计算过程，以便能够在不同的节点上进行计算而不会彼此影响。依据矩阵乘法的公式，C中各个元素的计算都是相互独立的，即各个cij在计算过程中彼此不影响。这种话，在Map阶段能够把计算所须要的元素都集中到同一个key中，然后，在Reduce阶段就能够从中解析出各个元素来计算cij。</p>
<p>另外，以a11为例，它将会在c11、c12……c1p的计算中使用。也就是说。在Map阶段，当我们从HDFS取出一行记录时，假设该记录是A的元素。则须要存储成p个&lt;key, value&gt;对。而且这p个key互不同样。假设该记录是B的元素，则须要存储成m个&lt;key, value&gt;对，同样的，m个key也应互不同样；但同一时候。用于存放计算cij的ai1、ai2……ain和b1j、b2j……bnj的&lt;key, value&gt;对的key应该都是同样的，这样才能被传递到同一个Reduce中。</p>
<h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><p>普遍有一个共识是：数据结构+算法&#x3D;程序，所以在编写代码之前须要先理清数据存储结构和处理数据的算法。</p>
<h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><h5 id="map阶段"><a href="#map阶段" class="headerlink" title="map阶段"></a>map阶段</h5><p>在map阶段。须要做的是进行数据准备。把来自矩阵A的元素aij，标识成p条&lt;key, value&gt;的形式，key&#x3D;”i,k”,（当中k&#x3D;1,2,…,p）。value&#x3D;”a:j,aij”；把来自矩阵B的元素bij，标识成m条&lt;key, value&gt;形式，key&#x3D;”k,j”（当中k&#x3D;1,2,…,m），value&#x3D;”b:i,bij”。</p>
<p>经过处理，用于计算cij须要的a、b就转变为有同样key（”i,j”）的数据对，通过value中”a:”、”b:”能区分元素是来自矩阵A还是矩阵B。以及详细的位置（在矩阵A的第几列。在矩阵B的第几行）。</p>
<h5 id="shuffle阶段"><a href="#shuffle阶段" class="headerlink" title="shuffle阶段"></a>shuffle阶段</h5><p>这个阶段是Hadoop自己主动完毕的阶段，具有同样key的value被分到同一个Iterable中，形成&lt;key,Iterable(value)&gt;对，再传递给reduce。</p>
<h5 id="reduce阶段"><a href="#reduce阶段" class="headerlink" title="reduce阶段"></a>reduce阶段</h5><p>通过map数据预处理和shuffle数据分组两个阶段，reduce阶段仅仅须要知道两件事即可：</p>
<ul>
<li>&lt;key,Iterable(value)&gt;对经过计算得到的是矩阵C的哪个元素？由于map阶段对数据的处理。key（i,j）中的数据对。就是其在矩阵C中的位置，第i行j列。</li>
<li>Iterable中的每一个value来自于矩阵A和矩阵B的哪个位置？这个也在map阶段进行了标记。对于value（x:y,z），仅仅须要找到y同样的来自不同矩阵（即x分别为a和b）的两个元素，取z相乘，然后加和就可以。</li>
</ul>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>计算过程已经设计清楚了，就须要对数据结构进行设计。大体有两种设计方案：</p>
<p>第一种：使用最原始的表示方式，同样行内不同列数据通过”,”切割。不同行通过换行切割。</p>
<p>第二种：通过行列表示法，即文件里的每行数据有三个元素通过分隔符切割，第一个元素表示行，第二个元素表示列，第三个元素表示数据。这样的方式对于能够不列出为0的元素，即能够降低稀疏矩阵的数据量。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207132715.png"></p>
<p>在上图中，第一种方式存储的数据量小于另外一种，但这仅仅是由于样例中的数据设计成这样。在现实中，使用分布式计算矩阵乘法的环境中，大部分矩阵是稀疏矩阵。且数据量极大，在这样的情况下，另外一种数据结构的优势就显现了出来。并且，由于使用分布式计算，假设数据大于64m，在map阶段将不可以逐行处理，将不能确定数据来自于哪一行。只是，由于现实中对于大矩阵的乘法，考虑到存储空间和内存的情况，须要特殊的处理方式，有一种是将矩阵进行行列转换然后计算。这个时候第一种还是挺有用的。</p>
<p>第一种优点：存储空间相对第二种占用小</p>
<p>第一种缺点：数据大于64m在map阶段不能逐行处理，不能确定数据来自哪一行</p>
<p>第二种优点：计算大的稀疏矩阵可以并行处理</p>
<p>第二种缺点：存储空间相对第一种占用大</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.sample.mapreducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileSplit;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.partition.HashPartitioner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 矩阵相乘，A * B = C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MatrixMultiply</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATRIX_A_FILENAME</span> <span class="operator">=</span> <span class="string">&quot;MatrixA&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATRIX_B_FILENAME</span> <span class="operator">=</span> <span class="string">&quot;MatrixB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MatrixMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, Text&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 文件名称，用于区分矩阵 A 或 B*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 A 的行数*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rowNum</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 B 的列数*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">colNum</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 A 当前在第几行*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rowIndexA</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 B 当前在第几行*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rowIndexB</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            filename = ((FileSplit) context.getInputSplit()).getPath().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] rowFields = value.toString().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (MATRIX_A_FILENAME.equals(filename)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= colNum; i++) &#123;</span><br><span class="line">                    <span class="type">Text</span> <span class="variable">k</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(rowIndexA + <span class="string">&quot;,&quot;</span> + i);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; rowFields.length; j++) &#123;</span><br><span class="line">                        <span class="type">Text</span> <span class="variable">v</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(MATRIX_A_FILENAME + <span class="string">&quot;,&quot;</span> + (j + <span class="number">1</span>) + <span class="string">&quot;,&quot;</span> + rowFields[j]);</span><br><span class="line">                        context.write(k, v);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                rowIndexA++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MATRIX_B_FILENAME.equals(filename)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= rowNum; i++) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; rowFields.length; j++) &#123;</span><br><span class="line">                        <span class="type">Text</span> <span class="variable">k</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(i + <span class="string">&quot;,&quot;</span> + (j + <span class="number">1</span>));</span><br><span class="line">                        <span class="type">Text</span> <span class="variable">v</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(MATRIX_B_FILENAME + <span class="string">&quot;,&quot;</span> + rowIndexB + <span class="string">&quot;,&quot;</span> + rowFields[j]);</span><br><span class="line">                        context.write(k, v);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                rowIndexB++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MatrixReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, Text, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            Map&lt;String, String&gt; mapA = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            Map&lt;String, String&gt; mapB = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Text value : values) &#123;</span><br><span class="line">                String[] val = value.toString().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (MATRIX_A_FILENAME.equals(val[<span class="number">0</span>])) &#123;</span><br><span class="line">                    mapA.put(val[<span class="number">1</span>], val[<span class="number">2</span>]);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MATRIX_B_FILENAME.equals(val[<span class="number">0</span>])) &#123;</span><br><span class="line">                    mapB.put(val[<span class="number">1</span>], val[<span class="number">2</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> Iterator&lt;String&gt; iterator = mapA.keySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">mapAKey</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (mapB.get(mapAKey) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 由于 mapAKey 取的是 mapA 的 key 集合。所以仅仅须要推断 mapB 是否存在就可以。</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                result += Integer.parseInt(mapA.get(mapAKey)) * Integer.parseInt(mapB.get(mapAKey));</span><br><span class="line">            &#125;</span><br><span class="line">            context.write(key, <span class="keyword">new</span> <span class="title class_">IntWritable</span>(result));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        <span class="comment">// 配置Job</span></span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;matrix multiply&quot;</span>);</span><br><span class="line">        job.setJarByClass(MatrixMultiply.class);</span><br><span class="line">        job.setMapperClass(MatrixMapper.class);</span><br><span class="line">        job.setMapOutputKeyClass(Text.class);</span><br><span class="line">        job.setMapOutputValueClass(Text.class);</span><br><span class="line">        job.setReducerClass(MatrixReducer.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line">        <span class="comment">// 添加输入路径和输出路径</span></span><br><span class="line">        FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">0</span>]));</span><br><span class="line">        FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Path</span> <span class="variable">outputDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">2</span>]);</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fs</span> <span class="operator">=</span> FileSystem.get(conf);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(outputDir)) &#123;</span><br><span class="line">            fs.delete(outputDir, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job, outputDir);</span><br><span class="line">        job.setPartitionerClass(HashPartitioner.class);</span><br><span class="line">        <span class="comment">// 向集群提交Job，并等待完成</span></span><br><span class="line">        System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.study.sample.mapreducer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileSplit;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.partition.HashPartitioner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 稀疏矩阵相乘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SparseMatrixMultiply</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATRIX_A_FILENAME</span> <span class="operator">=</span> <span class="string">&quot;SparseMatrixA&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATRIX_B_FILENAME</span> <span class="operator">=</span> <span class="string">&quot;SparseMatrixB&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SparseMatrixMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, Text&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 文件名称，用于区分矩阵 A 或 B*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 A 的行数*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">rowNum</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="comment">/** 矩阵 B 的列数*/</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">colNum</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            filename = ((FileSplit) context.getInputSplit()).getPath().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] rowFields = value.toString().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (MATRIX_A_FILENAME.equals(filename)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= colNum; i++) &#123;</span><br><span class="line">                    <span class="type">Text</span> <span class="variable">k</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(rowFields[<span class="number">0</span>] + <span class="string">&quot;,&quot;</span> + i);</span><br><span class="line">                    <span class="type">Text</span> <span class="variable">v</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(MATRIX_A_FILENAME + <span class="string">&quot;,&quot;</span> + rowFields[<span class="number">1</span>] + <span class="string">&quot;,&quot;</span> + rowFields[<span class="number">2</span>]);</span><br><span class="line">                    context.write(k, v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MATRIX_B_FILENAME.equals(filename)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= rowNum; i++) &#123;</span><br><span class="line">                    <span class="type">Text</span> <span class="variable">k</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(i + <span class="string">&quot;,&quot;</span> + rowFields[<span class="number">1</span>]);</span><br><span class="line">                    <span class="type">Text</span> <span class="variable">v</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>(MATRIX_B_FILENAME + <span class="string">&quot;,&quot;</span> + rowFields[<span class="number">0</span>] + <span class="string">&quot;,&quot;</span> + rowFields[<span class="number">2</span>]);</span><br><span class="line">                    context.write(k, v);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SparseMatrixReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, Text, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            Map&lt;String, String&gt; mapA = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            Map&lt;String, String&gt; mapB = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Text value : values) &#123;</span><br><span class="line">                String[] val = value.toString().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (MATRIX_A_FILENAME.equals(val[<span class="number">0</span>])) &#123;</span><br><span class="line">                    mapA.put(val[<span class="number">1</span>], val[<span class="number">2</span>]);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MATRIX_B_FILENAME.equals(val[<span class="number">0</span>])) &#123;</span><br><span class="line">                    mapB.put(val[<span class="number">1</span>], val[<span class="number">2</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> Iterator&lt;String&gt; iterator = mapA.keySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">mapAKey</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (mapB.get(mapAKey) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 由于 mapAKey 取的是 mapA 的 key 集合。所以仅仅须要推断 mapB 是否存在就可以。</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                result += Integer.parseInt(mapA.get(mapAKey)) * Integer.parseInt(mapB.get(mapAKey));</span><br><span class="line">            &#125;</span><br><span class="line">            context.write(key, <span class="keyword">new</span> <span class="title class_">IntWritable</span>(result));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        <span class="comment">// 配置Job</span></span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;sparse matrix multiply&quot;</span>);</span><br><span class="line">        job.setJarByClass(SparseMatrixMultiply.class);</span><br><span class="line">        job.setMapperClass(SparseMatrixMapper.class);</span><br><span class="line">        job.setMapOutputKeyClass(Text.class);</span><br><span class="line">        job.setMapOutputValueClass(Text.class);</span><br><span class="line">        job.setReducerClass(SparseMatrixReducer.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line">        <span class="comment">// 添加输入路径和输出路径</span></span><br><span class="line">        FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">0</span>]));</span><br><span class="line">        FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Path</span> <span class="variable">outputDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(args[<span class="number">2</span>]);</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fs</span> <span class="operator">=</span> FileSystem.get(conf);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(outputDir)) &#123;</span><br><span class="line">            fs.delete(outputDir, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job, outputDir);</span><br><span class="line">        job.setPartitionerClass(HashPartitioner.class);</span><br><span class="line">        <span class="comment">// 向集群提交Job，并等待完成</span></span><br><span class="line">        System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第一种数据结构"><a href="#第一种数据结构" class="headerlink" title="第一种数据结构"></a>第一种数据结构</h4><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207201017.png"></p>
<h4 id="第二种数据结构"><a href="#第二种数据结构" class="headerlink" title="第二种数据结构"></a>第二种数据结构</h4><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20211207204931.png"></p>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">// 矩阵乘法执行</span><br><span class="line">hadoop fs -mkdir -p /user/cdh/matrix_multiply/input-1/</span><br><span class="line">hadoop fs -put MatrixA /user/cdh/matrix_multiply/input-1/</span><br><span class="line"></span><br><span class="line">hadoop fs -mkdir -p /user/cdh/matrix_multiply/input-2/</span><br><span class="line">hadoop fs -put MatrixB /user/cdh/matrix_multiply/input-2/</span><br><span class="line"></span><br><span class="line">hadoop fs -ls /user/cdh/matrix_multiply/input-1/</span><br><span class="line">hadoop fs -ls /user/cdh/matrix_multiply/input-2/</span><br><span class="line"></span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.MatrixMultiply /user/cdh/matrix_multiply/input-1/ /user/cdh/matrix_multiply/input-2/ /user/cdh/matrix_multiply/output/</span><br><span class="line"></span><br><span class="line">hadoop fs -ls /user/cdh/matrix_multiply/output/</span><br><span class="line">hadoop fs -text /user/cdh/matrix_multiply/output/part-r-*</span><br><span class="line"></span><br><span class="line">1,2	46</span><br><span class="line">2,1	40</span><br><span class="line">3,2	202</span><br><span class="line">4,1	232</span><br><span class="line">1,1	43</span><br><span class="line">2,2	70</span><br><span class="line">3,1	169</span><br><span class="line">4,2	280</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 稀疏矩阵乘法执行</span><br><span class="line">hadoop fs -mkdir -p /user/cdh/sparse_matrix_multiply/input-1/</span><br><span class="line">hadoop fs -put SparseMatrixA /user/cdh/sparse_matrix_multiply/input-1/</span><br><span class="line"></span><br><span class="line">hadoop fs -mkdir -p /user/cdh/sparse_matrix_multiply/input-2/</span><br><span class="line">hadoop fs -put SparseMatrixB /user/cdh/sparse_matrix_multiply/input-2/</span><br><span class="line"></span><br><span class="line">hadoop fs -ls /user/cdh/sparse_matrix_multiply/input-1/</span><br><span class="line">hadoop fs -ls /user/cdh/sparse_matrix_multiply/input-2/</span><br><span class="line"></span><br><span class="line">hadoop jar demo_mapreducer-1.0-SNAPSHOT-jar-with-dependencies.jar com.study.sample.mapreducer.SparseMatrixMultiply /user/cdh/sparse_matrix_multiply/input-1/ /user/cdh/sparse_matrix_multiply/input-2/ /user/cdh/sparse_matrix_multiply/output/</span><br><span class="line"></span><br><span class="line">hadoop fs -ls /user/cdh/sparse_matrix_multiply/output/</span><br><span class="line">hadoop fs -text /user/cdh/sparse_matrix_multiply/output/part-r-*</span><br><span class="line"></span><br><span class="line">1,2	46</span><br><span class="line">2,1	40</span><br><span class="line">3,2	202</span><br><span class="line">4,1	232</span><br><span class="line">1,1	43</span><br><span class="line">2,2	70</span><br><span class="line">3,1	169</span><br><span class="line">4,2	280</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/08/15/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/03-MapReduce/" data-id="clmcxec6j000nu8wa7fyxcj0v" data-title="MapReduce" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/08/15/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/02-HDFS/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          HDFS
        
      </div>
    </a>
  
  
    <a href="/2020/08/15/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/04-YARN/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">YARN</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>