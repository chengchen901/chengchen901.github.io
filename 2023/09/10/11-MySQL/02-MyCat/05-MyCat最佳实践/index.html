<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Mycat最佳实践Mycat实施指南实施流程 了解Mycat 的能力，包括如下的方面：  Mycat 的起源和解决的目标； Mycat 在数据库中间件方面的独特功能和定位； Mycat 的实际案例情况； Mycat 的优点和不足； Mycat 所提供的监控和测试工具； Mycat 社区的动态。  其中，关于分片规则的支持和扩展、多数据库支持、SQL 拦截和注解、跨库Join、读写分离、缓存功能、高">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2023/09/10/11-MySQL/02-MyCat/05-MyCat%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Mycat最佳实践Mycat实施指南实施流程 了解Mycat 的能力，包括如下的方面：  Mycat 的起源和解决的目标； Mycat 在数据库中间件方面的独特功能和定位； Mycat 的实际案例情况； Mycat 的优点和不足； Mycat 所提供的监控和测试工具； Mycat 社区的动态。  其中，关于分片规则的支持和扩展、多数据库支持、SQL 拦截和注解、跨库Join、读写分离、缓存功能、高">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160038.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160700.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163346.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163432.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163501.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226174405.png">
<meta property="article:published_time" content="2023-09-10T03:59:08.895Z">
<meta property="article:modified_time" content="2022-12-26T10:03:34.165Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160038.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-11-MySQL/02-MyCat/05-MyCat最佳实践" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/05-MyCat%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.895Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mycat最佳实践"><a href="#Mycat最佳实践" class="headerlink" title="Mycat最佳实践"></a>Mycat最佳实践</h1><h2 id="Mycat实施指南"><a href="#Mycat实施指南" class="headerlink" title="Mycat实施指南"></a>Mycat实施指南</h2><h3 id="实施流程"><a href="#实施流程" class="headerlink" title="实施流程"></a>实施流程</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160038.png"></p>
<p>了解Mycat 的能力，包括如下的方面：</p>
<ul>
<li>Mycat 的起源和解决的目标；</li>
<li>Mycat 在数据库中间件方面的独特功能和定位；</li>
<li>Mycat 的实际案例情况；</li>
<li>Mycat 的优点和不足；</li>
<li>Mycat 所提供的监控和测试工具；</li>
<li>Mycat 社区的动态。</li>
</ul>
<p>其中，关于分片规则的支持和扩展、多数据库支持、SQL 拦截和注解、跨库Join、读写分离、缓存功能、高 可用性等方面需要比较深入的学习和理解，有助于正确的使用Mycat 来解决当前的业务问题。</p>
<p>接下来是分析当前业务，具体内容包括如下几个方面：</p>
<ul>
<li>数据模型：重点关注数据的增长模式（实时大量增长还是缓慢增长）和规律、数据之间的关联关系；</li>
<li>数据访问模式：通过抓取系统中实际执行的SQL，分析其频率、响应时间、对系统性能和功能的影响程度；</li>
<li>数据可靠性的要求：系统中不同数据表的可靠性要求，以及操作模式；</li>
<li>事务的要求：系统中哪些业务操作是严格事务的，哪些是普通事务或可以无事务的；</li>
<li>数据备份和恢复问题：目前的备份模式，对系统的压力等。</li>
</ul>
<p>数据的模型和访问模式在很大程度上决定了未来数据分片的模式，包括哪些表用全局表、哪些用ER 分片、哪 些用范围分片规则、哪些用一致性Hash 或自定义方式。而数据可靠性的要求，则影响到Mycat 后端是采用普通 的MySQL 主从还是用Gluster 多写模式，事务性要求需要相关的表或者SQL 尽量不会垮分片执行，对于以后制 定本项目的编程约束有重要意义。</p>
<p>分表方案则需要确定如下一些问题：</p>
<ul>
<li>哪些表要分片、什么分片规则、依赖关联关系如何解决；</li>
<li>数据迁移和扩容的手段。</li>
</ul>
<p>建议根据业务分析的结果，确定两套比较合适分表方案，然后进行性能测试，选出最佳的分表方案，性能测 试可以采用Mycat 自带的超级工具，此工具在前面提到过，可以模拟接近真实业务数据的数据，并随机制造大量的数据供测试，是目前开源的最佳数据库性能测试工具。</p>
<p>在最终进入开发之前，架构师还需要给出一个编程约束，需要明确列出不能执行的SQL 语句，这些约束可能包括如下几种：</p>
<ul>
<li>跨越太多节点的查询语句；</li>
<li>不能Join 的表和相关的Join SQL；</li>
<li>很影响性能的复杂SQL；</li>
<li>对比较大的表的SQL 操作提示。</li>
</ul>
<p>最后在开发阶段，还应该做到如下几点</p>
<ul>
<li>一开始就按照最初的分片设计和数据规模，制造大量的随机数据，进行开发和测试，尽早发现性能问题；</li>
<li>对所有的SQL 进行统计分析，找出异常的SQL，包括跨越太多分片的SQL，以及执行缓慢的SQL，对这些SQL 进行分析和优化；</li>
<li>时刻关注性能问题。</li>
</ul>
<p>当项目上线后，通过Mycat Web 对系统进行监控，特别是服务的IO 和网络指标，除此之外，对Mycat 运行过程中的日志也要进行排查，告警信息可能是SQL 错误，可能是Mycat Bug，及时分析处理，并积极反馈给Mycat 社区，寻求帮助。</p>
<h3 id="后端存储的选择"><a href="#后端存储的选择" class="headerlink" title="后端存储的选择"></a>后端存储的选择</h3><p>Mysql 尽量用比较新的稳定版，当前来说5.6 和5.7 都是比较靠谱的一个选择，因为Mysq 这两个版本做了 大量优化。另外Mysql 的各种变种版本都可以考虑。以下是一些通用准则：</p>
<ul>
<li>对于非严格苛刻交易型的数据表，建议用MariaDB，这个版本目前在开源界很盛行，评价很高，percona 版 本也值得推荐，percona 有很多辅助的运维工具。</li>
<li>对于交易型的数据表，可以考虑Mysql 官方稳定版，若交易型的数据表要求可靠性非常高，比如是替代Oracle，也可以选择Galera Cluster 这种高可用的方案，他以一定的写入性能损失带来了数据的高可用和高并发访问。</li>
<li>根据数据的可靠性要求，可以采用各种数据同步方案，比如1 主多从，读写分离提升数据表的读的并发能力。</li>
<li>部分表可以用NoSQL 方式存储，而前端访问方式不变，Mycat 支持后端MongoDB 和很多NoSQL 系统，以提升查询能力</li>
<li>部分表可以采用MySQL 内存表，来提升查询和写入速度，替代部分复杂缓存方案。</li>
</ul>
<p>下面是一个可能的Mycat 部署方案，不同的表用不同的存储方式，让不同的表根据其访问模式，都达到最佳 状态。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160700.png"></p>
<h3 id="Mycat-目前存在的限制"><a href="#Mycat-目前存在的限制" class="headerlink" title="Mycat 目前存在的限制"></a>Mycat 目前存在的限制</h3><p>部分SQL 还不能很好的支持</p>
<ul>
<li>除了分片规则相同、ER 分片、全局表、以及SharedJoin，其他表之间的Join 问题目前还没有很好的解决，需要自己编写Catlet 来处理。</li>
<li>不支持Insert into 中不包括字段名的SQL</li>
<li>insert into x select from y 的SQL，若x 与y 不是相同的分片规则，则不被支持，此时会涉及到跨分片转移。</li>
<li>跨分片的事务，目前只是弱XA 模式，还没完全实现XA 模式。</li>
<li>分片的Table，目前不能执行Lock Table 这样的语句，因为这种语句会随机发到某个节点，也不会全部分 片锁定，经常导致死锁问题，此类问题常常出现在sqldump 导入导出SQL数据的过程中。</li>
<li>目前sql 解析器采用Druid,再某些sql 例如order，group，sum ，count 条件下，如果这类操作会出现 兼容问题，比如： select t.name as name1 from test order by t.name 这条语句select 列的别名与order by 不一致解析器会出现异常，所以在对列加别名时候要注意这类操作异常，特别是由jpa 等类似的框架生成的语句会有兼容问题。</li>
</ul>
<p>开发框架方面，虽然支持Hibernate，但不建议使用Hibernate，而是建议Mybatis 以及直接JDBC 操作，原因Hibernat 无法控制SQL 的生成，无法做到对查询SQL 的优化，导致大数量下的性能问题。此外，事务方面，建议自己手动控制，查询语句尽量走自动提交事务模式，这样Mycat 的读写分离会被用到，提升性能很明显。</p>
<h2 id="Mycat高可用方案"><a href="#Mycat高可用方案" class="headerlink" title="Mycat高可用方案"></a>Mycat高可用方案</h2><h3 id="Mycat单点方案"><a href="#Mycat单点方案" class="headerlink" title="Mycat单点方案"></a>Mycat单点方案</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163346.png"></p>
<p><strong>单点的不足：</strong></p>
<ol>
<li>单点故障，整个系统不可用！</li>
<li>并发处理能力有上限！</li>
</ol>
<h3 id="高可用方案"><a href="#高可用方案" class="headerlink" title="高可用方案"></a>高可用方案</h3><p><strong>集群负载均衡：</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163432.png"></p>
<p><strong>HAproxy + keepalived+Mycat集群+DB主从同步复制 组成Mycat高可用系统</strong></p>
<p><strong>集群部署图示：</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163501.png"></p>
<p><strong>集群部署图说明：</strong></p>
<ol>
<li>keepalived 和haproxy 必须装在同一台机器上（如192.168.8.91 机器上，keepalived 和haproxy 都要安装），keepalived 负责为该服务器抢占vip（虚拟ip），抢占到vip 后，对该主机的访问可以通过原来的ip（192.168.8.91）访问，也可以直接通过vip（192.168.8.108）访问。</li>
<li>192.168.8.92 上的keepalived 也会去抢占vip，抢占vip 时有优先级，配置keepalived.conf 中的 （priority 150 #数值愈大，优先级越高,192.168.8.92 上改为120，master 和slave 上该值配置不同）决定。但是一般哪台主机上的keepalived 服务先启动就会抢占到vip，即使是slave，只要先启动也能抢到。</li>
<li>haproxy 负责将对vip 的请求分发到mycat 上。起到负载均衡的作用，同时haproxy 也能检测到mycat 是否存活，haproxy 只会将请求转发到存活的mycat 上。</li>
<li>如果一台服务器（keepalived+haproxy 服务器）宕机，另外一台上的keepalived 会立刻抢占vip 并接管服务。</li>
<li>如果一台mycat 服务器宕机，haporxy 转发时不会转发到宕机的mycat 上，所以mycat 依然可用。</li>
</ol>
<h3 id="高可用安装部署"><a href="#高可用安装部署" class="headerlink" title="高可用安装部署"></a>高可用安装部署</h3><h4 id="haproxy-安装"><a href="#haproxy-安装" class="headerlink" title="haproxy 安装"></a>haproxy 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#useradd haproxy </span></span><br><span class="line"><span class="comment">#wget http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.25.tar.gz </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tar zxvf haproxy-1.4.25.tar.gz </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cd haproxy-1.4.25 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make TARGET=linux26 PREFIX=/usr/local/haproxy ARCH=x86_64 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make install PREFIX=/usr/local/haproxy </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cd /usr/local/haproxy </span></span><br><span class="line"><span class="comment">#chown -R haproxy.haproxy *</span></span><br></pre></td></tr></table></figure>

<h4 id="haproxy-cfg"><a href="#haproxy-cfg" class="headerlink" title="haproxy.cfg"></a>haproxy.cfg</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd /usr/local/haproxy </span></span><br><span class="line"><span class="comment">#touch haproxy.cfg </span></span><br><span class="line"><span class="comment">#vi/usr/local/haproxy/haproxy.cfg </span></span><br><span class="line">global </span><br><span class="line"><span class="built_in">log</span> 127.0.0.1 local0 <span class="comment">##记日志的功能 </span></span><br><span class="line">maxconn 4096 </span><br><span class="line"><span class="built_in">chroot</span>/usr/local/haproxy </span><br><span class="line">user haproxy </span><br><span class="line">group haproxy </span><br><span class="line">daemon </span><br><span class="line">defaults </span><br><span class="line"><span class="built_in">log</span> global </span><br><span class="line">option dontlognull</span><br><span class="line">retries 3 </span><br><span class="line">option redispatch </span><br><span class="line">maxconn 2000 </span><br><span class="line">contimeout 5000 </span><br><span class="line">clitimeout 50000 </span><br><span class="line">srvtimeout 50000 </span><br><span class="line">listen admin_status 172.17.210.103:48800 <span class="comment">##VIP </span></span><br><span class="line">stats uri/admin-status <span class="comment">##统计页面 </span></span><br><span class="line">stats auth admin:admin </span><br><span class="line">mode http </span><br><span class="line">option httplog </span><br><span class="line">listen allmycat_service 172.17.210.103:8096 <span class="comment">##转发到mycat 的8066 端口，即 mycat的服务端口</span></span><br><span class="line">mode tcp </span><br><span class="line">option tcplog </span><br><span class="line">option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www </span><br><span class="line">balance roundrobin </span><br><span class="line">server mycat_91 192.168.8.91:8066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">server mycat_92 192.168.8.92:8066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">srvtimeout 20000</span><br><span class="line">listen allmycat_admin 172.17.210.103:8097 <span class="comment">##转发到mycat 的9066 端口，即mycat 的管理控制台端口</span></span><br><span class="line">mode tcp </span><br><span class="line">option tcplog </span><br><span class="line">option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www balance roundrobin </span><br><span class="line">server mycat_91 192.168.8.91:9066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">server mycat_92 192.168.8.92:9066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">srvtimeout 20000</span><br></pre></td></tr></table></figure>

<h4 id="haproxy-记录日志"><a href="#haproxy-记录日志" class="headerlink" title="haproxy 记录日志"></a>haproxy 记录日志</h4><p>默认haproxy 是不记录日志的，为了记录日志还需要配置syslog 模块，在linux 下是rsyslogd服务，先安装rsyslog</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum –y install rsyslog</span><br></pre></td></tr></table></figure>

<p>然后 记录haproxy 日志的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/rsyslog.d/</span><br></pre></td></tr></table></figure>

<p>如果没有这个目录，新建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> rsyslog.d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/rsyslog.d/ </span><br><span class="line"><span class="built_in">touch</span> haproxy.conf </span><br><span class="line">vi /etc/rsyslog.d/haproxy.conf</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ModLoad</span> imudp </span><br><span class="line"><span class="variable">$UDPServerRun</span> 514 </span><br><span class="line">local0.* /var/log/haproxy.log</span><br></pre></td></tr></table></figure>

<p>配置rsyslog:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsyslog.conf</span><br></pre></td></tr></table></figure>

<p>1、在#### RULES ####上面一行的地方加入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Include all config files in /etc/rsyslog.d/ </span><br><span class="line"></span><br><span class="line">$IncludeConfig /etc/rsyslog.d/*.conf </span><br><span class="line"></span><br><span class="line">#### RULES ####</span><br></pre></td></tr></table></figure>

<p>2、在local7.* &#x2F;var&#x2F;log&#x2F;boot.log 的下面加入以下内容（增加后的效果如下）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Save boot messages also to boot.log </span><br><span class="line">local7.* /var/log/boot.log </span><br><span class="line">local0.* /var/log/haproxy.log</span><br></pre></td></tr></table></figure>

<p>保存，重启rsyslog 服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>

<p>现在你就可以看到日志（&#x2F;var&#x2F;log&#x2F;haproxy.log）了</p>
<h4 id="配置监听mycat-是否存活"><a href="#配置监听mycat-是否存活" class="headerlink" title="配置监听mycat 是否存活"></a>配置监听mycat 是否存活</h4><p>在Mycat server1 Mycat server2 上都需要添加检测端口48700 的脚本，为此需要用到xinetd，xinetd 为linux 系统的基础服务。首先在xinetd 目录下面增加脚本与端口的映射配置文件</p>
<p>1、如果xinetd 没有安装，使用如下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xinetd -y</span><br></pre></td></tr></table></figure>

<p>2、检查&#x2F;etc&#x2F;xinetd.conf 的末尾是否有这一句：includedir &#x2F;etc&#x2F;xinetd.d 没有就加上</p>
<p>3、检查&#x2F;etc&#x2F;xinetd.d 文件夹是否存在，不存在也加上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> xinetd.d</span><br></pre></td></tr></table></figure>

<p>4、增加&#x2F;etc&#x2F;xinetd.d&#x2F;mycat_status 监听mycat 是否存活的配置,执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> xinetd.d </span><br><span class="line"><span class="built_in">cd</span> /etc/xinetd.d/ </span><br><span class="line"><span class="built_in">touch</span> mycat_status </span><br><span class="line">vim /etc/xinetd.d/mycat_status</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">service mycat_status </span><br><span class="line">&#123;</span><br><span class="line">flags = REUSE </span><br><span class="line">socket_type = stream </span><br><span class="line">port = 48700 </span><br><span class="line">wait = no </span><br><span class="line">user = root </span><br><span class="line">server =/usr/local/bin/mycat_status </span><br><span class="line">log_on_failure += USERID </span><br><span class="line">disable = no </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mycat_status 脚本 内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#/usr/local/bin/mycat_status.sh</span><br><span class="line">#This script checks if a mycat server is healthy running on localhost. It will</span><br><span class="line"></span><br><span class="line">#return: </span><br><span class="line">#&quot;HTTP/1.x 200 OK\r&quot; (if mycat is running smoothly)</span><br><span class="line"></span><br><span class="line">#&quot;HTTP/1.x 503 Internal Server Error\r&quot; (else)</span><br><span class="line"></span><br><span class="line">mycat=`/usr/local/mycat/bin/mycatstatus |grep&#x27;not running&#x27;| wc -l` </span><br><span class="line">if [ &quot;$mycat&quot; = &quot;0&quot; ];</span><br><span class="line">then </span><br><span class="line">/bin/echo-e&quot;HTTP/1.1 200 OK\r\n&quot; </span><br><span class="line">else </span><br><span class="line">/bin/echo-e&quot;HTTP/1.1 503 Service Unavailable\r\n&quot; </span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>6、&#x2F;etc&#x2F;services 中加入mycat_status 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line">vi services</span><br></pre></td></tr></table></figure>

<p>在末尾加入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mycat_status 48700/tcp # mycat_status</span><br></pre></td></tr></table></figure>

<p>保存，重启xinetd 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service xinetd restart</span><br></pre></td></tr></table></figure>

<p>7、验证mycat_status 服务是否启动成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -antup|grep 48700</span><br></pre></td></tr></table></figure>

<p>如果成功会显示如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="built_in">log</span>]<span class="comment"># netstat -antup|grep 48700 </span></span><br><span class="line">tcp 0 0 :::48700 :::* LISTEN 12609/xinetd</span><br></pre></td></tr></table></figure>

<h4 id="启动haproxy"><a href="#启动haproxy" class="headerlink" title="启动haproxy"></a>启动haproxy</h4><p>启动haproxy 前必须先启动keepalived，否则启动不了。 启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>

<p>启动haproxy 异常情况 如果报以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># /usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg </span></span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy admin_status: cannot <span class="built_in">bind</span> socket </span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy allmycat_service: cannot <span class="built_in">bind</span> socket </span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy allmycat_admin: cannot <span class="built_in">bind</span> socket</span><br></pre></td></tr></table></figure>

<p>原因为：该机器没有抢占到vip，如果另一台服务启动正常，这个错误可以忽略不管，如果另一台也一样，使 用ping vip 命令看看vip 是否生效，如果没有生效，说明keepalived 没有启动成功，回去检查keepalived 的异 常再说。</p>
<p>为了使用方便可以增加一个启动，停止haproxy 的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /usr/local/haproxy/sbin/starthaproxy </span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/haproxy/sbin/starthaproxy</span><br><span class="line"><span class="built_in">touch</span> /usr/local/haproxy/sbin/stophaproxy </span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/haproxy/sbin/stophaproxy</span><br></pre></td></tr></table></figure>

<p>启动脚本starthap 内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg &amp;</span><br></pre></td></tr></table></figure>

<p>停止脚本stophap 内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line">ps -ef | grep sbin/haproxy | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargs <span class="built_in">kill</span> -s 9</span><br></pre></td></tr></table></figure>

<p>启动后可以通过<a target="_blank" rel="noopener" href="http://192.168.8.108:48800/admin-status">http://192.168.8.108:48800/admin-status</a> (用户名密码都是admin，haproxy.cfg 中配置的)</p>
<h4 id="openssl-安装"><a href="#openssl-安装" class="headerlink" title="openssl 安装"></a>openssl 安装</h4><p>openssl 必须安装，否则安装keepalived 时无法编译，keepalived 依赖openssl。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf openssl-1.0.1g.tar.gz </span><br><span class="line">./config--prefix=/usr/local/openssl </span><br><span class="line">./config-t</span><br><span class="line">make depend </span><br><span class="line">make </span><br><span class="line">make <span class="built_in">test</span> </span><br><span class="line">make install </span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/openssl /usr/local/ssl</span><br></pre></td></tr></table></figure>

<p>openssl 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ld.so.conf</span><br></pre></td></tr></table></figure>

<p>在&#x2F;etc&#x2F;ld.so.conf 文件的最后面，添加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/openssl/lib</span><br></pre></td></tr></table></figure>

<p>配置环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> OPENSSL=/usr/local/openssl/bin </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$OPENSSL</span></span><br></pre></td></tr></table></figure>

<p>执行以下语句是环境变量生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>安装openssl-devel：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl-devel -y <span class="comment">#如无法yum 下载安装，请修改yum 配置文件</span></span><br></pre></td></tr></table></figure>

<p>测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldd /usr/local/openssl/bin/openssl </span><br><span class="line"></span><br><span class="line">    linux-vdso.so.1 =&gt; (0x00007fff996b9000) </span><br><span class="line">    libdl.so.2 =&gt;/lib64/libdl.so.2 (0x00000030efc00000) </span><br><span class="line">    libc.so.6 =&gt;/lib64/libc.so.6 (0x00000030f0000000) </span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00000030ef800000) </span><br><span class="line"></span><br><span class="line"><span class="built_in">which</span> openssl </span><br><span class="line">	/usr/bin/openssl </span><br><span class="line">openssl version </span><br><span class="line">	OpenSSL 1.0.0-fips 29 Mar 2010</span><br></pre></td></tr></table></figure>

<h4 id="keepalived-安装"><a href="#keepalived-安装" class="headerlink" title="keepalived 安装"></a>keepalived 安装</h4><p>本文在192.168.8.91、192.168.8.92 两台机器进行keepalived 安装 安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf keepalived-1.2.13.tar.gz </span><br><span class="line"><span class="built_in">cd</span> keepalived-1.2.13 </span><br><span class="line">./configure--prefix=/usr/local/keepalived </span><br><span class="line">make </span><br><span class="line">make install </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/sbin/keepalived /usr/sbin/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/rc.d/init.d/keepalived/etc/init.d/ </span><br><span class="line"><span class="built_in">mkdir</span> /etc/keepalived </span><br><span class="line"><span class="built_in">cd</span> /etc/keepalived/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/keepalived/keepalived.conf/etc/keepalived </span><br><span class="line">mkdir-p/usr/local/keepalived/var/log</span><br></pre></td></tr></table></figure>

<h4 id="keepalived-配置"><a href="#keepalived-配置" class="headerlink" title="keepalived 配置"></a>keepalived 配置</h4><p>创建检查haproxy 是否存活的脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/keepalived/scripts </span><br><span class="line"><span class="built_in">cd</span> /etc/keepalived/scripts</span><br></pre></td></tr></table></figure>

<p>配置 keepalived.conf:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<p>Master(192.168.8.91):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration Fileforkeepalived </span><br><span class="line">vrrp_script chk_http_port &#123; </span><br><span class="line">script<span class="string">&quot;/etc/keepalived/scripts/check_haproxy.sh&quot;</span> </span><br><span class="line">interval 2 </span><br><span class="line">weight 2 </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">state MASTER <span class="comment">#192.168.8.92 上为BACKUP </span></span><br><span class="line">interface eth0 <span class="comment">#对外提供服务的网络接口 </span></span><br><span class="line">virtual_router_id 51 <span class="comment">#VRRP 组名，两个节点的设置必须一样，以指明各个节点属于同一 VRRP 组 </span></span><br><span class="line">priority 150 <span class="comment">#数值愈大，优先级越高,192.168.8.92 上改为120 </span></span><br><span class="line">advert_int 1 <span class="comment">#同步通知间隔 </span></span><br><span class="line">authentication &#123; <span class="comment">#包含验证类型和验证密码。类型主要有PASS、AH 两种，通常使用的类型为 PASS，据说 AH 使用时有问题 </span></span><br><span class="line">auth_type PASS </span><br><span class="line">auth_pass 1111 </span><br><span class="line">&#125;</span><br><span class="line">track_script &#123; </span><br><span class="line">chk_http_port <span class="comment">#调用脚本check_haproxy.sh 检查haproxy 是否存活 </span></span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; <span class="comment">#vip 地址，这个ip 必须与我们在lvs 客户端设定的vip 相一致 </span></span><br><span class="line">192.168.8.108 dev eth0 scope global </span><br><span class="line">&#125;</span><br><span class="line">notify_master/etc/keepalived/scripts/haproxy_master.sh </span><br><span class="line">notify_backup/etc/keepalived/scripts/haproxy_backup.sh </span><br><span class="line">notify_fault /etc/keepalived/scripts/haproxy_fault.sh </span><br><span class="line">notify_stop /etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>slave(192.168.8.92)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration Fileforkeepalived </span><br><span class="line">vrrp_script chk_http_port &#123; </span><br><span class="line">script&quot;/etc/keepalived/scripts/check_haproxy.sh&quot; </span><br><span class="line">interval 2 </span><br><span class="line">weight 2 </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">state BACKUP </span><br><span class="line">interface eth0 #对外提供服务的网络接口</span><br><span class="line">virtual_router_id 51 #VRRP 组名，两个节点的设置必须一样，以指明各个节点属于同一 VRRP 组 </span><br><span class="line">priority 120 #数值愈大，优先级越高 </span><br><span class="line">advert_int 1 #同步通知间隔 </span><br><span class="line">authentication &#123; #包含验证类型和验证密码。类型主要有PASS、AH 两种，通常使用的类型为 PASS，据说 AH 使用时有问题 </span><br><span class="line">auth_type PASS </span><br><span class="line">auth_pass 1111 </span><br><span class="line">&#125;</span><br><span class="line">track_script &#123; </span><br><span class="line">chk_http_port #调用脚本check_haproxy.sh 检查haproxy 是否存活 </span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; #vip 地址，这个ip 必须与我们在lvs 客户端设定的vip 相一致 </span><br><span class="line">192.168.8.108 dev eth0 scope global </span><br><span class="line">&#125;</span><br><span class="line">notify_master /etc/keepalived/scripts/haproxy_master.sh </span><br><span class="line">notify_backup /etc/keepalived/scripts/haproxy_backup.sh </span><br><span class="line">notify_fault /etc/keepalived/scripts/haproxy_fault.sh</span><br><span class="line">notify_stop /etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>virtual_router_id 51 这个代表一个集群组，如果同一个网段还有另一组集群，请使用不同的组编号区分。 如换成52、53 等。</li>
<li>interface eth1 和192.168.8.108 dev eth1 scope global 中的eth1 指的是网卡，如果是多网卡，可能 会有eth0，eth1，eth2…，可以使用ifconfifig 命令查看，确保eth0 是本机存在的网卡地址。有些服务器如果只有一个网卡，但被人为把eth0 改成eth1 了，你再写eth0就找不到了的。</li>
</ol>
<p>check_haproxy.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/scripts/check_haproxy.sh</span><br></pre></td></tr></table></figure>

<p>脚本含义：如果没有haproxy 进程存在，就启动haproxy，停止keepalived。</p>
<p>check_haproxy.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=<span class="string">&quot;/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg&quot;</span> </span><br><span class="line">STOPKEEPALIVED=<span class="string">&quot;/etc/init.d/keepalived stop&quot;</span></span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[check_haproxy status]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line">A=`ps-C haproxy --no-header |wc-l` </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[check_haproxy status]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> <span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line">sleep5 </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `ps -C haproxy --no-header |wc-l` -eq0 ];<span class="keyword">then</span> </span><br><span class="line"><span class="built_in">exit</span> 0 </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"><span class="built_in">exit</span> 1 </span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>haproxy_master.sh(master 和slave 一样)</p>
<p>&#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_master.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=`/usr/local/haproxy/sbin/haproxy- f/usr/local/haproxy/haproxy.cfg` </span><br><span class="line">STOPHAPROXY=`ps-ef |grep sbin/haproxy| grep -vgrep|awk<span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargskill-s 9` </span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[master]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Being master....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STOPHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;haproxy stared ...&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>haproxy_backup.sh(master 和slave 一样)</p>
<p>&#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_backup.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=`/usr/local/haproxy/sbin/haproxy- f/usr/local/haproxy/haproxy.cfg` </span><br><span class="line">STOPHAPROXY=`ps-ef |grep sbin/haproxy| grep -vgrep|awk<span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargskill-s 9` </span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[backup]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Being backup....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STOPHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;haproxy stared ...&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>haproxy_fault.sh(master 和slave 一样) &#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_fault.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">LOGFILE=/usr/local/keepalived/var/log/keepalived-haproxy-state.log </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[fault]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line">haproxy_stop.sh(master 和slave 一样) </span><br><span class="line">/etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line"><span class="comment">#!/bin/bash </span></span><br><span class="line">LOGFILE=/usr/local/keepalived/var/log/keepalived-haproxy-state.log </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[stop]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>启用服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>

<h2 id="Mycat多类数据源完整解决方案"><a href="#Mycat多类数据源完整解决方案" class="headerlink" title="Mycat多类数据源完整解决方案"></a>Mycat多类数据源完整解决方案</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226174405.png"></p>
<h2 id="Mycat配置Zookeeper化"><a href="#Mycat配置Zookeeper化" class="headerlink" title="Mycat配置Zookeeper化"></a>Mycat配置Zookeeper化</h2><p>Mycat1.5开始支持配置zookeeper化，通过zookeeper管理Mycat-Server 。1.6 对zk 模块进行了重构，同时支持zk 的watch 机制，会将所有zk 上的变动同步到本地配置。</p>
<h3 id="配置zk化步骤"><a href="#配置zk化步骤" class="headerlink" title="配置zk化步骤"></a>配置zk化步骤</h3><p>1、配置myid.properties</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loadZk=<span class="literal">true</span> 是否启用zk </span><br><span class="line">zkURL=127.0.0.1:2181 zk地址支持多个 </span><br><span class="line">clusterId=mycat-cluster-1 mycat集群名称，即一组相同的mycat为一个集群，一个集 群名称配置唯一</span><br><span class="line">myid=mycat_fz_01 集群内部mycat 节点的<span class="built_in">id</span>，请保持集群内唯一</span><br></pre></td></tr></table></figure>

<p>2、在一个mycat实例上，在conf 下的zkconf 下配置常用的schemal rule server 等xml 文件</p>
<p>3、在该mycat实例上执行bin 目录下的init_zk_data.bat 或者init_zk_data.sh,会自动将zkconf下的所有配置文件上传到zk。</p>
<p>4.其他mycat实例，启动时如果loadzk&#x3D;true 会自动从zk 下载配置文件覆盖本地配置。</p>
<h3 id="zk-协调后端mysql-切换"><a href="#zk-协调后端mysql-切换" class="headerlink" title="zk 协调后端mysql 切换"></a>zk 协调后端mysql 切换</h3><p>server.xml 中配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useZKSwitch&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>则mycat 在进行切换时会自动通过zk协调，保证同一个集群下的mycat 都切换到一致的状态</p>
<h2 id="Mycat-性能测试指南"><a href="#Mycat-性能测试指南" class="headerlink" title="Mycat 性能测试指南"></a>Mycat 性能测试指南</h2><p>Mycat 自身提供了一套基准性能测试工具，这套工具可以用于性能测试、疲劳测试等，包括分片表插入性能 测试、分片表查询性能测试、更新性能测试、全局表插入性能测试等基准测试工具。</p>
<p>这里需要说明的一点是，分片表的性能测试不同于普通单表，因为它的数据是分布在几个Datahost 上的，因 此插入和查询，都必需要特定的工具，才能做到多个节点同时负载请求，通过观察每个主机的负载，能够确定是 否你的测试是合理和正确的。</p>
<p>大量测试表明，当带宽不是问题而且带宽没有占满，比如千兆网网络连接的Mycat 和MySQL服务器，以及 测试客户端，（通常个人电脑到服务器的连接为100M），分片表的性能取决于后端部署MySQL 的物理机的个 数，比如每个MySQL 的性能是5 万Tps，则3 台理论上是15万，而Mycat 能达到80-95%之间，即12 万以上。</p>
<p>关于带宽问题，是一个比较棘手的问题，通常需要监控交换机、MySQL 服务器、Mycat 服务器、以获取测试 过程中的端口流量信息，才能确定是否带宽存在问题，另外，很多企业里，千兆交换机采用了百兆的普通网线的 情况时有发生，防不胜防，所以，在不能控制的网络环境里，测试最大性能的目标通常无法实现。</p>
<p>另外，很多人测试的时候，并不知道MySQL 直连的性能，因此无法正确比较Mycat 的性能，所以，建议性 能测试过程里，首先直连MySQL 进行性能测试，可以同时直连多个MYSQL 服务器，然后把测试结果累计，作 为连的性能指标，然后改为连接Mycat 进行测试，这样的对比才是有价值的，当插件过大的时候，需要先排除 是否存在MySQL 冷热不均的现象，然后考虑Mycat 性能调优。</p>
<h3 id="测试工具获取"><a href="#测试工具获取" class="headerlink" title="测试工具获取"></a>测试工具获取</h3><p>测试工具在单独的包中，解压到任意机器中执行使用，跟MyCAT Server 没有关联关系，此测试工具很强 大，可以测试任意表，和任意数据库，测试工具下载：<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-download">https://github.com/MyCATApache/Mycat-download</a> 目录下的testtool.tar.gz 中。</p>
<p>解压后，在bin 目录里运行文中的测试脚本: </p>
<h3 id="标准插入性能测试脚本"><a href="#标准插入性能测试脚本" class="headerlink" title="标准插入性能测试脚本"></a>标准插入性能测试脚本</h3><p>标准插入性能测试脚本test_stand_insert_perf.sh 支持任意表的定制化业务数据的随机生成功能了，在sql 模板文件中用${int(1-100)}这种变量，测试程序会随机生成符合要求的值并插入数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test_stand_insert_perf.sh jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 10 file=mydata-create.sql</span><br></pre></td></tr></table></figure>

<p>其中mydata-create.sql 的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">total=10000000 </span><br><span class="line">sql=insert into my_table1 (….) values (<span class="string">&#x27;$&#123;date(yyyyMMddHHmmssSSS-[2014- 2015]y)&#125;-$&#123;int(0- 9999)&#125;ok$&#123;int(1111-9999)&#125;xxx &#x27;</span>,<span class="string">&#x27;$&#123;char([0-9]2:2)&#125; OPP_$&#123;enum(BJ,SH,WU,GZ)&#125;_1&#x27;</span>,10,<span class="variable">$&#123;int(10-999)&#125;</span>,<span class="variable">$&#123;int(10- 99)&#125;</span>,100,3,15,<span class="string">&#x27;$&#123;date(yyyyMMddHHmmssSSS-[2014-2015]y&#125;$&#123;char([a-f,0-9]8:8)&#125; &#x27;</span>,<span class="variable">$&#123;phone(139- 189)&#125;</span>,2,<span class="variable">$&#123;date(yyyyMMddHH-[2014-2015]y&#125;</span>,<span class="variable">$&#123;date(HHmmssSSS)&#125;</span>,<span class="variable">$&#123;int(100- 1000)&#125;</span>,<span class="string">&#x27;$&#123;enum(0000,0001,0002)&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>目前支持的有以下类型变量：</p>
<ul>
<li>Int:${int(..)} 可以是,${int(10-999)}或者,${int(10,999)}前者表示从10 到999 的值，后者表示10 或者999</li>
<li>Date:日期如${date(yyyyMMddHHmmssSSS-[2014-2015]y)}表示从2014 到2015 年的时间，前面是输出格式，符 合Java 标准</li>
<li>Char:字符串${char([0-9]2:2)}表示从0 到9 的字符，长度为2 位（2:2），}${char([a-f,0-9]8:8)}表示从a 到f 以及0 到9 的字符串随机组成，定常为8 位。</li>
<li>Enmu:枚举，表示从指定范围内获取一个值，${enum(0000,0001,0002)}，里面可以是任意字符串或数字等内容。</li>
</ul>
<h3 id="标准查询性能测试脚本"><a href="#标准查询性能测试脚本" class="headerlink" title="标准查询性能测试脚本"></a>标准查询性能测试脚本</h3><p>标准查询性能测试脚本test_stand_select_perf 也支持sqlTemplate 的变量方式，查询任意指定的sql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test_stand_select_perf.sh jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 10 100000 file=mysql-select.sql</span><br></pre></td></tr></table></figure>

<p>其中oppcall-select.sql 的内容类似下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql=<span class="keyword">select</span> * from mytravelrecord <span class="built_in">where</span> <span class="built_in">id</span> = <span class="variable">$&#123;int(1-1000000)&#125;</span></span><br></pre></td></tr></table></figure>

<p>表明查询id 为1 到1000000 之间的随机SQL。</p>
<p><strong>注意：</strong>Windows 下fifile&#x3D;xxx.slq 需要加引号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_insert_perf.bat jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 50 <span class="string">&quot;file=oppcall.sql&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试说明"><a href="#测试说明" class="headerlink" title="测试说明"></a>测试说明</h3><p>首先参考MyCAT 性能调优，确保整个系统达到最优配置。</p>
<p>性能测试，建议先小规模压力预热10-20 分钟，这是众所周知的Java 的特性，越跑越快。</p>
<p>测试的硬件和网络条件：</p>
<ul>
<li>建议至少3 台服务器；</li>
<li>MyCAT Server 一台；</li>
<li>Mysql 一台；</li>
<li>带宽应该是至少100M，建议千兆；</li>
<li>压力程序在另一台，压力程序的机器也可以由性能差的机器来代替。</li>
</ul>
<p>有条件的话，分片库在不同的MYSQL 实例上，如20 个分片，每个MYSQL 实例7 个分片，而且最好有多台 MYSQL 物理机。</p>
<h3 id="分片表的录入性能测试-T01"><a href="#分片表的录入性能测试-T01" class="headerlink" title="分片表的录入性能测试-T01"></a>分片表的录入性能测试-T01</h3><p>测试案例：分片表的并发录入性能测试，测试DEMO 中的travelrecord 表，此表的基准DDL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> travelrecord ( </span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key, </span><br><span class="line">    user_id <span class="type">varchar</span>(<span class="number">100</span>), </span><br><span class="line">    traveldate <span class="type">DATE</span>, </span><br><span class="line">    fee <span class="type">decimal</span>, </span><br><span class="line">    days <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>此表的标准分片方式为基于ID 范围的自动分片策略。Schema.xml 中配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;travelrecord&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding- long&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认是3 个分片，分片ID 范围定义在autopartition-long.txt 中，建议修改为以下或更大的数值范围分片， 每个分片500 万数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#range start-end ,data node index </span></span><br><span class="line"></span><br><span class="line">0-2000000=0 </span><br><span class="line">2000001-4000000=1 </span><br><span class="line">4000001-6000000=2</span><br></pre></td></tr></table></figure>

<p>根据自己的情况，可以每个分片放更多的数据，进行对比性能测试，当分片index 增加时，注意dataNode 也增加（dataNode&#x3D;“dn1,dn2,dn3”）。</p>
<p>测试的输入参数如下[jdbcurl] [user] [password] [threadpoolsize] [recordrange]：</p>
<ul>
<li>Jdbcurl:连接mycat 的地址，格式为jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB</li>
<li>User 连接Mycat 的用户名</li>
<li>Password:密码</li>
<li>Threadpoolsize:并发线程请求，可以在50-2000 左右调整，看看哪种情况下的性能最好</li>
<li>Recordrang:插入的分片系列以及对应的ID 范围，minId-maxId 然后逗号分开，对应多组</li>
<li>分片的ID 范围，如0-200000,200001-400000,400001-600000，跟分片配置保持一致。</li>
</ul>
<h3 id="测试过程："><a href="#测试过程：" class="headerlink" title="测试过程："></a>测试过程：</h3><p>每次测试，建议先执行重建表的操作，以保证测试环境的一致性： 连接mycat 8066 端口，在命令行执行下面的操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> travelrecord; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> travelrecord ( </span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key,</span><br><span class="line">    user_id <span class="type">varchar</span>(<span class="number">100</span>), </span><br><span class="line">    traveldate <span class="type">DATE</span>, </span><br><span class="line">    fee <span class="type">decimal</span>, </span><br><span class="line">    days <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>先预测试： 执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_insert_perf jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 100 “0-100M,100M1-200M,200M1-400M”</span><br></pre></td></tr></table></figure>

<p>MyCAT 温馨提示：并发线程数表明同时至少有多少个Mysql 连接会被打开，当SQL 不跨分片的时候，并发线程数 &#x3D;MYSQL 连接数，在Mycat conf&#x2F;schema.xml 中，将minCon 设置为&gt;&#x3D;并发连接数，这种情况下重启MYCAT，会 初始建立minCon 个连接，并发测试结果更好，另外，也可以验证是否当前内存设置，以及MYSQL 是否支持开启这么多连接，若无法支持，则logs&#x2F;mycat.log 日志中会有告警错误信息，建议测试过程中tail –f logs&#x2F;mycat.log 观察有无错误信息。另外，开启单独的Mycat 管理窗口，mysql –utest –ptest –P9066 然后运行show@@datasource 可以看到后端连接的使用情况。Show @@threadpool 可以看线程和SQL 任务积压的情况。 也可以同时启动多个测试程序,在不同的机器上，并发进行测试，每个测试程序写入一个分片的数据范围，对于1 个亿的数据插入测试来说，可能效果更好，毕竟单机并发线程50 个左右已经差不多极限： test_stand_insert_perf jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB test test 100 “0-100M” est_stand_insert_perf jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB test test100 100M1-200M”</p>
<h3 id="全局表的查询性能测试T02："><a href="#全局表的查询性能测试T02：" class="headerlink" title="全局表的查询性能测试T02："></a>全局表的查询性能测试T02：</h3><p>全局表自动在多个节点上同步插入，因此其插入性能有所降低，这里的插入表为goods 表，执行的命令类似 T01 的测试。温馨提示：全局表是同时往多个分片上写数据，因此所需并发MYSQL 数连接为普通表的3 倍，最 好的模式是全局表分别在多个mysql 实例上。 建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> goods; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> goods( </span><br><span class="line">	id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">200</span>), </span><br><span class="line">    good_type tinyint, </span><br><span class="line">    good_img_url <span class="type">varchar</span>(<span class="number">200</span>), </span><br><span class="line">    good_created <span class="type">date</span>, </span><br><span class="line">    good_desc <span class="type">varchar</span>(<span class="number">500</span>), </span><br><span class="line">    price <span class="keyword">double</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_globaltable_insert_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">100</span> <span class="number">1000000</span></span><br></pre></td></tr></table></figure>

<p>本机笔记本，4G 内存，数据库与Mycat 以及测试程序都在一起，跑出来每秒1000 多的插入速度。</p>
<h3 id="分片表的查询性能测试T03："><a href="#分片表的查询性能测试T03：" class="headerlink" title="分片表的查询性能测试T03："></a>分片表的查询性能测试T03：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发随机查询，此测试是在分片 库上，基于分片的主键ID 进行随机查询，返回单条记录，多线程并发随机执行N此记录查询，每次查询的记录主 键ID 是随机选择，在maxID(参数)范围之内。</p>
<p>测试工具test_stand_select_perf 的参数如下</p>
<p>[jdbcurl] [user] [password] [threadpoolsize] [executetimes] [maxId]</p>
<ul>
<li>Executetimes：每个线程总共执行多少次随机查询，建议1000 次以上</li>
<li>maxId：travelrecord 表的最大ID，可以执行select max(id) from travelrecord 来获取。</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_select_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">100</span> <span class="number">10000</span> <span class="number">50000</span></span><br></pre></td></tr></table></figure>

<h3 id="分片表的汇聚性能测试T04："><a href="#分片表的汇聚性能测试T04：" class="headerlink" title="分片表的汇聚性能测试T04："></a>分片表的汇聚性能测试T04：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发随机查询，此测试执行分片 库上的聚合、排序、分页的性能，SQL 如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(fee) total_fee, days,<span class="built_in">count</span>(id),<span class="built_in">max</span>(fee),<span class="built_in">min</span>(fee) <span class="keyword">from</span> travelrecord <span class="keyword">group</span> <span class="keyword">by</span> days <span class="keyword">order</span> <span class="keyword">by</span> days <span class="keyword">desc</span> limit ？</span><br></pre></td></tr></table></figure>

<p>测试工具test_stand_merge_sel_perf 的参数如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[jdbcurl] [user] [password] [threadpoolsize] [executetimes] [limit]</span><br></pre></td></tr></table></figure>

<ul>
<li>Executetimes：每个线程总共执行多少次随机查询，建议1000 次以上</li>
<li>limit：分页返回的记录个数，必须大于30</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_merge_sel_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">10</span> <span class="number">100</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h3 id="分片表的更新性能测试T05："><a href="#分片表的更新性能测试T05：" class="headerlink" title="分片表的更新性能测试T05："></a>分片表的更新性能测试T05：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发更新操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> travelrecord <span class="keyword">set</span> <span class="keyword">user</span> <span class="operator">=</span>? ,traveldate<span class="operator">=</span>?,fee<span class="operator">=</span>?,days<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>

<p>测试工具test_stand_update_perf 的参数如下</p>
<p>[jdbcurl] [user] [password] [threadpoolsize] [record]</p>
<ul>
<li>record：总共修改多少条记录，&gt;5000</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_update_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">10</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h2 id="监控与管理"><a href="#监控与管理" class="headerlink" title="监控与管理"></a>监控与管理</h2><h3 id="管理命令与监控"><a href="#管理命令与监控" class="headerlink" title="管理命令与监控"></a>管理命令与监控</h3><p>请参考《Mycat权威指南》 高级进阶篇 第8章 “管理命令与监控”。</p>
<h3 id="Mycat-Web"><a href="#Mycat-Web" class="headerlink" title="Mycat-Web"></a>Mycat-Web</h3><p>请参考《Mycat权威指南》 高级进阶篇 第10章 “Mycat-Web” 和 <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Web">https://github.com/MyCATApache/Mycat-Web</a></p>
<h3 id="Mycat-mini-monitor"><a href="#Mycat-mini-monitor" class="headerlink" title="Mycat-mini-monitor"></a>Mycat-mini-monitor</h3><p>使用参考：<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-mini-monitor">https://github.com/MyCATApache/Mycat-mini-monitor</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/05-MyCat%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-id="clmcxed6900cmu8wabqzf1rpo" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/01-ShardingSphere%E6%A6%82%E8%A7%88/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2023/09/10/11-MySQL/02-MyCat/04-MyCat%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>