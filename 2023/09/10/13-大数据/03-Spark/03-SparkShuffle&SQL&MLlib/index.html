<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Spark Shuffle 解析宽依赖和窄依赖 窄依赖 没有数据shuffling 所有父RDD中的Partition均会和子RDD的Partition关系是一对一      宽依赖 有数据shuffling 所有父RDD中的Partition会被切分，根据key的不同划分到子RDD的Partition中     回顾 Stage什么是Stage  一个Job会被拆分为多组Task，每组Task被">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2023/09/10/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/03-Spark/03-SparkShuffle&SQL&MLlib/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Spark Shuffle 解析宽依赖和窄依赖 窄依赖 没有数据shuffling 所有父RDD中的Partition均会和子RDD的Partition关系是一对一      宽依赖 有数据shuffling 所有父RDD中的Partition会被切分，根据key的不同划分到子RDD的Partition中     回顾 Stage什么是Stage  一个Job会被拆分为多组Task，每组Task被">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220221711.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220221827.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220222050.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306195805.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306195849.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200055.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200203.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200304.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200419.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200503.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200734.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200953.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201108.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201150.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201729.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201938.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202002.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202048.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202628.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202933.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306203028.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306203120.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220404112704.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306204539.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306204833.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205421.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205450.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205524.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205628.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205524.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205728.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205809.png">
<meta property="article:published_time" content="2023-09-10T03:59:07.646Z">
<meta property="article:modified_time" content="2022-09-03T09:25:37.839Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220221711.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-13-大数据/03-Spark/03-SparkShuffle&amp;SQL&amp;MLlib" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/03-Spark/03-SparkShuffle&SQL&MLlib/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.646Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spark-Shuffle-解析"><a href="#Spark-Shuffle-解析" class="headerlink" title="Spark Shuffle 解析"></a>Spark Shuffle 解析</h1><h2 id="宽依赖和窄依赖"><a href="#宽依赖和窄依赖" class="headerlink" title="宽依赖和窄依赖"></a>宽依赖和窄依赖</h2><ul>
<li>窄依赖<ul>
<li>没有数据shuffling</li>
<li>所有父RDD中的Partition均会和子RDD的Partition关系是一对一</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220221711.png"></p>
<ul>
<li>宽依赖<ul>
<li>有数据shuffling</li>
<li>所有父RDD中的Partition会被切分，根据key的不同划分到子RDD的Partition中</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220221827.png"></p>
<h2 id="回顾-Stage"><a href="#回顾-Stage" class="headerlink" title="回顾 Stage"></a>回顾 Stage</h2><p>什么是Stage</p>
<ul>
<li>一个Job会被拆分为多组Task，每组Task被称为一个Stage</li>
</ul>
<p>划分依据</p>
<ul>
<li>以shuffle操作作为边界，遇到一个宽依赖就分一个stage</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220220222050.png"></p>
<h2 id="引起shuffle的算子"><a href="#引起shuffle的算子" class="headerlink" title="引起shuffle的算子"></a>引起shuffle的算子</h2><ul>
<li>repartition</li>
<li>groupByKey</li>
<li>combineByKey</li>
<li>reduceByKey</li>
<li>aggregateByKey</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306195805.png"></p>
<ul>
<li>intersection</li>
<li>join</li>
<li>cogroup</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306195849.png"></p>
<h2 id="MapReduce-Shuffle-回顾"><a href="#MapReduce-Shuffle-回顾" class="headerlink" title="MapReduce Shuffle 回顾"></a>MapReduce Shuffle 回顾</h2><p>map 数据映射，reduce 数据聚合</p>
<ul>
<li>Map端完成之后会暴露一个Http Server共Reduce端获取数据</li>
<li>Reduce启动拷贝线程从各个Map端拷贝结果<ul>
<li>有大量的网络I&#x2F;O开销</li>
</ul>
</li>
<li>一边拷贝一边进行Merge操作（归并排序）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200055.png"></p>
<h2 id="Spark-Shuffle-两阶段"><a href="#Spark-Shuffle-两阶段" class="headerlink" title="Spark Shuffle 两阶段"></a>Spark Shuffle 两阶段</h2><p>为什么 spark 不把 shuffle 结果直接写到内存而是写到磁盘？</p>
<ol>
<li>一般大数据场景数据都是TB、PB级别，全部写到内存可能会内存溢出，内存放不下</li>
<li>即便内存放下，由于程序、网路等原因导致节点宕机，整个 shuffle 要重新计算，成本较高</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200203.png"></p>
<h2 id="Shuffle-是个昂贵的操作"><a href="#Shuffle-是个昂贵的操作" class="headerlink" title="Shuffle 是个昂贵的操作"></a>Shuffle 是个昂贵的操作</h2><ul>
<li><p>数据分区</p>
<p>一个RDD到另一个RDD转换就需要进行数据分区，基本上90%的分区都是HashPartition，剩下为RangePartition，sortByKey底层就是RangePartition</p>
</li>
<li><p>序列化反序列化</p>
<p>数据落到磁盘上就会涉及到序列化和反序列化，序列化反序列化会非常消耗cpu，优化可以从序列化反序列化去考虑</p>
</li>
<li><p>数据压缩</p>
<p>分布式计算情况下，节点与节点之间交互需要通过网络传输，网络带宽资源是有限的，需要对数据进行一定程度压缩，并不是所有数据都需要压缩，因为压缩数据也是需要耗费cpu的，当传输成本大于cpu成本可以考虑开启压缩</p>
</li>
<li><p>磁盘IO</p>
<p>大数据场景写入数据是有序的可以减少磁盘寻道的时间，这样吞吐量也高</p>
</li>
</ul>
<h2 id="Shuffle-实现进化历史"><a href="#Shuffle-实现进化历史" class="headerlink" title="Shuffle 实现进化历史"></a>Shuffle 实现进化历史</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200304.png"></p>
<h2 id="Shuffle-相关组件"><a href="#Shuffle-相关组件" class="headerlink" title="Shuffle 相关组件"></a>Shuffle 相关组件</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200419.png"></p>
<h2 id="Hash-Shuffle"><a href="#Hash-Shuffle" class="headerlink" title="Hash Shuffle"></a>Hash Shuffle</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200503.png"></p>
<h2 id="Hash-Shuffle-存在的问题？"><a href="#Hash-Shuffle-存在的问题？" class="headerlink" title="Hash Shuffle 存在的问题？"></a>Hash Shuffle 存在的问题？</h2><p><strong>打开文件过多</strong></p>
<ul>
<li>假设N(Shuffle Map Task) &#x3D; 1000，N(Following Task) &#x3D; 500，则会生成50万个小文件。</li>
<li>每打开一个文件需要占用一定量内存空间，假设一个句柄占据100K，则50万个小文件需要占据50GB。</li>
</ul>
<p><strong>大量随机IO</strong></p>
<ul>
<li>Shuffle Map Task随机写。</li>
<li>Following Task随机读。</li>
<li>机械磁盘的随机性能远不如顺序写入性能。</li>
</ul>
<p><strong>频繁GC</strong></p>
<ul>
<li>打开关闭文件</li>
<li>大量的序列化反序列化操作</li>
</ul>
<h2 id="Sort-Shuffle"><a href="#Sort-Shuffle" class="headerlink" title="Sort Shuffle"></a>Sort Shuffle</h2><p>先在内存中进行分区，快写满时进行一个排序写入到磁盘，当这个行为发送n次，说明在磁盘生成n个文件。把n个文件合并成一个大的文件，merge sort可以快速进行排序，因为磁盘上的文件已经是有序的，还会生成一个index，下游在读取的时候会从这里读取数据偏移量再从文件中偏移量位置读取数据。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200734.png"></p>
<h2 id="Sort-Shuffle-存在的问题？"><a href="#Sort-Shuffle-存在的问题？" class="headerlink" title="Sort Shuffle 存在的问题？"></a>Sort Shuffle 存在的问题？</h2><p><strong>需要进行排序</strong></p>
<ul>
<li>Spill写入文件的时候需要按照partitionId对Key进行排序</li>
<li>在merge阶段需要对进行归并排序合并成一个大文件</li>
</ul>
<p><strong>大量序列化反序列化</strong></p>
<ul>
<li>Spill写入文件时</li>
<li>合并文件进行归并排序时</li>
</ul>
<h2 id="Sort-Shuffle-改进-Tungsten-计划"><a href="#Sort-Shuffle-改进-Tungsten-计划" class="headerlink" title="Sort Shuffle 改进 Tungsten 计划"></a>Sort Shuffle 改进 Tungsten 计划</h2><h3 id="改进措施1：更高级的内存管理"><a href="#改进措施1：更高级的内存管理" class="headerlink" title="改进措施1：更高级的内存管理"></a>改进措施1：更高级的内存管理</h3><ul>
<li><p>使用sun.misc.Unsafe直接管理内存，消除GC</p>
</li>
<li><p>例如一个简单字符串abcd，实际占用24个字节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.String object internals:</span><br><span class="line">OFFSET SIZE TYPE DESCRIPTION VALUE</span><br><span class="line">0 4 (object header) ...</span><br><span class="line">4 4 (object header) ...</span><br><span class="line">8 4 (object header) ...</span><br><span class="line">12 4 char[] String.value []</span><br><span class="line">16 4 int String.hash 0</span><br><span class="line">20 4 int String.hash32 0</span><br><span class="line">Instance size: 24 bytes (reported by Instrumentation API)</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306200953.png"></p>
<h3 id="改进措施2：缓存感知计算"><a href="#改进措施2：缓存感知计算" class="headerlink" title="改进措施2：缓存感知计算"></a>改进措施2：缓存感知计算</h3><p>核心：尽可能把数据放到靠近cpu的缓存中</p>
<p>下图有一个ptr的数组，里面存放的是指针，指针指向key value存储的地方，我们排序的时候移动的是每一个指针的位置，ptr2大于ptr3，我们交互的是这俩个指针的，cpu在做计算的时候是先访问数组，再访问对应key value，往往我们可以把数组放到L1、L2、L3中，但是key value信息比较大，往往是在Memory中，所以cpu会在L1、L2、L3和Memory中来回奔波。我们可以把key和指针存放到一起，指针指向的是value，交换的时候直接在数组中进行交换，因为key类型都是固定的，例如long、int，量可控，把key和指针放到一起就更有可能把整个排序数组放到cpu的缓存中去。tungsten 实现后有3倍的性能提升</p>
<ul>
<li>提高缓存命中率</li>
<li>速度 L1&gt;L2&gt;L3&gt;内存&gt;磁盘</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201108.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201150.png"></p>
<h2 id="But-使用Tungsten限制条件"><a href="#But-使用Tungsten限制条件" class="headerlink" title="But 使用Tungsten限制条件"></a>But 使用Tungsten限制条件</h2><ol>
<li>在shuffle阶段不能有aggregate：例如reduceByKey</li>
<li>分区数不能超过2<sup>24</sup> − 1</li>
</ol>
<h2 id="Shuffle调优"><a href="#Shuffle调优" class="headerlink" title="Shuffle调优"></a>Shuffle调优</h2><ol>
<li><p>调整spill频率</p>
<ul>
<li>spark.shuffle.file.buffer<ul>
<li>map task的内存缓冲调节参数，默认是32kb</li>
</ul>
</li>
<li>spark.shuffle.memoryFraction<ul>
<li>reduce端聚合内存占比，默认0.2</li>
</ul>
</li>
<li>如何调整？<ul>
<li>通过监控平台观察shuffle write和shuffle read的运行次数</li>
</ul>
</li>
</ul>
</li>
<li><p>尽量减少Shuffle次数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两次shuffle</span></span><br><span class="line">rdd.map(...).repartition(<span class="number">1000</span>).reduceByKey(_ + _, <span class="number">3000</span>)</span><br><span class="line"><span class="comment">// 一次shuffle</span></span><br><span class="line">rdd.map(...).reduceByKey(_ + _, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Spark-SQL-原理"><a href="#Spark-SQL-原理" class="headerlink" title="Spark SQL 原理"></a>Spark SQL 原理</h1><h2 id="Spark-SQL"><a href="#Spark-SQL" class="headerlink" title="Spark SQL"></a>Spark SQL</h2><p>Spark一个模块，用于处理结构化数据</p>
<ul>
<li>无缝集成SQL查询</li>
<li>统一数据访问方法</li>
<li>Hive高度集成</li>
<li>支持JDBC和ODBC</li>
<li>多语言Scala Python</li>
</ul>
<h2 id="Spark-SQL-Example"><a href="#Spark-SQL-Example" class="headerlink" title="Spark SQL Example"></a>Spark SQL Example</h2><p>在Spark程序中无缝集成SQL查询</p>
<ol>
<li>df.registerTempTable(“course_score”)</li>
<li>sqlContext.sql(“select name, avg(score) from course_score group by name”).show()</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201729.png"></p>
<h2 id="Spark-SQL-原理-1"><a href="#Spark-SQL-原理-1" class="headerlink" title="Spark SQL 原理"></a>Spark SQL 原理</h2><p><strong>score表</strong></p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>LONG</td>
</tr>
<tr>
<td>match_score</td>
<td>INT</td>
</tr>
<tr>
<td>english_score</td>
<td>INT</td>
</tr>
</tbody></table>
<p><strong>people表</strong></p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>LONG</td>
</tr>
<tr>
<td>age</td>
<td>INT</td>
</tr>
<tr>
<td>name</td>
<td>STRING</td>
</tr>
</tbody></table>
<p>求大于18岁的同学总成绩平均分</p>
<ol>
<li>首先由SqlParser将sql解析为一棵树，这棵树称为没有分析的执行计划</li>
<li>Analyzer分析器分析没有分析的执行计划得到逻辑执行树，包含执行的关键信息，可以拿这棵树进行执行了，但是还需要再进行优化。</li>
<li>Optimizer进行sql优化，对于分析后的这棵树进行等价的交互，保证执行结果的正确性</li>
<li>Planner将优化后的逻辑执行树生成一个物理的执行计划</li>
<li>Prepare for Execution将Spark Plan转换为一个可以执行的计划</li>
<li>最终将给execute转换为RDD进行计算</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306201938.png"></p>
<h2 id="SQL-Parser"><a href="#SQL-Parser" class="headerlink" title="SQL Parser"></a>SQL Parser</h2><p>SqlBase.g4文件：<a target="_blank" rel="noopener" href="https://github.com/apache/spark/blob/v2.4.0/sql/catalyst/src/main/antlr4/org/apache/spark/sql/catalyst/parser/SqlBase.g4">https://github.com/apache/spark/blob/v2.4.0/sql/catalyst/src/main/antlr4/org/apache/spark/sql/catalyst/parser/SqlBase.g4</a></p>
<p>idea安装antlr插件，输入SELECT * FROM SCORE，注意要全大写，然后点击文件49行的singleStatement右键Test Rule singleStatement就可以得到抽象语法树（AST）</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202002.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202048.png"></p>
<h2 id="SQL-Analyzer"><a href="#SQL-Analyzer" class="headerlink" title="SQL Analyzer"></a>SQL Analyzer</h2><ol>
<li>经过Parser之后的LogicalPlan并不知道如何执行</li>
<li>需要绑定不确定的属性和关系<ul>
<li>解析表名<ul>
<li>临时表</li>
<li>临时view</li>
<li>hive table</li>
<li>hive view</li>
</ul>
</li>
<li>解析具体的schema结构<ul>
<li>字段类型</li>
<li>存储位置</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202628.png"></p>
<h2 id="SQL-Optimizer"><a href="#SQL-Optimizer" class="headerlink" title="SQL Optimizer"></a>SQL Optimizer</h2><ol>
<li><p>不同用户提交SQL质量不同</p>
</li>
<li><p>保证SQL需要被高效执行</p>
</li>
<li><p>Spark SQL主要采用规则优化方法</p>
<ol>
<li><p>谓词下推</p>
<p>减少参与计算的数据量</p>
</li>
<li><p>列值裁剪</p>
<p>减少Filter与Project操作的中间结果集数据量</p>
</li>
<li><p>常量累加</p>
<p>减少重复计算</p>
</li>
<li><p>Join重排序</p>
<p>尽可能地将带有条件过滤的子执行计划下推到执行树的最底层</p>
</li>
</ol>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// Operator push down</span><br><span class="line">PushProjectionThroughUnion,</span><br><span class="line">ReorderJoin,</span><br><span class="line">EliminateOuterJoin,</span><br><span class="line">PushPredicateThroughJoin,</span><br><span class="line">PushDownPredicate,</span><br><span class="line">LimitPushDown(conf),</span><br><span class="line">ColumnPruning,</span><br><span class="line">InferFiltersFromConstraints,</span><br><span class="line"></span><br><span class="line">// Operator combine</span><br><span class="line">CollapseRepartition,</span><br><span class="line">CollapseProject,</span><br><span class="line">CollapseWindow,</span><br><span class="line">CombineFilters,</span><br><span class="line">CombineLimits,</span><br><span class="line">CombineUnions,</span><br><span class="line"></span><br><span class="line">// Constant folding and strength reduction</span><br><span class="line">NullPropagation(conf),</span><br><span class="line">FoldablePropagation,</span><br><span class="line">OptimizeIn(conf),</span><br><span class="line">ConstantFolding,</span><br><span class="line">ReorderAssociativeOperator,</span><br><span class="line">LikeSimplification,</span><br><span class="line">BooleanSimplification,</span><br><span class="line">SimplifyConditionals,</span><br><span class="line">RemoveDispensableExpressions,</span><br><span class="line">SimplifyBinaryComparison,</span><br><span class="line">PruneFilters,</span><br><span class="line">EliminateSorts,</span><br><span class="line">SimplifyCasts,</span><br><span class="line">SimplifyCaseConversionExpressions,</span><br><span class="line">RewriteCorrelatedScalarSubquery,</span><br><span class="line">EliminateSerialization,</span><br><span class="line">RemoveRedundantAliases,</span><br><span class="line">RemoveRedundantProject,</span><br><span class="line">SimplifyCreateStructOps,</span><br><span class="line">SimplifyCreateArrayOps,</span><br><span class="line">SimplifyCreateMapOps</span><br></pre></td></tr></table></figure>

<h3 id="SQL-Optimizer-谓词下推"><a href="#SQL-Optimizer-谓词下推" class="headerlink" title="SQL Optimizer 谓词下推"></a>SQL Optimizer 谓词下推</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306202933.png"></p>
<h3 id="SQL-Optimizer-列值裁剪"><a href="#SQL-Optimizer-列值裁剪" class="headerlink" title="SQL Optimizer 列值裁剪"></a>SQL Optimizer 列值裁剪</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306203028.png"></p>
<h2 id="SQL-Planner"><a href="#SQL-Planner" class="headerlink" title="SQL Planner"></a>SQL Planner</h2><ol>
<li><p>与RDD进行绑定</p>
</li>
<li><p>选取执行策略</p>
<p>FileSourceStrategy</p>
<p>DataSourceStrategy</p>
<p>SpecialLimits</p>
<p>Aggregation</p>
<p>JoinSelection</p>
<p>InMemoryScans</p>
<p>BasicOperators</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306203120.png"></p>
<h2 id="RDD-DataFrame"><a href="#RDD-DataFrame" class="headerlink" title="RDD DataFrame"></a>RDD DataFrame</h2><p>Spark本身并不清楚RDD中Person内部的结构</p>
<ul>
<li>执行时无法优化</li>
</ul>
<p>DataFrame提供了详细的结构信息</p>
<ul>
<li>分布式Row对象集合</li>
<li>算子更加丰富</li>
<li>执行计划优化</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220404112704.png"></p>
<h2 id="Spark-SQL-实战"><a href="#Spark-SQL-实战" class="headerlink" title="Spark SQL 实战"></a>Spark SQL 实战</h2><p>创建DataFrame</p>
<ul>
<li>createDataFrame方法</li>
<li>RDD调用toDF方法 </li>
<li>直接读取JSON </li>
<li>从Hive表中读取</li>
</ul>
<p>执行业务逻辑</p>
<ul>
<li>sqlContext、sparkSession执行</li>
<li>DataFrame API</li>
</ul>
<h3 id="Spark-SQL-实战-1-6"><a href="#Spark-SQL-实战-1-6" class="headerlink" title="Spark SQL 实战 1.6"></a>Spark SQL 实战 1.6</h3><ol>
<li><p>初始化SparkContext</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">conf.setAppName(<span class="string">&quot;DataFrameSQL&quot;</span>).setMaster(<span class="string">&quot;local[4]&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化SQLContext</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sqlContext = <span class="keyword">new</span> <span class="type">SQLContext</span>(sc)</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成DataFrame</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlContext.implicits._</span><br><span class="line"><span class="keyword">val</span> df = <span class="type">Seq</span>( (<span class="number">1</span>, <span class="string">&quot;Bill&quot;</span>, <span class="string">&quot;Computer Science&quot;</span>, <span class="number">100</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&quot;Bill&quot;</span>, <span class="string">&quot;Math&quot;</span>, <span class="number">85</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&quot;Bill&quot;</span>, <span class="string">&quot;English&quot;</span>, <span class="number">90</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Math&quot;</span>, <span class="number">82</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Music&quot;</span>, <span class="number">90</span>),</span><br><span class="line">(<span class="number">6</span>, <span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Chemistry&quot;</span>, <span class="number">85</span>)</span><br><span class="line">).toDF(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;course&quot;</span>, <span class="string">&quot;score&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用算子执行业务逻辑</p>
<ul>
<li><p>使用标准SQL执行业务逻辑</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df.registerTempTable(<span class="string">&quot;course_score&quot;</span>)</span><br><span class="line">sqlContext.sql(<span class="string">&quot;select name, avg(score) from course_score group by name&quot;</span>).show()</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用DataFrame API执行业务逻辑</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df.groupBy(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">.avg(<span class="string">&quot;score&quot;</span>)</span><br><span class="line">.show()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="Spark-SQL-实战-2-0"><a href="#Spark-SQL-实战-2-0" class="headerlink" title="Spark SQL 实战 2.0"></a>Spark SQL 实战 2.0</h3><p>sqlContext、HiveContext不能使用，改为sparkSession，统一API、Hive、DataFrame、DataSet</p>
<ol>
<li><p>初始化SparkSession</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> spark = <span class="type">SparkSession</span></span><br><span class="line">.builder()</span><br><span class="line">.appName(<span class="string">&quot;Spark SQL Example&quot;</span>)</span><br><span class="line">.master(<span class="string">&quot;local[4]&quot;</span>)</span><br><span class="line">.config(<span class="string">&quot;spark.some.config.option&quot;</span>, <span class="string">&quot;some-value&quot;</span>)</span><br><span class="line">.getOrCreate()</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载数据</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> dataSet = spark.range(<span class="number">5</span>, <span class="number">100</span>, <span class="number">5</span>)</span><br><span class="line"><span class="keyword">val</span> dataFrame = spark.read.json(<span class="string">&quot;examples/src/main/resources/people.json&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> resultsDF = spark.sql(<span class="string">&quot;SELECT city, pop, state, zip FROM zips_table&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Enjoy Computing</p>
</li>
</ol>
<h2 id="Spark-SQL-数据倾斜"><a href="#Spark-SQL-数据倾斜" class="headerlink" title="Spark SQL 数据倾斜"></a>Spark SQL 数据倾斜</h2><p>什么是MapJoin？<br>    join尽量不发生在reduce阶段，发生在map阶段。拿成绩数据来讲，每个人的id、name、age数据量比较少，是一个字典表，完全可以把这个数据广播到每一个节点，生成一个hashTable，直接通过查id得到name和age，这样可以在map阶段把name和age关联出来</p>
<ol>
<li><p>Spark 1.6 使用MapJoin</p>
<p><strong>CACHE</strong> TABLE xx AS select * from xx</p>
</li>
<li><p>Spark 2.2 使用MapJoin Hint</p>
<p>SELECT **&#x2F;<em>+ MAPJOIN(b) <em>&#x2F;</em></em> …</p>
</li>
<li><p>调整Spark SQL相关参数</p>
<ul>
<li><p>spark.sql.autoBroadcastJoinThreshold</p>
<p>被广播表的大小小于该值时启动BroadcastJoin，默认10MB。 </p>
<p>如果需要广播，服务器内存比较大可以调整该参数</p>
</li>
<li><p>spark.sql.broadcastTimeout</p>
<p>广播等待超时时间(秒)，默认300s。 </p>
</li>
<li><p>spark.sql.shuffle.partitions</p>
<p>join或者aggregation是使用多少分区，默认200。</p>
<p>数据量比较大可以调高该参数</p>
</li>
</ul>
<p>解决数据倾斜相关链接</p>
<ul>
<li>Spark性能优化指南——高级篇 - 美团技术团队 <a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/05/12/spark-tuning-pro.html">https://tech.meituan.com/2016/05/12/spark-tuning-pro.html</a></li>
<li>Spark性能优化指南——基础篇 - 美团技术团队 <a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/04/29/spark-tuning-basic.html">https://tech.meituan.com/2016/04/29/spark-tuning-basic.html</a></li>
</ul>
</li>
</ol>
<h1 id="Spark-MLlib-实战"><a href="#Spark-MLlib-实战" class="headerlink" title="Spark MLlib 实战"></a>Spark MLlib 实战</h1><p>MLlib是Spark机器学习库，包含了许多通用的机器学习算法和工具。</p>
<h2 id="什么是机器学习？"><a href="#什么是机器学习？" class="headerlink" title="什么是机器学习？"></a>什么是机器学习？</h2><p>让机器从数据中学习，进而得到一个更加符合现实规律的模型，通过对模型的使用使得机器比以往表现的更好，这就是机器学习。</p>
<h2 id="MLlib-究竟能干啥？"><a href="#MLlib-究竟能干啥？" class="headerlink" title="MLlib 究竟能干啥？"></a>MLlib 究竟能干啥？</h2><p>算法</p>
<ul>
<li>回归 Regression<br>预测未来的增长</li>
<li>分类 Classification</li>
<li>聚类 Clustering<br>对某一类人群进行投放广告，提高转化率</li>
<li>决策树 Decision trees</li>
<li>协同过滤 Collaborative filtering<br>推荐领域，A和B是相似的人，A喜欢看小说，B也有很大可能喜欢看小说</li>
</ul>
<p>特征工程</p>
<ul>
<li><p>特征抽取 Feature extraction</p>
</li>
<li><p>降维 Dimensionality reduction</p>
</li>
</ul>
<p>持久化</p>
<p>常用工具</p>
<ul>
<li><p>线性代数工具集</p>
</li>
<li><p>统计工具集</p>
</li>
</ul>
<p><strong>简单的决策树</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306204539.png"></p>
<h2 id="逻辑回归预测乳腺癌"><a href="#逻辑回归预测乳腺癌" class="headerlink" title="逻辑回归预测乳腺癌"></a>逻辑回归预测乳腺癌</h2><table>
<thead>
<tr>
<th>特征X</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>Clump Thickness</td>
<td>肿块厚度</td>
</tr>
<tr>
<td>Uniformity of Cell Size</td>
<td>细胞大小均匀性</td>
</tr>
<tr>
<td>Uniformity of Cell Shape</td>
<td>细胞形状均匀性</td>
</tr>
<tr>
<td>Marginal Adhesion</td>
<td>边缘附着力</td>
</tr>
<tr>
<td>Single Epithelial Cell Size</td>
<td>单上皮细胞大小</td>
</tr>
<tr>
<td>Bare Nuclei</td>
<td>裸核</td>
</tr>
<tr>
<td>Bland Chromatin</td>
<td>染色质</td>
</tr>
<tr>
<td>Normal Nucleoli</td>
<td>正常核仁</td>
</tr>
<tr>
<td>Mitoses</td>
<td>有丝分裂</td>
</tr>
</tbody></table>
<p>预测Y：良性 or 恶性</p>
<h2 id="逻辑回归模型"><a href="#逻辑回归模型" class="headerlink" title="逻辑回归模型"></a>逻辑回归模型</h2><p>假设有个函数y &#x3D; h𝜃(𝑥)可以帮助我们预测癌症，且0 ≤ h𝜃(𝑥) ≤ 1</p>
<p>良性y &#x3D; 0</p>
<p>恶性y &#x3D; 1</p>
<h2 id="Sigmoid函数"><a href="#Sigmoid函数" class="headerlink" title="Sigmoid函数"></a>Sigmoid函数</h2><p>x的取值范围是负无穷大到正无穷大，y为该函数算出的值，以0作为分界点，把0代入x，e的负0次方为1，2分之1为0.5，我们可以把sigmoid函数用来去做一个概率的映射，小于0.5认为是良性，大于等于0.5是恶性</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306204833.png"><br>$$<br>𝑔(x) &#x3D; \dfrac{1} {1+𝑒^{-𝑥’}}，g(x)为sigmoid函数<br>$$</p>
<h2 id="LR分类Example"><a href="#LR分类Example" class="headerlink" title="LR分类Example"></a>LR分类Example</h2><p>逻辑回归，先在图上画出数据，假设我们只有2个维度x1、x2。横轴为x1，纵轴为x2。类别按不同的颜色来表示，蓝色和橘色。</p>
<p>去训练出一个平面，用一根线把俩类数据分开，这个叫线性可分。在线下和线上可以分为两类数据。当我们来了一个新的值x1、x2，我们只需要把他带入到这个方程里面，来看数据是在线的下面还是上面</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205421.png"></p>
<h2 id="Spark-MLlib-训练模型流程"><a href="#Spark-MLlib-训练模型流程" class="headerlink" title="Spark MLlib 训练模型流程"></a>Spark MLlib 训练模型流程</h2><p>模型训练流程</p>
<ul>
<li>加载数据</li>
<li>数据抽取</li>
<li>训练出模型</li>
<li>模型评估</li>
</ul>
<p>模型测试流程</p>
<ul>
<li><p>加载数据，使用模型从未接触过的数据测试</p>
</li>
<li><p>数据抽取</p>
</li>
<li><p>预测结果</p>
</li>
<li><p>模型评估</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205450.png"></p>
<h2 id="乳腺癌数据源"><a href="#乳腺癌数据源" class="headerlink" title="乳腺癌数据源"></a>乳腺癌数据源</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205524.png"></p>
<h3 id="Step-1-清洗数据"><a href="#Step-1-清洗数据" class="headerlink" title="Step 1 清洗数据"></a>Step 1 清洗数据</h3><p>String &#x3D;&gt;Object</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseRDD</span></span>(rdd: <span class="type">RDD</span>[<span class="type">String</span>]): <span class="type">RDD</span>[<span class="type">Array</span>[<span class="type">Double</span>]] = &#123;</span><br><span class="line">rdd.map(_.split(<span class="string">&quot;,&quot;</span>)).filter(_(<span class="number">6</span>) != </span><br><span class="line"><span class="string">&quot;?&quot;</span>).map(_.drop(<span class="number">1</span>)).map(_.map(_.toDouble))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205628.png"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseObs</span></span>(line: <span class="type">Array</span>[<span class="type">Double</span>]): <span class="type">Obs</span> = &#123;</span><br><span class="line"><span class="type">Obs</span>(</span><br><span class="line"><span class="keyword">if</span> (line(<span class="number">9</span>) == <span class="number">4.0</span>) <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>, line(<span class="number">0</span>), line(<span class="number">1</span>), line(<span class="number">2</span>), line(<span class="number">3</span>), </span><br><span class="line">line(<span class="number">4</span>), line(<span class="number">5</span>), line(<span class="number">6</span>), line(<span class="number">7</span>), line(<span class="number">8</span>)</span><br><span class="line">) &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-分割训练集和测试集"><a href="#Step-2-分割训练集和测试集" class="headerlink" title="Step 2 分割训练集和测试集"></a>Step 2 分割训练集和测试集</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205524.png"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> splitSeed = <span class="number">5043</span></span><br><span class="line"><span class="keyword">val</span> <span class="type">Array</span>(trainingData, testData) = </span><br><span class="line">df3.randomSplit(<span class="type">Array</span>(<span class="number">0.7</span>, <span class="number">0.3</span>), </span><br><span class="line">splitSeed)</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-训练模型"><a href="#Step-3-训练模型" class="headerlink" title="Step 3 训练模型"></a>Step 3 训练模型</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205728.png"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> lr = <span class="keyword">new</span> <span class="type">LogisticRegression</span>()</span><br><span class="line"><span class="comment">// 设置最大迭代次数，防止过拟合</span></span><br><span class="line">.setMaxIter(<span class="number">10</span>)</span><br><span class="line"><span class="comment">// 正则化参数，尝试把一个模型把简单方向训练，防止过拟合</span></span><br><span class="line"><span class="comment">// 过拟合是对测试集拟合的过好，往往数据会有一些波动和异常值，当模型对于数据拟合过好之后，在实际应用中会发现结果会很差，和实际不相符。模型通常来讲越简单，提供的效果越好</span></span><br><span class="line"><span class="comment">// 所以这边会设置一些参数，尝试让x0...xn参数趋近于0，当特征越少，留下的特征都是一些重要的特征</span></span><br><span class="line">.setRegParam(<span class="number">0.3</span>)</span><br><span class="line">.setElasticNetParam(<span class="number">0.8</span>)</span><br><span class="line"><span class="keyword">val</span> model = lr.fit(trainingData)</span><br></pre></td></tr></table></figure>

<h3 id="Step-4-评估模型"><a href="#Step-4-评估模型" class="headerlink" title="Step 4 评估模型"></a>Step 4 评估模型</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220306205809.png"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> predictions = model.transform(testData)</span><br><span class="line">predictions.select(<span class="string">&quot;clas&quot;</span>, <span class="string">&quot;label&quot;</span>, <span class="string">&quot;prediction&quot;</span>)</span><br><span class="line">.show(<span class="number">50</span>)</span><br><span class="line"><span class="keyword">val</span> evaluator = <span class="keyword">new</span> <span class="type">BinaryClassificationEvaluator</span>()</span><br><span class="line">.setLabelCol(<span class="string">&quot;label&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> accuracy = evaluator.evaluate(predictions)</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/03-Spark/03-SparkShuffle&SQL&MLlib/" data-id="clmcxec7o0015u8waf1yqhp7j" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/09/10/13-%E5%A4%A7%E6%95%B0%E6%8D%AE/03-Spark/04-StructuredStreaming/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2023/09/09/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>