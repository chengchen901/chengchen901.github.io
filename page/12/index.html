<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/12/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-03-SpringBoot/03-SpringBoot-AutoConfiguration" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/03-SpringBoot/03-SpringBoot-AutoConfiguration/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/03-SpringBoot/03-SpringBoot-AutoConfiguration/">SpringBoot-AutoConfiguration</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="参数配置规则详解"><a href="#参数配置规则详解" class="headerlink" title="参数配置规则详解"></a>参数配置规则详解</h1><h2 id="SpringBoot参数配置规则详解"><a href="#SpringBoot参数配置规则详解" class="headerlink" title="SpringBoot参数配置规则详解"></a>SpringBoot参数配置规则详解</h2><ul>
<li><p><strong>1 Spring Boot应用中可以在哪里配置参数?</strong> </p>
<ul>
<li>classpath:&#x2F;下的application.properties &#x2F; application.yml中</li>
</ul>
</li>
<li><p><strong>参数配置文件的名称有什么要求没?</strong></p>
<ul>
<li>application.properties &#x2F; application.yml</li>
</ul>
</li>
<li><p><strong>参数配置文件的位置有什么要求没?</strong></p>
<ul>
<li>classpath:&#x2F;</li>
</ul>
</li>
<li><p><strong>参数配置文件的约定名称为:</strong></p>
<ul>
<li>application.properties &#x2F; application.yml</li>
</ul>
</li>
<li><p><strong>参数配置文件的约定放置位置（优先级从高到低)为:</strong> </p>
<ul>
<li><strong>1 运行程序的当前工作目录下的config子目录file:.&#x2F;config</strong></li>
<li><strong>2 运行程序的当前工作目录file:.&#x2F;</strong></li>
<li><strong>3 classpath:&#x2F;config子目录</strong></li>
<li><strong>4 classpath:&#x2F;根目录</strong></li>
</ul>
<p><strong>看ConfigFileApplicationListener类</strong></p>
</li>
</ul>
<p><strong>ConfigFileApplicationListener:</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916192522.png"></p>
<p><strong>通过指定spring.config.name和spring.config.location属性的值来改变约定的默认名称、位置!</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916192624.png"></p>
<ul>
<li><strong>指定spring.config.name、spring.config.location属性值的三种方式（优先级 程序命令行参数 &gt; JVM参数 &gt; 操作系统环境变量）:</strong><ul>
<li>程序命令行参数:–spring.config.name&#x3D;xXXX</li>
<li>JVM参数:-Dspring.config.name&#x3D;xXXX</li>
<li>操作系统环境变量: spring.config.name&#x3D;xxXX</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar myproject.jar --spring.config.name=girl</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -jar myproject.jar --spring.config.location=classpath:/default.properties,classpath:/override.properties</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>spring.config.location属性特别说明</strong></p>
<ul>
<li>spring.config.location指定配置文件所在目录(以&#x2F;结尾）或文件名,可多值(逗号间隔) </li>
<li>查找的顺序是配置的反序</li>
</ul>
</li>
<li><p><strong>spring.config.name属性特别说明:</strong> </p>
<ul>
<li>spring.config.name可多值(逗号间隔) </li>
<li>属性查找的顺序是配置的反序</li>
</ul>
</li>
<li><p><strong>spring.config.additional-location属性说明:</strong> </p>
<ul>
<li>除了默认规则外用来指定额外补充的配置文件目录或配置文件</li>
<li>优先级高于spring.config.location</li>
</ul>
</li>
<li><p><strong>除了可在参数配置文件中配置外,还有其他方式配置参数吗?</strong></p>
<ul>
<li>程序命令行参数</li>
<li>Jvm参数</li>
<li>系统环境变量</li>
<li>参数配置文件</li>
<li>SpringApplication.setDefaultProperties()</li>
<li>@PropertySource</li>
</ul>
</li>
</ul>
<h2 id="SpringBoot参数配置语法"><a href="#SpringBoot参数配置语法" class="headerlink" title="SpringBoot参数配置语法"></a>SpringBoot参数配置语法</h2><ul>
<li><p><strong>配置文件格式:</strong> </p>
<ul>
<li>application.properties</li>
<li>application.yml</li>
</ul>
</li>
<li><p><strong>参数引用:</strong></p>
<ul>
<li>my.info&#x3D;${my.name} age is ${my.age}</li>
</ul>
</li>
<li><p><strong>参数随机值:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attr">my.secret</span>=<span class="string">$&#123;random.value&#125;</span></span><br><span class="line">  <span class="attr">my.number</span>=<span class="string">$&#123;random.int&#125;</span></span><br><span class="line">  <span class="attr">my.bignumber</span>=<span class="string">$&#123;random.long&#125;</span></span><br><span class="line">  <span class="attr">my.uuid</span>=<span class="string">$&#123;random. uuid&#125;</span></span><br><span class="line">  <span class="attr">my.number.less.than.ten</span>=<span class="string">$&#123;random.int(10)&#125;</span></span><br><span class="line">  <span class="attr">my.number.in.range</span>=<span class="string">$&#123;random.int[1024,65536]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">-</span> <span class="string">**参数值加密 password=eadesdrefdaf8efacnanaeijr91qw:**</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">1.</span> <span class="string">实现一个EnvironmentPostProcessor,在里面完成密文值的解密</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     ![](https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916193718.png)</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">2.</span> <span class="string">将这个实现加到META-INF/spring.factories 中，让其生效</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">````properties</span></span><br><span class="line">     <span class="attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=<span class="string">com.example.YourEnvironmentPostProcessor</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">-</span> <span class="string">YAML语法</span></span><br><span class="line">  <span class="attr">-</span> <span class="string">很简单，参考学习: https://blog.csdn.net/vincent_hbl/article/details/75411243</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 参数使用详解</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">## 参数使用详解</span></span><br><span class="line"></span><br><span class="line"><span class="attr">-</span> <span class="string">**方式一: @Value(&quot;$&#123;my.name&#125;&quot;)**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">-</span> <span class="string">**方式二:注入Environment bean**</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">````java</span></span><br><span class="line">  <span class="attr">@Component</span></span><br><span class="line">  <span class="attr">public</span> <span class="string">class UserEnvironmentDemo &#123;</span></span><br><span class="line">      <span class="attr">@Autowired</span></span><br><span class="line">      <span class="attr">private</span> <span class="string">Environment env;</span></span><br><span class="line">      </span><br><span class="line">      <span class="attr">public</span> <span class="string">void service() &#123;</span></span><br><span class="line">          <span class="attr">System.out.println(env.getProperty(&quot;my.name&quot;));</span></span><br><span class="line">      <span class="attr">&#125;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>方式三:@ConfigurationProperties(prefix &#x3D; “my”)</strong></p>
<ul>
<li><p>加在一个bean类上，给bean的属性进行赋值，属性需有getters and setters</p>
</li>
<li><p>有两种具体用法</p>
<ul>
<li><p><strong>1 自动配置中的参数装载Bean</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;user.share&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShareProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get set...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ShareProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShareAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShareProperties sp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>2 Bean属性值注入</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;user.share&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShareProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get set...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">      <span class="meta">@ConfigurationProperties(prefix = &quot;user.share&quot;)</span></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="keyword">public</span> ShareProperties <span class="title function_">shareProperties</span><span class="params">()</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShareProperties</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## <span class="meta">@ConfigurationProperties</span>属性名灵活绑定</span><br><span class="line"></span><br><span class="line">- **类中属性名一般会采用驼峰方式，配置参数名也要驼峰吗?**</span><br><span class="line"></span><br><span class="line">  不需要</span><br><span class="line"></span><br><span class="line">  ````java</span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;user.share&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShareProperties</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> String firstName;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// get set...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>类中属性名一般会采用驼峰方式，配置参数名可以用如下方式:</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916194933.png"></p>
<p>注意:prefix的值只可使用-、小写，如</p>
<p>@ConfigurationProperties(prefix &#x3D; “acme.my-project.person”)</p>
</li>
<li><p><strong>各类配置源对灵活绑定的支持情况:</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916195052.png"></p>
<p>建议:属性名采用小写–连接格式，如my.property-name&#x3D;acme</p>
</li>
<li><p><strong>如果名字本身包含-_等特殊字符怎么办?用[]包裹:</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">acme:</span></span><br><span class="line">	<span class="attr">map:</span></span><br><span class="line">		<span class="string">&quot;[/key1]&quot;</span><span class="string">:</span> <span class="string">value1</span></span><br><span class="line">		<span class="string">&quot;[/key2]&quot;</span><span class="string">:</span> <span class="string">value2</span></span><br><span class="line">		<span class="string">/key3:</span> <span class="string">value3</span></span><br></pre></td></tr></table></figure>

<p>最终的参数名为：&#x2F;key1，&#x2F;key2，key3</p>
</li>
</ul>
<h2 id="ConfigurationProperties更多用法"><a href="#ConfigurationProperties更多用法" class="headerlink" title="@ConfigurationProperties更多用法"></a>@ConfigurationProperties更多用法</h2><ul>
<li><p><strong>参数值直接转换</strong></p>
</li>
<li><p><strong>bean属性参数值绑定合法性校验@Validated</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32352777/article/details/108424932">https://blog.csdn.net/qq_32352777/article/details/108424932</a></p>
<p>详细用法通过官网了解</p>
</li>
</ul>
<h2 id="ConfigurationProperties-VS-Value"><a href="#ConfigurationProperties-VS-Value" class="headerlink" title="@ConfigurationProperties VS @Value"></a>@ConfigurationProperties VS @Value</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916195434.png"></p>
<h1 id="Profiles详解"><a href="#Profiles详解" class="headerlink" title="Profiles详解"></a>Profiles详解</h1><h2 id="Profiles详解-1"><a href="#Profiles详解-1" class="headerlink" title="Profiles详解"></a>Profiles详解</h2><ul>
<li><p><strong>profile是什么?</strong> </p>
<ul>
<li>Spring配置文件提供的一种隔离应用程序配置的方法，使其仅在特定环境中可用。 </li>
<li>可通过profile指定Bean的应用环境(如开发、测试、生产等环境) </li>
<li>可通过profile指定不同环境的配置参数值</li>
</ul>
</li>
<li><p><strong>通过profile指定Bean的应用环境</strong></p>
<ul>
<li><p>任何@Component或@Configuration都可以用@Profile来标记，以便在加载时进行限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Profile(&quot;production&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductionConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Profile(&quot;dev&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">&quot;dev&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;combatService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.study.spring.service.CombatService&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;6e&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-</span> <span class="attr">arg</span> <span class="attr">index</span>=<span class="string">&quot;5&quot;</span> <span class="attr">value</span>=<span class="string">&quot;999&quot;</span>/&gt;</span></span><br><span class="line">	&lt;/ bean&gt;</span><br><span class="line">&lt;/ beans&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>通过profile指定不同环境的配置参数值</strong> </p>
<ul>
<li><p>方式一∶通过不同的环境配置文件来区分</p>
<ul>
<li>application-{profile}.properties或application-{profile}.yml，没有带-{profile}表示共用到所有环境</li>
</ul>
</li>
<li><p>方式二:在同一个yml配置文件中区分，—是内容分隔符，第一部分为通用配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">address:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">profiles:</span> <span class="string">pro</span> <span class="string">&amp;</span> <span class="string">central</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">address:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.120</span></span><br></pre></td></tr></table></figure>

<p>还可通过spring.profiles.include来指定某个环境包含的其它profile定义</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my.property</span>: <span class="string">fromyamlfile</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">spring.profiles</span>: <span class="string">prod</span></span><br><span class="line"><span class="attr">spring.profiles.include</span>:<span class="string"></span></span><br><span class="line">	<span class="attr">-</span> <span class="string">proddb</span></span><br><span class="line">	<span class="attr">-</span> <span class="string">prodmq</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>指定程序启用的profiles</strong></p>
<ul>
<li><p>通过配置参数spring.profiles.active来指定应用启用的profiles</p>
<ul>
<li><p>环境变量、jvm参数、命令行程序参数、application.properties中都可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active=dev,hsqldb</span><br><span class="line">--spring.profiles.active=dev,hsqldb</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>编程式指定启用的环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringApplication.setAdditionalProfiles(...)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>注意事项</strong></p>
<ul>
<li><p>1没有通过spring.profiles.active指定启用的profiles时，将使用-default的（如果有) </p>
</li>
<li><p>2通过spring.config.location指定的配置文件不会应用profile，目录会。</p>
<pre><code>application-default.properties
</code></pre>
</li>
</ul>
</li>
</ul>
<h1 id="AutoConfiguration"><a href="#AutoConfiguration" class="headerlink" title="AutoConfiguration"></a>AutoConfiguration</h1><h2 id="AutoConfiguration-1"><a href="#AutoConfiguration-1" class="headerlink" title="AutoConfiguration"></a>AutoConfiguration</h2><p><strong>AutoConfiguration继承体系</strong></p>
<ol>
<li>继承spring boot-starter-parent</li>
<li>继承spring boot-dependencies</li>
<li>引入spring-boot-autoconfigure</li>
</ol>
<p><strong>AutoConfiguration的加载触发</strong></p>
<ol>
<li>注解EnableAutoConfiguration</li>
<li>AutoConfigurationImportSelector</li>
<li>通对selectImports加载自动配置信息</li>
<li>通getCandidateConfigurations加载META-INF&#x2F;spring.factories</li>
</ol>
<h2 id="AutoConfiguration-官方集成框架"><a href="#AutoConfiguration-官方集成框架" class="headerlink" title="AutoConfiguration 官方集成框架"></a>AutoConfiguration 官方集成框架</h2><p>Spring官方集成自动配置</p>
<ul>
<li>RabbitAutoConfiguration</li>
<li>JpaRepositoriesAutoConfiguration</li>
<li>ElasticsearchDataAutoConfiguration</li>
<li>RedisAutoConfiguration</li>
<li>EmbeddedMongoAutoConfiguration</li>
<li>HibernateJpaAutoConfiguration</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210916201435.png"></p>
<p>更多参考官方地址：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-auto-configuration-classes.html#auto-configuration-classes-from-autoconfigure-module">https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-auto-configuration-classes.html#auto-configuration-classes-from-autoconfigure-module</a></p>
<p>越来越多的第三方框架也进行了集成：Mybatis、Shiro、Dubbo、PageHelper等</p>
<h2 id="AutoConfiguration-相关注解"><a href="#AutoConfiguration-相关注解" class="headerlink" title="AutoConfiguration 相关注解"></a>AutoConfiguration 相关注解</h2><p><strong>自动配置-―条件依赖注解</strong></p>
<p>@ConditionalOnClass @ConditionalOnMissingClass 指定的类存在或不存在</p>
<p>@ConditionalOnBean @ConditionalOnMissingBean 指定的bean存在或不存在</p>
<p>@ConditionalOnProperty 指定的属性值存在或不存在</p>
<p>@ConditionalOnResource 类路径是否有指定的值</p>
<p>@ConditionalOnWebApplication @ConditionalOnNotWebApplication 是否为Web应用</p>
<p>@ConditionalOnExpression 当抛出某个异常的情况下</p>
<p>@AutoConfigureAfter @AutoConfigureBefore @AutoConfigureOrder 指定顺序</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/03-SpringBoot/03-SpringBoot-AutoConfiguration/" data-id="clmcxecw40080u8wa43xn6jhk" data-title="SpringBoot-AutoConfiguration" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-03-SpringBoot/04-SpringBoot-CLI" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/03-SpringBoot/04-SpringBoot-CLI/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/03-SpringBoot/04-SpringBoot-CLI/">SpringBoot-CLI</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Boot CLI是一个命令行工具，如果想快速开发Spring应用程序，可以使用它。它可以运行Groovy脚本，这意味着您具有类似Java的熟悉语法，而没有太多样板代码。还可以引导一个新项目或为其编写自己的命令。</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>针对window环境</p>
<ul>
<li><p>下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://repo.spring.io/release/org/springframework/boot/spring-boot-cli/2.3.5.RELEASE/spring-boot-cli-2.3.5.RELEASE-bin.zip">https://repo.spring.io/release/org/springframework/boot/spring-boot-cli/2.3.5.RELEASE/spring-boot-cli-2.3.5.RELEASE-bin.zip</a></p>
<p>Spring Boot CLI需要Java JDK v1.8或更高版本才能运行。Groovy已经在发行版包中，无需安装。</p>
</li>
<li><p>解压zip包</p>
<p>本示例解压在D:\Program Files\CLI目录下</p>
</li>
<li><p>设置环境SPRING_HOME变量</p>
<p>D:\Program Files\CLI\spring-2.3.5.RELEASE\bin</p>
</li>
<li><p>安装检查</p>
<p>运行一个cmd窗口，输入下面命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">  spring --version</span><br><span class="line">  Spring CLI v2.3.5.RELEASE</span><br><span class="line"></span><br><span class="line">## 使用帮助</span><br><span class="line"></span><br><span class="line">**查看帮助命令**</span><br><span class="line"></span><br><span class="line">````shell</span><br><span class="line">C:\Users\chen cheng&gt;spring help</span><br><span class="line">usage: spring [--help] [--version]</span><br><span class="line">       &lt;command&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">Available commands are:</span><br><span class="line">  # 运行groovy脚本</span><br><span class="line">  run [options] &lt;files&gt; [--] [args]</span><br><span class="line">    Run a spring groovy script</span><br><span class="line"></span><br><span class="line">  grab</span><br><span class="line">    Download a spring groovy script&#x27;s dependencies to ./repository</span><br><span class="line">  # 通过spring groovy脚本，创建可执行的jar应用</span><br><span class="line">  jar [options] &lt;jar-name&gt; &lt;files&gt;</span><br><span class="line">    Create a self-contained executable jar file from a Spring Groovy script</span><br><span class="line">  # 通过spring groovy脚本，创建包含内嵌容器可执行的war应用</span><br><span class="line">  war [options] &lt;war-name&gt; &lt;files&gt;</span><br><span class="line">    Create a self-contained executable war file from a Spring Groovy script</span><br><span class="line"></span><br><span class="line">  install [options] &lt;coordinates&gt;</span><br><span class="line">    Install dependencies to the lib/ext directory</span><br><span class="line"></span><br><span class="line">  uninstall [options] &lt;coordinates&gt;</span><br><span class="line">    Uninstall dependencies from the lib/ext directory</span><br><span class="line">  # 通过init命令可以创建并初始化一个springboot项目</span><br><span class="line">  init [options] [location]</span><br><span class="line">    Initialize a new project using Spring Initializr (start.spring.io)</span><br><span class="line"></span><br><span class="line">  encodepassword [options] &lt;password to encode&gt;</span><br><span class="line">    Encode a password for use with Spring Security</span><br><span class="line"></span><br><span class="line">  shell</span><br><span class="line">    Start a nested shell</span><br><span class="line"></span><br><span class="line">Common options:</span><br><span class="line"></span><br><span class="line">  --debug Verbose mode</span><br><span class="line">    Print additional status information for the command you are running</span><br><span class="line"></span><br><span class="line"># 使用spring help &lt;command&gt;针对指定的命令获得帮助信息</span><br><span class="line">See &#x27;spring help &lt;command&gt;&#x27; for more information on a specific command.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\chen cheng&gt;spring help init</span><br><span class="line">spring init - Initialize a new project using Spring Initializr (start.spring.io)</span><br><span class="line"></span><br><span class="line">usage: spring init [options] [location]</span><br><span class="line"></span><br><span class="line">Option                       Description</span><br><span class="line">------                       -----------</span><br><span class="line">-a, --artifactId &lt;String&gt;    Project coordinates; infer archive name (for</span><br><span class="line">                               example &#x27;test&#x27;)</span><br><span class="line">-b, --boot-version &lt;String&gt;  Spring Boot version (for example &#x27;1.2.0.RELEASE&#x27;)</span><br><span class="line">--build &lt;String&gt;             Build system to use (for example &#x27;maven&#x27; or</span><br><span class="line">                               &#x27;gradle&#x27;) (default: maven)</span><br><span class="line">-d, --dependencies &lt;String&gt;  Comma-separated list of dependency identifiers to</span><br><span class="line">                               include in the generated project</span><br><span class="line">--description &lt;String&gt;       Project description</span><br><span class="line">-f, --force                  Force overwrite of existing files</span><br><span class="line">--format &lt;String&gt;            Format of the generated content (for example</span><br><span class="line">                               &#x27;build&#x27; for a build file, &#x27;project&#x27; for a</span><br><span class="line">                               project archive) (default: project)</span><br><span class="line">-g, --groupId &lt;String&gt;       Project coordinates (for example &#x27;org.test&#x27;)</span><br><span class="line">-j, --java-version &lt;String&gt;  Language level (for example &#x27;1.8&#x27;)</span><br><span class="line">-l, --language &lt;String&gt;      Programming language  (for example &#x27;java&#x27;)</span><br><span class="line">--list                       List the capabilities of the service. Use it to</span><br><span class="line">                               discover the dependencies and the types that are</span><br><span class="line">                               available</span><br><span class="line">-n, --name &lt;String&gt;          Project name; infer application name</span><br><span class="line">-p, --packaging &lt;String&gt;     Project packaging (for example &#x27;jar&#x27;)</span><br><span class="line">--package-name &lt;String&gt;      Package name</span><br><span class="line">-t, --type &lt;String&gt;          Project type. Not normally needed if you use --</span><br><span class="line">                               build and/or --format. Check the capabilities of</span><br><span class="line">                               the service (--list) for more details</span><br><span class="line">--target &lt;String&gt;            URL of the service to use (default: https://start.</span><br><span class="line">                               spring.io)</span><br><span class="line">-v, --version &lt;String&gt;       Project version (for example &#x27;0.0.1-SNAPSHOT&#x27;)</span><br><span class="line">-x, --extract                Extract the project archive. Inferred if a</span><br><span class="line">                               location is specified without an extension</span><br><span class="line"></span><br><span class="line">examples:</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">展示springboot 生态圈组件</span></span><br><span class="line">    To list all the capabilities of the service:</span><br><span class="line">        $ spring init --list</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">创建一个默认的工程</span></span><br><span class="line">    To creates a default project:</span><br><span class="line">        $ spring init</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">创建一个web工程zip包</span></span><br><span class="line">    To create a web my-app.zip:</span><br><span class="line">        $ spring init -d=web my-app.zip</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">创建一个带有jpa的gradle管理的web应用,放在my-dir目录下</span></span><br><span class="line">    To create a web/data-jpa gradle project unpacked:</span><br><span class="line">        $ spring init -d=web,jpa --build=gradle my-dir</span><br></pre></td></tr></table></figure>

<p>示例创建SSM项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring init -d=web,mybatis,mysql,actuator -a=ssm-demo -g=com.study.springboot --build=maven ssm-demo</span><br></pre></td></tr></table></figure>



<h2 id="运行groovy脚本"><a href="#运行groovy脚本" class="headerlink" title="运行groovy脚本"></a>运行groovy脚本</h2><p>groovy官网：<a target="_blank" rel="noopener" href="http://www.groovy-lang.org/">http://www.groovy-lang.org/</a></p>
<p>快速入门：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e8dec95c4326">https://www.jianshu.com/p/e8dec95c4326</a></p>
<p>Groovy 是 Apache 旗下的一门基于 JVM 平台的动态&#x2F;敏捷编程语言，在语言的设计上它吸纳了Python、Ruby 和 Smalltalk 语言的优秀特性，语法非常简练和优美，开发效率也非常高（编程语言的开发效率和性能是相互矛盾的，越高级的编程语言性能越差，因为意味着更多底层的封装，不过开发效率会更高，需结合使用场景做取舍）。并且，Groovy 可以与 Java 语言无缝对接，在写 Groovy 的时候如果忘记了语法可以直接按Java的语法继续写，也可以在 Java 中调用 Groovy 脚本，都可以很好的工作，这有效的降低了 Java 开发者学习 Groovy 的成本。Groovy 也并不会替代 Java，而是相辅相成、互补的关系，具体使用哪门语言这取决于要解决的问题和使用的场景。</p>
<p>Groovy和Spring与Spring Boot CLI结合在一起，可以在单个Groovy文件部署中快速编写功能强大，高性能的微服务。</p>
<p>准备groovy脚本</p>
<ol>
<li>创建app.groovy文件，写入下面内容</li>
</ol>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Example</span> &#123; </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> MyService myService; </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span> </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">helloWorld</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span>+myService.sayWorld(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayWorld</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Server World!&quot;</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>运行app.groovy</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring run app.groovy</span><br></pre></td></tr></table></figure>

<p>第一运行需要下载依赖项非常慢，第二次运行就很快了。</p>
</li>
<li><p>访问验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/ </span><br><span class="line">Hello Server World!</span><br></pre></td></tr></table></figure>
</li>
<li><p>工程目录组织</p>
<p>Spring Boot会自动在&#x2F;config目录中搜索application.yml或application.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── app </span><br><span class="line">	├── app.groovy </span><br><span class="line">	├── config </span><br><span class="line">		├── application.yml </span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>根据之前学习的内容还可以在工作目录放置配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── app </span><br><span class="line">	├── app.groovy </span><br><span class="line">    ├── application.yml </span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>还可以在groovy脚本中通过@Grab注解在类中，来引用依赖和导入包。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package org.test</span><br><span class="line"></span><br><span class="line">@Grab(&quot;spring-boot-starter-actuator&quot;)</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">class ExampleRestController&#123;</span><br><span class="line">	// ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引用actuator依赖和import相关类</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/03-SpringBoot/04-SpringBoot-CLI/" data-id="clmcxecw60083u8wa2soucmqa" data-title="SpringBoot-CLI" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-03-SpringBoot/05-SpringBoot-源码解读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/03-SpringBoot/05-SpringBoot-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/03-SpringBoot/05-SpringBoot-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">SpringBoot-源码解读</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring-boot-核心源码解读"><a href="#Spring-boot-核心源码解读" class="headerlink" title="Spring boot 核心源码解读"></a>Spring boot 核心源码解读</h1><h2 id="Application启动类"><a href="#Application启动类" class="headerlink" title="Application启动类"></a>Application启动类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxxxxxxxxx <span class="meta">@SpringBootApplication</span> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootStudyConfigApplication</span> &#123;     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;         SpringApplication.run(SpringBootStudyConfigApplication.class, args);     &#125;  [<span class="number">05</span>-SpringBoot-源码解读.md](<span class="number">05</span>-SpringBoot-源码解读.md) &#125;</span><br></pre></td></tr></table></figure>

<h3 id="认识-SpringBootApplication注解"><a href="#认识-SpringBootApplication注解" class="headerlink" title="认识@SpringBootApplication注解"></a>认识@SpringBootApplication注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Indicates a &#123;<span class="doctag">@link</span> Configuration configuration&#125; class that declares one or more</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Bean <span class="doctag">@Bean</span>&#125; methods and also triggers &#123;<span class="doctag">@link</span> EnableAutoConfiguration</span></span><br><span class="line"><span class="comment"> * auto-configuration&#125; and &#123;<span class="doctag">@link</span> ComponentScan component scanning&#125;. This is a convenience</span></span><br><span class="line"><span class="comment"> * annotation that is equivalent to declaring &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125;,</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> <span class="doctag">@EnableAutoConfiguration</span>&#125; and &#123;<span class="doctag">@code</span> <span class="doctag">@ComponentScan</span>&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.2.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; //没有指定包名，默认是加这个注解的类所在包</span></span><br><span class="line"><span class="meta">    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@SpringBootApplication是 @Configuration @EnableAutoConfiguration @ComponentScan 三个注解的复合</p>
<h3 id="入口方法SpringApplication-run"><a href="#入口方法SpringApplication-run" class="headerlink" title="入口方法SpringApplication.run"></a>入口方法SpringApplication.run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(primarySources).run(args); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意它的返回值：ConfigurableApplicationContext</p>
<h2 id="SpringApplication-构造方法解读"><a href="#SpringApplication-构造方法解读" class="headerlink" title="SpringApplication 构造方法解读"></a>SpringApplication 构造方法解读</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">一：注释上的重要信息：</span></span><br><span class="line"><span class="comment">1、primary sources：application context从primarySource加载beans</span></span><br><span class="line"><span class="comment">2、创建的SpringApplication实例在调用它的run(String...)方法前，可对其进行定制化设置</span></span><br><span class="line"><span class="comment">可以进行哪些设置？看类中提供的public方法。</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@link</span> SpringApplication&#125; instance. The application context will load</span></span><br><span class="line"><span class="comment"> * beans from the specified primary sources (see &#123;<span class="doctag">@link</span> SpringApplication class-level&#125;</span></span><br><span class="line"><span class="comment"> * documentation for details. The instance can be customized before calling</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #run(String...)&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resourceLoader the resource loader to use</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> primarySources the primary bean sources</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #run(Class, String[])</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setSources(Set)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> &#123;</span><br><span class="line">    <span class="comment">//二、构造方法中的逻辑：</span></span><br><span class="line">	<span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    <span class="comment">// 1、一定要指定primarySources</span></span><br><span class="line">	Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">	<span class="built_in">this</span>.primarySources = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">// 2、deduce(推断)web类型(servlet、reactive、NoWeb)</span></span><br><span class="line">	<span class="built_in">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="comment">// 3、从META-INF/spring.factories中获取ApplicationContextInitializer</span></span><br><span class="line">	setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">    <span class="comment">// 4、从META-INF/spring.factories中获取ApplicationListener</span></span><br><span class="line">	setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// 5、推断执行的main方法的定义类</span></span><br><span class="line">	<span class="built_in">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>疑问：</p>
<ol>
<li>ApplicationContextInitializer是做什么用的？请了解它的接口注释、方法注释、实现类有哪些。</li>
<li>ApplicationListener是做什么用的？</li>
</ol>
<h2 id="SpringApplication-run-实例方法解读"><a href="#SpringApplication-run-实例方法解读" class="headerlink" title="SpringApplication.run()实例方法解读"></a>SpringApplication.run()实例方法解读</h2><p>相当于ApplicationContext.refresh一样重要</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 一：注释上的重要信息：</span></span><br><span class="line"><span class="comment">运行Spring application，创建并刷新一个 ApplicationContext</span></span><br><span class="line"><span class="comment"> * Run the Spring application, creating and refreshing a new</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ApplicationContext&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args the application arguments (usually passed from a Java main method)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a running &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="comment">// 二、方法中的逻辑：</span></span><br><span class="line">    <span class="comment">// 1 StopWatch开启计时</span></span><br><span class="line">	<span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">	stopWatch.start();</span><br><span class="line">	<span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 这是设置系统属性java.awt.headless，请百度了解 java.awt.headless的用途。</span></span><br><span class="line">	configureHeadlessProperty();</span><br><span class="line">    <span class="comment">// 2、获取到 META-INF/spring.factories中配置的SpringApplicationRunListener</span></span><br><span class="line">    <span class="comment">// 疑问：又出一个Listener，这个SpringApplicationRunListener是监听什么的？</span></span><br><span class="line">    <span class="comment">// 通过它的接口定义、注释了解它的用途</span></span><br><span class="line">	<span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    <span class="comment">// 这里就调用它的starting()</span></span><br><span class="line">	listeners.starting();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 命令行参数包装为了ApplicationArguments</span></span><br><span class="line">		<span class="type">ApplicationArguments</span> <span class="variable">applicationArguments</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultApplicationArguments</span>(args);</span><br><span class="line">        <span class="comment">// 3、准备好了Environment，此刻Environment中都有哪些配置参数了？</span></span><br><span class="line">		<span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">		configureIgnoreBeanInfo(environment);</span><br><span class="line">        <span class="comment">// 4、打印springboot LOGo图标</span></span><br><span class="line">		<span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        <span class="comment">// 5、创建ApplicationContext</span></span><br><span class="line">		context = createApplicationContext();</span><br><span class="line">        <span class="comment">// 6、获取到 META-INF/spring.factories中配置的SpringBootExceptionReporter</span></span><br><span class="line">		exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        <span class="comment">// 7、准备ApplicationContext</span></span><br><span class="line">		prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="comment">// 8、刷新ApplicationContext</span></span><br><span class="line">		refreshContext(context);</span><br><span class="line">		afterRefresh(context, applicationArguments);</span><br><span class="line">		stopWatch.stop();</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">StartupInfoLogger</span>(<span class="built_in">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 9、发布started事件</span></span><br><span class="line">		listeners.started(context);</span><br><span class="line">        <span class="comment">// 10、执行所有的Runners</span></span><br><span class="line">		callRunners(context, applicationArguments);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 11、发布running中事件</span></span><br><span class="line">		listeners.running(context);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		handleRunFailure(context, ex, exceptionReporters, <span class="literal">null</span>);</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(ex);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 12、返回ok的ConfigurableApplicationContext</span></span><br><span class="line">	<span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="环境准备过程解读"><a href="#环境准备过程解读" class="headerlink" title="环境准备过程解读"></a>环境准备过程解读</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">		ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">	<span class="comment">// Create and configure the environment</span></span><br><span class="line">    <span class="comment">// 根据应用类型，创建对应的Environment对象，会装载环境变量、系统参数、具体应用类型配置参数</span></span><br><span class="line">	<span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> getOrCreateEnvironment();</span><br><span class="line">    <span class="comment">// 配置环境：加入命令行参数PropertySource,配置启用的profiles</span></span><br><span class="line">	configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">	ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="comment">// 触发RunListener环境准备完成回调</span></span><br><span class="line">	listeners.environmentPrepared(environment);</span><br><span class="line">    <span class="comment">// 将environment绑定到SpringApplication（不需详看）</span></span><br><span class="line">	bindToSpringApplication(environment);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">		environment = <span class="keyword">new</span> <span class="title class_">EnvironmentConverter</span>(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">				deduceEnvironmentClass());</span><br><span class="line">	&#125;</span><br><span class="line">	ConfigurationPropertySources.attach(environment);</span><br><span class="line">	<span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>疑问：</p>
<ol>
<li>参数配置在哪里完成的加载？<br> 在学习参数配置时学习到了一个很重要的类 ConfigFileApplicationListener 。了解到在它里面完成的加载，它又是在何时被谁调用的呢？<br> ConfigFileApplicationListener 的类定义</li>
</ol>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigFileApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentPostProcessor</span>, SmartApplicationListener, Ordered &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>  它是一个EnvironmentPostProcessor，也是一个ApplicationListener，应该就是通过它们来完成的调用！</p>
<ul>
<li><p>实现的EnvironmentPostProcessor方法，在这里完成了加载配置文件的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> &#123;</span><br><span class="line">    addPropertySources(environment, application.getResourceLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现的ApplicationListener方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) &#123;</span><br><span class="line">        onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationPreparedEvent) &#123;</span><br><span class="line">        onApplicationPreparedEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li><p>ApplicationEnvironmentPreparedEvent这个事件会在哪里发布？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ConfigurableEnvironment <span class="title function_">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span><br><span class="line"><span class="params">                                                   ApplicationArguments applicationArguments)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 触发RunListener环境准备完成回调</span></span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>想要看它的加载执行过程怎么办？</p>
<p>在加载的代码处打个断点就可以看到完整的加载过程了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> &#123;</span><br><span class="line">    addPropertySources(environment, application.getResourceLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">postProcessEnvironment(ConfigurableEnvironment, SpringApplication):<span class="number">210</span>, ConfigFileApplicationListener (org.springframework.boot.context.config)</span><br><span class="line">onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent):<span class="number">200</span>, ConfigFileApplicationListener (org.springframework.boot.context.config)</span><br><span class="line">onApplicationEvent(ApplicationEvent):<span class="number">188</span>, ConfigFileApplicationListener (org.springframework.boot.context.config)</span><br><span class="line">doInvokeListener(ApplicationListener, ApplicationEvent):<span class="number">172</span>, SimpleApplicationEventMulticaster (org.springframework.context.event)</span><br><span class="line">invokeListener(ApplicationListener, ApplicationEvent):<span class="number">165</span>, SimpleApplicationEventMulticaster (org.springframework.context.event)</span><br><span class="line">multicastEvent(ApplicationEvent, ResolvableType):<span class="number">139</span>, SimpleApplicationEventMulticaster (org.springframework.context.event)</span><br><span class="line">multicastEvent(ApplicationEvent):<span class="number">127</span>, SimpleApplicationEventMulticaster (org.springframework.context.event)</span><br><span class="line">environmentPrepared(ConfigurableEnvironment):<span class="number">80</span>, EventPublishingRunListener (org.springframework.boot.context.event)</span><br><span class="line">environmentPrepared(ConfigurableEnvironment):<span class="number">53</span>, SpringApplicationRunListeners (org.springframework.boot)</span><br><span class="line">prepareEnvironment(SpringApplicationRunListeners, ApplicationArguments):<span class="number">345</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(String[]):<span class="number">308</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(Class[], String[]):<span class="number">1237</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(Class, String[]):<span class="number">1226</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">main(String[]):<span class="number">9</span>, App (com.study)</span><br></pre></td></tr></table></figure>

<p>里面的代码很多，也较复杂，感兴趣的同学可以继续去阅读！</p>
</li>
</ul>
</li>
</ol>
<h2 id="ConfigurableApplicationContext-创建与准备过程解读"><a href="#ConfigurableApplicationContext-创建与准备过程解读" class="headerlink" title="ConfigurableApplicationContext 创建与准备过程解读"></a>ConfigurableApplicationContext 创建与准备过程解读</h2><h3 id="ConfigurableApplicationContext-创建"><a href="#ConfigurableApplicationContext-创建" class="headerlink" title="ConfigurableApplicationContext 创建"></a>ConfigurableApplicationContext 创建</h3><p>createApplicationContext()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Strategy method used to create the &#123;<span class="doctag">@link</span> ApplicationContext&#125;. By default this</span></span><br><span class="line"><span class="comment"> * method will respect any explicitly set application context or application context</span></span><br><span class="line"><span class="comment"> * class before falling back to a suitable default.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the application context (not yet refreshed)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setApplicationContextClass(Class)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title function_">createApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">	Class&lt;?&gt; contextClass = <span class="built_in">this</span>.applicationContextClass;</span><br><span class="line">    <span class="comment">// 逻辑：如果没有编程式指定contextClass，则根据之前推断的webApplicationType来选择对应默认的ApplicationContext实现类</span></span><br><span class="line">	<span class="keyword">if</span> (contextClass == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">switch</span> (<span class="built_in">this</span>.webApplicationType) &#123;</span><br><span class="line">			<span class="keyword">case</span> SERVLET:</span><br><span class="line">				contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> REACTIVE:</span><br><span class="line">				contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">					<span class="string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认的三个常量类名是什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The class name of application context that will be used by default for non-web</span></span><br><span class="line"><span class="comment"> * environments.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.context.&quot;</span></span><br><span class="line">		+ <span class="string">&quot;annotation.AnnotationConfigApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The class name of application context that will be used by default for web</span></span><br><span class="line"><span class="comment"> * environments.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.boot.&quot;</span></span><br><span class="line">		+ <span class="string">&quot;web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The class name of application context that will be used by default for reactive web</span></span><br><span class="line"><span class="comment"> * environments.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.&quot;</span></span><br><span class="line">		+ <span class="string">&quot;boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="准备过程"><a href="#准备过程" class="headerlink" title="准备过程"></a>准备过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span><br><span class="line"><span class="params">	SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> &#123;</span><br><span class="line">    <span class="comment">// 1、设置环境对象</span></span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    <span class="comment">// 2、设置ApplicationContext的beanNameGenerator、resourceLoader、addConversionService（如果通过SpringApplication编程方式指定了它们）</span></span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    <span class="comment">// 3、应用初始化器对ApplicationContext进行初始化处理（Initializers在构造SpringApplication时就从spring.factories中加载到了）</span></span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    <span class="comment">// 4、发布ApplicationContext准备妥当事件</span></span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    <span class="comment">// 5、打印startup日志信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == <span class="literal">null</span>);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6 、添加例 bean 到 beanFactory中</span></span><br><span class="line">    <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">    beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">        ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">        .setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.lazyInitialization) &#123;</span><br><span class="line">        context.addBeanFactoryPostProcessor(<span class="keyword">new</span> <span class="title class_">LazyInitializationBeanFactoryPostProcessor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7、加载PrimarySource、其他编程式指定的source 配置类中的Bean定义</span></span><br><span class="line">    <span class="comment">// Load the sources</span></span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">    load(context, sources.toArray(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">// 8、发布ApplicationContext加载Bean定义完毕事件</span></span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="刷新过程"><a href="#刷新过程" class="headerlink" title="刷新过程"></a>刷新过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> &#123;</span><br><span class="line">    refresh((ApplicationContext) context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.registerShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            context.registerShutdownHook();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">            <span class="comment">// Not allowed in some environments.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">    Assert.isInstanceOf(ConfigurableApplicationContext.class, applicationContext);</span><br><span class="line">    refresh((ConfigurableApplicationContext) applicationContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="auto-configuration的bean定义加载"><a href="#auto-configuration的bean定义加载" class="headerlink" title="auto configuration的bean定义加载"></a>auto configuration的bean定义加载</h3><p>问题：</p>
<ol>
<li>META-INF&#x2F;spring.factories中指定的auto configuration Bean定义在哪里完成的加载？<br> 整个过程的代码已看完，没看到这块代码，代码茫茫，如何找到加载它们的代码？<br> 思考：一定会从META-INF&#x2F;spring.factories中加载，加载的方法是哪个？<br> 前面的代码中已见过从META-INF&#x2F;spring.factories中加载其他的：</li>
</ol>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3、从META-INF/spring.factories中获取ApplicationContextInitializer </span></span><br><span class="line">setInitializers((Collection) getSpringFactoriesInstances( ApplicationContextInitializer.class));</span><br></pre></td></tr></table></figure>

<p>  那就从这个getSpringFactoriesInstances（…）方法调用中找到一个合适的点，打个断点来看谁会加载自动配置</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; Collection&lt;T&gt; <span class="title function_">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> getClassLoader();</span><br><span class="line">    <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  看到，它是调用的SpringFactoriesLoader.loadFactoryNames(type, classLoader));</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">factoryTypeName</span> <span class="operator">=</span> factoryType.getName();</span><br><span class="line">    <span class="keyword">return</span> loadSpringFactories(classLoader).getOrDefault(factoryTypeName, Collections.emptyList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  在它上打个断点，来看什么时候会加载自动配置的配置类：</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.actuate.autoconfigure.amqp.RabbitHealthContributorAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.actuate.autoconfigure.audit.AuditAutoConfiguration,\</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">loadFactoryNames(Class, ClassLoader):<span class="number">121</span>, SpringFactoriesLoader (org.springframework.core.io.support)</span><br><span class="line">getCandidateConfigurations(AnnotationMetadata, AnnotationAttributes):<span class="number">178</span>, AutoConfigurationImportSelector (org.springframework.boot.autoconfigure)</span><br><span class="line">getAutoConfigurationEntry(AnnotationMetadata):<span class="number">123</span>, AutoConfigurationImportSelector (org.springframework.boot.autoconfigure)</span><br><span class="line">process(AnnotationMetadata, DeferredImportSelector):<span class="number">434</span>, AutoConfigurationImportSelector$AutoConfigurationGroup (org.springframework.boot.autoconfigure)</span><br><span class="line">getImports():<span class="number">879</span>, ConfigurationClassParser$DeferredImportSelectorGrouping (org.springframework.context.annotation)</span><br><span class="line">processGroupImports():<span class="number">809</span>, ConfigurationClassParser$DeferredImportSelectorGroupingHandler (org.springframework.context.annotation)</span><br><span class="line">process():<span class="number">780</span>, ConfigurationClassParser$DeferredImportSelectorHandler (org.springframework.context.annotation)</span><br><span class="line">parse(Set):<span class="number">193</span>, ConfigurationClassParser (org.springframework.context.annotation)</span><br><span class="line">processConfigBeanDefinitions(BeanDefinitionRegistry):<span class="number">319</span>, ConfigurationClassPostProcessor (org.springframework.context.annotation)</span><br><span class="line">postProcessBeanDefinitionRegistry(BeanDefinitionRegistry):<span class="number">236</span>, ConfigurationClassPostProcessor (org.springframework.context.annotation)</span><br><span class="line">invokeBeanDefinitionRegistryPostProcessors(Collection, BeanDefinitionRegistry):<span class="number">280</span>, PostProcessorRegistrationDelegate (org.springframework.context.support)</span><br><span class="line">invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory, List):<span class="number">96</span>, PostProcessorRegistrationDelegate (org.springframework.context.support)</span><br><span class="line">invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory):<span class="number">707</span>, AbstractApplicationContext (org.springframework.context.support)</span><br><span class="line">refresh():<span class="number">533</span>, AbstractApplicationContext (org.springframework.context.support)</span><br><span class="line">refresh():<span class="number">143</span>, ServletWebServerApplicationContext (org.springframework.boot.web.servlet.context)</span><br><span class="line">refresh(ConfigurableApplicationContext):<span class="number">758</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">refresh(ApplicationContext):<span class="number">750</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">refreshContext(ConfigurableApplicationContext):<span class="number">397</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(String[]):<span class="number">315</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(Class[], String[]):<span class="number">1237</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">run(Class, String[]):<span class="number">1226</span>, SpringApplication (org.springframework.boot)</span><br><span class="line">main(String[]):<span class="number">9</span>, App (com.study)</span><br></pre></td></tr></table></figure>

<p>  从调用栈看到是在进行ConfigurationClassPostProcessor处理阶段</p>
<p>  其实，秘密在@SpringBootApplication复合的 @EnableAutoConfiguration 注解</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Enable auto-configuration of the Spring Application Context, attempting to guess and</span></span><br><span class="line"><span class="comment"> * configure beans that you are likely to need. Auto-configuration classes are usually</span></span><br><span class="line"><span class="comment"> * applied based on your classpath and what beans you have defined. For example, if you</span></span><br><span class="line"><span class="comment"> * have &#123;<span class="doctag">@code</span> tomcat-embedded.jar&#125; on your classpath you are likely to want a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> TomcatServletWebServerFactory&#125; (unless you have defined your own</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; bean).</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * When using &#123;<span class="doctag">@link</span> SpringBootApplication <span class="doctag">@SpringBootApplication</span>&#125;, the auto-configuration</span></span><br><span class="line"><span class="comment"> * of the context is automatically enabled and adding this annotation has therefore no</span></span><br><span class="line"><span class="comment"> * additional effect.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Auto-configuration tries to be as intelligent as possible and will back-away as you</span></span><br><span class="line"><span class="comment"> * define more of your own configuration. You can always manually &#123;<span class="doctag">@link</span> #exclude()&#125; any</span></span><br><span class="line"><span class="comment"> * configuration that you never want to apply (use &#123;<span class="doctag">@link</span> #excludeName()&#125; if you don&#x27;t</span></span><br><span class="line"><span class="comment"> * have access to them). You can also exclude them via the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> spring.autoconfigure.exclude&#125; property. Auto-configuration is always applied</span></span><br><span class="line"><span class="comment"> * after user-defined beans have been registered.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * The package of the class that is annotated with &#123;<span class="doctag">@code</span> <span class="doctag">@EnableAutoConfiguration</span>&#125;,</span></span><br><span class="line"><span class="comment"> * usually via &#123;<span class="doctag">@code</span> <span class="doctag">@SpringBootApplication</span>&#125;, has specific significance and is often used</span></span><br><span class="line"><span class="comment"> * as a &#x27;default&#x27;. For example, it will be used when scanning for &#123;<span class="doctag">@code</span> <span class="doctag">@Entity</span>&#125; classes.</span></span><br><span class="line"><span class="comment"> * It is generally recommended that you place &#123;<span class="doctag">@code</span> <span class="doctag">@EnableAutoConfiguration</span>&#125; (if you&#x27;re</span></span><br><span class="line"><span class="comment"> * not using &#123;<span class="doctag">@code</span> <span class="doctag">@SpringBootApplication</span>&#125;) in a root package so that all sub-packages</span></span><br><span class="line"><span class="comment"> * and classes can be searched.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Auto-configuration classes are regular Spring &#123;<span class="doctag">@link</span> Configuration <span class="doctag">@Configuration</span>&#125;</span></span><br><span class="line"><span class="comment"> * beans. They are located using the &#123;<span class="doctag">@link</span> SpringFactoriesLoader&#125; mechanism (keyed</span></span><br><span class="line"><span class="comment"> * against this class). Generally auto-configuration beans are</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> Conditional <span class="doctag">@Conditional</span>&#125; beans (most often using</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ConditionalOnClass <span class="doctag">@ConditionalOnClass</span>&#125; and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ConditionalOnMissingBean <span class="doctag">@ConditionalOnMissingBean</span>&#125; annotations).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConditionalOnBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConditionalOnMissingBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConditionalOnClass</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AutoConfigureAfter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> SpringBootApplication</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">String</span> <span class="variable">ENABLED_OVERRIDE_PROPERTY</span> <span class="operator">=</span> <span class="string">&quot;spring.boot.enableautoconfiguration&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment">	 * applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  AutoConfigurationImportSelector 干的这个事</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware,</span><br><span class="line">		ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>重点说明</strong>：AutoConfigurationImportSelector 实现了 DeferredImportSelector 是延迟导入选择器。所谓延迟：在所有指定的、包扫描到的@Configuration类中的 bean定义注册后，才会来处理延迟导入的@Configuration类 </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">所谓延迟：在所有指定的、包扫描到的<span class="doctag">@Configuration</span>类中的bean定义注册后，才会来处理延迟导入的<span class="doctag">@Configuration</span>类</span></span><br><span class="line"><span class="comment"> * A variation of &#123;<span class="doctag">@link</span> ImportSelector&#125; that runs after all &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; beans</span></span><br><span class="line"><span class="comment"> * have been processed. This type of selector can be particularly useful when the selected</span></span><br><span class="line"><span class="comment"> * imports are &#123;<span class="doctag">@code</span> <span class="doctag">@Conditional</span>&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Implementations can also extend the &#123;<span class="doctag">@link</span> org.springframework.core.Ordered&#125;</span></span><br><span class="line"><span class="comment"> * interface or use the &#123;<span class="doctag">@link</span> org.springframework.core.annotation.Order&#125; annotation to</span></span><br><span class="line"><span class="comment"> * indicate a precedence against other &#123;<span class="doctag">@link</span> DeferredImportSelector DeferredImportSelectors&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Implementations may also provide an &#123;<span class="doctag">@link</span> #getImportGroup() import group&#125; which</span></span><br><span class="line"><span class="comment"> * can provide additional sorting and filtering logic across different selectors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeferredImportSelector</span> <span class="keyword">extends</span> <span class="title class_">ImportSelector</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>这里自动配置为什么要以DeferredImportSelector 延迟导入的方式？</p>
<p>答案：让我们自己编程配置的bean提前注册，这样自动配置时的条件判断能发现到我们配置的，就能做到不再配置 自动配置的bean等。比如：如果我们自己配置了数据源bean，则使用我们配置的数据源，不在自动配置数据源。数 据源自动配置的代码中可以看到@ConditionalOnMissingBean({ DataSource.class, XADataSource.class })：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">         DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class,</span></span><br><span class="line"><span class="meta">         DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="callRunners-context-applicationArguments-解读"><a href="#callRunners-context-applicationArguments-解读" class="headerlink" title="callRunners(context, applicationArguments) 解读"></a>callRunners(context, applicationArguments) 解读</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10、执行所有的的Runners </span></span><br><span class="line">callRunners(context, applicationArguments);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callRunners</span><span class="params">(ApplicationContext context, ApplicationArguments args)</span> &#123;</span><br><span class="line">    List&lt;Object&gt; runners = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span><br><span class="line">    runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span><br><span class="line">    AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">    <span class="keyword">for</span> (Object runner : <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(runners)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> ApplicationRunner) &#123;</span><br><span class="line">            callRunner((ApplicationRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> CommandLineRunner) &#123;</span><br><span class="line">            callRunner((CommandLineRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callRunner</span><span class="params">(ApplicationRunner runner, ApplicationArguments args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        (runner).run(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to execute ApplicationRunner&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callRunner</span><span class="params">(CommandLineRunner runner, ApplicationArguments args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        (runner).run(args.getSourceArgs());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to execute CommandLineRunner&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在代码中我们看到，从applicationContext 获取了所有 ApplicationRunner、CommandLineRunner类型的bean，并执行了它们的run方法。</p>
<h3 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li><p>ApplicationRunner 是什么？有什么用？</p>
</li>
<li><p>CommandLineRunner是什么？有什么用？</p>
</li>
</ol>
<p>两个是同样的用途：当ApplicationContext刷新好后，来执行你的应用逻辑。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootStudyConfigApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; </span><br><span class="line">        SpringApplication.run(SpringBootStudyConfigApplication.class, args); </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;***************** &quot;</span> + args.getOptionNames()); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除此之外，你还有什么方式来执行应用逻辑吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootStudyConfigApplication</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; </span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpringApplication.run(SpringBootStudyConfigApplication.class, args); </span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">mybean</span> <span class="operator">=</span> context.getBean(MyBean.class); </span><br><span class="line">        mybean.doService(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Tomcat是如何跑起来的？"><a href="#Tomcat是如何跑起来的？" class="headerlink" title="Tomcat是如何跑起来的？"></a>Tomcat是如何跑起来的？</h2><p>从创建ApplicationContext处开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5、创建ApplicationContext </span></span><br><span class="line">context = createApplicationContext();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title function_">createApplicationContext</span><span class="params">()</span> &#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = <span class="built_in">this</span>.applicationContextClass;</span><br><span class="line">    <span class="keyword">if</span> (contextClass == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">this</span>.webApplicationType) &#123;</span><br><span class="line">                <span class="keyword">case</span> SERVLET:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> REACTIVE:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看AnnotationConfigServletWebServerApplicationContext类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationConfigServletWebServerApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">ServletWebServerApplicationContext</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">AnnotationConfigRegistry</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>看它的父类ServletWebServerApplicationContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">这个context会通过从自身查找一个ServletWebServerFactory单例bean来创建、初始化、运行一个WebServer</span></span><br><span class="line"><span class="comment">&lt;p&gt;</span></span><br><span class="line"><span class="comment">此外，在context中定义的Servlet、Filter bean会被自动注册到Web Server。如果只有一个Servlet bean，则会将它映射到&#x27;/&#x27; 请求地址；多个Servlet bean时，则bean name 的小写将作为 mapping 前缀；bean名</span></span><br><span class="line"><span class="comment">为&#x27;dispatcherServlet&#x27; 的Servlet将映射到 &#x27;/&#x27;。Filter beans将会映射到&#x27;/*&#x27;（所有url)</span></span><br><span class="line"><span class="comment">&lt;p&gt;</span></span><br><span class="line"><span class="comment">更高级的配置ServletContext的方式：定义实现ServletContextInitializer接口的bean，更常用的 方式是通过 配置ServletRegistrationBean和FilterRegistrationBean的方式来配Servlet、Filter. 为防止重复注册，当使用ServletContextInitializer beans 时会关闭自动Servlet和Filter Bean 注册</span></span><br><span class="line"><span class="comment">&lt;p&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * A &#123;<span class="doctag">@link</span> WebApplicationContext&#125; that can be used to bootstrap itself from a contained</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; bean.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This context will create, initialize and run an &#123;<span class="doctag">@link</span> WebServer&#125; by searching for a</span></span><br><span class="line"><span class="comment"> * single &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; bean within the &#123;<span class="doctag">@link</span> ApplicationContext&#125;</span></span><br><span class="line"><span class="comment"> * itself. The &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; is free to use standard Spring concepts</span></span><br><span class="line"><span class="comment"> * (such as dependency injection, lifecycle callbacks and property placeholder variables).</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * In addition, any &#123;<span class="doctag">@link</span> Servlet&#125; or &#123;<span class="doctag">@link</span> Filter&#125; beans defined in the context will be</span></span><br><span class="line"><span class="comment"> * automatically registered with the web server. In the case of a single Servlet bean, the</span></span><br><span class="line"><span class="comment"> * &#x27;/&#x27; mapping will be used. If multiple Servlet beans are found then the lowercase bean</span></span><br><span class="line"><span class="comment"> * name will be used as a mapping prefix. Any Servlet named &#x27;dispatcherServlet&#x27; will</span></span><br><span class="line"><span class="comment"> * always be mapped to &#x27;/&#x27;. Filter beans will be mapped to all URLs (&#x27;/*&#x27;).</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * For more advanced configuration, the context can instead define beans that implement</span></span><br><span class="line"><span class="comment"> * the &#123;<span class="doctag">@link</span> ServletContextInitializer&#125; interface (most often</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ServletRegistrationBean&#125;s and/or &#123;<span class="doctag">@link</span> FilterRegistrationBean&#125;s). To prevent</span></span><br><span class="line"><span class="comment"> * double registration, the use of &#123;<span class="doctag">@link</span> ServletContextInitializer&#125; beans will disable</span></span><br><span class="line"><span class="comment"> * automatic Servlet and Filter bean registration.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Although this context can be used directly, most developers should consider using the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> AnnotationConfigServletWebServerApplicationContext&#125; or</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> XmlServletWebServerApplicationContext&#125; variants.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Scott Frederick</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationConfigServletWebServerApplicationContext</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> XmlServletWebServerApplicationContext</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ServletWebServerFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletWebServerApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">GenericWebApplicationContext</span></span><br><span class="line">		<span class="keyword">implements</span> <span class="title class_">ConfigurableWebServerApplicationContext</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(ServletWebServerApplicationContext.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constant value for the DispatcherServlet bean name. A Servlet bean with this name</span></span><br><span class="line"><span class="comment">	 * is deemed to be the &quot;main&quot; servlet and is automatically given a mapping of &quot;/&quot; by</span></span><br><span class="line"><span class="comment">	 * default. To change the default behavior you can use a</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> ServletRegistrationBean&#125; or a different bean name.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DISPATCHER_SERVLET_NAME</span> <span class="operator">=</span> <span class="string">&quot;dispatcherServlet&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> WebServer webServer;</span><br><span class="line">	<span class="keyword">private</span> ServletConfig servletConfig;</span><br><span class="line">	<span class="keyword">private</span> String serverNamespace;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebServer的创建过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onRefresh();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        createWebServer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start web server&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>onRefresh()方法是AbstractApplicationContext中定义的供子类实现的空模板方法，在refresh()方法中被调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createWebServer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">WebServer</span> <span class="variable">webServer</span> <span class="operator">=</span> <span class="built_in">this</span>.webServer;</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">    <span class="keyword">if</span> (webServer == <span class="literal">null</span> &amp;&amp; servletContext == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ServletWebServerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> getWebServerFactory();</span><br><span class="line">        <span class="built_in">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">        getBeanFactory().registerSingleton(<span class="string">&quot;webServerGracefulShutdown&quot;</span>,</span><br><span class="line">                                           <span class="keyword">new</span> <span class="title class_">WebServerGracefulShutdownLifecycle</span>(<span class="built_in">this</span>.webServer));</span><br><span class="line">        getBeanFactory().registerSingleton(<span class="string">&quot;webServerStartStop&quot;</span>,</span><br><span class="line">                                           <span class="keyword">new</span> <span class="title class_">WebServerStartStopLifecycle</span>(<span class="built_in">this</span>, <span class="built_in">this</span>.webServer));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getSelfInitializer().onStartup(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Cannot initialize servlet context&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看它里面的getWebServerFactory()：从容器中找ServletWebServerFactory类型的Bean，只能有一个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; that should be used to create the</span></span><br><span class="line"><span class="comment"> * embedded &#123;<span class="doctag">@link</span> WebServer&#125;. By default this method searches for a suitable bean in</span></span><br><span class="line"><span class="comment"> * the context itself.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> ServletWebServerFactory&#125; (never &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ServletWebServerFactory <span class="title function_">getWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// Use bean names so that we don&#x27;t consider the hierarchy</span></span><br><span class="line">	String[] beanNames = getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class);</span><br><span class="line">	<span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to missing &quot;</span></span><br><span class="line">				+ <span class="string">&quot;ServletWebServerFactory bean.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start ServletWebServerApplicationContext due to multiple &quot;</span></span><br><span class="line">				+ <span class="string">&quot;ServletWebServerFactory beans : &quot;</span> + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ServletWebServerFactory.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看通过factory.getWebServer()得到WebServer，先看接口定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Factory interface that can be used to create a &#123;<span class="doctag">@link</span> WebServer&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> WebServer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletWebServerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	获得一个完全配置但暂停的新WebServer实例，当ApplicationContext完成refresh后再调用WebServer.start(),客户端才可以进行连接。</span></span><br><span class="line"><span class="comment">	 * Gets a new fully configured but paused &#123;<span class="doctag">@link</span> WebServer&#125; instance. Clients should</span></span><br><span class="line"><span class="comment">	 * not be able to connect to the returned server until &#123;<span class="doctag">@link</span> WebServer#start()&#125; is</span></span><br><span class="line"><span class="comment">	 * called (which happens when the &#123;<span class="doctag">@code</span> ApplicationContext&#125; has been fully</span></span><br><span class="line"><span class="comment">	 * refreshed).</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> initializers &#123;<span class="doctag">@link</span> ServletContextInitializer&#125;s that should be applied as</span></span><br><span class="line"><span class="comment">	 * the server starts</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a fully configured and started &#123;<span class="doctag">@link</span> WebServer&#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> WebServer#stop()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	WebServer <span class="title function_">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在WebServerStartStopLifecycle.start中可以看到做这个start&#x2F;stop动作的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.webServer.start();</span><br><span class="line">    <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">this</span>.applicationContext</span><br><span class="line">        .publishEvent(<span class="keyword">new</span> <span class="title class_">ServletWebServerInitializedEvent</span>(<span class="built_in">this</span>.webServer, <span class="built_in">this</span>.applicationContext));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.webServer.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TomcatServletWebServerFactory中的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WebServer <span class="title function_">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.disableMBeanRegistry) &#123;</span><br><span class="line">        Registry.disableRegistry();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">    <span class="type">File</span> <span class="variable">baseDir</span> <span class="operator">=</span> (<span class="built_in">this</span>.baseDirectory != <span class="literal">null</span>) ? <span class="built_in">this</span>.baseDirectory : createTempDir(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">    <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connector</span>(<span class="built_in">this</span>.protocol);</span><br><span class="line">    connector.setThrowOnFailure(<span class="literal">true</span>);</span><br><span class="line">    tomcat.getService().addConnector(connector);</span><br><span class="line">    customizeConnector(connector);</span><br><span class="line">    tomcat.setConnector(connector);</span><br><span class="line">    tomcat.getHost().setAutoDeploy(<span class="literal">false</span>);</span><br><span class="line">    configureEngine(tomcat.getEngine());</span><br><span class="line">    <span class="keyword">for</span> (Connector additionalConnector : <span class="built_in">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">        tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">    &#125;</span><br><span class="line">    prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">    <span class="keyword">return</span> getTomcatWebServer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>疑问：TomcatServletWebServerFactory这个Bean哪里配置的？</p>
<p>在spring boot 的自动配置中可以找到</p>
<p>看 ServletWebServerFactoryAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration&#125; for servlet web servers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Ivan Sopov</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Brian Clozel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ServletRequest.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ServerProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedJetty.class,</span></span><br><span class="line"><span class="meta">		ServletWebServerFactoryConfiguration.EmbeddedUndertow.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletWebServerFactoryAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> ServletWebServerFactoryCustomizer <span class="title function_">servletWebServerFactoryCustomizer</span><span class="params">(ServerProperties serverProperties)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletWebServerFactoryCustomizer</span>(serverProperties);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(name = &quot;org.apache.catalina.startup.Tomcat&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> TomcatServletWebServerFactoryCustomizer <span class="title function_">tomcatServletWebServerFactoryCustomizer</span><span class="params">(</span></span><br><span class="line"><span class="params">			ServerProperties serverProperties)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactoryCustomizer</span>(serverProperties);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看ServletWebServerFactoryConfiguration.EmbeddedTomcat.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServletWebServerFactoryConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(&#123; Servlet.class, Tomcat.class, UpgradeProtocol.class &#125;)</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EmbeddedTomcat</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		TomcatServletWebServerFactory <span class="title function_">tomcatServletWebServerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">				ObjectProvider&lt;TomcatConnectorCustomizer&gt; connectorCustomizers,</span></span><br><span class="line"><span class="params">				ObjectProvider&lt;TomcatContextCustomizer&gt; contextCustomizers,</span></span><br><span class="line"><span class="params">				ObjectProvider&lt;TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; protocolHandlerCustomizers)</span> &#123;</span><br><span class="line">			<span class="type">TomcatServletWebServerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactory</span>();</span><br><span class="line">			factory.getTomcatConnectorCustomizers()</span><br><span class="line">					.addAll(connectorCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">			factory.getTomcatContextCustomizers()</span><br><span class="line">					.addAll(contextCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">			factory.getTomcatProtocolHandlerCustomizers()</span><br><span class="line">					.addAll(protocolHandlerCustomizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">			<span class="keyword">return</span> factory;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到 @EnableConfigurationProperties(ServerProperties.class)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;server&quot;, ignoreUnknownFields = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerProperties</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>可以配置哪些服务器参数：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210918164939.png"></p>
<p>参数配置示例： application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">	<span class="attr">port:</span> <span class="number">80</span> </span><br><span class="line">	<span class="attr">servlet:</span> </span><br><span class="line">		<span class="attr">context-path:</span> <span class="string">/app</span> </span><br><span class="line">		<span class="attr">session:</span> </span><br><span class="line">			<span class="attr">timeout:</span> <span class="number">60</span> <span class="comment">#单位秒 </span></span><br><span class="line">			<span class="attr">cookie:</span> </span><br><span class="line">				<span class="attr">name:</span> <span class="string">myLove</span> </span><br><span class="line">	<span class="attr">tomcat:</span> </span><br><span class="line">		<span class="attr">max-connections:</span> <span class="number">20000</span> </span><br><span class="line">		<span class="attr">max-threads:</span> <span class="number">400</span></span><br></pre></td></tr></table></figure>



<h1 id="Spring-boot-web-中集成-Servlet-api"><a href="#Spring-boot-web-中集成-Servlet-api" class="headerlink" title="Spring boot web 中集成 Servlet api"></a>Spring boot web 中集成 Servlet api</h1><h2 id="使用-Servlet-Filter"><a href="#使用-Servlet-Filter" class="headerlink" title="使用 Servlet Filter"></a>使用 Servlet Filter</h2><p>有两种方式</p>
<h3 id="servelt3-0-注解-ServletComponentScan"><a href="#servelt3-0-注解-ServletComponentScan" class="headerlink" title="servelt3.0 注解 + @ServletComponentScan"></a>servelt3.0 注解 + @ServletComponentScan</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/myservlet&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123; </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123; </span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;name&quot;</span>); </span><br><span class="line">        resp.getWriter().print(<span class="string">&quot;hello MyServlet &quot;</span> + name); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span> </span><br><span class="line"><span class="meta">@ServletComponentScan</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootStudySourceApplication</span> &#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123; </span><br><span class="line">        SpringApplication.run(SpringBootStudySourceApplication.class, args); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ServletRegistrationBean和FilterRegistrationBean注册方式"><a href="#ServletRegistrationBean和FilterRegistrationBean注册方式" class="headerlink" title="ServletRegistrationBean和FilterRegistrationBean注册方式"></a>ServletRegistrationBean和FilterRegistrationBean注册方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@WebFilter(&quot;/*&quot;) </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123; </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;*************** MyFilter doFilter *****&quot;</span>); </span><br><span class="line">        chain.doFilter(request, response); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="keyword">public</span> FilterRegistrationBean&lt;MyFilter&gt; <span class="title function_">getFilterRegistrationBean</span><span class="params">()</span> &#123; </span><br><span class="line">    FilterRegistrationBean&lt;MyFilter&gt; frb = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;(); </span><br><span class="line">    frb.setFilter(<span class="keyword">new</span> <span class="title class_">MyFilter</span>()); </span><br><span class="line">    frb.addUrlPatterns(<span class="string">&quot;/*&quot;</span>); </span><br><span class="line">    <span class="keyword">return</span> frb; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jsp做视图技术"><a href="#jsp做视图技术" class="headerlink" title="jsp做视图技术"></a>jsp做视图技术</h2><p>spring boot 不推荐使用jsp。</p>
<p>集成jsp的步骤：</p>
<ol>
<li><p>引入对应的jar</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建jsp文件放置目录 src&#x2F;main下创建 webapp&#x2F;WEB-INF&#x2F;jsp&#x2F;</p>
</li>
<li><p>在application.yml中配置spring.mvc.view</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">	<span class="attr">mvc:</span> </span><br><span class="line">		<span class="attr">view:</span> </span><br><span class="line">			<span class="attr">prefix:</span> <span class="string">/WEB-INF/jsp/</span> </span><br><span class="line">			<span class="attr">suffix:</span> <span class="string">.jsp</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写Controller jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123; </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/index&quot;)</span> </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toIndex</span><span class="params">()</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">            xxxxxxxxxxxxxxxxxx-$&#123;param.name &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/03-SpringBoot/05-SpringBoot-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="clmcxecx60086u8wahosobyer" data-title="SpringBoot-源码解读" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-04-SpringCloud/01-SpringCloud入门（一）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/04-SpringCloud/01-SpringCloud%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringCloud/">SpringCloud</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/04-SpringCloud/01-SpringCloud%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/">SpringCloud入门（一）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前提知识"><a href="#前提知识" class="headerlink" title="前提知识"></a>前提知识</h1><h2 id="什么是集群？"><a href="#什么是集群？" class="headerlink" title="什么是集群？"></a>什么是集群？</h2><p>通过一组松散集成的计算机软件和&#x2F;或硬件连接起来高度紧密地协作完成计算工作。在某种意义上，他们可以被看作是一台计算机。集群系统中的单个计算机通常称为节点，通常通过局域网连接，但也有其它的可能连接方式。集群计算机通常用来改进单个计算机的计算速度和&#x2F;或可靠性。一般情况下集群计算机比单个计算机，比如工作站或超级计算机性能价格比要高得多。</p>
<p>特点：</p>
<ul>
<li><p>通过<strong>多台计算机完成同一个工作</strong>，达到更高的效率。</p>
</li>
<li><p><strong>多机内容、工作过程等完全一样</strong>。如果一台死机，另一台可以起作用。</p>
</li>
</ul>
<h2 id="什么是分布式？"><a href="#什么是分布式？" class="headerlink" title="什么是分布式？"></a>什么是分布式？</h2><p>分布式系统是一组计算机，通过网络相互连接传递消息与通信后并协调它们的行为而形成的系统。<strong>组件之间彼此进行交互以实现一个共同的目标</strong>。</p>
<h2 id="什么是SOA？"><a href="#什么是SOA？" class="headerlink" title="什么是SOA？"></a>什么是SOA？</h2><p>业务系统分解为多个组件，让每个组件都独立提供离散，自治，可复用的服务能力，通过服务的组合和编排来实现上层的业务流程。</p>
<p>作用：简化维护，降低整体风险，伸缩灵活</p>
<h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>spring官网微服务的解释：<a target="_blank" rel="noopener" href="https://spring.io/microservices">https://spring.io/microservices</a></p>
<p>马丁·福勒关于微服务的解释：<a target="_blank" rel="noopener" href="https://martinfowler.com/microservices/">https://martinfowler.com/microservices/</a></p>
<p>微服务：<a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.htm">https://martinfowler.com/articles/microservices.htm</a></p>
<p>中文翻译：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4821a29fa998">简书上</a>、<a target="_blank" rel="noopener" href="http://blog.cuicc.com/blog/2015/07/22/microservices/">YYGCui个人博客</a></p>
<h1 id="微服务概述"><a href="#微服务概述" class="headerlink" title="微服务概述"></a>微服务概述</h1><h2 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h2><p>马丁·福勒：<a target="_blank" rel="noopener" href="https://martinfowler.com/">https://martinfowler.com/</a></p>
<p>Martinfowler，是作家、演讲家、ThoughtWorks首席科学家，也是企业应用程序开发体系结构主题的权威人士。企业应用程序开发微服务架构提倡者，下面是他对微服务架构的定义。</p>
<p>微服务是一种软件架构设计风格。是一种将单个应用程序开发分为一组小型服务的方法，每个小型服务都在自己的进程中运行并与轻量级机制（通常是HTTP资源API）进行通信。这些服务围绕业务能力构建并且可通过全自动部署机制独立部署。这些服务共用一个最小型的集中式的管理，服务可用不同的语言开发，使用不同的数据存储技术。  </p>
<p>备注：这里说HTTP是轻量级是相对于SOA中的ESB</p>
<h2 id="单体应用与微服务"><a href="#单体应用与微服务" class="headerlink" title="单体应用与微服务"></a>单体应用与微服务</h2><p><strong>单体应用</strong>∶处理用户请求的所有逻辑都运行在单个的进程内，能发挥编程语言的特性，把系统划分为<strong>类</strong>、<strong>函数</strong>和<strong>命名空间</strong>。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1.png"></p>
<p><span style="color:red">问题∶互联网时代，应用业务功能越来越庞大，应用的更新受到很大限制，很小的变更需要重新构建部署整个系统。</span></p>
<p><strong>微服务</strong>∶抽出同质业务，构建一组小型服务的方式来构建应用系统</p>
<p>它们的规模小且相对隔离可以带来许多其他好处，例如更容易维护，提高生产率，更大的容错能力，更好的业务调整等等。</p>
<p>微服务架构成为软件开发的新常态。构建小型，独立自治，可运行的应用程序可以带来极大的灵活性，并为您的代码增加弹性。没有SpringCloud简化管理和提高容错能力。</p>
<p>架构设计概念，各服务间隔离（分布式也是隔离），自治（分布式依赖整体组合）其它特性(单一职责，边界，异步通信，独立部署)是分布式概念的跟严格执行SOA到微服务架构的演进过程。</p>
<h2 id="微服务九大特征"><a href="#微服务九大特征" class="headerlink" title="微服务九大特征"></a>微服务九大特征</h2><p><strong>特性一∶”组件化”与”多服务”</strong> </p>
<p>​	组件表示是一个可以独立更换和升级的软件单元，通过内存中的函数调用。服务是进程外的组件，通过远程过程调用进行通信。应用系统通过服务来实现组件化，是因为，组件的修改需要重新部署整个系统，服务则只需要重新部署这一个服务，不会影响整个系统。</p>
<p><strong>特性二∶围绕”业务功能”组织团队</strong></p>
<p>​	 减轻沟通成本。任何设计（广义上的）系统的组织，都会产生这样一个设计，即该设计的结构与该组织的沟通结构相—致。康威定律。</p>
<p> <strong>特性三∶ “做产品”而不是”做项目”</strong> </p>
<p>​	做项目是做完就解散开发团队，做产品则是开发团队为产品的整个生命周期负责。</p>
<p> <strong>特性四∶”智能端点”与”傻瓜管道”</strong> </p>
<p>​	去除智能通信机制ESB，每个服务高内聚低耦合实现自已的领域逻辑，采用REST协议和轻量级消息协议。  </p>
<p><strong>特性五∶”去中心化”的治理技术</strong> </p>
<p>​	中心化单一的技术栈具有局限性，去中心化治理技术，能针对不同的服务都能够选择合适的技术栈。</p>
<p><strong>特性六∶”去中心化”的管理数据</strong></p>
<p>​	 各个服务采用各自合适的数据存储方案，通过最终一致性、补偿方案来达到数据的一致性。</p>
<p><strong>特性七∶”基础设施”自动化</strong> </p>
<p>​	自动持续构建与交付，从编译、测试到部署。微服务中具备这样的流水线更加的方便省力。</p>
<p> <strong>特性八∶”容错”设计</strong> </p>
<p>​	使用微服务来替代组件，应用程序需要设计为能容忍这些服务出现的故障。发生故障时，能快速检测出故障，而且尽可能进行自动恢复服务。应用程序化大量精力放在实时监控上，检查服务各项指标、业务相关指标，某个地方出现问题能够报警。</p>
<p><strong>特性九∶”演进式”设计</strong></p>
<p>​	 不建议项目从零开始就进行微服务设计，在原有的单体系统上，新的特性可及时拆分、老特性逐步拆分演进。  </p>
<h2 id="RPC框架与微服务"><a href="#RPC框架与微服务" class="headerlink" title="RPC框架与微服务"></a>RPC框架与微服务</h2><ul>
<li><p>RPC框架是一个远程过程调用框架，具备通信协议、寻址、序列化三个核心过程处理。</p>
</li>
<li><p>微服务则是一个业务应用级别的架构设计方法，微服务的具体实现通过RPC框架来实现。</p>
</li>
</ul>
<p>学习微服务，我们可以先对比RPC框架的功能实现来快速入门SpringCloud，以Dubbo为例进行对比：</p>
<table>
<thead>
<tr>
<th>功能特效</th>
<th>Dubbo</th>
<th>SpringCloud</th>
</tr>
</thead>
<tbody><tr>
<td>注册中心</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>负载均衡</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>服务治理</td>
<td>√</td>
<td>不完善</td>
</tr>
<tr>
<td>服务监控</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>客户端服务调用</td>
<td>基于接口</td>
<td>需要声明式组件</td>
</tr>
<tr>
<td>集成协议</td>
<td>多种</td>
<td>HTTP</td>
</tr>
<tr>
<td>集成序列化</td>
<td>多种</td>
<td>字符串</td>
</tr>
<tr>
<td>断路器</td>
<td>集群容错-不完善</td>
<td>√</td>
</tr>
<tr>
<td>服务网关</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>分布式配置</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>服务跟踪</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>消息总线</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>数据流</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>批量任务</td>
<td>×</td>
<td>√</td>
</tr>
</tbody></table>
<p>可见SpringCloud对微服务的支撑更加丰富全面。</p>
<h1 id="初识SpringCloud"><a href="#初识SpringCloud" class="headerlink" title="初识SpringCloud"></a>初识SpringCloud</h1><h2 id="SpringCloud是什么？"><a href="#SpringCloud是什么？" class="headerlink" title="SpringCloud是什么？"></a>SpringCloud是什么？</h2><p>Spring Cloud俗称微服务全家桶，实现分布式微服务一站式解决方案，多种微服务架构落地技术集合，提供开箱即用的良好体验。</p>
<p>从<a target="_blank" rel="noopener" href="https://spring.io/microservices">Spring官网</a>关于微服务描述可知，SpringCloud支持微服务架构如图：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/SpringCloud%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84.svg"></p>
<p>Spring Cloud为开发人员提供了整套微服务工具，可以快速构建分布式系统中的—些常见模式。例如，配置管理服务发现，断路器，智能路由，微代理，控制总线，一次性令牌，全局锁，领导选举，分布式会话，群集状态。</p>
<p>SpringCloud官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud/docs/Hoxton.SR9/reference/htmlsingle/">戳这里</a></p>
<h2 id="为什么用SpringCloud？"><a href="#为什么用SpringCloud？" class="headerlink" title="为什么用SpringCloud？"></a>为什么用SpringCloud？</h2><p>分布式微服务架构一站式的解决方案，开发高效，生态组件全面丰富，社区活跃度高，文档完善。</p>
<h2 id="什么时候会用到SpringCloud？"><a href="#什么时候会用到SpringCloud？" class="headerlink" title="什么时候会用到SpringCloud？"></a>什么时候会用到SpringCloud？</h2><p>系统复杂到需要进行拆小，并且独立运行部署的阶段。从开发效率、部署运维、团队成本、人员沟通角度考虑。</p>
<h2 id="SpringCloud与微服务"><a href="#SpringCloud与微服务" class="headerlink" title="SpringCloud与微服务"></a>SpringCloud与微服务</h2><p>SpringCloud通过SpringBoot构建一个个可独立运行的微服务应用，并且能够快速迭代。</p>
<p>构建一个分布式微服务需要包含如下组件∶</p>
<ul>
<li>服务注册与发现</li>
<li>服务网关</li>
<li>服务调用</li>
<li>服务监控 </li>
<li>负载均衡 </li>
<li>全链路追踪</li>
<li>熔断器</li>
<li>自动化构建部署</li>
<li>分布式消息</li>
<li> 定时任务调度操作</li>
<li>分布式配置</li>
</ul>
<p>通过<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">SpringCloud官方网站</a>可知它的生态圈非常庞大，对各类云、各类组件的支持。</p>
<p><strong>SpringCloud中的组件：</strong></p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>aws</td>
<td>简化了与托管的Amazon Web Services的集成，供一种方便的与AWS交互的方法，使用Spring习惯用法和API(如消息传递或缓存API)提供服务。开发人员可以围绕托管服务构建应用程序，而不必关心基础设施或维护。</td>
<td></td>
</tr>
<tr>
<td>build</td>
<td>Spring Cloud用于插件和依赖管理的通用工具项目</td>
<td></td>
</tr>
<tr>
<td>bus</td>
<td>Spring Cloud Bus用轻量级消息代理链接分布式系统的节点。 然后可以使用此代理来广播状态更改（如配置更改）或其他管理说明。 一个关键的想法是，总线就像一个分布式执行器，用于一个扩展的SpringBoot应用程序。 然而，它也可以用作应用程序之间的通信通道。 此项目为AMQP代理或Kafka作为传输提供启动程序。</td>
<td></td>
</tr>
<tr>
<td>circuitbreaker</td>
<td>断路器，支持reactive应用程序和非reactive应用程序。</td>
<td></td>
</tr>
<tr>
<td>cli</td>
<td>SpringBootCLI为SpringCloud提供SpringBoot命令行功能。 可以编写Groovy脚本来运行SpringCloud组件应用程序</td>
<td></td>
</tr>
<tr>
<td>cloudfoundry</td>
<td>Spring Cloudfoundry使在Cloud Foundry pas云服务中运行SpringCloud应用程序变得很容易</td>
<td></td>
</tr>
<tr>
<td>commons</td>
<td>服务发现、负载平衡和断路器等模式可以提供一个公共抽象层，所有Spring Cloud客户端都可以使用该而不依赖于实现</td>
<td></td>
</tr>
<tr>
<td>config</td>
<td>为分布式系统中的外部化配置提供服务器端和客户端支持</td>
<td></td>
</tr>
<tr>
<td>consul</td>
<td>为Spring Boot应用程序提供Consul集成，自动配置并绑定SpringEnvironment</td>
<td></td>
</tr>
<tr>
<td>contract</td>
<td>Spring Cloud微服务体系快速测试存根组件，不需要构建整个庞大的微服务体系，又能尽量接近生产环境，Contract可确保使用的存根由调用的服务创建。</td>
<td></td>
</tr>
<tr>
<td>function</td>
<td>Spring Cloud函数式编程的支持</td>
<td></td>
</tr>
<tr>
<td>gateway</td>
<td>在Spring生态系统之上构建的API网关，目前基于：Spring 5，SpringBoot 2和Project Reactor。</td>
<td></td>
</tr>
<tr>
<td>gcp</td>
<td>Google Cloud Platform （GCP）对谷歌云平台的支持。</td>
<td></td>
</tr>
<tr>
<td>kubernetes</td>
<td>对k8s的的支持。</td>
<td></td>
</tr>
<tr>
<td>netflix</td>
<td>提供了Netflix OSS集成，包括服务发现（Eureka），断路器（Hystrix），智能路由（Zuul）和客户端负载平衡（Ribbon）。</td>
<td></td>
</tr>
<tr>
<td>openfeign</td>
<td>为Spring Boot应用程序提供OpenFeign集成。</td>
<td></td>
</tr>
<tr>
<td>security</td>
<td>Security安全机制的支持。</td>
<td></td>
</tr>
<tr>
<td>sleuth</td>
<td>分布式跟踪解决方案：OpenZipkin Brave</td>
<td></td>
</tr>
<tr>
<td>task</td>
<td>任务调度</td>
<td></td>
</tr>
<tr>
<td>vault</td>
<td>分布式系统中的外部化配置的客户端支持</td>
<td></td>
</tr>
<tr>
<td>zookeeper</td>
<td>为Spring Boot应用程序提供Zookeeper集成</td>
<td></td>
</tr>
<tr>
<td>alibaba</td>
<td>Alibaba为分布式应用程序开发提供了一站式解决方案，包含流程控制服务降级、服务注册发现、分布式配置、事件驱动、消息总线、分布式事务、Dubbo RPC。实质对应的是：Sentinel、Nacos、RocketMQ、Seata、Dubbo组件。</td>
<td></td>
</tr>
</tbody></table>
<h2 id="SpringCloud与SpringBoot版本兼容"><a href="#SpringCloud与SpringBoot版本兼容" class="headerlink" title="SpringCloud与SpringBoot版本兼容"></a>SpringCloud与SpringBoot版本兼容</h2><p>Spring Cloud与Spring Boot的对应版本支持。所以你在使用SpringCloud的时候一定要注意 SpringBoot的版本，以免引起不兼容的问题。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/SpringCloud%E4%B8%8ESpringBoot%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9.png"></p>
<p>我们这里选择Hoxton.SR9作为学习。点开这个版本的文档，你会发现，它推荐的SpringBoot版本为2.3.5</p>
<h2 id="SpringCloud该如何学习？"><a href="#SpringCloud该如何学习？" class="headerlink" title="SpringCloud该如何学习？"></a>SpringCloud该如何学习？</h2><p>SpringCloud的体系这么庞大，结合RPC远程过程调用，它逃离不了应用代码、Stub、通信协议、通信框架几块。我们不会每一个都去学习，接下来我们将对微服务中常用的核心组件进行学习。</p>
<ul>
<li>服务注册与发现，具体集成包含∶Eureka、Zookeeper、Consul、<strong>Nacos</strong> </li>
<li>负载均衡器，集成包含∶ Ribbon、Loadbalancer </li>
<li>熔断器，集成包含∶Hystrix、Resilience4J、<strong>Sentinel</strong>、Spring Retry</li>
<li>声明式调用∶ <del>Feign</del>、OpenFeign</li>
<li>网关∶ <del>Zuul</del>、Gateway</li>
<li>配置中心∶ Config、Nacos</li>
</ul>
<h1 id="SpringCloud搭建微服务"><a href="#SpringCloud搭建微服务" class="headerlink" title="SpringCloud搭建微服务"></a>SpringCloud搭建微服务</h1><h2 id="SpringCloud父工程搭建"><a href="#SpringCloud父工程搭建" class="headerlink" title="SpringCloud父工程搭建"></a>SpringCloud父工程搭建</h2><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>SpringCloud配置文件属性列表</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud/docs/Hoxton.SR9/reference/html/configprops.html">https://docs.spring.io/spring-cloud/docs/Hoxton.SR9/reference/html/configprops.html</a></p>
<h2 id="注册中心的应用"><a href="#注册中心的应用" class="headerlink" title="注册中心的应用"></a>注册中心的应用</h2><p>SpringCloud集成的注册中心组件包含有：Eureka、Zookeeper、Consul、Nacos。</p>
<p>Eureka目前处于停更状态，还有Zookeeper、Consul、Nacos等注册中心的组件替代。</p>
<h3 id="注册中心简介"><a href="#注册中心简介" class="headerlink" title="注册中心简介"></a>注册中心简介</h3><h4 id="什么是注册中心？"><a href="#什么是注册中心？" class="headerlink" title="什么是注册中心？"></a>什么是注册中心？</h4><p>提供服务注册与发现的组件。服务注册用于服务提供者，发布自己可用的服务(ip、port等)信息，服务发现用于服务消费者，用来订阅自己感兴趣的接口方法。</p>
<h4 id="为什么需要注册中心？"><a href="#为什么需要注册中心？" class="headerlink" title="为什么需要注册中心？"></a>为什么需要注册中心？</h4><p>没有注册中心的情况下，服务消费者连接服务提供者需要配置服务提供者的信息，如果服务提供者增加删减节点，则需要重新调整服务消费者的配置信息然后重启，这在分布式、微服务架构体系中成本太大。有了服务注册中心，就能够做到在服务提供者变化的情况下，服务消费者可以不需要重启，自动实时调整服务提供者的信息。</p>
<h4 id="什么场景下会用到注册中心？"><a href="#什么场景下会用到注册中心？" class="headerlink" title="什么场景下会用到注册中心？"></a>什么场景下会用到注册中心？</h4><p>单体应用开发用不到注册中心，分布式不考虑高可用，集群容错，负载均衡，服务运维治理，也可以不需要注册中心。所以在你的项目中考虑需要建立一个高可用、容错、负载均衡、需要运维治理的大型高度自治的分布式系统，注册中心能够发挥最大的优势。</p>
<h3 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h3><p>Netflix Eureka官方文档：<a target="_blank" rel="noopener" href="https://github.com/Netflix/eureka/">https://github.com/Netflix/eureka/</a></p>
<p>Spring Netflix文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/docs/3.0.0/reference/html">https://docs.spring.io/spring-cloud-netflix/docs/3.0.0/reference/html</a></p>
<h4 id="Eureka简介"><a href="#Eureka简介" class="headerlink" title="Eureka简介"></a>Eureka简介</h4><p>Eureka属于Netflix公司提供的服务发现与注册组件，基于REST协议通信，主要用于AWS云，当然也应用在任何需要使用注册中心的场景。Eureka采用了CS的设计架构，Eureka Server作为服务注册功能的服务器，它是服务注册中心。而系统中的其他微服务，使用Eureka的客户端连接到Eureka Server并维持心跳连接。这样系统的维护人员就可以通过Eureka Server来监控系统中各个微服务是否正常运行。</p>
<h4 id="为什么要用Eureka？"><a href="#为什么要用Eureka？" class="headerlink" title="为什么要用Eureka？"></a>为什么要用Eureka？</h4><p>Eureka，与其他其他注册中心相比，最主要在于：</p>
<ol>
<li><p>基于HTTP通信，泛化通信协议</p>
</li>
<li><p>在分布式CAP理论中属于AP类，注重高可用。</p>
</li>
<li><p>由于Netflix停更了很多组件，Eureka属于其中之一，SpringCloud后期版本中也会逐步淘汰，但是目前生产环境很有很多使用Eureka的企业，碰到老的项目仍然会用到它。</p>
</li>
</ol>
<h4 id="Eureka中的几个概念"><a href="#Eureka中的几个概念" class="headerlink" title="Eureka中的几个概念"></a>Eureka中的几个概念</h4><p>在服务注册与发现中，有一个注册中心。当服务器启动的时候，会把当前自己服务器的信息（ip地址、<br>端口、服务名称）注册到注册中心上。另一方，以该别名的方式去注册中心上获取到实际的服务通信地<br>址，然后再实现本地RPC调用RPC远程调用框架核心设计思想：在于注册中心，因为使用注册中心管理<br>每个服务与服务之间的一个依赖关系（服务治理）。在任何rpc远程框架中，都会有一个注册中心（存放<br>服务接口地址相关信息）。</p>
<p>Eureka 由两个组件组成：<strong>Eureka 服务端</strong>和 <strong>Eureka 客户端</strong>。</p>
<ul>
<li>Eureka 服务端就是注册中心，用来存放服务提供者的信息，给Eureka客户端分发服务提供者信<br>息。</li>
<li>Eureka 客户端是一个 java 客户端，用来简化与Eureka服务端的交互、作为轮询负载均衡器，并提<br>供服务的故障切换支持。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/1647073822(1).jpg"></p>
<h4 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="Eureka Server"></a>Eureka Server</h4><p>提供服务注册功能。</p>
<p>每个微服务节点通过配置启动后，在EurekaServer中进行注册，这样EurekaServer中的服务注册表中将<br>会存储所有可用服务节点的信息，服务节点的信息可以在界面中查看到。</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>  <span class="comment"># 当服务想eureka注册服务时使用ip地址</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># eureka做为一个client默认情况会将自己注册到eureka上</span></span><br><span class="line">    <span class="comment"># 是否将自己注册到eureka上，这里选择false，只有客户端才需要注册和拉取</span></span><br><span class="line">    <span class="attr">registerWithEureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问页面</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8761/">http://localhost:8761/</a></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312164059.png"></p>
<p>关于Eureka的更多配置信息：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/docs/3.0.0/reference/html/appendix.html">https://docs.spring.io/spring-cloud-netflix/docs/3.0.0/reference/html/appendix.html</a></p>
<h4 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="Eureka Client"></a>Eureka Client</h4><p>Eureka Client是一个Java客户端，分为<strong>服务提供端</strong>和<strong>服务消费端</strong>两种。</p>
<h5 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h5><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>appliction.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">provider</span></span><br></pre></td></tr></table></figure>

<p>Java代码实现</p>
<p><strong>服务提供者实现</strong></p>
<p>application-provider.yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span>  </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="comment"># 如果浏览器可以通过http://localhost:8761直接访问eureka，那么需要加上/eureka后缀</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-service</span> <span class="comment"># 注册到eureka上的应用名字</span></span><br></pre></td></tr></table></figure>

<p>服务提供者代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@Profile(&quot;provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Provider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Provider.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka provider!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provider</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Goods Id : &quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Eureka的自我保护机制</strong></p>
<ul>
<li>微服务第一次注册成功之后，每30秒会发送一次心跳将服务的实例信息注册到注册中心。通知<br>Eureka</li>
<li>Server 该实例仍然存在。如果超过90秒没有发送更新，则服务器将从注册信息中将此服务移<br>Eureka Server在运行期间，会统计心跳失败的比例在15分钟之内是否低于85%，如果出现低于的<br>情况（在单机调试的时候很容易满足，实际在生产环境上通常是由于网络不稳定导致），<br>EurekaServer会将当前的实例注册信息保护起来，同时提示这个警告。保护模式主要用于一组客户<br>端和Eureka Server之间存在网络分区场景下的保护。一旦进入保护模式，Eureka Server将会尝试<br>保护其服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）</li>
<li>验证完自我保护机制开启后，并不会马上呈现到web上，而是默认需等待5分钟（可以通过<br>eureka.server.wait-time-in-ms-when-sync-empty配置），即5分钟后你会看到下面的提示信息</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312165800.png"></p>
<ul>
<li>关闭自我保护：通过设置eureka.enableSelfPreservation&#x3D;false来关闭自我保护功能</li>
</ul>
<h5 id="服务消费"><a href="#服务消费" class="headerlink" title="服务消费"></a>服务消费</h5><p><strong>消费者实现</strong></p>
<p>application-consummer.yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8021</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-consumer</span></span><br></pre></td></tr></table></figure>

<p>消费者代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.EurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Profile(&quot;consumer&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaRegistryConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaRegistryConsumer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consumer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consumer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InstanceInfo</span> <span class="variable">info</span> <span class="operator">=</span> eurekaClient.getNextServerFromEureka(<span class="string">&quot;goods-service&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> info.getHomePageUrl()+<span class="string">&quot;/goods/&quot;</span> + <span class="number">123</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">providerInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InstanceInfo</span> <span class="variable">info</span> <span class="operator">=</span> eurekaClient.getNextServerFromEureka(<span class="string">&quot;goods-service&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> info.getHomePageUrl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>试试访问：<a target="_blank" rel="noopener" href="http://localhost:8081/goods/123">http://localhost:8081/goods/123</a></p>
<h4 id="EurekaClient替代品"><a href="#EurekaClient替代品" class="headerlink" title="EurekaClient替代品"></a>EurekaClient替代品</h4><p>可以不需要使用EurekaClient，它后面会逐步替代，有两种方式替代方式。</p>
<ol>
<li><p>使用Spring Cloud的DiscoveryClient，注意不是netflix的DiscoveryClient。 </p>
</li>
<li><p>Spring Cloud 支持的Feign和带负载均衡的RestTemplate通过逻辑Eureka服务标识符(VIP)而不是物理URL。</p>
</li>
</ol>
<h5 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><ol>
<li><p><strong>遇到的异常信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.fasterxml.jackson.databind.exc.MismatchedInputException: Root name <span class="string">&#x27;timestamp&#x27;</span> does not match <span class="title function_">expected</span> <span class="params">(<span class="string">&#x27;applications&#x27;</span>)</span> <span class="keyword">for</span> type [simple type, <span class="keyword">class</span> <span class="title class_">org</span>.springframework.cloud.netflix.eureka.http.EurekaApplications]</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong></p>
<p>yml配置文件需要加上&#x2F;eureka后缀，哪怕是eureka服务的contextPath是&#x2F;eureka。</p>
<p>浏览器访问eurekaServer不需要多加&#x2F;eureka，除非你的contextPath是&#x2F;eureka。 </p>
</li>
<li><p><strong>IDEA启动Eureka集群的问题</strong></p>
</li>
</ol>
<p>   想在一个IDEA中启动三个节点的Eureka服务，<a href="#%E5%9C%A8IDEA%E4%B8%AD%E5%90%AF%E5%8A%A8%E9%9B%86%E7%BE%A4">参考集群的截图部分</a>。</p>
<ol start="3">
<li><p><strong>启动时报找不到WebServerFactoryBean</strong></p>
<p>排除内嵌web容器依赖问题，发现Tomcat依赖正常。是因为启动类上@Profile(“consummer”)缺少对应的application-consummer.yml配置文件。</p>
</li>
</ol>
<h4 id="Eureka注册中心集群原理"><a href="#Eureka注册中心集群原理" class="headerlink" title="Eureka注册中心集群原理"></a>Eureka注册中心集群原理</h4><p>互相注册，相互守望</p>
<h5 id="Eureka架构图"><a href="#Eureka架构图" class="headerlink" title="Eureka架构图"></a>Eureka架构图</h5><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312170459.png"></p>
<p>上面的体系结构描述了如何在Netflix部署Eureka。 每个区域有一个eureka集群，它只知道其区域中的实例。 每个区域至少有一个eureka服务器来处理区域故障。</p>
<p>服务在Eureka<strong>注册</strong>，然后每30秒发送一次<strong>心跳</strong>更新租约。如果客户端几次无法续签租约，则大约90秒内会将租约从服务器注册表中删除。注册信息和续订将复制到集群中的所有eureka节点。任何区域的客户端都可以查找<strong>注册表</strong>信息（每30秒发生一次）以查找其服务（可能在任何区域）并进行远程调用。</p>
<h5 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h5><p>application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/eureka</span> </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">peer1</span></span><br></pre></td></tr></table></figure>

<p>application-peer1.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer1.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer2.com:8763/eureka/,http://peer3.com:8764/eureka/</span></span><br></pre></td></tr></table></figure>

<p>application-peer2.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8763</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer2.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer1.com:8762/eureka/,http://peer3.com:8764/eureka/</span></span><br></pre></td></tr></table></figure>

<p>application-peer3.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8764</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">peer3.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://peer1.com:8762/eureka/,http://peer2.com:8763/eureka/</span></span><br></pre></td></tr></table></figure>

<h5 id="在IDEA中启动集群"><a href="#在IDEA中启动集群" class="headerlink" title="在IDEA中启动集群"></a>在IDEA中启动集群</h5><p>修改host文件，添加如下host</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 peer1.com </span><br><span class="line">127.0.0.1 peer2.com </span><br><span class="line">127.0.0.1 peer3.com</span><br></pre></td></tr></table></figure>

<p>分别使用不同的配置文件，依次启动三台Eureka服务。IDEA需要通过启动配置界面来配置active文件，Eclipse可以直接修改spring.profiles.active启动，也可以像IDEA一样来配置操作。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312171453.png"></p>
<p>配置操作</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312171524.png"></p>
<h3 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h3><p>Zookeeper官方文档：<a target="_blank" rel="noopener" href="http://zookeeper.apache.org/">http://zookeeper.apache.org</a></p>
<p>SpringCloud文档：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-zookeeper">https://spring.io/projects/spring-cloud-zookeeper</a></p>
<h4 id="Zookeeper简介"><a href="#Zookeeper简介" class="headerlink" title="Zookeeper简介"></a>Zookeeper简介</h4><p>SpringCloud中支持使用Zookeeper作为注册中心、配置中心。</p>
<h4 id="注册服务到ZK"><a href="#注册服务到ZK" class="headerlink" title="注册服务到ZK"></a>注册服务到ZK</h4><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置文件，application-provider.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8070</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">instance-host:</span> <span class="string">localhost</span></span><br></pre></td></tr></table></figure>

<p>Java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZkRegistryProvider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ZkRegistryProvider.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka provider!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/goods/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provider</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Goods Id : &quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="从ZK消费服务"><a href="#从ZK消费服务" class="headerlink" title="从ZK消费服务"></a>从ZK消费服务</h4><p>pom.xml</p>
<p>参考[注册服务到ZK的pom文件内容](# 注册服务到ZK)</p>
<p>配置文件，application-consummer.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8071</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-consummer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br></pre></td></tr></table></figure>

<p>Java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;consummer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZkRegistryConsummer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ZkRegistryConsummer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consummer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consummer</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">&quot;goods-service&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> list.get(<span class="number">0</span>).getUri().toString()+<span class="string">&quot;/goods/&quot;</span> + <span class="number">123</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分别启动服务提供者和消费者两个应用</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8072/consummer">http://localhost:8072/consummer</a></p>
<h3 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h3><p>consul官网：<a target="_blank" rel="noopener" href="https://www.consul.io/">https://www.consul.io/</a></p>
<p>SpringCloud Consul文档：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-consul">https://spring.io/projects/spring-cloud-consul</a></p>
<h4 id="Consul简介"><a href="#Consul简介" class="headerlink" title="Consul简介"></a>Consul简介</h4><p>Consul是一种网络工具，可提供功能全面的服务网格和服务发现。由HashiCorp公司用Go语言开发。</p>
<p>SpringCloud中支持通过Consul实现注册中心、配置中心、控制总线。</p>
<h4 id="为什么要用-学Consul？-未完成"><a href="#为什么要用-学Consul？-未完成" class="headerlink" title="为什么要用&#x2F;学Consul？(未完成)"></a>为什么要用&#x2F;学Consul？(未完成)</h4><h4 id="Consul中的几个概念"><a href="#Consul中的几个概念" class="headerlink" title="Consul中的几个概念"></a>Consul中的几个概念</h4><p>Consul架构图</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312200858.png"></p>
<p>Consul是一个运行在集群上的分布式系统，节点可以是物理服务器、云实例、虚拟机或容器。</p>
<h5 id="Consul集群原理及概念"><a href="#Consul集群原理及概念" class="headerlink" title="Consul集群原理及概念"></a>Consul集群原理及概念</h5><p><strong>数据中心</strong>：Consul运行的节点集连在一起称为数据中心，数据中心一般有3-5台服务器和若干客户端。在数据中心中，Consul有两种运行模式：服务器、客户端。</p>
<p><strong>服务端</strong>：是一个具有扩展职责集的代理，包括参与Raft仲裁，维护集群状态，响应RPC查询，与其他数据中心交换WAN gossip 以及将查询转发给领导者或远程数据中心。</p>
<p><strong>客户端</strong>：客户端是一个轻量级的进程，在服务运行的每个节点上运行。 它将所有RPC转发到服务器的代理。</p>
<p>Consul集群为了确保即使服务器发生故障，Consul的数据也会保留，建议在生产中运行奇数台服务器，三到五台最多不超过五台，能够在性能和容错能力之间取得平衡。说着有点像ZK了，其实consul是类似ZK原理的服务，采用RAFT算法（paxos算法变种）实现分布式下状态一致性协调。</p>
<h4 id="如何使用Consul？"><a href="#如何使用Consul？" class="headerlink" title="如何使用Consul？"></a>如何使用Consul？</h4><h5 id="安装Consul"><a href="#安装Consul" class="headerlink" title="安装Consul"></a>安装Consul</h5><p>Consul的二进制安装非常简单，三步走。</p>
<ol>
<li>访问consul<a target="_blank" rel="noopener" href="https://www.consul.io/downloads">下载地址</a>，选择对应的操作系统版本，下载对应的zip包。这里使用<a target="_blank" rel="noopener" href="https://releases.hashicorp.com/consul/1.9.2/consul_1.9.2_linux_amd64.zip">consul_1.9.2_linux_amd64.zip</a></li>
<li>选择并创建安装根目录，解压zip包 </li>
<li>将根目录加入环境变量，测试consul命令</li>
</ol>
<p>下面以centos7为示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出下载的consul zip包 </span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll</span></span><br><span class="line">总用量 40348</span><br><span class="line">-rw-r--r--. 1 root root 41313084 3月  12 20:32 consul_1.9.2_linux_amd64.zip</span><br><span class="line"><span class="comment"># 解压zip包</span></span><br><span class="line">[root@localhost ~]<span class="comment"># unzip consul_1.9.2_linux_amd64.zip </span></span><br><span class="line">Archive:  consul_1.9.2_linux_amd64.zip</span><br><span class="line">  inflating: consul </span><br><span class="line"><span class="comment"># 查看环境变量目录</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo $PATH</span></span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line"><span class="comment"># 移动consul执行文件到/usr/local/bin环境变量目录下 </span></span><br><span class="line">[root@localhost ~]<span class="comment"># sudo mv consul /usr/local/bin/</span></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">[root@localhost ~]<span class="comment"># consul</span></span><br><span class="line">Usage: consul [--version] [--<span class="built_in">help</span>] &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">Available commands are:</span><br><span class="line">    acl            Interact with Consul<span class="string">&#x27;s ACLs</span></span><br><span class="line"><span class="string">    agent          Runs a Consul agent</span></span><br><span class="line"><span class="string">    catalog        Interact with the catalog</span></span><br><span class="line"><span class="string">    config         Interact with Consul&#x27;</span>s Centralized Configurations</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="启动Consul服务代理"><a href="#启动Consul服务代理" class="headerlink" title="启动Consul服务代理"></a>启动Consul服务代理</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生产环境启动示例：consul agent -data-dir=/data/consul </span></span><br><span class="line"><span class="comment"># 切勿在生产模式下运行consul agent -dev</span></span><br><span class="line">[root@localhost ~]<span class="comment"># consul agent -dev</span></span><br><span class="line">==&gt; Starting Consul agent...</span><br><span class="line">           Version: <span class="string">&#x27;1.9.2&#x27;</span></span><br><span class="line">           Node ID: <span class="string">&#x27;8e089f38-b482-bc65-b6e9-93319f96481f&#x27;</span></span><br><span class="line">         Node name: <span class="string">&#x27;localhost.localdomain&#x27;</span></span><br><span class="line">        Datacenter: <span class="string">&#x27;dc1&#x27;</span> (Segment: <span class="string">&#x27;&lt;all&gt;&#x27;</span>)</span><br><span class="line">            Server: <span class="literal">true</span> (Bootstrap: <span class="literal">false</span>)</span><br><span class="line">       <span class="comment"># 暴露的协议及端口信息</span></span><br><span class="line">       Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600)</span><br><span class="line">      Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302)</span><br><span class="line">           Encrypt: Gossip: <span class="literal">false</span>, TLS-Outgoing: <span class="literal">false</span>, TLS-Incoming: <span class="literal">false</span>, Auto-Encrypt-TLS: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">==&gt; Log data will now stream <span class="keyword">in</span> as it occurs:</span><br><span class="line"></span><br><span class="line">    2022-03-12T20:39:38.894+0800 [WARN]  agent: Node name <span class="string">&quot;localhost.localdomain&quot;</span> will not be discoverable via DNS due to invalid characters. Valid characters include all alpha-numerics and dashes.</span><br><span class="line">    2022-03-12T20:39:38.899+0800 [WARN]  agent.auto_config: Node name <span class="string">&quot;localhost.localdomain&quot;</span> will not be discoverable via DNS due to invalid characters. Valid characters include all alpha-numerics and dashes.</span><br><span class="line">    2022-03-12T20:39:38.901+0800 [INFO]  agent.server.raft: initial configuration: index=1 servers=<span class="string">&quot;[&#123;Suffrage:Voter ID:8e089f38-b482-bc65-b6e9-93319f96481f Address:127.0.0.1:8300&#125;]&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.902+0800 [INFO]  agent.server.serf.wan: serf: EventMemberJoin: localhost.localdomain.dc1 127.0.0.1</span><br><span class="line">    2022-03-12T20:39:38.903+0800 [INFO]  agent.server.serf.lan: serf: EventMemberJoin: localhost.localdomain 127.0.0.1</span><br><span class="line">    2022-03-12T20:39:38.903+0800 [INFO]  agent.router: Initializing LAN area manager</span><br><span class="line">    2022-03-12T20:39:38.905+0800 [INFO]  agent: Started DNS server: address=127.0.0.1:8600 network=udp</span><br><span class="line">    2022-03-12T20:39:38.905+0800 [INFO]  agent.server.raft: entering follower state: follower=<span class="string">&quot;Node at 127.0.0.1:8300 [Follower]&quot;</span> leader=</span><br><span class="line">    2022-03-12T20:39:38.906+0800 [INFO]  agent.server: Adding LAN server: server=<span class="string">&quot;localhost.localdomain (Addr: tcp/127.0.0.1:8300) (DC: dc1)&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.906+0800 [INFO]  agent.server: Handled event <span class="keyword">for</span> server <span class="keyword">in</span> area: event=member-join server=localhost.localdomain.dc1 area=wan</span><br><span class="line">    2022-03-12T20:39:38.906+0800 [INFO]  agent: Started DNS server: address=127.0.0.1:8600 network=tcp</span><br><span class="line">    2022-03-12T20:39:38.907+0800 [INFO]  agent: Starting server: address=127.0.0.1:8500 network=tcp protocol=http</span><br><span class="line">    2022-03-12T20:39:38.907+0800 [WARN]  agent: DEPRECATED Backwards compatibility with pre-1.9 metrics enabled. These metrics will be removed <span class="keyword">in</span> a future version of Consul. Set `telemetry &#123; disable_compat_1.9 = <span class="literal">true</span> &#125;` to <span class="built_in">disable</span> them.</span><br><span class="line">    2022-03-12T20:39:38.907+0800 [INFO]  agent: started state syncer</span><br><span class="line">==&gt; Consul agent running!</span><br><span class="line">    2022-03-12T20:39:38.907+0800 [INFO]  agent: Started gRPC server: address=127.0.0.1:8502 network=tcp</span><br><span class="line">    <span class="comment"># raft，一看到了大多数协议的算法了，集群配置奇数个节点不奇怪了</span></span><br><span class="line">    2022-03-12T20:39:38.981+0800 [WARN]  agent.server.raft: heartbeat <span class="built_in">timeout</span> reached, starting election: last-leader=</span><br><span class="line">    2022-03-12T20:39:38.982+0800 [INFO]  agent.server.raft: entering candidate state: node=<span class="string">&quot;Node at 127.0.0.1:8300 [Candidate]&quot;</span> term=2</span><br><span class="line">    2022-03-12T20:39:38.982+0800 [DEBUG] agent.server.raft: votes: needed=1</span><br><span class="line">    2022-03-12T20:39:38.982+0800 [DEBUG] agent.server.raft: vote granted: from=8e089f38-b482-bc65-b6e9-93319f96481f term=2 tally=1</span><br><span class="line">    2022-03-12T20:39:38.982+0800 [INFO]  agent.server.raft: election won: tally=1</span><br><span class="line">    <span class="comment"># 成为一个leader</span></span><br><span class="line">    2022-03-12T20:39:38.982+0800 [INFO]  agent.server.raft: entering leader state: leader=<span class="string">&quot;Node at 127.0.0.1:8300 [Leader]&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.982+0800 [INFO]  agent.server: cluster leadership acquired</span><br><span class="line">    2022-03-12T20:39:38.982+0800 [DEBUG] agent.server: Cannot upgrade to new ACLs: leaderMode=0 mode=0 found=<span class="literal">true</span> leader=127.0.0.1:8300</span><br><span class="line">    2022-03-12T20:39:38.983+0800 [INFO]  agent.server: New leader elected: payload=localhost.localdomain</span><br><span class="line">    2022-03-12T20:39:38.984+0800 [INFO]  agent.leader: started routine: routine=<span class="string">&quot;federation state anti-entropy&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.984+0800 [INFO]  agent.leader: started routine: routine=<span class="string">&quot;federation state pruning&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.984+0800 [DEBUG] connect.ca.consul: consul CA provider configured: <span class="built_in">id</span>=07:80:c8:de:f6:41:86:29:8f:9c:b8:17:d6:48:c2:d5:c5:5c:7f:0c:03:f7:cf:97:5a:a7:c1:68:aa:23:ae:81 is_primary=<span class="literal">true</span></span><br><span class="line">    2022-03-12T20:39:38.991+0800 [INFO]  agent.server.connect: initialized primary datacenter CA with provider: provider=consul</span><br><span class="line">    2022-03-12T20:39:38.991+0800 [INFO]  agent.leader: started routine: routine=<span class="string">&quot;intermediate cert renew watch&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.991+0800 [INFO]  agent.leader: started routine: routine=<span class="string">&quot;CA root pruning&quot;</span></span><br><span class="line">    2022-03-12T20:39:38.991+0800 [DEBUG] agent.server: successfully established leadership: duration=8.678251ms</span><br><span class="line">    2022-03-12T20:39:38.991+0800 [INFO]  agent.server: member joined, marking health alive: member=localhost.localdomain</span><br><span class="line">    <span class="comment"># consul启动状态的日志信息</span></span><br><span class="line">    2022-03-12T20:39:38.992+0800 [DEBUG] agent.server.autopilot: autopilot is now running</span><br><span class="line">    2022-03-12T20:39:38.992+0800 [DEBUG] agent.server.autopilot: state update routine is now running</span><br><span class="line">    2022-03-12T20:39:38.992+0800 [INFO]  agent.server: federation state anti-entropy synced</span><br><span class="line">    2022-03-12T20:39:39.074+0800 [DEBUG] agent: Skipping remote check since it is managed automatically: check=serfHealth</span><br><span class="line">    2022-03-12T20:39:39.075+0800 [INFO]  agent: Synced node info</span><br><span class="line">    2022-03-12T20:39:39.075+0800 [DEBUG] agent: Node info <span class="keyword">in</span> <span class="built_in">sync</span></span><br><span class="line">    2022-03-12T20:39:40.519+0800 [DEBUG] agent: Skipping remote check since it is managed automatically: check=serfHealth</span><br><span class="line">    2022-03-12T20:39:40.519+0800 [DEBUG] agent: Node info <span class="keyword">in</span> <span class="built_in">sync</span></span><br></pre></td></tr></table></figure>



<h5 id="操作Consul"><a href="#操作Consul" class="headerlink" title="操作Consul"></a>操作Consul</h5><p>查询数据中心成员信息</p>
<p>另起一个新的命令窗口，输入下面命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># consul members</span></span><br><span class="line">Node                   Address         Status  Type    Build  Protocol  DC   Segment</span><br><span class="line">localhost.localdomain  127.0.0.1:8301  alive   server  1.9.2  2         dc1  &lt;all&gt;</span><br></pre></td></tr></table></figure>

<p>停止服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# consul leave</span><br><span class="line">Graceful leave complete</span><br></pre></td></tr></table></figure>

<h4 id="注册服务到Consul"><a href="#注册服务到Consul" class="headerlink" title="注册服务到Consul"></a>注册服务到Consul</h4><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8075</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br></pre></td></tr></table></figure>

<p>Java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;provider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsulRegistryProvider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsulRegistryProvider.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka provider!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/goods/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">provider</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Goods Id : &quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="从Consul消费服务"><a href="#从Consul消费服务" class="headerlink" title="从Consul消费服务"></a>从Consul消费服务</h4><p>pom.xml，<a href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E5%88%B0Consul">参考consul注册服务</a></p>
<p>yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8074</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-consummer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br></pre></td></tr></table></figure>

<p>Java代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;consummer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsulRegistryConsummer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsulRegistryConsummer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consummer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consummer</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">&quot;goods-service&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> list.get(<span class="number">0</span>).getUri().toString()+<span class="string">&quot;/goods/&quot;</span> + <span class="number">123</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a target="_blank" rel="noopener" href="http://localhost:8074/consummer">http://localhost:8074/consummer</a></p>
<h3 id="注册中心组件总结"><a href="#注册中心组件总结" class="headerlink" title="注册中心组件总结"></a>注册中心组件总结</h3><table>
<thead>
<tr>
<th>注册中心组件</th>
<th>开发语言</th>
<th>CAP</th>
<th>服务监控检查</th>
<th>保录协议</th>
<th>使用难易度</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配置</td>
<td>HTTP</td>
<td>嵌入式SDK实现注册发现</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>TCP</td>
<td>需要开发客户端</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>支持</td>
<td>HTTP&#x2F;DNS</td>
<td>无需开发，直接使用</td>
</tr>
</tbody></table>
<h2 id="负载均衡器的基本搭建配置"><a href="#负载均衡器的基本搭建配置" class="headerlink" title="负载均衡器的基本搭建配置"></a>负载均衡器的基本搭建配置</h2><h3 id="负载均衡器简介"><a href="#负载均衡器简介" class="headerlink" title="负载均衡器简介"></a>负载均衡器简介</h3><h4 id="什么是负载均衡器？"><a href="#什么是负载均衡器？" class="headerlink" title="什么是负载均衡器？"></a>什么是负载均衡器？</h4><p>是一个提供从多个资源中选择一个资源算法组件。客户端即服务消费者，通过注册中心获得多个服务提供者的信息以后，可以通过负载均衡器从中选择一个服务提供者，来发送请求。</p>
<h4 id="为什么需要负载均衡器？"><a href="#为什么需要负载均衡器？" class="headerlink" title="为什么需要负载均衡器？"></a>为什么需要负载均衡器？</h4><p>在分布式微服务体系中，服务提供者（集群）每台服务器承载压力的能力不一样，我们想尽量让每台服务器都能够充分发挥自己的能力，如何将请求均发给他们，做到充分发挥自己的能力，做到人尽其才、物尽其用的目的。</p>
<h4 id="什么时候会需要负载均衡？"><a href="#什么时候会需要负载均衡？" class="headerlink" title="什么时候会需要负载均衡？"></a>什么时候会需要负载均衡？</h4><p>当上游服务一台机器不能满足要求，需要将请求均匀分发给集群中的其他机器，分摊请求压力，负载均衡器。</p>
<h4 id="SpringCloud中的负载均衡器"><a href="#SpringCloud中的负载均衡器" class="headerlink" title="SpringCloud中的负载均衡器"></a>SpringCloud中的负载均衡器</h4><p>SpringCloud集成的负载均衡器有：Ribbon、Loadbalancer</p>
<h3 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h3><h4 id="Ribbon简介"><a href="#Ribbon简介" class="headerlink" title="Ribbon简介"></a>Ribbon简介</h4><p>Netflix官方文档：<a target="_blank" rel="noopener" href="https://github.com/Netflix/Ribbon">https://github.com/Netflix/Ribbon</a><br>SpringCloud Ribbon文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/docs/2.2.6.RELEASE/reference/html/#spring-cloud-ribbon">https://docs.spring.io/spring-cloud-netflix/docs/2.2.6.RELEASE/reference/html/#spring-cloud-ribbon</a></p>
<p>Ribbon是一个客户端负载均衡器，提供了许多特性，用来控制HTTP和TCP协议的客户端，Feign中已经集成使用了Ribbon。</p>
<p>Ribbon是一个内置软件负载均衡器的进程间通信（远程过程调用）库。 主要的使用模型REST调用，并支持各种序列化方案。</p>
<h4 id="为什么要学Ribbon？"><a href="#为什么要学Ribbon？" class="headerlink" title="为什么要学Ribbon？"></a>为什么要学Ribbon？</h4><p>Ribbon处于停更委会状态，但是现在生产环境中仍然有使用，如果要结合SpringCloud Eureka的使用，建议使用Hoxton版本的Spring Cloud。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312211109.png"></p>
<p>在SpringCloud 2020.0.0版本Ribbon已经被SpringCloud自身的LoadBalancer替代。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312211142.png"></p>
<h4 id="Ribbon中的概念"><a href="#Ribbon中的概念" class="headerlink" title="Ribbon中的概念"></a>Ribbon中的概念</h4><p><strong>IClientConfig</strong>，客户端配置文件的编程接口</p>
<p><strong>IRule</strong>，负载均衡算法规则接口，用来确定从列表返回哪个服务器的逻辑</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312211233.png"></p>
<ol>
<li><p>StickyRule，粘滞，同一个Key每次使用相同的服务实例。</p>
</li>
<li><p>RoundRobinRule，轮询，默认使用该规则。</p>
</li>
<li><p>RetryRule，重试</p>
</li>
<li><p>RandomRule，随机</p>
</li>
<li><p>ZoneAvoidanceRule，SpringCloud默认使用该规则，基于轮询，复合判断server所在区域的性能和server的可用性来选择服务。</p>
</li>
<li><p>BestAvailableRule，过滤掉多次访问故障而处于跳闸状态的服务，选择并发量最小的服务。</p>
</li>
<li><p>AvailabilityFilteringRule<br>可用性过滤策略，默认一个服务三次不能建立连接则跳闸，30秒后再次开放。再次开放，立马又跳闸了，则会成倍的增加时间。</p>
</li>
<li><p>WeightedResponseTimeRule<br> 随机响应时间加权策略。随机选择服务器，被随机的概率由权重来决定。根据每个服务器的平均响应时间为其分配权重，响应时间越长权重越少。<br> 要启用WeightedResponseTimeRule，请通过API使用负载均衡器进行设置或设置以下属性</p>
</li>
</ol>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NFLoadBalancerRuleClassName</span>=<span class="string">com.netflix.loadbalancer .WeightedResponseTimeRule</span></span><br></pre></td></tr></table></figure>

<p><strong>IPing</strong>，在后台运行以确保服务器活动的心跳接口</p>
<p><strong>ServerList</strong>，服务器列表，可以是静态的也可以是动态的，动态的，则后台线程将按一定间隔刷新并过滤列表。</p>
<p><strong>ILoadBalancer</strong>，负载均衡器的接口，目前有。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20220312212103.png"></p>
<p><strong>ServerListFilter</strong>，用在动态服务列表中过滤服务器的组件，有两个实现：<br>ZoneAffinityServerListFilter、ServerListSubsetFilter。 </p>
<ol>
<li>ZoneAffinityServerListFilter，筛选出与客户端不在同一区域中的服务器，除非客户端区域中没有可用的服务器。</li>
</ol>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用ZoneAffinityServerListFilter </span></span><br><span class="line"><span class="attr">myclient.ribbon.EnableZoneAffinity</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ServerListSubsetFilter，筛选确保客户端仅看到由ServerList实现返回的全部服务器的固定子集。</li>
</ol>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用ServerListSubsetFilter </span></span><br><span class="line"><span class="attr">myClient.ribbon.NIWSServerListClassName</span>=<span class="string">com.netflix.niws.loadbalancer.Discov eryEnabledNIWSServerList </span></span><br><span class="line"><span class="comment"># 当前服务必须在Eureka服务器上，使用&quot;myservice&quot;虚拟地址注册自己 </span></span><br><span class="line"><span class="attr">myClient.ribbon.DeploymentContextBasedVipAddresses</span>=<span class="string">myservice </span></span><br><span class="line"><span class="attr">myClient.ribbon.NIWSServerListFilterClassName</span>=<span class="string">com.netflix.loadbalancer.Serve rListSubsetFilter </span></span><br><span class="line"><span class="comment"># 只显示客户端5台服务器，默认20. </span></span><br><span class="line"><span class="attr">myClient.ribbon.ServerListSubsetFilter.size</span>=<span class="string">5</span></span><br></pre></td></tr></table></figure>

<p><strong>RetryHandler</strong>，重试逻辑处理器。</p>
<p><strong>RestClient</strong>，Http协议客户端。</p>
<p><strong>属性配置</strong></p>
<p>这些组件行为可以通过Netflix的Archaius在运行时更改</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NFLoadBalancerClassName</span>=<span class="string">xxx </span></span><br><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NFLoadBalancerRuleClassName</span>=<span class="string">xxx </span></span><br><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NFLoadBalancerPingClassName</span>=<span class="string">xxx </span></span><br><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NIWSServerListClassName</span>=<span class="string">xxx </span></span><br><span class="line"><span class="attr">&lt;clientName&gt;.&lt;clientConfigNameSpace&gt;.NIWSServerListFilterClassName</span>=<span class="string">xxx</span></span><br></pre></td></tr></table></figure>

<h4 id="如何使用Ribbon"><a href="#如何使用Ribbon" class="headerlink" title="如何使用Ribbon"></a>如何使用Ribbon</h4><p>Ribbon的wiki入门：<a target="_blank" rel="noopener" href="https://github.com/Netflix/ribbon/wiki/Getting-Started">https://github.com/Netflix/ribbon/wiki/Getting-Started</a></p>
<p>Ribbon的wiki：<a target="_blank" rel="noopener" href="https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers">https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers</a></p>
<h4 id="SpringCloud中使用Ribbon"><a href="#SpringCloud中使用Ribbon" class="headerlink" title="SpringCloud中使用Ribbon"></a>SpringCloud中使用Ribbon</h4><h5 id="配置Ribbon"><a href="#配置Ribbon" class="headerlink" title="配置Ribbon"></a>配置Ribbon</h5><p>SpringCloud中的默认配置：org.springframework.cloud.netflix.ribbon.RibbonClientConfiguration包含了Ribbon客户端需要的属性准备，包含ILoadBalancer、RestClient、ServerListFilter等信息的创建和准备。查看RibbonClientConfiguration的源代码即可。</p>
<h5 id="使用默认配置"><a href="#使用默认配置" class="headerlink" title="使用默认配置"></a>使用默认配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.EurekaClient;</span><br><span class="line"><span class="keyword">import</span> edu.dongnao.cloud.ribbonconf.GoodsServiceLoadbalancerConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.ribbon.RibbonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;ribbon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RibbonLoadBalanceConsummer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GOODS_SERVICE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://goods-service&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RibbonLoadBalanceConsummer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一种方式，直接使用Netflix的EurekaClient</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line">    <span class="comment">// 第二种方式，使用SpringCloud的LoadBalancerClient，脱离Netflix</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第三种方式，使用带@LoadBalanced注解的restTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consummer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consummer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InstanceInfo</span> <span class="variable">info</span> <span class="operator">=</span> eurekaClient.getNextServerFromEureka(<span class="string">&quot;goods-service&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>+info.getVIPAddress()+<span class="string">&quot;/server/info&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadbalancer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadbalancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(<span class="string">&quot;goods-service&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> instance.getUri().toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">providerInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(GOODS_SERVICE_URL +<span class="string">&quot;/server/info&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过浏览器验证，你会发现：</p>
<p>&#x2F;consummer、&#x2F;loadbalancer、&#x2F;provider&#x2F;info，都具有了负载均衡的效果了</p>
<h5 id="Ribbon结合eureka使用"><a href="#Ribbon结合eureka使用" class="headerlink" title="Ribbon结合eureka使用"></a>Ribbon结合eureka使用</h5><ul>
<li>ribbonServerList会被覆盖为DiscoveryEnabledNIWSServerList，通过Eureka填充服务列表。</li>
<li>IPing委托给Eureka NIWSDiscoveryPing来确定服务器是否启动</li>
</ul>
<p>不仅仅上面两个，还有很多默认实现都是绑定了AWS，所以需要进行重新实现。</p>
<h5 id="改变默认全局配置"><a href="#改变默认全局配置" class="headerlink" title="改变默认全局配置"></a>改变默认全局配置</h5><p>新增一个配置类CustomConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.IPing;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.IRule;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.PingUrl;</span><br><span class="line"><span class="keyword">import</span> com.netflix.loadbalancer.RandomRule;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.ribbon.ZonePreferenceServerListFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义Ribbon客户端配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IRule <span class="title function_">ribbonRule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ZonePreferenceServerListFilter <span class="title function_">serverListFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ZonePreferenceServerListFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZonePreferenceServerListFilter</span>();</span><br><span class="line">        filter.setZone(<span class="string">&quot;myTestZone&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IPing <span class="title function_">ribbonPing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PingUrl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对应的类中引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RibbonClients(defaultConfiguration = CustomConfig.class)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RibbonLoadBalanceConsummer</span> &#123; </span><br><span class="line">    <span class="comment">//... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>或者</strong><br>将CustomConfig类放在@ComponentScan能够扫描到的目录下</p>
<p><strong>针对某类接口自定义RibbonClient</strong></p>
<p>如果想要单独配置某个接口的轮询规则。</p>
<ol>
<li>CustomConfig必须放到@ComponentScan扫描不到的包，否则这个配置会被所有的引用，即@RibbonClients注解的效果。</li>
<li>@RibbonClient中指定name为对应接口的VIP名称</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.EurekaClient;</span><br><span class="line"><span class="keyword">import</span> edu.dongnao.cloud.ribbonconf.GoodsServiceLoadbalancerConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.ribbon.RibbonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;ribbon&quot;)</span></span><br><span class="line"><span class="comment">// name必须为VIPAdress，否则对应接口不能起作用，比如这里的goods-service</span></span><br><span class="line"><span class="meta">@RibbonClient(name=&quot;goods-service&quot;, configuration = GoodsServiceLoadbalancerConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RibbonLoadBalanceConsummer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GOODS_SERVICE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://goods-service&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RibbonLoadBalanceConsummer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一种方式，直接使用Netflix的EurekaClient</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line">    <span class="comment">// 第二种方式，使用SpringCloud的LoadBalancerClient，脱离Netflix</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第三种方式，使用带@LoadBalanced注解的restTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consummer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consummer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InstanceInfo</span> <span class="variable">info</span> <span class="operator">=</span> eurekaClient.getNextServerFromEureka(<span class="string">&quot;goods-service&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>+info.getVIPAddress()+<span class="string">&quot;/server/info&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadbalancer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">loadbalancer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(<span class="string">&quot;goods-service&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> instance.getUri().toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">providerInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(GOODS_SERVICE_URL +<span class="string">&quot;/server/info&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Cloud-Loadbalancer"><a href="#Spring-Cloud-Loadbalancer" class="headerlink" title="Spring Cloud Loadbalancer"></a>Spring Cloud Loadbalancer</h3><p><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/spring-cloud-loadbalancer/">https://spring.io/guides/gs/spring-cloud-loadbalancer/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-guides/gs-spring-cloud-loadbalancer">https://github.com/spring-guides/gs-spring-cloud-loadbalancer</a></p>
<h4 id="Loadbalancer简介"><a href="#Loadbalancer简介" class="headerlink" title="Loadbalancer简介"></a>Loadbalancer简介</h4><p>用来替换Ribbon的Spring Cloud客户端负载均衡器。</p>
<h4 id="为什么要学Loadbalancer？"><a href="#为什么要学Loadbalancer？" class="headerlink" title="为什么要学Loadbalancer？"></a>为什么要学Loadbalancer？</h4><p>Ribbon将逐步淘汰，Loadbalancer会比替代。</p>
<h4 id="如何使用Loadbalancer？"><a href="#如何使用Loadbalancer？" class="headerlink" title="如何使用Loadbalancer？"></a>如何使用Loadbalancer？</h4><h5 id="pom-xml配置"><a href="#pom-xml配置" class="headerlink" title="pom.xml配置"></a>pom.xml配置</h5><p>在spring-cloud-starter-netflix-eureka-client中已经集成了loadbanlcer</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="application-loadbalancer-yml配置"><a href="#application-loadbalancer-yml配置" class="headerlink" title="application-loadbalancer.yml配置"></a>application-loadbalancer.yml配置</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8084</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8761/eureka</span></span><br><span class="line">      <span class="comment">#eureka集群</span></span><br><span class="line">      <span class="comment">#defaultZone: http://peer1.com:8762/eureka/,http://peer2.com:8763/eureka/,http://peer3.com:8764/eureka/</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">goods-loadbalancer-consummer</span></span><br></pre></td></tr></table></figure>

<h5 id="Java代码"><a href="#Java代码" class="headerlink" title="Java代码"></a>Java代码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.EurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Profile(&quot;loadbalancer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalanceConsummer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ORDER_SERVICE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://GOODS-SERVICE&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(LoadBalanceConsummer.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用eurekaClient也能使用Loadbalancer</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 带上负载均衡的RestTemplate</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">bean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to eureka consummer!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consummer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">consummer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 带有负载均衡的eurekaClient</span></span><br><span class="line">        <span class="type">InstanceInfo</span> <span class="variable">info</span> <span class="operator">=</span> eurekaClient.getNextServerFromEureka(<span class="string">&quot;goods-service&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> info.getHomePageUrl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 带有负载均衡效果的restTemplate</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/provider/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">providerInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Eureka服务标识符(VIP) ORDER_SERVICE_URL 访问服务</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(ORDER_SERVICE_URL+<span class="string">&quot;/server/info&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="熔断器基本配置搭建"><a href="#熔断器基本配置搭建" class="headerlink" title="熔断器基本配置搭建"></a>熔断器基本配置搭建</h2><h2 id="SpringCloud快速搭建微服务"><a href="#SpringCloud快速搭建微服务" class="headerlink" title="SpringCloud快速搭建微服务"></a>SpringCloud快速搭建微服务</h2><p>先从服务注册与发现开始</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717165155.png"></p>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/chengchen901/springcloud-study-Hoxton.SR9.git">https://github.com/chengchen901/springcloud-study-Hoxton.SR9.git</a></p>
<h2 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h2><p>SpringCloud中支持的可用注册中心有很多，Eureka虽然处于停更状态，但是生产环境有大量的企业在用。</p>
<p>Eureka属于Netflix公司提供的服务发 现与注册组件，基于REST协议通信。 采用了CS的设计架构，Eureka Server 作为服务注册功能的服务器，它是服务 注册中心。而系统中的其他微服务，使 用Eureka的客户端连接到Eureka Server并维持心跳连接。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717170018.png"></p>
<h2 id="负载均衡器"><a href="#负载均衡器" class="headerlink" title="负载均衡器"></a>负载均衡器</h2><p>Ribbon是一个客户端负载均衡器，提供了许多特性，用来控制HTTP和TCP协议的客户端，Feign中已经集成使用了Ribbon。</p>
<p>SpringCloud中使用Ribbon：</p>
<ul>
<li>依赖</li>
<li>配置</li>
<li>代码实现</li>
<li>验证测试</li>
</ul>
<p>Ribbon中的几个概念∶</p>
<ul>
<li> 客户端配置</li>
<li>负载均衡算法规则</li>
<li>心跳ping</li>
<li>服务器列表</li>
<li>负载均衡器</li>
</ul>
<h2 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a>熔断器</h2><p>Hystrix是一个延迟和容错库，设计用于隔离对远程系统、服务和第三方库的访问点，停止级联故障，并在故障不可避免的复杂分布式系统中复服务能力。  </p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717170455.png" alt="Hystri整体工作流程图"></p>
<h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><p>OpenFeign是一个声明式Web服务客户端，使得HTTP URL资源的访问类似接口方法的调用。</p>
<p>OpenFeign提供的特性如下图：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717201717.png"></p>
<h2 id="服务网关"><a href="#服务网关" class="headerlink" title="服务网关"></a>服务网关</h2><p>Gateway是一个在Spring生态系统之上构建的API网关，包括∶ Spring 5，Spring Boot 2和Project Reactor。 Gateway设计为提供一种简单而有效的方法来路由到API，并为提供跨领域的关注点，例如∶安全性，监视&#x2F;性能指标和弹性。  </p>
<p>Gateway中的核心概念∶</p>
<ul>
<li>路由 Route∶网关的基本构建块。它由ID，目标URI，谓词集合和过滤器集合定义。如果结合断言为true， 则匹配路由。</li>
<li>断言 Predicate∶ 本质就是Java8中的函数式编程接口Predicate，输入类型为Spring框架中的ServerWebExchange。可以用来匹配来自HTTP请求的任何内容，例如头或参数。</li>
<li>过滤器 Filter∶ 都是GatewayFiter接口的实例，是用一个特定的工厂建造的。在Filter中，可以在发送下游请求之前或之后修改请求和响应。</li>
</ul>
<p><strong>gateway的工作流程</strong></p>
<p> 1. 客户端向Spring Cloud Gateway发出请求。<br>  2. 如果网关处理程序映射确定请求与路由匹配，则将其发送到网关Web 处理程序。网关Web程序通过特定于请求的过滤器链运行请求。过滤 器由虚线分隔的原因是，过滤器可以在发送代理请求之前和之后运行逻辑。 <br>  3. 发出代理请求前，过滤器前置逻辑都被执行，发出代理请求后，会运 行过滤器后置逻辑。  </p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717202150.png"></p>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><p>Config为分布式系统中的外部化配置提供服务器端和客户端支持。可以在Config Server中心位置管理所有环境中应用程序的外部属性，通过Config Client拉取解读配置。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210717202413.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong>微服务概述</strong></p>
<p>     理解什么是微服务、微服务的九大特征 </p>
<p><strong>认识SpringCloud</strong> </p>
<p>​	SpringBoot构建微服务、SpringCloud生态圈及核心组件 </p>
<p><strong>SpringCloud核心组件</strong> </p>
<p>​	快速搭建微服务，微服务的常用核心组件</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/04-SpringCloud/01-SpringCloud%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="clmcxecx60087u8wa0774hi7k" data-title="SpringCloud入门（一）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-02-Spring/16-Spring面试总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/02-Spring/16-Spring%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/02-Spring/16-Spring%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">Spring面试总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring面试汇总"><a href="#Spring面试汇总" class="headerlink" title="Spring面试汇总"></a>Spring面试汇总</h1><h2 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h2><p>Spring 5 于 2017 年 9 月发布了通用版本 (GA)，它标志着自 2013 年 12 月以来第一个主要SpringFramework 版本。它提供了一些人们期待已久的改进，还采用了一种全新的编程范例，以反应式描述中陈述的反应式原则为基础。 这个版本是很长时间以来最令人激动的 Spring Framework 版本。Spring 5兼容 Java™8 和 JDK 9，它集成了反应式流，以方便后续提供一种颠覆性方法来实现端点和 Web 应用程序开发。</p>
<p>当然，反应式编程不仅是此版本的主题，还是令许多程序员激动不已的重大特性。人们对能够针对负载波动进行无缝扩展的容灾和响应式服务的需求在不断增加，Spring 5 很好地满足了这一需求。</p>
<p>我们将介绍 Java SE 8 和 Java EE 7 API 升级的基本内容、Spring 5 的新反应式编程模型、对 HTTP&#x2F;2支持，以及 Spring 通过 Kotlin 对函数式编程的全面支持。我还会简要介绍测试和性能增强，最后介绍对Spring 核心和容器的一般性修订。</p>
<h3 id="升级到-Java-SE-8-和-Java-EE-7"><a href="#升级到-Java-SE-8-和-Java-EE-7" class="headerlink" title="升级到 Java SE 8 和 Java EE 7"></a>升级到 Java SE 8 和 Java EE 7</h3><p>以前的 Spring Framework 中一直在支持一些弃用的 Java 版本，而 Spring 5 已从旧包袱中解放出来。为了充分利用 Java 8 特性，它的代码库已进行了改进，而且该框架要求将 Java 8 作为最低的 JDK版本。</p>
<p>Spring 5 在类路径（和模块路径）上完全兼容 Java 9，而且它通过了 JDK 9 测试套件的测试。对 Java9爱好者而言，这是一条好消息，因为在 Java 9 发布后，Spring 能立即使用它。</p>
<p>在 API 级别上，Spring 5 兼容 Java EE 8 技术，满足对 Servlet 4.0、Bean Validation 2.0 和全新的JSON Binding API 的需求。对 Java EE API 的最低要求为 V7，该版本引入了针对 Servlet、JPA和 Bean Validation API 的次要版本。</p>
<h3 id="反应式编程模型"><a href="#反应式编程模型" class="headerlink" title="反应式编程模型"></a>反应式编程模型</h3><p>Spring 5 最令人兴奋的新特性是它的反应式编程模型。Spring 5 Framework 基于一种反应式基础而构建，而且是完全异步和非阻塞的。只需少量的线程，新的事件循环执行模型就可以垂直扩展。 该框架采用反应式流来提供在反应式组件中传播负压的机制。负压是一个确保来自多个生产者的数据不会让使用者不堪重负的概念。 Spring WebFlux 是 Spring 5 的反应式核心，它为开发人员提供了两种为 SpringWeb 编程而设计的编程模型：一种基于注解的模型和 Functional Web Framework (WebFlux.fn)。 基于注解的模型是 Spring WebMVC 的现代替代方案，该模型基于反应式基础而构建，而 Functional WebFramework 是基于 @Controller 注解的编程模型的替代方案。这些模型都通过同一种反应式基础来运行，后者调整非阻塞 HTTP 来适应反应式流 API。</p>
<h3 id="使用注解进行编程"><a href="#使用注解进行编程" class="headerlink" title="使用注解进行编程"></a>使用注解进行编程</h3><p>Web MVC 程序员应该对 Spring 5 的基于注解的编程模型非常熟悉。Spring 5 调整了 Web MVC的@Controller 编程模型，采用了相同的注解。</p>
<p>在下面的代码中 BookController 类提供了两个方法，分别响应针对某个图书列表的 HTTP 请求，以及针对具有给定 id 的图书的 HTTP 请求。请注意 resource 方法返回的对象（Mono 和 Flux）。这些对象是实现反应式流规范中的 Publisher 接口的反应式类型。它们的职责是处理数据流。Mono 对象处理一个仅含 1 个元素的流，而 Flux 表示一个包含 N 个元素的流。</p>
<p>反应式控制器</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111314.png"></p>
<p>这是针对 Spring Web 编程的注解。现在我们使用函数式 Web 框架来解决同一个问题。</p>
<h3 id="支持函数式编程"><a href="#支持函数式编程" class="headerlink" title="支持函数式编程"></a>支持函数式编程</h3><p>Spring 5 的新函数式方法将请求委托给处理函数，这些函数接受一个服务器请求实例并返回一种反应式类型。来看一段代码，创建 BookHandler 类，其中 listBook() 和 getBook() 方法相当于 Controller中的功能。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111405.png"></p>
<p>通过路由函数来匹配 HTTP 请求参数与媒体类型，将客户端请求路由到处理函数。下面的代码展示了图书资源端点 URI 将调用委托给合适的处理函数：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111434.png"></p>
<p>这些示例背后的数据存储库也支持完整的反应式体验，该体验是通过 Spring Data 对反应式Couchbase、Reactive MongoDB 和 Cassandra 的支持来实现的。</p>
<h3 id="使用-REST-端点执行反应式编程"><a href="#使用-REST-端点执行反应式编程" class="headerlink" title="使用 REST 端点执行反应式编程"></a>使用 REST 端点执行反应式编程</h3><p>新的编程模型脱离了传统的 Spring WebMVC 模型，引入了一些很不错的新特性。 举例来说，WebFlux模块为 RestTemplate 提供了一种完全非阻塞、反应式的替代方案，名为 WebClient。下面创建一个WebClient，并调用 books 端点来请求一本给定 id 为 1234 的图书。 通过 WebClient 调用 REST 端点</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111523.png"></p>
<h3 id="对-HTTP-2-支持"><a href="#对-HTTP-2-支持" class="headerlink" title="对 HTTP&#x2F;2 支持"></a>对 HTTP&#x2F;2 支持</h3><p>HTTP&#x2F;2 幕后原理：要了解 HTTP&#x2F;2 如何提高传输性能，减少延迟，并帮助提高应用程序吞吐量，从而提供经过改进的丰富 Web 体验。</p>
<p>Spring Framework 5.0 提供专门的 HTTP&#x2F;2 特性支持，还支持人们期望出现在 JDK 9 中的新 HTTP客户端。尽管 HTTP&#x2F;2 的服务器推送功能已通过 Jetty Servlet 引擎的 ServerPushFilter 类向Spring 开发人员公开了很长一段时间，但如果发现 Spring 5 中开箱即用地提供了 HTTP&#x2F;2 性能增强，Web 优化者们一定会为此欢呼雀跃。 Servlet 4.0 支持在 Spring 5.1 中提供。到那时，HTTP&#x2F;2 新特性将由 Tomcat 9.0、Jetty 9.3 和Undertow 1.4 原生提供。</p>
<h3 id="Kotlin-和-Spring-WebFlux"><a href="#Kotlin-和-Spring-WebFlux" class="headerlink" title="Kotlin 和 Spring WebFlux"></a>Kotlin 和 Spring WebFlux</h3><p>Kotlin 是一种来自 JetBrains 的面向对象的语言，它支持函数式编程。它的主要优势之一是与 Java 有非常高的互操作性。通过引入对 Kotlin 的专门支持，Spring 在 V5 中全面吸纳了这一优势。它的函数式编程风格与 Spring WebFlux 模块完美匹配，它的新路由 DSL 利用了函数式 Web 框架以及干净且符合语言习惯的代码。可以像下面代码中这样简单地表达端点路由：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111653.png"></p>
<p>使用 Kotlin 1.1.4+ 时，还添加了对 Kotlin 的不可变类的支持（通过带默认值的可选参数），以及对完全支持 null 的 API 的支持。</p>
<h3 id="使用-Lambda-表达式注册-Bean"><a href="#使用-Lambda-表达式注册-Bean" class="headerlink" title="使用 Lambda 表达式注册 Bean"></a>使用 Lambda 表达式注册 Bean</h3><p>作为传统 XML 和 JavaConfig 的替代方案，现在可以使用 lambda 表达式注册 Spring bean，使bean 可以实际注册为提供者。下面代码中使用 lambda 表达式注册了一个 Book bean。</p>
<p>将 Bean 注册为提供者</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915111825.png"></p>
<h3 id="Spring-Web-MVC-支持最新的-API"><a href="#Spring-Web-MVC-支持最新的-API" class="headerlink" title="Spring Web MVC 支持最新的 API"></a>Spring Web MVC 支持最新的 API</h3><p>全新的 WebFlux 模块提供了许多新的、令人兴奋的功能，但 Spring 5 也迎合了愿意继续使用SpringMVC 的开发人员的需求。Spring 5 中更新了模型-视图-控制器框架，以兼容 WebFlux 和最新版的Jackson 2.9 和 Protobuf 3.0，甚至包括对新的 Java EE 8 JSON-Binding API 的支持。</p>
<p>除了 HTTP&#x2F;2 特性的基础服务器实现之外，Spring WebMVC 还通过 MVC 控制器方法的一个参数来支持Servlet 4.0 的 PushBuilder。最后，WebMVC 全面支持 Reactor 3.1 的 Flux 和 Mono 对象，以及RxJava 1.3 和 2.1，它们被视为来自 MVC 控制器方法的返回值。这项支持的最终目的是支持SpringData 中的新的反应式 WebClient 和反应式存储库。</p>
<h3 id="使用-JUnit-5-执行条件和并发测试"><a href="#使用-JUnit-5-执行条件和并发测试" class="headerlink" title="使用 JUnit 5 执行条件和并发测试"></a>使用 JUnit 5 执行条件和并发测试</h3><p>JUnit 和 Spring 5：Spring 5 全面接纳了函数式范例，并支持 JUnit 5 及其新的函数式测试风格。还提供了对 JUnit 4 的向后兼容性，以确保不会破坏旧代码。</p>
<p>Spring 5 的测试套件通过多种方式得到了增强，但最明显的是它对 JUnit 5 的支持。现在可以在您的单元测试中利用 Java 8 中提供的函数式编程特性。以下代码演示了这一支持：</p>
<p>JUnit 5 全面接纳了 Java 8 流和 lambda 表达式</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915112011.png"></p>
<p>迁移到 JUnit 5：如果您对升级到 JUnit 5 持观望态度，Steve Perry 的分两部分的深入剖析教程将说服您冒险尝试。 Spring 5 继承了 JUnit 5 在 Spring TestContext Framework 内实现多个扩展 API 的灵活性。举例而言，开发人员可以使用 JUnit 5 的条件测试执行注解 @EnabledIf 和 @DisabledIf 来自动计算一个 SpEL (Spring Expression Language) 表达式，并适当地启用或禁用测试。借助这些注解，Spring 5支持以前很难实现的复杂的条件测试方案。Spring TextContext Framework 现在能够并发执行测试。</p>
<h3 id="包清理和弃用"><a href="#包清理和弃用" class="headerlink" title="包清理和弃用"></a>包清理和弃用</h3><p>Spring 5 中止了对一些过时 API 的支持。遭此厄运的还有 Hibernate 3 和 4，为了支持 Hibernate5，它们遭到了弃用。另外，对 Portlet、Velocity、JasperReports、XMLBeans、JDO 和 Guava 的支持也已中止。包级别上的清理工作仍在继续：Spring 5 不再支持 beans.factory.access、jdbc.support.nativejdbc、mock.staticmock（来自 spring-aspects 模块）或 web.view.tiles2M。Tiles3 现在是 Spring 的最低要求</p>
<h3 id="Spring-核心和容器的一般更新"><a href="#Spring-核心和容器的一般更新" class="headerlink" title="Spring 核心和容器的一般更新"></a>Spring 核心和容器的一般更新</h3><p>Spring Framework 5 改进了扫描和识别组件的方法，使大型项目的性能得到提升。目前，扫描是在编译时执行的，而且向 META-INF&#x2F;spring.components 文件中的索引文件添加了组件坐标。该索引是通过一个为项目定义的特定于平台的应用程序构建任务来生成的。</p>
<p>标有来自 javax 包的注解的组件会添加到索引中，任何带 @Index 注解的类或接口都会添加到索引中。Spring 的传统类路径扫描方式没有删除，而是保留为一种后备选择。有许多针对大型代码库的明显性能优势，而托管许多 Spring 项目的服务器也会缩短启动时间。</p>
<p>Spring 5 还添加了对 @Nullable 的支持，后者可用于指示可选的注入点。使用者现在必须准备接受null值。此外，还可以使用此注解来标记可以为 null 的参数、字段和返回值。@Nullable 主要用于IntelliJIDEA 等 IDE，但也可用于 Eclipse 和 FindBugs，它使得在编译时处理 null 值变得更方便，而无需在运行时发送 NullPointerExceptions。</p>
<p>Spring Logging 还提升了性能，自带开箱即用的 Commons Logging 桥接器。现在已通过资源抽象支持防御性编程，为 getFile 访问提供了 isFile 指示器。</p>
<h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><h3 id="什么是-Spring-框架？"><a href="#什么是-Spring-框架？" class="headerlink" title="什么是 Spring 框架？"></a>什么是 Spring 框架？</h3><p>Spring 是一种轻量级开发框架，旨在提高开发人员的开发效率以及系统的可维护性。</p>
<p>我们一般说 Spring 框架指的都是 Spring Framework，它是很多模块的集合，使用这些模块可以很方便地协助我们进行开发。这些模块是：核心容器、数据访问&#x2F;集成,、Web、AOP（面向切面编程）、工具、消息和测试模块。比如：Core Container 中的 Core 组件是Spring 所有组件的核心，Beans 组件和Context 组件是实现IOC和依赖注入的基础，AOP组件用来实现面向切面编程。</p>
<p>打开Spring官网 <a target="_blank" rel="noopener" href="http://www.spring.io/">www.spring.io</a></p>
<p>Spring 官网列出的 Spring 的 6 个特征:</p>
<ul>
<li><strong>核心技术</strong> ：依赖注入(DI)，AOP，事件(events)，资源，i18n（internationalization的首末字符i和n，18为中间的字符数），验证，数据绑定，类型转换，SpEL。</li>
<li><strong>测试</strong> ：模拟对象，TestContext框架，Spring MVC 测试，WebTestClient。</li>
<li><strong>数据访问</strong> ：事务，DAO支持，JDBC，ORM，编组XML。</li>
<li><strong>Web支持</strong> : Spring MVC和Spring WebFlux Web框架。</li>
<li><strong>集成</strong> ：远程处理，JMS，JCA，JMX，电子邮件，任务，调度，缓存。</li>
<li><strong>语言</strong> ：Kotlin，Groovy，动态语言。</li>
</ul>
<p>对于Spring而言，现在已经是一个生态了。</p>
<h3 id="Spring中有哪些重要的模块？"><a href="#Spring中有哪些重要的模块？" class="headerlink" title="Spring中有哪些重要的模块？"></a>Spring中有哪些重要的模块？</h3><ul>
<li><strong>Spring Core</strong>： 基础,可以说 Spring 其他所有的功能都需要依赖于该类库。主要提供 IoC 依赖注入功能。</li>
<li><strong>Spring Aspects</strong> ： 该模块为与AspectJ的集成提供支持。</li>
<li><strong>Spring AOP</strong> ：提供了面向切面的编程实现。</li>
<li><strong>Spring JDBC</strong> : Java数据库连接。</li>
<li><strong>Spring JMS</strong> ：Java消息服务。</li>
<li><strong>Spring ORM</strong> : 用于支持Hibernate等ORM工具。</li>
<li><strong>Spring Web</strong> : 为创建Web应用程序提供支持。</li>
<li><strong>Spring Test</strong> : 提供了对 JUnit 和 TestNG 测试的支持</li>
</ul>
<h3 id="RestController-与-Controller有什么区别？"><a href="#RestController-与-Controller有什么区别？" class="headerlink" title="@RestController 与 @Controller有什么区别？"></a>@RestController 与 @Controller有什么区别？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span> </span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span> </span><br><span class="line"><span class="meta">@Documented</span> </span><br><span class="line"><span class="meta">@Controller</span> </span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RestController &#123; </span><br><span class="line">    <span class="meta">@AliasFor(annotation = Controller.class)</span> </span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Controller </code><strong>返回一个页面</strong></p>
<p>单独使用 <code>@Controller</code> 不加 <code>@ResponseBody</code> 的话一般使用在要返回一个视图的情况，这种情况属于</p>
<p>比较传统的Spring MVC 的应用，对应于前后端不分离的情况。</p>
<p><code>@RestController </code><strong>返回JSON或XML形式数据</strong></p>
<p>但 <code>@RestController</code> 只返回对象，对象数据直接以 JSON 或 XML 形式写入 HTTP 响应(Response)中，这种情况属于 RESTful Web服务，这也是目前日常开发所接触的最常用的情况（前后端分离）。</p>
<p><code>@Controller+@ResponseBody</code> <strong>返回JSON或XML形式数据</strong></p>
<p>如果你需要在Spring4之前开发 RESTful Web服务的话，你需要使用 <code>@Controller</code> 并结合<code>@ResponseBody</code>注解，也就是说 <code>@Controller + @ResponseBody = @RestController</code>（Spring 4 之后新加的注解）。</p>
<h3 id="谈谈你对-Spring中-IoC-和-AOP-的理解"><a href="#谈谈你对-Spring中-IoC-和-AOP-的理解" class="headerlink" title="谈谈你对 Spring中 IoC 和 AOP 的理解"></a>谈谈你对 Spring中 IoC 和 AOP 的理解</h3><p><strong>IOC的理解</strong></p>
<p>IoC（Inverse of Control:控制反转）是一种<strong>设计思想</strong>，将原本在程序中手动创建对象的控制权，交由Spring框架来管理，IoC 在其他语言中也有应用，并非 Spring 特有。</p>
<p>IoC 容器是Spring 用来实现 IoC 的载体，IoC 容器实际上就是个Map（key，value），Map 中存放的是各种对象。对象之间的相互依赖关系交给 IoC 容器来管理，并由 IoC 容器完成对象的注入。很大程度上简化应用的开发，把应用从复杂的依赖关系中解放出来。</p>
<p><strong>IoC的初始化过程</strong></p>
<p>用配置Bean定义（XML、Annotation、Java配置）—&gt; 加载Bean定义成Resource —&gt; 各种解读器，解析Bean定义BeanDefinition —&gt; 注册Bean定义到BeanFactory</p>
<p><strong>AOP的理解</strong></p>
<p>Aspect-Oriented Programming，将那些与业务无关，但是业务模块都共同调用的逻辑或责任（例如事务处理、日志管理、权限控制等）封装起来，能减少系统的重复代码，降低模块间的耦合度，提高系统的可拓展性和可维护性。</p>
<p><strong>Spring AOP就是基于动态代理实现的</strong></p>
<p>实现了某个接口的对象，Spring AOP会使用JDK Proxy，创建代理对象。</p>
<p>没有实现接口的对象，Spring AOP会使用CGLIB ，生成一个被代理对象的子类来作为代理。</p>
<p>或者配置指定使用基于类代理，也会使用CGLIB方式创建代理对象。</p>
<p>Spring AOP 已经集成了AspectJ风格的切面表达式，但并不是使用AspectJ完成对象代理，AspectJ是一种静态代理的方式。</p>
<h3 id="Spring-AOP-和-AspectJ-AOP-有什么区别？"><a href="#Spring-AOP-和-AspectJ-AOP-有什么区别？" class="headerlink" title="Spring AOP 和 AspectJ AOP 有什么区别？"></a>Spring AOP 和 AspectJ AOP 有什么区别？</h3><p>Spring AOP 属于运行时增强，而 AspectJ 是编译时增强。 Spring AOP 基于代理(Proxying)，而 AspectJ基于字节码操作(Bytecode Manipulation)。</p>
<h3 id="Spring-中的-bean-的作用域有哪些？"><a href="#Spring-中的-bean-的作用域有哪些？" class="headerlink" title="Spring 中的 bean 的作用域有哪些？"></a>Spring 中的 bean 的作用域有哪些？</h3><ol>
<li>singleton : 唯一 bean 实例，Spring 中的 bean 默认都是单例的。</li>
<li>prototype : 每次请求都会创建一个新的 bean 实例。</li>
<li>request : 每一次HTTP请求都会产生一个新的bean，该bean仅在当前HTTP request内有效。</li>
<li>session : 新的HTTP Session都会产生一个新的 bean，该bean仅在当前 HTTP session 内有效。</li>
<li>global-session： 全局session作用域，仅仅在基于portlet的web应用中才有意义，Spring5已经没有了。Portlet是能够生成语义代码(例如：HTML)片段的小型Java Web插件。它们基于portlet容器，可以像servlet一样处理HTTP请求。但是，与 servlet 不同，每个 portlet 都有不同的会话</li>
</ol>
<h3 id="Spring-中的单例-bean-是不是线程安全的？"><a href="#Spring-中的单例-bean-是不是线程安全的？" class="headerlink" title="Spring 中的单例 bean 是不是线程安全的？"></a>Spring 中的单例 bean 是不是线程安全的？</h3><p>回答是或者不是都掉坑里了。Spring 框架并没有对单例 bean 进行任何多线程的封装处理。关于单例bean 的线程安全和并发问题需要开发者自行去搞定。但实际上，大部分的 Spring bean 并没有可变的状态(比如 Service类和 DAO类)，所以在某种程度上说 Spring 的单例 bean 是线程安全的。如果你的bean 有多种状态的话（比如 View Model 对象），就需要自行保证线程安全。</p>
<p>如果需要保证单例bean线程安全，常见解决办法：</p>
<ol>
<li>加锁</li>
<li>在Bean对象中尽量避免定义可变的成员变量。</li>
<li>在类中定义一个ThreadLocal成员变量，将需要的可变成员变量保存在 ThreadLocal 中。</li>
</ol>
<h3 id="Component-和-Bean-的区别是什么？"><a href="#Component-和-Bean-的区别是什么？" class="headerlink" title="@Component 和 @Bean 的区别是什么？"></a>@Component 和 @Bean 的区别是什么？</h3><p>作用对象不同: @Component 注解作用于类，而 @Bean 注解作用于方法。</p>
<p>@Component 通常是通过类路径扫描来自动侦测Bean以及自动装配到Spring容器中（我们可以使用@ComponentScan 注解定义要扫描的路径从中找出标识了需要装配的类自动装配到 Spring 的 bean 容器中）。</p>
<p>@Bean 注解通常是我们在标有该注解的方法中定义产生这个 bean, @Bean 告诉了Spring这是某个类的示<br>例，当我需要用它的时候还给我。</p>
<p>@Bean 注解比 Component 注解的自定义性更强，而且很多地方我们只能通过 @Bean 注解来注册bean。比如当我们引用第三方库中的类需要装配到 Spring 容器时，则只能通过 @Bean 来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无法通过@Component注解实现 </span></span><br><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="keyword">public</span> OneService <span class="title function_">getService</span><span class="params">(status)</span> &#123; </span><br><span class="line">    <span class="keyword">case</span> (status) &#123; </span><br><span class="line">        when <span class="number">1</span>: </span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">serviceImpl1</span>(); </span><br><span class="line">        when <span class="number">2</span>: </span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">serviceImpl2</span>(); </span><br><span class="line">        when <span class="number">3</span>: </span><br><span class="line">        	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">serviceImpl3</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="说说Spring-中的-bean-生命周期是怎样的？"><a href="#说说Spring-中的-bean-生命周期是怎样的？" class="headerlink" title="说说Spring 中的 bean 生命周期是怎样的？"></a>说说Spring 中的 bean 生命周期是怎样的？</h3><ol>
<li>注册Bean定义，Bean 容器找到配置文件中 Spring Bean 的定义，完成加载解析注册。</li>
<li>Bean实例化，Bean 容器用Lambada Supplier、Factory、构造函数三种方式创建一个Bean的实例。</li>
<li>属性填充，如果涉及到一些属性值利用 set() 方法设置一些属性值。</li>
<li>初始化，初始化有下面一系列动作，初始化完毕，Bean就可以使用了<br>如果 Bean 实现了 *.Aware 接口，就调用相应的方法。<br>如果有和加载这个 Bean 的 Spring 容器相关的 BeanPostProcessor 对象，执行<br>postProcessBeforeInitialization() 方法<br>如果Bean实现了 InitializingBean 接口，执行 afterPropertiesSet() 方法。<br>如果 Bean 在配置文件中的定义包含 init-method 属性，执行指定的方法。<br>如果有和加载这个 Bean的 Spring 容器相关的 BeanPostProcessor 对象，执行<br>postProcessAfterInitialization() 方法</li>
<li>Bean销毁，在容器关闭时，调用 Bean 注册的 DisposableBean 接口 、自定义的 destroy- method 属性，执行销毁。</li>
</ol>
<h3 id="Spring-管理事务的方式有几种？"><a href="#Spring-管理事务的方式有几种？" class="headerlink" title="Spring 管理事务的方式有几种？"></a>Spring 管理事务的方式有几种？</h3><ol>
<li>编程式事务，在代码中硬编码</li>
<li>声明式事务，在配置文件中配置<br>基于XML的声明式事务<br>基于注解的声明式事务</li>
</ol>
<h3 id="Spring-事务中的隔离级别有哪几种？"><a href="#Spring-事务中的隔离级别有哪几种？" class="headerlink" title="Spring 事务中的隔离级别有哪几种？"></a>Spring 事务中的隔离级别有哪几种？</h3><p><strong>TransactionDefinition</strong> 接口中定义了五个表示隔离级别的常量：</p>
<ul>
<li><strong>TransactionDefinition.ISOLATION_DEFAULT:</strong> 使用后端数据库默认的隔离级别，Mysql 默认采用的 REPEATABLE_READ隔离级别；Oracle 默认采用的 READ_COMMITTED隔离级别。</li>
<li><strong>TransactionDefinition.ISOLATION_READ_UNCOMMITTED:</strong> 最低的隔离级别，允许读取尚未提交的数据变更，<strong>可能会导致脏读、幻读或不可重复读</strong></li>
<li><strong>TransactionDefinition.ISOLATION_READ_COMMITTED:</strong> 允许读取并发事务已经提交的数据，<strong>可以阻止脏读，但是幻读或不可重复读仍有可能发生</strong></li>
<li><strong>TransactionDefinition.ISOLATION_REPEATABLE_READ:</strong> 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，<strong>可以阻止脏读和不可重复读，但幻读仍有可能发生。</strong></li>
<li><strong>TransactionDefinition.ISOLATION_SERIALIZABLE:</strong> 最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，<strong>该级别可以防止脏读、不可重复读以及幻读。</strong>但是这将严重影响程序的性能。通常情况下也不会用到该级别。</li>
</ul>
<h3 id="Spring-事务中哪几种事务传播行为？"><a href="#Spring-事务中哪几种事务传播行为？" class="headerlink" title="Spring 事务中哪几种事务传播行为？"></a>Spring 事务中哪几种事务传播行为？</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20210915114708.png"></p>
<p><strong>支持当前事务的情况：</strong></p>
<ul>
<li><strong>TransactionDefinition.PROPAGATION_REQUIRED：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。</li>
<li><strong>TransactionDefinition.PROPAGATION_SUPPORTS：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</li>
<li><strong>TransactionDefinition.PROPAGATION_MANDATORY：</strong> 如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。（mandatory：强制性）</li>
</ul>
<p><strong>不支持当前事务的情况：</strong></p>
<ul>
<li><strong>TransactionDefinition.PROPAGATION_REQUIRES_NEW：</strong> 创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li>
<li><strong>TransactionDefinition.PROPAGATION_NOT_SUPPORTED：</strong> 以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li>
<li><strong>TransactionDefinition.PROPAGATION_NEVER：</strong> 以非事务方式运行，如果当前存在事务，则抛出异常。</li>
</ul>
<p><strong>嵌套事务：</strong></p>
<ul>
<li><strong>TransactionDefinition.PROPAGATION_NESTED：</strong> 如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于TransactionDefinition.PROPAGATION_REQUIRED。</li>
</ul>
<h3 id="Transactional-rollbackFor-Exception-class-注解了解吗？"><a href="#Transactional-rollbackFor-Exception-class-注解了解吗？" class="headerlink" title="@Transactional(rollbackFor &#x3D; Exception.class)注解了解吗？"></a>@Transactional(rollbackFor &#x3D; Exception.class)注解了解吗？</h3><p>Exception分为运行时异常RuntimeException和非运行时异常。事务管理对于企业应用来说非常重要，即使出现异常情况，它也可以保证数据的一致性。</p>
<p><code>@Transactional</code> 注解作用于类上时，该类的所有 public 方法将都具有该类型的事务属性，同时，我们也可以在方法级别使用该标注来覆盖类级别的定义。如果类或者方法加了这个注解，那么这个类里面的方法抛出异常，就会回滚，数据库里面的数据也会回滚。</p>
<p><strong>为什么<code>@Transactional</code>只对public方法有效？</strong></p>
<p>TransactionInterceptor#invoke</p>
<p>TransactionAspectSupport#invokeWithinTransaction</p>
<p>AbstractFallbackTransactionAttributeSource#getTransactionAttribute</p>
<p>AbstractFallbackTransactionAttributeSource#computeTransactionAttribute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> TransactionAttribute <span class="title function_">computeTransactionAttribute</span><span class="params">(Method method, <span class="meta">@Nullable</span> Class&lt;?&gt; targetClass)</span> &#123;</span><br><span class="line">    <span class="comment">// 非public方法直接返回null</span></span><br><span class="line">    <span class="comment">// Don&#x27;t allow no-public methods as required.</span></span><br><span class="line">    <span class="keyword">if</span> (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The method may be on an interface, but we need attributes from the target class.</span></span><br><span class="line">    <span class="comment">// If the target class is null, the method will be unchanged.</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">specificMethod</span> <span class="operator">=</span> AopUtils.getMostSpecificMethod(method, targetClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First try is the method in the target class.</span></span><br><span class="line">    <span class="type">TransactionAttribute</span> <span class="variable">txAttr</span> <span class="operator">=</span> findTransactionAttribute(specificMethod);</span><br><span class="line">    <span class="keyword">if</span> (txAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> txAttr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Second try is the transaction attribute on the target class.</span></span><br><span class="line">    txAttr = findTransactionAttribute(specificMethod.getDeclaringClass());</span><br><span class="line">    <span class="keyword">if</span> (txAttr != <span class="literal">null</span> &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> txAttr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (specificMethod != method) &#123;</span><br><span class="line">        <span class="comment">// Fallback is to look at the original method.</span></span><br><span class="line">        txAttr = findTransactionAttribute(method);</span><br><span class="line">        <span class="keyword">if</span> (txAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> txAttr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Last fallback is the class of the original method.</span></span><br><span class="line">        txAttr = findTransactionAttribute(method.getDeclaringClass());</span><br><span class="line">        <span class="keyword">if</span> (txAttr != <span class="literal">null</span> &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> txAttr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 <code>@Transactional</code> 注解中如果不配置 <code>rollbackFor</code> 属性,那么事务只会在遇到 <code>RuntimeException</code> 的时候才会回滚,加上 <code>rollbackFor=Exception.class</code> ,可以让事务在遇到非运行时异常时也回滚。</p>
<p>另外<strong>需要注意</strong>的就是，如果子方法有使用@Transactional(rollbackFor &#x3D; RuntimeException.class)，父方法是rollabackFor&#x3D;Exception.class，则可能出现，子方法出现非运行时异常，导致父方法不回滚自己的事务，导致不一致性问题出现。</p>
<h3 id="说说你对于-Spring-MVC-了解"><a href="#说说你对于-Spring-MVC-了解" class="headerlink" title="说说你对于 Spring MVC 了解"></a>说说你对于 Spring MVC 了解</h3><p><strong>Servlet</strong>，Java中用来处理Web请求的程序，是一套API规范，它有不同的Servlet容器实现，比如，Tomcat、WebLogic、Jboss等。</p>
<p><strong>SpringMVC</strong>，基于Servlet构建的处理web请求的MVC框架。MVC 是一种软件设计典范，用一种业务逻辑、数据、界面显示分层，分离的方法组织代码，将业务逻辑聚集到一个部件里面，在改进和个性化定制界面及用户交互的同时，不需要重新编写业务逻辑。</p>
<h3 id="说说SpringMVC的工作原理"><a href="#说说SpringMVC的工作原理" class="headerlink" title="说说SpringMVC的工作原理"></a>说说SpringMVC的工作原理</h3><p>准备阶段</p>
<ol>
<li><p>Servlet容器启动，触发DispatcherServlet进行初始化</p>
</li>
<li><p>初始化：文件上传、本地语言解析器、模板处理器、映射处理器、处理适配器、异常拦截处理器、视图预处理器、视图解析器、内存管理器 九大组件。</p>
</li>
<li><p>AbstractDetectingUrlHandlerMapping的initApplicationContext建立URL与Controller的对应关系</p>
</li>
</ol>
<p>运行阶段</p>
<ol>
<li><p>客户端（浏览器）发送请求，直接请求到 <code>DispatcherServlet</code> 。 </p>
</li>
<li><p><code>DispatcherServlet</code> 根据请求信息调用 <code>HandlerMapping</code> ，解析请求对应的 <code>Handler</code> 。 </p>
</li>
<li><p>解析到对应的 <code>Handler</code> （也就是我们平常说的 <code>Controller</code> 控制器）后，开始由<code>HandlerAdapter</code> 适配器处理。</p>
</li>
<li><p><code>HandlerAdapter</code> 会根据 <code>Handler</code> 来调用真正的处理器来处理请求，并处理相应的业务逻辑。</p>
</li>
<li><p>处理器处理完业务后，会返回一个 <code>ModelAndView</code> 对象， <code>Model</code> 是返回的数据对象， <code>View</code> 是个逻辑上的 <code>View</code> 。 </p>
</li>
<li><p><code>ViewResolver</code> 会根据逻辑 <code>View</code> 查找实际的 <code>View</code> 。 </p>
</li>
<li><p><code>DispaterServlet</code> 把返回<code>的 Model</code> 传给 <code>View</code> （视图渲染）。</p>
</li>
<li><p>把 <code>View</code> 返回给请求者（浏览器）</p>
</li>
</ol>
<h3 id="Spring-框架中用到了哪些设计模式"><a href="#Spring-框架中用到了哪些设计模式" class="headerlink" title="Spring 框架中用到了哪些设计模式"></a>Spring 框架中用到了哪些设计模式</h3><p>Spring中应用设计模式的地方非常多，经典的有这些。</p>
<p><strong>工厂模式 :</strong> Spring使用工厂模式通过 <code>BeanFactory</code> 、 <code>ApplicationContext</code> 创建 bean 对象。</p>
<p><strong>代理模式 :</strong> Spring AOP 功能的实现。</p>
<p><strong>策略模式 :</strong> Spring 中的代理对象创建方式，JDK Proxy和CGLIB。</p>
<p><strong>单例模式 :</strong> Spring 中的 Bean 默认都是单例的。</p>
<p><strong>模板方法 :</strong> Spring 中 <code>AbstractApplication</code> 的refresh方法和 <code>jdbcTemplate</code> 、 <code>hibernateTemplate</code>等以 Template 结尾的对数据库操作的类，它们就使用到了模板模式。</p>
<p><strong>包装器模式 :</strong> 我们的项目需要连接多个数据库，而且不同的客户在每次访问中根据需要会去访问不同的数据库。这种模式让我们可以根据客户的需求能够动态切换不同的数据源。</p>
<p><strong>观察者模式：</strong> Spring 事件驱动模型就是观察者模式很经典的一个应用。</p>
<p><strong>适配器模式：</strong>Spring AOP 的增强或通知(Advice)使用到了适配器模式、spring MVC 中也是用到了适配器模式适配 <code>Controller</code> 。</p>
<p><strong>责任链模式：</strong>SpringAOP将advice串成链执行。MVC的HandlerInterceptor也是串成链执行。</p>
<h3 id="BeanFactory-和-ApplicationContext-有什么区别？"><a href="#BeanFactory-和-ApplicationContext-有什么区别？" class="headerlink" title="BeanFactory 和 ApplicationContext 有什么区别？"></a>BeanFactory 和 ApplicationContext 有什么区别？</h3><p>BeanFactory 可以理解为含有 bean 集合的工厂类。BeanFactory 包含了种 bean 的定义，以便在接 收到客户端请求时将对应的 bean 实例化。 BeanFactory 还能在实例化对象的时生成协作类之间的关系。此举将 bean 自身与 bean 客户端的配置中解放出来。BeanFactory 还包含了 bean 生命周期的控制，调用客户端的初始化方法（initialization Methods）和销毁方法（destruction Methods）。</p>
<p>从表面上看，ApplicationContext 如同 bean factory 一样具有 bean 定义、bean 关联关系的设置，据请求分发 bean 的功能。但 ApplicationContext 在此基础上还提供了其他的功能。</p>
<ol>
<li>提供了支持国际化的文本消息</li>
<li>统一的资源文件读取方式</li>
<li>已在监听器中注册的 bean 的事件</li>
</ol>
<p>以下是三种较常见的 ApplicationContext 实现方式： </p>
<ol>
<li><p>ClassPathXmlApplicationContext：从classpath 的 XML 配置文件中读取上下文，并生成上下文 定义。应用程序上下文从程序环境变量中取得。 ApplicationContext context &#x3D; new ClassPathXmlApplicationContext(“application.xml”);</p>
</li>
<li><p>FileSystemXmlApplicationContext ：由文件系统中的 XML 配置文件读取上下文。ApplicationContext context &#x3D; new FileSystemXmlApplicationContext(“application.xml”);</p>
</li>
<li><p>XmlWebApplicationContext：由 Web 应用的 XML 文件读取上下文。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/02-Spring/16-Spring%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" data-id="clmcxecy7008yu8wagiln63ky" data-title="Spring面试总结" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-03-SpringBoot/01-SpringBoot快速上手" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/07/03-SpringBoot/01-SpringBoot%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" class="article-date">
  <time class="dt-published" datetime="2021-05-07T14:36:30.000Z" itemprop="datePublished">2021-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/07/03-SpringBoot/01-SpringBoot%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">SpringBoot快速上手</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="web开发、部署"><a href="#web开发、部署" class="headerlink" title="web开发、部署"></a>web开发、部署</h1><h2 id="Spring-boot是什么"><a href="#Spring-boot是什么" class="headerlink" title="Spring boot是什么"></a>Spring boot是什么</h2><ul>
<li><strong>一个让你能在5分钟之内创建一个产品级的spring应用的开发框架</strong></li>
<li><strong>与Spring framework的区别?</strong> <ul>
<li>构建于Spring framework之上</li>
<li>为我们提供直接可用的集成成品</li>
</ul>
</li>
</ul>
<h2 id="Spring-Boot应用创建"><a href="#Spring-Boot应用创建" class="headerlink" title="Spring Boot应用创建"></a>Spring Boot应用创建</h2><ul>
<li>创建Spring boot应用有三种方式: <ul>
<li>通过start.spring.io，<a target="_blank" rel="noopener" href="https://start.spring.io/">https://start.spring.io/</a></li>
<li>通过IDE (IDEA、STS）快速创建</li>
<li>完全手动创建<ul>
<li>新建普通java maven工程</li>
<li>引入maven依赖</li>
<li>编写启动类</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1、加入parent --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2、引入需要的依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 3、加入spring boot maven构建插件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>boot1<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="约定俗成的规则"><a href="#约定俗成的规则" class="headerlink" title="约定俗成的规则"></a>约定俗成的规则</h2><ul>
<li>Bean扫描的basePackage为启动类所在包</li>
<li>配置参数通过classpath下的application.properties或application.yml来配置</li>
<li>web开发的静态资源文件可放在classpath下的static、public.resources、 META-NF&#x2F;resouces目录，访问的url对应它们之下的目录结构。四个目录的搜索次序:&#x2F;META-INF&#x2F;resources&gt;resources&gt;static&gt;public</li>
<li>web开发采用页面模板技术时，模板文件放在classpath:&#x2F;templates目录下</li>
</ul>
<h2 id="Spring-Boot应用构建部署"><a href="#Spring-Boot应用构建部署" class="headerlink" title="Spring Boot应用构建部署"></a>Spring Boot应用构建部署</h2><ul>
<li><p><strong>构建的依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>构建可执行Jar</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>构建:maven package</li>
<li>执行:java -jar xxx.jar</li>
</ul>
</li>
<li><p><strong>构建war</strong></p>
<ul>
<li><p>修改打包方式: war</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- 移除内嵌tomcat的依赖</span><br><span class="line"></span><br><span class="line">  ```xml</span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- 移除嵌入式tomcat插件 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 俩者用一即可，注意Servlet API的依赖需要 --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 或修改tomcat依赖scope为provided --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  ```</span><br><span class="line"></span><br><span class="line">- 修改启动类继承SpringBootServletInitializer,实现configure方法。这里实际是创建了一个DispatcherServlet</span><br><span class="line"></span><br><span class="line">  ````java</span><br><span class="line">  package com.study;</span><br><span class="line">  </span><br><span class="line">  import org.springframework.boot.SpringApplication;</span><br><span class="line">  import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">  import org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line">  import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;</span><br><span class="line">  </span><br><span class="line">  @SpringBootApplication</span><br><span class="line">  public class App extends SpringBootServletInitializer &#123;</span><br><span class="line">      public static void main(String[] args) &#123;</span><br><span class="line">          SpringApplication.run(App.class, args);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      @Override</span><br><span class="line">      protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) &#123;</span><br><span class="line">          return builder.sources(App.class);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意项:为了防止应用上下文所导致的项目访问资源加载不到的问题，建议pom.xml文件中&lt; build &gt;&lt; &#x2F;build&gt;标签下添加&lt; finalName&gt;&lt; &#x2F;finalName&gt;标签</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>boot1<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span> <span class="comment">&lt;!-- war包名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  - 打包maven package</span><br><span class="line"></span><br><span class="line">  - 部暑war包到tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 了解spring-boot-starter-parent</span><br><span class="line"></span><br><span class="line">**我们的应用pom会从spring-boot-starter-parent继承来什么?**</span><br><span class="line"></span><br><span class="line">- 在spring-boot-starter-parent的父模块spring-boot-dependencies中带有各类开发所需要的依赖版本号以及版本控制</span><br><span class="line">- 如果需要修改对应版本号在自己的xml中的properties中添加对应spring-boot-dependencies的依赖标签名称，修改版本号为自己指定版本号</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 日志</span><br><span class="line"></span><br><span class="line">## Spring Boot日志</span><br><span class="line"></span><br><span class="line">- **Java日志框架:** </span><br><span class="line"></span><br><span class="line">  - 常见的日志框架很多：JCL、SLF4J、Jboss-logging、jUL、log4j、log4j2、logback等等</span><br><span class="line"></span><br><span class="line">  - 一般日志是由一个抽象层+实现层的组合来搭建的，一个应用中各组件用的日志框架可能不同</span><br><span class="line"></span><br><span class="line">    日志抽象层：JCL、SLF4J、jboss-logging</span><br><span class="line"></span><br><span class="line">    日志实现层：jul、log4j、log4j2、logback </span><br><span class="line"></span><br><span class="line">    Java日志组件介绍：http://www.blogjava.net/daiyongzhi/archive/2014/04/13/412364.html</span><br><span class="line"></span><br><span class="line">- **SpringBoot日志框架:** </span><br><span class="line"></span><br><span class="line">  - Spring Boot使用Commons Logging记录内部日志，但底层日志实现保持开放状态。 </span><br><span class="line">  - 提供了Java Util Logging，Log4J2和Logback的默认配置</span><br><span class="line">  - Stater方式，默认使用Logback实现进行日志记录，加入适当的路由确保其他日志框架的正常工作</span><br><span class="line">  - 一般情况会集成其他框架，这些框架会带有自己的日志框架，我们只需要排除即可</span><br><span class="line"></span><br><span class="line">## Spring Boot测试</span><br><span class="line"></span><br><span class="line">- **SpringBoot日志配置:**</span><br><span class="line"></span><br><span class="line">  - application.properties中的属性配置</span><br><span class="line"></span><br><span class="line">    ````properties</span><br><span class="line">    # 日志配置</span><br><span class="line">    # 指定日志文件</span><br><span class="line">    logging.file.name=my.log</span><br><span class="line">    # 指定日志目录</span><br><span class="line">    logging.file.path=/app/log</span><br><span class="line">    # 调整日志级别</span><br><span class="line">    logging.level.root=info</span><br><span class="line">    logging.level.org.springframework.web=debug</span><br><span class="line">    logging.level.org.hibernate=error</span><br><span class="line"></span><br><span class="line">  - 日志文件配置</span><br><span class="line"></span><br><span class="line">  - resource目录下的logback.xml配置示例</span><br><span class="line"></span><br><span class="line">    ````xml</span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;filelog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">File</span>&gt;</span>/logs/app.log<span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>/logs/app.%d.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>1MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                    %d %p (%file:%line\)- %m%n</span><br><span class="line">                <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;filelog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line"></span><br><span class="line">## Spring Boot测试</span><br><span class="line"></span><br><span class="line">- **SpringBoot测试框架:** </span><br><span class="line"></span><br><span class="line">  - Spring Boot提供了许多实用程序和注解来测试应用</span><br><span class="line"></span><br><span class="line">  - Spring的测试包含spring-boot-test和spring-boot-test-autoconfigure两个模块</span><br><span class="line"></span><br><span class="line">  - 一般使用spring-boot-starter-test使用测试框架，引入了test模块及JUnit Jupiter，AssertJ，Hamcrest等库</span><br><span class="line"></span><br><span class="line">    ````xml</span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**SpringBoot MVC测试案例:**</span><br><span class="line"></span><br><span class="line">````java</span><br><span class="line">package com.study;</span><br><span class="line"></span><br><span class="line">import org.junit.jupiter.api.Test;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line">import org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"></span><br><span class="line">import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</span><br><span class="line">import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br><span class="line"></span><br><span class="line">@SpringBootTest</span><br><span class="line">@AutoConfigureMockMvc</span><br><span class="line">public class MockMvcExampleTests &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void exampleTest(@Autowired MockMvc mvc) throws Exception &#123;</span><br><span class="line">        mvc.perform(get(&quot;/user/123456&quot;))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andExpect(content().string(&quot;supermark-6666666668&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="Actuator的使用"><a href="#Actuator的使用" class="headerlink" title="Actuator的使用"></a>Actuator的使用</h1><h2 id="Spring-Boot-Actuator"><a href="#Spring-Boot-Actuator" class="headerlink" title="Spring Boot Actuator"></a>Spring Boot Actuator</h2><p><strong>SpringBoot单体应用监控-Actuator</strong></p>
<p>预生产环境监视管理应用程序，可以通过HTTP端点、JMX方式进行管理监视。可以自动做到应用审计、健康检查、指标收集。</p>
<p><strong>开启生产功能Actuator</strong></p>
<p>pom.xml配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.properties配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用端点，默认不启用，还可以单独的指定，见shutdown的示例</span></span><br><span class="line"><span class="attr">management.endpoints.enabled-by-default</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 启用shutdown端点</span></span><br><span class="line"><span class="attr">management.endpoint.shutdown.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 表示在http上暴露所有端点，指定端点名表示暴露指定的端点</span></span><br><span class="line"><span class="attr">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 默认值为never，显示所有组件的详细健康信息</span></span><br><span class="line"><span class="attr">management.endpoint.health.show-components</span>=<span class="string">always</span></span><br><span class="line"><span class="attr">management.endpoint.health.show-details</span>=<span class="string">always</span></span><br><span class="line"><span class="comment"># 禁用HTTP暴露端点</span></span><br><span class="line"><span class="comment"># management.server.port=-1</span></span><br></pre></td></tr></table></figure>



<p><strong>Actuator暴露的Http端点</strong></p>
<ul>
<li>查看所有暴露端点：&#x2F;actuator</li>
<li>访问health端点：&#x2F;actuator&#x2F;health</li>
<li>bean信息：&#x2F;actuator&#x2F;beans</li>
<li>指标信息：&#x2F;actuator&#x2F;metrics</li>
<li>RequestMapping信息：&#x2F;actuator&#x2F;mappings</li>
<li>线程堆栈：&#x2F;actuator&#x2F;threaddump</li>
<li>自定义暴露端点</li>
</ul>
<p>更多信息参考官网：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-readyendpoints-enabling-endpoints">https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-readyendpoints-enabling-endpoints</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/07/03-SpringBoot/01-SpringBoot%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" data-id="clmcxecyl009bu8wa01sb5670" data-title="SpringBoot快速上手" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-01-Java基础/01-多线程/04-获取线程执行结果" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/25/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/04-%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C/" class="article-date">
  <time class="dt-published" datetime="2021-04-25T12:06:48.000Z" itemprop="datePublished">2021-04-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/25/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/04-%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C/">获取线程执行结果</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-线程组"><a href="#1-线程组" class="headerlink" title="1 线程组"></a>1 线程组</h1><p>ThreadGroup的提出是为了方便线程的管理，通过它可以批量设定一组线程的属性，比如setDaemon，设置未处理异常的处理方法，设置统一的安全策略等等；也可以通过线程组方便的获得线程的一些信息，<strong>尽量不要使用，会带来线程安全问题</strong>。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210425204146934.png" alt="image-20210425204146934"></p>
<h1 id="2-启动线程"><a href="#2-启动线程" class="headerlink" title="2 启动线程"></a>2 启动线程</h1><p>启动线程的方式只有一种：new Thread().start()</p>
<p>Runnable 也是？错。 Runnable只是Thread要执行的逻辑</p>
<p>Callable<T></p>
<p>FutureTask也是Thread要执行的逻辑，只是封装了获取结果的功能</p>
<h1 id="3-终止线程"><a href="#3-终止线程" class="headerlink" title="3 终止线程"></a>3 终止线程</h1><h2 id="3-1-Stop"><a href="#3-1-Stop" class="headerlink" title="3.1 Stop"></a>3.1 Stop</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_stop</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);     <span class="comment">// 休眠1秒，确保i变量自增成功</span></span><br><span class="line">        thread.stop(); <span class="comment">// i=1 j=0，无法保证同步代码块里面数据的一致性，破坏了线程安全</span></span><br><span class="line">        <span class="comment">// thread.interrupt(); // i=1 j=1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (thread.isAlive()) &#123;&#125;  <span class="comment">// 确保线程已经终止</span></span><br><span class="line">        thread.print();     <span class="comment">// 输出结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            ++i;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            ++j;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;锁释放。。。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;i=&quot;</span> + i + <span class="string">&quot; j=&quot;</span> + j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>理想输出：i&#x3D;0 j&#x3D;0</p>
<p>程序执行结果：i&#x3D;1 j&#x3D;0</p>
<p>没有保证同步代码块里面数据的一致性，破坏了线程安全</p>
<p><strong>Stop∶</strong> 但是可能导致线程安全问题，JDK不建议用。 </p>
<p><strong>Destroy∶</strong> JDK未实现该方法。</p>
<h2 id="3-2-interrupt"><a href="#3-2-interrupt" class="headerlink" title="3.2 interrupt"></a>3.2 interrupt</h2><ol>
<li>interrupt方法并不会中断线程，知识打上中断标记</li>
<li>如 果 目 标 线 程 在 调 用 wait() 、 wait(long) 方 法 、 join() 、 join(long, int) 、join(long, int)、sleep(long, int)或sleep(long, int)等方法后，处于<strong>WAITING、Timed Waiting</strong>状态时，该线程被调用<strong>interrupt</strong>方法后，线程的WAITING、Timed Waiting<strong>状态将被清除</strong>，并抛出InterruptedException异常。</li>
<li>park()\parkNanos方法执行后，线程也处于 <strong>WAITING、Timed Waiting，也会被唤醒，但是不会抛异常，且有很诡异的情况发生。</strong></li>
<li>如果目标线程是被I&#x2F;O 或者NIO中的Channel所阻塞，同样，I&#x2F;O操作会被中断或者返回特殊异常值。达到终止线程的目的。</li>
<li>如果以上条件都不满足，则会设置此线程的中断状态。</li>
</ol>
<h2 id="3-3-正确终止-interrupt"><a href="#3-3-正确终止-interrupt" class="headerlink" title="3.3 正确终止 - interrupt"></a>3.3 正确终止 - interrupt</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">testThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;runing...&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="comment">//isinterrupted状态被擦除</span></span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    testThread.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    testThread.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-deamon线程：主线程结束，进程就结束了吗？"><a href="#4-deamon线程：主线程结束，进程就结束了吗？" class="headerlink" title="4 deamon线程：主线程结束，进程就结束了吗？"></a>4 deamon线程：主线程结束，进程就结束了吗？</h1><p>守护线程：是指在程序运行的时候在后台提供一种通用服务的线程，进程结束时，会杀死所有守护线程。</p>
<p>用户线程：非守护线程就是用户线程线</p>
<p>进程结束：没有非守护线程还在运行时，进程结束</p>
<p>注意：</p>
<ul>
<li>thread.setDaemon(true)必须在thread.start()之前设置，否则会跑出一个IllegalThreadStateException异常。你不能把正在运行的常规线程设置为守护线程。</li>
<li>在Daemon线程中产生的新线程也是Daemon的。</li>
<li>守护线程应该永远不去访问固有资源，如文件、数据库，因为它会在任何时候甚至在一个操作的中间发生中断。</li>
</ul>
<h1 id="5-CountDownLatch"><a href="#5-CountDownLatch" class="headerlink" title="5 CountDownLatch"></a>5 CountDownLatch</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">AtomicLong</span> <span class="variable">num</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>; j&lt; <span class="number">10000000</span>; j++)&#123;</span><br><span class="line">                    num.getAndIncrement();</span><br><span class="line">                &#125;</span><br><span class="line">                ctl.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctl.await();     <span class="comment">//设置开关，设置门栓</span></span><br><span class="line">    System.out.println(num.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-Semaphore"><a href="#6-Semaphore" class="headerlink" title="6 Semaphore"></a>6 Semaphore</h1><p>Semaphore是一个计数信号量，常用于限制可以访问某些资源（物理或逻辑的）线程数目。</p>
<p>简单说，是一种用来控制并发量的共享锁。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210425231433111.png" alt="image-20210425231433111"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">sp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这么短的时间，发送1000个请求，并发会很高，数据库会受不了</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sp.acquire();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                queryDb(<span class="string">&quot;localhost:3306&quot;</span>);  <span class="comment">//模拟DB查询</span></span><br><span class="line">                sp.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//发送一个HTTP请求</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">queryDb</span><span class="params">(String uri)</span>  &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;do query...:&quot;</span> + uri);</span><br><span class="line">    LockSupport.parkNanos(<span class="number">1000</span> * <span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-CyclicBarrier"><a href="#7-CyclicBarrier" class="headerlink" title="7 CyclicBarrier"></a>7 CyclicBarrier</h1><p>循环栅栏，可以循环利用的屏障。</p>
<p>举例：排队上摩天轮时，每到齐四个人，就可以上同一个车厢。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">CyclicBarrier</span> <span class="variable">barrier</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">4</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;&gt;&gt;&gt; 这是一个栅栏。。。&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//传入一个Runnable，打印栅栏</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//LockSupport.parkNanos(1000 * 1000 * 1000 * 10L);</span></span><br><span class="line">                    barrier.await();    <span class="comment">//</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;上到摩天轮...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        LockSupport.parkNanos(<span class="number">1000</span> * <span class="number">1000</span> * <span class="number">1000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/25/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/04-%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C/" data-id="clmcxeco3005lu8wagpi4b0o0" data-title="获取线程执行结果" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-01-Java基础/01-多线程/03-线程安全之原子性" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/24/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/03-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%80%A7/" class="article-date">
  <time class="dt-published" datetime="2021-04-24T12:06:48.000Z" itemprop="datePublished">2021-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/24/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/03-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%80%A7/">线程安全之原子性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-原子操作"><a href="#1-原子操作" class="headerlink" title="1 原子操作"></a>1 原子操作</h1><h2 id="1-1-什么是原子操作？"><a href="#1-1-什么是原子操作？" class="headerlink" title="1.1 什么是原子操作？"></a>1.1 什么是原子操作？</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">ct</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Counter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    ct.add();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;done...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">6000L</span>);</span><br><span class="line">    System.out.println(ct.i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        i = i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>期望输出：60000，实际输出：小于60000</p>
<p>为什么出问题？</p>
<p>使用<code>javap -v -p Counter.class</code>反编译class文件，发现i &#x3D; i + 1;指行的步骤如下，需要执行4个指令</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210424230307267.png" alt="image-20210424230307267"></p>
<p>原子操作可以是一个步骤，也可以是多个操作步骤，但是其顺序不可以被打乱，也<strong>不可以被切割</strong>而只执行其中的一部分(不可中断性)。</p>
<p>将整个操作视作一个整体，<strong>资源在该次操作中保持一致</strong>，这是原子性的核心特征。</p>
<p><strong>结论：</strong>i++不是原子操作，存在竞态条件，线程不安全，需要转变为原子操作才能安全。</p>
<h2 id="1-2-竞态条件与临界区"><a href="#1-2-竞态条件与临界区" class="headerlink" title="1.2 竞态条件与临界区"></a>1.2 竞态条件与临界区</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        i = i + <span class="number">1</span>; <span class="comment">// 竞态条件</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>竞态条件：当两个线程竞争同一资源时，如果对资源的访问<strong>顺序敏感</strong>，就称存在<strong>竞态条件</strong>。</p>
<p><strong>临界区</strong>，就是导致竞态条件发生的代码区。</p>
<h2 id="1-3-CAS（Compare-and-swap）机制"><a href="#1-3-CAS（Compare-and-swap）机制" class="headerlink" title="1.3 CAS（Compare and swap）机制"></a>1.3 CAS（Compare and swap）机制</h2><ul>
<li>CAS 属于<strong>硬件</strong>同步原语，处理器提供的内存操作指令，<strong>保证原子性</strong>。</li>
<li>CAS 操作需要两个参数，一个<strong>旧值</strong>和一个<strong>目标值</strong>，修改前先<strong>比较</strong>旧值是否改变，如果没变，将新值赋给变量，否则不做改变。</li>
</ul>
<p>JAVA中的sun.misc.Unsafe类提供了CAS机制。</p>
<h2 id="1-4-J-U-C包内的原子操作封装类"><a href="#1-4-J-U-C包内的原子操作封装类" class="headerlink" title="1.4 J.U.C包内的原子操作封装类"></a>1.4 J.U.C包内的原子操作封装类</h2><p>AtomicBoolean：原子更新布尔类型<br>AtomicInteger：原子更新整型<br>AtomicLong：原子更新长整型</p>
<p>AtomicIntegerArray：原子更新整型数组里的元素<br>AtomicLongArray：原子更新长整型数组里的元素<br>AtomicReferenceArray：原子更新引用类型数组里的元素</p>
<p>AtomicIntegerFieldUpdater：原子更新整型的字段的更新器<br>AtomicLongFieldUpdater：原子更新长整型字段的更新器<br>AtomicReferenceFieldUpdater：原子更新引用类型里的字段</p>
<p>AtomicReference：原子更新引用类型<br>AtomicStampedReference：原子更新带有版本号的引用类型<br>AtomicMarkableReference：原子更新带有标记位的引用类型</p>
<p>1.8更新</p>
<p>计数器： DoubleAdder、 LongAdder<br>计数器增强版，高并发下性能更好</p>
<p>DoubleAccumulator、 LongAccumulator<br>是计数器的增强版，可自定义累加规则</p>
<h2 id="1-4-CAS存在的问题"><a href="#1-4-CAS存在的问题" class="headerlink" title="1.4 CAS存在的问题"></a>1.4 CAS存在的问题</h2><ol>
<li>仅针对单个变量的操作，不能用于多个变量来实现原子操作。</li>
<li>循环+CAS，自旋的实现让所有线程都处于高频运行，争抢CPU执行时间的状态 。如果操作长时间不成功，会带来很大的CPU资源消耗。</li>
<li>ABA问题。（无法体现出数据的变动）。</li>
</ol>
<h2 id="1-5-CAS自旋的典型场景"><a href="#1-5-CAS自旋的典型场景" class="headerlink" title="1.5 CAS自旋的典型场景"></a>1.5 CAS自旋的典型场景</h2><p>i++场景</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210424232656127.png" alt="image-20210424232656127"></p>
<p>抢锁场景</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210424232709628.png" alt="image-20210424232709628"></p>
<h2 id="1-6-ABA问题"><a href="#1-6-ABA问题" class="headerlink" title="1.6 ABA问题"></a>1.6 ABA问题</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210424232902086.png" alt="image-20210424232902086"></p>
<ul>
<li>thread1、thread2同时读取到i&#x3D;0后</li>
<li>thread1、thread2都要执行CAS（0，1）操作</li>
<li>假设thread2操作稍之后与thread1，则thread1执行成功</li>
<li>thread1紧接着执行了CAS（1，0），将i的值改回0</li>
<li>线程2本应该失败的CAS（0，1）操作，此时却成功了</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/24/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/03-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%80%A7/" data-id="clmcxeco2005iu8wa4f38g1tm" data-title="线程安全之原子性" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-01-Java基础/01-多线程/01-多线程基础" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="article-date">
  <time class="dt-published" datetime="2021-04-19T13:33:48.000Z" itemprop="datePublished">2021-04-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/">多线程基础</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-Java程序运行原理"><a href="#1-Java程序运行原理" class="headerlink" title="1 Java程序运行原理"></a>1 Java程序运行原理</h1><p><strong>Java与JVM</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419214439862.png" alt="image-20210419214439862"></p>
<h2 id="1-1-JVM运行时数据区"><a href="#1-1-JVM运行时数据区" class="headerlink" title="1.1 JVM运行时数据区"></a>1.1 JVM运行时数据区</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419214620464.png" alt="image-20210419214620464"></p>
<p><strong>线程共享∶</strong>所有线程能访问这块内存数据，随虚拟机或者GC而创建和销毁</p>
<p><strong>线程独占∶</strong> 每个线程都会有它独立的空间，随线程生命周期而创建和销毁  </p>
<h3 id="1-1-1-方法区"><a href="#1-1-1-方法区" class="headerlink" title="1.1.1 方法区"></a>1.1.1 方法区</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419214728568.png" alt="image-20210419214728568"></p>
<ul>
<li><p>作用∶ 存储加载的类信息、常量、静态变量、JIT编译后的代码等数据 </p>
</li>
<li><p>JDK7中的永久代 和 方法区 是否等价?<br>《Java虚拟机规范》只是规定了有方法区这么个概念和它的作用，并没有规定如何去实现它。在HotSpot上把GC分代收集扩展至方法区，或者说使用永久代来实现方法区。因此，我们得到了结论，永久代是HotSpot的概念，方法区是Java虚拟机规范中的定义，是一种规范，而永久代是一种实现，一个是标准一个是实现。</p>
</li>
<li><p>GC∶ 方法区存在垃圾回收，但回收频率低：<br>回收主要针对常量池的回收，和类型的卸载；<br>当方法区无法满足内存需求时，报OOM。</p>
</li>
</ul>
<p> </p>
<h3 id="1-1-2-堆内存"><a href="#1-1-2-堆内存" class="headerlink" title="1.1.2 堆内存"></a>1.1.2 堆内存</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419215414041.png" alt="image-20210419215414041"></p>
<p>作用∶ 唯一的目的就是存放对象实例，几乎所有的对象、数组都在这里存放 </p>
<p>对于大多数应用来说，堆是，JVM管理的内存中最大的一块内存区域，也是最容易OOM的区域</p>
<p> 大多数JVM都将堆实现为大小可扩展的， （通过-Xmx、-Xms控制）</p>
<h3 id="1-1-3-live-or-dir"><a href="#1-1-3-live-or-dir" class="headerlink" title="1.1.3 live or dir"></a>1.1.3 live or dir</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419215700259.png" alt="image-20210419215700259"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419215720074.png" alt="image-20210419215720074"></p>
<p>​	<strong>引用计数器算法，</strong>存在两个对象相互引用的问题</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419215733904.png" alt="image-20210419215733904"></p>
<p>​	<strong>可达性分析算法</strong>：主流的商用程序语言(Java、C#)都是通过<strong>可达性分析算法</strong>来判定对象是否存活的，<strong>GC Roots可以是</strong>：1、虚拟机栈； 2、方法中静态属性引用的对象； 3、方法区中常量引用的对象； Native方法引用的对象。</p>
<h3 id="1-1-4-虚拟机栈"><a href="#1-1-4-虚拟机栈" class="headerlink" title="1.1.4 虚拟机栈"></a>1.1.4 虚拟机栈</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419215842865.png" alt="image-20210419215842865"></p>
<p>​	<strong>虚拟机栈</strong>：线程中方法执行的模型，每个方法执行时，就会在虚拟机栈中创建一个<strong>栈帧</strong>，每个方法从调用到执行的过程，就对应着<strong>栈帧</strong>在虚拟机栈中从入栈到出栈的过程。</p>
<p>​	<strong>栈帧</strong>：虚拟机栈由多个栈帧（Stack Fframe）组成。一个线程会执行一个或多个方法， 一个方法对应一个栈帧。</p>
<h3 id="1-1-5-本地方法栈"><a href="#1-1-5-本地方法栈" class="headerlink" title="1.1.5 本地方法栈"></a>1.1.5 本地方法栈</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419220009835.png" alt="image-20210419220009835"></p>
<p>​	<strong>本地方法栈：</strong>和虚拟机栈功能类似，虚拟机栈是为虚拟机执行JAVA方法而准备的，本地方法栈是为虚拟机使用Native本地方法而准备的。</p>
<p>《Java虚拟机规范》中对Native方法使用的语言、使用方式与数据结构没有强制规定。</p>
<p>HotSpot虚拟机中虚拟机栈和本地方法栈合二为一。</p>
<h3 id="1-1-6-程序计数器"><a href="#1-1-6-程序计数器" class="headerlink" title="1.1.6 程序计数器"></a>1.1.6 程序计数器</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419220112235.png" alt="image-20210419220112235"></p>
<p>​	<strong>程序计数器</strong>（Program Counter Register）记录当前线程执行字节码的位置，<strong>字节码解释器工作</strong>时，就是通过改变计数器的值来选取<strong>下一条</strong>需要执行的字节码指令。</p>
<p>​	如果执行java方法，存储的是字节码指令地址，如果执行Native方法，则计数器值为空。</p>
<p>​	程序计数器是唯一一个在《JVM规范》中<strong>没有任何OOM的区域</strong>。</p>
<h3 id="1-1-7-直接内存（不属于JVM内存区域）"><a href="#1-1-7-直接内存（不属于JVM内存区域）" class="headerlink" title="1.1.7 直接内存（不属于JVM内存区域）"></a>1.1.7 直接内存（不属于JVM内存区域）</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419220232148.png" alt="image-20210419220232148"></p>
<p>​	直接内存<strong>不是JVM运行时数据区的一部分</strong>，也不是《Java虚拟机规范》中定义的内存区域，是我们常说的堆外内存。</p>
<p>​	JDK1.4 引入NIO，它可以使用<strong>Native函数库</strong>直接分配堆外内存，然后通过一个存在在Java堆中的DirectByteBuffer对象作为操作这块内存区域的引用进行操作。</p>
<p>​	直接内存不受Java堆大小限制，当内存总和大于机器物理内存时，会OOM。</p>
<h2 id="1-2-Java类文件结构"><a href="#1-2-Java类文件结构" class="headerlink" title="1.2 Java类文件结构"></a>1.2 Java类文件结构</h2><h3 id="1-2-1-示例代码"><a href="#1-2-1-示例代码" class="headerlink" title="1.2.1 示例代码"></a>1.2.1 示例代码</h3><p>思考：这样一段代码，如何在JVM中执行？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NUMBER</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> x/y;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">envName</span> <span class="operator">=</span> <span class="string">&quot;JAVA_HOME&quot;</span>;</span><br><span class="line">        stu.age = a;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> System.getenv(envName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-class文件结构"><a href="#1-2-2-class文件结构" class="headerlink" title="1.2.2 class文件结构"></a>1.2.2 class文件结构</h3><p>​	class文件包含JAVA程序执行的字节码；数据严格按照格式紧凑排列在class文件中的二进制流，中间无任何分隔符；u1、u2、u4、u8都是无符号数，info结尾都是表，要搞懂这个，可以看《深入理解Java虚拟机》第六章。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419221236624.png" alt="image-20210419221236624"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419221256273.png" alt="image-20210419221256273"></p>
<h3 id="1-2-3-Class文件结构-全限定名、简单名称、描述符"><a href="#1-2-3-Class文件结构-全限定名、简单名称、描述符" class="headerlink" title="1.2.3 Class文件结构 - 全限定名、简单名称、描述符"></a>1.2.3 Class文件结构 - 全限定名、简单名称、描述符</h3><p>​	<strong>全限定名</strong>：把类全名中的. 替换成&#x2F;，例如com&#x2F;study&#x2F;concurrent&#x2F;Demo1；</p>
<p>​	<strong>简单名称</strong>：是指没有类型和参数修饰的方法或者字段名称，如 public int inc(){} ，简单名称就是inc， public int age 字段，简单名称就是age</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419221532706.png" alt="image-20210419221532706"></p>
<p>​	<strong>描述符</strong>： 比较复杂，描述符的偶用是用来描述字段的数据类型、方法的参数列表（包括数量、类型以及顺序）和返回值。如“int[]”将被标记为“[I”，java.lang.String[][] ，被标记为“[[Ljava&#x2F;lang&#x2F;String；”；java.lang.String toString() 的描述符为()Ljava&#x2F;lang&#x2F;String</p>
<h3 id="1-2-4-属性表集合"><a href="#1-2-4-属性表集合" class="headerlink" title="1.2.4 属性表集合"></a>1.2.4 属性表集合</h3><p>在Class文件、字段表、方法表都可以携带自己的属性表集合，以用于描述某些场景专有的信息。</p>
<p>不像其他表，<strong>属性表的排列没有严格的顺序，只要不与已有属性名重复即可</strong></p>
<p>任何人实现的编译器都可以向属性表中写入自己的属性信息，<strong>但JVM只认识自己预定义的</strong>21种属性，JVM会忽略不认识的属性。</p>
<p>详见《深入理解Java虚拟机》P180 表6-13</p>
<h3 id="1-2-5-class文件结构-程序入口main方法"><a href="#1-2-5-class文件结构-程序入口main方法" class="headerlink" title="1.2.5 class文件结构 - 程序入口main方法"></a>1.2.5 class文件结构 - 程序入口main方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -verbose Demo1.class</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419222633914.png" alt="image-20210419222633914"></p>
<h2 id="1-3-Java程序完整运行分析"><a href="#1-3-Java程序完整运行分析" class="headerlink" title="1.3 Java程序完整运行分析"></a>1.3 Java程序完整运行分析</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419223914527.png" alt="image-20210419223914527"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224313506.png" alt="image-20210419224313506"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224336344.png" alt="image-20210419224336344"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224356981.png" alt="image-20210419224356981"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224409313.png" alt="image-20210419224409313"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224426052.png" alt="image-20210419224426052"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224455891.png" alt="image-20210419224455891"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224520547.png" alt="image-20210419224520547"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224540425.png" alt="image-20210419224540425"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224608720.png" alt="image-20210419224608720"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224649866.png" alt="image-20210419224649866"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224710854.png" alt="image-20210419224710854"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224726305.png" alt="image-20210419224726305"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224755139.png" alt="image-20210419224755139"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224916387.png" alt="image-20210419224916387"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419224951567.png" alt="image-20210419224951567"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419225012459.png" alt="image-20210419225012459"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419225033967.png" alt="image-20210419225033967"></p>
<h1 id="2-线程状态"><a href="#2-线程状态" class="headerlink" title="2 线程状态"></a>2 线程状态</h1><h2 id="2-1-线程6种状态"><a href="#2-1-线程6种状态" class="headerlink" title="2.1 线程6种状态"></a>2.1 线程6种状态</h2><p>6个状态定义：java.lang.Thread.State</p>
<ol>
<li><p>New：尚未启动的线程的线程状态。</p>
</li>
<li><p>Runnable：可运行线程的线程状态，等待CPU调度。</p>
</li>
<li><p>Blocked：线程阻塞等待监视器锁定的线程状态。<br>处于synchronized同步代码块或方法中被阻塞。</p>
</li>
<li><p>Waiting：线程等待的线程状态。<br>不带timeout参数的方式调用Object.wait、Thread.join、LockSupport.park</p>
</li>
<li><p>Timed Waiting：具有指定等待时间的等待线程的线程状态。下列带超时的方式：<br>Thread.sleep、Object.wait、Thread.join、LockSupport.parkNanos、LockSupport.parkUntil</p>
</li>
<li><p>Terminated：终止线程的线程状态。线程正常完成执行或者出现异常。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210419225527439.png" alt="image-20210419225527439"></p>
<h2 id="2-2-终止线程-Stop"><a href="#2-2-终止线程-Stop" class="headerlink" title="2.2 终止线程 - Stop"></a>2.2 终止线程 - Stop</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo3_stop</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);     <span class="comment">// 休眠1秒，确保i变量自增成功</span></span><br><span class="line">        thread.stop(); <span class="comment">// i=1 j=0，无法保证同步代码块里面数据的一致性，破坏了线程安全</span></span><br><span class="line">        <span class="comment">// thread.interrupt(); // i=1 j=1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (thread.isAlive()) &#123;&#125;  <span class="comment">// 确保线程已经终止</span></span><br><span class="line">        thread.print();     <span class="comment">// 输出结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            ++i;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            ++j;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;锁释放。。。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;i=&quot;</span> + i + <span class="string">&quot; j=&quot;</span> + j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>理想输出：i&#x3D;0 j&#x3D;0</p>
<p>程序执行结果：i&#x3D;1 j&#x3D;0</p>
<p>没有保证同步代码块里面数据的一致性，破坏了线程安全</p>
<p><strong>Stop∶</strong> 但是可能导致线程安全问题，JDK不建议用。 </p>
<p><strong>Destroy∶</strong> JDK未实现该方法。</p>
<h2 id="2-3-终止线程-interrupt"><a href="#2-3-终止线程-interrupt" class="headerlink" title="2.3 终止线程 - interrupt"></a>2.3 终止线程 - interrupt</h2><p>如果目标线程在调用Object class的wait()、wait(long)或wait(long, int)方法、join()、join(long, int)、join(long, int)、sleep(long, int)或sleep(long, int)方法时被阻塞。此时线程被调用interrupt方法后，该线程的<strong>中断状态将被清除</strong>，抛出InterruptedException异常。</p>
<p>如果目标线程是被I&#x2F;O 或者NIO中的Channel所阻塞，同样，I&#x2F;O操作会被中断或者返回特殊异常值。达到终止线程的目的。</p>
<p>如果以上条件都不满足，则会设置此线程的中断状态。</p>
<p>stop改成interrupt后，最终输出为“i&#x3D;1 j&#x3D;1”，数据一致。</p>
<h2 id="2-4-正确的线程终止-标志位"><a href="#2-4-正确的线程终止-标志位" class="headerlink" title="2.4 正确的线程终止 - 标志位"></a>2.4 正确的线程终止 - 标志位</h2><p>代码逻辑中，增加一个判断，用来控制线程执行的中止。如下面Demo4示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo4_FlagControl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (flag) &#123; <span class="comment">// 判断是否运行</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;运行中&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3秒之后，将状态标志改为False，代表不继续运行</span></span><br><span class="line">        Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;程序运行结束&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-线程封闭"><a href="#3-线程封闭" class="headerlink" title="3 线程封闭"></a>3 线程封闭</h1><h2 id="3-1-线程封闭概念"><a href="#3-1-线程封闭概念" class="headerlink" title="3.1 线程封闭概念"></a>3.1 线程封闭概念</h2><p>多线程访问共享可变数据时，涉及到线程间数据同步的问题。</p>
<p><strong>并不是所有时候，都要用到共享数据</strong>，若数据都被<strong>封闭</strong>在<strong>各自的线程之中</strong>，就不需要同步，这种通过<strong>将数据封闭在线程中</strong>而避免使用同步的技术称为<strong>线程封闭</strong>。</p>
<h2 id="3-2-ThreadLocal实现线程封闭"><a href="#3-2-ThreadLocal实现线程封闭" class="headerlink" title="3.2 ThreadLocal实现线程封闭"></a>3.2 ThreadLocal实现线程封闭</h2><p>ThreadLocal是Java里一种特殊的变量。</p>
<p>它是一个线程级别变量，每个线程都有一个ThreadLocal就是<strong>每个线程都拥有了自己独立的一个变量</strong>，<strong>竞争条件</strong>被彻底消除了，在并发模式下是绝对安全的变量。</p>
<p>用法：ThreadLocal<T> var &#x3D; new ThreadLocal<T>();</p>
<p>​	会自动在每一个线程上创建一个T的<strong>副本</strong>，副本之间彼此独立，互不影响。可以用ThreadLocal存储一些参数，以便在线程中多个方法中使用，用来代替方法传参的做法。</p>
<p>实在难以理解的，可以理解为，JVM维护了一个Map&lt;Thread, T&gt;，每个线程要用这个T的时候，用当前的线程去Map里面取。仅作为一个概念理解</p>
<h2 id="3-3-栈封闭"><a href="#3-3-栈封闭" class="headerlink" title="3.3 栈封闭"></a>3.3 栈封闭</h2><p>局部变量的固有属性之一就是封闭在线程中。</p>
<p>它们位于执行线程的栈中，其他线程无法访问这个栈。</p>
<h1 id="4-CPU缓存和内存屏障"><a href="#4-CPU缓存和内存屏障" class="headerlink" title="4 CPU缓存和内存屏障"></a>4 CPU缓存和内存屏障</h1><h2 id="4-1-CPU性能优化手段-缓存"><a href="#4-1-CPU性能优化手段-缓存" class="headerlink" title="4.1 CPU性能优化手段 - 缓存"></a>4.1 CPU性能优化手段 - 缓存</h2><p>为了提高程序运行的性能，现代CPU在很多方面对程序进行了优化。</p>
<p>例如：CPU高速缓存。尽可能地避免<strong>处理器</strong>访问<strong>主内存</strong>的时间开销，处理器大多会利用**缓存(cache)**以提高性能</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420133445919.png" alt="image-20210420133445919"></p>
<p>CPU高速缓存中的数据是内存中的一小部分，但这一小部分是短时间内CPU即将访问的，当CPU调用大量数据时，就可避开内存直接从Cache中调用</p>
<h2 id="4-2-多级缓存"><a href="#4-2-多级缓存" class="headerlink" title="4.2 多级缓存"></a>4.2 多级缓存</h2><ul>
<li><p><strong>L1</strong> Cache是CPU第一层高速缓存，它的容量非常小，一般为32-256KB，<strong>提高容量</strong>所带来的技术难度增加和<strong>成本增加非常大</strong>。 </p>
</li>
<li><p><strong>L2</strong> 由于L1高速缓存的<strong>容量限制</strong>，为了<strong>再次</strong>提高CPU的运算速度，在CPU<strong>外部</strong>放置一高速存储器，即二级缓存，现在家庭用CPU容量最大的是4MB，而服务器和工作站上用CPU的L2高速缓存普遍大于4MB，有的高达8MB或者19MB。 </p>
</li>
<li><p><strong>L3</strong> 现在一般都是内置的。在拥有三级缓存的CPU中，只有约5%的数据需要从内存中调用，<strong>进一步提升了CPU效率</strong>，同时提升<strong>大数据量</strong>计算时处理器的性能。具有较大L3缓存的处理器提供更有效的<strong>文件系统缓存行为</strong>及较短消息和处理器队列长度。一般是多核共享一个L3缓存！</p>
</li>
</ul>
<p>CPU在读取数据时，先在L1中寻找，再从L2寻找，再从L3寻找，然后是内存，再后是外存储器。</p>
<h2 id="4-3-缓存同步协议"><a href="#4-3-缓存同步协议" class="headerlink" title="4.3 缓存同步协议"></a>4.3 缓存同步协议</h2><ul>
<li><p>多CPU读取同样的数据进行缓存，<strong>进行不同运算之后</strong>，最终写入主内存以<strong>哪个</strong>CPU为准？ </p>
</li>
<li><p>在这种高速缓存回写的场景下，有一个缓存一致性协议（MESI协议）多数CPU厂商对它进行了实现。 </p>
</li>
<li><p>多处理器时，单个CPU对缓存中数据进行了改动，需要通知给其他CPU。也就是意味着，CPU处理要控制自己的读写操作，还要监听其他CPU发出的通知，从而保证最终一致。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420133751803.png" alt="image-20210420133751803"></p>
<h2 id="4-4-CPU性能优化手段-运行时指令重排"><a href="#4-4-CPU性能优化手段-运行时指令重排" class="headerlink" title="4.4 CPU性能优化手段 - 运行时指令重排"></a>4.4 CPU性能优化手段 - 运行时指令重排</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420133936890.png" alt="image-20210420133936890"></p>
<p>指令重排的场景：当CPU<strong>写缓存时</strong>发现缓存区块正被其他CPU占用，为了提高CPU处理性能，可能将后面的<strong>读缓存命令优先执行</strong>。</p>
<p><strong>as-if-serial</strong>语义：<strong>指令重排时</strong>，不管怎么重排序,<strong>单个线程的执行结果不能被改变</strong>。</p>
<p>换句话说，编译器和处理器<strong>不会对存在数据依赖关系的操作做重排序</strong>。</p>
<h2 id="4-5-俩个问题"><a href="#4-5-俩个问题" class="headerlink" title="4.5 俩个问题"></a>4.5 俩个问题</h2><ol>
<li>CPU高速缓存下有一个问题：<br>缓存中的数据与主内存的数据并不是实时同步的，各CPU（或CPU核心）间缓存的数据也不是实时同步。<strong>在同一个时间点，各CPU所看到同一内存地址的数据的值可能是不一致的</strong>。 </li>
<li>CPU执行指令重排序优化下有一个问题：<br>虽然遵守了<strong>as-if-serial</strong>语义，单仅在单CPU自己执行的情况下能保证结果正确。<br>多核多线程中，指令逻辑无法分辨因果关联，可能出现<strong>乱序执行</strong>，导致程序运行结果错误。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420134133804.png" alt="image-20210420134133804"></p>
<h2 id="4-6-内存屏障"><a href="#4-6-内存屏障" class="headerlink" title="4.6 内存屏障"></a>4.6 内存屏障</h2><p>处理器提供了两个内存屏障指令（Memory Barrier）用于解决上述两个问题：</p>
<p><strong>写内存屏障（Store Memory Barrier）</strong>：在写指令后插入Store Barrier，能让写入缓存中的最新数据更新写入主内存，让其他线程可见。强制写入主内存，这种显示调用，CPU就不会因为性能考虑而去对指令重排。</p>
<p><strong>读内存屏障（Load Memory Barrier）</strong>：在读指令前插入Load Barrier，可以让高速缓存中的数据失效，强制从新从主内存加载数据。强制读取主内存内容，让CPU缓存与主内存保持一致，避免了缓存导致的一致性问题</p>
<h1 id="5-线程池原理"><a href="#5-线程池原理" class="headerlink" title="5 线程池原理"></a>5 线程池原理</h1><h2 id="5-1-为什么要用线程池"><a href="#5-1-为什么要用线程池" class="headerlink" title="5.1 为什么要用线程池"></a>5.1 为什么要用线程池</h2><p> <strong>线程是不是越多越好？</strong> </p>
<ol>
<li>线程不仅java中是一个对象，每个线程都有自己的工作内存，<ul>
<li>线程创建、销毁需要时间，消耗性能。</li>
<li>线程过多，会占用很多内存</li>
</ul>
</li>
<li>操作系统需要频繁切换线程上下文（大家都想被运行），影响性能。 </li>
<li>如果创建时间+ 销毁时间 &gt; 执行任务时间 就很不合算</li>
</ol>
<p><strong>线程池的推出，就是为了方便的控制线程数量</strong> </p>
<h2 id="5-2-线程池原理-概念"><a href="#5-2-线程池原理-概念" class="headerlink" title="5.2 线程池原理 - 概念"></a>5.2 线程池原理 - 概念</h2><ol>
<li><strong>线程池管理器</strong>：用于创建并管理线程池，包括创建线程池，销毁线程池，添加新任务； </li>
<li><strong>工作线程</strong>：线程池中线程，可以循环的执行任务，在没有任务时处于等待状态；</li>
<li><strong>任务接口</strong>：每个任务必须实现的接口，以供工作线程调度任务的执行，它主要规定了任务的入口，任务执行完后的收尾工作，任务的执行状态等； </li>
<li><strong>任务队列</strong>：用于存放没有处理的任务。提供一种缓冲机制。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420220755414.png" alt="image-20210420220755414"></p>
<h2 id="5-3-线程池-类的层次结构"><a href="#5-3-线程池-类的层次结构" class="headerlink" title="5.3 线程池 - 类的层次结构"></a>5.3 线程池 - 类的层次结构</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420220820200.png" alt="image-20210420220820200"></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>接口</td>
<td>Executor</td>
<td>最上层的接口，只定义了 execute</td>
</tr>
<tr>
<td>接口</td>
<td>ExecutorService</td>
<td>继承了Executor接口，拓展了Callable 、Future、关闭方法</td>
</tr>
<tr>
<td>接口</td>
<td>ScheduledExecutorService</td>
<td>继承了ExecutorService，增加了定时任务相关的方法</td>
</tr>
<tr>
<td>实现类</td>
<td>ThreadPoolExecutor</td>
<td>基础、标准的线程池<strong>实现</strong></td>
</tr>
<tr>
<td>实现类</td>
<td>ScheduledThreadPoolExecutor</td>
<td>继承了ThreadPoolExecutor，实现了ScheduledExecutorService中相关<strong>定时任务</strong>的方法</td>
</tr>
</tbody></table>
<h2 id="5-4-线程池API-–-ExecutorService接口"><a href="#5-4-线程池API-–-ExecutorService接口" class="headerlink" title="5.4 线程池API – ExecutorService接口"></a>5.4 线程池API – ExecutorService接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shutdown();</span><br><span class="line">shutdownNow();</span><br><span class="line">awaitTermination(<span class="type">long</span> timeout, TimeUnit unit)</span><br><span class="line">isTerminated();</span><br><span class="line">isShutdown()</span><br><span class="line">invokeAll(Collection&lt;? <span class="keyword">extends</span> <span class="title class_">Callable</span>&lt;T&gt;&gt; tasks);</span><br><span class="line">invokeAll(Collection&lt;? <span class="keyword">extends</span> <span class="title class_">Callable</span>&lt;T&gt;&gt; tasks, <span class="type">long</span> timeout, TimeUnit unit);</span><br><span class="line">invokeAny(Collection&lt;? <span class="keyword">extends</span> <span class="title class_">Callable</span>&lt;T&gt;&gt; tasks);</span><br><span class="line">invokeAny(Collection&lt;? <span class="keyword">extends</span> <span class="title class_">Callable</span>&lt;T&gt;&gt; tasks, <span class="type">long</span> timeout, TimeUnit unit);</span><br><span class="line">submit(Callable&lt;T&gt; task);</span><br><span class="line">submit(Runnable task);</span><br><span class="line">submit(Runnable task, T result);</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="5-5-线程池API-–-ScheduledExecutorService接口"><a href="#5-5-线程池API-–-ScheduledExecutorService接口" class="headerlink" title="5.5 线程池API – ScheduledExecutorService接口"></a>5.5 线程池API – ScheduledExecutorService接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建并执行 一次性定时任务</span></span><br><span class="line">schedule(Callable&lt;V&gt; callable, <span class="type">long</span> delay, TimeUnit unit);</span><br><span class="line">schedule(Runnable command, <span class="type">long</span> delay, TimeUnit unit);</span><br><span class="line"><span class="comment">// 创建并执行一个 周期性任务,到initialDelay后，任务会第一次被执行</span></span><br><span class="line">scheduleAtFixedRate(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> period, TimeUnit unit);</span><br><span class="line">scheduleWithFixedDelay(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> delay, TimeUnit unit)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420221522185.png" alt="image-20210420221522185"></p>
<h2 id="5-6-ThreadPoolExecutor-典型使用"><a href="#5-6-ThreadPoolExecutor-典型使用" class="headerlink" title="5.6 ThreadPoolExecutor 典型使用"></a>5.6 ThreadPoolExecutor 典型使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>( </span><br><span class="line">	<span class="number">5</span>, <span class="comment">//核心线程数 </span></span><br><span class="line">	<span class="number">10</span>, <span class="comment">//最大线程数 </span></span><br><span class="line">	<span class="number">5</span>, <span class="comment">//keepAliveTime,超过核心线程数的线程，超过keepAliveTime，这个线程就会被销毁 </span></span><br><span class="line">	TimeUnit.SECONDS, <span class="comment">//keepAliveTime 的时间单位 </span></span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;() <span class="comment">//传入无界的等待队列 </span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>任务数量比corePoolSize、maximumPoolSize都大，线程数却保持为5个，那么，最大线程数存在的意义是什么？？</p>
<h2 id="5-7-线程池原理-–-任务execute过程"><a href="#5-7-线程池原理-–-任务execute过程" class="headerlink" title="5.7 线程池原理 – 任务execute过程"></a>5.7 线程池原理 – 任务execute过程</h2><ol>
<li>是否达到核心线程数量？没达到，创建一个工作线程来执行任务。 </li>
<li>工作队列是否已满？没满，则将新提交的任务存储在工作队列里。</li>
<li>是否达到线程池最大数量？没达到，则创建一个新的工作线程来执行任务。 </li>
<li>最后，执行拒绝策略来处理这个任务。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420221840739.png" alt="image-20210420221840739"></p>
<h2 id="5-8-线程池API-–-Executors工具类"><a href="#5-8-线程池API-–-Executors工具类" class="headerlink" title="5.8 线程池API – Executors工具类"></a>5.8 线程池API – Executors工具类</h2><p>你可以自己实例化线程池，也可以用Executors 创建线程池的工厂类，常用方法如下：</p>
<p><strong>newFixedThreadPool(int nThreads)</strong> 创建一个固定大小、任务队列容量无界的线程池。核心线程数&#x3D;最大线程数。 </p>
<p><strong>newCachedThreadPool()</strong> 创建的是一个大小无界的缓冲线程池。它的任务队列是一个同步队列。任务加入到池中，如果池中有空闲线程，则用空闲线程执行，如无则创建新线程执行。池中的线程空闲超过60秒，将被销毁释放。线程数随任 务的多少变化。适用于执行耗时较小的异步任务。池的核心线程数&#x3D;0 ，最大线程数&#x3D; Integer.MAX_VALUE </p>
<p><strong>newSingleThreadExecutor()</strong> 只有一个线程来执行无界任务队列的单一线程池。该线程池确保任务按加入的顺序一个一个依次执行。当唯一的线程因任务异常中止时，将创建一个新的线程来继续执行后续的任务。与newFixedThreadPool(1)的区别在于，单一线程池的池大小在newSingleThreadExecutor方法中硬编码，不能再改变的。 </p>
<p><strong>newScheduledThreadPool(int corePoolSize)</strong> 能定时执行任务的线程池。该池的核心线程数由参数指定，最大线程数&#x3D;Integer.MAX_VALUE</p>
<h2 id="5-9-线程数量"><a href="#5-9-线程数量" class="headerlink" title="5.9 线程数量"></a>5.9 线程数量</h2><p><strong>如何确定合适数量的线程？</strong></p>
<p>计算型任务：cpu数量的1-2倍</p>
<p>IO型任务：相对比计算型任务，需多一些线程，要根据具体的IO阻塞时长进行考量决定。也可考虑根据需要在一个最小数量和最大数量间自动增减线程数。 </p>
<p>如tomcat中默认的最大线程数为：200。</p>
<h2 id="5-10-线程池源码探究"><a href="#5-10-线程池源码探究" class="headerlink" title="5.10 线程池源码探究"></a>5.10 线程池源码探究</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedSizeThreadPool</span> &#123;</span><br><span class="line">    <span class="comment">//思考：需要做哪些准备工作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、需要一个任务仓库</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; blockingQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、 集合容器，存放工作线程</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Thread&gt; workers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、普通线程要执行多个task，咱们需要封装一下</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> FixedSizeThreadPool pool;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(FixedSizeThreadPool pool)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.pool = pool;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="built_in">this</span>.pool.isWorking || <span class="built_in">this</span>.pool.blockingQueue.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//如果没有任务，就阻塞等待任务</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.pool.isWorking)</span><br><span class="line">                        task = <span class="built_in">this</span>.pool.blockingQueue.take();</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        task = <span class="built_in">this</span>.pool.blockingQueue.poll();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (task != <span class="literal">null</span>)&#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 初始化线程池</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FixedSizeThreadPool</span><span class="params">(<span class="type">int</span> poolSize, <span class="type">int</span> queueSize)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (poolSize&lt;=<span class="number">0</span> || queueSize&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;非法参数&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.blockingQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(queueSize);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.workers = Collections.synchronizedList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;poolSize; i++)&#123;</span><br><span class="line">            <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="built_in">this</span>);   <span class="comment">//实例化Worker对象，实际上是一个Thread对象</span></span><br><span class="line">            worker.start();         <span class="comment">//启动worker对象，实际上就是启动一个线程</span></span><br><span class="line">            workers.add(worker);    <span class="comment">//讲worker加到workers集合中，方便管理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供提交任务的接口 非阻塞</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">submit</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isWorking)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.blockingQueue.offer(task);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对外提供提交任务的接口 阻塞</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isWorking) <span class="built_in">this</span>.blockingQueue.put(task);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭线程池</span></span><br><span class="line">    <span class="comment">//a. 禁止往队列提交任务</span></span><br><span class="line">    <span class="comment">//b. 等待仓库中的任务执行</span></span><br><span class="line">    <span class="comment">//c. 关闭的时候，再去那任务就不用阻塞，因为不会有新任务来了</span></span><br><span class="line">    <span class="comment">//d. 关闭的时候，阻塞的线程，就要强行中断</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isWorking</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.isWorking = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread: workers)&#123;</span><br><span class="line">            <span class="keyword">if</span> (thread.getState().equals( Thread.State.WAITING) ||</span><br><span class="line">                    thread.getState().equals( Thread.State.BLOCKED))&#123;</span><br><span class="line">                thread.interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-线程间通信"><a href="#6-线程间通信" class="headerlink" title="6 线程间通信"></a>6 线程间通信</h1><h2 id="6-1-通信方式"><a href="#6-1-通信方式" class="headerlink" title="6.1 通信方式"></a>6.1 通信方式</h2><p>数据交互：</p>
<ul>
<li>文件共享</li>
<li>网络共享 </li>
<li>共享变量</li>
</ul>
<p>线程间协作：</p>
<ul>
<li>jdk提供的线程协调API，例如：<del>suspend&#x2F;resume</del>、wait&#x2F;notify、park&#x2F;unpark</li>
</ul>
<h2 id="6-2-文件共享"><a href="#6-2-文件共享" class="headerlink" title="6.2 文件共享"></a>6.2 文件共享</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210420224947131.png" alt="image-20210420224947131"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;Demo7.log&quot;</span>); <span class="comment">// 线程1 - 写入数据</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;当前时间&quot;</span> + String.valueOf(System.currentTimeMillis());</span><br><span class="line">            Files.write(path, content.getBytes());</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="comment">// 线程2 - 读取数据</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">byte</span>[] allBytes = Files.readAllBytes(path);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(allBytes));</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-变量共享"><a href="#6-3-变量共享" class="headerlink" title="6.3 变量共享"></a>6.3 变量共享</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210421130715716.png" alt="image-20210421130715716"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 线程1 - 写入数据</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            content = <span class="string">&quot;当前时间:&quot;</span> + String.valueOf(System.currentTimeMillis());</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="comment">// 线程2 - 读取数据</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            System.out.println(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-4-线程协作-场景"><a href="#6-4-线程协作-场景" class="headerlink" title="6.4 线程协作 - 场景"></a>6.4 线程协作 - 场景</h2><p>示例：小朋友去买冰激凌，没有冰激凌，就等着。店员发现没有冰激凌，就做了一个，通知小朋友。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210421131717917.png" alt="image-20210421131717917"></p>
<p>这是多线程协作的典型场景：生产者-消费者 模型。（线程阻塞、线程唤醒）</p>
<p>JDK中对于需要多线程协作完成某一任务的场景，提供了对应API支持。</p>
<h2 id="6-5-API-被弃用的suspend和resume"><a href="#6-5-API-被弃用的suspend和resume" class="headerlink" title="6.5 API - 被弃用的suspend和resume"></a>6.5 API - 被弃用的suspend和resume</h2><p>作用：调用suspend挂起目标线程，通过resume可以恢复线程执行。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">iceCream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">suspendResumeTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 启动线程</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line">            Thread.currentThread().suspend();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    consumerThread.start();</span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>(); </span><br><span class="line">    <span class="comment">//店员做好了冰激凌 </span></span><br><span class="line">    consumerThread.resume();</span><br><span class="line">    <span class="comment">// 通知小朋友</span></span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>被弃用的主要原因是，<strong>容易写出死锁的代码</strong> </p>
<h3 id="6-5-1-suspend-resume-死锁示例1"><a href="#6-5-1-suspend-resume-死锁示例1" class="headerlink" title="6.5.1 suspend&#x2F;resume - 死锁示例1"></a>6.5.1 suspend&#x2F;resume - 死锁示例1</h3><p><strong>在同步代码中使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2_SyncDeadLock</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (Demo7_SuspendResume.class)&#123;</span><br><span class="line">                    Thread.currentThread().suspend();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    consumerThread.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();      <span class="comment">//店员做好了冰激凌</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Demo7_SuspendResume.class)&#123;</span><br><span class="line">        consumerThread.resume();    <span class="comment">//通知小朋友</span></span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(Demo7_SuspendResume.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-5-2-suspend-resume-死锁示例2"><a href="#6-5-2-suspend-resume-死锁示例2" class="headerlink" title="6.5.2 suspend&#x2F;resume - 死锁示例2"></a>6.5.2 suspend&#x2F;resume - 死锁示例2</h3><p> <strong>suspend 比 resume后执行时，会出现死锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3_OrderDeadLock</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">6000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Thread.currentThread().suspend();  <span class="comment">//挂起</span></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    consumerThread.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();      <span class="comment">//店员做好了冰激凌</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">    consumerThread.resume();    <span class="comment">//通知小朋友</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-6-wait-notify机制"><a href="#6-6-wait-notify机制" class="headerlink" title="6.6 wait&#x2F;notify机制"></a>6.6 wait&#x2F;notify机制</h2><p><strong>wait</strong>方法导致当前线程等待，加入该对象的等待集合中，并且放弃当前持有的对象锁。</p>
<p><strong>notify&#x2F;notifyAll</strong>方法唤醒一个或所有正在等待这个对象锁的线程。 </p>
<p><strong>注意1：</strong>虽然会wait自动解锁，但是对顺序有要求， 如果在notify被调用之后，才开始wait方法的调用，线程会永远处于WAITING状态。</p>
<p><strong>注意2：</strong>这些方法只能由同一对象锁的持有者线程调用，也就是写在同步块里面，否则会抛出IllegalMonitorStateException异常。</p>
<h3 id="6-6-1-wait-notify-示例代码"><a href="#6-6-1-wait-notify-示例代码" class="headerlink" title="6.6.1 wait&#x2F;notify - 示例代码"></a>6.6.1 wait&#x2F;notify - 示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1_normal</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//若没有冰激凌</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="comment">//店员做了一个冰激凌</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">//拿到小朋友加的钥匙，去叫他</span></span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">        System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-6-2-wait-notify-死锁示例"><a href="#6-6-2-wait-notify-死锁示例" class="headerlink" title="6.6.2 wait&#x2F;notify 死锁示例"></a>6.6.2 wait&#x2F;notify 死锁示例</h3><p> <strong>notify 比 wait 后执行时，会出现死锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2_DeadLock</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//若没有冰激凌</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">    &#125;).start();</span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="comment">// 店员做了一个冰激凌</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 通知小朋友</span></span><br><span class="line">        <span class="built_in">this</span>.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-7-park-unpark机制"><a href="#6-7-park-unpark机制" class="headerlink" title="6.7 park&#x2F;unpark机制"></a>6.7 park&#x2F;unpark机制</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20210421141414103.png" alt="image-20210421141414103"></p>
<p>线程调用park则等待“许可” ，unpark方法为指定线程提供“许可(permit)”。</p>
<p>调用unpark之后，再调用park，线程会直接运行</p>
<p>提前调用的unpark不叠加，连续多次调用unpark后，第一次调用park后会拿到“许可”直接运行，后续调用会进入等待。 </p>
<h3 id="6-7-1-park-unpark-示例代码"><a href="#6-7-1-park-unpark-示例代码" class="headerlink" title="6.7.1 park&#x2F;unpark - 示例代码"></a>6.7.1 park&#x2F;unpark - 示例代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1_normal</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span> (iceCream == <span class="literal">null</span>) &#123;     <span class="comment">// 若没有冰激凌</span></span><br><span class="line">            System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    consumerThread.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();    <span class="comment">//店员做了一个冰激凌</span></span><br><span class="line"></span><br><span class="line">    LockSupport.unpark(consumerThread);     <span class="comment">//通知小朋友</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-7-2-park-unpark-死锁示例"><a href="#6-7-2-park-unpark-死锁示例" class="headerlink" title="6.7.2 park&#x2F;unpark - 死锁示例"></a>6.7.2 park&#x2F;unpark - 死锁示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2_DeadLock</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//开启一个线程，代表小朋友</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">consumerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span> (iceCream == <span class="literal">null</span>) &#123;     <span class="comment">// 若没有冰激凌</span></span><br><span class="line">            System.out.println(<span class="string">&quot;没有冰激凌，小朋友不开心，等待...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;   <span class="comment">// 若拿到锁</span></span><br><span class="line">                LockSupport.park();     <span class="comment">//执行park</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;小朋友买到冰激凌，开心回家&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    consumerThread.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">3000L</span>);    <span class="comment">// 3秒之后</span></span><br><span class="line">    iceCream = <span class="keyword">new</span> <span class="title class_">Object</span>();    <span class="comment">//店员做了一个冰激凌</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;   <span class="comment">// 争取到锁以后，才能恢复consumerThread</span></span><br><span class="line">        LockSupport.unpark(consumerThread);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;通知小朋友&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-8-总结"><a href="#6-8-总结" class="headerlink" title="6.8 总结"></a>6.8 总结</h2><table>
<thead>
<tr>
<th>协作方式</th>
<th>死锁方式1（锁）</th>
<th>死锁方式2（先唤醒，再挂起）</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>suspend&#x2F;resume</td>
<td>死锁</td>
<td>死锁</td>
<td>弃用</td>
</tr>
<tr>
<td>wait&#x2F;notify</td>
<td>不死锁</td>
<td>死锁</td>
<td>只用于synchronized关键字</td>
</tr>
<tr>
<td>park&#x2F;unpark</td>
<td>死锁</td>
<td>不死锁</td>
<td></td>
</tr>
</tbody></table>
<h2 id="6-9-伪唤醒"><a href="#6-9-伪唤醒" class="headerlink" title="6.9 伪唤醒"></a>6.9 伪唤醒</h2><p><strong>警告!!!</strong> 之前代码中用 if 语句来判断，是否进入等待状态，这样的做法是错误的！	</p>
<p>官方建议应该在循环中检查等待条件，原因是处于等待状态的线程可能会收到错误警报和伪唤醒，如果不在循环中检查等待条件，程序就会在没有满足结束条件的情况下退出。</p>
<p><strong>伪唤醒</strong>是指线程并非因为notify、notifyall、unpark等api调用而意外唤醒，是更底层原因导致的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// park</span></span><br><span class="line"><span class="keyword">while</span> (&lt;条件判断&gt;)</span><br><span class="line">    LockSupport.park();</span><br><span class="line">    <span class="comment">// 执行后续操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-10-多线程使用场景"><a href="#6-10-多线程使用场景" class="headerlink" title="6.10 多线程使用场景"></a>6.10 多线程使用场景</h2><p>场景1：<strong>批量处理任务</strong></p>
<ul>
<li>向大量（100w以上）的用户发送邮件</li>
<li>处理<strong>大批量</strong>文件</li>
<li>处理<strong>大文件</strong>时，文件分段处理</li>
</ul>
<p>场景2：<strong>实现异步</strong></p>
<ul>
<li><strong>快速响应用户</strong>，入浏览器请求网页、图片时</li>
<li>自动作业处理</li>
</ul>
<p>场景3：<strong>增大吞吐量</strong>，例如tomcat、数据库 等服务</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80/" data-id="clmcxecia0041u8wa0kbad02t" data-title="多线程基础" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-01-Java基础/01-多线程/02-Java内存模型" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/02-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" class="article-date">
  <time class="dt-published" datetime="2021-04-19T13:33:48.000Z" itemprop="datePublished">2021-04-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/02-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/">Java内存模型</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Java内存模型</p>
        
          <p class="article-more-link">
            <a href="/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/02-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/19/01-Java%E5%9F%BA%E7%A1%80/01-%E5%A4%9A%E7%BA%BF%E7%A8%8B/02-Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" data-id="clmcxecnx005fu8wadf9m5pvm" data-title="Java内存模型" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/11/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/13/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>