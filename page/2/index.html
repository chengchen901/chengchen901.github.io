<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-11-MySQL/02-MyCat/05-MyCat最佳实践" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/05-MyCat%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.895Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mycat最佳实践"><a href="#Mycat最佳实践" class="headerlink" title="Mycat最佳实践"></a>Mycat最佳实践</h1><h2 id="Mycat实施指南"><a href="#Mycat实施指南" class="headerlink" title="Mycat实施指南"></a>Mycat实施指南</h2><h3 id="实施流程"><a href="#实施流程" class="headerlink" title="实施流程"></a>实施流程</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160038.png"></p>
<p>了解Mycat 的能力，包括如下的方面：</p>
<ul>
<li>Mycat 的起源和解决的目标；</li>
<li>Mycat 在数据库中间件方面的独特功能和定位；</li>
<li>Mycat 的实际案例情况；</li>
<li>Mycat 的优点和不足；</li>
<li>Mycat 所提供的监控和测试工具；</li>
<li>Mycat 社区的动态。</li>
</ul>
<p>其中，关于分片规则的支持和扩展、多数据库支持、SQL 拦截和注解、跨库Join、读写分离、缓存功能、高 可用性等方面需要比较深入的学习和理解，有助于正确的使用Mycat 来解决当前的业务问题。</p>
<p>接下来是分析当前业务，具体内容包括如下几个方面：</p>
<ul>
<li>数据模型：重点关注数据的增长模式（实时大量增长还是缓慢增长）和规律、数据之间的关联关系；</li>
<li>数据访问模式：通过抓取系统中实际执行的SQL，分析其频率、响应时间、对系统性能和功能的影响程度；</li>
<li>数据可靠性的要求：系统中不同数据表的可靠性要求，以及操作模式；</li>
<li>事务的要求：系统中哪些业务操作是严格事务的，哪些是普通事务或可以无事务的；</li>
<li>数据备份和恢复问题：目前的备份模式，对系统的压力等。</li>
</ul>
<p>数据的模型和访问模式在很大程度上决定了未来数据分片的模式，包括哪些表用全局表、哪些用ER 分片、哪 些用范围分片规则、哪些用一致性Hash 或自定义方式。而数据可靠性的要求，则影响到Mycat 后端是采用普通 的MySQL 主从还是用Gluster 多写模式，事务性要求需要相关的表或者SQL 尽量不会垮分片执行，对于以后制 定本项目的编程约束有重要意义。</p>
<p>分表方案则需要确定如下一些问题：</p>
<ul>
<li>哪些表要分片、什么分片规则、依赖关联关系如何解决；</li>
<li>数据迁移和扩容的手段。</li>
</ul>
<p>建议根据业务分析的结果，确定两套比较合适分表方案，然后进行性能测试，选出最佳的分表方案，性能测 试可以采用Mycat 自带的超级工具，此工具在前面提到过，可以模拟接近真实业务数据的数据，并随机制造大量的数据供测试，是目前开源的最佳数据库性能测试工具。</p>
<p>在最终进入开发之前，架构师还需要给出一个编程约束，需要明确列出不能执行的SQL 语句，这些约束可能包括如下几种：</p>
<ul>
<li>跨越太多节点的查询语句；</li>
<li>不能Join 的表和相关的Join SQL；</li>
<li>很影响性能的复杂SQL；</li>
<li>对比较大的表的SQL 操作提示。</li>
</ul>
<p>最后在开发阶段，还应该做到如下几点</p>
<ul>
<li>一开始就按照最初的分片设计和数据规模，制造大量的随机数据，进行开发和测试，尽早发现性能问题；</li>
<li>对所有的SQL 进行统计分析，找出异常的SQL，包括跨越太多分片的SQL，以及执行缓慢的SQL，对这些SQL 进行分析和优化；</li>
<li>时刻关注性能问题。</li>
</ul>
<p>当项目上线后，通过Mycat Web 对系统进行监控，特别是服务的IO 和网络指标，除此之外，对Mycat 运行过程中的日志也要进行排查，告警信息可能是SQL 错误，可能是Mycat Bug，及时分析处理，并积极反馈给Mycat 社区，寻求帮助。</p>
<h3 id="后端存储的选择"><a href="#后端存储的选择" class="headerlink" title="后端存储的选择"></a>后端存储的选择</h3><p>Mysql 尽量用比较新的稳定版，当前来说5.6 和5.7 都是比较靠谱的一个选择，因为Mysq 这两个版本做了 大量优化。另外Mysql 的各种变种版本都可以考虑。以下是一些通用准则：</p>
<ul>
<li>对于非严格苛刻交易型的数据表，建议用MariaDB，这个版本目前在开源界很盛行，评价很高，percona 版 本也值得推荐，percona 有很多辅助的运维工具。</li>
<li>对于交易型的数据表，可以考虑Mysql 官方稳定版，若交易型的数据表要求可靠性非常高，比如是替代Oracle，也可以选择Galera Cluster 这种高可用的方案，他以一定的写入性能损失带来了数据的高可用和高并发访问。</li>
<li>根据数据的可靠性要求，可以采用各种数据同步方案，比如1 主多从，读写分离提升数据表的读的并发能力。</li>
<li>部分表可以用NoSQL 方式存储，而前端访问方式不变，Mycat 支持后端MongoDB 和很多NoSQL 系统，以提升查询能力</li>
<li>部分表可以采用MySQL 内存表，来提升查询和写入速度，替代部分复杂缓存方案。</li>
</ul>
<p>下面是一个可能的Mycat 部署方案，不同的表用不同的存储方式，让不同的表根据其访问模式，都达到最佳 状态。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226160700.png"></p>
<h3 id="Mycat-目前存在的限制"><a href="#Mycat-目前存在的限制" class="headerlink" title="Mycat 目前存在的限制"></a>Mycat 目前存在的限制</h3><p>部分SQL 还不能很好的支持</p>
<ul>
<li>除了分片规则相同、ER 分片、全局表、以及SharedJoin，其他表之间的Join 问题目前还没有很好的解决，需要自己编写Catlet 来处理。</li>
<li>不支持Insert into 中不包括字段名的SQL</li>
<li>insert into x select from y 的SQL，若x 与y 不是相同的分片规则，则不被支持，此时会涉及到跨分片转移。</li>
<li>跨分片的事务，目前只是弱XA 模式，还没完全实现XA 模式。</li>
<li>分片的Table，目前不能执行Lock Table 这样的语句，因为这种语句会随机发到某个节点，也不会全部分 片锁定，经常导致死锁问题，此类问题常常出现在sqldump 导入导出SQL数据的过程中。</li>
<li>目前sql 解析器采用Druid,再某些sql 例如order，group，sum ，count 条件下，如果这类操作会出现 兼容问题，比如： select t.name as name1 from test order by t.name 这条语句select 列的别名与order by 不一致解析器会出现异常，所以在对列加别名时候要注意这类操作异常，特别是由jpa 等类似的框架生成的语句会有兼容问题。</li>
</ul>
<p>开发框架方面，虽然支持Hibernate，但不建议使用Hibernate，而是建议Mybatis 以及直接JDBC 操作，原因Hibernat 无法控制SQL 的生成，无法做到对查询SQL 的优化，导致大数量下的性能问题。此外，事务方面，建议自己手动控制，查询语句尽量走自动提交事务模式，这样Mycat 的读写分离会被用到，提升性能很明显。</p>
<h2 id="Mycat高可用方案"><a href="#Mycat高可用方案" class="headerlink" title="Mycat高可用方案"></a>Mycat高可用方案</h2><h3 id="Mycat单点方案"><a href="#Mycat单点方案" class="headerlink" title="Mycat单点方案"></a>Mycat单点方案</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163346.png"></p>
<p><strong>单点的不足：</strong></p>
<ol>
<li>单点故障，整个系统不可用！</li>
<li>并发处理能力有上限！</li>
</ol>
<h3 id="高可用方案"><a href="#高可用方案" class="headerlink" title="高可用方案"></a>高可用方案</h3><p><strong>集群负载均衡：</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163432.png"></p>
<p><strong>HAproxy + keepalived+Mycat集群+DB主从同步复制 组成Mycat高可用系统</strong></p>
<p><strong>集群部署图示：</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226163501.png"></p>
<p><strong>集群部署图说明：</strong></p>
<ol>
<li>keepalived 和haproxy 必须装在同一台机器上（如192.168.8.91 机器上，keepalived 和haproxy 都要安装），keepalived 负责为该服务器抢占vip（虚拟ip），抢占到vip 后，对该主机的访问可以通过原来的ip（192.168.8.91）访问，也可以直接通过vip（192.168.8.108）访问。</li>
<li>192.168.8.92 上的keepalived 也会去抢占vip，抢占vip 时有优先级，配置keepalived.conf 中的 （priority 150 #数值愈大，优先级越高,192.168.8.92 上改为120，master 和slave 上该值配置不同）决定。但是一般哪台主机上的keepalived 服务先启动就会抢占到vip，即使是slave，只要先启动也能抢到。</li>
<li>haproxy 负责将对vip 的请求分发到mycat 上。起到负载均衡的作用，同时haproxy 也能检测到mycat 是否存活，haproxy 只会将请求转发到存活的mycat 上。</li>
<li>如果一台服务器（keepalived+haproxy 服务器）宕机，另外一台上的keepalived 会立刻抢占vip 并接管服务。</li>
<li>如果一台mycat 服务器宕机，haporxy 转发时不会转发到宕机的mycat 上，所以mycat 依然可用。</li>
</ol>
<h3 id="高可用安装部署"><a href="#高可用安装部署" class="headerlink" title="高可用安装部署"></a>高可用安装部署</h3><h4 id="haproxy-安装"><a href="#haproxy-安装" class="headerlink" title="haproxy 安装"></a>haproxy 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#useradd haproxy </span></span><br><span class="line"><span class="comment">#wget http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.25.tar.gz </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tar zxvf haproxy-1.4.25.tar.gz </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cd haproxy-1.4.25 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make TARGET=linux26 PREFIX=/usr/local/haproxy ARCH=x86_64 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make install PREFIX=/usr/local/haproxy </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cd /usr/local/haproxy </span></span><br><span class="line"><span class="comment">#chown -R haproxy.haproxy *</span></span><br></pre></td></tr></table></figure>

<h4 id="haproxy-cfg"><a href="#haproxy-cfg" class="headerlink" title="haproxy.cfg"></a>haproxy.cfg</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cd /usr/local/haproxy </span></span><br><span class="line"><span class="comment">#touch haproxy.cfg </span></span><br><span class="line"><span class="comment">#vi/usr/local/haproxy/haproxy.cfg </span></span><br><span class="line">global </span><br><span class="line"><span class="built_in">log</span> 127.0.0.1 local0 <span class="comment">##记日志的功能 </span></span><br><span class="line">maxconn 4096 </span><br><span class="line"><span class="built_in">chroot</span>/usr/local/haproxy </span><br><span class="line">user haproxy </span><br><span class="line">group haproxy </span><br><span class="line">daemon </span><br><span class="line">defaults </span><br><span class="line"><span class="built_in">log</span> global </span><br><span class="line">option dontlognull</span><br><span class="line">retries 3 </span><br><span class="line">option redispatch </span><br><span class="line">maxconn 2000 </span><br><span class="line">contimeout 5000 </span><br><span class="line">clitimeout 50000 </span><br><span class="line">srvtimeout 50000 </span><br><span class="line">listen admin_status 172.17.210.103:48800 <span class="comment">##VIP </span></span><br><span class="line">stats uri/admin-status <span class="comment">##统计页面 </span></span><br><span class="line">stats auth admin:admin </span><br><span class="line">mode http </span><br><span class="line">option httplog </span><br><span class="line">listen allmycat_service 172.17.210.103:8096 <span class="comment">##转发到mycat 的8066 端口，即 mycat的服务端口</span></span><br><span class="line">mode tcp </span><br><span class="line">option tcplog </span><br><span class="line">option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www </span><br><span class="line">balance roundrobin </span><br><span class="line">server mycat_91 192.168.8.91:8066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">server mycat_92 192.168.8.92:8066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">srvtimeout 20000</span><br><span class="line">listen allmycat_admin 172.17.210.103:8097 <span class="comment">##转发到mycat 的9066 端口，即mycat 的管理控制台端口</span></span><br><span class="line">mode tcp </span><br><span class="line">option tcplog </span><br><span class="line">option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www balance roundrobin </span><br><span class="line">server mycat_91 192.168.8.91:9066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">server mycat_92 192.168.8.92:9066 check port 48700 inter 5s rise 2 fall 3 </span><br><span class="line">srvtimeout 20000</span><br></pre></td></tr></table></figure>

<h4 id="haproxy-记录日志"><a href="#haproxy-记录日志" class="headerlink" title="haproxy 记录日志"></a>haproxy 记录日志</h4><p>默认haproxy 是不记录日志的，为了记录日志还需要配置syslog 模块，在linux 下是rsyslogd服务，先安装rsyslog</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum –y install rsyslog</span><br></pre></td></tr></table></figure>

<p>然后 记录haproxy 日志的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/rsyslog.d/</span><br></pre></td></tr></table></figure>

<p>如果没有这个目录，新建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> rsyslog.d</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/rsyslog.d/ </span><br><span class="line"><span class="built_in">touch</span> haproxy.conf </span><br><span class="line">vi /etc/rsyslog.d/haproxy.conf</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ModLoad</span> imudp </span><br><span class="line"><span class="variable">$UDPServerRun</span> 514 </span><br><span class="line">local0.* /var/log/haproxy.log</span><br></pre></td></tr></table></figure>

<p>配置rsyslog:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsyslog.conf</span><br></pre></td></tr></table></figure>

<p>1、在#### RULES ####上面一行的地方加入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Include all config files in /etc/rsyslog.d/ </span><br><span class="line"></span><br><span class="line">$IncludeConfig /etc/rsyslog.d/*.conf </span><br><span class="line"></span><br><span class="line">#### RULES ####</span><br></pre></td></tr></table></figure>

<p>2、在local7.* &#x2F;var&#x2F;log&#x2F;boot.log 的下面加入以下内容（增加后的效果如下）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Save boot messages also to boot.log </span><br><span class="line">local7.* /var/log/boot.log </span><br><span class="line">local0.* /var/log/haproxy.log</span><br></pre></td></tr></table></figure>

<p>保存，重启rsyslog 服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure>

<p>现在你就可以看到日志（&#x2F;var&#x2F;log&#x2F;haproxy.log）了</p>
<h4 id="配置监听mycat-是否存活"><a href="#配置监听mycat-是否存活" class="headerlink" title="配置监听mycat 是否存活"></a>配置监听mycat 是否存活</h4><p>在Mycat server1 Mycat server2 上都需要添加检测端口48700 的脚本，为此需要用到xinetd，xinetd 为linux 系统的基础服务。首先在xinetd 目录下面增加脚本与端口的映射配置文件</p>
<p>1、如果xinetd 没有安装，使用如下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install xinetd -y</span><br></pre></td></tr></table></figure>

<p>2、检查&#x2F;etc&#x2F;xinetd.conf 的末尾是否有这一句：includedir &#x2F;etc&#x2F;xinetd.d 没有就加上</p>
<p>3、检查&#x2F;etc&#x2F;xinetd.d 文件夹是否存在，不存在也加上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> xinetd.d</span><br></pre></td></tr></table></figure>

<p>4、增加&#x2F;etc&#x2F;xinetd.d&#x2F;mycat_status 监听mycat 是否存活的配置,执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line"><span class="built_in">mkdir</span> xinetd.d </span><br><span class="line"><span class="built_in">cd</span> /etc/xinetd.d/ </span><br><span class="line"><span class="built_in">touch</span> mycat_status </span><br><span class="line">vim /etc/xinetd.d/mycat_status</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">service mycat_status </span><br><span class="line">&#123;</span><br><span class="line">flags = REUSE </span><br><span class="line">socket_type = stream </span><br><span class="line">port = 48700 </span><br><span class="line">wait = no </span><br><span class="line">user = root </span><br><span class="line">server =/usr/local/bin/mycat_status </span><br><span class="line">log_on_failure += USERID </span><br><span class="line">disable = no </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、&#x2F;usr&#x2F;local&#x2F;bin&#x2F;mycat_status 脚本 内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#/usr/local/bin/mycat_status.sh</span><br><span class="line">#This script checks if a mycat server is healthy running on localhost. It will</span><br><span class="line"></span><br><span class="line">#return: </span><br><span class="line">#&quot;HTTP/1.x 200 OK\r&quot; (if mycat is running smoothly)</span><br><span class="line"></span><br><span class="line">#&quot;HTTP/1.x 503 Internal Server Error\r&quot; (else)</span><br><span class="line"></span><br><span class="line">mycat=`/usr/local/mycat/bin/mycatstatus |grep&#x27;not running&#x27;| wc -l` </span><br><span class="line">if [ &quot;$mycat&quot; = &quot;0&quot; ];</span><br><span class="line">then </span><br><span class="line">/bin/echo-e&quot;HTTP/1.1 200 OK\r\n&quot; </span><br><span class="line">else </span><br><span class="line">/bin/echo-e&quot;HTTP/1.1 503 Service Unavailable\r\n&quot; </span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>6、&#x2F;etc&#x2F;services 中加入mycat_status 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc </span><br><span class="line">vi services</span><br></pre></td></tr></table></figure>

<p>在末尾加入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mycat_status 48700/tcp # mycat_status</span><br></pre></td></tr></table></figure>

<p>保存，重启xinetd 服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service xinetd restart</span><br></pre></td></tr></table></figure>

<p>7、验证mycat_status 服务是否启动成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -antup|grep 48700</span><br></pre></td></tr></table></figure>

<p>如果成功会显示如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost <span class="built_in">log</span>]<span class="comment"># netstat -antup|grep 48700 </span></span><br><span class="line">tcp 0 0 :::48700 :::* LISTEN 12609/xinetd</span><br></pre></td></tr></table></figure>

<h4 id="启动haproxy"><a href="#启动haproxy" class="headerlink" title="启动haproxy"></a>启动haproxy</h4><p>启动haproxy 前必须先启动keepalived，否则启动不了。 启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg</span><br></pre></td></tr></table></figure>

<p>启动haproxy 异常情况 如果报以下错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]<span class="comment"># /usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg </span></span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy admin_status: cannot <span class="built_in">bind</span> socket </span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy allmycat_service: cannot <span class="built_in">bind</span> socket </span><br><span class="line">[ALERT] 183/115915 (12890) :Starting proxy allmycat_admin: cannot <span class="built_in">bind</span> socket</span><br></pre></td></tr></table></figure>

<p>原因为：该机器没有抢占到vip，如果另一台服务启动正常，这个错误可以忽略不管，如果另一台也一样，使 用ping vip 命令看看vip 是否生效，如果没有生效，说明keepalived 没有启动成功，回去检查keepalived 的异 常再说。</p>
<p>为了使用方便可以增加一个启动，停止haproxy 的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /usr/local/haproxy/sbin/starthaproxy </span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/haproxy/sbin/starthaproxy</span><br><span class="line"><span class="built_in">touch</span> /usr/local/haproxy/sbin/stophaproxy </span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/haproxy/sbin/stophaproxy</span><br></pre></td></tr></table></figure>

<p>启动脚本starthap 内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg &amp;</span><br></pre></td></tr></table></figure>

<p>停止脚本stophap 内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh </span></span><br><span class="line">ps -ef | grep sbin/haproxy | grep -v grep |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargs <span class="built_in">kill</span> -s 9</span><br></pre></td></tr></table></figure>

<p>启动后可以通过<a target="_blank" rel="noopener" href="http://192.168.8.108:48800/admin-status">http://192.168.8.108:48800/admin-status</a> (用户名密码都是admin，haproxy.cfg 中配置的)</p>
<h4 id="openssl-安装"><a href="#openssl-安装" class="headerlink" title="openssl 安装"></a>openssl 安装</h4><p>openssl 必须安装，否则安装keepalived 时无法编译，keepalived 依赖openssl。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf openssl-1.0.1g.tar.gz </span><br><span class="line">./config--prefix=/usr/local/openssl </span><br><span class="line">./config-t</span><br><span class="line">make depend </span><br><span class="line">make </span><br><span class="line">make <span class="built_in">test</span> </span><br><span class="line">make install </span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/openssl /usr/local/ssl</span><br></pre></td></tr></table></figure>

<p>openssl 配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/ld.so.conf</span><br></pre></td></tr></table></figure>

<p>在&#x2F;etc&#x2F;ld.so.conf 文件的最后面，添加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/openssl/lib</span><br></pre></td></tr></table></figure>

<p>配置环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> OPENSSL=/usr/local/openssl/bin </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$OPENSSL</span></span><br></pre></td></tr></table></figure>

<p>执行以下语句是环境变量生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<p>安装openssl-devel：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl-devel -y <span class="comment">#如无法yum 下载安装，请修改yum 配置文件</span></span><br></pre></td></tr></table></figure>

<p>测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldd /usr/local/openssl/bin/openssl </span><br><span class="line"></span><br><span class="line">    linux-vdso.so.1 =&gt; (0x00007fff996b9000) </span><br><span class="line">    libdl.so.2 =&gt;/lib64/libdl.so.2 (0x00000030efc00000) </span><br><span class="line">    libc.so.6 =&gt;/lib64/libc.so.6 (0x00000030f0000000) </span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00000030ef800000) </span><br><span class="line"></span><br><span class="line"><span class="built_in">which</span> openssl </span><br><span class="line">	/usr/bin/openssl </span><br><span class="line">openssl version </span><br><span class="line">	OpenSSL 1.0.0-fips 29 Mar 2010</span><br></pre></td></tr></table></figure>

<h4 id="keepalived-安装"><a href="#keepalived-安装" class="headerlink" title="keepalived 安装"></a>keepalived 安装</h4><p>本文在192.168.8.91、192.168.8.92 两台机器进行keepalived 安装 安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf keepalived-1.2.13.tar.gz </span><br><span class="line"><span class="built_in">cd</span> keepalived-1.2.13 </span><br><span class="line">./configure--prefix=/usr/local/keepalived </span><br><span class="line">make </span><br><span class="line">make install </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/sbin/keepalived /usr/sbin/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/rc.d/init.d/keepalived/etc/init.d/ </span><br><span class="line"><span class="built_in">mkdir</span> /etc/keepalived </span><br><span class="line"><span class="built_in">cd</span> /etc/keepalived/ </span><br><span class="line"><span class="built_in">cp</span> /usr/local/keepalived/etc/keepalived/keepalived.conf/etc/keepalived </span><br><span class="line">mkdir-p/usr/local/keepalived/var/log</span><br></pre></td></tr></table></figure>

<h4 id="keepalived-配置"><a href="#keepalived-配置" class="headerlink" title="keepalived 配置"></a>keepalived 配置</h4><p>创建检查haproxy 是否存活的脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/keepalived/scripts </span><br><span class="line"><span class="built_in">cd</span> /etc/keepalived/scripts</span><br></pre></td></tr></table></figure>

<p>配置 keepalived.conf:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<p>Master(192.168.8.91):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration Fileforkeepalived </span><br><span class="line">vrrp_script chk_http_port &#123; </span><br><span class="line">script<span class="string">&quot;/etc/keepalived/scripts/check_haproxy.sh&quot;</span> </span><br><span class="line">interval 2 </span><br><span class="line">weight 2 </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">state MASTER <span class="comment">#192.168.8.92 上为BACKUP </span></span><br><span class="line">interface eth0 <span class="comment">#对外提供服务的网络接口 </span></span><br><span class="line">virtual_router_id 51 <span class="comment">#VRRP 组名，两个节点的设置必须一样，以指明各个节点属于同一 VRRP 组 </span></span><br><span class="line">priority 150 <span class="comment">#数值愈大，优先级越高,192.168.8.92 上改为120 </span></span><br><span class="line">advert_int 1 <span class="comment">#同步通知间隔 </span></span><br><span class="line">authentication &#123; <span class="comment">#包含验证类型和验证密码。类型主要有PASS、AH 两种，通常使用的类型为 PASS，据说 AH 使用时有问题 </span></span><br><span class="line">auth_type PASS </span><br><span class="line">auth_pass 1111 </span><br><span class="line">&#125;</span><br><span class="line">track_script &#123; </span><br><span class="line">chk_http_port <span class="comment">#调用脚本check_haproxy.sh 检查haproxy 是否存活 </span></span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; <span class="comment">#vip 地址，这个ip 必须与我们在lvs 客户端设定的vip 相一致 </span></span><br><span class="line">192.168.8.108 dev eth0 scope global </span><br><span class="line">&#125;</span><br><span class="line">notify_master/etc/keepalived/scripts/haproxy_master.sh </span><br><span class="line">notify_backup/etc/keepalived/scripts/haproxy_backup.sh </span><br><span class="line">notify_fault /etc/keepalived/scripts/haproxy_fault.sh </span><br><span class="line">notify_stop /etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>slave(192.168.8.92)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration Fileforkeepalived </span><br><span class="line">vrrp_script chk_http_port &#123; </span><br><span class="line">script&quot;/etc/keepalived/scripts/check_haproxy.sh&quot; </span><br><span class="line">interval 2 </span><br><span class="line">weight 2 </span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">state BACKUP </span><br><span class="line">interface eth0 #对外提供服务的网络接口</span><br><span class="line">virtual_router_id 51 #VRRP 组名，两个节点的设置必须一样，以指明各个节点属于同一 VRRP 组 </span><br><span class="line">priority 120 #数值愈大，优先级越高 </span><br><span class="line">advert_int 1 #同步通知间隔 </span><br><span class="line">authentication &#123; #包含验证类型和验证密码。类型主要有PASS、AH 两种，通常使用的类型为 PASS，据说 AH 使用时有问题 </span><br><span class="line">auth_type PASS </span><br><span class="line">auth_pass 1111 </span><br><span class="line">&#125;</span><br><span class="line">track_script &#123; </span><br><span class="line">chk_http_port #调用脚本check_haproxy.sh 检查haproxy 是否存活 </span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123; #vip 地址，这个ip 必须与我们在lvs 客户端设定的vip 相一致 </span><br><span class="line">192.168.8.108 dev eth0 scope global </span><br><span class="line">&#125;</span><br><span class="line">notify_master /etc/keepalived/scripts/haproxy_master.sh </span><br><span class="line">notify_backup /etc/keepalived/scripts/haproxy_backup.sh </span><br><span class="line">notify_fault /etc/keepalived/scripts/haproxy_fault.sh</span><br><span class="line">notify_stop /etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ol>
<li>virtual_router_id 51 这个代表一个集群组，如果同一个网段还有另一组集群，请使用不同的组编号区分。 如换成52、53 等。</li>
<li>interface eth1 和192.168.8.108 dev eth1 scope global 中的eth1 指的是网卡，如果是多网卡，可能 会有eth0，eth1，eth2…，可以使用ifconfifig 命令查看，确保eth0 是本机存在的网卡地址。有些服务器如果只有一个网卡，但被人为把eth0 改成eth1 了，你再写eth0就找不到了的。</li>
</ol>
<p>check_haproxy.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/scripts/check_haproxy.sh</span><br></pre></td></tr></table></figure>

<p>脚本含义：如果没有haproxy 进程存在，就启动haproxy，停止keepalived。</p>
<p>check_haproxy.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=<span class="string">&quot;/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.cfg&quot;</span> </span><br><span class="line">STOPKEEPALIVED=<span class="string">&quot;/etc/init.d/keepalived stop&quot;</span></span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[check_haproxy status]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line">A=`ps-C haproxy --no-header |wc-l` </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[check_haproxy status]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> <span class="keyword">if</span> [ <span class="variable">$A</span> -eq 0 ];<span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line">sleep5 </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ `ps -C haproxy --no-header |wc-l` -eq0 ];<span class="keyword">then</span> </span><br><span class="line"><span class="built_in">exit</span> 0 </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"><span class="built_in">exit</span> 1 </span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>haproxy_master.sh(master 和slave 一样)</p>
<p>&#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_master.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=`/usr/local/haproxy/sbin/haproxy- f/usr/local/haproxy/haproxy.cfg` </span><br><span class="line">STOPHAPROXY=`ps-ef |grep sbin/haproxy| grep -vgrep|awk<span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargskill-s 9` </span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[master]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Being master....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STOPHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;haproxy stared ...&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>haproxy_backup.sh(master 和slave 一样)</p>
<p>&#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_backup.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">STARTHAPROXY=`/usr/local/haproxy/sbin/haproxy- f/usr/local/haproxy/haproxy.cfg` </span><br><span class="line">STOPHAPROXY=`ps-ef |grep sbin/haproxy| grep -vgrep|awk<span class="string">&#x27;&#123;print $2&#125;&#x27;</span>|xargskill-s 9` </span><br><span class="line">LOGFILE=<span class="string">&quot;/usr/local/keepalived/var/log/keepalived-haproxy-state.log&quot;</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[backup]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Being backup....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="variable">$STOPHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start haproxy....&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line"><span class="variable">$STARTHAPROXY</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;haproxy stared ...&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>haproxy_fault.sh(master 和slave 一样) &#x2F;etc&#x2F;keepalived&#x2F;scripts&#x2F;haproxy_fault.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">LOGFILE=/usr/local/keepalived/var/log/keepalived-haproxy-state.log </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[fault]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line">haproxy_stop.sh(master 和slave 一样) </span><br><span class="line">/etc/keepalived/scripts/haproxy_stop.sh </span><br><span class="line"><span class="comment">#!/bin/bash </span></span><br><span class="line">LOGFILE=/usr/local/keepalived/var/log/keepalived-haproxy-state.log </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[stop]&quot;</span> &gt;&gt; <span class="variable">$LOGFILE</span> </span><br><span class="line"><span class="built_in">date</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br></pre></td></tr></table></figure>

<p>启用服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>

<h2 id="Mycat多类数据源完整解决方案"><a href="#Mycat多类数据源完整解决方案" class="headerlink" title="Mycat多类数据源完整解决方案"></a>Mycat多类数据源完整解决方案</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221226174405.png"></p>
<h2 id="Mycat配置Zookeeper化"><a href="#Mycat配置Zookeeper化" class="headerlink" title="Mycat配置Zookeeper化"></a>Mycat配置Zookeeper化</h2><p>Mycat1.5开始支持配置zookeeper化，通过zookeeper管理Mycat-Server 。1.6 对zk 模块进行了重构，同时支持zk 的watch 机制，会将所有zk 上的变动同步到本地配置。</p>
<h3 id="配置zk化步骤"><a href="#配置zk化步骤" class="headerlink" title="配置zk化步骤"></a>配置zk化步骤</h3><p>1、配置myid.properties</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loadZk=<span class="literal">true</span> 是否启用zk </span><br><span class="line">zkURL=127.0.0.1:2181 zk地址支持多个 </span><br><span class="line">clusterId=mycat-cluster-1 mycat集群名称，即一组相同的mycat为一个集群，一个集 群名称配置唯一</span><br><span class="line">myid=mycat_fz_01 集群内部mycat 节点的<span class="built_in">id</span>，请保持集群内唯一</span><br></pre></td></tr></table></figure>

<p>2、在一个mycat实例上，在conf 下的zkconf 下配置常用的schemal rule server 等xml 文件</p>
<p>3、在该mycat实例上执行bin 目录下的init_zk_data.bat 或者init_zk_data.sh,会自动将zkconf下的所有配置文件上传到zk。</p>
<p>4.其他mycat实例，启动时如果loadzk&#x3D;true 会自动从zk 下载配置文件覆盖本地配置。</p>
<h3 id="zk-协调后端mysql-切换"><a href="#zk-协调后端mysql-切换" class="headerlink" title="zk 协调后端mysql 切换"></a>zk 协调后端mysql 切换</h3><p>server.xml 中配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useZKSwitch&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>则mycat 在进行切换时会自动通过zk协调，保证同一个集群下的mycat 都切换到一致的状态</p>
<h2 id="Mycat-性能测试指南"><a href="#Mycat-性能测试指南" class="headerlink" title="Mycat 性能测试指南"></a>Mycat 性能测试指南</h2><p>Mycat 自身提供了一套基准性能测试工具，这套工具可以用于性能测试、疲劳测试等，包括分片表插入性能 测试、分片表查询性能测试、更新性能测试、全局表插入性能测试等基准测试工具。</p>
<p>这里需要说明的一点是，分片表的性能测试不同于普通单表，因为它的数据是分布在几个Datahost 上的，因 此插入和查询，都必需要特定的工具，才能做到多个节点同时负载请求，通过观察每个主机的负载，能够确定是 否你的测试是合理和正确的。</p>
<p>大量测试表明，当带宽不是问题而且带宽没有占满，比如千兆网网络连接的Mycat 和MySQL服务器，以及 测试客户端，（通常个人电脑到服务器的连接为100M），分片表的性能取决于后端部署MySQL 的物理机的个 数，比如每个MySQL 的性能是5 万Tps，则3 台理论上是15万，而Mycat 能达到80-95%之间，即12 万以上。</p>
<p>关于带宽问题，是一个比较棘手的问题，通常需要监控交换机、MySQL 服务器、Mycat 服务器、以获取测试 过程中的端口流量信息，才能确定是否带宽存在问题，另外，很多企业里，千兆交换机采用了百兆的普通网线的 情况时有发生，防不胜防，所以，在不能控制的网络环境里，测试最大性能的目标通常无法实现。</p>
<p>另外，很多人测试的时候，并不知道MySQL 直连的性能，因此无法正确比较Mycat 的性能，所以，建议性 能测试过程里，首先直连MySQL 进行性能测试，可以同时直连多个MYSQL 服务器，然后把测试结果累计，作 为连的性能指标，然后改为连接Mycat 进行测试，这样的对比才是有价值的，当插件过大的时候，需要先排除 是否存在MySQL 冷热不均的现象，然后考虑Mycat 性能调优。</p>
<h3 id="测试工具获取"><a href="#测试工具获取" class="headerlink" title="测试工具获取"></a>测试工具获取</h3><p>测试工具在单独的包中，解压到任意机器中执行使用，跟MyCAT Server 没有关联关系，此测试工具很强 大，可以测试任意表，和任意数据库，测试工具下载：<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-download">https://github.com/MyCATApache/Mycat-download</a> 目录下的testtool.tar.gz 中。</p>
<p>解压后，在bin 目录里运行文中的测试脚本: </p>
<h3 id="标准插入性能测试脚本"><a href="#标准插入性能测试脚本" class="headerlink" title="标准插入性能测试脚本"></a>标准插入性能测试脚本</h3><p>标准插入性能测试脚本test_stand_insert_perf.sh 支持任意表的定制化业务数据的随机生成功能了，在sql 模板文件中用${int(1-100)}这种变量，测试程序会随机生成符合要求的值并插入数据库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test_stand_insert_perf.sh jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 10 file=mydata-create.sql</span><br></pre></td></tr></table></figure>

<p>其中mydata-create.sql 的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">total=10000000 </span><br><span class="line">sql=insert into my_table1 (….) values (<span class="string">&#x27;$&#123;date(yyyyMMddHHmmssSSS-[2014- 2015]y)&#125;-$&#123;int(0- 9999)&#125;ok$&#123;int(1111-9999)&#125;xxx &#x27;</span>,<span class="string">&#x27;$&#123;char([0-9]2:2)&#125; OPP_$&#123;enum(BJ,SH,WU,GZ)&#125;_1&#x27;</span>,10,<span class="variable">$&#123;int(10-999)&#125;</span>,<span class="variable">$&#123;int(10- 99)&#125;</span>,100,3,15,<span class="string">&#x27;$&#123;date(yyyyMMddHHmmssSSS-[2014-2015]y&#125;$&#123;char([a-f,0-9]8:8)&#125; &#x27;</span>,<span class="variable">$&#123;phone(139- 189)&#125;</span>,2,<span class="variable">$&#123;date(yyyyMMddHH-[2014-2015]y&#125;</span>,<span class="variable">$&#123;date(HHmmssSSS)&#125;</span>,<span class="variable">$&#123;int(100- 1000)&#125;</span>,<span class="string">&#x27;$&#123;enum(0000,0001,0002)&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>目前支持的有以下类型变量：</p>
<ul>
<li>Int:${int(..)} 可以是,${int(10-999)}或者,${int(10,999)}前者表示从10 到999 的值，后者表示10 或者999</li>
<li>Date:日期如${date(yyyyMMddHHmmssSSS-[2014-2015]y)}表示从2014 到2015 年的时间，前面是输出格式，符 合Java 标准</li>
<li>Char:字符串${char([0-9]2:2)}表示从0 到9 的字符，长度为2 位（2:2），}${char([a-f,0-9]8:8)}表示从a 到f 以及0 到9 的字符串随机组成，定常为8 位。</li>
<li>Enmu:枚举，表示从指定范围内获取一个值，${enum(0000,0001,0002)}，里面可以是任意字符串或数字等内容。</li>
</ul>
<h3 id="标准查询性能测试脚本"><a href="#标准查询性能测试脚本" class="headerlink" title="标准查询性能测试脚本"></a>标准查询性能测试脚本</h3><p>标准查询性能测试脚本test_stand_select_perf 也支持sqlTemplate 的变量方式，查询任意指定的sql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test_stand_select_perf.sh jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 10 100000 file=mysql-select.sql</span><br></pre></td></tr></table></figure>

<p>其中oppcall-select.sql 的内容类似下面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql=<span class="keyword">select</span> * from mytravelrecord <span class="built_in">where</span> <span class="built_in">id</span> = <span class="variable">$&#123;int(1-1000000)&#125;</span></span><br></pre></td></tr></table></figure>

<p>表明查询id 为1 到1000000 之间的随机SQL。</p>
<p><strong>注意：</strong>Windows 下fifile&#x3D;xxx.slq 需要加引号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_insert_perf.bat jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 50 <span class="string">&quot;file=oppcall.sql&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试说明"><a href="#测试说明" class="headerlink" title="测试说明"></a>测试说明</h3><p>首先参考MyCAT 性能调优，确保整个系统达到最优配置。</p>
<p>性能测试，建议先小规模压力预热10-20 分钟，这是众所周知的Java 的特性，越跑越快。</p>
<p>测试的硬件和网络条件：</p>
<ul>
<li>建议至少3 台服务器；</li>
<li>MyCAT Server 一台；</li>
<li>Mysql 一台；</li>
<li>带宽应该是至少100M，建议千兆；</li>
<li>压力程序在另一台，压力程序的机器也可以由性能差的机器来代替。</li>
</ul>
<p>有条件的话，分片库在不同的MYSQL 实例上，如20 个分片，每个MYSQL 实例7 个分片，而且最好有多台 MYSQL 物理机。</p>
<h3 id="分片表的录入性能测试-T01"><a href="#分片表的录入性能测试-T01" class="headerlink" title="分片表的录入性能测试-T01"></a>分片表的录入性能测试-T01</h3><p>测试案例：分片表的并发录入性能测试，测试DEMO 中的travelrecord 表，此表的基准DDL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> travelrecord ( </span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key, </span><br><span class="line">    user_id <span class="type">varchar</span>(<span class="number">100</span>), </span><br><span class="line">    traveldate <span class="type">DATE</span>, </span><br><span class="line">    fee <span class="type">decimal</span>, </span><br><span class="line">    days <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>此表的标准分片方式为基于ID 范围的自动分片策略。Schema.xml 中配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;travelrecord&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding- long&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认是3 个分片，分片ID 范围定义在autopartition-long.txt 中，建议修改为以下或更大的数值范围分片， 每个分片500 万数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#range start-end ,data node index </span></span><br><span class="line"></span><br><span class="line">0-2000000=0 </span><br><span class="line">2000001-4000000=1 </span><br><span class="line">4000001-6000000=2</span><br></pre></td></tr></table></figure>

<p>根据自己的情况，可以每个分片放更多的数据，进行对比性能测试，当分片index 增加时，注意dataNode 也增加（dataNode&#x3D;“dn1,dn2,dn3”）。</p>
<p>测试的输入参数如下[jdbcurl] [user] [password] [threadpoolsize] [recordrange]：</p>
<ul>
<li>Jdbcurl:连接mycat 的地址，格式为jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB</li>
<li>User 连接Mycat 的用户名</li>
<li>Password:密码</li>
<li>Threadpoolsize:并发线程请求，可以在50-2000 左右调整，看看哪种情况下的性能最好</li>
<li>Recordrang:插入的分片系列以及对应的ID 范围，minId-maxId 然后逗号分开，对应多组</li>
<li>分片的ID 范围，如0-200000,200001-400000,400001-600000，跟分片配置保持一致。</li>
</ul>
<h3 id="测试过程："><a href="#测试过程：" class="headerlink" title="测试过程："></a>测试过程：</h3><p>每次测试，建议先执行重建表的操作，以保证测试环境的一致性： 连接mycat 8066 端口，在命令行执行下面的操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> travelrecord; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> travelrecord ( </span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key,</span><br><span class="line">    user_id <span class="type">varchar</span>(<span class="number">100</span>), </span><br><span class="line">    traveldate <span class="type">DATE</span>, </span><br><span class="line">    fee <span class="type">decimal</span>, </span><br><span class="line">    days <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>先预测试： 执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_insert_perf jdbc:mysql://localhost:8066/TESTDB <span class="built_in">test</span> <span class="built_in">test</span> 100 “0-100M,100M1-200M,200M1-400M”</span><br></pre></td></tr></table></figure>

<p>MyCAT 温馨提示：并发线程数表明同时至少有多少个Mysql 连接会被打开，当SQL 不跨分片的时候，并发线程数 &#x3D;MYSQL 连接数，在Mycat conf&#x2F;schema.xml 中，将minCon 设置为&gt;&#x3D;并发连接数，这种情况下重启MYCAT，会 初始建立minCon 个连接，并发测试结果更好，另外，也可以验证是否当前内存设置，以及MYSQL 是否支持开启这么多连接，若无法支持，则logs&#x2F;mycat.log 日志中会有告警错误信息，建议测试过程中tail –f logs&#x2F;mycat.log 观察有无错误信息。另外，开启单独的Mycat 管理窗口，mysql –utest –ptest –P9066 然后运行show@@datasource 可以看到后端连接的使用情况。Show @@threadpool 可以看线程和SQL 任务积压的情况。 也可以同时启动多个测试程序,在不同的机器上，并发进行测试，每个测试程序写入一个分片的数据范围，对于1 个亿的数据插入测试来说，可能效果更好，毕竟单机并发线程50 个左右已经差不多极限： test_stand_insert_perf jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB test test 100 “0-100M” est_stand_insert_perf jdbc:mysql:&#x2F;&#x2F;localhost:8066&#x2F;TESTDB test test100 100M1-200M”</p>
<h3 id="全局表的查询性能测试T02："><a href="#全局表的查询性能测试T02：" class="headerlink" title="全局表的查询性能测试T02："></a>全局表的查询性能测试T02：</h3><p>全局表自动在多个节点上同步插入，因此其插入性能有所降低，这里的插入表为goods 表，执行的命令类似 T01 的测试。温馨提示：全局表是同时往多个分片上写数据，因此所需并发MYSQL 数连接为普通表的3 倍，最 好的模式是全局表分别在多个mysql 实例上。 建表语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> goods; </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> goods( </span><br><span class="line">	id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">200</span>), </span><br><span class="line">    good_type tinyint, </span><br><span class="line">    good_img_url <span class="type">varchar</span>(<span class="number">200</span>), </span><br><span class="line">    good_created <span class="type">date</span>, </span><br><span class="line">    good_desc <span class="type">varchar</span>(<span class="number">500</span>), </span><br><span class="line">    price <span class="keyword">double</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_globaltable_insert_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">100</span> <span class="number">1000000</span></span><br></pre></td></tr></table></figure>

<p>本机笔记本，4G 内存，数据库与Mycat 以及测试程序都在一起，跑出来每秒1000 多的插入速度。</p>
<h3 id="分片表的查询性能测试T03："><a href="#分片表的查询性能测试T03：" class="headerlink" title="分片表的查询性能测试T03："></a>分片表的查询性能测试T03：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发随机查询，此测试是在分片 库上，基于分片的主键ID 进行随机查询，返回单条记录，多线程并发随机执行N此记录查询，每次查询的记录主 键ID 是随机选择，在maxID(参数)范围之内。</p>
<p>测试工具test_stand_select_perf 的参数如下</p>
<p>[jdbcurl] [user] [password] [threadpoolsize] [executetimes] [maxId]</p>
<ul>
<li>Executetimes：每个线程总共执行多少次随机查询，建议1000 次以上</li>
<li>maxId：travelrecord 表的最大ID，可以执行select max(id) from travelrecord 来获取。</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_select_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">100</span> <span class="number">10000</span> <span class="number">50000</span></span><br></pre></td></tr></table></figure>

<h3 id="分片表的汇聚性能测试T04："><a href="#分片表的汇聚性能测试T04：" class="headerlink" title="分片表的汇聚性能测试T04："></a>分片表的汇聚性能测试T04：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发随机查询，此测试执行分片 库上的聚合、排序、分页的性能，SQL 如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(fee) total_fee, days,<span class="built_in">count</span>(id),<span class="built_in">max</span>(fee),<span class="built_in">min</span>(fee) <span class="keyword">from</span> travelrecord <span class="keyword">group</span> <span class="keyword">by</span> days <span class="keyword">order</span> <span class="keyword">by</span> days <span class="keyword">desc</span> limit ？</span><br></pre></td></tr></table></figure>

<p>测试工具test_stand_merge_sel_perf 的参数如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[jdbcurl] [user] [password] [threadpoolsize] [executetimes] [limit]</span><br></pre></td></tr></table></figure>

<ul>
<li>Executetimes：每个线程总共执行多少次随机查询，建议1000 次以上</li>
<li>limit：分页返回的记录个数，必须大于30</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_merge_sel_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">10</span> <span class="number">100</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h3 id="分片表的更新性能测试T05："><a href="#分片表的更新性能测试T05：" class="headerlink" title="分片表的更新性能测试T05："></a>分片表的更新性能测试T05：</h3><p>此测试可以在T01 的集群上运行，先生成大量travelrecord 记录，然后进行并发更新操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> travelrecord <span class="keyword">set</span> <span class="keyword">user</span> <span class="operator">=</span>? ,traveldate<span class="operator">=</span>?,fee<span class="operator">=</span>?,days<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>

<p>测试工具test_stand_update_perf 的参数如下</p>
<p>[jdbcurl] [user] [password] [threadpoolsize] [record]</p>
<ul>
<li>record：总共修改多少条记录，&gt;5000</li>
</ul>
<p>Example:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test_stand_update_perf.bat jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">8066</span><span class="operator">/</span>TESTDB test test <span class="number">10</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h2 id="监控与管理"><a href="#监控与管理" class="headerlink" title="监控与管理"></a>监控与管理</h2><h3 id="管理命令与监控"><a href="#管理命令与监控" class="headerlink" title="管理命令与监控"></a>管理命令与监控</h3><p>请参考《Mycat权威指南》 高级进阶篇 第8章 “管理命令与监控”。</p>
<h3 id="Mycat-Web"><a href="#Mycat-Web" class="headerlink" title="Mycat-Web"></a>Mycat-Web</h3><p>请参考《Mycat权威指南》 高级进阶篇 第10章 “Mycat-Web” 和 <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Web">https://github.com/MyCATApache/Mycat-Web</a></p>
<h3 id="Mycat-mini-monitor"><a href="#Mycat-mini-monitor" class="headerlink" title="Mycat-mini-monitor"></a>Mycat-mini-monitor</h3><p>使用参考：<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-mini-monitor">https://github.com/MyCATApache/Mycat-mini-monitor</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/05-MyCat%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-id="clmcxed6900cmu8wabqzf1rpo" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/02-MyCat/04-MyCat分库分表" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/04-MyCat%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.888Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mycat分库分表"><a href="#Mycat分库分表" class="headerlink" title="Mycat分库分表"></a>Mycat分库分表</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol>
<li><p>准备数据库服务，这里作为学习用，我们就用一个数据库服务。<br>dhost1： localhost</p>
</li>
<li><p>在dhost1服务创建三个数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE db1 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8&#x27;</span>; </span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db2 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE db3 <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置好dataHost dataNode</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注意：里面的元素一定要按 schema 、dataNode 、 dataHost的顺序配置 --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;mydb&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db2&quot;</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db3&quot;</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;xxx&quot;</span> <span class="attr">password</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="表分类"><a href="#表分类" class="headerlink" title="表分类"></a>表分类</h2><h3 id="分片表"><a href="#分片表" class="headerlink" title="分片表"></a>分片表</h3><p>分片表，是指那些有很大数据，需要切分到多个数据库的表，这样每个分片都有一部分数据，所有分片构成了完整的数据。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_goods&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;vid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;rule1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="非分片表"><a href="#非分片表" class="headerlink" title="非分片表"></a>非分片表</h3><p>一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就是那些不需要进行数据切分的表。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_node&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;vid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>示例</strong></p>
<p>商家表，数据量500万内</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_shops( </span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_shops&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_shops(name) <span class="keyword">values</span>(<span class="string">&#x27;xxx&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="ER表"><a href="#ER表" class="headerlink" title="ER表"></a>ER表</h3><p>Mycat 中的ER 表是基于E-R 关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分片上，保证数据Join 不会跨库操作。</p>
<p>ER分片是解决跨分片数据join 的一种很好的思路，也是数据切分规划的一条重要规则。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_items&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h3><p>一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动。</p>
<p>问题：业务表往往需要和字典表Join查询，当业务表因为规模而进行分片以后，业务表与字典表之间的关联跨库了。</p>
<p>解决：Mycat中通过表冗余来解决这类表的join，即它的定义中指定的dataNode上都有一份该表的拷贝。（将字典表或者符合字典表特性的表定义为全局表。 ）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<p>省份表 t_province，在各数据节点所在库上分别创建全局表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_province( </span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">table</span> name<span class="operator">=</span>&quot;t_province&quot; primaryKey<span class="operator">=</span>&quot;ID&quot; type<span class="operator">=</span>&quot;global&quot; dataNode<span class="operator">=</span>&quot;dn1,dn2,dn3&quot; <span class="operator">/</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启mycat服务，插入数据看看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_province(id,name) <span class="keyword">values</span>(<span class="number">1001</span>,<span class="string">&#x27;浙江&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_province(id,name) <span class="keyword">values</span>(<span class="number">1002</span>,<span class="string">&#x27;江苏&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_province(id,name) <span class="keyword">values</span>(<span class="number">1003</span>,<span class="string">&#x27;上海&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_province(id,name) <span class="keyword">values</span>(<span class="number">1004</span>,<span class="string">&#x27;广东&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>两个数据节点库上都同时写入了该数据。</p>
<h2 id="分片规则配置"><a href="#分片规则配置" class="headerlink" title="分片规则配置"></a>分片规则配置</h2><h3 id="分表规则定义"><a href="#分表规则定义" class="headerlink" title="分表规则定义"></a>分表规则定义</h3><p>在conf&#x2F;rule.xml中定义分片规则：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:rule <span class="keyword">SYSTEM</span> <span class="string">&quot;rule.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>128<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="tableRule标签说明："><a href="#tableRule标签说明：" class="headerlink" title="tableRule标签说明："></a>tableRule标签说明：</h4><ul>
<li>name 属性指定唯一的名字，用于标识不同的表规则。</li>
<li>内嵌的rule 标签则指定对物理表中的哪一列进行拆分和使用什么路由算法。<ul>
<li>columns 内指定要拆分的列名字。</li>
<li>algorithm 使用function 标签中的name 属性。连接表规则和具体路由算法。当然，多个表规则可以连接到同一个路由算法上。table 标签内使用。让逻辑表使用这个规则进行分片。</li>
</ul>
</li>
</ul>
<h4 id="function标签说明："><a href="#function标签说明：" class="headerlink" title="function标签说明："></a>function标签说明：</h4><ul>
<li>name 指定算法的名字。</li>
<li>class 制定路由算法具体的类名字。</li>
<li>property 为具体算法需要用到的一些属性。</li>
</ul>
<h2 id="分表分库原则"><a href="#分表分库原则" class="headerlink" title="分表分库原则"></a>分表分库原则</h2><h3 id="分表分库原则-1"><a href="#分表分库原则-1" class="headerlink" title="分表分库原则"></a>分表分库原则</h3><p>分表分库虽然能解决大表对数据库系统的压力，但它并不是万能的，也有一些不利之处，因此<strong>首要问题是分不分库，分哪些库，什么规则分，分多少分片</strong></p>
<ul>
<li>原则一：能不分就不分，1000 万以内的表，不建议分片，通过合适的索引，读写分离等方式，可以很好的解决性能问题。</li>
<li>原则二：分片数量尽量少，分片尽量均匀分布在多个DataHost 上，因为一个查询SQL 跨分片越多，则总体性能越差，虽然要好于所有数据在一个分片的结果，只在必要的时候进行扩容，增加分片数量。</li>
<li>原则三：分片规则需要慎重选择，分片规则的选择，需要考虑数据的增长模式，数据的访问模式，分片关联性问题，以及分片扩容问题，最常用的分片策略为范围分片，枚举分片，一致性Hash 分片，这几种分片都有利于扩容。</li>
<li>原则四：尽量不要在一个事务中的SQL 跨越多个分片，分布式事务一直是个不好处理的问题。</li>
<li>原则五：查询条件尽量优化，尽量避免Select * 的方式，大量数据结果集下，会消耗大量带宽和CPU 资源，查询尽量避免返回大量结果集，并且尽量为频繁使用的查询语句建立索引。</li>
</ul>
<p>这里特别强调一下分片规则的选择问题，如果某个表的数据有明显的时间特征，比如订单、交易记录等，则他们通常比较合适用时间范围分片，因为具有时效性的数据，我们往往关注其近期的数据，查询条件中往往带有时间字段进行过滤，比较好的方案是，当前活跃的数据，采用跨度比较短的时间段进行分片，而历史性的数据，则采用比较长的跨度存储。</p>
<p>总体上来说，分片的选择是取决于最频繁的查询SQL 的条件，因为不带任何Where 语句的查询SQL，会便利所有的分片，性能相对最差，因此这种SQL 越多，对系统的影响越大，所以我们要尽量避免这种SQL 的产生。</p>
<h3 id="SQL统计分析"><a href="#SQL统计分析" class="headerlink" title="SQL统计分析"></a>SQL统计分析</h3><p>如何准确统计和分析当前系统中最频繁的SQL 呢？有几个简单做法：</p>
<ul>
<li>采用特殊的JDBC 驱动程序，拦截所有业务SQL，并写程序进行分析</li>
<li>采用Mycat 的SQL 拦截器机制，写一个插件，拦截所欲SQL，并进行统计分析</li>
<li>打开MySQL 日志，分析统计所有SQL。</li>
</ul>
<p>找出每个表最频繁的SQL，分析其查询条件，以及相互的关系，并结合ER 图，就能比较准确的选择每个表的分片策略。</p>
<h3 id="库内分表说明"><a href="#库内分表说明" class="headerlink" title="库内分表说明"></a>库内分表说明</h3><p>对于大家经常提起的同库内分表的问题，这里做一些分析和说明，同库内分表，仅仅是单纯的解决了单一表数据过大的问题，由于没有把表的数据分布到不同的机器上，因此对于减轻MySQL 服务器的压力来说，并没有太大的作用，大家还是竞争同一个物理机上的IO、CPU、网络。</p>
<p>此外，库内分表的时候，要修改用户程序发出的SQL，可以想象一下A、B 两个表各自分片5 个分表情况下的JoinSQL 会有多么的反人类。这种复杂的SQL 对于DBA 调优来说，也是个很大的问题。因此，Mycat 和一些主流的数据库中间件，都不支持库内分表，但由于MySQL 本身对此有解决方案，所以可以与Mycat 的分库结合，做到最佳效果，下面是MySQL 的分表方案：</p>
<ul>
<li>MySQL 分区；</li>
<li>MERGE 表（MERGE 存储引擎）。</li>
</ul>
<p>通俗地讲MySQL 分区是将一大表，根据条件分割成若干个小表。mysql5.1 开始支持数据表分区了。如：某用户表的记录超过了600 万条，那么就可以根据入库日期将表分区，也可以根据所在地将表分区。当然也可根据其他的条件分区。</p>
<p>MySQL 分区支持的分区规则有以下几种：</p>
<ul>
<li>RANGE 分区：基于属于一个给定连续区间的列值，把多行分配给分区。</li>
<li>LIST 分区：类似于按RANGE 分区，区别在于LIST 分区是基于列值匹配一个离散值集合中的某个值来进行选择。</li>
<li>HASH 分区：基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL 中有效的、产生非负整数值的任何表达式。</li>
<li>KEY 分区：类似于按HASH 分区，区别在于KEY 分区只支持计算一列或多列，且MySQL 服务器提供其自身的哈希函数。必须有一列或多列包含整数值。</li>
</ul>
<p>在Mysql 数据库中，Merge 表有点类似于视图，mysql 的merge 引擎类型允许你把许多结构相同的表合并为一个表。之后，你可以执行查询，从多个表返回的结果就像从一个表返回的结果一样。每一个合并的表必须有完全相同表的定义和结构，但是只支持MyISAM 引擎。</p>
<p>Mysql Merge 表的优点：</p>
<ul>
<li>分离静态的和动态的数据；</li>
<li>利用结构接近的的数据来优化查询；</li>
<li>查询时可以访问更少的数据；</li>
<li>更容易维护大数据集。</li>
</ul>
<p>在数据量、查询量较大的情况下，不要试图使用Merge 表来达到类似于Oracle 的表分区的功能，会很影响性能。我的感觉是和union 几乎等价。</p>
<p><strong>Mycat 建议的方案是Mycat 分库+MySQL 分区，此方案具有以下优势：</strong></p>
<ul>
<li>充分结合分布式的并行能力和MySQL 分区表的优化；</li>
<li>可以灵活的控制表的数据规模；</li>
<li>可以两个维度对表进行分片，MyCAT 一个维度分库，MySQL 一个维度分区。</li>
</ul>
<h2 id="数据拆分原则"><a href="#数据拆分原则" class="headerlink" title="数据拆分原则"></a>数据拆分原则</h2><ol>
<li>达到一定数量级才拆分（800 万）</li>
<li>不到800 万但跟大表（超800 万的表）有关联查询的表也要拆分，在此称为大表关联表</li>
<li>大表关联表如何拆：小于100 万的使用全局表；大于100 万小于800 万跟大表使用同样的拆分策略；无法跟大表使用相同规则的，可以考虑从java 代码上分步骤查询，不用关联查询，或者破例使用全局表。</li>
<li>破例的全局表：如item_sku 表250 万，跟大表关联了，又无法跟大表使用相同拆分策略，也做成了全局表。破例的全局表必须满足的条件：没有太激烈的并发update，如多线程同时update 同一条id&#x3D;1 的记录。虽有多线程update，但不是操作同一行记录的不在此列。多线程update 全局表的同一行记录会死锁。批量insert没问题</li>
<li>拆分字段是不可修改的</li>
<li>拆分字段只能是一个字段，如果想按照两个字段拆分，必须新建一个冗余字段，冗余字段的值使用两个字段的值拼接而成（如大区+年月拼成zone_yyyymm 字段）。</li>
<li>拆分算法的选择和合理性评判：按照选定的算法拆分后每个库中单表不得超过800 万 </li>
<li>能不拆的就尽量不拆。如果某个表不跟其他表关联查询，数据量又少，直接不拆分，使用单库即可。</li>
</ol>
<h2 id="DataNode-的分布问题"><a href="#DataNode-的分布问题" class="headerlink" title="DataNode 的分布问题"></a>DataNode 的分布问题</h2><p>DataNode 代表MySQL 数据库上的一个Database，因此一个分片表的DataNode 的分布可能有以下几种：</p>
<ul>
<li>都在一个DataHost 上</li>
<li>在几个DataHost 上，但有连续性，比如dn1 到dn5 在Server1 上，dn6 到dn10 在Server2 上，依次类推</li>
<li>在几个DataHost 上，但均匀分布，比如dn1,dn2,d3 分别在Server1,Server2,Server3 上，dn4 到dn5 又重复如此</li>
</ul>
<p>一般情况下，不建议第一种，二对于范围分片来说，在大多数情况下，最后一种情况最理想，因为当一个表的数据均匀分布在几个物理机上的时候，跨分片查询或者随机查询，都是到不同的机器上去执行，并行度最高，IO 竞争也最小，因此性能最好。</p>
<p>当我们有几十个表都分片的情况下，怎样设计DataNode 的分布问题，就成了一个难题，解决此难题的最好方式是试运行一段时间，统计观察每个DataNode 上的SQL 执行情况，看是否有严重不均匀的现象产生，然后根据统计结果，重新映射DataNode 到DataHost 的关系。</p>
<p>Mycat 1.4 增加了distribute 函数，可以用于Table 的dataNode 属性上，表示将这些dataNode 在该Table 的分片规则里的引用顺序重新安排，使得他们能均匀分布到几个DataHost 上：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;oc_call&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;distribute(dn1$0-372,dn2$0-372)&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;latest-monthcalldate&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中dn1xxx 与dn2xxxx 是分别定义在DataHost1 上与DataHost2 上的377 个分片</p>
<h2 id="Mycat内置的常用分片规则"><a href="#Mycat内置的常用分片规则" class="headerlink" title="Mycat内置的常用分片规则"></a>Mycat内置的常用分片规则</h2><h3 id="分片枚举（列表分片）"><a href="#分片枚举（列表分片）" class="headerlink" title="分片枚举（列表分片）"></a>分片枚举（列表分片）</h3><p>通过在配置文件中配置可能的枚举id，自己配置分片，本规则适用于特定的场景，比如有些业务需要按照省份或区县来做保存，而全国省份区县固定的，这类业务使用本条规则，配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>enum-func<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;enum-func&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>sharding-by-enum.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>function分片函数中配置说明：</strong></p>
<ul>
<li><p>算法实现类为：io.mycat.route.function.PartitionByFileMap</p>
</li>
<li><p>mapFile 标识配置文件名称；</p>
</li>
<li><p>type 默认值为0，0 表示Integer，非零表示String；</p>
</li>
<li><p>defaultNode defaultNode 默认节点:小于0 表示不设置默认节点，大于等于0 表示设置默认节点为第几个数据节点。<br>默认节点的作用：枚举分片时，如果碰到不识别的枚举值，就让它路由到默认节点 如果不配置默认节点（defaultNode 值小于0 表示不配置默认节点），碰到不识别的枚举值就会报错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">like this：can’t find datanode for sharding column:column_name val:ffffffff</span><br></pre></td></tr></table></figure>
</li>
<li><p>sharding-by-enum.txt 放置在conf&#x2F;下，配置内容示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10000=0 #字段值为10000的放到0号数据节点 </span><br><span class="line">10010=1</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>示例</strong></p>
<p>客户表t_customer</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_customer( </span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">null</span>, </span><br><span class="line">    province <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>按省份进行数据分片，表配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-province&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片规则配置 rule.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-province&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>province<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-province-func<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-province-func&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>sharding-by-province.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">nam</span>=<span class="string">&quot;type&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>sharding-by-province.txt文件中枚举分片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1001=0 </span><br><span class="line">1002=1 </span><br><span class="line">1003=2 </span><br><span class="line">1004=0</span><br></pre></td></tr></table></figure>

<p>测试：插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_customer(name,province) <span class="keyword">values</span>(<span class="string">&#x27;xxx01&#x27;</span>,<span class="number">1001</span>); <span class="keyword">insert</span> <span class="keyword">into</span> t_customer(name,province) <span class="keyword">values</span>(<span class="string">&#x27;xxx02&#x27;</span>,<span class="number">1002</span>); <span class="keyword">insert</span> <span class="keyword">into</span> t_customer(name,province) <span class="keyword">values</span>(<span class="string">&#x27;xxx03&#x27;</span>,<span class="number">1003</span>); <span class="keyword">insert</span> <span class="keyword">into</span> t_customer(name,province) <span class="keyword">values</span>(<span class="string">&#x27;xxx04&#x27;</span>,<span class="number">1004</span>); <span class="keyword">insert</span> <span class="keyword">into</span> t_customer(name,province) <span class="keyword">values</span>(<span class="string">&#x27;xxx05&#x27;</span>,<span class="number">1005</span>);</span><br></pre></td></tr></table></figure>

<h3 id="范围分片"><a href="#范围分片" class="headerlink" title="范围分片"></a>范围分片</h3><p>此分片适用于，提前规划好分片字段某个范围属于哪个分片</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;range-sharding&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>range-partition.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置说明：</p>
<ul>
<li>mapFile 代表配置文件路径</li>
<li>defaultNode 超过范围后的默认节点。</li>
</ul>
<p>所有的节点配置都是从0 开始，及0 代表节点1。</p>
<p>mapFile中的定义规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start &lt;= range &lt;= end. </span><br><span class="line">range start-end=data node index </span><br><span class="line">K=1000,M=10000.</span><br></pre></td></tr></table></figure>

<p>配置示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0-500M=0 </span><br><span class="line">500M-1000M=1 </span><br><span class="line">1000M-1500M=2</span><br></pre></td></tr></table></figure>

<p>或 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0-10000000=0 </span><br><span class="line">10000001-20000000=1</span><br></pre></td></tr></table></figure>

<p><strong>示例</strong></p>
<p>在mycat中定义分片表：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>members<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>range-members-count<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;range-members-count&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>company-range-partition.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>company-range-partition.txt中分片定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0-10=0 </span><br><span class="line">11-50=1 </span><br><span class="line">51-100=2 </span><br><span class="line">101-1000=0 </span><br><span class="line">1001-9999=1 </span><br><span class="line">10000-9999999=2</span><br></pre></td></tr></table></figure>

<p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_company( </span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    members <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company01&#x27;</span>,<span class="number">10</span>); <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company01&#x27;</span>,<span class="number">20</span>); <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company01&#x27;</span>,<span class="number">200</span>);</span><br></pre></td></tr></table></figure>

<h3 id="按日期范围分片"><a href="#按日期范围分片" class="headerlink" title="按日期范围分片"></a>按日期范围分片</h3><p>此规则为按日期段进行分片。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-date<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2018-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2019-01-02<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<ul>
<li>columns ：标识将要分片的表字段</li>
<li>algorithm ：分片函数</li>
<li>dateFormat ：日期格式</li>
<li>sBeginDate ：开始日期</li>
<li>sEndDate：结束日期</li>
<li>sPartionDay ：分区天数，即默认从开始日期算起，分隔10 天一个分区</li>
</ul>
<p><strong>sBeginDate,sEndDate配置情况说明：</strong></p>
<ul>
<li><p><strong>sBeginDate,sEndDate 都有指定</strong><br>此时表的dataNode 数量的&gt;&#x3D;这个时间段算出的分片数，否则启动时会异常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ExceptionInInitializerError at io.mycat.MycatStartup.main(MycatStartup.java:53) </span><br><span class="line">Caused by: io.mycat.config.util.ConfigException: Illegal table conf : table [ T_ORDER ] rule function [ shardi partition size : 4 &gt; table datanode size : 3, please make sure table datanode size = function partition size</span><br></pre></td></tr></table></figure>

<p>如果配置了sEndDate 则代表数据达到了这个日期的分片后循环从开始分片插入。</p>
</li>
<li><p><strong>没有指定 sEndDate 的情况</strong><br>数据分片将依次存储到dataNode上，数据分片随时间增长，所需的dataNode数也随之增长，当超出了为该表配置的dataNode数时，将得到如下异常信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[SQL] INSERT INTO t_order(order_time,customer_id,order_amount) VALUES (&#x27;2019-02-05&#x27;,1001,203);</span><br><span class="line">[Err] 1064 - Can&#x27;t find a valid data node for specified node index :T_ORDER -&gt; ORDER_TIME -&gt; 2019-02-05 -&gt; Index : 3</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>示例</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_order&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;order-sharding-by-date&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;order-sharding-by-date&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-date<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2019-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2019-02-02<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>20<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_order ( </span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    order_time DATETIME, </span><br><span class="line">    customer_id <span class="type">BIGINT</span>, </span><br><span class="line">    order_amount <span class="type">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_order(order_time,customer_id,order_amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-01-05&#x27;</span>,<span class="number">1001</span>,<span class="number">201</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_order(order_time,customer_id,order_amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-01-25&#x27;</span>,<span class="number">1001</span>,<span class="number">202</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_order(order_time,customer_id,order_amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-02-15&#x27;</span>,<span class="number">1001</span>,<span class="number">203</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_order(order_time,customer_id,order_amount) <span class="keyword">VALUES</span> (<span class="string">&#x27;2019-03-15&#x27;</span>,<span class="number">1001</span>,<span class="number">203</span>);</span><br></pre></td></tr></table></figure>

<p>请去看数据的分布！</p>
<h3 id="自然月分片"><a href="#自然月分片" class="headerlink" title="自然月分片"></a>自然月分片</h3><p>按月份列分区，每个自然月一个分片。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-month<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2014-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<ul>
<li>columns： 分片字段，字符串类型</li>
<li>dateFormat ： 日期字符串格式,默认为yyyy-MM-dd</li>
<li>sBeginDate ： 开始日期，无默认值</li>
<li>sEndDate：结束日期，无默认值</li>
<li>节点从0 开始分片</li>
</ul>
<p><strong>使用场景：</strong></p>
<p><strong>场景1：默认设置（不指定sBeginDate、sEndDate）</strong></p>
<p>节点数量必须是12 个，对应1 月~12 月</p>
<ul>
<li>“2017-01-01” &#x3D; 节点0</li>
<li>“2018-01-01” &#x3D; 节点0</li>
<li>2018-05-01” &#x3D; 节点4</li>
<li>“2019-12-01” &#x3D; 节点11</li>
</ul>
<p><strong>场景2 ：仅指定sBeginDate</strong></p>
<p>sBeginDate &#x3D; “2017-01-01” 该配置表示”2017-01 月”是第0 个节点，从该时间按月递增，无最大节点</p>
<ul>
<li>“2014-01-01” &#x3D; 未找到节点</li>
<li>“2017-01-01” &#x3D; 节点0</li>
<li>“2017-12-01” &#x3D; 节点11</li>
<li>“2018-01-01” &#x3D; 节点12</li>
<li>“2018-12-01” &#x3D; 节点23</li>
</ul>
<p><strong>场景3： 指定sBeginDate&#x3D;1月、sEndDate&#x3D;12月</strong></p>
<p>sBeginDate &#x3D; “2015-01-01” sEndDate &#x3D; “2015-12-01” 该配置可看成与场景1 一致。</p>
<ul>
<li>“2014-01-01” &#x3D; 节点0</li>
<li>“2014-02-01” &#x3D; 节点1</li>
<li>“2015-02-01” &#x3D; 节点1</li>
<li>“2017-01-01” &#x3D; 节点0</li>
<li>“2017-12-01” &#x3D; 节点11</li>
<li>“2018-12-01” &#x3D; 节点11</li>
</ul>
<p><strong>场景4：</strong></p>
<p>sBeginDate &#x3D; “2015-01-01”sEndDate &#x3D; “2015-03-01” 该配置表示只有3 个节点；很难与月份对应上；平均分散到3 个节点上</p>
<h3 id="取模"><a href="#取模" class="headerlink" title="取模"></a>取模</h3><p>此规则为对分片字段进行十进制运算，来分片数据。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-sharding&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-fun<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-fun&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置说明：</p>
<ul>
<li>count 指明dataNode 的数量，是求模的基数</li>
</ul>
<p>此种在批量插入时可能存在批量插入单事务插入多数据分片，增大事务一致性难度。</p>
<h3 id="取模范围分片"><a href="#取模范围分片" class="headerlink" title="取模范围分片"></a>取模范围分片</h3><p>此种规则是取模运算与范围约束的结合，主要为了后续数据迁移做准备，即可以自主决定取模后数据的节点 分布。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-pattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByPattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>partition-pattern.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1-32=0 #余数为1-32的放到数据节点0上 \</span><br><span class="line">33-64=1 </span><br><span class="line">65-96=2 </span><br><span class="line">97-128=3 </span><br><span class="line">129-160=4 </span><br><span class="line">161-192=5 </span><br><span class="line">193-224=6 </span><br><span class="line">225-256=7 </span><br><span class="line">0-0=7</span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<ul>
<li>patternValue 即求模基数</li>
<li>defaoultNode 默认节点，如果配置了默认节点，如果id 非数据，则会分配在defaoultNode 默认节点</li>
<li>mapFile 指定余数范围分片配置文件</li>
</ul>
<h3 id="二进制取模范围分片"><a href="#二进制取模范围分片" class="headerlink" title="二进制取模范围分片"></a>二进制取模范围分片</h3><p>本条规则类似于十进制的求模范围分片，区别在于是二进制的操作,是分片列值的二进制低10 位&amp;1111111111。此算法的优点在于如果按照10 进制取模运算，在连续插入1-10 时候1-10 会被分到1-10 个分片，增大了插入的事务控制难度，而此算法根据二进制则可能会分到连续的分片，减少插入事务控制难度。</p>
<p>二进制低10&amp;1111111111 的结果是 0-1023 一共是1024个值，按范围分成多个连续的片（最大1024个片）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>2,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256,512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<ul>
<li>partitionCount 分片个数列表。</li>
<li>partitionLength 分片范围列表</li>
</ul>
<p>分区长度:默认为最大2^n&#x3D;1024 ,即最大支持1024 分区</p>
<p>约束:</p>
<ul>
<li>count,length 两个数组的长度必须是一致的。</li>
<li>1024 &#x3D; sum((count[i] * length[i]))，count 和length 两个向量的点积恒等于1024</li>
</ul>
<p><strong>用法例子:</strong></p>
<p>本例的分区策略：希望将数据水平分成3 份，前两份各占25%，第三份占50%。（本例非均匀分区） &#x2F;&#x2F; |&lt;———————1024———————————&gt;|</p>
<p>&#x2F;&#x2F; |&lt;—-256—&gt;|&lt;—-256—&gt;|&lt;———-512————-&gt;| &#x2F;&#x2F; | partition0 | partition1 | partition2 | &#x2F;&#x2F; | 共2 份,故count[0]&#x3D;2 | 共1 份，故count[1]&#x3D;1 |</p>
<p>如果需要平均分配设置：平均分为4 分片，partitionCount*partitionLength&#x3D;1024</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="范围取模分片"><a href="#范围取模分片" class="headerlink" title="范围取模分片"></a>范围取模分片</h3><p>先进行范围分片计算出分片组，组内再求模。</p>
<p>优点可以避免扩容时的数据迁移，又可以一定程度上避免范围分片的热点问题。综合了范围分片和求模分片的优点，分片组内使用求模可以保证组内数据比较均匀，分片组之间是范围分片可以兼顾范围查询。</p>
<p>最好事先规划好分片的数量，数据扩容时按分片组扩容，则原有分片组的数据不需要迁移。由于分片组内数据比 较均匀，所以分片组内可以避免热点数据问题。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-rang-mod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-mod<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-mod&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByRangeMod&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-range-mod.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>21<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置说明：</p>
<ul>
<li>mapFile 配置文件路径</li>
<li>defaultNode 超过范围后的默认节点顺序号，节点从0 开始。</li>
</ul>
<p>partition-range-mod.txt 以下配置一个范围代表一个分片组，&#x3D;号后面的数字代表该分片组所拥有的分片的数量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0-200M=5 //代表有5个分片节点 </span><br><span class="line">200M1-400M=1 </span><br><span class="line">400M1-600M=4 </span><br><span class="line">600M1-800M=4 </span><br><span class="line">800M1-1000M=6</span><br></pre></td></tr></table></figure>

<h3 id="一致性hash"><a href="#一致性hash" class="headerlink" title="一致性hash"></a>一致性hash</h3><p>一致性hash 算法有效解决了分布式数据的扩容问题。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;murmur&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 默认是0--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一个实际的数据库节点被映射为多少个虚拟节点，默认是160 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt; 节点的权重，没有指定权重的节点默认是1。以properties 文件的格式填写，以从0 开始到count-1 的整数值也 就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1 代替--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;property name=&quot;bucketMapPath&quot;&gt;/etc/mycat/bucketMapPath&lt;/property&gt; 用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash 值与物理 节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="应用指定"><a href="#应用指定" class="headerlink" title="应用指定"></a>应用指定</h3><p>此规则是在运行阶段有应用自主决定路由到那个分片。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-substring&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-substring<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-substring&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionDirectBySubString&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;startIndex&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- zero-based --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;size&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultPartition&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<p>此方法为直接根据字符子串（必须是数字）计算分区号（由应用传递参数，显式指定分区号）。 例如id&#x3D;05-100000002 在此配置中代表根据id 中从startIndex&#x3D;0，开始，截取siz&#x3D;2 位数字即05，05 就是获取的分区，如果没传 默认分配到defaultPartition</p>
<h3 id="截取字符ASCII求和求模范围分片"><a href="#截取字符ASCII求和求模范围分片" class="headerlink" title="截取字符ASCII求和求模范围分片"></a>截取字符ASCII求和求模范围分片</h3><p>此种规则类似于取模范围约束，只是计算的数值是取前几个字符的ASCII值和，再取模，再对余数范围分片。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-prefixpattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-prefixpattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByPrefixPattern&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefixLength&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>partition-pattern.tx</p>
<p>range start-end &#x3D;data node index </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#ASCII </span><br><span class="line">#8-57=0-9 阿拉伯数字 </span><br><span class="line">#64、65-90=@、A-Z </span><br><span class="line">#97-122=a-z </span><br><span class="line">1-4=0 # 余数1-4的放到0号数据节点 </span><br><span class="line">5-8=1 </span><br><span class="line">9-12=2 </span><br><span class="line">13-16=3 </span><br><span class="line">17-20=4 </span><br><span class="line">21-24=5 </span><br><span class="line">25-28=6</span><br><span class="line">29-32=7 </span><br><span class="line">0-0=7</span><br></pre></td></tr></table></figure>

<p>配置说明：</p>
<ul>
<li>patternValue 即求模基数，</li>
<li>prefifixLength ASCII 截取的位数，求这几位字符的ASCII码值的和，再求余patternValue</li>
<li>mapFile 配置文件路径，配置文件中配置余数范围分片规则。</li>
</ul>
<h2 id="主键值生成"><a href="#主键值生成" class="headerlink" title="主键值生成"></a>主键值生成</h2><p>在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_customer( </span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    province <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-province&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>为此，MyCat 提供了全局sequence，并且提供了包含本地配置和数据库配置等多种实现方式。</strong></p>
<h3 id="本地文件方式"><a href="#本地文件方式" class="headerlink" title="本地文件方式"></a>本地文件方式</h3><p>原理：此方式MyCAT 将sequence 配置到文件中，当使用到sequence 中的配置后，MyCAT 会更新 conf中的sequence_conf.properties 文件中sequence 当前的值。</p>
<p><strong>配置方式：</strong></p>
<p>1、在sequence_conf.properties 文件中做如下配置： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GLOBAL.HISIDS= </span><br><span class="line">GLOBAL.MINID=1001</span><br><span class="line">GLOBAL.MAXID=1000000000</span><br><span class="line">GLOBAL.CURID=1000</span><br></pre></td></tr></table></figure>

<p>其中HISIDS 表示使用过的历史分段(一般无特殊需要可不配置)，MINID 表示最小ID 值，MAXID 表示最大 ID 值，CURID 表示当前ID 值。</p>
<p>2、server.xml 中配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注：sequnceHandlerType 需要配置为0，表示使用本地文件方式。</p>
<p><strong>使用示例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table1(id,name) <span class="keyword">values</span>(next <span class="keyword">value</span> <span class="keyword">for</span> MYCATSEQ_GLOBAL,‘test’);</span><br></pre></td></tr></table></figure>

<p>缺点：当MyCAT 重新发布后，配置文件中的sequence 会恢复到初始值。 优点：本地加载，读取速度较快。</p>
<p><strong>为表配置主键自增值的序列：</strong></p>
<p>规则：在sequence_conf.properties 中配置以表名为名的序列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">T_COMPANY.CURID=501 </span><br><span class="line">T_COMPANY.MINID=1 </span><br><span class="line">T_COMPANY.MAXID=1000000000</span><br></pre></td></tr></table></figure>

<p>就可以使用了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company06&#x27;</span>,<span class="number">200</span>); <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_company;</span><br></pre></td></tr></table></figure>

<h3 id="数据库方式"><a href="#数据库方式" class="headerlink" title="数据库方式"></a>数据库方式</h3><p><strong>原理</strong></p>
<p>在数据库中建立一张表，存放sequence 名称(name)，sequence 当前值(current_value)，步长(increment int类型，每次读取多少个sequence)等信息；</p>
<p><strong>Sequence 获取步骤：</strong></p>
<ol>
<li>当初次使用该sequence 时，根据传入的sequence 名称，从数据库这张表中读取current_value，和increment 到MyCat 中，并将数据库中的current_value 设置为原current_value 值+increment 值。</li>
<li>MyCat 将读取到current_value+increment 作为本次要使用的sequence 值，下次使用时，自动加1，当使用increment 次后，执行步骤1)相同的操作。</li>
</ol>
<p>MyCat 负责维护这张表，用到哪些sequence，只需要在这张表中插入一条记录即可。若某次读取的 sequence 没有用完，系统就停掉了，则这次读取的sequence 剩余值不会再使用。</p>
<p><strong>配置方式：</strong></p>
<p><strong>server.xml 配置：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注：sequnceHandlerType 需要配置为1，表示使用数据库方式生成sequence。</p>
<p><strong>数据库配置：</strong></p>
<ol>
<li><p>创建MYCAT_SEQUENCE 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建存放sequence 的表 </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> MYCAT_SEQUENCE; </span><br><span class="line"><span class="comment">-- name sequence 名称 </span></span><br><span class="line"><span class="comment">-- current_value 当前value </span></span><br><span class="line"><span class="comment">-- increment 增长步长! 可理解为mycat 在数据库中一次读取多少个sequence. 当这些用完后, 下次再从数据库中 读取。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> MYCAT_SEQUENCE ( </span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">    current_value <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">    increment <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>, </span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY(name)</span><br><span class="line">); </span><br><span class="line"><span class="comment">-- 插入一条sequence </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> MYCAT_SEQUENCE(name,current_value,increment) <span class="keyword">VALUES</span> (<span class="string">&#x27;GLOBAL&#x27;</span>, <span class="number">100000</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建相关function</p>
   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取sequence当前值(返回当前值,增量)的函数 </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> mycat_seq_currval; </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_currval(seq_name <span class="type">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="type">varchar</span>(<span class="number">64</span>) </span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> retval <span class="type">VARCHAR</span>(<span class="number">64</span>); </span><br><span class="line">	<span class="keyword">SET</span> retval<span class="operator">=</span><span class="string">&#x27;-999999999,null&#x27;</span>; </span><br><span class="line">	<span class="keyword">SELECT</span> concat(<span class="built_in">CAST</span>(current_value <span class="keyword">AS</span> <span class="type">CHAR</span>),<span class="string">&#x27;,&#x27;</span>,<span class="built_in">CAST</span>(increment <span class="keyword">AS</span> <span class="type">CHAR</span>)) <span class="keyword">INTO</span> retval </span><br><span class="line">	<span class="keyword">FROM</span> MYCAT_SEQUENCE </span><br><span class="line">	<span class="keyword">WHERE</span> name <span class="operator">=</span> seq_name; </span><br><span class="line">	<span class="keyword">RETURN</span> retval; </span><br><span class="line"><span class="keyword">END</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置sequence 值的函数 </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> mycat_seq_setval; </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_setval(seq_name <span class="type">VARCHAR</span>(<span class="number">50</span>),<span class="keyword">value</span> <span class="type">INTEGER</span>) <span class="keyword">RETURNS</span> <span class="type">varchar</span>(<span class="number">64</span>) </span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">UPDATE</span> MYCAT_SEQUENCE </span><br><span class="line">	<span class="keyword">SET</span> current_value <span class="operator">=</span> <span class="keyword">value</span> </span><br><span class="line">	<span class="keyword">WHERE</span> name <span class="operator">=</span> seq_name; </span><br><span class="line">	<span class="keyword">RETURN</span> mycat_seq_currval(seq_name); </span><br><span class="line"><span class="keyword">END</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取下一个sequence 值 </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> mycat_seq_nextval; </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_nextval(seq_name <span class="type">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="type">varchar</span>(<span class="number">64</span>) </span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">UPDATE</span> MYCAT_SEQUENCE </span><br><span class="line">	<span class="keyword">SET</span> current_value <span class="operator">=</span> current_value <span class="operator">+</span> increment </span><br><span class="line">	<span class="keyword">WHERE</span> name <span class="operator">=</span> seq_name; </span><br><span class="line">	<span class="keyword">RETURN</span> mycat_seq_currval(seq_name); </span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>   <strong>注意：</strong>MYCAT_SEQUENCE 表和以上的3 个function，需要放在同一个节点上。function 请直接在具体节点的数据库上执行，如果执行的时候报： you might want to use the less safe log_bin_trust_function_creators variable</p>
<p>   需要对数据库做如下设置： windows 下my.ini[mysqld]加上log_bin_trust_function_creators&#x3D;1 linux下&#x2F;etc&#x2F;my.cnf 下my.ini[mysqld]加上log_bin_trust_function_creators&#x3D;1 修改完后，即可在mysql 数据库中执行上面的函数。</p>
<ol start="3">
<li><p>sequence_db_conf.properties 相关配置,指定sequence 相关配置在哪个节点上：</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USER_SEQ=test_dn1</span><br></pre></td></tr></table></figure>

<p>使用示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table1(id,name) <span class="keyword">values</span>(next <span class="keyword">value</span> <span class="keyword">for</span> MYCATSEQ_GLOBAL,<span class="string">&#x27;test&#x27;</span>)；</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>配置表的主键自增使用序列：</strong></p>
<ol>
<li><p>在序列定义表中增加名字为表名的序列：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> MYCAT_SEQUENCE(name,current_value,increment) <span class="keyword">VALUES</span> (<span class="string">&#x27;T_COMPANY&#x27;</span>, <span class="number">1</span>,<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在sequence_db_conf.properties中增加表的序列配置</p>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T_COMPANY=dn1</span><br></pre></td></tr></table></figure>
</li>
<li><p>主键自增就可以使用了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company08&#x27;</span>,<span class="number">200</span>); </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_company;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="本地时间戳方式"><a href="#本地时间戳方式" class="headerlink" title="本地时间戳方式"></a>本地时间戳方式</h3><p><strong>原理：</strong></p>
<p>ID&#x3D; 64 位二进制：42(毫秒)+5(机器ID)+5(业务编码)+12(重复累加)</p>
<p>换算成十进制为18 位数的long 类型，每毫秒可以并发12 位二进制的累加。</p>
<p><strong>使用方式：</strong></p>
<ol>
<li><p>配置server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在mycat 下配置：sequence_time_conf.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WORKID=0-31 任意整数 表示机器id（或mycat实例id） </span><br><span class="line">DATAACENTERID=0-31 任意整数 业务编码</span><br></pre></td></tr></table></figure>

<p>多个mycat 节点下每个mycat 配置的WORKID，DATAACENTERID 不同，组成唯一标识，总共支持32*32&#x3D;1024 种组合。<br>ID 示例：56763083475511 。</p>
</li>
</ol>
<p><strong>主键自增配置</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company09&#x27;</span>,<span class="number">200</span>); </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_company;</span><br></pre></td></tr></table></figure>

<h3 id="分布式ZK-ID-生成器"><a href="#分布式ZK-ID-生成器" class="headerlink" title="分布式ZK ID 生成器"></a>分布式ZK ID 生成器</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置</strong></p>
<ol>
<li><p>Zk 的连接信息统一在myid.properties 的zkURL 属性中配置。<strong>此只需关注zkURL。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loadZk=<span class="literal">false</span></span><br><span class="line">zkURL=127.0.0.1:2181</span><br><span class="line">clusterId=mycat-cluster-1</span><br><span class="line">myid=mycat_fz_01</span><br><span class="line">clusterSize=3</span><br><span class="line">clusterNodes=mycat_fz_01,mycat_fz_02,mycat_fz_04</span><br><span class="line"><span class="comment">#server booster; booster install on db same server,will reset all minCon to 2</span></span><br><span class="line"><span class="built_in">type</span>=server</span><br><span class="line">boosterDataHosts=dataHost1</span><br></pre></td></tr></table></figure>

<p>基于ZK 与本地配置的分布式ID 生成器，ID 结构：long 64 位，ID 最大可占63 位：</p>
<ul>
<li><p>|current time millis(微秒时间戳38 位,可以使用17 年)|clusterId（机房或者ZKid，通过配置文件配置5</p>
<p>位）|instanceId（实例ID，可以通过ZK 或者配置文件获取，5 位）|threadId（线程ID，9 位）</p>
<p>|increment(自增,6 位)</p>
</li>
<li><p>一共63 位，可以承受单机房单机器单线程1000*(2^6)&#x3D;640000 的并发。</p>
</li>
<li><p>无悲观锁，无强竞争，吞吐量更高</p>
</li>
</ul>
</li>
<li><p>配置文件：sequence_distributed_conf.properties，只要配置里面：INSTANCEID&#x3D;ZK 就是从ZK 上获取InstanceID。(可以通过ZK 获取集群（机房）唯一InstanceID，也可以通过配置文件配置InstanceID)</p>
</li>
</ol>
<p><strong>测试：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company10&#x27;</span>,<span class="number">200</span>); </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_company;</span><br></pre></td></tr></table></figure>

<h3 id="Zk-递增方式"><a href="#Zk-递增方式" class="headerlink" title="Zk 递增方式"></a>Zk 递增方式</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Zk 的连接信息统一在myid.properties 的zkURL 属性中配置。</p>
<p><strong>配置：</strong></p>
<p>配置文件：sequence_conf.properties 只要配置好ZK 地址和表名的如下属性</p>
<ul>
<li>TABLE.MINID 某线程当前区间内最小值</li>
<li>TABLE.MAXID 某线程当前区间内最大值</li>
<li>TABLE.CURID 某线程当前区间内当前值</li>
</ul>
<p>文件配置的MAXID 以及MINID 决定每次取得区间，这个对于每个线程或者进程都有效。文件中的这三个属性配置只对第一个进程的第一个线程有效，其他线程和进程会动态读取ZK。</p>
<p><strong>测试：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_company(name,members) <span class="keyword">VALUES</span>(<span class="string">&#x27;company12&#x27;</span>,<span class="number">200</span>); </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_company;</span><br></pre></td></tr></table></figure>

<h3 id="last-insert-id-问题"><a href="#last-insert-id-问题" class="headerlink" title="last_insert_id() 问题"></a>last_insert_id() 问题</h3><p>我们配置分片表主键自增。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;range-sharding-by-members-count&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>如需通过 select last_insert_id() 来获得自增主键值，则表定义中主键列需是自增的AUTO_INCREMENT： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_company( </span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    members <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>如果没有指定 AUTO_INCREMENT，则select last_insert_id() 获取不到刚插入数据的主键值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_company(</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">    members <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>Mybatis 中新增记录后获取last_insert_id 的示例：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.study.user.model.User&quot;</span>&gt;</span> insert into t_user (user_name,login_name,login_pwd,role_id) values(#&#123;userName&#125;,#&#123;loginName&#125;,#&#123;loginPwd&#125;,#&#123;roleId&#125;) </span><br><span class="line">    <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span> <span class="attr">order</span>=<span class="string">&quot;AFTER&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span> </span><br><span class="line">        select last_insert_id() as id </span><br><span class="line">    <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>






      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/04-MyCat%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" data-id="clmcxed6200clu8wa1t38ej29" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/02-MyCat/03-MyCat进阶特性详解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/03-MyCat%E8%BF%9B%E9%98%B6%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.880Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="核心概念理解和工作原理"><a href="#核心概念理解和工作原理" class="headerlink" title="核心概念理解和工作原理"></a>核心概念理解和工作原理</h1><h2 id="Mycat版本说明"><a href="#Mycat版本说明" class="headerlink" title="Mycat版本说明"></a>Mycat版本说明</h2><ul>
<li>Mycat-mini-monitor项目开源了,又一款Mycat监控! - Mycat-mini-monitor-1.0.0 版本发布</li>
<li>Mycat-server-1.6.6-release 版本发布</li>
<li>Mycat-server-1.6.6-test 版本发布</li>
<li>Mycat-server-1.6-release 版本发布</li>
<li>Mycat-server-1.5-release 版本发布</li>
<li>Mycat-server-1.4-release 版本发布</li>
<li>Mycat-server-1.3-release 版本发布</li>
<li>Mycat-web(eye) 版本发布</li>
</ul>
<h2 id="Mycat工作原理"><a href="#Mycat工作原理" class="headerlink" title="Mycat工作原理"></a>Mycat工作原理</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224180206.png"></p>
<p><strong>Mycat 的原理</strong>： ‚拦截‛，它拦截了用户发送过来的SQL 语句，首先解析SQL 语句，做一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户；</p>
<h2 id="Mycat架构"><a href="#Mycat架构" class="headerlink" title="Mycat架构"></a>Mycat架构</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224180351.png"></p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>数据库中间件</strong>：对应用，mycat就是数据库服务，mycat是后端数据库集群的代理</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224180453.png"></p>
<p><strong>逻辑概念:</strong></p>
<ul>
<li>逻辑库：mycat数据库服务中定义、管理的数据库</li>
<li>逻辑表：逻辑库中包含的需分库分表存储的表</li>
<li>dataNode：数据节点（分片节点），逻辑表分片的存放节点。</li>
<li>dataHost: 数据主机（节点主机），数据节点所在的主机。</li>
</ul>
<p><strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;testdb&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span><span class="attr">...</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.2:3306&quot;</span><span class="attr">...</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>物理概念</strong></p>
<ul>
<li>writeHost：写主机，真实的数据库服务主机描述</li>
<li>readHost：读主机，真实的数据库服务主机描述</li>
</ul>
<p><strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;testdb&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span><span class="attr">...</span>&gt;</span> <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.2:3306&quot;</span><span class="attr">...</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="schema配置-schema"><a href="#schema配置-schema" class="headerlink" title="schema配置-schema"></a>schema配置-schema</h2><p><strong>逻辑库 schema</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>MyCat 可以有多个逻辑库，每个逻辑库都有自己的相关配置。</p>
<p>如果不配置schema 标签，所有的表配置，会属于同一个默认的逻辑库。</p>
<h2 id="schema配置-schema元素属性说明"><a href="#schema配置-schema元素属性说明" class="headerlink" title="schema配置-schema元素属性说明"></a>schema配置-schema元素属性说明</h2><table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>逻辑数据库名</td>
</tr>
<tr>
<td>dataNode</td>
<td>String</td>
<td>(0..1)</td>
<td>该库中未指定dataNode的表的默认存储节点</td>
</tr>
<tr>
<td>checkSQLschema</td>
<td>boolean</td>
<td>(1)</td>
<td>是否检查SQL语句中库名(select * from TESTDB.orders;)，如果设置为true，会检查；当库名与逻辑库名相同时，会去掉语句中的库名前缀。<br />这么做的目的避免发送到后端数据库执行时报（ERROR1146 (42S02): Table ‘testdb.travelrecord’ doesn’t exist）。</td>
</tr>
<tr>
<td>sqlMaxLimit</td>
<td>int</td>
<td>(1)</td>
<td>对于拆分库的schema，当该值设置为某个数值时，每条执行的SQL 语句，如果没有加上limit 子句，MyCat 会自动加上。<br />例如：设置值为100，执行select * from TESTDB.travelrecord;的效果为select * from TESTDB.travelrecord limit 100;</td>
</tr>
</tbody></table>
<h2 id="schema配置-table"><a href="#schema配置-table" class="headerlink" title="schema配置-table"></a>schema配置-table</h2><p><strong>逻辑表 table</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;travelrecord&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;goods&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_items&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Table标签定义了MyCat中的逻辑表，所有需要拆分的表都需要通过这个标签定义。</p>
<h2 id="schema配置-table元素属性说明"><a href="#schema配置-table元素属性说明" class="headerlink" title="schema配置-table元素属性说明"></a>schema配置-table元素属性说明</h2><table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>表名，同个schema 标签中定义的名字必须唯一。</td>
</tr>
<tr>
<td>dataNode</td>
<td>String</td>
<td>(1..*)</td>
<td>存放表数据的数据节点名。<br />很多难以罗列时，可以这样配置：dataNode&#x3D;‚multipleDn$0-99,multipleDn2$100-199‛，$0-99表示0-99<br />&lt;dataNode name&#x3D;”multipleDn$0-99” dataHost&#x3D;”localhost1” database&#x3D;”db$0-99” &gt;&lt; &#x2F;dataNode&gt;</td>
</tr>
<tr>
<td>rule</td>
<td>String</td>
<td>(0..1)</td>
<td>指定逻辑表要使用的分片规则名字，规则名字在rule.xml 中定义，必须与tableRule标签中name 属性属性值一一对应。</td>
</tr>
<tr>
<td>ruleRequired</td>
<td>boolean</td>
<td>(0..1)</td>
<td>该属性用于指定表是否绑定分片规则，如果配置为true，但没有配置具体rule 的话，程序会报错。</td>
</tr>
<tr>
<td>primaryKey</td>
<td>String</td>
<td>(1)</td>
<td>该逻辑表对应真实表的主键，当分片的规则是使用非主键进行分片的，那么在使用主键查询的时候，就会发送查询语句到所有配置的DN 上，如果使用该属性配置了主键，那么MyCat 会缓存主键与具体DN 的信息，那么再次使用非主键进行查询的时候就不会进行广播式的查询，会直接发送语句给具体的DN。<br/>注意：尽管配置该属性，如果缓存并没有命中的话，还是会发送语句给具体的DN，来获得数据。</td>
</tr>
<tr>
<td>type</td>
<td>String</td>
<td>(0..1)</td>
<td>定义逻辑表的类型，目前只有‚全局表‛和‛普通表‛两种。<br/>对应的配置：<br/>全局表：global<br/>普通表：不指定该值为globla 的所有表</td>
</tr>
<tr>
<td>autoIncrement</td>
<td>boolean</td>
<td>(0..1)</td>
<td>是否使用主键自增长</td>
</tr>
<tr>
<td>subTables</td>
<td>String</td>
<td>(1)</td>
<td>分表，subTables&#x3D;”t_order$1-2,t_order3”。<br/>目前分表1.6以后开始支持，并且 dataNode 在分表条件下只能配置一个，分表条件下<br/>不支持各种条件的 join 语句。</td>
</tr>
<tr>
<td>needAddLimit</td>
<td>boolean</td>
<td>(0..1)</td>
<td>指定表是否需要自动的在每个语句后面加上 limit 限制。由于使用了分库分表，数据量有时会特别巨大。这时候执行查询语句，若恰巧忘记了加上数量限制，那么想要查询所有的数据，则需要等待一段时间。<br/>所以，mycat 就自动的为我们加上LIMIT 100。当然，如果语句中有limit，就不会再次添加了。这个属性默认为true，你也可以设置成 false 禁用掉默认行为。</td>
</tr>
</tbody></table>
<h2 id="schema配置-childTable标签"><a href="#schema配置-childTable标签" class="headerlink" title="schema配置-childTable标签"></a>schema配置-childTable标签</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_items&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>childTable 标签用于定义E-R 分片的子表，通过标签上的属性与父表进行关联。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>子表名</td>
</tr>
<tr>
<td>primaryKey</td>
<td>String</td>
<td>(0..1)</td>
<td>字表的主键列名</td>
</tr>
<tr>
<td>joinKey</td>
<td>String</td>
<td>(1)</td>
<td>字表中与父表关联的列</td>
</tr>
<tr>
<td>parentKey</td>
<td>String</td>
<td>(1)</td>
<td>父表中关联的列</td>
</tr>
</tbody></table>
<h2 id="schema配置-dataHost"><a href="#schema配置-dataHost" class="headerlink" title="schema配置-dataHost"></a>schema配置-dataHost</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.200:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;xxx&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>dataHost定义Mycat中的数据主机，数据主机定义中定义了具体的数据库服务、读写分离配置和心跳语句。这是与物理数据库服务关联的地方。</p>
<h2 id="schema配置-dataHost元素属性说明"><a href="#schema配置-dataHost元素属性说明" class="headerlink" title="schema配置-dataHost元素属性说明"></a>schema配置-dataHost元素属性说明</h2><table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>String</td>
<td>(1)</td>
<td>数据主机名，唯一</td>
</tr>
<tr>
<td>maxCon</td>
<td>int</td>
<td>(1)</td>
<td>指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数。</td>
</tr>
<tr>
<td>minCon</td>
<td>int</td>
<td>(1)</td>
<td>指定每个读写实例连接池的最小连接，初始化连接池的大小。</td>
</tr>
<tr>
<td>balance</td>
<td>int</td>
<td>(1)</td>
<td>负载均衡类型，目前的取值有4 种：<br/>1、balance&#x3D;”0”，不开启读写分离机制，所有读操作都发送到当前可用的writeHost 上。<br/>2、balance&#x3D;”1”，全部的readHost 与stand by writeHost 参与select 语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1 与M2 互为主备)，正常情况下，M2,S1,S2 都参与select 语句的负载均衡。 <br/>3、balance&#x3D;”2”，所有读操作都随机的在writeHost、readhost 上分发。 <br/>4、balance&#x3D;”3” ， 所有读请求随机的分发到 writeHost 对应的 readhost 执 行 ，writeHost 不负担读压力，注意balance&#x3D;3 只在1.4 及其以后版本有，1.3 没有。</td>
</tr>
<tr>
<td>writeType</td>
<td>int</td>
<td>(1)</td>
<td>1、writeType&#x3D;”0”，所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个writeHost，重新启动后已切换后的为准，切换记录在配置文件中：dnindex.properties 。<br/>2、writeType&#x3D;”1”，所有写操作都随机的发送到配置的writeHost（1.5 以后废弃不推荐）</td>
</tr>
<tr>
<td>switchType</td>
<td>int</td>
<td>(1)</td>
<td>-1 表示不自动切换。 1 默认值，自动切换。2 基于MySQL 主从同步的状态决定是否切换。</td>
</tr>
<tr>
<td>dbType</td>
<td>String</td>
<td>(1)</td>
<td>指定后端连接的数据库类型，目前支持二进制的mysql 协议，还有其他使用JDBC 连接的数据库。例如：mongodb、oracle、spark 等。</td>
</tr>
<tr>
<td>dbDriver</td>
<td>String</td>
<td>(1)</td>
<td>指定连接后端数据库使用的Driver，目前可选的值有native 和JDBC。 <br/>1、使用native 的话，因为这个值执行的是二进制的mysql 协议，所以可以使用mysql 和mariadb。从1.6 版本开始支持postgresql 的native 原始协议。 <br/>2、使用JDBC 的话需要将符合JDBC 4 标准的驱动JAR 包放到MYCAT\lib 目录下，并检查驱动JAR 包中包括如下目录结构的文件：META-INF\services\java.sql.Driver。在这个文件内写上具体的Driver 类名，例如：com.mysql.jdbc.Driver。</td>
</tr>
</tbody></table>
<h2 id="schema配置-heartbeat"><a href="#schema配置-heartbeat" class="headerlink" title="schema配置-heartbeat"></a>schema配置-heartbeat</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.200:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;xxx&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>这个标签内指明用于和后端数据库进行心跳检查的语句如：MYSQL 可以使用select user()，Oracle 可以使用select 1 from dual 等。</li>
<li>这个标签还有一个connectionInitSql 属性，主要是当使用Oracle数据库时，需要执行的初始化SQL语句就放到这里。 如：alter session set nls_date_format&#x3D;’yyyy-mm-dd hh24:mi:ss’<br>1.4 主从切换的语句必须是：show slave status</li>
</ol>
<h2 id="schema配置-writeHost-readHost"><a href="#schema配置-writeHost-readHost" class="headerlink" title="schema配置-writeHost readHost"></a>schema配置-writeHost readHost</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.200:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;xxx&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这两个标签都指定后端数据库的相关配置给mycat，用于实例化后端连接池。writeHost 指定写实例、readHost 指定读实例。</p>
<p>在一个dataHost 内可以定义多个writeHost 和readHost。但是，如果writeHost 指定的后端数据库宕机，那么这个writeHost 绑定的所有readHost 都将不可用。另一方面，由于这个writeHost 宕机系统会自动的检测到，并切换到备用的writeHost 上去。</p>
<h2 id="schema配置-writeHost-readHost属性说明"><a href="#schema配置-writeHost-readHost属性说明" class="headerlink" title="schema配置-writeHost readHost属性说明"></a>schema配置-writeHost readHost属性说明</h2><table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>host</td>
<td>String</td>
<td>(1)</td>
<td>用于标识不同实例，一般writeHost 我们使用* M1，readHost 我们用* S1。</td>
</tr>
<tr>
<td>url</td>
<td>String</td>
<td>(1)</td>
<td>后端实例连接地址<br/>若是用native 的dbDriver，则一般为address:port 这种形式。<br/>若是用JDBC 或其他的dbDriver，则需要特殊指定。（当使用JDBC 时则可以这么写：jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;）</td>
</tr>
<tr>
<td>user</td>
<td>String</td>
<td>(1)</td>
<td>连接后端存储实例的用户名</td>
</tr>
<tr>
<td>password</td>
<td>String</td>
<td>(1)</td>
<td>密码</td>
</tr>
</tbody></table>
<p>加密密码，执行mycat jar 程序（1.4.1 以后）</p>
<p>java -cp Mycat-server-1.4.1-dev.jar io.mycat.util.DecryptUtil 1:host:user:password Mycat-server-1.4.1-dev.jar 为mycat download 下载目录的jar<br>1:host:user:password 中1 为db 端加密标志，host 为dataHost 的host 名称</p>
<h1 id="Mycat如何解决分库分表带来的挑战"><a href="#Mycat如何解决分库分表带来的挑战" class="headerlink" title="Mycat如何解决分库分表带来的挑战"></a>Mycat如何解决分库分表带来的挑战</h1><h2 id="挑战的解决思路"><a href="#挑战的解决思路" class="headerlink" title="挑战的解决思路"></a>挑战的解决思路</h2><p>第一原则：能不切分尽量不要切分<br>第二原则：如果要切分一定要选择合适的切分规则，提前规划好。<br>第三原则：数据切分尽量通过数据冗余或表分组（Table Group）来降低跨库Join 的可能。<br>第四原则：由于数据库中间件对数据Join实现的优劣难以把握，而且实现高性能难度极大，业务读取尽量少使用多表Join。</p>
<h1 id="Mycat解决分库分表的难点实战"><a href="#Mycat解决分库分表的难点实战" class="headerlink" title="Mycat解决分库分表的难点实战"></a>Mycat解决分库分表的难点实战</h1><h2 id="Mycat中表分类"><a href="#Mycat中表分类" class="headerlink" title="Mycat中表分类"></a>Mycat中表分类</h2><p><strong>分片表</strong></p>
<p>分片表，是指那些有很大数据，需要切分到多个数据库的表，这样每个分片都有一部分数据，所有分片构成了完整的数据。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_goods&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;vid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;rule1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>非分片表</strong></p>
<p>一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就是那些不需要进行数据切分的表。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_node&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;vid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Mycat中表分类-1"><a href="#Mycat中表分类-1" class="headerlink" title="Mycat中表分类"></a>Mycat中表分类</h2><p><strong>ER表</strong></p>
<p>Mycat 中的ER 表是基于E-R 关系的数据分片策略，子表的记录与所关联的父表记录存放在同一个数据分片上，保证数据Join 不会跨库操作。<br>ER分片是解决跨分片数据join 的一种很好的思路，也是数据切分规划的一条重要规则。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_items&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">childTable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>全局表</strong></p>
<p>一个真实的业务系统中，往往存在大量的类似字典表的表，数据量不大，这些表基本上很少变动。</p>
<p><strong>问题：</strong>业务表往往需要和字典表Join查询，当业务表因为规模而进行分片以后，业务表与字典表之间的关联跨库了。</p>
<p><strong>解决：</strong>Mycat中通过表冗余来解决这类表的join，即它的定义中指定的dataNode上都有一份该表的拷贝。（将字典表或者符合字典表特性的表定义为全局表。 ）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="分片规则"><a href="#分片规则" class="headerlink" title="分片规则"></a>分片规则</h2><p>在conf&#x2F;rule.xml中定义分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>128<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Mycat架构实践方案"><a href="#Mycat架构实践方案" class="headerlink" title="Mycat架构实践方案"></a>Mycat架构实践方案</h2><p><strong>Haproxy + Mycat集群 + 读写分离</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224192007.png"></p>
<h2 id="Mycat高可用方案"><a href="#Mycat高可用方案" class="headerlink" title="Mycat高可用方案"></a>Mycat高可用方案</h2><p><strong>Haproxy + Mycat集群 + 分库分表</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224192054.png"></p>
<h2 id="Mycat监控介绍"><a href="#Mycat监控介绍" class="headerlink" title="Mycat监控介绍"></a>Mycat监控介绍</h2><p><img src="/04-MyCat%E8%BF%9B%E9%98%B6%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3.assets/20221224192252.png"></p>
<p><strong>Mycat-web(eye)</strong><br>支持对Mycat、Mysql性能监控<br>支持对Mycat的JVM内存提供监控服务<br>支持对线程的监控<br>支持对操作系统的CPU、内存、磁盘、网络的监控</p>
<p><strong>现在还有 Mycat-mini-monitor</strong> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/03-MyCat%E8%BF%9B%E9%98%B6%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3/" data-id="clmcxed5v00cku8wa3c6p759k" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/02-MyCat/02-MyCat安装" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/02-MyCat%E5%AE%89%E8%A3%85/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.874Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>MySQL5.7 Centos7</p>
<p>JDK1.7+</p>
<p>Mycat 版本：1.6.6.1</p>
<h1 id="jdk安装"><a href="#jdk安装" class="headerlink" title="jdk安装"></a>jdk安装</h1><ol>
<li><p>上传jdk安装包到linux机器上</p>
</li>
<li><p>root用户身份安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jdk-8u162-linux-x64.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>jdk安装在&#x2F;usr&#x2F;java目录下</p>
</li>
<li><p>配置java环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure>

<p>在文件末尾追加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/latest</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>保存退出，执行下面命令使配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="MySQL安装：参照前面文章手册"><a href="#MySQL安装：参照前面文章手册" class="headerlink" title="MySQL安装：参照前面文章手册"></a>MySQL安装：参照前面文章手册</h1><p>注意：Linux 下部署安装MySQL，默认不忽略表名大小写，需要手动到&#x2F;etc&#x2F;my.cnf 下追加lower_case_table_names&#x3D;1 使Linux 环境下MySQL 忽略表名大小写，否则使用MyCAT 的 时候会提示找不到 表的错误！</p>
<h1 id="Mycat安装"><a href="#Mycat安装" class="headerlink" title="Mycat安装"></a>Mycat安装</h1><h2 id="解压安装包"><a href="#解压安装包" class="headerlink" title="解压安装包"></a>解压安装包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf Mycat-server-1.6.6.1-release-20181031195535-linux.tar.gz</span><br></pre></td></tr></table></figure>

<p> bin 程序目录，存放了window 版本和linux 版本，除了提供封装成服务的版本之外， 也提供了nowrap 的 shell 脚本命令，方便大家选择和修改：</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224202335.png"><br>conf 目录下存放配置文件，server.xml 是Mycat 服务器参数调整和用户授权的配置文 件，schema.xml 是逻辑库定义和表以及分片定义的配置文件，rule.xml 是分片规则 的配置文件，分片规则的具体一些参数信息单独存放为文件，也在这个目录下，配置 文件修改，需要重启Mycat 或者通过9066 端口reload。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224202412.png"></p>
<p>lib 目录下主要存放mycat 依赖的一些jar 文件.</p>
<p>日志存放在logs&#x2F;mycat.log 中，每天一个文件，日志的配置是在conf&#x2F;log4j2.xml 中， 根据自己的需要，可以调整输出级别为debug，debug 级别下，会输出更多的信息， 方便排查问题。</p>
<h2 id="配置环境变量MYCAT-HOME-usr-local-mycat"><a href="#配置环境变量MYCAT-HOME-usr-local-mycat" class="headerlink" title="配置环境变量MYCAT_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;mycat"></a>配置环境变量MYCAT_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;mycat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"><span class="comment"># 添加 mycat 环境变量</span></span><br><span class="line"><span class="built_in">export</span> MYCAT_HOME=/usr/local/mycat</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h2 id="启动MYCAT"><a href="#启动MYCAT" class="headerlink" title="启动MYCAT"></a>启动MYCAT</h2><p>到mycat&#x2F;bin目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mycat start</span><br></pre></td></tr></table></figure>

<h2 id="用MySQL客户端链接MySQL服务"><a href="#用MySQL客户端链接MySQL服务" class="headerlink" title="用MySQL客户端链接MySQL服务"></a>用MySQL客户端链接MySQL服务</h2><p> 到 conf&#x2F;server.xml 中看看端口和密码</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224202710.png"></p>
<p>默认的服务端口为8066，管理端口为9066</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224202725.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/02-MyCat%E5%AE%89%E8%A3%85/" data-id="clmcxed5i00ciu8wabwok79af" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/02-MyCat/01-MyCat入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/02-MyCat/01-MyCat%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.868Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="海量数据分片之分库分表"><a href="#海量数据分片之分库分表" class="headerlink" title="海量数据分片之分库分表"></a>海量数据分片之分库分表</h1><h2 id="大数据处理-分区"><a href="#大数据处理-分区" class="headerlink" title="大数据处理-分区"></a>大数据处理-分区</h2><p>应对大数据的处理，在分库分表之前，我们可以用分区，提升数据库的性能</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224145018.png"></p>
<h2 id="大数据处理-分片理解"><a href="#大数据处理-分片理解" class="headerlink" title="大数据处理-分片理解"></a><strong>大数据处理-分片理解</strong></h2><p>随着业务的发展，业务越来越复杂，应用的模块越来越多，总的数据量很大，高并发读写操作均超过单个数据库服务器的处理能力怎么办？</p>
<ol>
<li>对于读压力，我们可以想什么办法？<br>集群，多个从库</li>
<li>对于写压力呢？<br>能集群，多个主库吗？<br>不能多个相同的主库</li>
</ol>
<p><strong>那到底怎么办？</strong></p>
<p>数据分片指按照某个维度将存放在单一数据库中的数据分散地存放至多个数据库或表中<br>数据分片的有效手段是对关系型数据库进行分库和分表</p>
<ul>
<li>垂直拆分</li>
<li>水平拆分</li>
</ul>
<h2 id="大数据处理-分库理解"><a href="#大数据处理-分库理解" class="headerlink" title="大数据处理-分库理解"></a>大数据处理-分库理解</h2><p>分库又叫垂直拆分，或者纵向拆分，指的是按照业务模块将数据分散到不同的数据库服务器</p>
<p>就是把原本存储于一个库的表拆分存储到多个库上，通常是将表按照功能模块、关系密切程度划分出来，部署到不同的库上。</p>
<p>如果数据库是因为表太多而造成海量数据，并且项目的各项业务逻辑划分清晰、低耦合，那么规则简单明了、容易实施的首选就是分库。</p>
<h2 id="大数据处理-分库图例"><a href="#大数据处理-分库图例" class="headerlink" title="大数据处理-分库图例"></a>大数据处理-分库图例</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224145313.png"></p>
<p>优点</p>
<ul>
<li>拆分后业务清晰，拆分规则明确；</li>
<li>系统之间整合或扩展容易；</li>
<li>数据维护简单。</li>
</ul>
<p>缺点</p>
<ul>
<li>部分业务表无法join，只能通过接口方式解决，提高了系统复杂度；</li>
<li>受每种业务不同的限制存在单库性能瓶颈，不易数据扩展跟性能提高；</li>
<li>事务处理复杂。</li>
</ul>
<h2 id="大数据处理-分表理解"><a href="#大数据处理-分表理解" class="headerlink" title="大数据处理-分表理解"></a>大数据处理-分表理解</h2><p>垂直拆分可以缓冲数据量和访问量带来的问题，但无法根治。<br>如果单个表的数量很大，超出了单表的存储上限，如电商网站的商品表、订单表等该怎么办？<br>如果垂直拆分之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理。 </p>
<p>分表又叫水平切分，它不再将数据根据业务逻辑分类，而是通过某个字段（或某几个字段），根据某种规则或逻辑，将一个表的数据拆分成多份，分别存储在多个表结构一样的表中，这多个表可以存在一到多个库中，每个分片仅包含数据的一部分。</p>
<h2 id="大数据处理-分表类型"><a href="#大数据处理-分表类型" class="headerlink" title="大数据处理-分表类型"></a>大数据处理-分表类型</h2><p>分表又分成垂直分表和水平分表：</p>
<ul>
<li><p>垂直分表：将本来可以在同一个表的内容，划分为多个表。（按照关系型数据库的第三范式要求，是应该在同一个表的。）</p>
</li>
<li><p>水平分表：是把一个表复制成同样表结构的不同表，然后把数据按照一定的规则划分，分别存储到这些表中，从而保证单表的容量不会太大，提升性能；当然这些结构一样的表，可以放在一个或多个数据库中。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224145523.png"></p>
<h2 id="大数据处理-分表图例"><a href="#大数据处理-分表图例" class="headerlink" title="大数据处理-分表图例"></a>大数据处理-分表图例</h2><p>对海量数据的表进行分表分库存储-水平拆分</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224145712.png"></p>
<p><strong>优点</strong></p>
<ul>
<li>拆分规则抽象好，join 操作基本可以数据库做；</li>
<li>不存在单库大数据，高并发的性能瓶颈；</li>
<li>应用端改造较少；</li>
<li>提高了系统的稳定性跟负载能力。</li>
</ul>
<p>缺点</p>
<ul>
<li>拆分规则难以抽象；</li>
<li>分片事务一致性难以解决；</li>
<li>数据多次扩展难度跟维护量极大；</li>
<li>跨库join 性能较差。</li>
</ul>
<h2 id="水平拆分—分片规则"><a href="#水平拆分—分片规则" class="headerlink" title="水平拆分—分片规则"></a>水平拆分—分片规则</h2><p>水平对数据进行拆分最重要的是分片规则—拆分规则</p>
<p>可以如何来拆分？</p>
<ul>
<li>范围：时间、数值；</li>
<li>列表：按地域、按组织、分类；</li>
<li>散列：hash(某个字段) % 分片数、一致性hash； </li>
<li>复合多种方式。</li>
</ul>
<h1 id="分库分表会带来的挑战"><a href="#分库分表会带来的挑战" class="headerlink" title="分库分表会带来的挑战"></a>分库分表会带来的挑战</h1><h2 id="分库分表的技术难点"><a href="#分库分表的技术难点" class="headerlink" title="分库分表的技术难点"></a>分库分表的技术难点</h2><p>无论垂直拆分、水平拆分，都有共同的<strong>技术难点:</strong> </p>
<ul>
<li>分布式事务的问题；</li>
<li>跨节点Join的问题；</li>
<li>跨节点合并排序分页问题；</li>
<li>多数据源管理问题。</li>
</ul>
<h2 id="需要一个这样的东西"><a href="#需要一个这样的东西" class="headerlink" title="需要一个这样的东西"></a>需要一个这样的东西</h2><ol>
<li>要能解析SQL</li>
<li>能支持读写分离</li>
<li>能支持从库读的负载均衡</li>
<li>支持分库操作</li>
<li>支持分表操作</li>
<li>支持跨库关联查询</li>
<li>对事务处理的支持</li>
<li>主键ID生成</li>
<li>数据源管理</li>
</ol>
<h2 id="数据库中间件的分类和分库分表实战"><a href="#数据库中间件的分类和分库分表实战" class="headerlink" title="数据库中间件的分类和分库分表实战"></a>数据库中间件的分类和分库分表实战</h2><h2 id="数据库中间件的两种实现模式"><a href="#数据库中间件的两种实现模式" class="headerlink" title="数据库中间件的两种实现模式"></a>数据库中间件的两种实现模式</h2><p><strong>客户端模式</strong>，在应用程序中集成数据库中间件模块，通过该模块来配置管理应用需要的一个（或者多个）数据源，以及访问各个数据源，在模块内完成数据的整合。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224150018.png"></p>
<p><strong>服务端（代理）模式</strong>，通过中间代理层来统一管理所有的数据源，后端数据库集群对前端应用程序透明，同时易于数据库扩展。独立的服务能提供更强的处理能力。适用于大型复杂系统。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224150040.png"></p>
<h2 id="常用数据库中间件简介"><a href="#常用数据库中间件简介" class="headerlink" title="常用数据库中间件简介"></a>常用数据库中间件简介</h2><table>
<thead>
<tr>
<th></th>
<th>客户端模式</th>
<th></th>
<th>proxy</th>
</tr>
</thead>
<tbody><tr>
<td>当当</td>
<td>sharding-jdbc</td>
<td>社区</td>
<td>Mycat - cobar</td>
</tr>
<tr>
<td>阿里</td>
<td>TDDL</td>
<td>数字</td>
<td>Atlas</td>
</tr>
<tr>
<td></td>
<td></td>
<td>百度</td>
<td>heinsberge</td>
</tr>
<tr>
<td></td>
<td></td>
<td>youtube</td>
<td>vitess</td>
</tr>
<tr>
<td></td>
<td></td>
<td>金山</td>
<td>kingshard</td>
</tr>
<tr>
<td></td>
<td></td>
<td>商业版</td>
<td>Oneproxy</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th></th>
<th>Cobar</th>
<th>TDDL</th>
<th>ShardingJDBC</th>
<th>MyCat</th>
</tr>
</thead>
<tbody><tr>
<td>分库支持</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>分表支持</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>类型</td>
<td>Proxy</td>
<td>客户端集成</td>
<td>客户端集成</td>
<td>Proxy</td>
</tr>
<tr>
<td>中间层</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>ORM支持</td>
<td>任意</td>
<td>多种</td>
<td>多种</td>
<td>多种</td>
</tr>
<tr>
<td>数据库支持</td>
<td>mysql</td>
<td>多种</td>
<td>多种</td>
<td>多种</td>
</tr>
<tr>
<td>外部依赖</td>
<td>No</td>
<td>Diamond</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>社区活跃度</td>
<td>停滞</td>
<td>停滞</td>
<td>较活跃</td>
<td>活跃</td>
</tr>
<tr>
<td>文档丰富</td>
<td>Yes</td>
<td>N&#x2F;A</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>持续更新</td>
<td>No</td>
<td>N&#x2F;A</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody></table>
<h2 id="Mycat是什么"><a href="#Mycat是什么" class="headerlink" title="Mycat是什么"></a>Mycat是什么</h2><p>MyCat数据库分库分表中间件：国内最活跃的、性能最好的开源数据库中间件</p>
<ul>
<li>一个彻底开源的，面向企业应用开发的大数据库集群</li>
<li>支持事务、ACID、可以替代MySQL的加强版数据库</li>
<li>一个可以视为MySQL集群的企业级数据库，用来替代昂贵的Oracle集群</li>
<li>一个融合内存缓存技术、NoSQL技术、HDFS大数据的新型SQL Server</li>
<li>结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品</li>
<li>一个新颖的数据库中间件产品。</li>
</ul>
<p>官网地址： <a target="_blank" rel="noopener" href="http://www.mycat.io、http//www.mycat.org.cn/">http://www.mycat.io、http://www.mycat.org.cn/</a><br>Github地址： <a target="_blank" rel="noopener" href="https://github.com/MyCATApache">https://github.com/MyCATApache</a><br>Github上文档地址： <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-doc">https://github.com/MyCATApache/Mycat-doc</a></p>
<h2 id="Mycat-由来"><a href="#Mycat-由来" class="headerlink" title="Mycat 由来"></a>Mycat 由来</h2><p>2013年阿里的Cobar在社区使用过程中发现存在一些比较严重的问题，及其使用限制，经过Mycat发起人第一次改良，第一代改良版——Mycat诞生。 Mycat开源以后，一些Cobar的用户参与了Mycat的开发，最终Mycat发展成为一个由众多软件公司的实力派架构师和资深开发人员维护的社区型开源软件。</p>
<h2 id="Mycat-安装"><a href="#Mycat-安装" class="headerlink" title="Mycat 安装"></a>Mycat 安装</h2><p>环境准备</p>
<ul>
<li>JDK1.7+	 Mycat是用java开发</li>
<li>MySQL统一5.7 镜像地址： <a target="_blank" rel="noopener" href="http://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-5.7.24-1.el7.x86_64.rpm-bundle.tar%E3%80%81">http://mirrors.163.com/mysql/Downloads/MySQL-5.7/mysql-5.7.24-1.el7.x86_64.rpm-bundle.tar、</a></li>
<li>Mycat安装包 下载地址： <a target="_blank" rel="noopener" href="http://dl.mycat.io/">http://dl.mycat.io</a> 当前最新版本：1.6.6.1</li>
</ul>
<p>Mycat使用说明</p>
<ul>
<li>源码方式导入到IDE，源码地址： <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server.git">https://github.com/MyCATApache/Mycat-Server.git</a></li>
<li>安装包方式安装，下载地址： <a target="_blank" rel="noopener" href="http://dl.mycat.io/">http://dl.mycat.io</a></li>
</ul>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>数据库中间件</strong>：对应用，mycat就是数据库服务，mycat是后端数据库集群的代理</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221224152247.png"></p>
<p><strong>逻辑概念:</strong> </p>
<ul>
<li>逻辑库：mycat数据库服务中定义、管理的数据库</li>
<li>逻辑表：逻辑库中包含的需分库分表存储的表</li>
<li>dataNode：数据节点（分片节点），逻辑表分片的存放节点。</li>
<li>dataHost: 数据主机（节点主机），数据节点所在的主机。</li>
</ul>
<p><strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;testdb&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span><span class="attr">...</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.2:3306&quot;</span><span class="attr">...</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>物理概念</strong></p>
<ul>
<li>writeHost：写主机，真实的数据库服务主机描述</li>
<li>readHost：读主机，真实的数据库服务主机描述</li>
</ul>
<h1 id="分库分表的优缺点和原则"><a href="#分库分表的优缺点和原则" class="headerlink" title="分库分表的优缺点和原则"></a>分库分表的优缺点和原则</h1><h2 id="大数据处理-分片优点"><a href="#大数据处理-分片优点" class="headerlink" title="大数据处理-分片优点"></a>大数据处理-分片优点</h2><ul>
<li>解决磁盘系统最大文件限制，比如常见的有：<br>FAT16(最大分区2GB,最大文件2GB)<br>FAT32(最大分区32GB，最大容量2TB，最大文件32G)<br>NTFS(最大分区2TB，最大容量，最大文件2TB)<br>EXT3(最大文件大小: 2TB，最大文件极限: 仅受文件系统大小限制，最大分区&#x2F;文件系统大小: 4TB，最大文件名长度: 255 字符) </li>
<li>减少增量数据写入时的锁对查询的影响，减少长时间查询造成的表锁，影响写入操作等锁竞争的情况，节省排队的时间开支，增加呑吐量。 </li>
<li>由于单表数量下降，常见的查询操作由于减少了需要扫描的记录，使得单表单次查询所需的检索行数变少，减少了磁盘IO，时延变短。</li>
</ul>
<h2 id="大数据处理-分库原则"><a href="#大数据处理-分库原则" class="headerlink" title="大数据处理-分库原则"></a>大数据处理-分库原则</h2><p>基本的思路就是分析业务功能，以及表间的聚合关系，把关系紧密的表放在一起。</p>
<p>分库的粒度指的是在做切分时允许几级的关联表放在一起，这个问题对应用程序实现有着很大的影响。关联打 断的越多，则受影响的join操作越多。</p>
<p>实际的粒度掌控需要结合“业务紧密程度”和“表的数据量”两个因素综合考虑</p>
<ul>
<li>若划归到一起的表关系紧密，且数据量并不大，增速也非常缓慢，则适宜放在一起，不需要再进行水平切分；</li>
<li>若划归到一起的表的数据量巨大且增速迅猛，则势必要在分库的基础上再进行分表，这就意味着原单一的库还可能会被拆分成多个库，这会导致更多的复杂性，一开始最好就要考虑进去</li>
</ul>
<h2 id="大数据处理-分表原则"><a href="#大数据处理-分表原则" class="headerlink" title="大数据处理-分表原则"></a>大数据处理-分表原则</h2><p>对于垂直分表，通常是按照业务功能的使用频次，把主要的、热门的字段放在一起做为主要表；然后把不常用的，按照各自的业务属性进行聚集，拆分到不同的次要表中；主要表和次要表的关系一般都是一对一的。</p>
<p>对于水平分表，通常是按照具体的业务规则和数据的格式，选择能够把数据进行合理拆分的业务数据做为拆分标准，以此来对数据进行拆分。</p>
<p><strong>水平对数据进行拆分最重要的是分片规则—拆分规则</strong></p>
<p>可以如何来拆分？</p>
<ul>
<li>范围：时间、数值；</li>
<li>列表：按地域、按组织、分类；</li>
<li>散列：hash(某个字段) % 分片数、一致性hash； </li>
<li>复合多种方式。</li>
</ul>
<h2 id="数据库拆分原则"><a href="#数据库拆分原则" class="headerlink" title="数据库拆分原则"></a>数据库拆分原则</h2><ul>
<li>第一原则：能不切分尽量不要切分</li>
<li>第二原则：如果要切分一定要选择合适的切分规则，提前规划好。</li>
<li>第三原则：数据切分尽量通过数据冗余或表分组（Table Group）来降低跨库Join 的可能。</li>
<li>第四原则：由于数据库中间件对数据Join实现的优劣难以把握，而且实现高性能难度极大，业务读取尽量少使用多表Join。</li>
</ul>
<h1 id="分库分表配置文件示例"><a href="#分库分表配置文件示例" class="headerlink" title="分库分表配置文件示例"></a>分库分表配置文件示例</h1><h2 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - - Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); </span></span><br><span class="line"><span class="comment">	- you may not use this file except in compliance with the License. - You </span></span><br><span class="line"><span class="comment">	may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 </span></span><br><span class="line"><span class="comment">	- - Unless required by applicable law or agreed to in writing, software - </span></span><br><span class="line"><span class="comment">	distributed under the License is distributed on an &quot;AS IS&quot; BASIS, - WITHOUT </span></span><br><span class="line"><span class="comment">	WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the </span></span><br><span class="line"><span class="comment">	License for the specific language governing permissions and - limitations </span></span><br><span class="line"><span class="comment">	under the License. --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:server <span class="keyword">SYSTEM</span> <span class="string">&quot;server.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:server</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>user<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>mydb1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;mydb1&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_order&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;uuid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_user&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;uuid&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orderdb&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;userdb&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;userdb&quot;</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.201:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;5462837zhu&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostM2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.202:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>	<span class="attr">password</span>=<span class="string">&quot;5462837zhu&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="rule-xml"><a href="#rule-xml" class="headerlink" title="rule.xml"></a>rule.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - - Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); </span></span><br><span class="line"><span class="comment">	- you may not use this file except in compliance with the License. - You </span></span><br><span class="line"><span class="comment">	may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 </span></span><br><span class="line"><span class="comment">	- - Unless required by applicable law or agreed to in writing, software - </span></span><br><span class="line"><span class="comment">	distributed under the License is distributed on an &quot;AS IS&quot; BASIS, - WITHOUT </span></span><br><span class="line"><span class="comment">	WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the </span></span><br><span class="line"><span class="comment">	License for the specific language governing permissions and - limitations </span></span><br><span class="line"><span class="comment">	under the License. --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:rule <span class="keyword">SYSTEM</span> <span class="string">&quot;rule.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule1&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rule2&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func1<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>uuid<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;crc32slot&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>crc32slot<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partbymonth<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;latest-month-calldate&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>calldate<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>latestMonth<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-rang-mod&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-mod<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;jch&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>jump-consistent-hash<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;murmur&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;crc32slot&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByCRC32PreSlot&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>128<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;latestMonth&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.LatestMonthPartion&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;splitOneDay&quot;</span>&gt;</span>24<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partbymonth&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2015-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-mod&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByRangeMod&quot;</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-range-mod.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;jump-consistent-hash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByJumpConsistentHash&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;totalBuckets&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>备注：mycat1.6.6版本使用主键生成自己测试一直失败，使用1.6版本可以</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/02-MyCat/01-MyCat%E5%85%A5%E9%97%A8/" data-id="clmcxed5k00cju8wag0pa773w" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/01-基础及安装/03-MySQL分区详解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/03-MySQL%E5%88%86%E5%8C%BA%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.853Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="数据的概念和分类"><a href="#数据的概念和分类" class="headerlink" title="数据的概念和分类"></a>数据的概念和分类</h1><h2 id="大数据基础"><a href="#大数据基础" class="headerlink" title="大数据基础"></a>大数据基础</h2><p><strong>何为大数据</strong> </p>
<p>数据很多，数据量很大，记录数一般在千万级或者亿级甚至更多；<br>存储体量一般在TB级甚至PB级以上。<br>存储在一个或多个服务器上；</p>
<p><strong>跟“大数据”的区别</strong> </p>
<p>“大数据”指的是对大数据量进行分析和挖掘，发掘出数据中蕴含的有意义的东西，比如：规律、趋势、喜好等，并据此做出一定的推理和预测。<br>通常会涉及数据仓库、数据挖掘、人工智能AI、机器学习等方面的技术。</p>
<h2 id="大数据带来的影响"><a href="#大数据带来的影响" class="headerlink" title="大数据带来的影响"></a>大数据带来的影响</h2><p><strong>大数据量带来的影响</strong> </p>
<p>服务端应用在处理业务逻辑时，会多次操作数据，如果数据量太大，每次对数据进行操作会消耗大量的资源，性能也比较低下，从而导致整个应用性能下降。 </p>
<p><strong>大数据量带来的问题</strong> </p>
<p>慢：业务处理变慢、响应时间变慢、整个应用变慢；高并发下多次操作导致数据库崩溃</p>
<p><strong>大数据量问题的本质就是：要操作的数据的基数太大</strong></p>
<h2 id="数据的分类"><a href="#数据的分类" class="headerlink" title="数据的分类"></a>数据的分类</h2><p><strong>联机事务处理（OLTP）</strong> </p>
<p>面向交易的处理系统，特征是数据需要立即传送到计算中心进行处理，并在短时间内给出处理结果</p>
<p><strong>联机分析处理（OLAP）</strong> </p>
<p>通过多维的方式对数据进行分析、查询、报表，不必要即时给出响应结果</p>
<table>
<thead>
<tr>
<th></th>
<th>OLTP</th>
<th>OLAP</th>
</tr>
</thead>
<tbody><tr>
<td>系统功能</td>
<td>日常交易处理</td>
<td>统计、分析、报表</td>
</tr>
<tr>
<td>DB设计</td>
<td>面向实时交易应用</td>
<td>面向统计分析应用</td>
</tr>
<tr>
<td>数据处理</td>
<td>当前的，最新的</td>
<td>历史的，聚集的</td>
</tr>
<tr>
<td>实时性</td>
<td>实时读写要求高</td>
<td>实时读写要求低</td>
</tr>
<tr>
<td>事务</td>
<td>强一致性</td>
<td>弱事务</td>
</tr>
<tr>
<td>分析要求</td>
<td>低</td>
<td>高</td>
</tr>
</tbody></table>
<h1 id="大数据处理思路"><a href="#大数据处理思路" class="headerlink" title="大数据处理思路"></a>大数据处理思路</h1><p><strong>分流</strong><br>用和不用、常用和不常用分开<br>对数据库存放的数据：分区、分库、分表<br>对文件存放的数据：拆文件<br>考虑分批处理<br>原则就是：尽量使每次操作的数据的基数减少</p>
<p><strong>缓存技术</strong><br>读多写少用缓存</p>
<p><strong>数据库优化</strong><br>合理设计数据库结构<br>合理构建索引<br>数据库集群</p>
<p><strong>处理优化</strong><br>优化Sql<br>考虑使用临时表、中间表 </p>
<p><strong>合理使用NoSql</strong><br>Mongodb、Redis、HBase等 </p>
<p><strong>分布式大数据处理方案</strong><br>Hadoop、Spark、Storm等</p>
<h2 id="大数据处理-数据库种类"><a href="#大数据处理-数据库种类" class="headerlink" title="大数据处理-数据库种类"></a><strong>大数据处理-数据库种类</strong></h2><p><strong>传统数据库</strong> </p>
<p>Oracle、MySQL、SQLServer、DB2</p>
<p><strong>NoSql数据库</strong> </p>
<p>临时性键值存储：Redis、Memcached</p>
<p>永久性键值存储：ROMA、Redis</p>
<p>面向文档存储：mongoDB、CouchDB</p>
<p>面向列存储：Cassandra、HBase</p>
<table>
<thead>
<tr>
<th></th>
<th>关系型数据库</th>
<th>NoSql数据库</th>
</tr>
</thead>
<tbody><tr>
<td>特点</td>
<td>数据关系模型基于关系模型，结构化存储，完整性约束<br />基于二维表及其之间的联系，需要连接、并、交、差、除等数据操作才用结构化的查询语句（SQL）做数据读写<br />操作需要数据的一致性，需要事务甚至是强一致性</td>
<td>非结构化存储<br/>基于多维度关系模型<br/>具有特定的使用场景</td>
</tr>
<tr>
<td>优点</td>
<td>爆出数据的一致性（事务处理）<br/>可以进行join等复杂查询<br/>通用化，技术成熟</td>
<td>高并发，大数据下读写能力强<br/>支持分布式，易于扩展，可伸缩<br/>简单，弱结构化存储</td>
</tr>
<tr>
<td>缺点</td>
<td>数据读写必须sql解析，大量数据，高并发下读写性能不足<br/>对数据做读写，或修改数据结构时需要加锁，影响并发操作<br/>无法使用非结构化存储<br />扩展困难、昂贵</td>
<td>Join等复杂操作能力弱<br/>事务支持弱<br/>通用性差<br/>无完整约束复杂业务场景</td>
</tr>
</tbody></table>
<h2 id="大数据处理-分区理解"><a href="#大数据处理-分区理解" class="headerlink" title="大数据处理-分区理解"></a>大数据处理-分区理解</h2><p>所谓分区就是将一个表分解成多个区块进行操作和保存，从而降低每次操作的数据，提高性能。 </p>
<p>而对应用来说是透明的，从逻辑上看是只有一个表（这里跟分库分表的访问不一样），但在物理上这 </p>
<p>个表可能是由多个物理分区组成的，每个分区都是一个独立的对象，可以进行独立处理。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223211715.png"></p>
<h2 id="大数据处理-分区优缺点"><a href="#大数据处理-分区优缺点" class="headerlink" title="大数据处理-分区优缺点"></a>大数据处理-分区优缺点</h2><p><strong>优点</strong> </p>
<ul>
<li>进行逻辑数据分割，分割数据能够有多个不同的物理文件路径</li>
<li>可以存储更多的数据，突破系统单个文件最大限制</li>
<li>提升性能，提高每个分区的读写速度，提高分区范围查询的速度</li>
<li>可以通过删除相关分区来快速删除数据</li>
<li>通过跨多个磁盘来分散数据查询，从而提高磁盘I&#x2F;O的性能</li>
<li>涉及到例如SUM()和COUNT()这样聚合函数的查询，可以很容易地进行并行处理</li>
<li>可以备份和恢复独立的分区，这对大数据量很有好处</li>
</ul>
<p><strong>分区能支持的引擎</strong> </p>
<ul>
<li>MySQL支持大部分的存储引擎创建分区，如MyISAM、InnoDB等； </li>
<li>不支持MERGE和CSV等来创建分区。</li>
<li>同一个分区表中的所有分区必须是同一个存储引擎。</li>
</ul>
<h2 id="大数据处理-分区类型"><a href="#大数据处理-分区类型" class="headerlink" title="大数据处理-分区类型"></a>大数据处理-分区类型</h2><ul>
<li>RANGE分区：一个给定连续区间的列值</li>
<li>LIST分区：LIST是列值匹配一个离散值集合中的某个值来进行选择</li>
<li>HASH分区：用户定义的表达式的返回值来进行hash计算之后选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算，这个函数必须产生非负整数值</li>
<li>KEY分区：类似于按HASH分区，由MySQL服务器提供其自身的哈希函数</li>
</ul>
<ol>
<li>如果表中存在primary key或者unique key时，分区的列是两种中的一个组成部分</li>
<li>如果表中不存在任何的primary key或者unique key，则可以指定任何一个列作为分区列</li>
<li>5.5版本前的Range、List、Hash分区要求分区键必须是int；MySQL5.5及以上，支持非整型的Range和List分区，即：range columns 和list columns。</li>
</ol>
<h2 id="大数据处理-创建分区"><a href="#大数据处理-创建分区" class="headerlink" title="大数据处理-创建分区"></a>大数据处理-创建分区</h2><p><strong>分区命名</strong> </p>
<ul>
<li>分区的名字基本上遵循其他MySQL标识符应当遵循的原则，例如用于表和数据库名字的标识符。但是应当注意，分区的名字是不区分大小写的。</li>
<li>无论使用何种类型的分区，分区总是在创建时就自动的顺序编号，且从0开始记录。</li>
</ul>
<p>MySQL分区处理NULL值的方式<br>MySQL中的分区在禁止空值NULL上没有进行处理，无论它是一个列值还是一个用户定义表达式的值，一般而言，在这种情况下MySQL把NULL视为0。如果你希望回避这种做法，应该在设计表时声明列“NOT NULL”</p>
<h2 id="大数据处理-分区管理"><a href="#大数据处理-分区管理" class="headerlink" title="大数据处理-分区管理"></a>大数据处理-分区管理</h2><p>可以对分区进行添加、删除、重新定义、合并或拆分等管理操作。</p>
<h2 id="大数据处理-分区注意点"><a href="#大数据处理-分区注意点" class="headerlink" title="大数据处理-分区注意点"></a>大数据处理-分区注意点</h2><ul>
<li><p>最大分区数目不能超过1024，一般建议对单表的分区数不要超过150个 </p>
</li>
<li><p>如果含有唯一索引或者主键，则分区列必须包含在所有的唯一索引或者主键之内</p>
</li>
<li><p>不支持外键</p>
</li>
<li><p>不支持全文索引，对分区表的分区键创建索引，那么这个索引也将被分区</p>
</li>
<li><p>按日期进行分区很合适，因为很多日期函数可以用。但是对于字符串来说合适的分区函数不太多</p>
</li>
<li><p>只有RANG和LIST分区能进行子分区，HASH和KEY分区不能进行子分区</p>
</li>
<li><p>分区表对于单条记录的查询没有优势</p>
</li>
<li><p>要注意选择分区的成本，每插入一行数据都需要按照表达式筛选插入的分区</p>
</li>
<li><p>分区字段尽量不要可以为null</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/03-MySQL%E5%88%86%E5%8C%BA%E8%AF%A6%E8%A7%A3/" data-id="clmcxed5100ccu8wa41aj8g2u" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/01-基础及安装/02-MySQL分区创建和管理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/02-MySQL%E5%88%86%E5%8C%BA%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.847Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>MySQL5.7<br>Centos7</p>
<h1 id="查看是否支持分区"><a href="#查看是否支持分区" class="headerlink" title="查看是否支持分区"></a>查看是否支持分区</h1><p><strong>从MySQL5.1开始引入分区功能，用如下方式查看是否支持：</strong></p>
<p>​	“老”的版本用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE ‘%partition%’;</span><br></pre></td></tr></table></figure>

<p>​	新的版本用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show plugins;</span><br></pre></td></tr></table></figure>

<p>​	查看支持的存储引擎</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br></pre></td></tr></table></figure>

<h1 id="创建分区"><a href="#创建分区" class="headerlink" title="创建分区"></a>创建分区</h1><h2 id="1-创建RANGE分区"><a href="#1-创建RANGE分区" class="headerlink" title="1 创建RANGE分区"></a>1 创建RANGE分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_users1 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime VARCHAR(100)</span><br><span class="line">)</span><br><span class="line">PARTITION BY RANGE (uuid) (</span><br><span class="line">	PARTITION p0 VALUES LESS THAN (5),</span><br><span class="line">	PARTITION p1 VALUES LESS THAN (10),</span><br><span class="line">	PARTITION p2 VALUES LESS THAN (15),</span><br><span class="line">	PARTITION p3 VALUES LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-添加数据和测试"><a href="#1-1-添加数据和测试" class="headerlink" title="1.1 添加数据和测试"></a>1.1 添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show tables;</span><br><span class="line">insert into tbl_users1 values(1,&#x27;x&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users1 values(8,&#x27;x&#x27;,&#x27;2001-01-02&#x27;);</span><br><span class="line">insert into tbl_users1 values(80,&#x27;x&#x27;,&#x27;2001-01-03&#x27;);</span><br><span class="line">select * from tbl_users1;</span><br><span class="line">select * from tbl_users1 where uuid = 8;</span><br></pre></td></tr></table></figure>

<p>表看不出来有任何区别，而且执行插入语句的时候也没有任何影响，然后查询看出来对应用是透明的，但是没看出分区啊！那这个分区体现在哪里呢？参考最后分区位置和信息查看张姐</p>
<h2 id="2-创建List分区"><a href="#2-创建List分区" class="headerlink" title="2 创建List分区"></a>2 创建List分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_users2 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime VARCHAR(100)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">PARTITION BY List (uuid) (</span><br><span class="line">	PARTITION p0 VALUES in (1,2,3,5),</span><br><span class="line">	PARTITION p1 VALUES in (7,9,10),</span><br><span class="line">	PARTITION p2 VALUES in (11,15)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="2-1-添加数据和测试"><a href="#2-1-添加数据和测试" class="headerlink" title="2.1 添加数据和测试"></a>2.1 添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">insert into tbl_users2 values(1,&#x27;x&#x27;,&#x27;2001-01-02&#x27;);</span><br><span class="line">insert into tbl_users2 values(2,&#x27;x&#x27;,&#x27;2001-01-03&#x27;);</span><br><span class="line">insert into tbl_users2 values(7,&#x27;x&#x27;,&#x27;2001-01-04&#x27;);</span><br><span class="line"></span><br><span class="line">select * from tbl_users2;</span><br><span class="line">select * from tbl_users2 where uuid = 1;</span><br><span class="line"></span><br><span class="line">select * from tbl_users2 partition(p0);</span><br><span class="line">select * from tbl_users2 partition(p1);</span><br><span class="line">select * from tbl_users2 partition(p2);</span><br></pre></td></tr></table></figure>

<p><strong>（1）如果试图操作的列值不在分区值列表中时，那么会失败并报错。要注意的是，LIST分区没有类似如“VALUES LESS THAN MAXVALUE”这样的包含其他值在内的定义，将要匹配的任何值都必须在值列表中找到。</strong><br><strong>（2）LIST分区除了能和RANGE分区结合起来生成一个复合的子分区，与HASH和KEY分区结合起来生成复合的子分区也是可以的。</strong></p>
<h2 id="3-创建非整形的RANGE-LIST分区"><a href="#3-创建非整形的RANGE-LIST分区" class="headerlink" title="3 创建非整形的RANGE,LIST分区"></a>3 创建非整形的RANGE,LIST分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_users3 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime VARCHAR(100)</span><br><span class="line">)</span><br><span class="line">PARTITION BY RANGE columns (name) (</span><br><span class="line">	PARTITION p0 VALUES LESS THAN (&#x27;id05&#x27;),	</span><br><span class="line">	PARTITION p1 VALUES LESS THAN (&#x27;id10&#x27;),</span><br><span class="line">	PARTITION p2 VALUES LESS THAN (&#x27;id15&#x27;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="3-1-添加数据和测试"><a href="#3-1-添加数据和测试" class="headerlink" title="3.1 添加数据和测试"></a>3.1 添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">insert into tbl_users3 values(2,&#x27;id07&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users3 values(3,&#x27;id02&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users3 values(4,&#x27;id12&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line"></span><br><span class="line">select * from tbl_users3;</span><br><span class="line"></span><br><span class="line">select * from tbl_users3 partition(p0);</span><br><span class="line">select * from tbl_users3 partition(p1);</span><br><span class="line">select * from tbl_users3 partition(p2);</span><br></pre></td></tr></table></figure>



<h2 id="4-创建Hash分区"><a href="#4-创建Hash分区" class="headerlink" title="4 创建Hash分区"></a>4 创建Hash分区</h2><p>HASH分区主要用来确保数据在预先确定数目的分区中平均分布。在RANGE和LIST分区中，必须明确指定一个给定的列值或列值集合以指定应该保存在哪个分区中；</p>
<p>而在HASH分区中，MySQL自动完成这些工作，要做的只是基于将要被哈希的列值指定一个表达式，以及指定被分区的表将要被分割成的分区数量，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	CREATE TABLE tbl_users4 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime VARCHAR(100)</span><br><span class="line">)</span><br><span class="line">	PARTITION BY HASH (uuid)	//uuid可以添加表达式，比如/2,或者mod(uuid,2)，性能低，每条数据要计算之后								在hash然后再插入</span><br><span class="line">	PARTITIONS 3;</span><br></pre></td></tr></table></figure>

<p>（1）由于每次插入、更新、删除一行，这个表达式都要计算一次；这意味着非常复杂的表达式可能会引起性			能问题，尤其是在执行同时影响大量行的运算（例如批量插入）的时候。<br>（2）最有效率的哈希函数是只对单个表列进行计算，并且它的值随列值进行一致地增大或减小，因为这考虑了在分区范围上的“修剪”。也就是说，表达式值和它所基于的列的值变化越接近，就能越有效地使用该表达式来进行HASH分区。</p>
<h3 id="4-1-添加数据和测试"><a href="#4-1-添加数据和测试" class="headerlink" title="4.1 添加数据和测试"></a>4.1 添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">insert into tbl_users4 values(10,&#x27;id7&#x27;，&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users4 values(11,&#x27;id07&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users4 values(12,&#x27;id02&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line"></span><br><span class="line">select * from tbl_users4;</span><br><span class="line"></span><br><span class="line">select * from tbl_users4 where uuid = 10;</span><br><span class="line">select * from tbl_users4 where uuid = 11;</span><br><span class="line">select * from tbl_users4 where uuid = 12;</span><br><span class="line"></span><br><span class="line">select * from tbl_users4 partition(p0);</span><br><span class="line">select * from tbl_users4 partition(p1);</span><br><span class="line">select * from tbl_users4 partition(p2);</span><br></pre></td></tr></table></figure>



<h3 id="4-2-线性Hash分区"><a href="#4-2-线性Hash分区" class="headerlink" title="4.2 线性Hash分区"></a>4.2 线性Hash分区</h3><p>线性哈希分区在“PARTITION BY” 子句中添加“LINEAR”关键字。<br>线性哈希分区的优点在于增加、删除、合并和拆分分区将变得更加快捷，有利于处理含有极其大量数据的表。它的缺点在于，各个分区间数据的分布不大可能均衡。</p>
<h2 id="5-Key分区"><a href="#5-Key分区" class="headerlink" title="5 Key分区"></a>5 Key分区</h2><p>类似于按照HASH分区，Hash分区允许用户自定义的表达式，而Key分区不允许使用用户自定义的表达式； Hash分区只支持整数分区，Key分区支持除了blob或text类型之外的其他数据类型分区。<br>与Hash分区不同，创建Key分区表的时候，可以不指定分区键，默认会选择使用主键或唯一键作为分区键，没有主键或唯一键，就必须指定分区键。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_users5 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime VARCHAR(100)</span><br><span class="line">)</span><br><span class="line">PARTITION BY LINEAR Key (uuid)</span><br><span class="line">PARTITIONS 3;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-添加数据和测试"><a href="#5-1-添加数据和测试" class="headerlink" title="5.1 添加数据和测试"></a>5.1 添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">insert into tbl_users5 values(12,&#x27;id7&#x27;，&#x27;2001-01-01&#x27;);</span><br><span class="line">insert into tbl_users5 values(7,&#x27;id07&#x27;,&#x27;2001-01-01&#x27;);</span><br><span class="line"></span><br><span class="line">select * from tbl_users5;</span><br><span class="line">explain partition select * from tbl_user5 where uuid = 12;	//看看是key分区是如何分的？</span><br><span class="line"></span><br><span class="line">select * from tbl_users5 partition(p0);</span><br><span class="line">select * from tbl_users5 partition(p1);</span><br><span class="line">select * from tbl_users5 partition(p2);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="6-子分区-复合分区"><a href="#6-子分区-复合分区" class="headerlink" title="6 子分区(复合分区)"></a>6 子分区(复合分区)</h2><p>​	在每个分区内，子分区的名字必须是唯一的，目前在整个表中，也要保持唯一。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tbl_users6 (</span><br><span class="line">	uuid INT NOT NULL,</span><br><span class="line">	name VARCHAR(20),</span><br><span class="line">	registerTime Date</span><br><span class="line">)</span><br><span class="line">PARTITION BY RANGE(YEAR(registerTime))</span><br><span class="line">	SUBPARTITION BY HASH(TO_DAYS(registerTime))</span><br><span class="line">	SUBPARTITIONS 2</span><br><span class="line">	(</span><br><span class="line">		PARTITION p0 VALUES LESS THAN (2008),</span><br><span class="line">		PARTITION p1 VALUES LESS THAN (2015),</span><br><span class="line">		PARTITION p2 VALUES LESS THAN MAXVALUE</span><br><span class="line">		</span><br><span class="line">	);</span><br></pre></td></tr></table></figure>

<h3 id="6-1添加数据和测试"><a href="#6-1添加数据和测试" class="headerlink" title="6.1添加数据和测试"></a>6.1添加数据和测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">insert into tbl_users6 values(1,&#x27;x&#x27;,&#x27;2007-01-02&#x27;);</span><br><span class="line">insert into tbl_users6 values(2,&#x27;x&#x27;,&#x27;2009-01-03&#x27;);</span><br><span class="line">insert into tbl_users6 values(3,&#x27;x&#x27;,&#x27;2016-01-04&#x27;);</span><br><span class="line"></span><br><span class="line">select * from tbl_users6;</span><br><span class="line"></span><br><span class="line">explain partition select * from tbl_user6 \G;	//看看是子分区是如何分的？</span><br><span class="line">explain partition select * from tbl_user6  where registerTime=&#x27;2007-01-02&#x27; \G;</span><br><span class="line"></span><br><span class="line">select * from tbl_users6 partition(p0);</span><br><span class="line">select * from tbl_users6 partition(p1);</span><br><span class="line">select * from tbl_users6 partition(p2);</span><br></pre></td></tr></table></figure>



<h1 id="分区管理"><a href="#分区管理" class="headerlink" title="分区管理"></a>分区管理</h1><h2 id="1-RANGE和LIST分区的管理"><a href="#1-RANGE和LIST分区的管理" class="headerlink" title="1 RANGE和LIST分区的管理"></a>1 RANGE和LIST分区的管理</h2><h3 id="1-1-删除"><a href="#1-1-删除" class="headerlink" title="1.1 删除"></a>1.1 删除</h3><p>​			删除分区语句如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show create table &#x27;tbl_users1&#x27; \G;</span><br><span class="line">alter table tbl_users1 drop partition p0;</span><br><span class="line">select * from tbl_user1;</span><br></pre></td></tr></table></figure>

<p>​			（1）当删除了一个分区，也同时删除了该分区中所有的数据<br>​			（2）可以通过show create table tbl_users1;来查看新的创建表的语句<br>​			（3）如果是List分区的话，删除的数据不能新增进来，因为这些行的列值包含在已<br>​			经删除了的分区的值列表中</p>
<h3 id="1-2-添加"><a href="#1-2-添加" class="headerlink" title="1.2 添加"></a>1.2 添加</h3><p>​			添加分区语句如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users1 add partition(partition p4 values less than(50));//p3是最大值，所以不能添加p4</span><br><span class="line">alter table tbl_users1 drop partition p3;						//p3是最大值，所以不能添加p4</span><br><span class="line">show create table &#x27;tbl_users1&#x27; \G;								//删除之后再看下分区</span><br><span class="line">alter table tbl_users1 add partition(partition p4 values less than(50));//不能用p0</span><br><span class="line">show create table &#x27;tbl_users1&#x27; \G;								//添加之后再看下分区</span><br></pre></td></tr></table></figure>

<p>​			（1）对于RANGE分区的表，只可以添加新的分区到分区列表的高端<br>​			（2）对于List分区的表，不能添加已经包含在现有分区值列表中的任意值</p>
<h3 id="1-3-重建（拆分合并）分区不丢失数据"><a href="#1-3-重建（拆分合并）分区不丢失数据" class="headerlink" title="1.3 重建（拆分合并）分区不丢失数据"></a>1.3 重建（拆分合并）分区不丢失数据</h3><p>​			如果希望能不丢失数据的条件下重新定义分区，可以使用如下语句：	</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name REORGANIZE PARTITION partition_list INTO (partition_definitions)</span><br></pre></td></tr></table></figure>

<p>​			（1）拆分分区如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users1 REORGANIZE PARTITION p1 INTO(partition s0 values less than(5), partition s1 values less than(10));</span><br><span class="line">show create table &#x27;tbl_users1&#x27; \G;	</span><br></pre></td></tr></table></figure>

<p>​			或者如（针对LIST）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users2 REORGANIZE PARTITION p0 INTO(partition s0 values in(1,2,3), partition s1 values in(4,5));</span><br><span class="line">show create table &#x27;tbl_users2&#x27; \G;	</span><br><span class="line">select * from tbl_users2			//查看数据是否丢失</span><br></pre></td></tr></table></figure>

<p>​			（2）合并分区如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users2 REORGANIZE PARTITION s0,s1 INTO(partition p0 values in(1,2,3,4,5));</span><br><span class="line">select * from tbl_users2			//查看数据是否丢失</span><br><span class="line">show create table &#x27;tbl_users2&#x27; \G;	//在查看分区信息</span><br></pre></td></tr></table></figure>



<h3 id="1-4-删除分区不丢失数据"><a href="#1-4-删除分区不丢失数据" class="headerlink" title="1.4 删除分区不丢失数据"></a>1.4 删除分区不丢失数据</h3><p>​			删除所有分区，但保留数据，形如： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show create table &#x27;tbl_users1&#x27; \G;			//在查看分区信息</span><br><span class="line">alter table tbl_users1 remove partitioning;</span><br><span class="line">show create table &#x27;tbl_users1&#x27; \G;			//没有分区信息了</span><br><span class="line">select * from tbl_users1			//查看数据是否丢失</span><br></pre></td></tr></table></figure>

<h2 id="2-HASH和KEY分区的管理"><a href="#2-HASH和KEY分区的管理" class="headerlink" title="2 HASH和KEY分区的管理"></a>2 HASH和KEY分区的管理</h2><h3 id="2-1-减少分区数量"><a href="#2-1-减少分区数量" class="headerlink" title="2.1 减少分区数量"></a>2.1 减少分区数量</h3><p>​			减少分区数量语句如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show create table &#x27;tbl_users4&#x27; \G;				//先看分区数量</span><br><span class="line">alter table tbl_users4 COALESCE PARTITION 1;</span><br><span class="line">show create table &#x27;tbl_users4&#x27; \G;				//减少再看分区数量</span><br></pre></td></tr></table></figure>

<h3 id="2-2-添加分区数量"><a href="#2-2-添加分区数量" class="headerlink" title="2.2 添加分区数量"></a>2.2 添加分区数量</h3><p>​			添加分区数量语句如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users4 add PARTITION partitions 2;</span><br><span class="line">  show create table &#x27;tbl_users4&#x27; \G;			//添加再看分区数量</span><br></pre></td></tr></table></figure>

<h2 id="3-其他分区管理"><a href="#3-其他分区管理" class="headerlink" title="3 其他分区管理"></a>3 其他分区管理</h2><h3 id="3-1：重建分区"><a href="#3-1：重建分区" class="headerlink" title="3.1：重建分区"></a>3.1：重建分区</h3><p>​			类似于先删除保存在分区中的所有记录，然后重新插入它们，可用于整理分区碎片。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users REBUILD PARTITION p2,p3;</span><br></pre></td></tr></table></figure>

<h3 id="3-2：优化分区"><a href="#3-2：优化分区" class="headerlink" title="3.2：优化分区"></a>3.2：优化分区</h3><p>​			如果从分区中删除了大量的行，或者对一个带有可变长度的行（也就是说，有VARCHAR，BLOB，或TEXT类型的列）作了许多修改，可以使用“ALTER TABLE … OPTIMIZE PARTITION”来收回没有使用的空间，并整理分区数据文件的碎片。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users OPTIMIZE PARTITION p2,p3;</span><br></pre></td></tr></table></figure>

<h3 id="3-3：分析分区"><a href="#3-3：分析分区" class="headerlink" title="3.3：分析分区"></a>3.3：分析分区</h3><p>​			读取并保存分区的键分布，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users ANALYZE PARTITION p2,p3;</span><br></pre></td></tr></table></figure>

<h3 id="3-4：检查分区"><a href="#3-4：检查分区" class="headerlink" title="3.4：检查分区"></a>3.4：检查分区</h3><p>​			检查分区中的数据或索引是否已经被破坏，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users CHECK PARTITION 	p2,p3;</span><br></pre></td></tr></table></figure>

<h3 id="3-5：修补分区"><a href="#3-5：修补分区" class="headerlink" title="3.5：修补分区"></a>3.5：修补分区</h3><p>​			 修补被破坏的分区，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl_users REPAIR PARTITION p2,p3;</span><br></pre></td></tr></table></figure>

<h1 id="分区位置查看"><a href="#分区位置查看" class="headerlink" title="分区位置查看"></a>分区位置查看</h1><h2 id="到存放数据的地方查看文件，路经配置在"><a href="#到存放数据的地方查看文件，路经配置在" class="headerlink" title="到存放数据的地方查看文件，路经配置在"></a>到存放数据的地方查看文件，路经配置在</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &quot;%datadir%&quot;;</span><br><span class="line">cd 到数据库</span><br></pre></td></tr></table></figure>

<p>​		frm：表结构   ibd：索引和数据文件	</p>
<h2 id="可以通过下面的语句来查看表的分区信息："><a href="#可以通过下面的语句来查看表的分区信息：" class="headerlink" title="可以通过下面的语句来查看表的分区信息："></a>可以通过下面的语句来查看表的分区信息：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.partitions where table_schema=‘xxx’ and table_name=‘xxx’ \G; </span><br></pre></td></tr></table></figure>

<p>​		\G：按列显示</p>
<h2 id="可以通过下面的语句来查看分区上的数据"><a href="#可以通过下面的语句来查看分区上的数据" class="headerlink" title="可以通过下面的语句来查看分区上的数据"></a>可以通过下面的语句来查看分区上的数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from tbl_users partition(p0);</span><br></pre></td></tr></table></figure>

<h2 id="可以使用下面的语句来查看MySQL会操作的分区"><a href="#可以使用下面的语句来查看MySQL会操作的分区" class="headerlink" title="可以使用下面的语句来查看MySQL会操作的分区"></a>可以使用下面的语句来查看MySQL会操作的分区</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain partitions select * from tbl_users where uuid=80;</span><br></pre></td></tr></table></figure>

<p>​		explain：查询计划，分析性能用的</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/02-MySQL%E5%88%86%E5%8C%BA%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86/" data-id="clmcxed4z00cbu8wadq3na65c" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/01-基础及安装/01-MySQL安装" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/01-MySQL%E5%AE%89%E8%A3%85/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.839Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>MySQL5.7<br>Centos7</p>
<h1 id="1-下载YUM源"><a href="#1-下载YUM源" class="headerlink" title="1 下载YUM源"></a>1 下载YUM源</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>​	如果提示wget命令无法找到，执行下面的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget</span><br></pre></td></tr></table></figure>



<h1 id="2-安装MySQL源"><a href="#2-安装MySQL源" class="headerlink" title="2 安装MySQL源"></a>2 安装MySQL源</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mysql57-community-release-el7-8.noarch.rpm</span><br></pre></td></tr></table></figure>

<h1 id="3-检查MySQL源是否安装成功"><a href="#3-检查MySQL源是否安装成功" class="headerlink" title="3 检查MySQL源是否安装成功"></a>3 检查MySQL源是否安装成功</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum repolist enabled | grep &quot;mysql.*-community.*&quot;</span><br></pre></td></tr></table></figure>

<h1 id="4-安装MySQL"><a href="#4-安装MySQL" class="headerlink" title="4 安装MySQL"></a>4 安装MySQL</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql-community-server</span><br></pre></td></tr></table></figure>

<h1 id="5-启动MySQL服务"><a href="#5-启动MySQL服务" class="headerlink" title="5 启动MySQL服务"></a>5 启动MySQL服务</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure>

<p>​	根据自己需求设置是否开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysqld</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h1 id="6-修改root密码"><a href="#6-修改root密码" class="headerlink" title="6 修改root密码"></a>6 修改root密码</h1><p>​	mysql安装完成之后，在&#x2F;var&#x2F;log&#x2F;mysqld.log文件中给root生成了一个默认<br>密码。通过下面的方式找到root默认密码，然后登录mysql进行修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br><span class="line">mysql -uroot –p</span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;root&#x27;;</span><br></pre></td></tr></table></figure>

<p>​	<strong>tips：mysql5.7默认安装了密码安全检查插件（validate_password），默认密码检查策略要求密码必须包含：</strong></p>
<p>​	<strong>大小写字母、数字和特殊符号，并且长度不能少于8位。修改策略之后再执行修改密码</strong><br>​	<strong>1 set global validate_password_policy&#x3D;0;</strong><br>​	<strong>2 set global validate_password_policy&#x3D;LOW;</strong></p>
<h1 id="7-查看MySQL目前是什么存储引擎"><a href="#7-查看MySQL目前是什么存储引擎" class="headerlink" title="7 查看MySQL目前是什么存储引擎"></a>7 查看MySQL目前是什么存储引擎</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br></pre></td></tr></table></figure>

<h1 id="8-修改存储引擎"><a href="#8-修改存储引擎" class="headerlink" title="8 修改存储引擎"></a>8 修改存储引擎</h1><p>​	如果不是InnoDB，设置为InnoDB，修改配置文件&#x2F;etc&#x2F;my.cnf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine=INNODB</span><br></pre></td></tr></table></figure>

<h1 id="9-重启MySQL数据库"><a href="#9-重启MySQL数据库" class="headerlink" title="9 重启MySQL数据库"></a>9 重启MySQL数据库</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/01-%E5%9F%BA%E7%A1%80%E5%8F%8A%E5%AE%89%E8%A3%85/01-MySQL%E5%AE%89%E8%A3%85/" data-id="clmcxecz0009ku8waa9gffdp5" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-01-Java基础/05-正则表达式/01-正则表达式入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/01-Java%E5%9F%BA%E7%A1%80/05-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/01-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.372Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>正则表达式在线测试工具：<a target="_blank" rel="noopener" href="https://regex101.com/">https://regex101.com/</a></p>
<h1 id="限定符"><a href="#限定符" class="headerlink" title="限定符"></a>限定符</h1><h2 id=""><a href="#" class="headerlink" title="?"></a>?</h2><p>used?</p>
<p>表示 ? 前面这个字符需要出现0次或者1次，简单点就是 d 可有可无</p>
<p>可匹配：use、used</p>
<h2 id="-1"><a href="#-1" class="headerlink" title="*"></a>*</h2><p>匹配0个或<strong>多</strong>个字符</p>
<p>ab*c</p>
<p>可匹配：ac、abc、abbbbc</p>
<p>没有匹配 adc，因为表达式中规定了 a 和 c 中间只能出现0个或者多个 b</p>
<h2 id="-2"><a href="#-2" class="headerlink" title="+"></a>+</h2><p>和 * 不同的是它会匹配出现1次以上的字符</p>
<p>ab+c</p>
<p>可匹配：abc、abbbbc</p>
<p>ac 则不会被匹配</p>
<p>指定 b 出现的次数为6次：ab{6}c</p>
<p>指定 b 出现的次数为2到6之间：ab{2,6}c</p>
<p>指定 b 出现的次数为2以上：ab{2,}c</p>
<p>比如在下面的例子中，我们想去匹配中间多次出现的这个 ab</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">abc</span><br><span class="line">abbc</span><br><span class="line">abababac</span><br></pre></td></tr></table></figure>

<p>我们可以先将 ab 括起来，然后再在后面添加限定符：(ab)+</p>
<h1 id="“或”运算"><a href="#“或”运算" class="headerlink" title="“或”运算"></a>“或”运算</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a cat</span><br><span class="line">a dog</span><br><span class="line">a bird</span><br></pre></td></tr></table></figure>

<p>比如这里我们要去匹配 a cat 或者 a dog，我们可以将正则表达式写成这样：a (cat|dog)</p>
<p>这里前面会先去匹配 “a”，后面括号中的内容代表要么是 cat 要么是 dog，中间以竖线分开，注意这里的括号是比不可少的，否则就变成了要么是 a cat 要么是 dog</p>
<h1 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h1><p>比如我们想要匹配由 abc 这几个字母构成的单词</p>
<p>我们可以写：[abc]+</p>
<p>方括号里的内容代表要求匹配的字符只能取自于它们</p>
<p>我们还可以在方括号指定字符的范围</p>
<p>比如[a-z]+代表所有的小写英文字符，[a-zA-Z]+代表所有的英文字符，[a-zA-Z0-9]+代表所有的英文字符和数字</p>
<p>如果在方括号的前面写一个尖号（^），则代表要求匹配除了尖号后面列出的<strong>以外</strong>的字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">比如[^0-9]代表所有的非数字字符（包括换行符）</span><br></pre></td></tr></table></figure>

<h1 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h1><p>正则表达式中的大多数元字符都以反斜杠开头</p>
<p>\d 代表数字字符，\d+ 等同于 [0-9]+</p>
<p>\w 代表”单词”字符，也就是所有的英文字符、数字加上下划线</p>
<p>\s 代表空白符（包含 Tab 和换行符），它同时包含 Tab 字符以及换行符</p>
<p>与 \d 相对应的 \D 代表非数字字符</p>
<p>与 \w 相对应的 \W 代表非单词字符</p>
<p>与 \s 相对应的 \S 代表非空白字符</p>
<p>. 在正则表达式中也是一个特殊字符，它代表任意字符，但不包含换行符</p>
<p>^ 会匹配行首，$ 会匹配行尾</p>
<p>比如 ^a 只会去匹配行首的 a，a$ 只会去匹配行尾的 a</p>
<h1 id="贪婪与懒惰匹配"><a href="#贪婪与懒惰匹配" class="headerlink" title="贪婪与懒惰匹配"></a>贪婪与懒惰匹配</h1><p>之前我们讲到的 * + {} 在匹配字符串的时候，默认会去匹配尽可能多的字符，比如在下面的例子中</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>This is a sample text<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们想去匹配里面的 html 标签，比如 span 和 b</p>
<p>我们会想到：&lt;.+&gt;</p>
<p>但这个正则表达式会直接把整个字符串都全部匹配了</p>
<p>原因是因为中间的这个 .+ 会匹配尽可能多的字符</p>
<p>我们知道 . 能代表任意字符，自然也会匹配 &gt;，因此才会有这样的结果</p>
<p>解决方法我们在 + 右边加一个 ? 就好了，它会将正则表达式中默认的贪婪匹配切换为懒惰匹配</p>
<h1 id="实例-1-RGB-颜色值匹配"><a href="#实例-1-RGB-颜色值匹配" class="headerlink" title="实例 1 RGB 颜色值匹配"></a>实例 1 RGB 颜色值匹配</h1><p>匹配文本中所有出现的十六进制 RGB 值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#00</span><br><span class="line">#ffffff</span><br><span class="line">#ffaaff</span><br><span class="line">#00hh00</span><br><span class="line">#aabbcc</span><br><span class="line">#000000</span><br><span class="line">#ffffffff</span><br></pre></td></tr></table></figure>

<p>我们可以首先去匹配前面的 # 号，接下来由于代表每一个颜色的字符都是十六进制，因此它们只能取自于 a-f 之间，或者大写的 A-F，或者0-9之间，并且字符一定要出现6次，最后我们在表达式末尾加入 \b 来代表单词字符的边界，这样可以避免这里 #ffffffff 的文本也被识别成 RGB 颜色值</p>
<p>#[a-fA-F0-9]{6}\b</p>
<h1 id="实例-2-IPv4-地址匹配"><a href="#实例-2-IPv4-地址匹配" class="headerlink" title="实例 2 IPv4 地址匹配"></a>实例 2 IPv4 地址匹配</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">123</span><br><span class="line">255.255.255.0</span><br><span class="line">192.168.0.1</span><br><span class="line">0.0.0.0</span><br><span class="line">256.1.1.1</span><br><span class="line">This is a string.</span><br><span class="line">123.123.0</span><br></pre></td></tr></table></figure>



<p>IPv4 的地址实际上是由四段数字构成，数字之间由句点隔开，如果要在文本中提取所有出现的 IP 地址，我们可以直接使用下面这个正则表达式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\d+\.\d+\.\d+\.\d+</span><br></pre></td></tr></table></figure>



<p>\d+ 会匹配任何长度大于1的数字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\. 代表 . 这个字面量，因为 . 在正则表达式中是一个特殊符号，所以我们这里需要用反斜杠作转义</span><br></pre></td></tr></table></figure>

<p>可以看到正则表达式也成功的帮我们匹配了这四个结果</p>
<p>不过这里有一个问题，我们知道 IP 地址的每个部分都是8位的数字</p>
<p>也就是说它的范围介于0-255之间，但这里 256.1.1.1 这个数字显然超出了范围，但是还是被正则表达式成功匹配了</p>
<p>所以如果我们这里要做改良的话，我们可以使用下面这段逻辑</p>
<p>我们先来看 IP 地址被句点隔开的每一部分，如果它的前俩位是25，那么最后一位只能取0-5之间的数字，如果它的第一位是2，第二位是0-4之间的数字，那么最后一位可以取0-9之间的任意值，这里用 \d 代替</p>
<p>如果它的第一位是0或者1，那么最后俩位可以取00-99之间的任意数字，我们用 \d\d代替，但是我们也知道 IP 地址的每一部分也可以由两位数字构成，甚至是1位，这样都是合法的。因此我们可以直接将这里的第一个数字和第三个数字后面都加一个?，就可以表示这种情况了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(25[0-5]|2[0-4]\d|[01]?\d\d?)</span><br></pre></td></tr></table></figure>

<p>数字的部分我们就匹配完了，接下来我们匹配后面的句点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(25[0-5]|2[0-4]\d|[01]?\d\d?)\.</span><br></pre></td></tr></table></figure>

<p>然后将全部表达式用括号括起来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((25[0-5]|2[0-4]\d|[01]?\d\d?)\.)</span><br></pre></td></tr></table></figure>

<p>这一段我们要求重复匹配三次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((25[0-5]|2[0-4]\d|[01]?\d\d?)\.)&#123;3&#125;</span><br></pre></td></tr></table></figure>

<p>这样正则表达式会去匹配 IP 地址的前三段，并且包含每一段后面的句点，至于最后一段数字，我们只需要将匹配第一段数字的这一部分复制过来即可，最后在尾部加入 \b 来匹配字符的边界</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((25[0-5]|2[0-4]\d|[01]?\d\d?)\.)&#123;3&#125;((25[0-5]|2[0-4]\d|[01]?\d\d?)\.)\b</span><br></pre></td></tr></table></figure>

<p>可以看到，经过改良版的表达式可以成功的匹配上面的三个 IP 地址，并且把不符合要求的这一个排除在外了</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/image-20220315235724530.png"></p>
<p>其它教程</p>
<ol>
<li><p>正则表达式30分钟入门教程 作者: deerchao <a target="_blank" rel="noopener" href="https://deerchao.cn/tutorials/regex/regex.htm">https://deerchao.cn/tutorials/regex/regex.htm</a></p>
</li>
<li><p>Regex tutorial — A quick cheatsheet by examples (英文) 作者: Jonny Fox <a target="_blank" rel="noopener" href="https://medium.com/factory-mind/regex-tutorial-a-simple-cheatsheet-by-examples-649dc1c3f285">https://medium.com/factory-mind/regex-tutorial-a-simple-cheatsheet-by-examples-649dc1c3f285</a></p>
</li>
<li><p>Regular Expressions Tutorial (英文) <a target="_blank" rel="noopener" href="https://www.regular-expressions.info/tutorial.html">https://www.regular-expressions.info/tutorial.html</a></p>
</li>
</ol>
<p>未讲到全部内容，比如捕获、断言、递归、平衡组等等</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/01-Java%E5%9F%BA%E7%A1%80/05-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/01-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%85%A5%E9%97%A8/" data-id="clmcxecrn006lu8wa6cwl9l9d" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-999-工具/02-MyBatis Migrations/03-MyBatis Migrations Hooks" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/999-%E5%B7%A5%E5%85%B7/02-MyBatis%20Migrations/03-MyBatis%20Migrations%20Hooks/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.203Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>您可以编写在 up&#x2F;down 操作之前或之后执行的钩子脚本，支持使用SQL或JSR-223兼容的脚本语言。</p>
<h1 id="创建钩子脚本"><a href="#创建钩子脚本" class="headerlink" title="创建钩子脚本"></a>创建钩子脚本</h1><p>在基本目录中创建一个名为<code>hooks</code>的目录。</p>
<p>在<code>hooks</code>目录创建<code>hello.js</code>钩子脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hello.js</span></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;Hello, World!&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>钩子脚本是通过在环境属性文件(例如：development.properties)中添加一行以<code>key=value</code>的格式来配置的。</p>
<p>以下代码告诉 MyBatis Migrations在<code>migrate up</code>命令运行前执行<code>hello.js</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook_before_up=<span class="title class_">JavaScript</span>:hello.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//输出</span><br><span class="line">========== Applying JSR-223 hook : hello.js ==========</span><br><span class="line">Hello, World!</span><br></pre></td></tr></table></figure>

<h2 id="键"><a href="#键" class="headerlink" title="键"></a>键</h2><ul>
<li>hook_before_up</li>
<li>hook_before_each_up</li>
<li>hook_after_each_up</li>
<li>hook_after_up</li>
<li>hook_before_down</li>
<li>hook_before_each_down</li>
<li>hook_after_each_down</li>
<li>hook_after_down</li>
<li>hook_before_new [1]</li>
<li>hook_after_new [1]</li>
<li>hook_before_script [1]</li>
<li>hook_before_each_script [1]</li>
<li>hook_after_each_script [1]</li>
<li>hook_after_script [1]</li>
</ul>
<p>[1] 仅支持 JSR-223 脚本。</p>
<h2 id="值"><a href="#值" class="headerlink" title="值"></a>值</h2><p>值部分由两个或多个以冒号<code>:</code>分隔的段组成。第一段是语言名称（例如<code>SQL</code>、<code>JavaScript</code>、<code>Groovy</code>等）。第二段是文件名。这两个部分是必需的。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>这些变量可以有任意名称，但也有一些用于 JSR-223 钩子的特殊变量名称。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js示例</span></span><br><span class="line"><span class="comment">// printvar.js</span></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&#x27;This is &#x27;</span> + when + <span class="string">&#x27; &#x27;</span> + what + <span class="string">&#x27; hook.&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// development.properties</span></span><br><span class="line">hook_before_up=<span class="title class_">JavaScript</span>:printvar.<span class="property">js</span>:when=<span class="attr">before</span>:what=up</span><br><span class="line">hook_after_down=<span class="title class_">JavaScript</span>:printvar.<span class="property">js</span>:when=<span class="attr">after</span>:what=down</span><br><span class="line"></span><br><span class="line"><span class="comment">// migrate up输出</span></span><br><span class="line"><span class="title class_">This</span> is before up hook.</span><br><span class="line"></span><br><span class="line"><span class="comment">// migrate down输出</span></span><br><span class="line"><span class="title class_">This</span> is after down hook.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// sql示例</span><br><span class="line">// update_timestamp.sql</span><br><span class="line">update worklog set $&#123;col&#125; = current_date();</span><br><span class="line"></span><br><span class="line">// development.properties</span><br><span class="line">hook_before_up=SQL:update_timestamp.sql:col=before</span><br><span class="line">hook_after_up=SQL:update_timestamp.sql:col=after</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>要调用函数，请使用特殊变量名称<code>_function</code>指定函数名称和<code>_arg</code>指定参数值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// foobar.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">print</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">id, name</span>) &#123;</span><br><span class="line">  <span class="title function_">print</span>(id + <span class="string">&#x27;:&#x27;</span> + name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// development.properties</span></span><br><span class="line">hook_before_up=<span class="attr">js</span>:foobar.<span class="property">js</span>:_function=foo</span><br><span class="line">hook_after_up=<span class="attr">js</span>:foobar.<span class="property">js</span>:_function=<span class="attr">bar</span>:_arg=<span class="number">100</span>:_arg=<span class="title class_">John</span></span><br></pre></td></tr></table></figure>

<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>要调用方法，请使用特殊变量名称<code>_object</code>指定对象名称和<code>_method</code>指定方法名称以及<code>_arg</code>指定参数值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doggy.js</span></span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">dog.<span class="property">bark</span> = <span class="keyword">function</span>(<span class="params">who, times</span>) &#123;</span><br><span class="line">  <span class="title function_">print</span>(<span class="string">&#x27;bow-wow &#x27;</span> + times + <span class="string">&#x27; times at &#x27;</span> + who);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// development.properties</span></span><br><span class="line">hook_before_up=<span class="attr">js</span>:doggy.<span class="property">js</span>:_object=<span class="attr">dog</span>:_method=<span class="attr">bark</span>:_arg=<span class="title class_">Lucy</span>:_arg=<span class="number">128</span></span><br></pre></td></tr></table></figure>

<h1 id="JSR-223兼容脚本语言"><a href="#JSR-223兼容脚本语言" class="headerlink" title="JSR-223兼容脚本语言"></a>JSR-223兼容脚本语言</h1><p>以添加支持使用groovy脚本语言为例</p>
<p>首先，拷贝<a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy">groovy.jar</a> 和 <a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/org.codehaus.groovy/groovy-jsr223">groovy-jsr223.jar</a> 到<code>$MIGRATIONS_HOME/lib</code>目录。</p>
<p>然后，在<code>hooks</code>目录创建<code>hello.groovy</code>钩子脚本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">println</span>(<span class="string">&#x27;Hello groovy!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最后，添加配置到环境属性文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook_before_up=<span class="attr">groovy</span>:hello.<span class="property">groovy</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/999-%E5%B7%A5%E5%85%B7/02-MyBatis%20Migrations/03-MyBatis%20Migrations%20Hooks/" data-id="clmcxecn00059u8wa550odhgv" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>