<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-16-Nginx/08-负载均衡整体架构" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/08-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.849Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="负载均衡整体架构"><a href="#负载均衡整体架构" class="headerlink" title="负载均衡整体架构"></a>负载均衡整体架构</h1><p>负载均衡调度器，分担网络请求到后端集群<br>CDN和反向代理， 基本原理都是缓存<br>反向代理部署在网站中心机房，CDN则靠近用户的网络服务提供商</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223155256.png"></p>
<h2 id="负载均衡层"><a href="#负载均衡层" class="headerlink" title="负载均衡层"></a>负载均衡层</h2><p>F5也能用来架设防火墙集群<br>LVS能做成集群、主从、双主的形式<br>Nginx能做成集群、主从形式</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223155355.png"></p>
<h2 id="硬件负载均衡"><a href="#硬件负载均衡" class="headerlink" title="硬件负载均衡"></a>硬件负载均衡</h2><p>F5的全称是F5-BIG-IP LTM，是最流行的硬件负载均衡设备，并发能力达到百万级。<br><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223155542.png"></p>
<p>F5产品系列：<br>F5 BIG-IP ASM应用安全管理器产品<br>F5 BIG-IP Edge Gateway产品<br>F5 BIG-IP GTM广域流量管理器产品<br>F5 BIG-IP LTM本地流量管理器产品<br>F5 BIG-IP SAM 安全接入管理器产品<br>F5 BIG-IP Web应用加速器产品<br>F5 BIG-IP 链路控制器产品<br>F5 BIG-IP 企业管理器产品<br>F5 BIG-IP 广域网优化模块产品</p>
<p>F5的特性包括：</p>
<ol>
<li>多链路的负载均衡和冗余</li>
<li>防火墙负载均衡</li>
<li>服务器负载均衡</li>
<li>高可用</li>
<li>安全性</li>
<li>易于管理</li>
<li>还提供SSL加速、软件升级、IP地址过滤、带宽控制等辅助功能</li>
</ol>
<p>F5中国区官网：<a target="_blank" rel="noopener" href="https://f5.com/zh">https://f5.com/zh</a></p>
<h2 id="软硬件负载均衡的区别"><a href="#软硬件负载均衡的区别" class="headerlink" title="软硬件负载均衡的区别"></a>软硬件负载均衡的区别</h2><p>硬件负载均衡设备有：NetScaler、F5、Radware和Array等。硬件负载均衡优点有专业团队进行维护，单机抗压能力强悍；缺点花销太大，规模较小的网站来说还不需要使用。</p>
<p>软件负载均衡有：LVS&#x2F;HAProxy、Nginx等，基于Linux的开源免费的负载均衡软件策略。通过软件级别来实现，费用非常低廉，很多大型的互联网公司都采用软件负载均衡来架设自己网站。软件负载均衡稳定性非常好，几乎很少宕机。</p>
<p>我们的电脑也具有路由功能，但是路由器却更善于处理网络路由的事情。硬件负载均衡比软件负载均衡强悍，是因为其内部有针对性的设计硬件设备，专门用来处理网络传输流量处理。</p>
<p>推荐大家优先考虑采用软件负载均衡来实施自己网站的负载均衡需求。</p>
<h2 id="为什么服务器负载均衡无法实现10亿级并发"><a href="#为什么服务器负载均衡无法实现10亿级并发" class="headerlink" title="为什么服务器负载均衡无法实现10亿级并发"></a>为什么服务器负载均衡无法实现10亿级并发</h2><p>再强悍的硬件负载设备，单台服务器的处理能力是有限的。当达到某一个瓶颈时如何处理？</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223155846.png"></p>
<h1 id="互联网必用负载均衡方案DNS"><a href="#互联网必用负载均衡方案DNS" class="headerlink" title="互联网必用负载均衡方案DNS"></a>互联网必用负载均衡方案DNS</h1><h2 id="DNS设计"><a href="#DNS设计" class="headerlink" title="DNS设计"></a>DNS设计</h2><p>DNS，Domain Name System，域名系统是因特网上作为域名和IP地址相互映射的一个<strong>分布式数据库</strong>，方便用户访问互联网。一个域名对应多个IP地址。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223155924.png"></p>
<p>一种简单的设计模式，在因特网上只使用一个DNS服务器，该服务器包含所有的映射。不适用当前的互联网，单点故障、通信容量、远距离延时、维护成本大。</p>
<p>DNS服务器一般分三种，根DNS服务器，顶级DNS服务器，权威DNS服务器，使用分布式的层次数据库模式以及缓存方法来解决单点集中式的问题。</p>
<h2 id="DNS核心流程分析"><a href="#DNS核心流程分析" class="headerlink" title="DNS核心流程分析"></a>DNS核心流程分析</h2><p>DNS解析过程,从浏览器出发：</p>
<ol>
<li>本地的hosts文件</li>
<li>本地DNS解析器缓存</li>
<li>本地DNS服务器，权威</li>
<li>本地DNS服务器缓存，非权威</li>
<li>本地DNS服务器找不到<br>非转发，根DNS服务器—&gt;顶级域名服务器<br>转发上一级DNS服务器，如此循环</li>
<li>由本地DNS服务器再返回给客户机</li>
</ol>
<p>用命令 nslookup <a target="_blank" rel="noopener" href="http://www.qq.com/">www.qq.com</a> 试试</p>
<p>从客户端到本地DNS服务器是属于递归查询，而DNS服务器之间就是的交互查询就是迭代查询。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223160101.png"></p>
<h2 id="DNS负载均衡优缺点分析"><a href="#DNS负载均衡优缺点分析" class="headerlink" title="DNS负载均衡优缺点分析"></a>DNS负载均衡优缺点分析</h2><p>优点：</p>
<ul>
<li>技术实现比较灵活、方便，简单易行，成本低，适用大多数TCP&#x2F;IP应用。不需要网络专家来进行设定维护。 </li>
<li>对于Web应用不需要修改代码来支持。</li>
<li>Web服务器可以位于互联网的任意位置上。</li>
</ul>
<p>缺点：</p>
<ul>
<li><p>单一的轮询负载算法。不能够按照Web服务器的处理能力分配负载。</p>
</li>
<li><p>不支持高可靠性。DNS负载均衡技术没有考虑容错。某台Web服务器出现故障，请求仍分配到这台故障服务器上。</p>
</li>
<li><p>可能造成额外的网络开销。为本地DNS服务数据实时性，与其他DNS同步，刷新时间设置较小，会使得DNS流量大增。</p>
</li>
<li><p>服务故障恢复有时延。某个服务器出现故障，即使及时修改了DNS设置，还是要等待DNS刷新后才能发挥作用，等待期间，不能正常访问服务器。</p>
</li>
</ul>
<h2 id="客户端负载均衡和服务端服务均衡异同"><a href="#客户端负载均衡和服务端服务均衡异同" class="headerlink" title="客户端负载均衡和服务端服务均衡异同"></a>客户端负载均衡和服务端服务均衡异同</h2><p><strong>服务端负载均衡，</strong>请求到达服务器后，再从服务列表中挑选服务器,<strong>实现</strong></p>
<ul>
<li>DNS域名解析负载均衡</li>
<li>反向代理负载均衡</li>
<li>IP负载均衡</li>
</ul>
<p><strong>客户端负载均衡</strong>，请求未发起，先从客户端缓存的服务列表挑选服务，<strong>实现</strong></p>
<ul>
<li>Spring cloud中的ribbon</li>
<li>Redis中的分片集群客户端计算slot槽位</li>
</ul>
<p>客户端负载均衡和服务器负载均衡的核心差异在服务列表本身，客户端负载均衡服务列表在通过客户端维护，服务器负载均衡服务列表由中间服务单独维护。</p>
<h1 id="基于云平台CDN服务实现内容分发和分流"><a href="#基于云平台CDN服务实现内容分发和分流" class="headerlink" title="基于云平台CDN服务实现内容分发和分流"></a>基于云平台CDN服务实现内容分发和分流</h1><p>CDN，全称Content Delivery Network，即内容分发网络。通过现有的Internet中增加一层新的网络架构，将网站的内容发布到最接近用户的网络”边缘”，使用户可以就近取得所需的内容，解决Internet网络拥挤的状况，提高用户访问网站的响应速度。</p>
<p>CDN包括分布式存储、负载均衡、网络请求的重定向和内容管理4个要件，而内容管理和全局的网络流量管理(TrafficManagement)是CDN的核心所在。内容服务基于缓存服务器，也称作代理缓存(Surrogate)，它位于网络的边缘，距用户仅有”一跳”(Single Hop)之遥。</p>
<p>CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源站的负载</p>
<h2 id="CDN刷新机制"><a href="#CDN刷新机制" class="headerlink" title="CDN刷新机制"></a>CDN刷新机制</h2><p>在Http请求响应中使用CDN</p>
<p>​	<img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221223160447.png"></p>
<p>浏览器缓存策略有：Expires、Cache-control、Last-Modified、Max-age、Etag</p>
<p>CDN缓存策略<br>类似浏览器缓存，CDN边缘节点也存在着一套缓存机制。CDN边缘节点缓存策略因服务商不同而不同，但一般都会遵循http标准协议，通过http响应头中的Cache-control: max-age的字段来设置CDN边缘节点数据缓存时间。</p>
<p>当网站更新时，如果CDN节点上数据没有及时更新，即便用户再浏览器使用Ctrl+F5的方式使浏览器端的缓存失效，也会因为CDN边缘节点没有同步最新数据而导致用户访问异常。</p>
<p>CDN边缘节点对开发者是透明的，相比于浏览器Ctrl+F5的强制刷新来使浏览器本地缓存失效，开发者可以通过CDN服务商提供的“刷新缓存”接口来达到清理CDN边缘节点缓存的目的。</p>
<h2 id="常用CDN平台分享"><a href="#常用CDN平台分享" class="headerlink" title="常用CDN平台分享"></a>常用CDN平台分享</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/aspnet/ajax/cdn/overview">微软CDN</a><br>为了吸引更多开发人员和网站使用ASP.NET，微软为Microsoft AJAX和jQuery脚本提供了免费的CDN服务。提供了jQuery系 列,jQ Validation,jQ Cycle,jQ DataTables及Ajax Control Toolkit,ASP.NET等资源。</p>
<p><a target="_blank" rel="noopener" href="http://lib.sinaapp.com/">新浪SAE CDN</a><br>新浪的SAE CDN的public resource加速服务，对常用js&#x2F;css库在全国采用cdn加速,用户只在第一次访问时加载js库,以后就直接在本地缓存读了。提供的库同百度基本相当。</p>
<p><a target="_blank" rel="noopener" href="http://www.staticfile.org/">开放静态文件 CDN</a><br>不仅仅是一个JS库CDN，而是提供了一个仓库，尽可能全面收录优秀的开源库，并免费为之提供 CDN 加速服务，使之有更好的访问速度和稳定的环境。同时，也提供开源库源接入的入口，让所有人都可以提交开源库，包括 JS、CSS、image 和swf 等静态文件。一方面，提供了最新最流行的JS等库资源如angular,underscore,backbone,zepto,seajs等 ;另一方面，提供命令行工具鼓励程序猿自行提交和管理开源库。</p>
<p><a target="_blank" rel="noopener" href="http://cdnjs.com/">CDNJS</a><br>大名鼎鼎的JS资源库平台，号称Web 上最快的 JavaScript 资源库(啧啧)，类似 Google CDN 和微软 CDN 服务，但是速度比这二者更加快。CDNJS 上提供了众多 JavaScript 库，你可以直接在网页上引用这些 JS 文件，实现用户浏览网站的最佳速度体验。同开放静态CDN一样，CDNJS也鼓励添加JS库到该站，只需要提交到 CDNJS 在 Github 上的项目即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/08-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/" data-id="clmcxecdc003fu8wa3k0vfulf" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/07-01-高可用Nginx集群安装搭建手册" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/07-01-%E9%AB%98%E5%8F%AF%E7%94%A8Nginx%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.843Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="高可用Nginx集群安装搭建手册"><a href="#高可用Nginx集群安装搭建手册" class="headerlink" title="高可用Nginx集群安装搭建手册"></a>高可用Nginx集群安装搭建手册</h1><h2 id="LVS搭建Nginx集群"><a href="#LVS搭建Nginx集群" class="headerlink" title="LVS搭建Nginx集群"></a>LVS搭建Nginx集群</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>共需要三台linux centos服务器，一台LVS，两台RealServer，<strong>端口号必须保持一致，设为80</strong>，所以需要3台服务器。</p>
<p><strong>设定IP环境如下</strong></p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>IP</th>
<th>端口</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LVS-Director</td>
<td>VIP 192.168.120.200<br>RIP 192.168.120.58</td>
<td>80</td>
<td>运行LVS均衡调度，对外提供虚拟IP访问</td>
</tr>
<tr>
<td>RealServer-Nginx1</td>
<td>192.168.120.83</td>
<td>80</td>
<td>运行nginx及tomcat服务，作为真实服务1</td>
</tr>
<tr>
<td>RealServer-Nginx2</td>
<td>192.168.120.58</td>
<td>80</td>
<td>运行nginx及tomcat服务，作为真实服务2</td>
</tr>
</tbody></table>
<p>LVS-Director负责将80端口的请求，负载均衡到Nginx1、Nginx2两台真实服务器上去，接下来我们将进行配置LVS-Director的路由方式-DR，直接路由。</p>
<p>准备IP地址信息打印程序balancer-1.0.0.jar，<a href="http://hostname:port/server/ip，打印服务器的IP端口号信息。">http://hostname:port/server/ip，打印服务器的IP端口号信息。</a></p>
<h3 id="启动RealServer服务"><a href="#启动RealServer服务" class="headerlink" title="启动RealServer服务"></a>启动RealServer服务</h3><p>安装步骤，参考前面Nginx的手册来操作，将Nginx分别安装在前面准备的两台linux服务器上。</p>
<p>启动Nginx，都为80端口，代理balancer-1.0.0.jar服务。</p>
<p>balancer-1.0.0.jar的端口号，分别为8081</p>
<p>操作192.168.120.83、192.168.120.58</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar balancer-1.0.0.jar --server.port=8081</span><br><span class="line">cd /usr/local/nginx</span><br><span class="line">sudo ./nginx -c conf/nginx_lvs_upstream.conf</span><br></pre></td></tr></table></figure>

<p>nginx_lvs_upstream.conf配置内容，提供在课件资料中</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  text/html;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="regexp">//</span>backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试各个端口的服务是否可用，<a href="http://hostname:port/server/ip">http://hostname:port/server/ip</a></p>
<h2 id="安装LVS"><a href="#安装LVS" class="headerlink" title="安装LVS"></a>安装LVS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LVS全称为Linux Virtual Server，工作在ISO模型中的第四层，由于其工作在第四层，因此与iptables类似，必须工作在内核空间上。因此lvs与iptables一样，是直接工作在内核中的，叫ipvs，主流的linux发行版默认都已经集成了ipvs，因此用户只需安装一个管理工具ipvsadm即可。</span><br><span class="line">LVS现在已成为Linux内核的一部分，默认编译为ip_vs模块，必要时能够自动调用。以下操作可以手动加载ip_vs模块，并查看当前系统中ip_vs模块的版本信息。</span><br></pre></td></tr></table></figure>

<h3 id="加载LVS"><a href="#加载LVS" class="headerlink" title="加载LVS"></a>加载LVS</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过下面命令来检查，如果没有显示，则说明没有加载</span></span><br><span class="line">lsmod |grep ip_vs</span><br><span class="line">ip_vs                 145497  0 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载LVS，执行下面命令就可以把ip_vs模块加载到内核</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或者如果是centos7，通过ipvsadm来加载，可以跳过这步</span></span><br><span class="line">sudo modprobe ip_vs</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看LVS版本号,说明安装成功</span></span><br><span class="line">cat /proc/net/ip_vs</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port Forward Weight ActiveConn InActConn</span></span><br></pre></td></tr></table></figure>

<h3 id="IPVS管理工具ipvsadm"><a href="#IPVS管理工具ipvsadm" class="headerlink" title="IPVS管理工具ipvsadm"></a>IPVS管理工具ipvsadm</h3><p>ipvsadm是lvs的管理工具，我们在使用ipvs的时候需要使用到这个工具。</p>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y gcc gcc-c++ makepcre pcre-devel kernel-devel openssl-devel libnl-devel popt*</span><br></pre></td></tr></table></figure>

<h4 id="安装ipvsadm"><a href="#安装ipvsadm" class="headerlink" title="安装ipvsadm"></a>安装ipvsadm</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;http://www.linuxvirtualserver.org/software/kernel-2.6/ipvsadm-1.26.tar.gz&quot; -o ipvsadm-1.26.tar.gz</span><br><span class="line">tar zxf ipvsadm-1.26.tar.gz  </span><br><span class="line">cd ipvsadm-1.26 </span><br><span class="line">rpm -qa | grep kernel-devel	# 确认是否安装了kernel-devel（默认已经安装）</span><br><span class="line">sudo make &amp;&amp; sudo make install</span><br><span class="line"></span><br><span class="line">curl &quot;http://www.linuxvirtualserver.org/software/kernel-2.6/ipvsadm-1.25-1.src.rpm&quot; -o ipvsadm-1.25-1.src.rpm</span><br><span class="line">sudo rpm -ivh ipvsadm-1.25-1.src.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否安装成功，显示下面的内容表示安装成功</span></span><br><span class="line">sudo ipvsadm</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br></pre></td></tr></table></figure>



<h2 id="LVS-DR模式"><a href="#LVS-DR模式" class="headerlink" title="LVS DR模式"></a>LVS DR模式</h2><p>DR模式是LVS三种实现负载均衡方式中性能最好的一个，下面就使用这个模式，配置Nginx负载均衡的实现。</p>
<h3 id="DR配置"><a href="#DR配置" class="headerlink" title="DR配置"></a>DR配置</h3><h4 id="LVS配置"><a href="#LVS配置" class="headerlink" title="LVS配置"></a>LVS配置</h4><p>编辑lvs文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/sbin/lvs_dr.sh</span><br></pre></td></tr></table></figure>

<p>输入下面内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1，启用ip转发；0，禁止ip转发；默认0。</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义两个变量方便后面使用</span></span><br><span class="line">ipv=/sbin/ipvsadm</span><br><span class="line">vip=192.168.120.200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过ifconfig，找到自己的网卡名，我这里是enp0s3</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下掉enp0s3:0的虚拟ip</span></span><br><span class="line">ifconfig enp0s3:0 down</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过ifconfig，找到自己的网卡名，在其下面绑定虚拟ip</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在enp0s3上绑定虚拟ip，虚拟ip地址的广播地址是它本身</span></span><br><span class="line">ifconfig enp0s3:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加路由规则</span></span><br><span class="line">route add -host $vip dev enp0s3:0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清除原有转发规则</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ipv -C</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增虚拟服务端口，采用轮询策略，负载转发端口是80</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ipv -A -t <span class="variable">$vip</span>:80 -s rr</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义实际服务ip</span></span><br><span class="line">rs1=192.168.120.103</span><br><span class="line">rs2=192.168.120.58</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-a在虚拟IP中添加上游服务信息；-t表示tcp服务</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-r表示真实服务信息；-g指定为LVS为直接路由模式</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ipv -a -t <span class="variable">$vip</span>:80 -r <span class="variable">$rs1</span>:80 -g</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ipv -a -t <span class="variable">$vip</span>:80 -r <span class="variable">$rs2</span>:80 -g</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ipv --<span class="built_in">set</span> 1 2 1</span></span><br></pre></td></tr></table></figure>

<p>使配置生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sh /usr/local/sbin/lvs_dr.sh</span><br><span class="line">sudo ipvsadm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看虚拟服务端口转发列表</span></span><br><span class="line">sudo ipvsadm -ln</span><br></pre></td></tr></table></figure>

<h4 id="可能出现的错误"><a href="#可能出现的错误" class="headerlink" title="可能出现的错误"></a>可能出现的错误</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">0、SIOCSIFFLAGS: 无法指定被请求的地址</span><br><span class="line">没有对应的enp0s3:0网卡ip，本来就没有，可以忽略。运行脚本后enp0s3:0正常出现就没有问题。</span><br><span class="line"></span><br><span class="line">1、没有轮询效果</span><br><span class="line">一条tcp的连接经过lvs后,lvs会把这台记录保存15分钟</span><br><span class="line">sudo ipvsadm -L --timeout	# 查看timeout配置信息</span><br><span class="line">可以设置短一点，达到实验效果：</span><br><span class="line">sudo ipvsadm --set 1 2 1</span><br><span class="line"></span><br><span class="line">注： 保存添加的虚拟ip记录和ipvsadm的规则可以使用service ipvsadm save，还可以用-S或--save。清除所有记录和规则除了使用-C，还以使用--clear</span><br><span class="line"></span><br><span class="line">2、错误：Memory allocation problem</span><br><span class="line">查看一下vmlloc使用情况： </span><br><span class="line">cat /proc/meminfo | grep -i vmalloc</span><br><span class="line">在/etc/default/grub文件的末尾添加如下一行：</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;vmalloc=256MB&quot;</span><br><span class="line"></span><br><span class="line">完成上述操作之后，发现lvs状态仍然是SYN_RECV。</span><br><span class="line"></span><br><span class="line">3、lvs状态仍然是SYN_RECV</span><br><span class="line">抓包后的pcap文件中，没有syn ack。于是想到是不是在什么地方丢掉了。</span><br><span class="line">看到官方文档中有描述要设置re_ filter。</span><br><span class="line">查了一下这个参数的解释</span><br><span class="line">======================================</span><br><span class="line">rp_filter参数有三个值，0、1、2，具体含义：</span><br><span class="line">0：不开启源地址校验。</span><br><span class="line">1：开启严格的反向路径校验。对每个进来的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该数据包。</span><br><span class="line">2：开启松散的反向路径校验。对每个进来的数据包，校验其源地址是否可达，即反向路径是否能通（通过任意网口），如果反向路径不同，则直接丢弃该数据包。</span><br><span class="line">=======================================</span><br><span class="line">default的值是1，这里改为2</span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/ 网卡名/rp_filter</span><br><span class="line">echo 2 &gt; /proc/sys/net/ipv4/conf/ 网卡名/rp_filter</span><br><span class="line">systemctl restart network.service</span><br><span class="line"></span><br><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo &quot;2&quot;&gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo &quot;1&quot;&gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>



<h4 id="ipvsadm操作说明"><a href="#ipvsadm操作说明" class="headerlink" title="ipvsadm操作说明"></a>ipvsadm操作说明</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -C 清除</span><br><span class="line">说明：</span><br><span class="line">-A  --add-service在服务器列表中新添加一条新的虚拟服务器记录</span><br><span class="line">-t 表示为tcp服务</span><br><span class="line">-u 表示为udp服务</span><br><span class="line">-s --scheduler 使用的调度算法， rr | wrr | lc | wlc | lblb | lblcr | dh | sh | sed | nq 默认调度算法是 wlc</span><br><span class="line">-a --add-server 在服务器表中添加一条新的真实主机记录</span><br><span class="line">-r --real-server  真实服务器地址</span><br><span class="line">-m --masquerading 指定LVS工作模式为NAT模式</span><br><span class="line">-w --weight 真实服务器的权值</span><br><span class="line">-g --gatewaying 指定LVS工作模式为直接路由器模式（也是LVS默认的模式）</span><br><span class="line">-i --ipip 指定LVS的工作模式为隧道模式</span><br><span class="line"></span><br><span class="line">sudo ipvsadm -help 可以查看更多的帮助信息</span><br></pre></td></tr></table></figure>



<h3 id="真实服务配置"><a href="#真实服务配置" class="headerlink" title="真实服务配置"></a>真实服务配置</h3><p>在lvs的DR和TUn模式下，用户的访问请求到达真实服务器后，响应数据是直接返回给用户的，而不再经过前端的Director Server，因此，就需要在每个Real server节点上增加虚拟的VIP地址，这样数据才能直接返回给用户。</p>
<p><strong>2台服务都需要配置相同的内容</strong>，2台真实web服务器的配置信息，编辑lvs_dr_rs.sh文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/sbin/lvs_dr_rs.sh</span><br></pre></td></tr></table></figure>

<p>输入内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line">vip=192.168.120.200</span><br><span class="line">ifconfig enp0s3:0 $vip broadcast $vip netmask 255.255.255.255 up</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用回环网卡适配器</span></span><br><span class="line">route add -host $vip lo:0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭arp解析</span></span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

<p>关闭arp解析</p>
<p>arp_ignore：当ARP请求发过来后发现自己正是请求的地址是否响应；       </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 - 利用本地的任何地址，不管配置在哪个接口上去响应ARP请求；</span><br><span class="line">1 - 哪个接口上接受ARP请求，就从哪个端口上回应。</span><br></pre></td></tr></table></figure>

<p>arp_announce ：定义不同级别，当ARP请求通过某个端口进来是否利用这个接口来回应。</p>
<pre><code>0 - 利用本地的任何地址，不管配置在哪个接口上去响应ARP请求；
1 - 避免使用另外一个接口上的mac地址去响应ARP请求；
2 - 尽可能使用能够匹配到ARP请求的最佳地址。
</code></pre>
<p><strong>使配置生效</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sh /usr/local/sbin/lvs_dr_rs.sh</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>

<p><strong>检查是否生效</strong></p>
<p>多出enp0s3:0:虚拟网卡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br><span class="line">enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.120.127  netmask 255.255.255.0  broadcast 192.168.120.255</span><br><span class="line">        inet6 fe80::370a:a3ea:20d0:69e3  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 08:00:27:f1:e3:c4  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 123143  bytes 129065693 (123.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 28035  bytes 2598163 (2.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 88  bytes 9145 (8.9 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">lo:0: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 192.168.100.200  netmask 255.255.255.255</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br></pre></td></tr></table></figure>



<h3 id="可能出现的错误-1"><a href="#可能出现的错误-1" class="headerlink" title="可能出现的错误"></a>可能出现的错误</h3><h4 id="不能telnet端口"><a href="#不能telnet端口" class="headerlink" title="不能telnet端口"></a>不能telnet端口</h4><p><strong>现象描述</strong>  VIP能ping桶，但是VIP对应的端口号telnet不通</p>
<p><strong>解决方法</strong></p>
<p>确认真实服务器VIP是否一致</p>
<p>真实服务器与LVS-Director的端口号必须相同</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在浏览器输入访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.120.200:8080/server/ip</span><br></pre></td></tr></table></figure>

<p>如果你发现IP地址在变化，恭喜你，成功了！</p>
<h3 id="封装成shell脚本"><a href="#封装成shell脚本" class="headerlink" title="封装成shell脚本"></a>封装成shell脚本</h3><h4 id="LVS-Director脚本"><a href="#LVS-Director脚本" class="headerlink" title="LVS-Director脚本"></a>LVS-Director脚本</h4><p>见课件资料《lvs_dr.sh》shell脚本，在LVS-DR机器上我们只需要执行lvs_dr.sh脚本即可</p>
<p>使用方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo sh lvs_dr.sh --help</span><br><span class="line">Usage: lvs_dr.sh &#123;start ¦ stop&#125;</span><br><span class="line">Usage: lvs_dr.sh start vip vip_port &quot;real_server_ips...&quot; virtual_net_card</span><br><span class="line">Usage: lvs_dr.sh stop virtual_net_card</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动，指定虚拟ip、真实服务ip、虚拟网卡</span></span><br><span class="line">sudo sh lvs_dr.sh start 192.168.120.200 80 &quot;192.168.120.83 192.168.120.58&quot; enp0s3:0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止</span></span><br><span class="line">sudo sh lvs_rs.sh stop enp0s3:0</span><br></pre></td></tr></table></figure>



<h4 id="RealServer脚本"><a href="#RealServer脚本" class="headerlink" title="RealServer脚本"></a>RealServer脚本</h4><p>见课件资料《lvs_rs.sh》shell脚本，在RealServer机器上我们只需要执行lvs_rs.sh脚本即可</p>
<p>使用方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sh lvs_rs.sh --help</span><br><span class="line">Usage: lvs_rs.sh &#123;start ¦ stop&#125;</span><br><span class="line">Usage: lvs_rs.sh start vip loopback</span><br><span class="line">Usage: lvs_rs.sh stop loopback</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动，指定虚拟ip、虚拟网卡</span></span><br><span class="line">sudo sh lvs_rs.sh start 192.168.120.200 lo:0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止</span></span><br><span class="line">sudo sh lvs_rs.sh stop lo:0</span><br></pre></td></tr></table></figure>

<p>window下编写的shell脚本，在linux下运行有<code>$&#39;\r&#39;: 未找到命令</code>的错误，是因为编码格式问题，通过dos2unix来解决。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y dos2unix</span><br><span class="line">sudo dos2unix lvs_rs.sh</span><br></pre></td></tr></table></figure>



<h2 id="Keepalived保证应用高可用"><a href="#Keepalived保证应用高可用" class="headerlink" title="Keepalived保证应用高可用"></a>Keepalived保证应用高可用</h2><p>只有一台LVS服务，万一挂了怎么办？需要Keepalived来做高可用，准备两台linux服务器，用来安装两台keepalived，Keepalived安装过程如下。</p>
<h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><p>做LVS高可用，我们需要准备四台服务器</p>
<h4 id="服务器设定"><a href="#服务器设定" class="headerlink" title="服务器设定"></a>服务器设定</h4><p>共需要四台服务器，两台LVS，两台RealServer，<strong>端口号必须保持一致，设为80</strong>，所以需要4台服务器。</p>
<p><strong>设定IP环境如下</strong></p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>IP</th>
<th>端口</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LVS-Master<br>Keepalived-Master</td>
<td>VIP 192.168.120.200<br>RIP 192.168.120.127</td>
<td>80</td>
<td>主LVS，对外提供虚拟IP访问</td>
</tr>
<tr>
<td>LVS-Backup<br/>Keepalived-Backup</td>
<td>VIP 192.168.120.200<br/>RIP 192.168.120.128</td>
<td>80</td>
<td>备份LVS，对外提供虚拟IP访问<br>当主LVS不可用时，VIP漂移到备份LVS<br>当主LVS恢复可用时，VIP漂移回主LVS</td>
</tr>
<tr>
<td>RealServer-Nginx1</td>
<td>192.168.120.124</td>
<td>80</td>
<td>运行nginx及tomcat服务，作为真实服务1</td>
</tr>
<tr>
<td>RealServer-Nginx2</td>
<td>192.168.120.120</td>
<td>80</td>
<td>运行nginx及tomcat服务，作为真实服务2</td>
</tr>
</tbody></table>
<p>LVS-Director负责将80端口的请求均衡到Nginx1、Nginx2两台真实服务器上去，接下来我们将进行配置LVS-Director的路由方式-DR，直接路由。</p>
<p>准备IP地址信息打印程序balancer-1.0.0.jar，<a href="http://hostname:port/server/ip，打印服务器的IP端口号信息。">http://hostname:port/server/ip，打印服务器的IP端口号信息。</a></p>
<h4 id="准备LVS"><a href="#准备LVS" class="headerlink" title="准备LVS"></a>准备LVS</h4><p>在LVS-Master、LVS-Backup两台服务器上启用LVS，具体参考前面LVS安装部分内容。确保任意的LVS能够进行负载均衡。</p>
<h4 id="准备后端服务"><a href="#准备后端服务" class="headerlink" title="准备后端服务"></a>准备后端服务</h4><p>在RealServer-Nginx1、RealServer-Nginx2两台服务上启动后端服务，具体操作参考前面的环境准备。<strong>确保各个服务端口可用正常</strong>。</p>
<h3 id="准备Keepalived"><a href="#准备Keepalived" class="headerlink" title="准备Keepalived"></a>准备Keepalived</h3><p>在两台LVS服务上安装Keepalived 2.0.18版本</p>
<h4 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y openssl-devel popt-devel libnl-devel kernel-devel gcc</span><br></pre></td></tr></table></figure>



<h4 id="安装Keepalived"><a href="#安装Keepalived" class="headerlink" title="安装Keepalived"></a>安装Keepalived</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">wget https://www.keepalived.org/software/keepalived-2.0.18.tar.gz</span><br><span class="line">tar -xvzf keepalived-2.0.18.tar.gz</span><br><span class="line">cd keepalived-2.0.18 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装到/usr/local/keepalived目录</span></span><br><span class="line">./configure --prefix=/usr/local/keepalived --sysconf=/etc  </span><br><span class="line"></span><br><span class="line">sudo make &amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>安装成功后，配置放在&#x2F;etc&#x2F;keepalived&#x2F;目录中。</p>
<h3 id="LVS高可用配置"><a href="#LVS高可用配置" class="headerlink" title="LVS高可用配置"></a>LVS高可用配置</h3><h4 id="LVS-Master配置"><a href="#LVS-Master配置" class="headerlink" title="LVS-Master配置"></a>LVS-Master配置</h4><p>文件内容，参考课件资料keepalived-lvs-master.conf</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局段，故障通知邮件配置</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@along.com</span><br><span class="line">   smtp_server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span></span><br><span class="line">   smtp_connect_timeout <span class="number">30</span></span><br><span class="line">   router_id keepalived_lvs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置虚拟路由器的实例段，VI_1是自定义的实例名称，可以有多个实例段</span></span><br><span class="line"><span class="comment"># VI_1是自定义的实例名称</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    <span class="comment">#初始状态，MASTER|BACKUP</span></span><br><span class="line">    <span class="keyword">state</span> MASTER</span><br><span class="line">    <span class="comment">#通告选举所用端口</span></span><br><span class="line">    interface enp0s3</span><br><span class="line">    <span class="comment">#虚拟路由的ID号（一般不可大于255）</span></span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    <span class="comment">#优先级信息 #备节点必须更低</span></span><br><span class="line">    priority <span class="number">100</span></span><br><span class="line">    <span class="comment">#VRRP通告间隔，秒</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    <span class="comment">#vip</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span>.<span class="number">120.200</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置一个virtual server段</span></span><br><span class="line">virtual_server <span class="number">192.168</span>.<span class="number">120.200</span> <span class="number">80</span> &#123;</span><br><span class="line">    <span class="comment"># service polling的delay时间，即检查realserver状态的间隔时间</span></span><br><span class="line">    <span class="comment"># 作为测试改为0，默认6</span></span><br><span class="line">    delay_loop <span class="number">0</span></span><br><span class="line">    <span class="comment">#LVS调度算法：rr|wrr|lc|wlc|lblc|sh|dh</span></span><br><span class="line">    lb_algo rr</span><br><span class="line">    <span class="comment">#LVS集群模式：NAT|DR|TUN</span></span><br><span class="line">    lb_kind DR</span><br><span class="line">    <span class="comment">#会话保持时间（持久连接，秒），即以用户在600秒内被分配到同一个后端realserver</span></span><br><span class="line">    <span class="comment">#作为测试改为0</span></span><br><span class="line">    persistence_timeout <span class="number">0</span></span><br><span class="line">    <span class="comment">#健康检查用的是TCP还是UDP</span></span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    <span class="comment"># real server设置段</span></span><br><span class="line">    <span class="comment"># 后端真实节点主机的权重等设置</span></span><br><span class="line">    real_server <span class="number">192.168</span>.<span class="number">120.120</span> <span class="number">80</span> &#123;</span><br><span class="line">        <span class="comment">#weight 1  #给每台的权重，rr无效</span></span><br><span class="line">        <span class="comment">#http服务</span></span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#连接超时时间</span></span><br><span class="line">            connect_timeout <span class="number">3</span></span><br><span class="line">            <span class="comment">#重连次数</span></span><br><span class="line">            retry <span class="number">3</span></span><br><span class="line">            <span class="comment">#重连间隔</span></span><br><span class="line">            delay_before_retry <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server <span class="number">192.168</span>.<span class="number">120.124</span> <span class="number">80</span> &#123;</span><br><span class="line">        <span class="comment">#weight 2</span></span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">              path /</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout <span class="number">3</span></span><br><span class="line">            retry <span class="number">3</span></span><br><span class="line">            delay_before_retry <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LVS-Backup配置"><a href="#LVS-Backup配置" class="headerlink" title="LVS-Backup配置"></a>LVS-Backup配置</h4><p>文件内容，参考课件资料keepalived-lvs-backup.conf</p>
<p>参考LVS-Master配置，修改vrrp_instance VI_1部分的内容，state、priority两个地方。其他的保持不变。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置虚拟路由器的实例段，VI_1是自定义的实例名称，可以有多个实例段</span></span><br><span class="line"><span class="comment"># VI_1是自定义的实例名称</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    <span class="comment">#初始状态，MASTER|BACKUP</span></span><br><span class="line">    <span class="keyword">state</span> BACKUP</span><br><span class="line">    <span class="comment">#通告选举所用端口</span></span><br><span class="line">    interface enp0s3</span><br><span class="line">    <span class="comment">#虚拟路由的ID号（一般不可大于255）</span></span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    <span class="comment">#优先级信息 #备节点必须更低</span></span><br><span class="line">    priority <span class="number">90</span></span><br><span class="line">    <span class="comment">#VRRP通告间隔，秒</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    <span class="comment">#vip</span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span>.<span class="number">120.200</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="启动配置"><a href="#启动配置" class="headerlink" title="启动配置"></a>启动配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master主机</span></span><br><span class="line">sudo /usr/local/keepalived/sbin/keepalived -f /etc/keepalived/keepalived-lvs-master.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动backup备机</span></span><br><span class="line">sudo /usr/local/keepalived/sbin/keepalived -f /etc/keepalived/keepalived-lvs-backup.conf</span><br></pre></td></tr></table></figure>



<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>关闭master，服务是否仍然可用？</p>
<h3 id="Nginx高可用配置"><a href="#Nginx高可用配置" class="headerlink" title="Nginx高可用配置"></a>Nginx高可用配置</h3><h4 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h4><p>共需要两台linux centos服务器，一台LVS，两台RealServer，<strong>端口号必须保持一致，设为80</strong>，所以需要3台服务器。</p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>IP</th>
<th>端口</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LVS(Nginx)-Master</td>
<td>VIP 192.168.120.200<br>RIP 192.168.120.58</td>
<td>80</td>
<td>运行LVS均衡调度，对外提供虚拟IP访问</td>
</tr>
<tr>
<td>LVS(Nginx)-Backup</td>
<td>192.168.120.83</td>
<td>80</td>
<td>运行nginx及tomcat服务，作为真实服务1</td>
</tr>
</tbody></table>
<p>Keepalived不仅仅保证LVS高可用，也能保证其他应用高可用，比如tomcat、Nginx、甚至RPC服务。</p>
<p>我们需要三份配置文件（一个nginx_monitor监控脚本，主备LVS各一份keepalived配置）</p>
<h4 id="Nginx监控脚本"><a href="#Nginx监控脚本" class="headerlink" title="Nginx监控脚本"></a>Nginx监控脚本</h4><p>编辑nginx_monitor.sh文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/keepalived/nginx_monitor.sh</span><br></pre></td></tr></table></figure>

<p>脚本内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">shell脚本监控：如果程序的进程存在，则认为没有问题</span></span><br><span class="line">if [ &quot;$(ps -ef | grep &quot;nginx&quot;| grep -v grep| grep -v keepalived )&quot; == &quot;&quot; ]</span><br><span class="line">  then</span><br><span class="line">    # 输出日志</span><br><span class="line">    echo &quot;nginx ############# app down &quot; &gt;&gt; /var/log/messages</span><br><span class="line">    exit 1</span><br><span class="line">  else</span><br><span class="line">    # 一切正常</span><br><span class="line">	exit 0</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>执行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建nginx monitor 脚本，并赋予可执行权限</span></span><br><span class="line">sudo chmod +x /etc/keepalived/nginx_monitor.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试一下脚本能不能执行</span></span><br><span class="line">sh /etc/keepalived/nginx_monitor.sh </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没报错即表示为成功</span></span><br></pre></td></tr></table></figure>



<h4 id="Keepalived配置"><a href="#Keepalived配置" class="headerlink" title="Keepalived配置"></a>Keepalived配置</h4><p><strong>主配置</strong> &#x2F;etc&#x2F;keepalived&#x2F;keepalived-nginx-master.conf</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个名为monitor的脚本</span></span><br><span class="line">vrrp_script monitor &#123;</span><br><span class="line">     <span class="comment"># 监控脚本存放地址</span></span><br><span class="line">	 script <span class="string">&quot;/etc/keepalived/nginx_monitor.sh&quot;</span></span><br><span class="line">	 <span class="comment"># 每隔1秒执行一次</span></span><br><span class="line">	 interval <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个vrrp示例</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	<span class="keyword">state</span> MASTER    <span class="comment">#(主机为MASTER，备用机为BACKUP)</span></span><br><span class="line">	interface enp0s3  <span class="comment">#(HA监测网卡接口)</span></span><br><span class="line"></span><br><span class="line">	virtual_router_id <span class="number">61</span> <span class="comment">#(主、备机的virtual_router_id必须相同，不大于255)</span></span><br><span class="line">	priority <span class="number">90</span> <span class="comment">#(主、备机取不同的优先级，主机值较大，备份机值较小,值越大优先级越高)</span></span><br><span class="line">	advert_int <span class="number">1</span> <span class="comment">#(VRRP Multicast广播周期秒数)</span></span><br><span class="line"></span><br><span class="line">	track_script &#123;</span><br><span class="line">		monitor <span class="comment">#(监控脚本名称)</span></span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">            <span class="number">192.168</span>.<span class="number">120.200</span> <span class="comment">#(VRRP HA虚拟IP)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>备份配置</strong> &#x2F;etc&#x2F;keepalived&#x2F;keepalived-nginx-backup.conf</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个名为monitor的脚本</span></span><br><span class="line">vrrp_script monitor &#123;</span><br><span class="line">     <span class="comment"># 监控nginx的脚本存放地址</span></span><br><span class="line">	 script <span class="string">&quot;/etc/keepalived/nginx_monitor.sh&quot;</span></span><br><span class="line">	 <span class="comment"># 每隔1秒执行一次</span></span><br><span class="line">	 interval <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个vrrp示例</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	<span class="keyword">state</span> BACKUP    <span class="comment">#(主机为MASTER，备用机为BACKUP)</span></span><br><span class="line">	interface enp0s3  <span class="comment">#(HA监测网卡接口)</span></span><br><span class="line"></span><br><span class="line">	virtual_router_id <span class="number">61</span> <span class="comment">#(主、备机的virtual_router_id必须相同)</span></span><br><span class="line">	priority <span class="number">80</span> <span class="comment">#(主、备机取不同的优先级，主机值较大，备份机值较小,值越大优先级越高)</span></span><br><span class="line">	advert_int <span class="number">1</span> <span class="comment">#(VRRP Multicast广播周期秒数)</span></span><br><span class="line"></span><br><span class="line">	track_script &#123;</span><br><span class="line">		monitor <span class="comment">#(监控脚本名称)</span></span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">            <span class="number">192.168</span>.<span class="number">120.200</span> <span class="comment">#(VRRP HA虚拟IP)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># - master主机</span><br><span class="line">keepalived-nginx-master.conf</span><br><span class="line"># - backup备机</span><br><span class="line">keepalived-nginx-backup.conf</span><br></pre></td></tr></table></figure>

<h4 id="启动Keepalived服务"><a href="#启动Keepalived服务" class="headerlink" title="启动Keepalived服务"></a>启动Keepalived服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动master主机</span></span><br><span class="line">/usr/local/keepalived/sbin/keepalived -f /etc/keepalived/keepalived-nginx-master.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动backup备机</span></span><br><span class="line">/usr/local/keepalived/sbin/keepalived -f /etc/keepalived/keepalived-nginx-backup.conf</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>两台keepalived服务间需要通信，关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state #查看默认防火墙状态（关闭后显示notrunning，开启后显示running）</span><br><span class="line">systemctl list-unit-files|grep firewalld.service</span><br><span class="line">systemctl stop firewalld.service #停止firewall</span><br><span class="line">systemctl disable firewalld.service #禁止firewall开机启动</span><br><span class="line"></span><br><span class="line">[root@localhost ~]#systemctl stop firewalld.service</span><br><span class="line">[root@localhost ~]#systemctl disable firewalld.service</span><br><span class="line">启动一个服务：systemctl start firewalld.service</span><br><span class="line">关闭一个服务：systemctl stop firewalld.service</span><br><span class="line">重启一个服务：systemctl restart firewalld.service</span><br><span class="line">显示一个服务的状态：systemctl status firewalld.service</span><br><span class="line">在开机时启用一个服务：systemctl enable firewalld.service</span><br><span class="line">在开机时禁用一个服务：systemctl disable firewalld.service</span><br><span class="line">查看服务是否开机启动：systemctl is-enabled firewalld.service;echo $?</span><br><span class="line">查看已启动的服务列表：systemctl list-unit-files|grep enabled</span><br></pre></td></tr></table></figure>



<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>关闭master nginx服务，服务是否仍然可用，backup服务是否替补上来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep nginx</span><br><span class="line">root      5189     1  0 22:01 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx_lvs_upstream.conf</span><br><span class="line">nginx     5190  5189  0 22:01 ?        00:00:00 nginx: worker process</span><br><span class="line">sudo kill 5189</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/07-01-%E9%AB%98%E5%8F%AF%E7%94%A8Nginx%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/" data-id="clmcxecd6003bu8wahkd29nb8" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/07-00-LVS实现Nginx集群" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/07-00-LVS%E5%AE%9E%E7%8E%B0Nginx%E9%9B%86%E7%BE%A4/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.837Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="LVS简介"><a href="#LVS简介" class="headerlink" title="LVS简介"></a>LVS简介</h1><h2 id="什么是LVS"><a href="#什么是LVS" class="headerlink" title="什么是LVS"></a>什么是LVS</h2><p>LVS（Linux Virtual Server）linux 虚拟服务，由中国人章文嵩创造和开发的linux内核项目。一句话理解：将一堆的linux服务节点虚拟成一台服务器，对外提供相同的ip访问，对内实现各服务器的负载调度。</p>
<p><strong>特点</strong></p>
<ul>
<li>有一个负载调度器—负载均衡</li>
<li>内部结构对客户端透明—封装</li>
<li>无感知的增删服务节点—可伸缩</li>
<li>检测服务健康状态—高可用</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206232127.png"></p>
<p>官网地址： <a target="_blank" rel="noopener" href="http://www.linuxvirtualserver.org/">http://www.linuxvirtualserver.org</a></p>
<h2 id="为什么要用LVS？"><a href="#为什么要用LVS？" class="headerlink" title="为什么要用LVS？"></a>为什么要用LVS？</h2><p><strong>互联网发展需求</strong><br>要求web服务能具有可伸缩性、高可用性、可管理、性价比高这几个特性</p>
<p><strong>服务器面临提升瓶颈</strong><br>升级单台硬件设备显然代价非常大，服务集群化更具可扩展性和成本效益。</p>
<p><strong>构建集群的方法</strong><br>基于DNS，DNS将域名解析为服务器的不同IP地址来将请求分发到不同的服务器，实现集群负载<br>基于客户端，客户端需要值得服务集群信息。<br>基于调度程序，调度程序可以以精细的粒度调度请求（例如每个连接） ，以便在服务器之间实现更好的负载平衡。<br>基于IP</p>
<p>LVS属于基于IP级负载均衡，IP级的开销很小，服务器节点的最大数量可以达到25或高达100</p>
<h2 id="LVS应用框架结构"><a href="#LVS应用框架结构" class="headerlink" title="LVS应用框架结构"></a>LVS应用框架结构</h2><p>在LVS框架中，提供了含有三种IP负载均衡技术的IP虚拟服务器软件IPVS，基于内容请求分发的内核Layer-7交换机KTCPVS和集群管理软件。再上层则是集群管理、网络服务、电子商务应用。</p>
<p>IP级负载均衡—IPVS<br>应用级负载均衡—KTCPVS</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206232616.png"></p>
<h2 id="LVS如何工作？"><a href="#LVS如何工作？" class="headerlink" title="LVS如何工作？"></a>LVS如何工作？</h2><p>第四层负载均衡IPVS</p>
<p>IPVS (IP Virtual Server) 在Linux内核中实现传输层负载平衡，即所谓的第4层交换。在主机上运行的IPVS充当真实服务器集群前端的负载均衡器，它可以将对基于TCP &#x2F; UDP的服务的请求定向到真实服务器，并使真实服务器的服务在虚拟服务上显示为虚拟服务。单个IP地址。LinuxDirector中共有三种IP负载均衡技术（数据包转发方法）。它们是通过<strong>NAT</strong>的虚拟服务器、通过<strong>IP隧道</strong>的虚拟服务器、通过<strong>直接路由</strong>的虚拟服务器。</p>
<p>第七层负载均衡KTCPVS</p>
<p>由于用户空间TCP Gateway的开销太大，我们提出在操作系统的内核中实现Layer-7交换方法，来避免用户空间与核心空间的切换和内存复制的开销。在Linux操作系统的内核中，我们实现了Layer-7交换，称之为KTCPVS（Kernel TCP Virtual Server）。目前，KTCPVS已经能对HTTP请求进行基于内容的调度，但它<strong>还不很成熟</strong>，在其调度算法和各种协议的功能支持等方面，有大量的工作需要做。</p>
<h3 id="IPVS-NAT"><a href="#IPVS-NAT" class="headerlink" title="IPVS - NAT"></a>IPVS - NAT</h3><p>NAT —（Network Address Translation网络地址转换）。将IP地址从一个组映射到另一个组的功能，<strong>易于设置</strong>。负载均衡器可能是服务器数量超过20的整个系统的瓶颈，因为请求数据包和响应数据包都需要由负载均衡器重写。</p>
<p>通过NAT的虚拟服务器的优点是真实服务器可以运行任何支持TCP&#x2F;IP协议的操作系统，真实服务器可以使用私有Internet地址，并且负载均衡器只需要IP地址。</p>
<p>缺点是通过NAT的虚拟服务器的可扩展性是有限的。当服务器节点（通用PC服务器）的数量增加到大约20或更多时，负载平衡器可能是整个系统的瓶颈，因为请求包和响应包都需要由负载平衡器重写。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206233005.png"></p>
<h3 id="IPVS-IP-TUN"><a href="#IPVS-IP-TUN" class="headerlink" title="IPVS - IP TUN"></a>IPVS - IP TUN</h3><p>IP TUN — IP（tunnel 隧道）。将发往一个IP地址的数据报包装并重定向到另一个IP地址。是<strong>最具扩展性</strong>的。</p>
<p>TUN模式是通过ip隧道技术减轻lvs调度服务器的压力，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大，负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量。</p>
<p>相比NAT性能要高的多，比DR模式的优点是不限制负载均衡器与RS在一个物理段上。</p>
<p><strong>缺点</strong>，需要所有的服务器（lvs、RS）支持”IP Tunneling”(IP Encapsulation)协议</p>
<p><strong>优点</strong>，由于服务器通过使用IP隧道相互连接，负载均衡器和真实服务器可以驻留在不同的LAN甚至WAN上。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206233236.png"></p>
<h3 id="IPVS-DR"><a href="#IPVS-DR" class="headerlink" title="IPVS - DR"></a>IPVS - DR</h3><p>DR —（direct route 直接路由）虚拟IP地址由真实服务器和负载均衡器共享。负载均衡器的接口也配置了虚拟IP地址，用于接受请求数据包，并直接将数据包路由到选定的服务器。所有真实服务器的<strong>非arp别名</strong>接口都配置了虚拟IP地址，或者将发往虚拟IP地址的数据包重定向到本地套接字，以便真实服务器可以在本地处理数据包。</p>
<p>具有<strong>最佳性能</strong>。VS &#x2F; DR使用MAC欺骗技术，因此它要求负载均衡器的NIC和真实服务器的NIC之一必须位于同一IP网段和物理段中。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206233329.png"></p>
<h1 id="LVS负载策略分析"><a href="#LVS负载策略分析" class="headerlink" title="LVS负载策略分析"></a>LVS负载策略分析</h1><h2 id="LVS负载策略"><a href="#LVS负载策略" class="headerlink" title="LVS负载策略"></a>LVS负载策略</h2><p><strong>轮询（Round Robin）</strong><br>        调度器通过”轮询”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</p>
<p><strong>加权轮询（Weighted Round Robin）</strong><br>        调度器通过”加权轮询”调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
<p><strong>最少连接（Least Connections）</strong><br>        调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</p>
<p><strong>加权最少链接（Weighted Least Connections）</strong><br>        在集群系统中的服务器性能差异较大的情况下，调度器采用”加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</p>
<p><strong>基于局部性的最少链接（Locality-Based Least Connections）</strong><br>        针对目标IP地址的负载均衡，主要用于Cache集群系统。根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少连接”的原则选出一个可用的服务器，将请求发送到该服务器。 </p>
<p><strong>带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）</strong><br>        与LBLC算法类似，不同的是它维护一个从目标IP地址到一组服务器的映射，LBLC算法维护一个从目标IP地址到一台服务器的映射。根据请求的目标IP地址找出该目标IP地址对应的服务器组，按“最少连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按”最少连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。</p>
<p><strong>目标地址散列（Destination Hashing）</strong><br>        “目标地址散列”调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p>
<p><strong>源地址散列（Source Hashing）</strong><br>        “源地址散列”调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p>
<h2 id="LVS实现Nginx负载均衡"><a href="#LVS实现Nginx负载均衡" class="headerlink" title="LVS实现Nginx负载均衡"></a>LVS实现Nginx负载均衡</h2><p>《高可用Nginx集群安装搭建手册》</p>
<h1 id="基于Keepalived实现LVS高可用"><a href="#基于Keepalived实现LVS高可用" class="headerlink" title="基于Keepalived实现LVS高可用"></a>基于Keepalived实现LVS高可用</h1><h2 id="什么是Keepalived？"><a href="#什么是Keepalived？" class="headerlink" title="什么是Keepalived？"></a>什么是Keepalived？</h2><p>Keepalived是一款为Linux系统、基于Linux的基础架构，提供<strong>负载平衡</strong>和<strong>高可用性</strong>的网络路由软件。由C语言编写，简单而强大。一句话理解，类似于heartbeat，用来防止单点故障的软件。</p>
<p><strong>负载平衡</strong>，通过LVS的IPVS内核模块，实现第四层负载均衡。</p>
<p><strong>高可用性</strong>，通过虚拟冗余路由协议（VRRP），实现了动态自适应地管理负载平衡的服务器池。</p>
<p>Keepalived可以独立使用，也可以一起使用提供弹性基础架构</p>
<p>Keepalived提供两个主要功能： </p>
<ul>
<li>LVS系统的健康检查</li>
<li>实现VRRPv2堆栈以处理负载均衡器故障转移</li>
</ul>
<p>官网地址： <a target="_blank" rel="noopener" href="https://www.keepalived.org/">https://www.keepalived.org</a></p>
<h2 id="Keepalived的设计"><a href="#Keepalived的设计" class="headerlink" title="Keepalived的设计"></a>Keepalived的设计</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Keepalived有三个不同的进程，一个父进程，两个子进程</span><br><span class="line">PID 111 Keepalived &lt;--父进程负责fork、监控子进程</span><br><span class="line">    112 \_ Keepalived &lt;-- VRRP 子进程</span><br><span class="line">    113 \_ Keepalived &lt;-- Healthchecking 子进程</span><br></pre></td></tr></table></figure>

<p>子进程都有自己的I&#x2F;O多路复用调度器，这样可以优化VRRP调度抖动，VRRP调度比健康检查器更敏感关键。这样拆分最小化了健康检查外部库的使用，并将其自身操作最小化到空闲主循环，以避免由自身引起的故 障。</p>
<p>父进程监视框架称为看门狗。每个子进程打开一个接受unix域套接字，然后在守护进程引导时，父进程连接到那些unix域套接字并向子进程发送周期性（5s）hello数据包。如果父进程无法向远程连接的unix域套接字发送hello数据包，则只需重启子进程。</p>
<p>这样的设计确保Keepalived的健壮性和稳定性，另外两个好处：</p>
<ol>
<li>父进程发给远程连接的hello数据包是通过子进程I&#x2F;O多路复用器调度程序完成的，可以检测子进程调度框架中的deadloop</li>
<li>通过使用sysV信号来检测死亡的子进程</li>
</ol>
<h2 id="Keepalived的结构"><a href="#Keepalived的结构" class="headerlink" title="Keepalived的结构"></a>Keepalived的结构</h2><p>Keepalived由控制平面、IO多路复用调度器、内存管理、核心组件构成。核心组件中包含了前面提到的三个进程，父进程WatchDog程序、子进程检查程序、子进程VRRP协议栈程序。</p>
<p><strong>WatchDog</strong></p>
<p>派生、监控(VRRP &amp; Healthchecking)子进程。</p>
<p><strong>检查程序</strong></p>
<p>负责realserver的运行状况检查。检查器测试realserver是否还活着，从而决定，自动从LVS拓扑中删除或添加realserver。</p>
<p><strong>VRRP协议栈</strong></p>
<p>VRRP（Virtual Router Redundancy Protocol 虚拟路由器冗余协议）专门用于处理一组路由器组中路由器故障接管工作。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206235500.png"></p>
<h2 id="健康检查—Checkers"><a href="#健康检查—Checkers" class="headerlink" title="健康检查—Checkers"></a>健康检查—Checkers</h2><p>健康检查注册在全局调度框架中，有以下类型的运行状况检查：</p>
<p><strong>TCP_CHECK</strong><br>在第4层工作，使用无阻塞&#x2F;超时的TCP连接，如果远程服务器未回复此请求（超时），则测试错误，并从服务器池中删除该服务器。</p>
<p><strong>HTTP_GET</strong><br>在第5层工作，对指定的URL执行HTTP GET。使用MD5算法对HTTP GET结果进行摘要, 与期望值不匹配，则测试不通过，并将服务器从服务器池中删除。</p>
<p><strong>SSL_GET</strong><br>与HTTP_GET相同，但使用到远程Web服务器的SSL连接。</p>
<p><strong>MISC_CHECK</strong><br>通过System call调用自定义的脚本作为运行状况检查器运行，结果必须为0或1。脚用来测试内部应用程序的理想方法。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206235605.png"></p>
<h2 id="高可用特性—VRRP-Stack"><a href="#高可用特性—VRRP-Stack" class="headerlink" title="高可用特性—VRRP Stack"></a>高可用特性—VRRP Stack</h2><p>在设计网络的时候必须考虑冗余容灾，包括线路冗余，设备冗余等，防止网络存在单点故障，在路由器或三层交换机处实现冗余就显得尤为重要。 在网络里面VRRP协议就是来做这事的，Keepalived运用VRRP协议来实现高可用性。</p>
<p>VRRP是用来实现路由器冗余的协议，VRRP协议将多台路由器设备虚拟成一个设备，对外提供虚拟路由器IP。路由器组内部，路由器分为Master、Backup两种状态，Master是一台对外提供服务的IP的路由器，或者是通过算法选举产生的，其他的状态为BACKUP 。</p>
<p>MASTER路由器，实现针对虚拟路由器IP的各种网络功能，如ARP请求，ICMP，以及数据的转发等。</p>
<p>BACKUP状态路由器，只接收MASTER的VRRP状态信息，不执行对外的网络功能。当Master失效时，BACKUP将接管原先MASTER的网络功能。</p>
<p>由于设计和健壮性的原因，这个模块已完全集成在Keepalived守护程序中</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221206235803.png"></p>
<h2 id="安装Keepalived"><a href="#安装Keepalived" class="headerlink" title="安装Keepalived"></a>安装Keepalived</h2><p>二进制安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived</span><br></pre></td></tr></table></figure>

<p>源码编译安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 安装依赖</span><br><span class="line">sudo yum install -y curl gcc openssl-devel libnl3-devel net-snmp-devel</span><br><span class="line"># 下载解压</span><br><span class="line">sudo wget https://github.com/acassen/keepalived/archive/v2.0.18.tar.gz</span><br><span class="line">tar -xvf keepalived.tar.gz</span><br><span class="line">cd keepalived </span><br><span class="line"># 编译安装，安装到/usr/local/keepalived目录</span><br><span class="line">./configure --prefix=/usr/local/keepalived --sysconf=/etc </span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="通过Keepalived保证LVS高可用"><a href="#通过Keepalived保证LVS高可用" class="headerlink" title="通过Keepalived保证LVS高可用"></a>通过Keepalived保证LVS高可用</h2><p>参考《高可用Nginx集群安装搭建手册》</p>
<h1 id="LVS和Nginx异同分析"><a href="#LVS和Nginx异同分析" class="headerlink" title="LVS和Nginx异同分析"></a>LVS和Nginx异同分析</h1><p><strong>LVS后面的服务一定要接Nginx服务吗？能直接接Tomcat吗？能直接接RPC服务吗？为什么不这样做呢？</strong></p>
<p>LVS基于网络模型的第四层负载均衡，即传输层。<br>Nginx基于网络模型的第七层负载均衡，及应用用层。<br>两个都可以用来做Web服务器的负载均衡<br>传输层的LVS比Nginx能够处理的并发更高，性能更强大<br>应用层的Nginx则比LVS的功能特性更加丰富、更加成熟稳定</p>
<p><strong>Nginx VS LVS</strong><br>都有第四层、第七层负载均衡的机制</p>
<ol>
<li>Nginx在第七层更加成熟稳定，功能更加丰富，大量的第三方模块和插件。LVS比拟不了，LVS应用层的负载均衡还不够成熟。</li>
<li>LVS处于第四层负载均衡，并且集成到了Linux内核中，基于IP级别的负载均衡，又Nginx 四层负载均衡无法比拟。在内核中，效率更加的高效。</li>
</ol>
<p><strong>LVS只能够Nginx做负载均衡吗</strong><br>LVS 第四层内核，意味着可以对所有的应用服务做负载均衡</p>
<p><strong>Keepalived与LVS的区别</strong><br>他们是一个功能包含关系，Keepalived依赖了LVS的IPVS模块。<br>Keepalived除了能进行负载均衡、还能提供解决高可用特性，单点故障的问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/07-00-LVS%E5%AE%9E%E7%8E%B0Nginx%E9%9B%86%E7%BE%A4/" data-id="clmcxeccx0030u8wa6bs8ahfh" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/06-01-Nginx常用插件安装" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/06-01-Nginx%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.829Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Nginx实用插件"><a href="#Nginx实用插件" class="headerlink" title="Nginx实用插件"></a>Nginx实用插件</h1><h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><p>由于插件的兼容关系，请使用nginx-1.4.7这个版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载nginx-1.4.7</span></span><br><span class="line">wget https://nginx.org/download/nginx-1.4.7.tar.gz</span><br><span class="line">tar -xvzf nginx-1.4.7.tar.gz</span><br><span class="line">sudo mv nginx-1.4.7 /usr/local/</span><br></pre></td></tr></table></figure>



<h2 id="健康检查插件"><a href="#健康检查插件" class="headerlink" title="健康检查插件"></a>健康检查插件</h2><p>主动检查内部上游的服健康状态插件，淘宝开源实现<a target="_blank" rel="noopener" href="https://github.com/yaoweibin/nginx_upstream_check_module">nginx_upstream_check_module</a>。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip \</span><br><span class="line">-O nginx_upstream_check_module-master.zip</span><br><span class="line">unzip nginx_upstream_check_module-master.zip</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx-1.4.7</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">补丁包</span></span><br><span class="line">sudo patch -p1 &lt; /home/wesley/nginx_upstream_check_module-master/check_1.2.6+.patch</span><br><span class="line"></span><br><span class="line">sudo ./configure \</span><br><span class="line">    --prefix=/usr/local/nginx1.4 \</span><br><span class="line">    --sbin-path=/usr/local/nginx1.4/nginx \</span><br><span class="line">    --conf-path=/usr/local/nginx1.4/conf/nginx.conf \</span><br><span class="line">    --error-log-path=/usr/local/nginx1.4/logs/error.log \</span><br><span class="line">    --pid-path=/usr/local/nginx1.4/pid/nginx.pid \</span><br><span class="line">    --add-module=/home/wesley/echo-nginx-module-0.61 \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --add-module=/home/wesley/nginx_upstream_check_module-master</span><br><span class="line">    </span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置Nginx配置文件内容如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream cluster &#123;</span><br><span class="line">        <span class="comment"># simple round-robin</span></span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">        check interval=<span class="number">5000</span> rise=<span class="number">1</span> fall=<span class="number">3</span> timeout=<span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span></span><br><span class="line">        <span class="comment">#check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</span></span><br><span class="line">        <span class="comment">#check_http_expect_alive http_2xx http_3xx;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="regexp">//</span>cluster;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line">            access_log   off;</span><br><span class="line">            allow <span class="number">192.168</span>.<span class="number">120.0</span>/<span class="number">255</span>;</span><br><span class="line">            deny all;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>指令介绍</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 为上游服务添加健康检查，以及相关配置</span><br><span class="line">check</span><br><span class="line">    syntax: *check interval=milliseconds [fall=count] [rise=count]</span><br><span class="line">    [timeout=milliseconds] [default_down=true|false]</span><br><span class="line">    [type=tcp|http|ssl_hello|mysql|ajp|fastcgi]*</span><br><span class="line">    default: *none, if parameters omitted, default parameters are</span><br><span class="line">    interval=30000 fall=5 rise=2 timeout=1000 default_down=true type=tcp*</span><br><span class="line"></span><br><span class="line"># 设置检查上游服务的访问URI</span><br><span class="line">check_http_send</span><br><span class="line">    syntax: *check_http_send http_packet*</span><br><span class="line">    default: *&quot;GET / HTTP/1.0\r\n\r\n&quot;*</span><br><span class="line"></span><br><span class="line"># 展示服务的健康检查状态</span><br><span class="line">check_status</span><br><span class="line">    syntax: *check_status [html|csv|json]*</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>更多的参考github的内容。</p>
<p>启动Nginx服务</p>
<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://hostname/server/ip</span><br></pre></td></tr></table></figure>

<p>关掉8080端口服务，验证是否还能将请求打到8080上面。</p>
<h2 id="动态更新后端服务插件"><a href="#动态更新后端服务插件" class="headerlink" title="动态更新后端服务插件"></a>动态更新后端服务插件</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>首先安装 nginx 动态 upstream 配置模块<a target="_blank" rel="noopener" href="https://github.com/yzprofile/ngx_http_dyups_module">ngx_http_dyups_module</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">wget https://github.com/yzprofile/ngx_http_dyups_module/archive/v0.2.9.tar.gz \</span><br><span class="line">-O ngx_http_dyups_module-0.2.9.tar.gz</span><br><span class="line">tar -xvzf ngx_http_dyups_module-0.2.9.tar.gz</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx-1.4.7</span><br><span class="line">sudo ./configure \</span><br><span class="line">    --prefix=/usr/local/nginx1.5 \</span><br><span class="line">    --sbin-path=/usr/local/nginx1.5/nginx \</span><br><span class="line">    --conf-path=/usr/local/nginx1.5/conf/nginx.conf \</span><br><span class="line">    --error-log-path=/usr/local/nginx1.5/logs/error.log \</span><br><span class="line">    --pid-path=/usr/local/nginx1.5/pid/nginx.pid \</span><br><span class="line">    --add-module=/home/wesley/echo-nginx-module-0.61 \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --add-module=/home/wesley/nginx_upstream_check_module-master \</span><br><span class="line">    --add-module=/home/wesley/ngx_http_dyups_module-0.2.9</span><br><span class="line"></span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>修改nginx的配置文件</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">4</span>;</span><br><span class="line">worker_rlimit_nofile <span class="number">65535</span>;</span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">	include upstream.conf;</span><br><span class="line">	<span class="comment"># 默认主机</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			proxy_pass http:<span class="regexp">//</span>$host;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 动态配置 upstream 的接口站点</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">81</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			dyups_interface;	<span class="comment"># 这个指令表示这边是接口站点</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># upstream 后面的 realserver,2 台 801，,802</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">801</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">200</span> <span class="string">&quot;801&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">802</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">200</span> <span class="string">&quot;802&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>upstream.conf 配置</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream server8<span class="number">0</span> &#123;</span><br><span class="line">	server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">801</span>;</span><br><span class="line">&#125;</span><br><span class="line">upstream server81 &#123;</span><br><span class="line">	server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">802</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>指令介绍</strong></p>
<p>语法: dyups_interface<br>默认: none<br>配置段: location<br>启用配置 upstream 的接口</p>
<p>语法: dyups_read_msg_timeout time<br>默认: 1s<br>配置段: main<br>设置从共享内存中读取 commands 的超时时间，默认为 1 秒</p>
<p>语法: dyups_shm_zone_size size<br>默认: 2MB<br>配置段: main<br>设置存储 commands 的共享内存</p>
<p>语法: dyups_upstream_conf path<br>默认: none<br>配置段: main<br>这个指令用来指定 upstream 配置文件的路径,他会在启动的时候加载</p>
<p>语法: dyups_trylock on | off<br>默认: off<br>配置段: main<br>是否启用锁，如果启用了它，同一时刻有人在修改，那么将会返回 409</p>
<h3 id="测试验证-1"><a href="#测试验证-1" class="headerlink" title="测试验证"></a>测试验证</h3><p>增删改查后端服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初次访问，<span class="variable">$host</span>变量设置为dyhost，原有的upstream中没有dyhost</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以访问获得错误信息</span></span><br><span class="line">curl -H &quot;host: dyhost&quot; 127.0.0.1:80</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.3.13&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加/修改 一个upstream列表信息，名字为dyhost</span></span><br><span class="line">curl -d &quot;server 127.0.0.1:8080;server 127.0.0.1:8081;&quot; 127.0.0.1:81/upstream/dyhost</span><br><span class="line">success</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查dyhost列表服务的状态</span></span><br><span class="line">curl -H &quot;host: dyhost&quot; 127.0.0.1:8080</span><br><span class="line">Welcome to balancer！</span><br><span class="line">curl -H &quot;host: dyhost&quot; 127.0.0.1:8081</span><br><span class="line">Welcome to balancer！</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过ngx_http_dyups_module接口查看当前的upstream列表信息</span></span><br><span class="line">curl 127.0.0.1:81/detail</span><br><span class="line">host1</span><br><span class="line">server 127.0.0.1:8088 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br><span class="line"></span><br><span class="line">host2</span><br><span class="line">server 127.0.0.1:8089 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br><span class="line"></span><br><span class="line">dyhost</span><br><span class="line">server 127.0.0.1:8089 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br><span class="line">server 127.0.0.1:8088 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次访问dyhost服务列表信息，成功返回信息</span></span><br><span class="line">curl -H &quot;host: dyhost&quot; 127.0.0.1:80</span><br><span class="line">Welcome to balancer！</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除一个upstream</span></span><br><span class="line">curl -i -X DELETE 127.0.0.1:81/upstream/dyhost</span><br><span class="line">success</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次查看当前后台服务信息</span></span><br><span class="line">curl 127.0.0.1:81/detail</span><br><span class="line">host1</span><br><span class="line">server 127.0.0.1:8088 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br><span class="line"></span><br><span class="line">host2</span><br><span class="line">server 127.0.0.1:8089 weight=1 max_conns=0 max_fails=1 fail_timeout=10 backup=0 down=0</span><br></pre></td></tr></table></figure>

<p>实际使用过程中，可以将$host固定下来，让后通过ngx_http_dyups_module的接口进行修改对应的upstream的列表信息，从而达到动态更新服务列表。</p>
<h2 id="限流插件"><a href="#限流插件" class="headerlink" title="限流插件"></a>限流插件</h2><p><a target="_blank" rel="noopener" href="https://github.com/cfsego/limit_upload_rate">Limit Upload Rate</a>是淘宝开源的限流插件，针对客户端请求速率的限制。已经集成在tengine中。</p>
<h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">wget https://github.com/cfsego/limit_upload_rate/archive/master.zip \</span><br><span class="line">-O limit_upload_rate-master.zip</span><br><span class="line">unzip limit_upload_rate-master.zip</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx-1.4.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx中使用limit_upload_rate需要tengine的input body filter的支持</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过path来给nginx打补丁，for-nginx-1.4.4.patch基于nginx 1.4.4，可与nginx 1.5.x一起使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我们这里是nginx 1.4.7，所以选择for-nginx-1.4.4.patch补丁</span></span><br><span class="line">sudo patch -p1 &lt; /home/wesley/limit_upload_rate-master/for-nginx-1.4.4.patch</span><br><span class="line">sudo ./configure \</span><br><span class="line">    --prefix=/usr/local/nginx1.6 \</span><br><span class="line">    --sbin-path=/usr/local/nginx1.6/nginx \</span><br><span class="line">    --conf-path=/usr/local/nginx1.6/conf/nginx.conf \</span><br><span class="line">    --error-log-path=/usr/local/nginx1.6/logs/error.log \</span><br><span class="line">    --pid-path=/usr/local/nginx1.6/pid/nginx.pid \</span><br><span class="line">    --add-module=/home/wesley/echo-nginx-module-0.61 \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --add-module=/home/wesley/nginx_upstream_check_module-0.3.0 \</span><br><span class="line">    --add-module=/home/wesley/ngx_http_dyups_module-0.2.9 \</span><br><span class="line">    --add-module=/home/wesley/limit_upload_rate-master</span><br><span class="line">	</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>



<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由淘宝提供，需要limit_upload_rate的支持。</span></span><br><span class="line"><span class="comment"># 限制客户端上传速率，跟limit_rate用法类似</span></span><br><span class="line"><span class="comment"># 可以放在http, server, location, if in location指令块中</span></span><br><span class="line">limit_upload_rate <span class="number">5</span>k;</span><br><span class="line">limit_upload_rate_after <span class="number">50</span>k;</span><br></pre></td></tr></table></figure>



<h3 id="测验"><a href="#测验" class="headerlink" title="测验"></a>测验</h3><p>通过上传页面检查</p>
<h2 id="黑白名单插件"><a href="#黑白名单插件" class="headerlink" title="黑白名单插件"></a>黑白名单插件</h2><p><strong>该插件很久没有维护了，而且不能正常使用，可以忽略该插件。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/codehunte/ngx_white_black_list">ngx_white_black_list</a> 通过配置文件来指定黑白名单内容。</p>
<p>功能描述：<br>处在黑名单中的 ip 与网络，将无法访问 web 服务。<br>处在白名单中的 ip，访问 web 服务时，将不受 nginx 所有安全模块的限制。<br>支持动态黑名单（需要与 ngx_http_limit_req 配合），需要修改nginx代码这里就不提及了。如有需要，参考给到的ngx_white_black_list链接</p>
<h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/codehunte/ngx_white_black_list/archive/master.zip \</span><br><span class="line">-O ngx_white_black_list-master.zip</span><br><span class="line">unzip ngx_white_black_list-master.zip</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx-1.4.7</span><br><span class="line">sudo ./configure \</span><br><span class="line">    --prefix=/usr/local/nginx1.7 \</span><br><span class="line">    --sbin-path=/usr/local/nginx1.7/nginx \</span><br><span class="line">    --conf-path=/usr/local/nginx1.7/conf/nginx.conf \</span><br><span class="line">    --error-log-path=/usr/local/nginx1.7/logs/error.log \</span><br><span class="line">    --pid-path=/usr/local/nginx1.7/pid/nginx.pid \</span><br><span class="line">    --add-module=/home/wesley/echo-nginx-module-0.61 \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --add-module=/home/wesley/nginx_upstream_check_module-0.3.0 \</span><br><span class="line">    --add-module=/home/wesley/ngx_http_dyups_module-0.2.9 \</span><br><span class="line">    --add-module=/home/wesley/limit_upload_rate-master \</span><br><span class="line">    --add-module=/home/wesley/ngx_white_black_list-master</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">make的时候ngx_white_black_list会有告警，导致编译不通过。修改Makefile文件，忽略告警。</span></span><br><span class="line">sudo vim objs/Makefile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将CFLAGS =  -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Werror -g换成下行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">忽略Makefile中的警告</span></span><br><span class="line">CFLAGS =  -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Wall -g</span><br><span class="line"></span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>



<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a>配置</h3><p>准备黑白名单列表文件，参考资料white.list、black.list、</p>
<p>nginx配置文件内容</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">4</span>;</span><br><span class="line">worker_rlimit_nofile <span class="number">65535</span>;</span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># 定义 黑名单或白名单文件 空间key</span></span><br><span class="line">	<span class="comment"># 只能在http指令块中</span></span><br><span class="line">	<span class="comment"># white_black_list_conf可以配置多个 只需 zone=value 其中的value不同就可</span></span><br><span class="line">	white_black_list_conf conf/white.list zone=white:<span class="number">2</span>m;</span><br><span class="line">	white_black_list_conf conf/black.list zone=black:<span class="number">4</span>m;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 启用黑白名单，on/off，启用/关闭。</span></span><br><span class="line">	<span class="comment"># 在http、server、location下使用, 功能默认是关闭</span></span><br><span class="line">	<span class="comment"># 配置在对应的指令块中，对应的指令块上下文生效</span></span><br><span class="line">	white_list white on; <span class="comment">#白名单  white 在整个http&#123;&#125;中都开启</span></span><br><span class="line">	black_list black on; <span class="comment">#黑名单  black 在整个http&#123;&#125;中都开启</span></span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		root /data/www/;</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 黑白名单配置调整接口，通过它可以调整配置内容</span></span><br><span class="line">		location /sec_config &#123;</span><br><span class="line">			sec_config on;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测验-1"><a href="#测验-1" class="headerlink" title="测验"></a>测验</h3><p>查看黑白名单定义内容</p>
<p>访问<a target="_blank" rel="noopener" href="http://xxx/sec_config">http://xxx/sec_config</a></p>
<p>查看zone_name 为white 的   list_path中的具体内容</p>
<p><a target="_blank" rel="noopener" href="http://xxx/sec_config?zone_name=white">http://xxx/sec_config?zone_name=white</a></p>
<p>向 zone_name 为white 中增加192.168.141.23</p>
<p><a target="_blank" rel="noopener" href="http://xxx/sec_config?zone_name=white&add_item=192.168.141.23">http://xxx/sec_config?zone_name=white&amp;add_item=192.168.141.23</a></p>
<p>在 zone_name 为white 中删除192.168.141.23</p>
<p><a target="_blank" rel="noopener" href="http://xxx/sec_config?zone_name=white&delete_item=192.168.141.23">http://xxx/sec_config?zone_name=white&amp;delete_item=192.168.141.23</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/06-01-Nginx%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/" data-id="clmcxeccu002zu8wa8sdberyr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/06-00-Nginx常用插件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/06-00-Nginx%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.822Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="代理服务故障处理"><a href="#代理服务故障处理" class="headerlink" title="代理服务故障处理"></a>代理服务故障处理</h1><h2 id="被动健康检查"><a href="#被动健康检查" class="headerlink" title="被动健康检查"></a>被动健康检查</h2><p>ngx_http_upstream_module，可以做到基本的健康检查。</p>
<p>upstream指令块中的server子指令参数：max_fails、fail_timeout</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">	server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">	server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>max_fails&#x3D;2的意思是设定Nginx与服务器通信的尝试失败的次数。在fail_timeout参数定义的时间段内，如果失败的次数达到此值，Nginx就认为服务器不可用。在下一个fail_timeout时间段，服务器不会再被尝试。失败的尝试次数默认是1。设为0就会停止统计尝试次数，认为服务器是一直可用的。</p>
<p>fail_timeout&#x3D;10s是设定服务器被认为不可用的时间段以及统计失败尝试次数的时间段。在这段时间中，服务器失败次数达到指定的尝试次数，服务器就被认为不可用。默认情况下，该超时时间是10秒。</p>
<p>Nginx能不能主动感知服务不可用呢？</p>
<h2 id="主动健康检查"><a href="#主动健康检查" class="headerlink" title="主动健康检查"></a>主动健康检查</h2><p>服务主动健康检查的Nginx插件，nginx_upstream_check_module</p>
<p>nginx 需要添加nginx_upstream_check_module 模块，用于对后端服务器的健康情况检测，如果后端服务器不可用，则把这台服务器移除负载均衡轮循集群，所有的请求不往这台服务器上转发，待这台服务器恢复正常后，再把这台加入到负载均衡集群。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">upstream cluster &#123;</span><br><span class="line">    <span class="comment"># simple round-robin</span></span><br><span class="line">    server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">    server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span>;</span><br><span class="line">    check interval=<span class="number">5000</span> rise=<span class="number">1</span> fall=<span class="number">3</span> timeout=<span class="number">4000</span>;</span><br><span class="line">    <span class="comment">#check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</span></span><br><span class="line">    <span class="comment">#check_http_expect_alive http_2xx http_3xx;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考《Nginx实用插件》操作手册</p>
<p>nginx_health_check.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># http属于主上下文</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  text/html;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置与后端服务器建立连接的超时时间，一般不可能大于75秒</span></span><br><span class="line">    <span class="comment">#proxy_connect_timeout 60s;</span></span><br><span class="line">    <span class="comment">#proxy_read_timeout 1s;</span></span><br><span class="line">    <span class="comment">#proxy_send_timeout 5s;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 故障转移</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream error timeout;</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream_timeout 3s;</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream_tries 1;</span></span><br><span class="line"></span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        <span class="comment"># 被动健康检查</span></span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#check interval=5000 rise=1 fall=3 timeout=4000;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span></span><br><span class="line"></span><br><span class="line">        check interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">        check_http_send <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">        check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># server在http的上下文中 </span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># location在server上下文中</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="regexp">//</span>backend;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line">            access_log off;</span><br><span class="line">            allow all;</span><br><span class="line">            <span class="comment">#deny all;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p><strong>ngx_http_proxy_module模块对故障转移的支持</strong></p>
<p>proxy_next_upstream<br>在尚未向客户端发送任何内容的情况下才能将请求传递给下一个服务器。也就是说，如果在传输响应的过程中发生错误或超时，则无法进行故障转移。一个请求传递给下一个服务时，还可以通过限制重试次数、等待时间。</p>
<p>proxy_next_upstream_timeout<br>限制请求可以传递到下一个服务器的时间。默认为0，表示关闭限制。</p>
<p>proxy_next_upstream_tries<br>限制将请求传递到下一个服务器的可能尝试次数 。默认为0，表示关闭限制。</p>
<p>nginx_next_upstream.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># http属于主上下文</span></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  text/html;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置与后端服务器建立连接的超时时间，一般不可能大于75秒</span></span><br><span class="line">    <span class="comment">#proxy_connect_timeout 60s;</span></span><br><span class="line">    <span class="comment">#proxy_read_timeout 1s;</span></span><br><span class="line">    <span class="comment">#proxy_send_timeout 5s;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 故障转移</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream error timeout;</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream_timeout 3s;</span></span><br><span class="line">    <span class="comment">#proxy_next_upstream_tries 1;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">        server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># server在http的上下文中 </span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment"># location在server上下文中</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="regexp">//</span>backend;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何应对服务雪崩"><a href="#如何应对服务雪崩" class="headerlink" title="如何应对服务雪崩"></a>如何应对服务雪崩</h2><p>Nginx后面有2台上游服务，每台服务负载5000并发，假如第一台挂掉，Nginx将第一台的请求转发给第二台，将第二台打挂，整个服务都不可用了。如果是多台服务，就这样多米诺骨牌效应产生，将全部服务打挂？怎么处理？</p>
<p>proxy_read_timeout<br>定义从代理服务器读取响应的超时。仅在两个连续的读操作之间设置超时，而不是为整个响应的传输。如果代理服务器在此时间内未传输任何内容，则关闭连接。默认60s。</p>
<p>max_conns参数<br>设置upstream中server指令的max_conns参数来进行控制每台服务器能够处理的最大的连接数</p>
<h2 id="动态更新上游服务"><a href="#动态更新上游服务" class="headerlink" title="动态更新上游服务"></a>动态更新上游服务</h2><p>后端服务发生变化，需要调整nginx的upstream列表，而且需要重启nginx，有一种插件可以无需重动nginx，动态更新后端服务地址列表。这个插件就是，ngx_http_dyups_module模块。</p>
<p>安装演示操作，参考《Nginx实用插件》操作手册</p>
<p>这个插件有个问题比较明显，因为数据存放在内存中，nginx 重启之后，配置内容就会清空。</p>
<p>Nginx可以通过Consul+Consul-template来解决（需要Nginx reload）</p>
<p>OpenResty可以通过balancer_by_lua+Consul来解决（无需Nginx reload）</p>
<p>nginx_dyups_upstream.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile <span class="number">65535</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	include upstream.conf;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 默认主机</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			proxy_pass http:<span class="regexp">//s</span>erver8<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 动态配置 upstream 的接口站点</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">81</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			dyups_interface;	<span class="comment"># 这个指令表示这边是接口站点</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># upstream 后面的 realserver,2 台 801，,802</span></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">801</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">200</span> <span class="string">&quot;801&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">802</span>;</span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">200</span> <span class="string">&quot;802&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="高并发限流"><a href="#高并发限流" class="headerlink" title="高并发限流"></a>高并发限流</h1><h2 id="限制请求"><a href="#限制请求" class="headerlink" title="限制请求"></a>限制请求</h2><p>Nginx中可以通过请求限制模块的指令来控制客户端的请求速率。使用“漏桶”算法，限制指定Key的请求处理速率，特别是从一个单一的IP地址的请求的处理速率。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=one:<span class="number">10</span>m rate=<span class="number">1</span>r/s;</span><br><span class="line">    limit_req_zone $server_name zone=preserver:<span class="number">10</span>m rate=<span class="number">10</span>r/s;</span><br><span class="line">    server &#123;</span><br><span class="line">        location /search/ &#123;</span><br><span class="line">            limit_req zone=one burst=<span class="number">5</span>;</span><br><span class="line">            limit_req zone=perserver burst=<span class="number">10</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例，通过定义内存空间块：</p>
<p>限制单个IP平均每秒允许不超过1个请求，突发不超过5个请求</p>
<p>整个虚拟服务，平均每秒不允许超过10个，突发不超过10个请求</p>
<h2 id="限制请求-相关指令"><a href="#限制请求-相关指令" class="headerlink" title="限制请求-相关指令"></a>限制请求-相关指令</h2><table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>limit_req</td>
<td>设置共享内存区域和请求的最大突发大小。如果请求速率超过为区域配置的速率，则延迟其处理，以便以定义的速率处理请求。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止 。</td>
<td>-</td>
</tr>
<tr>
<td>limit_req_dry_run</td>
<td>启用空运行模式。这个模式下，请求处理速率不受限制，但是，在共享存储区中，过多请求的数量照常计算。</td>
<td>on</td>
</tr>
<tr>
<td>limit_req_log_level</td>
<td>为服务器因速率超过或延迟请求处理而拒绝处理请求的情况设置所需的日志记录级别。延迟的记录水平比拒绝的记录水平低一个点;</td>
<td>error</td>
</tr>
<tr>
<td>limit_req_status</td>
<td>设置要响应拒绝的请求而返回的状态代码</td>
<td>503</td>
</tr>
<tr>
<td>limit_req_zone</td>
<td>设置共享内存区域的参数，该区域将保留各种键的状态。特别是，状态存储当前的过多请求数。该key可以包含文本，变量，他们的组合，空键值的请求不计算在内。</td>
<td>-</td>
</tr>
</tbody></table>
<h2 id="限制连接"><a href="#限制连接" class="headerlink" title="限制连接"></a>限制连接</h2><p>Nginx中通过ngx_http_limit_conn_module模块，来限制连接到nginx服务的数量。用于限制每个定义密钥的连接数，特别是来自单个IP地址的连接数。并非所有连接都被计算在内 只有当服务器正在处理请求并且已经读取了整个请求标头时，才会计算连接。</p>
<p>示例，通过定义内存空间块：<br>限制单个IP建立不超过1个连接<br>整个虚拟服务，不允许超过10个连接</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=addr:<span class="number">10</span>m;</span><br><span class="line">    limit_conn_zone $server_name zone = perserver：<span class="number">10</span>m;</span><br><span class="line">        server &#123;</span><br><span class="line">            location /download/ &#123;</span><br><span class="line">                limit_conn addr <span class="number">1</span>;</span><br><span class="line">                limit_conn perserver <span class="number">100</span>;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="限制连接-相关指令"><a href="#限制连接-相关指令" class="headerlink" title="限制连接-相关指令"></a>限制连接-相关指令</h2><table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>limit_conn</td>
<td>设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回 错误 以回复请求。</td>
<td>-</td>
</tr>
<tr>
<td>limit_conn_log_level</td>
<td>为服务器限制连接数的情况设置所需的日志记录级别</td>
<td>error</td>
</tr>
<tr>
<td>limit_conn_status</td>
<td>设置要响应拒绝的请求而返回的状态代码</td>
<td>503</td>
</tr>
<tr>
<td>limit_conn_zone</td>
<td>设置共享内存区域的参数，该区域将保留各种键的状态。特别是，状态包括当前的连接数。该key可以包含文本，变量，他们的组合。具有空键值的请求不计算在内。</td>
<td>-</td>
</tr>
</tbody></table>
<h2 id="限制给客户端的响应速率"><a href="#限制给客户端的响应速率" class="headerlink" title="限制给客户端的响应速率"></a>限制给客户端的响应速率</h2><p>http核心模块中对响应速率限制提供了支持，视频网站，不可能将所有带宽都给一个请求，我们需要限制每个请求的速率</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        location /download/ &#123;</span><br><span class="line">            limit_rate_after <span class="number">500</span>k;</span><br><span class="line">            limit_rate <span class="number">50</span>k; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例，限制响应初始速率50k，后续响应速率限制在500k</p>
<h2 id="针对爬虫限速"><a href="#针对爬虫限速" class="headerlink" title="针对爬虫限速"></a>针对爬虫限速</h2><p><strong>网络爬虫对网站的作用</strong><br>一方面可以给网站带来一定的流量，便于搜索引擎收录，利于用户搜素。<br>另一方面会给服务器带来一定的压力，在网络爬虫对网站内容进行收录时，会引起服务器负载高涨。<br>有没有什么方法既不阻止网络爬虫对网站内容进行收录，同时对其连接数和请求数进行一定的限制呢？</p>
<p><strong>robots.txt 协议</strong></p>
<p>robots.txt文件内容称为爬虫协议，搜索引擎会根据这个文件的内容，来确定它访问权限的范围。它不是命令要求，需要搜索引擎自觉遵守。<br>robots.txt 必须放置在一个站点的根目录下，而且文件名必须全部小写,一词不差。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">robots.txt 写法：</span><br><span class="line">User-agent: * 这里的*代表的所有的搜索引擎种类，*是一个通配符</span><br><span class="line">Allow: <span class="regexp">/cgi-bin/</span> 这里定义是允许爬寻cgi-bin目录下面的目录</span><br><span class="line">Disallow: <span class="regexp">/admin/</span> 这里定义是禁止爬寻 admin 目录下面的内容</span><br><span class="line">Disallow: <span class="regexp">/require/</span> 这里定义是禁止爬寻 <span class="keyword">require</span> 目录下面的内容</span><br></pre></td></tr></table></figure>

<h2 id="针对爬虫限速-Nginx配置"><a href="#针对爬虫限速-Nginx配置" class="headerlink" title="针对爬虫限速-Nginx配置"></a>针对爬虫限速-Nginx配置</h2><p>Map是nginx模块中用来映射变量的 根据每次请求$http_user_agent的内容进行子指令进行匹配，如果匹配成功，则将子指令右侧的值赋值给$agent变量。匹配不到则给默认值。示例中表示，根据客户端的操作系统浏览器工具等信息，匹配是否为curl、apachebench、spider、 bot、slurp也就是爬虫程序相关的名称，这里采用了原有内容作为$agent的值。</p>
<p>Limit_conn_zone、limit_req_zone则采用$agent做为key来存储限制速率。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span> $http_user_agent $agent &#123;</span><br><span class="line">    default <span class="string">&quot;&quot;</span>;</span><br><span class="line">    ~curl $http_user_agent;</span><br><span class="line">    ~*apachebench $http_user_agent;</span><br><span class="line">    ~*spider $http_user_agent;</span><br><span class="line">    ~*bot $http_user_agent;</span><br><span class="line">    ~*slurp $http_user_agent;</span><br><span class="line">&#125;</span><br><span class="line">limit_conn_zone $agent zone=conn_ttlsa_com:<span class="number">10</span>m;</span><br><span class="line">limit_req_zone $agent zone=req_ttlsa_com:<span class="number">10</span>m rate=<span class="number">1</span>r/s;</span><br><span class="line">    location / &#123;</span><br><span class="line">        limit_req zone=conn_ttlsa_com burst=<span class="number">5</span>;</span><br><span class="line">        limit_conn req_ttlsa_com <span class="number">1</span>;</span><br><span class="line">        limit rate <span class="number">500</span>k;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>nginx_bot_limit.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># 根据每次请求的$http_user_agent，匹配map块中的左侧字符</span></span><br><span class="line">	<span class="comment"># 匹配到的字符串，则将右侧内容赋值给$agent变量</span></span><br><span class="line">	<span class="keyword">map</span> $http_user_agent $agent &#123;</span><br><span class="line">		default <span class="string">&quot;&quot;</span>;  <span class="comment"># 其他的都是爬虫程序身份，未匹配到的为&quot;&quot;</span></span><br><span class="line">		~curl $http_user_agent;</span><br><span class="line">		~*apachebench $http_user_agent;</span><br><span class="line">		~*spider $http_user_agent;</span><br><span class="line">		~*bot $http_user_agent;</span><br><span class="line">		~*slurp $http_user_agent;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 根据每次匹配到的爬虫身份为key，定义它们的连接数、请求数</span></span><br><span class="line">	<span class="comment"># 不会为空值&quot;&quot;Key建立限制</span></span><br><span class="line">	limit_conn_zone $agent zone=conn_ttlsa_com:<span class="number">10</span>m;</span><br><span class="line">	limit_req_zone $agent zone=req_ttlsa_com:<span class="number">10</span>m rate=<span class="number">1</span>r/s;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		<span class="comment"># 目录下放置robots.txt文件</span></span><br><span class="line">		root /data/www/;</span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="comment"># 启用连接数、请求数的限制</span></span><br><span class="line">			limit_req zone=conn_ttlsa_com burst=<span class="number">5</span>;</span><br><span class="line">			limit_conn req_ttlsa_com <span class="number">1</span>;</span><br><span class="line">			limit_rate <span class="number">500</span>k;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="限流插件-限制客户端上传速率"><a href="#限流插件-限制客户端上传速率" class="headerlink" title="限流插件-限制客户端上传速率"></a>限流插件-限制客户端上传速率</h2><p>ngx_limit_upload_module是一个tengine模块，可以限制客户端发送请求主体时的上传速率。与标准的nginx limit_rate功能用法相同</p>
<p>速率限制请求主体从客户端的传输。速率以每秒字节数指定。值0禁用速率限制。根据请求设置限制，因此如果客户端同时打开两个连接，则总速率将是指定限制的两倍。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_upload_rate rate;</span><br><span class="line">Default: limit_upload_rate <span class="number">0</span>;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> in location</span><br></pre></td></tr></table></figure>

<p>设置初始金额，在此之后，来自客户端的请求正文的进一步传输将受到速率限制。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_upload_rate_after size;</span><br><span class="line">Default: limit_upload_rate_after <span class="number">0</span>;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> in location</span><br></pre></td></tr></table></figure>

<p>nginx_limit.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># 定义限流控制的使用空间及限制信息</span></span><br><span class="line">	<span class="comment"># 定义在http指令块中</span></span><br><span class="line">	<span class="comment"># 限制单个IP平均每秒允许不超过1个请求</span></span><br><span class="line">	limit_req_zone $binary_remote_addr zone=peraddr_req:<span class="number">10</span>m rate=<span class="number">1</span>r/s;</span><br><span class="line">	<span class="comment">#limit_req_zone $binary_remote_addr zone=peraddr_req:10m rate=10r/s;</span></span><br><span class="line">	<span class="comment"># 整个虚拟服务，平均每秒不允许超过10个</span></span><br><span class="line">	limit_req_zone $server_name zone=perserver_req:<span class="number">10</span>m rate=<span class="number">10</span>r/s;</span><br><span class="line">	<span class="comment">#limit_req_zone $server_name zone=perserver_req:10m rate=100r/s;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 定义在http指令块中</span></span><br><span class="line">	<span class="comment"># 限制客户端连接数的空间申请</span></span><br><span class="line">	limit_conn_zone $binary_remote_addr zone=peraddr_conn:<span class="number">10</span>m;</span><br><span class="line">    limit_conn_zone $server_name zone=perserver_conn:<span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 限制给客户端的响应速率，初始50k，后续500k</span></span><br><span class="line">    <span class="comment"># 可以放在http, server, location, if in location指令块中</span></span><br><span class="line">    <span class="comment">#limit_rate       50k;</span></span><br><span class="line">    limit_rate       <span class="number">0</span>;</span><br><span class="line">    <span class="comment">#limit_rate_after 500k;</span></span><br><span class="line">    limit_rate_after <span class="number">500</span>k;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 由淘宝提供，需要limit_upload_rate的支持。</span></span><br><span class="line">    <span class="comment"># 限制客户端上传速率，跟limit_rate用法类似</span></span><br><span class="line">    <span class="comment"># 可以放在http, server, location, if in location指令块中</span></span><br><span class="line">    <span class="comment">#limit_upload_rate 5k;</span></span><br><span class="line">    limit_upload_rate <span class="number">50</span>k;</span><br><span class="line">    <span class="comment">#limit_upload_rate_after 50k;</span></span><br><span class="line">    limit_upload_rate_after <span class="number">500</span>k;</span><br><span class="line"></span><br><span class="line">    upstream tomcatServer &#123;</span><br><span class="line">		server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">		server <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		root /data/www/;</span><br><span class="line">		server_name hash.com;</span><br><span class="line"></span><br><span class="line">		location / &#123;</span><br><span class="line">			<span class="comment"># 限制单个IP平均每秒允许不超过1个请求，突发不超过5个请求</span></span><br><span class="line">			limit_req zone=peraddr_req burst=<span class="number">5</span>;</span><br><span class="line">			<span class="comment">#limit_req zone=peraddr_req burst=50;</span></span><br><span class="line">			<span class="comment"># 整个虚拟服务，平均每秒不允许超过10个，突发不超过10个请求</span></span><br><span class="line">			limit_req zone=perserver_req burst=<span class="number">10</span>;</span><br><span class="line">			<span class="comment">#limit_req zone=perserver_req burst=100;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># 限制单个IP建立不超过1个连接</span></span><br><span class="line">			<span class="comment"># 整个虚拟服务，不允许超过100个连接</span></span><br><span class="line">			limit_conn peraddr_conn <span class="number">1</span>;</span><br><span class="line">			<span class="comment">#limit_conn peraddr_conn 10;</span></span><br><span class="line">			limit_conn perserver_conn <span class="number">100</span>;</span><br><span class="line">			<span class="comment">#limit_conn perserver_conn 1000;</span></span><br><span class="line"></span><br><span class="line">			proxy_pass http:<span class="regexp">//</span>tomcatServer;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="黑白名单插件"><a href="#黑白名单插件" class="headerlink" title="黑白名单插件"></a>黑白名单插件</h1><h2 id="Nginx的访问模块"><a href="#Nginx的访问模块" class="headerlink" title="Nginx的访问模块"></a>Nginx的访问模块</h2><p>ngx_http_access_module模块，提供允许、拒绝指令来控制客户端能否访问服务。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    deny <span class="number">192.168</span>.<span class="number">1.1</span>;</span><br><span class="line">    allow <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span>;</span><br><span class="line">    allow <span class="number">10.1</span>.<span class="number">1.0</span>/<span class="number">16</span>;</span><br><span class="line">    allow <span class="number">2001</span>:0db8::/<span class="number">32</span>;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>allow，允许某个ip或者一个 ip 段访问<br>deny，禁止某个ip或者一个 ip 段访问</p>
<h2 id="黑白名单插件-1"><a href="#黑白名单插件-1" class="headerlink" title="黑白名单插件"></a>黑白名单插件</h2><p>nginx_white_black_list可以根据定义的黑白名单配置文件来进行控制客户端能否访问服务。</p>
<p>处在黑名单中的 ip 与网络，将无法访问 web 服务。</p>
<p>处在白名单中的 ip，访问 web 服务时，将不受 nginx 所有安全模块的限制。</p>
<p>支持动态黑名单（需要与 ngx_http_limit_req 配合）</p>
<p>nginx_white_black_list.conf示例</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单指令以;结尾</span></span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大括号属于块指令</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	<span class="comment"># 定义 黑名单或白名单文件 空间key</span></span><br><span class="line">	<span class="comment"># 只能在http指令块中</span></span><br><span class="line">	<span class="comment"># white_black_list_conf可以配置多个 只需 zone=value 其中的value不同就可</span></span><br><span class="line">	white_black_list_conf white.list zone=white:<span class="number">2</span>m;</span><br><span class="line">	white_black_list_conf black.list zone=black:<span class="number">4</span>m;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 启用黑白名单，on/off，启用/关闭。</span></span><br><span class="line">	<span class="comment"># 在http、server、location下使用, 功能默认是关闭</span></span><br><span class="line">	<span class="comment"># 配置在对应的指令块中，对应的指令块上下文生效</span></span><br><span class="line">	white_list white on; <span class="comment">#白名单  white 在整个http&#123;&#125;中都开启</span></span><br><span class="line">	black_list black on; <span class="comment">#黑名单  black 在整个http&#123;&#125;中都开启</span></span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		root /data/www/;</span><br><span class="line"></span><br><span class="line">		location / &#123;</span><br><span class="line">			root   /data/www/;</span><br><span class="line">            <span class="keyword">index</span>  welcome.html;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 黑白名单配置调整接口，通过它可以调整配置内容</span></span><br><span class="line">		<span class="comment">#location /sec_config &#123;</span></span><br><span class="line">		<span class="comment">#	sec_config on;</span></span><br><span class="line">		<span class="comment">#&#125;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="更多常用插件"><a href="#更多常用插件" class="headerlink" title="更多常用插件"></a>更多常用插件</h1><p>参考官网wiki：<a target="_blank" rel="noopener" href="https://www.nginx.com/resources/wiki/modules/">https://www.nginx.com/resources/wiki/modules/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/06-00-Nginx%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6/" data-id="clmcxeccn002yu8wabspof2yk" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/05-Nginx性能优化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/05-Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.816Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Nginx程序运行原理分析"><a href="#Nginx程序运行原理分析" class="headerlink" title="Nginx程序运行原理分析"></a>Nginx程序运行原理分析</h1><h2 id="Nginx工作模式"><a href="#Nginx工作模式" class="headerlink" title="Nginx工作模式"></a>Nginx工作模式</h2><p>Nginx在启动时会以daemon形式在后台运行，采用多进程+异步非阻塞IO事件模型来处理各种连接请求。多进程模型包括一个master进程，多个worker进程，一般worker进程个数是根据服务器CPU核数来决定的。master进程负责管理Nginx本身和其他worker进程。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ps -ef|grep nginx</span><br><span class="line">root 24574 1 0 17:41 ? 00:00:00 nginx: master process bin/nginx -c </span><br><span class="line">conf/nginx.conf</span><br><span class="line">nobody 24575 24574 0 17:41 ? 00:00:00 nginx: worker process</span><br><span class="line">nobody 24576 24574 0 17:41 ? 00:00:00 nginx: worker process</span><br><span class="line">nobody 24577 24574 0 17:41 ? 00:00:00 nginx: worker process</span><br><span class="line">nobody 24578 24574 0 17:41 ? 00:00:00 nginx: worker process</span><br></pre></td></tr></table></figure>



<p>4个worker进程的父进程都是master进程，表明worker进程都是从父进程fork出来的，并且父进程的ppid为1，表示其为daemon进程。</p>
<p>Nginx中的Master、Worker两种进程。</p>
<p>Master进程<br>    负责加载配置、接收命令、监控子进程。Master进程也是可以关闭的</p>
<p>Worker进程<br>    负责处理网络请求。Worker进程的个数由配置文件决定，一般和CPU个数相关（有利于进程切换），配置几个就有几个Worker进程。需要说明的是，在nginx多进程中，每个worker都是平等的，因此每个进程处理外部请求的机会权重都是一致的。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221106181434.png"></p>
<h2 id="Nginx的架构及工作流程"><a href="#Nginx的架构及工作流程" class="headerlink" title="Nginx的架构及工作流程"></a>Nginx的架构及工作流程</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221106181529.png"></p>
<p>Master与Worker是如何分工协作的？与Netty的线程模型有什么异同？</p>
<h2 id="多进程处理模型"><a href="#多进程处理模型" class="headerlink" title="多进程处理模型"></a>多进程处理模型</h2><p>多进程模型的<strong>处理方式</strong></p>
<p><strong>首先</strong>，master进程一开始就会根据我们的配置，来建立需要listen的网络socket fd，然后fork出多个worker进程。</p>
<p><strong>其次</strong>，根据进程的特性，新建立的worker进程，也会和master进程一样，具有相同的设置。因此，其也会去监听相同ip端口的套接字socket fd。</p>
<p><strong>然后</strong>，多个worker进程监听同样设置的socket fd，当有一个请求进来，所有的worker都会感知。</p>
<p><strong>最后</strong>，监听成功的worker进程，读取请求，解析处理，响应数据返回给客户端，断开连接，结束。因此，一个request请求，只需要worker进程就可以完成。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221106181723.png"></p>
<h2 id="多进程处理模型优点"><a href="#多进程处理模型优点" class="headerlink" title="多进程处理模型优点"></a>多进程处理模型优点</h2><p><strong>Nginx为何要采用多进程模式？</strong></p>
<p>进程之间是独立的，当一个worker进程出现异常退出，其他worker进程不会受到影响；</p>
<p>独立进程也会避免一些不需要的锁操作，这样能提高处理效率，开发调试也更容易。</p>
<p>单纯的<strong>多进程模型会导致连接并发数量降低</strong>，<strong>异步非阻塞IO模型</strong>能解决这个问题，还能避免<strong>多线程上下文切换导致</strong>的性能损失。</p>
<p>多进程模型+异步非阻塞模型是一个非常好的选择。</p>
<p>跟NIO、Netty线程模型思想一致，只不过一个是线程级、一个是进程级。</p>
<h2 id="多worker进程如何协作？"><a href="#多worker进程如何协作？" class="headerlink" title="多worker进程如何协作？"></a>多worker进程如何协作？</h2><p><strong>Worker进程遇到的问题</strong></p>
<p><strong>出现惊群效应</strong></p>
<p>多个worker子进程监听相同端口的设计，这样多个子进程在accept建立新连接时会有争抢，这会带来著名的“惊群”问题，子进程数量越多问题越明显，这会造成系统性能下降。建立新连接时Nginx是如何避免出现“惊群”现象的呢？</p>
<p><strong>Worker进程负载不均衡</strong></p>
<p>多个子进程争抢处理一个新连接事件，最终只有一个worker子进程成功建立连接，随后，它会一直处理这个连接直到连接关闭。</p>
<p>如果有的子进程很“勤奋”，它们抢着建立并处理了大部分连接，而有的子进程则“运气不好”，只处理了少量连接。</p>
<p>子进程间负载不均衡，必然影响整个服务的性能。怎么办？</p>
<h2 id="问题的解决之道"><a href="#问题的解决之道" class="headerlink" title="问题的解决之道"></a>问题的解决之道</h2><h3 id="Nginx的Post队列"><a href="#Nginx的Post队列" class="headerlink" title="Nginx的Post队列"></a><strong>Nginx的Post队列</strong></h3><p>将epoll产生的事件分开，新连接事件的ngx_posted_accept_events队列优先执行，普通事件的ngx_posted_events队列最后执行</p>
<h3 id="accept-mutex"><a href="#accept-mutex" class="headerlink" title="accept_mutex"></a><strong>accept_mutex</strong></h3><p>Nginx采用了一个是否打开accept_mutex选项的值，控制worker进程是否需要去竞争锁，打开accept_mutex锁，能很好解决accept惊群问题。</p>
<h3 id="ngx-accept-disabled"><a href="#ngx-accept-disabled" class="headerlink" title="ngx_accept_disabled"></a><strong>ngx_accept_disabled</strong></h3><p>worker进程进行负载均衡阈的判断值，处理的连接总数没有达到7&#x2F;8，不会抢accept锁，达到时，则需要抢锁，它解决了负载均衡的问题。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221106182440.png"></p>
<h1 id="Worker与CPU的绑定"><a href="#Worker与CPU的绑定" class="headerlink" title="Worker与CPU的绑定"></a>Worker与CPU的绑定</h1><p>Worker进程跟CPU个数有关，但是如果多个Worker进程在同一个CPU上面争夺资源也非常消耗性能。Nginx中有一个worker_cpu_affinity 配置，能够将worker绑定到对应的CPU上面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 4;</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br></pre></td></tr></table></figure>

<p>单个Worker进程处理的并发连接数配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_connections 1024;</span><br></pre></td></tr></table></figure>

<h1 id="Linux服务器参数性能优化"><a href="#Linux服务器参数性能优化" class="headerlink" title="Linux服务器参数性能优化"></a>Linux服务器参数性能优化</h1><h2 id="linux服务器参数调整"><a href="#linux服务器参数调整" class="headerlink" title="linux服务器参数调整"></a>linux服务器参数调整</h2><p>当TCP TIME_WAIT套接字数量经常达到两、三万，服务器很容易被拖死，需要减少Nginx服务器的TIME_WAIT套接字数量。</p>
<p>修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>调整内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于某种原因服务端主动关闭连接，连接进入FIN_WAIT2状态,该状态是没有超时的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果客户端不关闭，这个FIN_WAIT_2状态将保持到系统重新启动，越来越多的FIN_WAIT_2状态会致使内核crash</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为20分钟。</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可防范少量SYN攻击，默认为0，表示关闭；</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。</span></span><br><span class="line">net.ipv4.ip_local_port_range = 1024    65000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000，改为5000。对于Apache、Nginx等服务器，上几行的参数可以很好地减少TIME_WAIT套接字数量，但是对于Squid，效果却不大。此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br></pre></td></tr></table></figure>

<p>生效配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /sbin/sysctl -p</span><br></pre></td></tr></table></figure>

<h1 id="常用nginx性能优化"><a href="#常用nginx性能优化" class="headerlink" title="常用nginx性能优化"></a>常用nginx性能优化</h1><h2 id="Nginx常规调整"><a href="#Nginx常规调整" class="headerlink" title="Nginx常规调整"></a>Nginx常规调整</h2><table>
<thead>
<tr>
<th>常见指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>worker_processes</td>
<td>定义工作进程的数量，最佳值取决于许多因素，包括（但不限于）CPU核心数，存储数据的硬盘驱动器数和负载模式。设置为可用CPU核心数将是一个良好的开端（值“ auto”将尝试自动检测它）。</td>
</tr>
<tr>
<td>worker_rlimit_core</td>
<td>工作进程的核心文件的最大大小限制，在不重新启动主进程的情况下增加限制。</td>
</tr>
<tr>
<td>worker_rlimit_nofile</td>
<td>工作进程允许打开的最大文件数，在不重新启动主进程的情况下增加限制。</td>
</tr>
<tr>
<td>worker_connections</td>
<td>工作进程可以打开的最大并发连接数。这个数字包括所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接。另一个考虑因素是实际的并发连接数不能超过最大打开文件数的当前限制，可以通过worker_rlimit_nofile更改</td>
</tr>
<tr>
<td>worker_cpu_affinity</td>
<td>将worker进程绑定到CPU组，每个CPU集由允许的CPU的位掩码表示。应该为每个worker进程定义一个单独的集合。默认情况下，工作进程不绑定到任何特定的CPU。</td>
</tr>
<tr>
<td>ssl_engine</td>
<td>硬件SSL加速器的名称。可以通过openssl engine -t来检查是否有硬件加密设备。</td>
</tr>
<tr>
<td>worker_priority</td>
<td>定义工作进程的调度优先级，就像nice命令一样：负数 number 表示更高的优先级，允许范围通常在-20到20之间变化。linux系统安装进程优先级来调度进程，优先级越高时间片越长。</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/05-Nginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" data-id="clmcxecch002vu8waehjb5rs7" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/04-Nginx缓存数据" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/04-Nginx%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.809Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Nginx缓存机制介绍"><a href="#Nginx缓存机制介绍" class="headerlink" title="Nginx缓存机制介绍"></a>Nginx缓存机制介绍</h1><h2 id="Nginx缓存机制的作用"><a href="#Nginx缓存机制的作用" class="headerlink" title="Nginx缓存机制的作用"></a>Nginx缓存机制的作用</h2><ol>
<li>缓存能够提升性能，学会Nginx中如何使用缓存很重要。</li>
<li>Nginx作为静态资源服务器，静态资源变动频率小，缓存能够加速访问。</li>
<li>Nginx离用户最近，启用缓存能更好的提高性能，结合Redis可以组成类似二级缓存。</li>
</ol>
<h2 id="Nginx缓存机制简述"><a href="#Nginx缓存机制简述" class="headerlink" title="Nginx缓存机制简述"></a>Nginx缓存机制简述</h2><p><strong>Nginx中的缓存</strong></p>
<p>nginx中的缓存是以文件系统上的分层数据存储的形式实现的。<br>缓存Key是可配置的，并且可以使用不同的请求特定参数来控制进入缓存的内容。<br>缓存Key和缓存元数据存储在共享内存段中，缓存加载器、缓存管理器和Worker进程可以访问它们。<br>目前，除了操作系统的虚拟文件系统机制所暗示的优化之外，没有任何内存中的文件缓存。每个缓存的响应都放在文件系统上的不同文件中。通过nginx配置指令控制指定层次结构(级别和命名细节)。</p>
<p><strong>缓存放置内容过程：</strong></p>
<p>当nginx从上游服务器读取响应时，首先将内容写入缓存目录结构之外的临时文件。 </p>
<p>当nginx完成处理请求时，它会重命名临时文件并将其移动到缓存目录。如果用于代理的临时文件目录位于另一个文件系统上，则文件将被复制，因此建议将临时目录和缓存目录保留在同一个文件系统上。当需要显式清除文件时，从缓存目录结构中删除文件也是非常安全的。</p>
<p>nginx有第三方扩展，可以远程控制缓存的内容，并计划在主发行版中集成此功能</p>
<h2 id="Nginx缓存支持"><a href="#Nginx缓存支持" class="headerlink" title="Nginx缓存支持"></a>Nginx缓存支持</h2><p>Nginx中有非常强大的缓存功能，针对后台服务返回的数据能够进行缓存，再次访问时，无需从后台服务拿取结果，直接在nginx本地获取即可。Nginx中针对fastcgi、http_proxy、scgi、ssl_session、ngx_http_uwsgi_module模块提供了通用的缓存功能。</p>
<table>
<thead>
<tr>
<th>cache支持的模块</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ngx_http_fastcgi_module</td>
<td>快速通用网关接口，如php,perl,tcl等采用</td>
</tr>
<tr>
<td>ngx_http_proxy_module</td>
<td>http代理模块，适用任何http协议的后台服务</td>
</tr>
<tr>
<td>ngx_http_scgi_module</td>
<td>通用网关接口，如php,perl,tcl等采用</td>
</tr>
<tr>
<td>ngx_http_uwsgi_module</td>
<td>WSGI协议的web服务，如python采用</td>
</tr>
<tr>
<td>ngx_http_ssl_module</td>
<td>session缓存</td>
</tr>
<tr>
<td>ngx_http_core_module</td>
<td>open_file_cache文件缓存</td>
</tr>
</tbody></table>
<p> 以http_proxy模块为例来进行学习，观察官网其他模块，都相差不大，学会一个其他的也就学会了</p>
<h2 id="缓存使用"><a href="#缓存使用" class="headerlink" title="缓存使用"></a>缓存使用</h2><p>缓存常用指令：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
<th>默认值</th>
<th>分类</th>
</tr>
</thead>
<tbody><tr>
<td>proxy_cache_path</td>
<td>定义缓存的路径和缓存空间名、大小等配置，缓存数据存储在文件中。缓存中的文件名是将MD5功能应用于缓存键的结果。</td>
<td>-</td>
<td>定义</td>
</tr>
<tr>
<td>proxy_cache</td>
<td>启用缓存，指定的用于缓存的缓存空间名，不同地方可以启用同一个空间名。</td>
<td>-</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_valid</td>
<td>设置不同响应代码的缓存时间</td>
<td>-</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_key</td>
<td>定义缓存的Key</td>
<td>$scheme $proxy_host $request_uri;</td>
<td>定义</td>
</tr>
<tr>
<td>proxy_cache_purge</td>
<td>定义将请求视为缓存清除请求的条件。如果字符串参数的至少一个值不为空且不等于“0”，则移除具有相应高速缓存键的高速缓存条目 。通过返回204（无内容）响应来指示成功操作的结果。</td>
<td>-</td>
<td>应用</td>
</tr>
</tbody></table>
<p> 示例参考下面内容</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">	<span class="comment"># 并发连接数</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># JAVA服务器集群</span></span><br><span class="line">	<span class="section">upstream</span> app_servers &#123;</span><br><span class="line">		<span class="attribute">server</span> <span class="number">127.0.0.1:8080</span>;	</span><br><span class="line"><span class="comment">#		server 127.0.0.1:8081;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># 代理缓存配置 - 定义配置</span></span><br><span class="line">	<span class="attribute">proxy_cache_path</span> <span class="string">&quot;./cache_data/&quot;</span> levels=<span class="number">2</span>:<span class="number">1</span>:<span class="number">2</span> keys_zone=hot_information_cache:<span class="number">256m</span> inactive=<span class="number">1d</span> max_size=<span class="number">1000g</span>;  </span><br><span class="line">	<span class="attribute">proxy_cache_path</span> <span class="string">&quot;./cache_data/&quot;</span> levels=<span class="number">2</span>:<span class="number">1</span>:<span class="number">2</span> keys_zone=cache2:<span class="number">256m</span> inactive=<span class="number">30s</span> max_size=<span class="number">30g</span>;  </span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="comment"># 监听80端口</span></span><br><span class="line">		<span class="attribute">listen</span>	<span class="number">80</span>;</span><br><span class="line">		<span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># 开启缓存</span></span><br><span class="line">            <span class="attribute">proxy_cache</span> hot_information_cache;</span><br><span class="line">            <span class="comment"># 缓存JAVA应用返回的指定状态的数据，缓存时间时1天       </span></span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">206</span> <span class="number">304</span> <span class="number">301</span> <span class="number">302</span> <span class="number">1d</span>;</span><br><span class="line">            <span class="comment"># 请求的url就是缓存的key（根据实际业务场景匹配）       </span></span><br><span class="line">            <span class="attribute">proxy_cache_key</span> <span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;      </span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 设置传递给上游服务的请求头，Host为客户端host，默认为$proxy_host</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">            <span class="comment"># 如果缓存中没找到，再去请求后端服务器</span></span><br><span class="line">            <span class="attribute">proxy_pass</span> http://app_servers;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># 该指令在商业版本Nginx Plus支持，可以通过第三方模块ngx_cache_purge来替代</span></span><br><span class="line">		<span class="comment"># 资源有变化的时候清除缓存</span></span><br><span class="line">		<span class="section">location</span> <span class="regexp">~ /purge(/.*)</span> &#123;</span><br><span class="line">			<span class="comment">#设置只允许指定的IP来清除缓存</span></span><br><span class="line">			<span class="attribute">allow</span> all;</span><br><span class="line">			<span class="comment"># allow 127.0.0.1;</span></span><br><span class="line">			<span class="comment"># deny all ;</span></span><br><span class="line">			<span class="attribute">proxy_cache_purge</span> hot_information_cache <span class="variable">$1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="proxy-cache-path参数详解"><a href="#proxy-cache-path参数详解" class="headerlink" title="proxy_cache_path参数详解"></a>proxy_cache_path参数详解</h2><p><strong>level</strong>：用来定义缓存的层级，可以定义1到3个层级，每个层级接收值1、2</p>
<p><strong>use_temp_path</strong>：是否启用缓存临时文件，第一次响应的内容将写入临时文件，后面才会重写回来。使用网盘注意网络IO的开销。</p>
<p><strong>keys_zone</strong>：定义在共享存储区中存储了所有活跃的Key和关于数据的信息。存储区名称和大小由key_zone参数配置。一个兆字节的区域可以存储大约8,000个Key</p>
<p><strong>Inactive</strong>：不论数据新旧程度，在inactive指定的时间内未访问的缓存数据 将从缓存中删除。</p>
<h2 id="缓存指令附录"><a href="#缓存指令附录" class="headerlink" title="缓存指令附录"></a>缓存指令附录</h2><table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
<th>默认值</th>
<th>分类</th>
</tr>
</thead>
<tbody><tr>
<td>proxy_cache</td>
<td>定义用于缓存的共享内存区域，可以在多个地方使用相同的区域。off禁用从先前配置级别继承的高速缓存。</td>
<td>off</td>
<td>定义</td>
</tr>
<tr>
<td>proxy_cache_background_update</td>
<td>允许启动后台子请求以更新过期的缓存项，同时将过时的缓存响应返回给客户端。</td>
<td>off</td>
<td>更新</td>
</tr>
<tr>
<td>proxy_cache_bypass</td>
<td>定义不从缓存中获取响应的条件。如果字符串参数的至少一个值不为空且不等于“0”，则不会从缓存中获取响应，可以与proxy_no_cache指令一起使用</td>
<td>-</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_convert_head</td>
<td>启用或禁用将“ HEAD”方法转换为“ ”以GET进行缓存。禁用转换时， 应将缓存键配置为包含$request_method。</td>
<td>on</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_key</td>
<td>定义缓存的键，默认情况下，指令的值接近字符串</td>
<td>$scheme $proxy_host $request_uri</td>
<td>定义</td>
</tr>
<tr>
<td>proxy_cache_lock</td>
<td>启用锁，一次只允许一个请求重建缓存，其他请求等待直到proxy_cache_lock_timeout设置超时。</td>
<td>off</td>
<td>管理</td>
</tr>
<tr>
<td>proxy_cache_lock_age</td>
<td>在指定的时间内，上一个重构缓存的请求未完成，则将另一个请求传递给代理服务器。</td>
<td>5s</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_lock_timeout</td>
<td>设置proxy_cache_lock的超时，超时请求将被传递给代理的服务器，但是，响应不会被缓存。</td>
<td>5s</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_max_range_offset</td>
<td>设置响应被缓存的最大字节数，超过则不缓存响应，直接请求代理服务。</td>
<td>-</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_methods</td>
<td>需要进行缓存的HTTP方法</td>
<td>GET、HEAD</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_min_uses</td>
<td>设置多少次请求后才缓存响应内容</td>
<td>1</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_path</td>
<td>设置缓存的路径和其他参数，缓存数据存储在文件中。缓存中的文件名是将MD5功能应用于缓存键的结果。 其他参数 levels参数定义高速缓存的层次结构级别 use_temp_path是否启用临时文件keys_zone定义键的大小，一兆字节区域可以存储大约8000个键inactive 指定的时间内未访问的缓存数据 将从缓存中删除 缓存管理器：max_size、manager_files、manager_threshold、manager_sleep 缓存清除：purger、purger_files、purger_threshold、purger_sleep</td>
<td>-</td>
<td>定义&#x2F;清除</td>
</tr>
<tr>
<td>proxy_cache_purge</td>
<td>定义将请求视为缓存清除请求的条件。如果字符串参数的至少一个值不为空且不等于“0”，则移除具有相应高速缓存键的高速缓存条目 。通过返回204（无内容）响应来指示成功操作的结果。 如果清除请求的缓存键以星号（“ *”）结束，则将从缓存中删除与通配符键匹配的所有缓存条目。但是，这些条目将保留在磁盘上，直到它们被删除为非活动状态，或由缓存清除程序（1.7.12）处理，或者客户端尝试访问它们。</td>
<td>-</td>
<td>清除</td>
</tr>
<tr>
<td>proxy_cache_revalidate</td>
<td>使用带有“If-Modified-Since”和“If-None-Match”标头字段的条件请求启用过期缓存项的重新验证。</td>
<td>off</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_use_stale</td>
<td>确定在与代理服务器通信期间，可以在哪些情况下使用过时的缓存响应。该指令的参数与proxy_next_upstream指令的参数匹配</td>
<td>off</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_cache_valid</td>
<td>设置不同响应代码的缓存时间</td>
<td>-</td>
<td>应用</td>
</tr>
<tr>
<td>proxy_no_cache</td>
<td>定义不将响应保存到缓存的条件。如果字符串参数的至少一个值不为空且不等于“0”，则不会保存响应。</td>
<td>-</td>
<td>应用</td>
</tr>
</tbody></table>
<h1 id="缓存清除机制分析"><a href="#缓存清除机制分析" class="headerlink" title="缓存清除机制分析"></a>缓存清除机制分析</h1><h2 id="被动缓存清除"><a href="#被动缓存清除" class="headerlink" title="被动缓存清除"></a>被动缓存清除</h2><p><strong>proxy_cache_path指令的缓存管理</strong></p>
<p>proxy_cache_path中可以通过以下指令来管理缓存</p>
<p>max_size：指定缓存大小，缓存管理进程监控缓存是否超过指定值，超过该大小则通过LRU算法来淘汰数据。一次迭代删除的数据通过下面的参数来指定。</p>
<p>manager_files：一次迭代过程中删除的项的数量，默认100个</p>
<p>manager_threshold：一次迭代操作的持续时间限制，默认200毫秒</p>
<p>manager_sleep：两次迭代的间隔时间，默认50毫秒</p>
<h2 id="缓存加载"><a href="#缓存加载" class="headerlink" title="缓存加载"></a>缓存加载</h2><p>proxy_cache_path中可以通过以下参数来调整加载缓存</p>
<p>Nginx启动一分钟后，缓存加载进程被激活，存储在文件系统上先前缓存的数据将被加载到缓存区中，整个加载是在迭代中完成的。一次加载</p>
<p>loader_files：一次迭代加载不超过指定数目的项，默认100。</p>
<p>loader_threshold：一次迭代操作的持续时间限制，默认200毫秒</p>
<p>loader_sleep：两次迭代的间隔时间，默认50毫秒</p>
<h2 id="主动清除缓存"><a href="#主动清除缓存" class="headerlink" title="主动清除缓存"></a>主动清除缓存</h2><p><strong>Nginx商业功能</strong></p>
<p>proxy_cache_path中可以通过以下参数来调整主动清除缓存</p>
<p>purger：on开启缓存清除进程，遍历所有缓存条目并删除匹配到的键的缓存数据</p>
<p>purger_files：一次迭代过程中扫描的项的数量，默认10个</p>
<p>purger_threshold：一次迭代的持续时间，默认50毫秒</p>
<p>purger_sleep：两次迭代的间隔时间，默认50毫秒</p>
<p>以上参数与proxy_cache_purge指令配合进行。</p>
<p><strong>虽说只能在商业版的Nginx中使用，但是我们可以通过强大的第三方模块来替代</strong></p>
<h1 id="第三方缓存主动清除"><a href="#第三方缓存主动清除" class="headerlink" title="第三方缓存主动清除"></a>第三方缓存主动清除</h1><h2 id="ngx-cache-purge"><a href="#ngx-cache-purge" class="headerlink" title="ngx_cache_purge"></a>ngx_cache_purge</h2><p>ngx_cache_purge是一个第三方的nginx缓存主动清除模块，集成方便，使用简单。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">下载nginx构建purge模块</span><br><span class="line">wget https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz</span><br><span class="line">tar -xfvz ngx_cache_purge-2.3.tar.gz</span><br><span class="line">./configure --prefix=/app/nginx --with-http_stub_status_module --with-http_ssl_module --add-module=../ngx_cache_purge-2.3</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">对于之前安装过nginx的可以按下面步骤操作</span><br><span class="line">wget https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz</span><br><span class="line"><span class="built_in">mv</span> 2.3.tar.gz ngx_cache_purge-2.3.tar.gz</span><br><span class="line">tar -xvzf ngx_cache_purge-2.3.tar.gz</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /usr/local/nginx</span><br><span class="line"><span class="built_in">cd</span> /usr/local/nginx-1.16.0</span><br><span class="line">sudo ./configure \</span><br><span class="line">	--prefix=/usr/local/nginx \</span><br><span class="line">    --sbin-path=/usr/local/nginx/nginx \</span><br><span class="line">    --conf-path=/usr/local/nginx/conf/nginx.conf \</span><br><span class="line">    --error-log-path=/usr/local/nginx/logs/error.log \</span><br><span class="line">    --pid-path=/usr/local/nginx/pid/nginx.pid \</span><br><span class="line">    --with-http_ssl_module \</span><br><span class="line">    --with-openssl=/home/root/openssl-OpenSSL_1_0_2k \</span><br><span class="line">    --add-module=/home/root/echo-nginx-module-0.61 \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --add-module=/home/root/ngx_cache_purge-2.3</span><br><span class="line">    </span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>详细资料地址：<a target="_blank" rel="noopener" href="https://github.com/FRiCKLE/ngx_cache_purge">https://github.com/FRiCKLE/ngx_cache_purge</a></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path  /app/proxy_cache_dir  levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=cache1:<span class="number">200</span>m inactive=<span class="number">1</span>d max_size=<span class="number">10</span>g;</span><br><span class="line"><span class="comment">#设置Web缓存区名称为cache1，内存缓存空间大小为200MB，1天没有被访问的内容自动清除，硬盘缓存空间大小为30GB。levels=1:2 表示缓存目录的第一级目录是1个字符，第二级目录是2个字符，即/app/proxy_cache_dir/cache1/a/1b这种形式</span></span><br><span class="line">server &#123;</span><br><span class="line">        <span class="keyword">listen</span>       <span class="number">80</span>;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            <span class="keyword">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ <span class="regexp">/purge(/</span>.*) &#123;</span><br><span class="line">            allow           <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>;</span><br><span class="line">            allow           <span class="number">192.168</span>.<span class="number">116.0</span>/<span class="number">24</span></span><br><span class="line">            deny            all;</span><br><span class="line">            proxy_cache_purge    cache1 $host$1$is_args$args;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ \.(gif|jpg|jpeg|png|bmp|ico)$ &#123;</span><br><span class="line">            proxy_set_header Host  $host;</span><br><span class="line">            proxy_set_header X-Forwarded-For  $remote_addr;</span><br><span class="line">            proxy_pass http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8080</span>;</span><br><span class="line">            proxy_cache cache1; <span class="comment"># 设置资源缓存的zone</span></span><br><span class="line">            <span class="comment"># 设置缓存的key，以域名、URI、参数组合成Web缓存的Key值，</span></span><br><span class="line">            <span class="comment"># Nginx根据Key值哈希，存储缓存内容到二级缓存目录内</span></span><br><span class="line">            proxy_cache_key $host$uri$is_args$args; </span><br><span class="line">            proxy_cache_valid <span class="number">200</span> <span class="number">304</span> <span class="number">12</span>h;  <span class="comment"># 对不同的HTTP状态码设置不同的缓存时间</span></span><br><span class="line">            expires <span class="number">7</span>d; <span class="comment"># 缓存时间</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用ngx-cache-purge"><a href="#使用ngx-cache-purge" class="headerlink" title="使用ngx_cache_purge"></a>使用ngx_cache_purge</h2><ol>
<li>访问缓存URL，<a target="_blank" rel="noopener" href="http://hostname/test/n.jpg">http://hostname/test/n.jpg</a><br>服务端初次响应，建立缓存内容</li>
<li>查看缓存的文件<br>查看缓存文件系统内容</li>
<li>修改数据访问<br>修改数据以后，缓存还在起作用，一段时间不能访问到新数据</li>
<li>清除缓存再次访问<br>通过插件主动清除缓存，再次访问到新的数据内容</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Nginx缓存支持的模块和常用指令</p>
<p>Nginx中缓存管理机制</p>
<ul>
<li>缓存开启</li>
<li>缓存管理</li>
<li>缓存加载</li>
<li>缓存清除</li>
</ul>
<p>第三方缓存主动清除插件</p>
<ul>
<li>安装使用</li>
<li>测试验证</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/04-Nginx%E7%BC%93%E5%AD%98%E6%95%B0%E6%8D%AE/" data-id="clmcxeccd002uu8wa8gmedeew" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/03-02-OpenResty安装操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/03-02-OpenResty%E5%AE%89%E8%A3%85%E6%93%8D%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.804Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="OpenResty安装使用"><a href="#OpenResty安装使用" class="headerlink" title="OpenResty安装使用"></a>OpenResty安装使用</h1><p>在Nginx新版本中没有直接提供Lua模块的集成，Lua脚本模块已经作为第三方集成模块中去了，查看<a target="_blank" rel="noopener" href="https://www.nginx.com/products/nginx/modules/">Nginx博客</a>地址可知，集成到<a target="_blank" rel="noopener" href="http://openresty.org/">OpenResty</a>中，OpenResty由主要国人章亦春维护的项目。</p>
<p>OpenResty是一个基于 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a> 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>充分利用 <a target="_blank" rel="noopener" href="http://openresty.org/cn/nginx.html">Nginx</a>的非阻塞 I&#x2F;O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>
<h2 id="安装OpenResty"><a href="#安装OpenResty" class="headerlink" title="安装OpenResty"></a>安装OpenResty</h2><p>有二进制安装包、源码构建两种方式来安装OpenResty</p>
<h3 id="安装OpenResty-1"><a href="#安装OpenResty-1" class="headerlink" title="安装OpenResty"></a>安装OpenResty</h3><p>官网提供二进制安装包，以CentOS为例，通过yum命令即可安装。其他系统参考<a target="_blank" rel="noopener" href="http://openresty.org/cn/linux-packages.html">官网</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 openresty 仓库</span></span><br><span class="line">sudo yum install yum-utils</span><br><span class="line">sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装OpenResty</span></span><br><span class="line">sudo yum install openresty</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装命令行工具 resty</span></span><br><span class="line">sudo yum install openresty-resty</span><br></pre></td></tr></table></figure>



<h3 id="构建OpenResty"><a href="#构建OpenResty" class="headerlink" title="构建OpenResty"></a>构建OpenResty</h3><h4 id="下载解压"><a href="#下载解压" class="headerlink" title="下载解压"></a>下载解压</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖工具</span></span><br><span class="line">yum install -y pcre-devel openssl-devel gcc curl</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载源码包</span></span><br><span class="line">wget https://openresty.org/download/openresty-1.15.8.1.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压构建并安装</span></span><br><span class="line">tar -xzvf openresty-1.15.8.1.tar.gz</span><br><span class="line">sudo mv openresty-1.15.8.1 openresty</span><br><span class="line">sudo mv openresty /usr/local</span><br><span class="line">cd openresty/</span><br></pre></td></tr></table></figure>

<h4 id="编译选项"><a href="#编译选项" class="headerlink" title="编译选项"></a>编译选项</h4><p>可以通过.&#x2F;configure –help来了解，编译的各种选项，例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">--without-http_srcache_module      disable ngx_http_srcache_module</span><br><span class="line">--without-http_lua_module          disable ngx_http_lua_module</span><br><span class="line">--without-http_lua_upstream_module disable ngx_http_lua_upstream_module</span><br><span class="line">--without-http_headers_more_module disable ngx_http_headers_more_module</span><br><span class="line">--without-http_array_var_module    disable ngx_http_array_var_module</span><br><span class="line">--without-http_memc_module         disable ngx_http_memc_module</span><br><span class="line">--without-http_redis2_module       disable ngx_http_redis2_module</span><br><span class="line">--without-http_redis_module        disable ngx_http_redis_module</span><br><span class="line">--without-http_rds_json_module     disable ngx_http_rds_json_module</span><br><span class="line">--without-http_rds_csv_module      disable ngx_http_rds_csv_module</span><br><span class="line">--without-stream_lua_module        disable ngx_stream_lua_module</span><br><span class="line">--without-ngx_devel_kit_module     disable ngx_devel_kit_module</span><br><span class="line">--without-http_ssl_module          disable ngx_http_ssl_module</span><br><span class="line">--without-stream_ssl_module        disable ngx_stream_ssl_module</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>你可以这样来添加和去除你想要选择的模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/openresty \ #指定编译目录，默认为/usr/local/openresty</span><br><span class="line">            --with-luajit \</span><br><span class="line">            --without-http_redis2_module \</span><br><span class="line">            --with-http_iconv_module \</span><br><span class="line">            --with-http_postgres_module</span><br></pre></td></tr></table></figure>

<p>你也可以使用默认配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure</span><br></pre></td></tr></table></figure>

<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>



<h2 id="启动OpenResty"><a href="#启动OpenResty" class="headerlink" title="启动OpenResty"></a>启动OpenResty</h2><p>实际上openresty使用的是nginx，openresty文件通过链接的形式，连到&#x2F;usr&#x2F;local&#x2F;openresty&#x2F;nginx&#x2F;sbin&#x2F;nginx文件，所以使用openresty与使用nginx并无太大区别。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo bin/openresty</span><br><span class="line">sudo bin/openresty -c conf/nginx.conf</span><br></pre></td></tr></table></figure>

<h3 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo bin/openresty -s stop</span><br><span class="line">sudo bin/openresty -s quit #比stop更优雅的退出</span><br></pre></td></tr></table></figure>



<h2 id="测试Lua脚本"><a href="#测试Lua脚本" class="headerlink" title="测试Lua脚本"></a>测试Lua脚本</h2><h3 id="编写Lua脚本"><a href="#编写Lua脚本" class="headerlink" title="编写Lua脚本"></a>编写Lua脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/</span><br><span class="line">sudo mkdir lua_scripts</span><br><span class="line">cd lua_scripts</span><br><span class="line">sudo vim mydata.lua</span><br></pre></td></tr></table></figure>

<p>往mydata.lua中输入内容</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> data = &#123;</span><br><span class="line">   dog = <span class="number">5</span>,</span><br><span class="line">   cat = <span class="number">3</span>,</span><br><span class="line">   pig = <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_M.get_age</span><span class="params">(name)</span></span></span><br><span class="line">   <span class="keyword">return</span> data[name]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure>



<h3 id="调整配置"><a href="#调整配置" class="headerlink" title="调整配置"></a>调整配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/openresty/nginx/conf/nginx_lua.conf</span><br></pre></td></tr></table></figure>

<h3 id="配置内容"><a href="#配置内容" class="headerlink" title="配置内容"></a>配置内容</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	lua_package_path <span class="string">&quot;/usr/local/openresty/lua_scripts/?.lua;;&quot;</span>;</span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">8080</span>;</span><br><span class="line">        location /lua &#123;</span><br><span class="line">            default_type text/html;</span><br><span class="line">            content_by_lua_block &#123;</span><br><span class="line">                <span class="keyword">local</span> mydata = <span class="keyword">require</span> <span class="string">&quot;mydata&quot;</span></span><br><span class="line">               ngx.say(mydata.get_age(<span class="string">&quot;dog&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bin/openresty -c conf/nginx_lua.conf</span><br></pre></td></tr></table></figure>

<p>有同学可能在奇怪，为什么配置文件不是nginx&#x2F;conf&#x2F;nginx_lua.conf。那是因为使用nginx&#x2F;conf&#x2F;nginx_lua.conf路径，发现报错，错误内容告诉我们找不到配置文件，错误信息里面的路径上多了一个nginx目录。</p>
<h3 id="输出内容"><a href="#输出内容" class="headerlink" title="输出内容"></a>输出内容</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/lua</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p>看到输出内容，表示已经安装成功，并且成功的访问了，实现的一个小小的lua脚本。</p>
<h2 id="使用Redis"><a href="#使用Redis" class="headerlink" title="使用Redis"></a>使用Redis</h2><p>redis_demo.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">	<span class="comment">--释放连接(Redis连接池实现)</span></span><br><span class="line">    <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span> <span class="comment">--毫秒  </span></span><br><span class="line">    <span class="keyword">local</span> pool_size = <span class="number">100</span> <span class="comment">--连接池大小  </span></span><br><span class="line">    <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">&quot;set keepalive error : &quot;</span>, err)</span><br><span class="line">    <span class="keyword">end</span> </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">--创建实例  </span></span><br><span class="line"><span class="keyword">local</span> red = redis:new()  </span><br><span class="line"><span class="comment">--设置超时（毫秒）  </span></span><br><span class="line">red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line"><span class="comment">--建立连接  </span></span><br><span class="line"><span class="keyword">local</span> ip = <span class="string">&quot;127.0.0.1&quot;</span>  </span><br><span class="line"><span class="keyword">local</span> port = <span class="number">6379</span>  </span><br><span class="line"><span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">--调用API进行处理  </span></span><br><span class="line">ok, err = red:set(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;hello world&quot;</span>)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;set msg error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">--调用API获取数据  </span></span><br><span class="line"><span class="keyword">local</span> resp, err = red:get(<span class="string">&quot;msg&quot;</span>)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;get msg error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span> close_redis(red)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">--得到的数据为空处理  </span></span><br><span class="line"><span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">    resp = <span class="string">&#x27;&#x27;</span>  <span class="comment">--比如默认值</span></span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">ngx.say(<span class="string">&quot;msg : &quot;</span>, resp)  </span><br><span class="line">  </span><br><span class="line">close_redis(red) </span><br></pre></td></tr></table></figure>

<p>nginx_lua_redis.conf文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 设置由set_by_lua， content_by_lua等指定的脚本使用的Lua模块搜索路径。类似java的classPath</span></span><br><span class="line">    <span class="comment"># 路径字符串采用标准的Lua路径形式，;; 可用于代表原始搜索路径。</span></span><br><span class="line">	<span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lua_scripts/?.lua;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 申请一个名为dogs的10m字典内存，共享在所有工作进程中</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dogs <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="section">location</span> /lua &#123;</span><br><span class="line">            <span class="attribute">default_type</span> text/html;</span><br><span class="line">            <span class="attribute">lua_code_cache</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment"># mysql只需要替换成mysql_demo.lua脚本即可</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> redis_demo.lua;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用MySQL"><a href="#使用MySQL" class="headerlink" title="使用MySQL"></a>使用MySQL</h2><p>mysql_demo.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_db</span><span class="params">(db)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    db:<span class="built_in">close</span>()  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span>(<span class="string">&quot;resty.mysql&quot;</span>)  </span><br><span class="line"><span class="comment">--创建实例  </span></span><br><span class="line"><span class="keyword">local</span> db, err = mysql:new()  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;new mysql error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">--设置超时时间(毫秒)  </span></span><br><span class="line">db:set_timeout(<span class="number">1000</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> props = &#123;  </span><br><span class="line">    host = <span class="string">&quot;127.0.0.1&quot;</span>,  </span><br><span class="line">    port = <span class="number">3306</span>,  </span><br><span class="line">    database = <span class="string">&quot;mysql&quot;</span>,  </span><br><span class="line">    user = <span class="string">&quot;root&quot;</span>,  </span><br><span class="line">    password = <span class="string">&quot;123456&quot;</span>  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> res, err, errno, sqlstate = db:connect(props)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;connect to mysql error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">--删除表  </span></span><br><span class="line"><span class="keyword">local</span> drop_table_sql = <span class="string">&quot;drop table if exists test&quot;</span>  </span><br><span class="line">res, err, errno, sqlstate = db:query(drop_table_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;drop table error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">--创建表  </span></span><br><span class="line"><span class="keyword">local</span> create_table_sql = <span class="string">&quot;create table test(id int primary key auto_increment, ch varchar(100))&quot;</span>  </span><br><span class="line">res, err, errno, sqlstate = db:query(create_table_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;create table error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">--插入  </span></span><br><span class="line"><span class="keyword">local</span> insert_sql = <span class="string">&quot;insert into test (ch) values(&#x27;hello&#x27;)&quot;</span>  </span><br><span class="line">res, err, errno, sqlstate = db:query(insert_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;insert error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line">res, err, errno, sqlstate = db:query(insert_sql)  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;insert rows : &quot;</span>, res.affected_rows, <span class="string">&quot; , id : &quot;</span>, res.insert_id, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment">--更新  </span></span><br><span class="line"><span class="keyword">local</span> update_sql = <span class="string">&quot;update test set ch = &#x27;hello2&#x27; where id =&quot;</span> .. res.insert_id  </span><br><span class="line">res, err, errno, sqlstate = db:query(update_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;update error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;update rows : &quot;</span>, res.affected_rows, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"><span class="comment">--查询  </span></span><br><span class="line"><span class="keyword">local</span> select_sql = <span class="string">&quot;select id, ch from test&quot;</span>  </span><br><span class="line">res, err, errno, sqlstate = db:query(select_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;select error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">ipairs</span>(res) <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">pairs</span>(row) <span class="keyword">do</span>  </span><br><span class="line">        ngx.say(<span class="string">&quot;select row &quot;</span>, i, <span class="string">&quot; : &quot;</span>, name, <span class="string">&quot; = &quot;</span>, value, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"><span class="comment">--防止sql注入  </span></span><br><span class="line"><span class="keyword">local</span> ch_param = ngx.req.get_uri_args()[<span class="string">&quot;ch&quot;</span>] <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>  </span><br><span class="line"><span class="comment">--使用ngx.quote_sql_str防止sql注入  </span></span><br><span class="line"><span class="keyword">local</span> query_sql = <span class="string">&quot;select id, ch from test where ch = &quot;</span> .. ngx.quote_sql_str(ch_param)  </span><br><span class="line">res, err, errno, sqlstate = db:query(query_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;select error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">ipairs</span>(res) <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">pairs</span>(row) <span class="keyword">do</span>  </span><br><span class="line">        ngx.say(<span class="string">&quot;select row &quot;</span>, i, <span class="string">&quot; : &quot;</span>, name, <span class="string">&quot; = &quot;</span>, value, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">--删除  </span></span><br><span class="line"><span class="keyword">local</span> delete_sql = <span class="string">&quot;delete from test&quot;</span>  </span><br><span class="line">res, err, errno, sqlstate = db:query(delete_sql)  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;delete error : &quot;</span>, err, <span class="string">&quot; , errno : &quot;</span>, errno, <span class="string">&quot; , sqlstate : &quot;</span>, sqlstate)  </span><br><span class="line">    <span class="keyword">return</span> close_db(db)  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line">ngx.say(<span class="string">&quot;delete rows : &quot;</span>, res.affected_rows, <span class="string">&quot;&lt;br/&gt;&quot;</span>)  </span><br><span class="line"></span><br><span class="line">close_db(db)  </span><br></pre></td></tr></table></figure>

<p>nginx_lua_mysql.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 设置由set_by_lua， content_by_lua等指定的脚本使用的Lua模块搜索路径。类似java的classPath</span></span><br><span class="line">    <span class="comment"># 路径字符串采用标准的Lua路径形式，;; 可用于代表原始搜索路径。</span></span><br><span class="line">	<span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lua_scripts/?.lua;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 申请一个名为dogs的10m字典内存，共享在所有工作进程中</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dogs <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="section">location</span> /lua &#123;</span><br><span class="line">            <span class="attribute">default_type</span> text/html;</span><br><span class="line">            <span class="attribute">lua_code_cache</span> <span class="literal">on</span>;</span><br><span class="line">            <span class="comment"># mysql只需要替换成mysql_demo.lua脚本即可</span></span><br><span class="line">            <span class="attribute">content_by_lua_file</span> mysql_demo.lua;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用HTTP客户端"><a href="#使用HTTP客户端" class="headerlink" title="使用HTTP客户端"></a>使用HTTP客户端</h2><p>OpenResty默认没有提供Http客户端，需要使用第三方提供，从github上搜索相应的客户端，比如<a target="_blank" rel="noopener" href="https://github.com/ledgetech/lua-resty-http">lua-resty-http</a></p>
<h3 id="下载插件"><a href="#下载插件" class="headerlink" title="下载插件"></a>下载插件</h3><p>​	下载lua-resty-http客户端到lualib</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/lua_scripts  </span><br><span class="line">sudo wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua </span><br><span class="line">sudo wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua</span><br></pre></td></tr></table></figure>

<h3 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/lua_scripts</span><br><span class="line">sudo vim http_demo.lua</span><br></pre></td></tr></table></figure>

<p>http_demo.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span>(<span class="string">&quot;resty.http&quot;</span>)  </span><br><span class="line"><span class="comment">--创建http客户端实例  </span></span><br><span class="line"><span class="keyword">local</span> httpc = http.new()</span><br><span class="line">  </span><br><span class="line"><span class="keyword">local</span> resp, err = httpc:request_uri(<span class="string">&quot;http://s.taobao.com&quot;</span>, &#123;  </span><br><span class="line">    method = <span class="string">&quot;GET&quot;</span>,  </span><br><span class="line">    <span class="built_in">path</span> = <span class="string">&quot;/search?q=hello&quot;</span>,</span><br><span class="line">    headers = &#123;  </span><br><span class="line">        [<span class="string">&quot;User-Agent&quot;</span>] = <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.111 Safari/537.36&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">    ngx.say(<span class="string">&quot;request error :&quot;</span>, err)  </span><br><span class="line">    <span class="keyword">return</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">--获取状态码  </span></span><br><span class="line">ngx.<span class="built_in">status</span> = resp.<span class="built_in">status</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">--获取响应头  </span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(resp.headers) <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">if</span> k ~= <span class="string">&quot;Transfer-Encoding&quot;</span> <span class="keyword">and</span> k ~= <span class="string">&quot;Connection&quot;</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx.header[k] = v  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"><span class="comment">--响应体  </span></span><br><span class="line">ngx.say(resp.body)</span><br><span class="line">  </span><br><span class="line">httpc:<span class="built_in">close</span>()  </span><br></pre></td></tr></table></figure>



<h3 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h3><p>nginx_lua_redis.conf文件，在http部分添加谷歌dns解析器，修改对应的lua脚本文件。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolver <span class="number">114.114</span>.<span class="number">114.114</span> <span class="number">8.8</span>.<span class="number">8.8</span>;</span><br></pre></td></tr></table></figure>



<h2 id="Lua模板渲染器"><a href="#Lua模板渲染器" class="headerlink" title="Lua模板渲染器"></a>Lua模板渲染器</h2><p>动态web网页开发是Web开发中一个常见的场景，Lua中也有许多模板引擎，我们通过<a target="_blank" rel="noopener" href="https://github.com/bungle/lua-resty-template">lua-resty-template</a>来完成动态页面的渲染。</p>
<h3 id="下载lua-resty-template"><a href="#下载lua-resty-template" class="headerlink" title="下载lua-resty-template"></a>下载lua-resty-template</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/lua_scripts</span><br><span class="line">wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template.lua</span><br><span class="line">mkdir /usr/example/lualib/resty/html  </span><br><span class="line">cd /usr/local/openresty/lua_scripts</span><br><span class="line">wget https://raw.githubusercontent.com/bungle/lua-resty-template/master/lib/resty/template/html.lua</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>nginx配置文件，添加模板解析路径</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先匹配nginx下面的模板目录  </span></span><br><span class="line">set $template_location <span class="string">&quot;/templates&quot;</span>;  </span><br><span class="line"><span class="comment">#然后匹配指定的模板根目录，我们这里是/usr/local/openresty/lua_scripts</span></span><br><span class="line">set $template_root <span class="string">&quot;/usr/local/openresty/lua_scripts&quot;</span>;</span><br><span class="line"><span class="comment">#或者通过root指令来切换路径</span></span><br><span class="line">root /usr/<span class="keyword">local</span>/openresty/lua_scripts;</span><br></pre></td></tr></table></figure>

<p>lua内容，html_template.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> template = <span class="built_in">require</span>(<span class="string">&quot;resty.template&quot;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> context = &#123;  </span><br><span class="line">    title = <span class="string">&quot;lua模板渲染&quot;</span>,  </span><br><span class="line">    name = <span class="string">&quot;hash同学&quot;</span>,  </span><br><span class="line">    description = <span class="string">&quot;&lt;script&gt;alert(1);&lt;/script&gt;&quot;</span>,  </span><br><span class="line">    age = <span class="number">20</span>,  </span><br><span class="line">    hobby = &#123;<span class="string">&quot;电影&quot;</span>, <span class="string">&quot;音乐&quot;</span>, <span class="string">&quot;阅读&quot;</span>&#125;,  </span><br><span class="line">    score = &#123;语文 = <span class="number">90</span>, 数学 = <span class="number">80</span>, 英语 = <span class="number">70</span>&#125;,  </span><br><span class="line">    score2 = &#123;  </span><br><span class="line">        &#123;name = <span class="string">&quot;语文&quot;</span>, score = <span class="number">90</span>&#125;,  </span><br><span class="line">        &#123;name = <span class="string">&quot;数学&quot;</span>, score = <span class="number">80</span>&#125;,  </span><br><span class="line">        &#123;name = <span class="string">&quot;英语&quot;</span>, score = <span class="number">70</span>&#125;,  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line">template.render(<span class="string">&quot;resty_template.html&quot;</span>, context)</span><br></pre></td></tr></table></figure>

<p>resty_template.html文件的html内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;* titile *&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        &#123;# 不转义变量输出 #&#125;  </span><br><span class="line">        姓名：&#123;* string.upper(name) *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">        &#123;# 转义变量输出 #&#125;  </span><br><span class="line">        简介：&#123;&#123;description&#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        &#123;# 可以做一些运算 #&#125;  </span><br><span class="line">        年龄: &#123;* age + 1 *&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">        &#123;# 循环输出 #&#125;  </span><br><span class="line">        爱好：  </span><br><span class="line">        &#123;% for i, v in ipairs(hobby) do %&#125;  </span><br><span class="line">           &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">           &#123;* v *&#125;  </span><br><span class="line">        &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line"></span><br><span class="line">        成绩：  </span><br><span class="line">        &#123;% local i = 1; %&#125;  </span><br><span class="line">        &#123;% for k, v in pairs(score) do %&#125;  </span><br><span class="line">           &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">           &#123;* k *&#125; = &#123;* v *&#125;  </span><br><span class="line">           &#123;% i = i + 1 %&#125;  </span><br><span class="line">        &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">        成绩2：  </span><br><span class="line">        &#123;% for i = 1, #score2 do local t = score2[i] %&#125;  </span><br><span class="line">           &#123;% if i &gt; 1 then %&#125;，&#123;% end %&#125;  </span><br><span class="line">            &#123;* t.name *&#125; = &#123;* t.score *&#125;  </span><br><span class="line">        &#123;% end %&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  </span><br><span class="line">        &#123;# 中间内容不解析 #&#125;  </span><br><span class="line">        &#123;-raw-&#125;&#123;(file)&#125;&#123;-raw-&#125;  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;* var *&#125;：变量输出；</span><br><span class="line"></span><br><span class="line">&#123;&#123; var &#125;&#125;：变量转义输出；</span><br><span class="line"></span><br><span class="line">&#123;% code %&#125;：代码片段；</span><br><span class="line"></span><br><span class="line">&#123;# comment #&#125;：注释；</span><br><span class="line"></span><br><span class="line">&#123;-raw-&#125;：中间的内容不会解析，作为纯文本输出；</span><br><span class="line"></span><br><span class="line">&#123;(include_file)&#125;：包含另一个模板文件</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/03-02-OpenResty%E5%AE%89%E8%A3%85%E6%93%8D%E4%BD%9C/" data-id="clmcxecc5002su8wa1ztv8khd" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/03-01-Nginx嵌入Lua脚本语言操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/03-01-Nginx%E5%B5%8C%E5%85%A5Lua%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.793Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Nginx-Lua模块安装手册"><a href="#Nginx-Lua模块安装手册" class="headerlink" title="Nginx_Lua模块安装手册"></a>Nginx_Lua模块安装手册</h1><p>为Nginx提供通过Lua脚本能够访问Redis的能力，可以通过集成nginx_lua、lua_redis模块来实现。</p>
<blockquote>
<p>参考项：<a target="_blank" rel="noopener" href="https://github.com/openresty/lua-nginx-module#installation">https://github.com/openresty/lua-nginx-module#installation</a></p>
</blockquote>
<h2 id="安装编译Nginx"><a href="#安装编译Nginx" class="headerlink" title="安装编译Nginx"></a>安装编译Nginx</h2><h3 id="安装依赖项"><a href="#安装依赖项" class="headerlink" title="安装依赖项"></a>安装依赖项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lua_jit</span></span><br><span class="line">wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz </span><br><span class="line">tar -xvf LuaJIT-2.0.5.tar.gz</span><br><span class="line">cd LuaJIT-2.0.5</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="下载安装nginx和依赖项"><a href="#下载安装nginx和依赖项" class="headerlink" title="下载安装nginx和依赖项"></a>下载安装nginx和依赖项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">tar -xvf nginx-1.14.2.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ndk</span></span><br><span class="line">wget https://github.com/simplresty/ngx_devel_kit/archive/v0.3.0.zip </span><br><span class="line">unzip v0.3.0.zip </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ngx_lua 模块</span></span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.14.zip</span><br><span class="line">unzip v0.10.14.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装nginx</span></span><br><span class="line">cd nginx-1.14.2</span><br><span class="line">./configure --prefix=/usr/local/nginx-1.14.2 \</span><br><span class="line">         --add-module=../ngx_devel_kit-0.3.0 \</span><br><span class="line">         --add-module=../lua-nginx-module-0.10.14</span><br></pre></td></tr></table></figure>

<h3 id="测试lua模块是否安装成功"><a href="#测试lua模块是否安装成功" class="headerlink" title="测试lua模块是否安装成功"></a>测试lua模块是否安装成功</h3><h4 id="0-创建一个文件夹存储lua脚本"><a href="#0-创建一个文件夹存储lua脚本" class="headerlink" title="0 创建一个文件夹存储lua脚本"></a>0 创建一个文件夹存储lua脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx-1.14.2/lua_scripts</span><br></pre></td></tr></table></figure>

<h4 id="1-创建mydata-lua"><a href="#1-创建mydata-lua" class="headerlink" title="1 创建mydata.lua"></a>1 创建mydata.lua</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mydata.lua</span></span><br><span class="line"> <span class="keyword">local</span> _M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">local</span> data = &#123;</span><br><span class="line">     dog = <span class="number">3</span>,</span><br><span class="line">     cat = <span class="number">4</span>,</span><br><span class="line">     pig = <span class="number">5</span>,</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">_M.get_age</span><span class="params">(name)</span></span></span><br><span class="line">     <span class="keyword">return</span> data[name]</span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure>

<h4 id="2-nginx-conf文件"><a href="#2-nginx-conf文件" class="headerlink" title="2 nginx.conf文件"></a>2 nginx.conf文件</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lua_package_path <span class="string">&quot;/usr/local/nginx-1.14.2/lua_scripts/?.lua;;&quot;</span>;</span><br><span class="line"> server &#123;</span><br><span class="line">     ...</span><br><span class="line">     location /lua &#123;</span><br><span class="line">         content_by_lua_block &#123;</span><br><span class="line">            <span class="keyword">local</span> mydata = <span class="keyword">require</span> <span class="string">&quot;mydata&quot;</span></span><br><span class="line">            ngx.say(mydata.get_age(<span class="string">&quot;dog&quot;</span>))</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h3 id="可能的错误"><a href="#可能的错误" class="headerlink" title="可能的错误"></a>可能的错误</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、动态库找不到</span></span><br><span class="line">./sbin/nginx: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决办法：</span></span><br><span class="line">echo &quot;/usr/local/lib&quot; &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">ldconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、warn提示</span></span><br><span class="line">nginx: [alert] detected a LuaJIT version which is not OpenResty&#x27;s; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty&#x27;s LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">告诉你，你不要用这个luajit版本，可以用openresty提供的luajit优化版本，或者干脆直接用openresty</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="安装lua-redis"><a href="#安装lua-redis" class="headerlink" title="安装lua_redis"></a>安装lua_redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://codeload.github.com/openresty/lua-resty-redis/zip/master</span><br><span class="line">unzip master</span><br><span class="line">cd lua-resty-redis-master</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/03-01-Nginx%E5%B5%8C%E5%85%A5Lua%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%93%8D%E4%BD%9C/" data-id="clmcxecc0002ru8wa9ul7dm08" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-16-Nginx/03-00-Lua扩展Nginx" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/16-Nginx/03-00-Lua%E6%89%A9%E5%B1%95Nginx/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.786Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Lua脚本简述"><a href="#Lua脚本简述" class="headerlink" title="Lua脚本简述"></a>Lua脚本简述</h1><h2 id="Lua脚本语言"><a href="#Lua脚本语言" class="headerlink" title="Lua脚本语言"></a>Lua脚本语言</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.lua.org/">https://www.lua.org</a></p>
<p>Lua是一种功能强大，高效，轻量级，可嵌入的脚本语言，非常容易嵌入到我们应用程序中。</p>
<p>Lua是动态类型的，通过使用基于寄存器的虚拟机解释字节码来运行，并具有增量垃圾收集的自动内存管理，使其成为配置，脚本和快速原型设计的理想选择。</p>
<p>Lua旨在成为一种轻量级可嵌入脚本语言。它用于各种应用程序，从游戏到Web应用程序和图像处理。</p>
<p><strong>应用场景</strong></p>
<ol>
<li>许多工业应用 （例如， Adobe的Photoshop Lightroom）</li>
<li>重点是嵌入式系统（例如， 巴西的数字电视的 Ginga中间件）</li>
<li>Lua目前 是游戏中领先的脚本语言，在游戏 （例如， 魔兽世界和愤怒的小鸟）中使用。</li>
</ol>
<h2 id="Lua脚本特点"><a href="#Lua脚本特点" class="headerlink" title="Lua脚本特点"></a>Lua脚本特点</h2><p><strong>快</strong>，Lua是解释脚本语言领域中最快的语言</p>
<p><strong>Lua是便携式的</strong>，在具有标准C编译器的所有平台中构建成开箱即用，可运行各种Unix和Windows，移动设备（运行Android，iOS，BREW，Symbian，Windows Phone），嵌入式微处理器（如ARM和Rabbit，适用于Lego MindStorms等应用程序），IBM大型机等。</p>
<p><strong>可嵌入</strong>，Lua是一种快速语言引擎，占用空间小，可以轻松嵌入到应用程序中。</p>
<p><strong>简单而强大</strong>，提供实现功能的元机制，而不是直接在语言中提供大量功能。Lua不是纯粹的面向对象语言，提供了现类和继承的元机制。</p>
<p><strong>小</strong>，源包含大约24000行C，包含源代码和文档的Lua 5.3.5的tar包需要297K压缩和1.2M未压缩。</p>
<p><strong>免费</strong>，MIT许可证，可以用于任何目的，包括商业目的，完全免费。</p>
<h2 id="开始使用Lua"><a href="#开始使用Lua" class="headerlink" title="开始使用Lua"></a>开始使用Lua</h2><p>安装Lua</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz </span><br><span class="line">tar zxf lua-5.3.5.tar.gz </span><br><span class="line">cd lua-5.3.5 </span><br><span class="line">make linux test</span><br></pre></td></tr></table></figure>

<p>Hello World</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lua</span><br><span class="line">Lua 5.1.4 Copyright (C) 1994-2008 Lua.org, PUC-Rio</span><br><span class="line">&gt; print(&quot;hello, world&quot;)</span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure>

<h2 id="一个小例子"><a href="#一个小例子" class="headerlink" title="一个小例子"></a>一个小例子</h2><p>新建hello.lua文件，Lua实现的阶乘代码示例，内容如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- defines a factorial function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fact</span> <span class="params">(n)</span></span></span><br><span class="line">  <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> n * fact(n<span class="number">-1</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;enter a number:&quot;</span>)</span><br><span class="line">a = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>) <span class="comment">-- read a number</span></span><br><span class="line"><span class="built_in">print</span>(fact(a))</span><br></pre></td></tr></table></figure>

<p>运行示例hello.lua文件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lua hello.lua</span><br><span class="line">enter a number:</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">120</span> # <span class="number">120</span>=<span class="number">5</span>*<span class="number">4</span>*<span class="number">3</span>*<span class="number">2</span>*<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>语法比Java要简略，缩进对齐，无大括号分号</p>
<h1 id="Nginx增加Lua执行模块"><a href="#Nginx增加Lua执行模块" class="headerlink" title="Nginx增加Lua执行模块"></a>Nginx增加Lua执行模块</h1><h2 id="Nginx嵌入Lua脚本语言"><a href="#Nginx嵌入Lua脚本语言" class="headerlink" title="Nginx嵌入Lua脚本语言"></a>Nginx嵌入Lua脚本语言</h2><p>ngx_lua模块资料：<a target="_blank" rel="noopener" href="https://github.com/openresty/lua-nginx-module">https://github.com/openresty/lua-nginx-module</a></p>
<p><strong>ngx_lua模块</strong></p>
<p>不鼓励自己用Nginx构建这个模块，自己构建需要注意，Nginx，LuaJIT和OpenSSL官方发行版具有各种限制和长期存在的错误，这些错误可能会导致某些模块的功能被禁用，无法正常运行或运行速度变慢。如何编译，<strong>参考《Nginx嵌入Lua脚本语言操作》</strong>手册。</p>
<p>使用ngx_lua模块相当于使用Openresty，建议用官方版本OpenResty，它做了大量优化、集成了常用的第三方插件。</p>
<p><strong>OpenResty</strong></p>
<p>OpenResty是一款基于NGINX 和 LuaJIT 的Web 平台。</p>
<p>OpenResty内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>OpenResty的安装参考《OpenResty安装操作》，比构建ngx_lua模块简单很多</p>
<h2 id="ngx-lua支持的指令"><a href="#ngx-lua支持的指令" class="headerlink" title="ngx_lua支持的指令"></a>ngx_lua支持的指令</h2><p><strong>认识ngx_lua中的指令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">指令分为配置指令、控制指令。</span><br><span class="line">控制指令分为两种方式：</span><br><span class="line">  lua脚本块*_by_lua_block</span><br><span class="line">  lua脚本文件*_by_lua_file</span><br><span class="line">Lua脚本执行顺序，如下图从上至下：初始化、重写/访问、内容处理、日志输出四个阶段。</span><br><span class="line">内容处理可以由上游服务或者Lua脚本语言来处理，用Lua脚本就大有可为了。</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221016153403.png"></p>
<h2 id="ngx-lua演示"><a href="#ngx-lua演示" class="headerlink" title="ngx_lua演示"></a>ngx_lua演示</h2><p>在OpenResty中演示ngx_lua的指令</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># 设置由set_by_lua， content_by_lua等指定的脚本使用的Lua模块搜索路径。类似java的classPath</span></span><br><span class="line">    <span class="comment"># 路径字符串采用标准的Lua路径形式，;; 可用于代表原始搜索路径。</span></span><br><span class="line">	<span class="attribute">lua_package_path</span> <span class="string">&quot;/usr/local/openresty/lua_scripts/?.lua;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 申请一个名为dogs的10m字典内存，共享在所有工作进程中</span></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> dogs <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 在服务器启动时预加载Lua模块，并利用现代操作系统的写时复制（COW）优化。</span></span><br><span class="line">    <span class="section">init_by_lua_block</span> &#123;</span><br><span class="line">        -- 预加载json模块</span><br><span class="line">        <span class="attribute">require</span> <span class="string">&quot;cjson&quot;</span></span><br><span class="line"></span><br><span class="line">        -- 操作共享内存</span><br><span class="line">        local dogs = ngx.shared.dogs;</span><br><span class="line">        dogs:set(&quot;Tom&quot;, 56)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">        <span class="section">location</span> /lua &#123;</span><br><span class="line">            <span class="attribute">default_type</span> text/html;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在location、location if上下文中使用。充当“内容处理程序”并执行指定的lua脚本内容，</span></span><br><span class="line">            <span class="comment"># Lua代码可以进行API调用，并在独立的全局环境（即沙箱）中作为新的衍生协程执行</span></span><br><span class="line">            <span class="section">content_by_lua_block</span> &#123;</span><br><span class="line">                <span class="attribute">local</span> mydata = require <span class="string">&quot;mydata&quot;</span></span><br><span class="line">                ngx.say(mydata.get_age(<span class="string">&quot;dog&quot;</span>))</span><br><span class="line"></span><br><span class="line">                -- require关键字会返回init_by_lua_block中已经预加载了cjson模块</span><br><span class="line">                ngx.say(require <span class="string">&quot;cjson&quot;</span>.encode&#123;<span class="attribute">dog</span> = <span class="number">5</span>, cat = <span class="number">6</span>&#125;)</span><br><span class="line"></span><br><span class="line">                -- 读取共享内存中的信息</span><br><span class="line">                local dogs = ngx.shared.dogs;</span><br><span class="line">                ngx.say(dogs:get(&quot;Tom&quot;))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>redis、mysql、http、html等lua操作参考《OpenResty安装操作》文件</p>
<h1 id="打造高性能后端接口"><a href="#打造高性能后端接口" class="headerlink" title="打造高性能后端接口"></a>打造高性能后端接口</h1><h2 id="OpenResty-Redis模块"><a href="#OpenResty-Redis模块" class="headerlink" title="OpenResty Redis模块"></a>OpenResty Redis模块</h2><p>OpenResty中默认嵌入了下列模块，包含Redis，所以要使用Redis非常简单。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221022162241.png"></p>
<p>Lua中使用Redis代码示例</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 引入Redis模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"><span class="comment">--创建实例</span></span><br><span class="line"><span class="keyword">local</span> red = redis:new() </span><br><span class="line"><span class="comment">--建立连接</span></span><br><span class="line"><span class="keyword">local</span> ok, err = red:connect(“<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>”, <span class="number">6379</span>)</span><br><span class="line"><span class="comment">--调用API进行处理</span></span><br><span class="line">ok, err = red:set(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> resp, err = red:get(<span class="string">&quot;msg&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Nginx非阻塞与Lua协程的绝配"><a href="#Nginx非阻塞与Lua协程的绝配" class="headerlink" title="Nginx非阻塞与Lua协程的绝配"></a>Nginx非阻塞与Lua协程的绝配</h2><p>服务器有个设计原则：永远不能阻塞。</p>
<p>nginx作为非常优秀的服务器，这点发挥的非常极致。在nginx里有很多的体现异步的地方。</p>
<p>Lua嵌入会阻塞吗?</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- foo本身是个协程，由nginx调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span> </span><br><span class="line">    <span class="comment">-- 此处由nginx发起db的连接请求，因为异步这里先暂停协程</span></span><br><span class="line">    users = db.query(<span class="string">&#x27;users&#x27;</span>, &#123;name: name&#125;); </span><br><span class="line">    <span class="comment">-- 当请求有响应得到处理时，继续执行协程，这些才运行</span></span><br><span class="line">    deal_with(users); </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>通过nginx的异步机制和lua的协程，很容易实现这种同步写法，异步实现的模型，但对开发人员而言，不用关心内部做了什么。</p>
<h2 id="Lua协程"><a href="#Lua协程" class="headerlink" title="Lua协程"></a>Lua协程</h2><p><strong>什么是协程？</strong></p>
<p>Lua协程，称为<strong>协作式多线程</strong>。Lua中的协程代表一个独立的执行线程，具有自己的堆栈、自己的局部变量、PC计数器和其自己的指令指针; 与java线程不同的是，协程只通过显式调用yield函数来暂停其执行。同一时间，多协程只运行其中一个，java多线程则可以运行多个。协程可以处于三种不同状态之一：<strong>暂停，运行和死亡</strong></p>
<p><strong>使用Lua协程</strong></p>
<p>coroutine.create(f)：创建一个新的协同程序并返回一个类型为thread的对象，并不启动协程。</p>
<p>coroutine.resume(co)：开始或继续执行协同程序co</p>
<p>coroutine.yield：暂停执行调用协程，让出CPU</p>
<p>coroutine.wrap(f)：类似create方法，创建一个协程但它不是返回协程本身，而是返回一个函数，当被调用时，它恢复协程</p>
<h2 id="Lua协程示例"><a href="#Lua协程示例" class="headerlink" title="Lua协程示例"></a>Lua协程示例</h2><p>同步的写法，异步的实现</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, i)</span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co) <span class="comment">-- 输出 co 1</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co) <span class="comment">-- 输出 co 2</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co) <span class="comment">-- 输出 co 3</span></span><br></pre></td></tr></table></figure>

<h1 id="功能实战"><a href="#功能实战" class="headerlink" title="功能实战"></a>功能实战</h1><h2 id="商品页面需求"><a href="#商品页面需求" class="headerlink" title="商品页面需求"></a>商品页面需求</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221022163133.png"></p>
<p>商品页主要包括商品基本信息、商品介绍、其他信息。</p>
<p>商品基本信息：</p>
<p>基本信息、图片列表、颜色&#x2F;尺码关系、扩展属性、规格参数、包装清单、售后保障等</p>
<p>其他信息：</p>
<p>分类、品牌、店铺【第三方卖家】、店内分类【第三方卖家】、同类相关品牌</p>
<p>亿级别的商品数量，每次动态获取上面内容进行模板拼装，数据来源多到造成性能无法满足要求，而且页面需要动态支持多套模板，怎么处理？</p>
<h2 id="商品页面功能设计"><a href="#商品页面功能设计" class="headerlink" title="商品页面功能设计"></a>商品页面功能设计</h2><p>可以通过Nginx的API服务功能来实现</p>
<p>将需要的数据准备好，通过Lua访问Redis获取得，再由Lua生成json数据，交给Lua模板解析器，通过Lua模板解析器，来完成模板数据的动态生成。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221022163509.png"></p>
<h2 id="商品页面功能实现"><a href="#商品页面功能实现" class="headerlink" title="商品页面功能实现"></a>商品页面功能实现</h2><p><strong>程序实现</strong></p>
<p>goods&#x2F;info?goodsId&#x3D;234</p>
<p>github：<a target="_blank" rel="noopener" href="https://github.com/chengchen901/nginx-balancer-demo.git">https://github.com/chengchen901/nginx-balancer-demo.git</a></p>
<p><strong>Lua脚本实现</strong></p>
<p>commond.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> ngx_log = ngx.<span class="built_in">log</span></span><br><span class="line"><span class="keyword">local</span> ngx_ERR = ngx.ERR  </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> red <span class="keyword">then</span>  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="comment">--释放连接(连接池实现)  </span></span><br><span class="line">    <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span> <span class="comment">--毫秒  </span></span><br><span class="line">    <span class="keyword">local</span> pool_size = <span class="number">100</span> <span class="comment">--连接池大小  </span></span><br><span class="line">    <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;set redis keepalive error : &quot;</span>, err)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_redis</span><span class="params">(ip, port, keys)</span></span>  </span><br><span class="line">    <span class="keyword">local</span> red = redis:new()  </span><br><span class="line">    red:set_timeout(<span class="number">1000</span>)  </span><br><span class="line">    <span class="keyword">local</span> ok, err = red:connect(ip, port)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;connect to redis error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">local</span> resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">if</span> #keys == <span class="number">1</span> <span class="keyword">then</span>  </span><br><span class="line">        resp, err = red:get(keys[<span class="number">1</span>])  </span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line">        resp, err = red:mget(keys)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;get redis content error : &quot;</span>, err)  </span><br><span class="line">        <span class="keyword">return</span> close_redis(red)  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">--得到的数据为空处理  </span></span><br><span class="line">    <span class="keyword">if</span> resp == ngx.null <span class="keyword">then</span>  </span><br><span class="line">        resp = <span class="literal">nil</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    close_redis(red)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> resp  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_http</span><span class="params">(args)</span></span>  </span><br><span class="line">    <span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/goods/info&quot;</span>, &#123;</span><br><span class="line">        method = ngx.HTTP_GET,</span><br><span class="line">        args = args</span><br><span class="line">    &#125;)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error&quot;</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">if</span> resp.<span class="built_in">status</span> ~= <span class="number">200</span> <span class="keyword">then</span>  </span><br><span class="line">        ngx_log(ngx_ERR, <span class="string">&quot;request error, status :&quot;</span>, resp.<span class="built_in">status</span>)  </span><br><span class="line">        <span class="keyword">return</span>  </span><br><span class="line">    <span class="keyword">end</span>  </span><br><span class="line">    <span class="keyword">return</span> resp.body  </span><br><span class="line"><span class="keyword">end</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _M = &#123;  </span><br><span class="line">    read_redis = read_redis,</span><br><span class="line">    read_http = read_http</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure>

<p>goods_template.lua</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Nginx配置文件实现</strong></p>
<p>nginx_goods_template.conf</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong>初始Lua脚本语言</strong></p>
<p>脚本语言的特点</p>
<p><strong>给老虎插上翅膀</strong></p>
<p>Nginx+Lua、ngx_lua模块指令、指令执行顺序及阶段</p>
<p><strong>高性能接口</strong></p>
<p>ngx_lua中的第三方模块（ Redis 、MySQL、HTTP、Template）</p>
<p>为什么Nginx与Lua协程天生绝配？</p>
<p><strong>商品页面实战</strong></p>
<p>redis、nginx_lua、lua-resty-redis、lua-resty-template</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/16-Nginx/03-00-Lua%E6%89%A9%E5%B1%95Nginx/" data-id="clmcxecbq002nu8wa4t7t3xhr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>