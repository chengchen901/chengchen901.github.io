<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-18-MongoDB/01-从关系型数据库到MongoDB特性入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/18-MongoDB/01-%E4%BB%8E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%B0MongoDB%E7%89%B9%E6%80%A7%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.938Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="NoSQL数据库及排名"><a href="#NoSQL数据库及排名" class="headerlink" title="NoSQL数据库及排名"></a>NoSQL数据库及排名</h1><h2 id="什么是NoSQL"><a href="#什么是NoSQL" class="headerlink" title="什么是NoSQL"></a>什么是NoSQL</h2><p><strong>SQL</strong>：结构化查询语言，这里泛指关系型数据库</p>
<p><strong>NoSQL</strong>(NoSQL &#x3D; Not Only SQL )，意即“不仅仅是SQL”，泛指不提供SQL功能的非关系型数据库。不遵循，SQL标准、ACID特性、表结构。这个概念很早就有人提出，当时做Not SQL解释，逐渐发展到今天的Not Only SQL。</p>
<h2 id="为什么需要NoSQL"><a href="#为什么需要NoSQL" class="headerlink" title="为什么需要NoSQL"></a>为什么需要NoSQL</h2><ul>
<li>现代网站服务，是超大规模和高并发的SNS类型的web2.0纯动态网站</li>
<li>传统关系型数据库遇到了性能、扩展瓶颈</li>
<li>NoSQL数据库为了解决大规模数据集合、多重数据种类带来的挑战而产生</li>
<li>应用在大数据应用难题，包括超大规模数据的存储</li>
</ul>
<h2 id="四大类NoSQL数据库"><a href="#四大类NoSQL数据库" class="headerlink" title="四大类NoSQL数据库"></a>四大类NoSQL数据库</h2><table>
<thead>
<tr>
<th>分类</th>
<th>优势</th>
<th>劣势</th>
<th>场景</th>
<th>代表</th>
</tr>
</thead>
<tbody><tr>
<td>键值对</td>
<td>查找速度快</td>
<td>数据无结构化，通常只被当做字符串或者二进制数据</td>
<td>内容缓存，主要用于处理大量数据的高频访问负载</td>
<td>Redis</td>
</tr>
<tr>
<td>列式存储</td>
<td>查找速度快，支持分布式横向扩展，数据压缩率高</td>
<td>功能相对受限</td>
<td>分布式文件系统</td>
<td>Hbase<br />Cassandra</td>
</tr>
<tr>
<td>文档存储</td>
<td>数据结构要求不严格，表结构可变</td>
<td>查询性能不高，缺乏统一的查询语法</td>
<td>web应用</td>
<td>MongoDB</td>
</tr>
<tr>
<td>图数据库</td>
<td>可利用图结构相关算法</td>
<td>可能需要对整个图做计算，不利于图数据分布式存储</td>
<td>社交网络、推荐系统、意向图、消费图、兴趣图、关系图谱等</td>
<td>Neo4J<br />CouchDB</td>
</tr>
</tbody></table>
<h2 id="数据库排名"><a href="#数据库排名" class="headerlink" title="数据库排名"></a>数据库排名</h2><p>数据库整体排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a></p>
<p>关系型数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/relational+dbms">https://db-engines.com/en/ranking/relational+dbms</a></p>
<p>键值对数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/key-value+store">https://db-engines.com/en/ranking/key-value+store</a></p>
<p>搜索引擎排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/search+engine">https://db-engines.com/en/ranking/search+engine</a></p>
<p>图形数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/graph+dbms">https://db-engines.com/en/ranking/graph+dbms</a></p>
<p>文档型数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking/document+store">https://db-engines.com/en/ranking/document+store</a></p>
<h2 id="NoSQL关系型数据库对比"><a href="#NoSQL关系型数据库对比" class="headerlink" title="NoSQL关系型数据库对比"></a>NoSQL关系型数据库对比</h2><table>
<thead>
<tr>
<th>特点</th>
<th>NoSQL</th>
<th>关系型数据库</th>
</tr>
</thead>
<tbody><tr>
<td>强一致性和弱一致性</td>
<td>CAP定理，最终一致性，而非ACID属性</td>
<td>严格的一致性，ACID</td>
</tr>
<tr>
<td>二维和多维表</td>
<td>键 - 值对存储，列存储，文档存储，图形数据库</td>
<td>二维表，数据和关系都存储在单独的表中</td>
</tr>
<tr>
<td>结构化和非结构化</td>
<td>非结构化、半结构化，没有声明性查询语言</td>
<td>高度组织化结构化数据，结构化查询语言（SQL）</td>
</tr>
<tr>
<td>强事务和弱事务</td>
<td>弱化事务</td>
<td>基础事务</td>
</tr>
<tr>
<td>Join强与弱</td>
<td>弱，没有预定义的模式</td>
<td>强，数据操纵语言，数据定义语言</td>
</tr>
<tr>
<td>成本代价</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>扩展性</td>
<td>强，高性能，高可用性和可伸缩性</td>
<td>弱</td>
</tr>
</tbody></table>
<h1 id="Mongo核心概念"><a href="#Mongo核心概念" class="headerlink" title="Mongo核心概念"></a>Mongo核心概念</h1><h2 id="什么是MongoDB？"><a href="#什么是MongoDB？" class="headerlink" title="什么是MongoDB？"></a>什么是MongoDB？</h2><p>MongoDB是一个基于C++开发的NoSQL开源文档数据库，具有所需的可伸缩性和灵活性，可用于所需的查询和索引编制。最像关系数据库，功能最丰富的NoSQL数据库。</p>
<p><strong>特性</strong></p>
<ul>
<li>面向集合文档的存储：适合存储Bson（json的扩展）形式的数据；</li>
<li>格式自由，数据格式不固定，生产环境下修改结构都可以不影响程序运行；</li>
<li>强大的查询语句，面向对象的查询语言，基本覆盖sql语言所有能力；</li>
<li>完整的索引支持，支持查询计划；</li>
<li>支持复制和自动故障转移；</li>
<li>支持二进制数据及大型对象（文件）的高效存储；</li>
<li>使用分片集群提升系统扩展性；</li>
<li>使用内存映射存储引擎，把磁盘的IO操作转换成为内存的操作；</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.mongodb.com/">https://docs.mongodb.com/</a></p>
<h2 id="为什么要学习MongoDB？"><a href="#为什么要学习MongoDB？" class="headerlink" title="为什么要学习MongoDB？"></a>为什么要学习MongoDB？</h2><p>国内外知名互联网公司都在使用</p>
<p>MongoDB应用的行业领域非常多，面向未来大量数据存储，向钱看，MongoDB必学。</p>
<h2 id="如何考虑是否选择MongoDB？"><a href="#如何考虑是否选择MongoDB？" class="headerlink" title="如何考虑是否选择MongoDB？"></a>如何考虑是否选择MongoDB？</h2><p>没有某个业务场景必须要使用MongoDB才能解决，但使用MongoDB通常能让你以更低的成本解决问题（包括学习、开发、运维等成本）</p>
<p><strong>应用需求和特点</strong></p>
<ul>
<li>不需要事务及复杂join支持</li>
<li>新应用，需求会变，数据模型不确定，想快速迭代开发</li>
<li>要应对2000-3000以上的读写QPS（或更高）</li>
<li>要存储TB甚至PB级别数据</li>
<li>应用发展迅速，能快速水平扩展</li>
<li>要求存储的数据不丢失</li>
<li>要求99.999%高可用</li>
<li>有大量的地理位置查询、文本查询</li>
</ul>
<p><strong>只要有一项需求满足就可以考虑，匹配越多，选择MongoDB越合适</strong></p>
<h2 id="MongoDB的使用场景"><a href="#MongoDB的使用场景" class="headerlink" title="MongoDB的使用场景"></a>MongoDB的使用场景</h2><p>MongoDB 的应用已经渗透到各个领域，比如游戏、物流、电商、内容管理、社交、物联网、视频直播等，以下是几个实际的应用案例：</p>
<ul>
<li>游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、更新</li>
<li>物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。</li>
<li>社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能</li>
<li>物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析</li>
<li>视频直播，使用 MongoDB 存储用户信息、礼物信息等</li>
</ul>
<h2 id="什么场景不适合使用MongoDB？"><a href="#什么场景不适合使用MongoDB？" class="headerlink" title="什么场景不适合使用MongoDB？"></a>什么场景不适合使用MongoDB？</h2><ol>
<li>高度事务性系统：例如银行、财务等系统。MongoDB对事物的支持较弱；</li>
<li>传统的商业智能应用：特定问题的数据分析，多数据实体关联，涉及到复杂的、高度优化的查询方式；</li>
<li>使用sql方便的时候；数据结构相对固定，使用sql进行查询统计更加便利的时候；</li>
</ol>
<h2 id="MongoDB中的基本概念"><a href="#MongoDB中的基本概念" class="headerlink" title="MongoDB中的基本概念"></a>MongoDB中的基本概念</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230128125820.png"></p>
<ul>
<li><strong>实例：</strong>系统上运行库的进程及节点集，一个实例可以有多个库</li>
<li><strong>库：</strong>多个集合组成数据库，每个数据库都是完全独立的，有自己<br>的用户、权限信息，独立的存储文件集</li>
<li><strong>集合：</strong>即一组文档的集合，文档是存放的数据。集合内的文档结<br>构可以不同</li>
<li><strong>文档：</strong>MongoDB数据库的最小数据集单位，其基本概念为：多个<br>键值对有序组合在一起的数据单元</li>
</ul>
<h2 id="与关系型数据库对比"><a href="#与关系型数据库对比" class="headerlink" title="与关系型数据库对比"></a>与关系型数据库对比</h2><p>可执行文件名对比</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>MongoDB</th>
<th>MySQL</th>
</tr>
</thead>
<tbody><tr>
<td>服务</td>
<td>mongod</td>
<td>mysqld</td>
</tr>
<tr>
<td>客户端</td>
<td>mongo</td>
<td>mysql</td>
</tr>
</tbody></table>
<p>概念对比</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>MongoDB</th>
<th>关系型数据库</th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>dataBase</td>
<td>dataBase</td>
</tr>
<tr>
<td>表</td>
<td>collection</td>
<td>table</td>
</tr>
<tr>
<td>数据行</td>
<td>document</td>
<td>row data</td>
</tr>
<tr>
<td>字段</td>
<td>field</td>
<td>column</td>
</tr>
<tr>
<td>索引</td>
<td>index</td>
<td>index</td>
</tr>
<tr>
<td>表关联</td>
<td>embedding&amp;linkding</td>
<td>join</td>
</tr>
<tr>
<td>分片&#x2F;分区</td>
<td>shard</td>
<td>partition</td>
</tr>
<tr>
<td>分区键</td>
<td>sharding Key</td>
<td>partition key</td>
</tr>
</tbody></table>
<h2 id="MongoDB中的文档"><a href="#MongoDB中的文档" class="headerlink" title="MongoDB中的文档"></a>MongoDB中的文档</h2><p>MongoDB文档类似于JSON对象，称为BSON。字段的值可以包括其他文档，数组和文档数组。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230128130628.png"></p>
<p><strong>使用文档存储的优点：</strong> </p>
<ul>
<li>文档（即对象）对应于许多编程语言中的本机数据类型</li>
<li>嵌入式文档和数组减少了对连接的需求</li>
<li>动态模式支持流畅的多态性</li>
</ul>
<h2 id="MongoDB中的Bson数据类型"><a href="#MongoDB中的Bson数据类型" class="headerlink" title="MongoDB中的Bson数据类型"></a>MongoDB中的Bson数据类型</h2><p>Bson是JSON文档的二进制表示形式，它包含比JSON更多的数据类型。</p>
<p>MongoDB中，一个BSON文档最大大小为16M，文档嵌套的级别不超过100</p>
<p>Bson文档规范：<a target="_blank" rel="noopener" href="http://bsonspec.org/spec.html">http://bsonspec.org/spec.html</a></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Number</th>
<th>Alias</th>
<th>Notes</th>
</tr>
</thead>
<tbody><tr>
<td>Double</td>
<td>1</td>
<td>双精度浮点值。用于存储浮点值</td>
<td></td>
</tr>
<tr>
<td>String</td>
<td>2</td>
<td>字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。</td>
<td></td>
</tr>
<tr>
<td>Object</td>
<td>3</td>
<td>用于内嵌文档</td>
<td></td>
</tr>
<tr>
<td>Array</td>
<td>4</td>
<td>用于将数组或列表或多个值存储为一个键</td>
<td></td>
</tr>
<tr>
<td>Binary data</td>
<td>5</td>
<td>二进制数据。用于存储二进制数据</td>
<td></td>
</tr>
<tr>
<td>Undefined</td>
<td>6</td>
<td>“undefined”</td>
<td>Deprecated.</td>
</tr>
<tr>
<td>ObjectId</td>
<td>7</td>
<td>对象 ID，用于创建文档的 ID。</td>
<td></td>
</tr>
<tr>
<td>Boolean</td>
<td>8</td>
<td>“bool”</td>
<td></td>
</tr>
<tr>
<td>Date</td>
<td>9</td>
<td>日期时间。用 UNIX 时间格式来存储当前日期或时间。可以指定自己的日期时间：创建 Date 对象，传入年月日信息。</td>
<td></td>
</tr>
<tr>
<td>Null</td>
<td>10</td>
<td>用于创建空值</td>
<td></td>
</tr>
<tr>
<td>Regular Expression</td>
<td>11</td>
<td>正则表达式类型。用于存储正则表达式。</td>
<td></td>
</tr>
<tr>
<td>DBPointer</td>
<td>12</td>
<td>“dbPointer”</td>
<td>Deprecated.</td>
</tr>
<tr>
<td>JavaScript</td>
<td>13</td>
<td>“javascript”</td>
<td></td>
</tr>
<tr>
<td>Symbol</td>
<td>14</td>
<td>“symbol”</td>
<td>Deprecated.</td>
</tr>
<tr>
<td>JavaScript (with scope)</td>
<td>15</td>
<td>“javascriptWithScope”</td>
<td></td>
</tr>
<tr>
<td>32-bit integer</td>
<td>16</td>
<td>“int”</td>
<td></td>
</tr>
<tr>
<td>Timestamp</td>
<td>17</td>
<td>MongoDB复制和Sharing使用的特殊内部类型。前4个字节是增量，第二4字节是时间戳。</td>
<td></td>
</tr>
<tr>
<td>64-bit integer</td>
<td>18</td>
<td>“long”</td>
<td></td>
</tr>
<tr>
<td>Decimal128</td>
<td>19</td>
<td>“decimal”</td>
<td>New in version 3.4.</td>
</tr>
<tr>
<td>Min key</td>
<td>-1</td>
<td>比所有其他可能的BSON元素值都低的特殊类型。</td>
<td></td>
</tr>
<tr>
<td>Max key</td>
<td>127</td>
<td>比所有其他可能的BSON元件值更高的特殊类型。</td>
<td></td>
</tr>
</tbody></table>
<h1 id="MongoDB操作语法"><a href="#MongoDB操作语法" class="headerlink" title="MongoDB操作语法"></a>MongoDB操作语法</h1><h2 id="使用MongoDB"><a href="#使用MongoDB" class="headerlink" title="使用MongoDB"></a>使用MongoDB</h2><p>通过Mongo shell操作学习如何使用MongoDB相关内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongo</span><br></pre></td></tr></table></figure>

<p>操作数据库、集合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db <span class="comment"># 显示当前数据库</span></span><br><span class="line">use dataBaseName <span class="comment"># 如果dataBaseName不存在，在插入数据时将会创建数据库</span></span><br><span class="line">show dbs <span class="comment"># 显示当前实例中的数据库</span></span><br><span class="line">db.dropDatabase() <span class="comment"># 删除当前选择的库</span></span><br><span class="line">db.createCollection(<span class="string">&quot;runoob&quot;</span>) <span class="comment"># 显式的创建runoob集合</span></span><br><span class="line">show tables <span class="comment"># 显示当前数据库中的集合信息</span></span><br><span class="line">show collections</span><br><span class="line">db.runoob.drop() <span class="comment"># 删除runoob集合</span></span><br></pre></td></tr></table></figure>

<h2 id="新建操作语法"><a href="#新建操作语法" class="headerlink" title="新建操作语法"></a>新建操作语法</h2><p><strong>新建文档</strong></p>
<p>新文档添加到集合中。如果该集合当前不存在，则插入操作将创建该集合。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insertOne() <span class="comment">#插入单个文档</span></span><br><span class="line">db.collection.insertMany() <span class="comment">#插入多个文档</span></span><br><span class="line">db.collection.insert() <span class="comment">#插入单条或多个文档</span></span><br></pre></td></tr></table></figure>

<p><strong>插入操作行为影响：</strong></p>
<ul>
<li>自动创建不存在的集合、数据库，例如这里的inventory集合</li>
<li>如果不指定，自动生成主键_id及其值</li>
<li>写操作都是基于单个文档级别的原子操作<br>注意：3.0基于单个集合级别的原子操作，4.0基于单个文档级别的原子操作</li>
<li>确认写操作级别，在分片集群中我们需要关注，目前忽略</li>
</ul>
<h2 id="新建文档摘要"><a href="#新建文档摘要" class="headerlink" title="新建文档摘要"></a>新建文档摘要</h2><p>MongoDB下新建文档的语法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.collection.insert(</span><br><span class="line">    &lt;document or array of documents&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">    	writeConcern: &lt;document&gt;,</span><br><span class="line">    	ordered: &lt;boolean&gt;</span><br><span class="line">    &#125; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>documents：必填，表示需要插入的文档，可以是多个文档</p>
<p>writeConcern：可选项，写策略，后面学习集群时我们再关注</p>
<p>ordered：可选，表示多个文档是否按照文档顺序插入</p>
<h2 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h2><p>在inventory集合中，查询我们插入的记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SELECT * FROM inventory WHERE item = &quot;canvas&quot;</span></span><br><span class="line">db.inventory.find( &#123; item: <span class="string">&quot;canvas&quot;</span> &#125; ).pretty()</span><br><span class="line"></span><br><span class="line"><span class="comment"># SELECT * FROM inventory WHERE status = &quot;A&quot; AND ( qty &lt; 30 OR item LIKE &quot;p%&quot;)</span></span><br><span class="line">db.inventory.find( &#123;</span><br><span class="line">    status: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">    <span class="variable">$or</span>: [ &#123; qty: &#123; <span class="variable">$lt</span>: 30 &#125; &#125;, &#123; item: /^p/ &#125; ]</span><br><span class="line">&#125; )</span><br></pre></td></tr></table></figure>

<p>MongoDB 查询数据的语法格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, projection)</span><br></pre></td></tr></table></figure>

<ul>
<li>query ：可选，使用查询操作符指定查询条件</li>
<li>projection ：可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）。</li>
<li>需要以易读的方式来读取数据，可以使用 pretty() 方法；</li>
</ul>
<h2 id="查询操作符"><a href="#查询操作符" class="headerlink" title="查询操作符"></a>查询操作符</h2><table>
<thead>
<tr>
<th>操作符类型</th>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>比较</td>
<td>$eq</td>
<td>等于</td>
</tr>
<tr>
<td></td>
<td>$lt</td>
<td>小于</td>
</tr>
<tr>
<td></td>
<td>$lte</td>
<td>小于等于</td>
</tr>
<tr>
<td></td>
<td>$gt</td>
<td>大于</td>
</tr>
<tr>
<td></td>
<td>$gte</td>
<td>大于等于</td>
</tr>
<tr>
<td></td>
<td>$in</td>
<td>判断元素是否在指定的集合范围里</td>
</tr>
<tr>
<td></td>
<td>$all</td>
<td>判断数组中是否包含某几个元素,无关顺序</td>
</tr>
<tr>
<td></td>
<td>$nin</td>
<td>判断元素是否不在指定的集合范围里</td>
</tr>
<tr>
<td>逻辑运算</td>
<td>$ne</td>
<td>不等于</td>
</tr>
<tr>
<td></td>
<td>$not</td>
<td>不匹配结果</td>
</tr>
<tr>
<td></td>
<td>$or</td>
<td>有一个条件成立则匹配</td>
</tr>
<tr>
<td></td>
<td>$nor</td>
<td>所有条件都不匹配</td>
</tr>
<tr>
<td></td>
<td>$and</td>
<td>所有条件都必须匹配</td>
</tr>
<tr>
<td></td>
<td>$exists</td>
<td>判断元素是否存在</td>
</tr>
<tr>
<td>其他</td>
<td>.</td>
<td>子文档匹配</td>
</tr>
<tr>
<td></td>
<td>$regex</td>
<td>正则表达式匹配</td>
</tr>
</tbody></table>
<h2 id="查询其他操作"><a href="#查询其他操作" class="headerlink" title="查询其他操作"></a>查询其他操作</h2><p><strong>映射</strong></p>
<ul>
<li>字段选择：db.inventory.find({},{‘item’:1}) </li>
<li>字段排除： db.inventory.find({},{‘item’:0}) </li>
<li>数组子元素选择：db.inventory.find({},{‘tags’:{‘$slice’:[1,2]},’tags’:1}) $slice可以取两个元素数组,分别表示跳过和限制的条数；</li>
</ul>
<p><strong>排序</strong></p>
<ul>
<li>sort()：db.orders.find().sort({‘orderTime’:1,’price’:1})<br>1：升序 2：降序</li>
</ul>
<p><strong>跳过和限制</strong></p>
<ul>
<li><p>skip(n)：跳过n条数据</p>
</li>
<li><p>limit(n)：限制n条数据</p>
<p>e.g：db.orders.find().sort({‘orderTime’:-1}).limit(5).skip(5)</p>
</li>
</ul>
<p><strong>查询唯一值</strong></p>
<ul>
<li><p>distinct()：查询指定字段的唯一值</p>
<p>e.g：db.users.distinct(“age”)</p>
</li>
</ul>
<h2 id="更新操作语法"><a href="#更新操作语法" class="headerlink" title="更新操作语法"></a>更新操作语法</h2><p>更新文档的几种方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.updateOne() <span class="comment"># 直接修改原数据</span></span><br><span class="line">db.collection.updateMany()</span><br><span class="line">db.collection.replaceOne() <span class="comment"># 先删除后新增，性能低</span></span><br></pre></td></tr></table></figure>

<p>更新操作行为：</p>
<ul>
<li><p>所有写操作都是单个文档级别的原子操作</p>
</li>
<li><p>_id无法被修改</p>
</li>
<li><p>更新操作对字段顺序的影响，一般都保留文档字段的原始顺序</p>
<p>_id字段始终是文档中的第一个字段</p>
<p>更改字段名，可能导致字段顺序发生变化</p>
</li>
</ul>
<h2 id="更新摘要"><a href="#更新摘要" class="headerlink" title="更新摘要"></a>更新摘要</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.collection.update(</span><br><span class="line">    &lt;query&gt;,</span><br><span class="line">    &lt;update&gt;,</span><br><span class="line">    &#123;</span><br><span class="line">        upsert: &lt;boolean&gt;,</span><br><span class="line">        multi: &lt;boolean&gt;,</span><br><span class="line">        writeConcern: &lt;document&gt;,</span><br><span class="line">        collation: &lt;document&gt;,</span><br><span class="line">        arrayFilters: [ &lt;filterdocument1&gt;, ... ],</span><br><span class="line">        hint: &lt;document|string&gt; // MongoDB 4.2中支持的功能</span><br><span class="line">    &#125; </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>query，查询条件，类似sql update查询的where</li>
<li>update,update的对象和一些更新的操作符（如$,$inc…）等，类似sql update查询的set</li>
<li>upsert,可选，表示如果记录不存在，是否插新文档,true为插入，默认false，不插入</li>
<li>multi,可选，默认false,只更新找到的第一条记录。true,匹配的多条记录全部更新</li>
<li>writeConcern,可选，写策略</li>
<li>collation,可选，索引语言规则</li>
<li>arrayFilters,可选，过滤文档数组，用于确定更新操作要修改数组中的具体元素</li>
<li>hint,可选的，指定查询希望使用的索引字段，如果没有这个索引就会报错</li>
</ul>
<h2 id="更新操作符"><a href="#更新操作符" class="headerlink" title="更新操作符"></a>更新操作符</h2><table>
<thead>
<tr>
<th>操作符类型</th>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>更新操作</td>
<td>$inc</td>
<td>指定值加n</td>
</tr>
<tr>
<td></td>
<td>$set</td>
<td>替换掉指定字段的值</td>
</tr>
<tr>
<td></td>
<td>$unset</td>
<td>将指定字段删除</td>
</tr>
<tr>
<td></td>
<td>$rename</td>
<td>更新字段名称</td>
</tr>
<tr>
<td></td>
<td>$setOnInsert</td>
<td>更新导致新增文档，则设置字段的值。文档存在不影响。</td>
</tr>
<tr>
<td></td>
<td>$currentDate</td>
<td>指定字段赋值为当前时间值</td>
</tr>
<tr>
<td></td>
<td>$min</td>
<td>指定值小于现有字段值时才更新字段</td>
</tr>
<tr>
<td></td>
<td>$max</td>
<td>指定值大于现有字段值时才更新字段</td>
</tr>
<tr>
<td></td>
<td>$mul</td>
<td>将字段的值乘以指定的金额</td>
</tr>
<tr>
<td>数组操作</td>
<td>$</td>
<td>定位到某一个元素</td>
</tr>
<tr>
<td></td>
<td>$push</td>
<td>添加值到数组中</td>
</tr>
<tr>
<td></td>
<td>$addToSet</td>
<td>添加值到数组中，有重复则不处理</td>
</tr>
<tr>
<td></td>
<td>$pop</td>
<td>删除数组第一个或者最后一个</td>
</tr>
<tr>
<td></td>
<td>$pull</td>
<td>从数组中删除匹配查询条件的值</td>
</tr>
<tr>
<td></td>
<td>$pullAll</td>
<td>从数组中删除多个值</td>
</tr>
<tr>
<td></td>
<td>$each</td>
<td></td>
</tr>
<tr>
<td>数组运算修饰</td>
<td>$each</td>
<td>每一个</td>
</tr>
<tr>
<td></td>
<td>$slice</td>
<td>分割</td>
</tr>
<tr>
<td></td>
<td>$sort</td>
<td>往数组添加元素的排序</td>
</tr>
<tr>
<td>位更新</td>
<td>$bit</td>
<td>执行整数值的按位AND、OR和XOR更新</td>
</tr>
</tbody></table>
<h2 id="更新操作示例"><a href="#更新操作示例" class="headerlink" title="更新操作示例"></a>更新操作示例</h2><p><strong>更新字段</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.updateOne(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;map&quot;</span>&#125;,&#123;<span class="string">&quot;<span class="variable">$unset</span>&quot;</span>:&#123;<span class="string">&quot;status&quot;</span>:<span class="string">&quot;&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>更新字段名称</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.updateMany(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;map&quot;</span>&#125;,&#123;<span class="string">&quot;<span class="variable">$rename</span>&quot;</span>:&#123;<span class="string">&quot;lastModified&quot;</span>:<span class="string">&quot;updateTime&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>$each作用</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update(</span><br><span class="line">    &#123; item: <span class="string">&quot;mobile&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="variable">$push</span>: &#123; scores: &#123; <span class="variable">$each</span>: [ 90, 92, 85 ] &#125; &#125; &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>数组更新</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.updateMany(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;mobile&quot;</span>&#125;,&#123;<span class="variable">$addToSet</span>:&#123;tags:<span class="string">&quot;c&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><p>删除文档的两种方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.collection.deleteMany()</span><br><span class="line">db.collection.deleteOne()</span><br></pre></td></tr></table></figure>

<p>删除操作行为影响：</p>
<ul>
<li>集合中的所有文档都被删除，索引不会删除</li>
<li>写操作都是单个文档级别的原子操作</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除所有文档</span></span><br><span class="line">db.inventory.deleteMany(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除单个文档</span></span><br><span class="line">db.inventory.deleteOne( &#123; status: <span class="string">&quot;D&quot;</span> &#125; )</span><br></pre></td></tr></table></figure>

<h2 id="图形化客户端"><a href="#图形化客户端" class="headerlink" title="图形化客户端"></a>图形化客户端</h2><p>除了Shell还有两种图形化客户</p>
<ul>
<li>MongoDB自带的图形化客户端：Compass Community</li>
<li>第三方mongoDB的图形化客户端：robomongo</li>
</ul>
<p>两种产品功能支持度</p>
<table>
<thead>
<tr>
<th>客户端产品</th>
<th>DDL</th>
<th>DML</th>
<th>脚本</th>
<th>查询计划</th>
<th>索引管理</th>
<th>支持版本</th>
</tr>
</thead>
<tbody><tr>
<td>Compass</td>
<td>支持</td>
<td>支持，比较人性化</td>
<td>不支持</td>
<td>支持</td>
<td>支持</td>
<td>4.2.1</td>
</tr>
<tr>
<td>Robomongo</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
<td></td>
</tr>
</tbody></table>
<h2 id="MongoDB-操作笔记"><a href="#MongoDB-操作笔记" class="headerlink" title="MongoDB 操作笔记"></a>MongoDB 操作笔记</h2><h3 id="基础新增和查询"><a href="#基础新增和查询" class="headerlink" title="基础新增和查询"></a>基础新增和查询</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 新增操作</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertOne</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;canvas&quot;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">tags</span>: [<span class="string">&quot;cotton&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">28</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;journal&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;blank&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;small&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mat&quot;</span>, <span class="attr">qty</span>: <span class="number">85</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">27.9</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mousepad&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;gel&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;big&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 查询操作</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;journal&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;notebook&quot;</span>, <span class="attr">qty</span>: <span class="number">50</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;planner&quot;</span>, <span class="attr">qty</span>: <span class="number">75</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty</span>: <span class="number">45</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">10</span>, <span class="attr">w</span>: <span class="number">15.25</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 精确匹配</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">item</span>: <span class="string">&quot;canvas&quot;</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 逻辑操作</span></span><br><span class="line"><span class="comment">// SELECT * FROM inventory WHERE status = &quot;A&quot; AND ( qty &lt; 30 OR item LIKE &quot;p%&quot;)</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123;</span><br><span class="line">     <span class="attr">status</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">     <span class="attr">$or</span>: [ &#123; <span class="attr">qty</span>: &#123; <span class="attr">$lt</span>: <span class="number">30</span> &#125; &#125;, &#123; <span class="attr">item</span>: <span class="regexp">/^p/</span> &#125; ]</span><br><span class="line">&#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// SELECT * FROM inventory WHERE status in (&quot;A&quot;, &quot;D&quot;)</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">status</span>: &#123; <span class="attr">$in</span>: [ <span class="string">&quot;A&quot;</span>, <span class="string">&quot;D&quot;</span> ] &#125; &#125; )</span><br></pre></td></tr></table></figure>

<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 准备数据 */</span></span><br><span class="line">use test</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">drop</span>()</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;journal&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;blank&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;small&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;notebook&quot;</span>, <span class="attr">qty</span>: <span class="number">50</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;planner&quot;</span>, <span class="attr">qty</span>: <span class="number">75</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty</span>: <span class="number">45</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">10</span>, <span class="attr">w</span>: <span class="number">15.25</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mat&quot;</span>, <span class="attr">qty</span>: <span class="number">85</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">27.9</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mousepad&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;gel&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;big&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mobile&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">tags</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;big&quot;</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;map&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">length</span>: [<span class="number">129</span>, <span class="number">500</span>, <span class="number">1000</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;apple&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">length</span>: [<span class="number">29</span>, <span class="number">50</span>, <span class="number">90</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;banana&quot;</span>, <span class="attr">qty</span>: <span class="number">150</span>, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;orange&quot;</span>, <span class="attr">qty</span>: <span class="number">90</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ======================= 查询操作示例 ======================= */</span></span><br><span class="line"><span class="comment">// 内嵌文档单字段精确匹配</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="string">&quot;size.uom&quot;</span>: <span class="string">&quot;in&quot;</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内嵌文档多个字段匹配</span></span><br><span class="line"><span class="comment">// 下面两个语句查询效果不一样，因为查询的字段顺序不一样</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125; )</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">size</span>: &#123; <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组查询</span></span><br><span class="line"><span class="comment">// 匹配确切的数组内容，包括元素顺序</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">tags</span>: [<span class="string">&quot;blank&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;small&quot;</span>] &#125; )</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">tags</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blank&quot;</span>] &#125; )</span><br><span class="line"><span class="comment">// 不考虑顺序和其他元素，只要tags包含red和blank这俩个值就可以查询到</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">tags</span>: &#123; <span class="attr">$all</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;blank&quot;</span>] &#125; &#125; )</span><br><span class="line"><span class="comment">// length数组中至少有一个元素，满足$elemMatch的条件</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">length</span>: &#123; <span class="attr">$elemMatch</span>: &#123;<span class="attr">$gte</span>:<span class="number">30</span>, <span class="attr">$lt</span>:<span class="number">80</span>&#125; &#125; &#125; )</span><br><span class="line"><span class="comment">// tags数组大小为3的记录</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="string">&quot;tags&quot;</span>: &#123; <span class="attr">$size</span>: <span class="number">3</span> &#125; &#125; )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// $slice的使用，限制数组返回的内容</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="attr">item</span>:&#123;$eq : <span class="string">&quot;journal&quot;</span>&#125;, <span class="attr">$comment</span>: <span class="string">&quot;匹配刊物文档&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// 切割tags数组中的元素个数，返回第一个元素</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;item&quot;</span> : <span class="string">&quot;journal&quot;</span>&#125;, &#123;<span class="attr">tags</span>:&#123;<span class="attr">$slice</span>:<span class="number">1</span>&#125;&#125;)</span><br><span class="line"><span class="comment">// 返回tags数组从下标1开始，后面的3个元素</span></span><br><span class="line"><span class="comment">// $slice: [index, lenth]</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;item&quot;</span> : <span class="string">&quot;journal&quot;</span>&#125;, &#123;<span class="attr">tags</span>:&#123;<span class="attr">$slice</span>:[<span class="number">1</span>,<span class="number">3</span>]&#125;&#125;)</span><br><span class="line"><span class="comment">// 返回tags数组最后一个元素</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;item&quot;</span> : <span class="string">&quot;journal&quot;</span>&#125;, &#123;<span class="attr">tags</span>:&#123;<span class="attr">$slice</span>:[-<span class="number">1</span>,<span class="number">1</span>]&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询指定字段</span></span><br><span class="line"><span class="comment">// SELECT _id, item, status from inventory WHERE status = &quot;A&quot;</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;, &#123; <span class="attr">item</span>: <span class="number">1</span>, <span class="attr">status</span>: <span class="number">1</span> &#125; )</span><br><span class="line"><span class="comment">// 查询默认显示_id字段如果需要屏蔽，需要显示指定</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;, &#123; <span class="attr">item</span>: <span class="number">1</span>, <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">0</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配null或不存在的字段</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">tags</span>: <span class="literal">null</span> &#125; )</span><br><span class="line"><span class="comment">// db.inventory.find( &#123; tags : &#123; $type: 10 &#125; &#125; ) // 官方有列出，但实际没有效果</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; tags : &#123; <span class="attr">$exists</span>: <span class="literal">false</span> &#125; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历游标迭代子</span></span><br><span class="line"><span class="keyword">var</span> cursor = db.<span class="property">inventory</span>.<span class="title function_">find</span>();</span><br><span class="line"><span class="keyword">while</span> ( cursor.<span class="title function_">hasNext</span>() ) &#123;</span><br><span class="line">   <span class="title function_">printjson</span>( cursor.<span class="title function_">next</span>() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分页查询，并排序</span></span><br><span class="line"><span class="comment">// offset limit</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>().<span class="title function_">skip</span>(<span class="number">2</span>).<span class="title function_">limit</span>(<span class="number">2</span>).<span class="title function_">sort</span>(&#123;<span class="attr">qty</span>:<span class="number">1</span>&#125;);</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>(&#123;<span class="attr">qty</span>:<span class="number">1</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚合查询</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 单用途聚合操作</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">distinct</span>(<span class="string">&quot;status&quot;</span>);</span><br><span class="line"><span class="comment">// 要避免不通过查询器，直接使用count方法，会导致近似计数。</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;).<span class="title function_">count</span>();  <span class="comment">// 4.0弃用</span></span><br><span class="line"><span class="comment">// 基于count方法而来，估算集合中的文档数</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">estimatedDocumentCount</span>(&#123;&#125;);</span><br><span class="line"><span class="comment">// 通过对数据进行统计的，返回准确的计数，通过聚合计算而来</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">countDocuments</span>(&#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计集合中状态为A的文档数</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">   &#123; <span class="attr">$match</span>: &#123; <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125; &#125;,</span><br><span class="line">   &#123; <span class="attr">$group</span>: &#123; <span class="attr">_id</span>: <span class="literal">null</span>, <span class="attr">totalStatusADoc</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 准备数据 */</span></span><br><span class="line">use test</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">drop</span>()</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;canvas&quot;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">28</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;journal&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;blank&quot;</span>, <span class="string">&quot;red&quot;</span>, <span class="string">&quot;small&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;notebook&quot;</span>, <span class="attr">qty</span>: <span class="number">50</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span>, <span class="attr">qty</span>: <span class="number">100</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">8.5</span>, <span class="attr">w</span>: <span class="number">11</span>, <span class="attr">uom</span>: <span class="string">&quot;in&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;planner&quot;</span>, <span class="attr">qty</span>: <span class="number">75</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;D&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;postcard&quot;</span>, <span class="attr">qty</span>: <span class="number">45</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">10</span>, <span class="attr">w</span>: <span class="number">15.25</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;sketchbook&quot;</span>, <span class="attr">qty</span>: <span class="number">80</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">14</span>, <span class="attr">w</span>: <span class="number">21</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;sketch pad&quot;</span>, <span class="attr">qty</span>: <span class="number">95</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">22.85</span>, <span class="attr">w</span>: <span class="number">30.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mat&quot;</span>, <span class="attr">qty</span>: <span class="number">85</span>, <span class="attr">tags</span>: [<span class="string">&quot;gray&quot;</span>, <span class="string">&quot;yellow&quot;</span>, <span class="string">&quot;green&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">27.9</span>, <span class="attr">w</span>: <span class="number">35.5</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mousepad&quot;</span>, <span class="attr">qty</span>: <span class="number">25</span>, <span class="attr">tags</span>: [<span class="string">&quot;gel&quot;</span>, <span class="string">&quot;blue&quot;</span>, <span class="string">&quot;big&quot;</span>], <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mobile&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">tags</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;big&quot;</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;map&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">length</span>: [<span class="number">129</span>, <span class="number">500</span>, <span class="number">1000</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;apple&quot;</span>, <span class="attr">qty</span>: <span class="number">250</span>, <span class="attr">length</span>: [<span class="number">29</span>, <span class="number">50</span>, <span class="number">90</span>], <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;banana&quot;</span>, <span class="attr">qty</span>: <span class="number">150</span>, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;orange&quot;</span>, <span class="attr">qty</span>: <span class="number">90</span>, <span class="attr">size</span>: &#123; <span class="attr">h</span>: <span class="number">19</span>, <span class="attr">w</span>: <span class="number">22.85</span>, <span class="attr">uom</span>: <span class="string">&quot;cm&quot;</span> &#125;, <span class="attr">status</span>: <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ======================= 更新操作示例 ======================= */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新单个文档，会更新第一个匹配到的文档</span></span><br><span class="line"><span class="comment">// UPDATE inventory SET size.uom=&#x27;cm&#x27;, status=&#x27;P&#x27;, lastModified=now() WHERE item = &quot;paper&quot; </span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span> &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">$set</span>: &#123; <span class="string">&quot;size.uom&quot;</span>: <span class="string">&quot;cm&quot;</span>, <span class="attr">status</span>: <span class="string">&quot;P&quot;</span> &#125;,</span><br><span class="line">     <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量更新</span></span><br><span class="line"><span class="comment">// UPDATE inventory SET size.uom=&#x27;in&#x27;, status=&#x27;P&#x27;, lastModified=now() WHERE qty &lt; 50</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateMany</span>(</span><br><span class="line">   &#123; <span class="string">&quot;qty&quot;</span>: &#123; <span class="attr">$lt</span>: <span class="number">50</span> &#125; &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">$set</span>: &#123; <span class="string">&quot;size.uom&quot;</span>: <span class="string">&quot;in&quot;</span>, <span class="attr">status</span>: <span class="string">&quot;P&quot;</span> &#125;,</span><br><span class="line">     <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">replaceOne</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span>, <span class="attr">instock</span>: [ &#123; <span class="attr">warehouse</span>: <span class="string">&quot;A&quot;</span>, <span class="attr">qty</span>: <span class="number">60</span> &#125;, &#123; <span class="attr">warehouse</span>: <span class="string">&quot;B&quot;</span>, <span class="attr">qty</span>: <span class="number">40</span> &#125; ] &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 可以支持任意修改已存在字段的数据类型</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;paper&quot;</span> &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">$set</span>: &#123; <span class="string">&quot;instock&quot;</span>: <span class="number">1000</span> &#125;,</span><br><span class="line">     <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除字段</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;map&quot;</span>&#125;)</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateOne</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;map&quot;</span>&#125;,&#123;<span class="string">&quot;$unset&quot;</span>:&#123;<span class="string">&quot;status&quot;</span>:<span class="string">&quot;&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment">// 把字段加回来</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;map&quot;</span> &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">$set</span>: &#123;<span class="attr">status</span>: <span class="string">&quot;P&quot;</span> &#125;,</span><br><span class="line">     <span class="attr">$currentDate</span>: &#123; <span class="attr">lastModified</span>: <span class="literal">true</span> &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新字段名</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateMany</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;map&quot;</span>&#125;,&#123;<span class="string">&quot;$rename&quot;</span>:&#123;<span class="string">&quot;lastModified&quot;</span>:<span class="string">&quot;updateTime&quot;</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组操作</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;mobile&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// 往tags数组中增加元素，如果tags字段不存在则会新增该字段，如果值有重复就不处理</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateMany</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;mobile&quot;</span>&#125;,&#123;<span class="attr">$addToSet</span>:&#123;<span class="attr">tags</span>:<span class="string">&quot;c&quot;</span>&#125;&#125;) </span><br><span class="line"><span class="comment">// 数组中添加数组元素，并不是添加多个值</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">updateMany</span>(&#123;<span class="string">&quot;item&quot;</span>:<span class="string">&quot;mobile&quot;</span>&#125;,&#123;<span class="attr">$addToSet</span>:&#123;<span class="attr">tags</span>:[<span class="string">&quot;o&quot;</span>,<span class="string">&quot;p&quot;</span>]&#125;&#125;) </span><br><span class="line"><span class="comment">// 通过$each，往数组中添加多个值</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>(</span><br><span class="line">   &#123; <span class="attr">item</span>: <span class="string">&quot;mobile&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">$push</span>: &#123; <span class="attr">scores</span>: &#123; <span class="attr">$each</span>: [ <span class="number">90</span>, <span class="number">92</span>, <span class="number">85</span> ] &#125; &#125; &#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">// 往数组添加三个元素，但是只保留最后三个</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>(</span><br><span class="line">   &#123;<span class="attr">item</span>:<span class="string">&quot;mobile&quot;</span>&#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">$push</span>: &#123;</span><br><span class="line">       <span class="attr">scores</span>: &#123;</span><br><span class="line">         <span class="attr">$each</span>: [ <span class="number">80</span>, <span class="number">78</span>, <span class="number">86</span> ],</span><br><span class="line">         <span class="attr">$slice</span>: -<span class="number">4</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新所有记录，删除tags数组的red、big元素</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>(&#123; <span class="attr">tags</span>: &#123; <span class="attr">$in</span>: [<span class="string">&quot;red&quot;</span>, <span class="string">&quot;big&quot;</span>] &#125; &#125;)</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>(</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">    &#123; <span class="attr">$pull</span>: &#123; <span class="attr">tags</span>: &#123; <span class="attr">$in</span>: [ <span class="string">&quot;red&quot;</span>, <span class="string">&quot;big&quot;</span> ] &#125;&#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">multi</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除length数组中包含50/90的元素</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>( &#123; <span class="attr">item</span>: <span class="string">&quot;apple&quot;</span> &#125;, &#123; <span class="attr">$pullAll</span>: &#123; <span class="attr">length</span>: [ <span class="number">150</span>, <span class="number">390</span> ] &#125; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从前弹出一个元素，类似队列的pop api</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>( &#123; <span class="attr">item</span>:<span class="string">&quot;mobile&quot;</span>&#125;, &#123; <span class="attr">$pop</span>: &#123; <span class="attr">scores</span>: -<span class="number">1</span> &#125; &#125; )</span><br><span class="line"><span class="comment">// 从后弹出两个元素</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>( &#123; <span class="attr">item</span>:<span class="string">&quot;mobile&quot;</span>&#125;, &#123; <span class="attr">$pop</span>: &#123; <span class="attr">scores</span>: <span class="number">2</span> &#125; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组元素过滤</span></span><br><span class="line"><span class="comment">// 将length数组中大于100的元素，调整为100</span></span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">find</span>( &#123; <span class="attr">length</span>: &#123;<span class="attr">$gte</span>:<span class="number">100</span>&#125; &#125; )</span><br><span class="line">db.<span class="property">inventory</span>.<span class="title function_">update</span>(</span><br><span class="line">   &#123;<span class="string">&quot;item&quot;</span> : <span class="string">&quot;map&quot;</span>&#125;,</span><br><span class="line">   &#123; <span class="attr">$set</span>: &#123; <span class="string">&quot;length.$[element]&quot;</span> : <span class="number">100</span> &#125; &#125;,</span><br><span class="line">   &#123; <span class="attr">multi</span>: <span class="literal">true</span>,</span><br><span class="line">     <span class="attr">arrayFilters</span>: [ &#123; <span class="string">&quot;element&quot;</span>: &#123; <span class="attr">$gte</span>: <span class="number">100</span> &#125; &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量写入操作</span></span><br><span class="line"><span class="comment">// 准备数据</span></span><br><span class="line">db.<span class="property">characters</span>.<span class="title function_">insertMany</span>([</span><br><span class="line">   &#123; <span class="string">&quot;_id&quot;</span> : <span class="number">1</span>, <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Brisbane&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;monk&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">4</span> &#125;,</span><br><span class="line">   &#123; <span class="string">&quot;_id&quot;</span> : <span class="number">2</span>, <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Eldon&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;alchemist&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">3</span> &#125;,</span><br><span class="line">   &#123; <span class="string">&quot;_id&quot;</span> : <span class="number">3</span>, <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Meldane&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;ranger&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">3</span> &#125;</span><br><span class="line">]);</span><br><span class="line"><span class="comment">// 批量操作动作</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   db.<span class="property">characters</span>.<span class="title function_">bulkWrite</span>(</span><br><span class="line">      [</span><br><span class="line">         &#123; insertOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">&quot;document&quot;</span> :</span><br><span class="line">               &#123;</span><br><span class="line">                  <span class="string">&quot;_id&quot;</span> : <span class="number">4</span>, <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Dithras&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;barbarian&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">4</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; insertOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">&quot;document&quot;</span> :</span><br><span class="line">               &#123;</span><br><span class="line">                  <span class="string">&quot;_id&quot;</span> : <span class="number">5</span>, <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Taeln&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;fighter&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">3</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; updateOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">&quot;filter&quot;</span> : &#123; <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Eldon&quot;</span> &#125;,</span><br><span class="line">               <span class="string">&quot;update&quot;</span> : &#123; $set : &#123; <span class="string">&quot;status&quot;</span> : <span class="string">&quot;Critical Injury&quot;</span> &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; deleteOne :</span><br><span class="line">            &#123; <span class="string">&quot;filter&quot;</span> : &#123; <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Brisbane&quot;</span>&#125; &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; replaceOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">&quot;filter&quot;</span> : &#123; <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Meldane&quot;</span> &#125;,</span><br><span class="line">               <span class="string">&quot;replacement&quot;</span> : &#123; <span class="string">&quot;char&quot;</span> : <span class="string">&quot;Tanys&quot;</span>, <span class="string">&quot;class&quot;</span> : <span class="string">&quot;oracle&quot;</span>, <span class="string">&quot;lvl&quot;</span> : <span class="number">4</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   );</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">   <span class="title function_">print</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="JAVA客户端使用"><a href="#JAVA客户端使用" class="headerlink" title="JAVA客户端使用"></a>JAVA客户端使用</h1><h2 id="MongoDB客户端驱动"><a href="#MongoDB客户端驱动" class="headerlink" title="MongoDB客户端驱动"></a>MongoDB客户端驱动</h2><p>客户端驱动标准URI连接语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[datab</span><br><span class="line">ase][?options]]</span><br></pre></td></tr></table></figure>

<p>MongoDB支持的客户端语言驱动</p>
<p>C&#x2F;C++、C#、GO、<strong>Java</strong>、NodeJs、Perl等主流编程语言</p>
<p>Java语言可以通过下面两种方式开发</p>
<ol>
<li>MongoDB原生客户端</li>
<li>spring-data-mongodb</li>
</ol>
<h2 id="MongoDB-CRUD操作"><a href="#MongoDB-CRUD操作" class="headerlink" title="MongoDB CRUD操作"></a>MongoDB CRUD操作</h2><p>原生客户端基础操作</p>
<p>连接到MongoDB；选择数据库、集合；创建索引；增删改查。<br>代码示例：<a target="_blank" rel="noopener" href="https://github.com/chengchen901/mongo-study/blob/master/src/test/java/com/study/mongo/lesson01_quickstart/SyncBsonDocTest.java">Bson文档</a>、<a target="_blank" rel="noopener" href="https://github.com/chengchen901/mongo-study/blob/master/src/test/java/com/study/mongo/lesson01_quickstart/SyncJavaPojoTest.java">Java Pojo</a>操作</p>
<p>POM文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mongodb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mongodb-driver-sync<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mongodb.driver.sync&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="批量写操作"><a href="#批量写操作" class="headerlink" title="批量写操作"></a>批量写操作</h2><p>MongoDB服务器以允许驱动程序为BulkWriteResult和BulkWriteException实现正确语义的方式，支持用于插入，更新和删除的批量写入命令</p>
<p>批量操作有两种类型，有序和无序批量操作。</p>
<ol>
<li>有序批量操作按顺序执行所有操作，并在第一个写入错误时出错。</li>
<li>无序批量操作将执行所有操作并报告所有错误。无序批量操作不能保证执行顺序</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/chengchen901/mongo-study/blob/master/src/test/java/com/study/mongo/lesson02_advance/BulkWriteTest.java">参考代码示例</a></p>
<h2 id="Spring对MongoDB的支持"><a href="#Spring对MongoDB的支持" class="headerlink" title="Spring对MongoDB的支持"></a>Spring对MongoDB的支持</h2><p>Spring使用MongoDB</p>
<ol>
<li>pom引入spring-data-mongodb依赖</li>
<li>配置mongodb信息</li>
<li>类中引用MongoOperations接口</li>
<li>使用MongoOperations完成</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/chengchen901/mongo-study/blob/master/src/test/java/com/study/mongo/lesson01_quickstart/SpringWithMongoTest.java">参考代码示例</a></p>
<p>Spring对MongoDB的支持，参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/mongodb/docs/2.2.0.RELEASE/reference/html/#reference">spring官网链接</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/18-MongoDB/01-%E4%BB%8E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%B0MongoDB%E7%89%B9%E6%80%A7%E5%85%A5%E9%97%A8/" data-id="clmcxecau002gu8wafz7jgpr8" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/06-01-ELK安装文档" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/06-01-ELK%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.915Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p> es安装包下载地址</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.tar.gz">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.tar.gz</a></p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/11yeqTW1KHRXZCzNc81bEwg">https://pan.baidu.com/s/11yeqTW1KHRXZCzNc81bEwg</a><br>提取码：3b4z</p>
<h1 id="filebeat安装测试"><a href="#filebeat安装测试" class="headerlink" title="filebeat安装测试"></a>filebeat安装测试</h1><p>The <a target="_blank" rel="noopener" href="https://github.com/elastic/beats/tree/master/filebeat">Filebeat</a> client is a lightweight, resource-friendly tool that collects logs from files on the server and forwards these logs to your Logstash instance for processing. Filebeat is designed for reliability and low latency. Filebeat has a light resource footprint on the host machine</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>解压后，即可使用</p>
<h2 id="Input基础配置"><a href="#Input基础配置" class="headerlink" title="Input基础配置"></a>Input基础配置</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/6.5/filebeat-input-log.html">https://www.elastic.co/guide/en/beats/filebeat/6.5/filebeat-input-log.html</a></p>
<p>注意：需要修改enabled为true，否则其它参数会不生效</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160745.png"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">fileeat.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定日志文件目录，还可以/home/es/*/*.log或/home/es/*_log/*log指定</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/home/es/temp_log/*.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置将日志输出到控制台</span></span><br><span class="line"><span class="attr">output.console:</span></span><br><span class="line">  <span class="attr">pretty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="启动-filebeat"><a href="#启动-filebeat" class="headerlink" title="启动 filebeat"></a>启动 filebeat</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件消费的位置信息位于 data/registry 文件，可以删除改文件重新读取日志所有内容</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Filebeat配置拓展"><a href="#Filebeat配置拓展" class="headerlink" title="Filebeat配置拓展"></a>Filebeat配置拓展</h2><h3 id="递归获取文件"><a href="#递归获取文件" class="headerlink" title="递归获取文件"></a>递归获取文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/log/*/*.log   会获取/var/log 下所有 .log 文件</span><br></pre></td></tr></table></figure>

<h3 id="忽略行"><a href="#忽略行" class="headerlink" title="忽略行"></a>忽略行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exclude_lines: [&#x27;^DBG&#x27;]</span><br></pre></td></tr></table></figure>

<h3 id="内存控制"><a href="#内存控制" class="headerlink" title="内存控制"></a>内存控制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">获取某一个文件的harvester的buffer大小</span><br><span class="line">harvester_buffer_size           16384（16kb）</span><br><span class="line"></span><br><span class="line">一条消息的最大size：</span><br><span class="line">max_bytes       默认值10MB (10485760)</span><br></pre></td></tr></table></figure>

<h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  . . .</span><br><span class="line">  fields:</span><br><span class="line">    app_id: query_engine_12</span><br><span class="line">  fields_under_root: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="多行解析"><a href="#多行解析" class="headerlink" title="多行解析"></a>多行解析</h3><p>官网描述</p>
<p><a href="#multiline">https://www.elastic.co/guide/en/beats/filebeat/6.5/multiline-examples.html#multiline</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">multiline.pattern: <span class="string">&#x27;^\[&#x27;</span></span><br><span class="line">multiline.negate: <span class="literal">true</span></span><br><span class="line">multiline.match: after</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[2022-09-03T01:01:56,624][INFO ][o.e.m.j.JvmGcM</span><br><span class="line">onitorService] [node-1] [gc][young][30688][4911] duration [868ms], collec</span><br><span class="line">tions [1]/[1.6s], total [868ms]/[8.9m], </span><br><span class="line">memory [239.3mb]-&gt;[180.9mb]/[1015.6mb], </span><br><span class="line">all_pool</span><br></pre></td></tr></table></figure>

<h2 id="Output到Logstash"><a href="#Output到Logstash" class="headerlink" title="Output到Logstash"></a>Output到Logstash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">output.logstash:</span><br><span class="line">   hosts:[“192.168.1.137:5044”]</span><br><span class="line">   index: customname</span><br><span class="line">@metadata字段在最终的输出中是没有的，如想看可配置logstash的out如下</span><br><span class="line"></span><br><span class="line">负载均衡配置</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">&quot;es01:5044&quot;</span>,<span class="string">&quot;es02:5044&quot;</span>]</span><br><span class="line">  loadbalance: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c filebeat.yml -d <span class="string">&quot;publish&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="logstash安装测试"><a href="#logstash安装测试" class="headerlink" title="logstash安装测试"></a>logstash安装测试</h1><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-6.5.3.zip</span><br><span class="line">unzip logstash-6.5.3.zip</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> logstash-6.5.3/bin/</span><br><span class="line">./logstash -e <span class="string">&#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 随便输入字符按回车查看控制台打印</span></span><br></pre></td></tr></table></figure>

<h2 id="配置filebeat输入"><a href="#配置filebeat输入" class="headerlink" title="配置filebeat输入"></a>配置filebeat输入</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/6.5/advanced-pipeline.html">https://www.elastic.co/guide/en/logstash/6.5/advanced-pipeline.html</a></p>
<h2 id="配置ES输出"><a href="#配置ES输出" class="headerlink" title="配置ES输出"></a>配置ES输出</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/6.5/plugins-outputs-elasticsearch.html">https://www.elastic.co/guide/en/logstash/6.5/plugins-outputs-elasticsearch.html</a></p>
<h2 id="配置日志解析"><a href="#配置日志解析" class="headerlink" title="配置日志解析"></a>配置日志解析</h2><p>However you’ll notice that the format of the log messages is not ideal. You want to parse the log messages to create specific, named fields from the logs. To do this, you’ll use the grok filter plugin.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;COMBINEDAPACHELOG&#125;</span>&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最终配置"><a href="#最终配置" class="headerlink" title="最终配置"></a>最终配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#aracter at the beginning of a line indicates a comment. Use</span></span><br><span class="line"><span class="comment"># comments to describe your configuration.</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">    <span class="string">beats</span> &#123;</span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="string">&quot;5044&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># # The filter part of this file is commented out to indicate that it is</span></span><br><span class="line"><span class="comment"># # optional.</span></span><br><span class="line"><span class="string">filter</span> &#123;</span><br><span class="line">    <span class="string">grok</span> &#123;</span><br><span class="line">        <span class="string">match</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;COMBINEDAPACHELOG&#125;</span>&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># index =&gt; &quot;logs_index&quot;</span></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">elasticsearch</span> &#123; <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;192.168.90.131:9200&quot;</span>] &#125;</span><br><span class="line">  <span class="string">stdout</span> &#123; <span class="string">codec</span> <span class="string">=&gt;</span> <span class="string">rubydebug</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动logstash"><a href="#启动logstash" class="headerlink" title="启动logstash"></a>启动logstash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash -f config/beats2es.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/06-01-ELK%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/" data-id="clmcxecey003nu8wagh3ycy5u" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/06-00-ELK" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/06-00-ELK/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.908Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ELK简介"><a href="#ELK简介" class="headerlink" title="ELK简介"></a>ELK简介</h1><p><strong>ELK是什么？</strong></p>
<p>ELK 是 Elasticsearch Logstash Kibana 三者的缩写，原来称为 ELK Stack ，现在称为Elastic Stack，加入了 beats 来优化Logstash。</p>
<p><strong>ELK的主要用途是什么？</strong></p>
<p>大型分布式系统的日志集中分析。</p>
<p><strong>为什么要做日志集中分析？</strong></p>
<p>在生产系统中出现问题，我们通过查看日志定位问题，在大型的分布式系统中，若出现问题，你该如何查看日志？</p>
<p><strong>一个完整的集中式日志系统，需要包含以下几个主要特点</strong></p>
<ul>
<li>收集－能够采集多种来源的日志数据</li>
<li>传输、汇流－能够将日志分流、汇总，并传入中央存储</li>
<li>转换— 能够对收集的日志数据进行转换处理</li>
<li>存储－如何存储日志数据</li>
<li>分析－可以支持 UI 分析</li>
<li>告警－能够提供错误报告，监控机制</li>
</ul>
<p>ELK提供了一整套解决方案，并且都是开源软件，之间互相配合使用，完美衔接，高效的满足了很多场合的应用。目前主流的一种日志系统。</p>
<h2 id="老的架构"><a href="#老的架构" class="headerlink" title="老的架构"></a>老的架构</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118155856.png"></p>
<h2 id="用beats来进行采集的架构"><a href="#用beats来进行采集的架构" class="headerlink" title="用beats来进行采集的架构"></a>用beats来进行采集的架构</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118155911.png"></p>
<h1 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h1><p><strong>Beats是什么？</strong></p>
<p>轻量型数据采集器。负责从目标源上采集数据。</p>
<p>官网介绍：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/beats">https://www.elastic.co/cn/products/beats</a></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160014.png"></p>
<h2 id="FileBeat-工作原理"><a href="#FileBeat-工作原理" class="headerlink" title="FileBeat 工作原理"></a>FileBeat 工作原理</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160039.png"></p>
<h1 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h1><p>日志信息只是作为一个文本字段放入ES中，还是应该将其解析为多个特定意义的字段，方便统计分析？</p>
<p><strong>Logstash的角色</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/products/logstash">https://www.elastic.co/cn/products/logstash</a><br>Logstash是开源的服务端数据处理管道，能够同时从多个数据源采集数据、转换数据，然后将数据发送到你的存储中（在ELK中特指ElasticSearch）。</p>
<p><strong>logstash Pipeline 管道 工作原理</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160124.png"></p>
<h1 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h1><p>Kibana 用户手册：<br><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/kibana/current/index.html">https://www.elastic.co/guide/cn/kibana/current/index.html</a></p>
<h1 id="架构分享"><a href="#架构分享" class="headerlink" title="架构分享"></a>架构分享</h1><p>filebeat到Logstash时，如果某个时间段日志量非常大，Logstash会是性能瓶颈</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160208.png"></p>
<p>将filebeat数据发送到kafka解决性能瓶颈，Logstash读取kafka慢慢消费</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118160345.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/06-00-ELK/" data-id="clmcxecer003mu8wacbhq7aks" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/05-ES高性能集群" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/05-ES%E9%AB%98%E6%80%A7%E8%83%BD%E9%9B%86%E7%BE%A4/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.902Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h1><h2 id="我们需要多大规模的集群？"><a href="#我们需要多大规模的集群？" class="headerlink" title="我们需要多大规模的集群？"></a>我们需要多大规模的集群？</h2><p>当前的数据量有多大？数据增长情况如何？</p>
<p>你的机器配置如何？cpu、多大内存、多大硬盘容量？ </p>
<p><strong>推算的依据：</strong>ES JVM heap 最大 32G. 30G heap 大概能处理的数据量 10 T。如果内存很大如128G， 可在一台机器上运行多个(2~3个)ES节点实例。</p>
<h2 id="集群中的节点角色如何分配？"><a href="#集群中的节点角色如何分配？" class="headerlink" title="集群中的节点角色如何分配？"></a>集群中的节点角色如何分配？</h2><p><strong>节点角色：</strong></p>
<p>一个节点可以有多个角色，根据下面介绍的配置参数指定</p>
<ul>
<li>Master Node：设置node.master: true时，节点可作为主节点。负责存储集群元信息，例如每个节点ip、是否有资格成为master等</li>
<li>DataNode Node：设置node.data: true时，可作为数据节点，默认值为true。负责存储具体的索引数据。</li>
<li>Coordinate Node：将上两个配置设为false时，仅担任协调节点。负责接收请求，并将请求解析去多个DataNode查询数据，并将查询结果进行整理响应客户端。</li>
</ul>
<p><strong>如何分配：</strong></p>
<ul>
<li><strong>小规模集群</strong>：不需严格区分。 </li>
<li><strong>中大规模集群（十个以上节点）</strong>：应考虑单独的角色充当。特别并发查询量大，查询的 合并量大，可以增加独立的协调节点。角色分开的好处是分工分开，不互影响。如不会 因协调角色负载过高而影响数据节点的能力。</li>
</ul>
<h2 id="如何避免脑裂问题？"><a href="#如何避免脑裂问题？" class="headerlink" title="如何避免脑裂问题？"></a>如何避免脑裂问题？</h2><p>为尽量避免脑裂， 可配置：discovery.zen.minimum_master_nodes: (有master资格节点数&#x2F;2) + 1，该配置含义为一个节点只有与n个有master资格节点通信正常才能成为master或者进行master选举。</p>
<p>常用做法（中大规模集群）：</p>
<ol>
<li>Master 和 dataNode 角色分开，配置奇数个master，如3 </li>
<li>配置选举发现数，及延长ping master的等待时长</li>
</ol>
<p>discovery.zen.ping_timeout: 30（默认值是3秒） </p>
<h2 id="索引应该设置多少个分片？"><a href="#索引应该设置多少个分片？" class="headerlink" title="索引应该设置多少个分片？"></a>索引应该设置多少个分片？</h2><ol>
<li><p>分片对应的存储实体是什么 ？ </p>
<p>lucene索引</p>
</li>
<li><p>分片是不是越多越好，分片过多有什么影响 ？ </p>
<p>不是，分片过多会<strong>占用文件句柄、内存、cpu、磁盘</strong></p>
<p>每个请求都会调用到对应的分片机器上，如果机器很少，数据很小，分片很多，例如2个机器，12个分片，一个请求需要检索多个分片导致<strong>响应速度过慢</strong></p>
<p>相关性得分根据词频统计得出，词频统计并不是根据全局词频计算，而是基于当前分片计算相关性得分，因为全局词频计算性能消耗会很大。如果分片过多，反映全局词频相<strong>关性得分就会偏差更大</strong>。</p>
</li>
</ol>
<p>分片设置的可参考原则： </p>
<ul>
<li>ElasticSearch推荐的最大JVM堆空间是30~32G, 所以把你的分片最大容量限制为30GB, 然后再对分片数量做合理估算. 例如, 你认为你的数据能达到200GB, 推荐你最多分配 7到8个分片。</li>
<li>在开始阶段, 一个好的方案是根据你的节点数量按照1.5~3倍的原则来创建分片. 例如, 如果你有3个节点, 则推荐你创建的分片数最多不超过9(3x3)个。当性能下降时，增加 节点，ES会平衡分片的放置。</li>
<li>对于基于日期的索引需求, 并且对索引数据的搜索场景非常少. 也许这些索引量将达 到成百上千, 但每个索引的数据量只有1GB甚至更小. 对于这种类似场景, 建议只需要 为索引分配1个分片</li>
</ul>
<h2 id="分片应该设置几个副本？"><a href="#分片应该设置几个副本？" class="headerlink" title="分片应该设置几个副本？"></a>分片应该设置几个副本？</h2><ol>
<li><p>副本的用途是什么？ </p>
<p>提高数据可用性、查询性能 </p>
</li>
<li><p>集群规模没变的情况下副本过多会有什么影响？</p>
<p>占用文件句柄、内存、cpu、磁盘、写性能下降</p>
</li>
</ol>
<p>基本原则： </p>
<ol>
<li>为保证高可用，副本数设置为2即可。要求集群至少要有3个节点，来分开存放主分片、副本。 </li>
<li>如发现并发量大时，查询性能会下降，可增加副本数，来提升并发查询能力。</li>
</ol>
<h1 id="ES集群架构"><a href="#ES集群架构" class="headerlink" title="ES集群架构"></a>ES集群架构</h1><h2 id="集群组成"><a href="#集群组成" class="headerlink" title="集群组成"></a>集群组成</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118103757.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">默认端口为9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [“10.0.1.11<span class="string">&quot;,“10.0.1.12&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">discovery.zen.ping.unicast.hosts: [“10.0.1.11:9200<span class="string">&quot;,“10.0.1.12:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><p>前提：已安装好单节点es，可以参考前面的《ES安装文档》文章</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vi elasticsearch.yml</span><br><span class="line"><span class="comment"># 修改或添加如下配置，值为集群节点ip，端口默认为9200，可以不指定</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;192.168.90.131:9200&quot;</span>,<span class="string">&quot;192.168.90.132:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝当前机器es文件到另一个节点</span></span><br><span class="line">scp -r elasticsearch-6.5.3 192.168.90.132:`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作192.168.90.132节点</span></span><br><span class="line"><span class="comment"># 进入到data目录下，删除所有内容</span></span><br><span class="line"><span class="built_in">rm</span> -rf *</span><br><span class="line"><span class="comment"># 修改node.name，不能与其它节点重名，cluster.name一个集群内保持一致</span></span><br><span class="line">node.name: node-2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动所有 es 节点</span></span><br><span class="line">bin/elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证集群是否配置成功，访问下面地址，成功会返回集群内所有node.name信息</span></span><br><span class="line">http://192.168.90.131:9200/_cat/nodes</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="集群监控"><a href="#集群监控" class="headerlink" title="集群监控"></a>集群监控</h1><h2 id="监控API"><a href="#监控API" class="headerlink" title="监控API"></a>监控API</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看监控都有哪些api</span></span><br><span class="line">GET /_cat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看索引的信息</span></span><br><span class="line">GET /_cat/indices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点信息</span></span><br><span class="line">GET /_cat/nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/_cat </span><br><span class="line">/_cat/health </span><br><span class="line">/_cat/nodes </span><br><span class="line">/_cat/master </span><br><span class="line">/_cat/indices </span><br><span class="line">/_cat/allocation</span><br><span class="line">/_cat/shards </span><br><span class="line">/_cat/shards/&#123;index&#125;</span><br><span class="line">/_cat/thread_pool </span><br><span class="line">/_cat/segments </span><br><span class="line">/_cat/segments/&#123;index&#125;</span><br></pre></td></tr></table></figure>



<h1 id="x-pack"><a href="#x-pack" class="headerlink" title="x-pack"></a>x-pack</h1><p>为集群提供安全防护、监控、告警、报告等功能的收费组件； </p>
<p>6.3开始已开源，并入了elasticsearch核心中。</p>
<p>注意：使用xpack进行本地验证时使用单节点es更方便</p>
<h2 id="开始xpack"><a href="#开始xpack" class="headerlink" title="开始xpack"></a>开始xpack</h2><h3 id="开启试用"><a href="#开启试用" class="headerlink" title="开启试用"></a>开启试用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 kibana 执行下面命令，让 kibana 知道 es 开启安全防护，kibana 在访问 es 时需要弹出登录的 ui</span></span><br><span class="line">POST /_xpack/license/start_trial?acknowledge=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="es开启security"><a href="#es开启security" class="headerlink" title="es开启security"></a>es开启security</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vi</span> <span class="string">elasticsearch.yml</span></span><br><span class="line"><span class="comment"># 添加如下配置</span></span><br><span class="line"><span class="attr">xpack.security.enabled</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>

<h3 id="设置内置用户密码"><a href="#设置内置用户密码" class="headerlink" title="设置内置用户密码"></a>设置内置用户密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置内置用户密码</span></span><br><span class="line">bin/elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line">如下用户，密码方便记忆可以与用户名一致</span><br><span class="line">elastic</span><br><span class="line">apm_system</span><br><span class="line">kibana</span><br><span class="line">logstash_system</span><br><span class="line">beats_system</span><br><span class="line">remote_monitoring_user</span><br></pre></td></tr></table></figure>

<h3 id="配置kibana访问ES"><a href="#配置kibana访问ES" class="headerlink" title="配置kibana访问ES"></a>配置kibana访问ES</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 kibana 配置文件，在文件末尾加上下面内容</span></span><br><span class="line">vi kibana.yml</span><br><span class="line"><span class="comment"># 指定kibana访问es使用的用户名和密码</span></span><br><span class="line">elasticsearch.username: <span class="string">&quot;elastic&quot;</span></span><br><span class="line">elasticsearch.password: <span class="string">&quot;elastic&quot;</span></span><br><span class="line">xpack.security.enabled: <span class="literal">true</span></span><br><span class="line">xpack.security.encryptionKey: <span class="string">&quot;4297f44b13955235245b2497399d7a93&quot;</span></span><br></pre></td></tr></table></figure>

<p>重启kibana，重新登陆kibana后，你会看到如下登录界面</p>
<h3 id="启用-禁用x-pack中的特性"><a href="#启用-禁用x-pack中的特性" class="headerlink" title="启用&#x2F;禁用x-pack中的特性"></a>启用&#x2F;禁用x-pack中的特性</h3><p>默认情况下xpack中的各种特性都是开启的. 你可以通过在elasticsearch.yml、kibana.yml、logstash.yml中配置来开启或关闭他们。</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>xpack.graph.enabled</td>
<td>Set to false to disable X-Pack graph features.</td>
</tr>
<tr>
<td>xpack.ml.enabled</td>
<td>Set to false to disable X-Pack machine learning features.</td>
</tr>
<tr>
<td>xpack.monitoring.enabled</td>
<td>Set to false to disable X-Pack monitoring features.</td>
</tr>
<tr>
<td>xpack.reporting.enabled</td>
<td>Set to false to disable X-Pack reporting features.</td>
</tr>
<tr>
<td>xpack.security.enabled</td>
<td>Set to false to disable X-Pack security features.</td>
</tr>
<tr>
<td>xpack.watcher.enabled</td>
<td>Set to false to disable Watcher.</td>
</tr>
</tbody></table>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>x-pack security 组件从下面三个方面为 ES stack 提供安全防护。</p>
<ul>
<li><a href="#preventing-unauthorized-access">Preventing unauthorized access</a> with password protection, role-based access control, and IP filtering. </li>
<li><a href="#preserving-data-integrity">Preserving the integrity of your data</a> with message authentication and SSL&#x2F;TLS encryption. </li>
<li><a href="#maintaining-audit-trail">Maintaining an audit trail</a> so you know who’s doing what to your cluster and the data it stores.</li>
</ul>
<h3 id="支持从多个安全数据源获取用户数据"><a href="#支持从多个安全数据源获取用户数据" class="headerlink" title="支持从多个安全数据源获取用户数据"></a>支持从多个安全数据源获取用户数据</h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>native</td>
<td>An internal realm where users are stored in a dedicated Elasticsearch index. With this realm, users are authenticated by usernames and passwords. The users are managed via the <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/security-api-users.html">User Management API</a>.</td>
</tr>
<tr>
<td>ldap</td>
<td>A realm that uses an external LDAP server to authenticate the users. With this realm, users are authenticated by usernames and passwords.</td>
</tr>
<tr>
<td>active_directory</td>
<td>A realm that uses an external Active Directory Server to authenticate the users. With this realm, users are authenticated by usernames and passwords.</td>
</tr>
<tr>
<td>pki</td>
<td>A realm that authenticates users using Public Key Infrastructure (PKI). This realm works in conjunction with SSL&#x2F;TLS and identifies the users through the Distinguished Name (DN) of the client’s X.509 certificates.</td>
</tr>
<tr>
<td>file</td>
<td>An internal realm where users are defined in files stored on each node in the Elasticsearch cluster. With this realm, users are authenticated by usernames and passwords. The users are managed via dedicated tools that are provided by X-Pack on installation.</td>
</tr>
<tr>
<td>saml</td>
<td>A realm that uses SAML 2.0 Web SSO. This realm is designed to be used with Kibana.</td>
</tr>
</tbody></table>
<h3 id="内建用户"><a href="#内建用户" class="headerlink" title="内建用户"></a>内建用户</h3><p>elastic<br>    A built-in <strong>superuser</strong>. See <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/x-pack/current/built-in-roles.html">Built-in Roles</a>. </p>
<p>kibana<br>    The user Kibana uses to connect and communicate with Elasticsearch. </p>
<p>logstash_system<br>    The user Logstash uses when storing monitoring information in Elasticsearch. </p>
<h3 id="内建角色"><a href="#内建角色" class="headerlink" title="内建角色"></a>内建角色</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/x-pack/6.2/built-in-roles.html">https://www.elastic.co/guide/en/x-pack/6.2/built-in-roles.html</a></p>
<h3 id="多种方式进行用户管理"><a href="#多种方式进行用户管理" class="headerlink" title="多种方式进行用户管理"></a>多种方式进行用户管理</h3><h4 id="Rest-API"><a href="#Rest-API" class="headerlink" title="Rest API"></a>Rest API</h4><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/security-api-users.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/security-api-users.html</a></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_xpack/security/user</span><br><span class="line">GET /_xpack/security/user/&lt;username&gt;</span><br><span class="line">DELETE /_xpack/security/user/&lt;username&gt;</span><br><span class="line">POST /_xpack/security/user/&lt;username&gt;</span><br><span class="line">PUT /_xpack/security/user/&lt;username&gt;</span><br><span class="line">PUT /_xpack/security/user/&lt;username&gt;/_disable</span><br><span class="line">PUT /_xpack/security/user/&lt;username&gt;/_enable</span><br><span class="line">PUT /_xpack/security/user/&lt;username&gt;/_password</span><br></pre></td></tr></table></figure>

<h4 id="Kibana-Management"><a href="#Kibana-Management" class="headerlink" title="Kibana Management"></a>Kibana Management</h4><p>用有系统管理权限的用户（如 elastic）登录kibana，在 management菜单中进行用户、角色管理。</p>
<h2 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h2><h3 id="Monitor简介"><a href="#Monitor简介" class="headerlink" title="Monitor简介"></a>Monitor简介</h3><p>监控从ES nodes、lostash nodes、kibana实例 收集数据，被监控的ES集群可以决定整个技术栈的监控日志存在什么地方，默认情况下，会存在被监控的ES集群中。但ES官方强烈建议，在生产环境试用Monitoring时，要将监控数据放到一个单独的ES集群。</p>
<p>1、可以避免生产问题导致监控系统失效<br>2、也能防止监控系统影响生产程序的性能。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118105526.png"></p>
<h3 id="开启monitor"><a href="#开启monitor" class="headerlink" title="开启monitor"></a>开启monitor</h3><p>1、在es中配置  xpack.monitoring.collection.enabled: true</p>
<p>2、打开监控界面</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230118105619.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/05-ES%E9%AB%98%E6%80%A7%E8%83%BD%E9%9B%86%E7%BE%A4/" data-id="clmcxeceo003lu8wa1159fjn0" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/04-查询建议以及聚合分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/04-%E6%9F%A5%E8%AF%A2%E5%BB%BA%E8%AE%AE%E4%BB%A5%E5%8F%8A%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.895Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="查询建议"><a href="#查询建议" class="headerlink" title="查询建议"></a>查询建议</h1><p>查询建议，为用户提供良好的使用体验。主要包括：</p>
<ul>
<li>拼写检查；</li>
<li>自动建议查询词（自动补全）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230116194458.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230116194631.png"></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230116194647.png"></p>
<p>查询建议使用顺序</p>
<ol>
<li>completion进行前缀查询</li>
<li>phrase进行短语查询</li>
<li>最后再用term进行纠错查询</li>
</ol>
<h2 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELETE /blogs</span><br><span class="line">PUT /blogs/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;tech&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _bulk/?refresh=<span class="literal">true</span></span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Lucene is cool&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch rocks&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;the elk stack rocks&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Term-Suggester-纠错查询"><a href="#Term-Suggester-纠错查询" class="headerlink" title="Term Suggester(纠错查询)"></a>Term Suggester(纠错查询)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#term suggester</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;MY_SUGGESTION&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;text&quot;</span>: <span class="string">&quot;lucne rook&quot;</span>,</span><br><span class="line">      <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;body&quot;</span>,</span><br><span class="line">        <span class="string">&quot;suggest_mode&quot;</span> : <span class="string">&quot;missing&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#mode :</span></span><br><span class="line"><span class="comment">#missing : 如果反向索引中不存在这个词，就提供选项</span></span><br><span class="line"><span class="comment">#popular : 在更多的文档当中出现过，才会作为选项返回</span></span><br><span class="line"><span class="comment">#always: 只要匹配上的词，都会返回</span></span><br></pre></td></tr></table></figure>

<h2 id="Phrase-Suggester-短语查询"><a href="#Phrase-Suggester-短语查询" class="headerlink" title="Phrase Suggester(短语查询)"></a>Phrase Suggester(短语查询)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ES 短语查询建议 API</span></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;MY_SUGGESTION&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;text&quot;</span>: <span class="string">&quot;lucene and elasticsear rock&quot;</span>,</span><br><span class="line">      <span class="string">&quot;phrase&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;body&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Completion-Suggester-前缀查询"><a href="#Completion-Suggester-前缀查询" class="headerlink" title="Completion Suggester(前缀查询)"></a>Completion Suggester(前缀查询)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自动补全  Completion Suggester</span></span><br><span class="line"><span class="comment">#exchange kody and mike 主要用于快速查找 完全基友内存的</span></span><br><span class="line">DELETE /blogs_completion</span><br><span class="line"></span><br><span class="line">PUT /blogs_completion/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;tech&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;body&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _bulk/?refresh=<span class="literal">true</span></span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Lucene is cool&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch builds on top of lucene&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elasticsearch rocks&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Elastic is the company behind ELK stack&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;the elk stack rocks&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;blogs_completion&quot;</span>, <span class="string">&quot;_type&quot;</span> : <span class="string">&quot;tech&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;body&quot;</span>: <span class="string">&quot;elasticsearch is rock solid&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs_completion/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;MY_SUGGESTION&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;prefix&quot;</span> : <span class="string">&quot;elastic i&quot;</span>,</span><br><span class="line">      <span class="string">&quot;completion&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;body&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ES聚合分析简介"><a href="#ES聚合分析简介" class="headerlink" title="ES聚合分析简介"></a>ES聚合分析简介</h1><h2 id="ES聚合分析是什么？"><a href="#ES聚合分析是什么？" class="headerlink" title="ES聚合分析是什么？"></a>ES聚合分析是什么？</h2><p>聚合分析是数据库中重要的功能特性，完成对一个查询的数据集中数据的聚合计算，如：找出某字段（或计算表达式的结果）的最大值、最小值，计算和、平均值等。ES作为搜索引擎兼数据库，同样提供了强大的聚合分析能力。</p>
<ul>
<li>对一个数据集求最大、最小、和、平均值等指标的聚合，在ES中称为<strong>指标聚合 metric</strong></li>
<li>而关系型数据库中除了有聚合函数外，还可以对查询出的数据进行分组group by，再在组上进行指标聚合。在 ES 中group by 称为<strong>分桶，桶聚合bucketing</strong></li>
</ul>
<p>ES中还提供了矩阵聚合（matrix）、管道聚合（pipleline），但还在完善中。</p>
<ul>
<li><strong>ES聚合分析查询的写法</strong></li>
</ul>
<p>在查询请求体中以aggregations节点按如下语法定义聚合分析：</p>
<p>aggregations也可简写为aggs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;aggregations&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;&lt;aggregation_name&gt;&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;&lt;aggregation_type&gt;&quot;</span> : &#123;</span><br><span class="line">        	&lt;aggregation_body&gt;</span><br><span class="line">        &#125;</span><br><span class="line">        [,<span class="string">&quot;meta&quot;</span> : &#123; [&lt;meta_data_body&gt;] &#125; ]?</span><br><span class="line">        [,<span class="string">&quot;aggregations&quot;</span> : &#123; [&lt;sub_aggregation&gt;]+ &#125; ]?</span><br><span class="line">    &#125;</span><br><span class="line">    [,<span class="string">&quot;&lt;aggregation_name_2&gt;&quot;</span> : &#123; ... &#125; ]*</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>聚合分析的值来源</li>
</ul>
<p>聚合计算的值可以取<strong>字段</strong>的值，也可是<strong>脚本</strong>计算的结果。</p>
<h2 id="指标聚合"><a href="#指标聚合" class="headerlink" title="指标聚合"></a>指标聚合</h2><h3 id="max-min-sum-avg"><a href="#max-min-sum-avg" class="headerlink" title="max min sum avg"></a>max min sum avg</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># select max(age) from bank where street like ...;</span></span><br><span class="line"><span class="comment">#min sum avg sum</span></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;street&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_age&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># select avg(age+1) from bank;</span></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;avg_age_yearlater&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: <span class="string">&quot;doc.age.value + 1&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="count、value-count、-cardinality"><a href="#count、value-count、-cardinality" class="headerlink" title="_count、value_count、 cardinality"></a>_count、value_count、 cardinality</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select count(age) from bank</span></span><br><span class="line">POST /bank/_count</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: 28</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: 28</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value_count&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#select count(*) from (</span></span><br><span class="line"><span class="comment">#  select distinct(age) from bank)</span></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;state_count&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="stats、extended-stats"><a href="#stats、extended-stats" class="headerlink" title="stats、extended_stats"></a>stats、extended_stats</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对该字段进行cout、min、max、avg、sum计算</span></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;age_stats&quot;</span> : &#123; <span class="string">&quot;stats&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;age&quot;</span> &#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;bank_stats&quot;</span> : &#123;</span><br><span class="line">             <span class="string">&quot;stats&quot;</span> : &#123;</span><br><span class="line">                 <span class="string">&quot;script&quot;</span> : &#123;</span><br><span class="line">                     <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;painless&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;source&quot;</span>: <span class="string">&quot;doc[&#x27;age&#x27;].value&quot;</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 对该字段进行cout、min、max、avg、sum、方差等更多计算</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;age_stats&quot;</span> : &#123; <span class="string">&quot;extended_stats&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;age&quot;</span> &#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="percentiles、percentiles-rank"><a href="#percentiles、percentiles-rank" class="headerlink" title="percentiles、percentiles rank"></a>percentiles、percentiles rank</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#让老板知道每个年龄段用户占比多少</span></span><br><span class="line"><span class="comment">#percentile_ranks</span></span><br><span class="line"><span class="comment"># &lt;= 10 占比，&lt;= 20 占比，20~30岁可以拿&lt;=30占比减&lt;=20占比</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;percent&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;percentile_ranks&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;values&quot;</span>: [</span><br><span class="line">          10,</span><br><span class="line">          20,</span><br><span class="line">          30,</span><br><span class="line">          40</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#percentiles</span></span><br><span class="line"><span class="comment"># 30%用户年龄&lt;=xx，40%用户年龄&lt;=xx，xx并非一个完全精确的数</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;percent&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;percentiles&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;percents&quot;</span>: [</span><br><span class="line">          30,</span><br><span class="line">          40,</span><br><span class="line">          80,</span><br><span class="line">          100</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="桶聚合"><a href="#桶聚合" class="headerlink" title="桶聚合"></a>桶聚合</h2><h3 id="Terms-Aggregation"><a href="#Terms-Aggregation" class="headerlink" title="Terms Aggregation"></a>Terms Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每种状态，平均年龄</span></span><br><span class="line"><span class="comment"># select state,avg(age) from bank group by state</span></span><br><span class="line"></span><br><span class="line">GET /bank/_search/?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;state_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_age&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 平均年龄小于30岁的状态</span></span><br><span class="line"><span class="comment"># select state,avg(age) avg_age from bank group by state having avg_age &lt;= 30</span></span><br><span class="line">GET /bank/_search/?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;state_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;state.keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_age&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;es_having&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;bucket_selector&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;buckets_path&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;kody_age&quot;</span>: <span class="string">&quot;avg_age&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;script&quot;</span>: <span class="string">&quot;params.kody_age &lt;= 30&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 年龄为25岁的用户，男生、女生分别有多少人</span></span><br><span class="line"><span class="comment"># select gender,count(*) from bank where age=25 group by gender;</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;25&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Filter-Aggregation"><a href="#Filter-Aggregation" class="headerlink" title="Filter Aggregation"></a>Filter Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filter agg</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;25yearold&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;age&quot;</span>: 25</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Filters-Aggregation"><a href="#Filters-Aggregation" class="headerlink" title="Filters Aggregation"></a>Filters Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 年龄为20、21、25岁的用户，男生、女生分别有多少人</span></span><br><span class="line"><span class="comment"># filters</span></span><br><span class="line"><span class="comment"># where age in (21, 20, 25) group by age,gender</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: [</span><br><span class="line">        21,</span><br><span class="line">        20,</span><br><span class="line">        25</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;by_age&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;20_21_25&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;filters&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;20&quot;</span>: &#123;<span class="string">&quot;term&quot;</span>: &#123;<span class="string">&quot;age&quot;</span>: 20&#125;&#125;,</span><br><span class="line">          <span class="string">&quot;21&quot;</span>: &#123;<span class="string">&quot;term&quot;</span>: &#123;<span class="string">&quot;age&quot;</span>: 21&#125;&#125;,</span><br><span class="line">          <span class="string">&quot;25&quot;</span>: &#123;<span class="string">&quot;term&quot;</span>: &#123;<span class="string">&quot;age&quot;</span>: 25&#125;&#125;</span><br><span class="line">        &#125;  </span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个年龄段，男生\女生分别多少人</span></span><br><span class="line"><span class="comment"># 10~20、20~30、30~40、40~50</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_age&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filters&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;filters&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;10~20&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: 10,</span><br><span class="line">                <span class="string">&quot;lt&quot;</span>: 20</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;20~30&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: 20,</span><br><span class="line">                <span class="string">&quot;lt&quot;</span>: 30</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;30~40&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: 30,</span><br><span class="line">                <span class="string">&quot;lt&quot;</span>: 40</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;40~50&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;gte&quot;</span>: 40,</span><br><span class="line">                <span class="string">&quot;lt&quot;</span>: 50</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Range-Aggregation"><a href="#Range-Aggregation" class="headerlink" title="Range Aggregation"></a>Range Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># range</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 10,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 20</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 20,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 30</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 30,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 40</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: 40,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: 50</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;by_gender&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Date-Range-Aggregation"><a href="#Date-Range-Aggregation" class="headerlink" title="Date Range Aggregation"></a>Date Range Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最近一个月，注册了多少用户</span></span><br><span class="line"><span class="comment"># date_range</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;month_recen&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;registered&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;from&quot;</span>: <span class="string">&quot;now-48M/M&quot;</span>,</span><br><span class="line">            <span class="string">&quot;to&quot;</span>: <span class="string">&quot;now&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Date-Histogram-Aggregation"><a href="#Date-Histogram-Aggregation" class="headerlink" title="Date Histogram Aggregation"></a>Date Histogram Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每个月用户注册人数</span></span><br><span class="line"><span class="comment"># date_histogram</span></span><br><span class="line">GET /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;by_month&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;registered&quot;</span>,</span><br><span class="line">        <span class="string">&quot;interval&quot;</span>: <span class="string">&quot;year&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Missing-Aggregation"><a href="#Missing-Aggregation" class="headerlink" title="Missing Aggregation"></a>Missing Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询字段为空的数据有多少条</span></span><br><span class="line">POST /bank/_search?size=0</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;user_without_a_age&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;missing&quot;</span> : &#123; <span class="string">&quot;field&quot;</span> : <span class="string">&quot;age&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Geo-Distance-Aggregation"><a href="#Geo-Distance-Aggregation" class="headerlink" title="Geo Distance Aggregation"></a>Geo Distance Aggregation</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-aggregations-bucket-geodistance-aggregation.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-aggregations-bucket-geodistance-aggregation.html</a></p>
<h1 id="ES-Java-Client"><a href="#ES-Java-Client" class="headerlink" title="ES Java Client"></a>ES Java Client</h1><p><strong>Java Low Level REST Cllient</strong>：低级别的REST客户端，通过http与集群交互，用户需要自己编组请求JSON串，及解析响应JSON串。兼容所有ES版本。</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/index.html">https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/index.html</a></p>
<p><strong>Java High Level REST Client</strong>：高级别的REST客户端，基于低级别的REST客户端，增加了遍组、解析响应等相关api，Hight Level REST Client中的操作API和java client大多是一样的</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-client/6.2.4/index.html">https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-client/6.2.4/index.html</a></p>
<p><strong>Java Client</strong>：ES的发展规划中在7.0版本开始将废弃TransportClient，8.0版本中将完全移除TransportClient，去而代之的是Hight Level REST Client。</p>
<p><a target="_blank" rel="noopener" href="http://www.elastic.co/guide/en/elasticsearch/client/java-api/current/index.html">http://www.elastic.co/guide/en/elasticsearch/client/java-api/current/index.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/04-%E6%9F%A5%E8%AF%A2%E5%BB%BA%E8%AE%AE%E4%BB%A5%E5%8F%8A%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/" data-id="clmcxecej003ku8wa8pbvbrsx" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/03-ES查询语法解析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/03-ES%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.888Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>测试数据</strong>：链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Hqal2L7cgNOcU1uaSsHwSQ">https://pan.baidu.com/s/1Hqal2L7cgNOcU1uaSsHwSQ</a> 提取码：nsb0</p>
<h1 id="搜索API（-search-API）"><a href="#搜索API（-search-API）" class="headerlink" title="搜索API（ _search API）"></a>搜索API（ _search API）</h1><p><strong>搜索API端点地址</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/account/_search </span><br><span class="line">GET /twitter/_search?q=user:kimchy </span><br><span class="line">GET /kimchy,elasticsearch/_search?q=tag:wow </span><br><span class="line">GET /_all/_search?q=tag:wow </span><br><span class="line">GET /_search?q=tag:wow</span><br></pre></td></tr></table></figure>

<p>搜索的端点地址可以是多索引多mapping type的。搜索的参数 可作为URI请求参数给出，也可用 request body 给出。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230112151614.png"></p>
<h2 id="URI-Search"><a href="#URI-Search" class="headerlink" title="URI Search"></a>URI Search</h2><p>我们可以仅仅用一个URL就能发送一个查询请求，这种方式并不是能支持所有的参数，但能够方便的做 curl 测试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search?q=user:kimchy</span><br></pre></td></tr></table></figure>

<p>URI中允许的参数是：</p>
<p><strong>q</strong>：查询字符串（映射到query_string查询）</p>
<p><strong>df</strong>：在查询中未定义字段前缀时使用的默认字段</p>
<p><strong>analyzer</strong>：指定解析query string的analyzer</p>
<p><strong>analyze_wildcard</strong>：terms-level中的wildcard 和 prefix查询是否分词。默认为false。</p>
<p><strong>batched_reduce_size</strong>：一次在协调节点上应该减少的分片结果的数量。如果请求中的潜在分片数量可能很大，则应将此值用作保护机制以减少每个搜索请求的内存开销。</p>
<p><strong>default_operator</strong>：要使用的默认运算符可以是AND或 OR。默认为OR。</p>
<p><strong>lenient</strong>：如果设置为true，则会导致基于格式的失败（如向数字字段提供文本）被忽略。默认为false。</p>
<p><strong>explain</strong>：对于每个命中，包含如何计算命中得分的解释。source设置为false禁用检索source字段。也可以使用source_include＆获取部分文档source_exclude (see the request body documentation for more details)<br>stored_fields选择性存储的文件字段为每个命中返回，逗号分隔。没有指定任何值将导致没有字段返回。</p>
<p><strong>sort</strong>：指定排序规则。可以是fieldName，或者是 fieldName:asc的形式fieldName:desc。fieldName可以是文档中的实际字段，也可以是_score根据分数表示排序的特殊名称。可以有几个sort参数（顺序很重要）。</p>
<p><strong>track_scores</strong>：排序时，设置为true仍然可以跟踪分数并将它们作为每次击中的一部分返回。</p>
<p><strong>timeout</strong>：搜索超时，限制在指定时间值内执行的搜索请求，并在到期时积累至该点的保留时间。默认没有超时。</p>
<p><strong>terminate_after</strong>：为每个分片收集的文档的最大数量，一旦达到该数量，查询执行将提前终止。如果设置，则响应将有一个布尔型字段terminated_early来指示查询执行是否实际已经terminate_early。缺省为no terminate_after。</p>
<p><strong>from</strong>：从命中的索引开始返回。默认为0。</p>
<p><strong>size</strong>：要返回的点击次数。默认为10。</p>
<p><strong>search_type</strong>：要执行的搜索操作的类型。可以是 dfs_query_then_fetch或query_then_fetch。默认为query_then_fetch。有关可以执行的不同搜索类型的更多详细信息，请参阅 搜索类型。</p>
<h2 id="Request-body-Search"><a href="#Request-body-Search" class="headerlink" title="Request body Search"></a>Request body Search</h2><p>Request body 搜索方式以JSON格式在请求体中定义查询 query。请求方式可以是 GET 、POST 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;<span class="string">&quot;user&quot;</span>: <span class="string">&quot;kimchy&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>request body search传参中一级参数如下</p>
<h3 id="from-size（简单分页）"><a href="#from-size（简单分页）" class="headerlink" title="from&#x2F;size（简单分页）"></a>from&#x2F;size（简单分页）</h3><p>from&#x2F;size会存在性能问题</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-request-from-size.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-request-from-size.html</a></p>
<p>from 0 size 10，分片有5个，需要取5 * 10 &#x3D; 50</p>
<p>from 10 size 10，分片有5个，需要取5 * 20 &#x3D; 100</p>
<p>from 20 size 10，分片有5个，需要取5 * 30 &#x3D; 150</p>
<p>深分页考虑scroll或者search after</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;account_number&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10, </span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="scroll（离线批量分页）"><a href="#scroll（离线批量分页）" class="headerlink" title="scroll（离线批量分页）"></a>scroll（离线批量分页）</h3><p>scroll：适合批量查询，不适合实时请求</p>
<h3 id="search-after（实时分页）"><a href="#search-after（实时分页）" class="headerlink" title="search after（实时分页）"></a>search after（实时分页）</h3><p>search after：适合深分页的实时请求，通过提供live cusor(活动游标)解决性能问题</p>
<p><strong>注意：search after分页时排序需要找一个唯一值，如果数值相同分页数据为随机展示。</strong></p>
<p>例如：sort by id</p>
<p>from 0 size 10，分片有5个，需要取5 * 10 &#x3D; 50，50条数据id排序，获取第10个id的值，max_id &#x3D; 10</p>
<p>from 10 size 10，分片有5个，需要取5 * 10 &#x3D; 50，查询每个分片id大于10的数据取10条，max_id &#x3D; 20</p>
<p>from 20 size 10，分片有5个，需要取5 * 10 &#x3D; 50，查询每个分片id大于10的数据取10条，max_id &#x3D; 30</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据 account_number 排序每页获取10条数据</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;account_number&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span> : [0]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 根据 account_number 排序每页获取10条数据，指定第1页最大的account_number值为9，表示查询第2页</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;account_number&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span> : [9]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 根据 account_number 排序每页获取10条数据，指定第2页最大的account_number值为19，表示查询第3页</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;account_number&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;search_after&quot;</span> : [19]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sort（排序）"><a href="#sort（排序）" class="headerlink" title="sort（排序）"></a>sort（排序）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;street&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;state.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># numbers为数组，在排序时可指定mode为min、max、avg等模式进行排序</span></span><br><span class="line">GET /numbers/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;numbers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;avg&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="collapse（折叠）"><a href="#collapse（折叠）" class="headerlink" title="collapse（折叠）"></a>collapse（折叠）</h3><p>只能对keyword字段进行折叠，如下第一个collapse中对field为songName.keyword值相同的值进行去重</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看每首歌，只展示一条</span></span><br><span class="line">GET /music_v11/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;collapse&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;field&quot;</span>: <span class="string">&quot;songName.keyword&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看每首歌按歌手折叠</span></span><br><span class="line"><span class="comment"># 可以多次折叠，如下对singer.keyword相同的值进行去重，name可以自己定义</span></span><br><span class="line">GET /music_v11/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;collapse&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;field&quot;</span>: <span class="string">&quot;songName.keyword&quot;</span>, </span><br><span class="line">    <span class="string">&quot;inner_hits&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span> : <span class="string">&quot;more_songs&quot;</span> ,</span><br><span class="line">      <span class="string">&quot;collapse&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span> : <span class="string">&quot;singer.keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;size&quot;</span> : 5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="source和stored-fields（展示字段）"><a href="#source和stored-fields（展示字段）" class="headerlink" title="source和stored_fields（展示字段）"></a>source和stored_fields（展示字段）</h3><p>stored_fields：为查询store设置为true的对应字段</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只示address、balance字段</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;address&quot;</span>, <span class="string">&quot;balance&quot;</span>],</span><br><span class="line">  <span class="string">&quot;stored_fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 全不展示</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;stored_fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 展示所有</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;stored_fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE /books</span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;science&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;author&quot;</span> : &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>  &#125;,</span><br><span class="line">        <span class="string">&quot;content&quot;</span> : &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,<span class="string">&quot;store&quot;</span>: <span class="literal">true</span>&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;excludes&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;content&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /books/science</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;testname&quot;</span>,</span><br><span class="line">  <span class="string">&quot;author&quot;</span> : <span class="string">&quot;test author&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content&quot;</span> : <span class="string">&quot;this is a test content ....&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>], </span><br><span class="line">  <span class="string">&quot;stored_fields&quot;</span>: [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="min-score（最小相关性得分）"><a href="#min-score（最小相关性得分）" class="headerlink" title="min_score（最小相关性得分）"></a>min_score（最小相关性得分）</h3><p>排除_score小于min_score中指定的最小值的文档:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /music_v1/songs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;lyrics&quot;</span>: <span class="string">&quot;So many people all around the world&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;min_score&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="highlight（高亮）"><a href="#highlight（高亮）" class="headerlink" title="highlight（高亮）"></a>highlight（高亮）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;balance&quot;</span>: <span class="string">&quot;green&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;strong&gt;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/strong&gt;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高亮分词器</span></span><br><span class="line"><span class="comment">#unified，按顺序查看term_vector、反向索引有没有存储词的起始结束下标，如果没有存则需要计算</span></span><br><span class="line"><span class="comment">#fvh，必须要求term_vector开启才能使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 高亮需要词对应起始结束下标数据，这些数据可以用过index_options或term_vector控制</span></span><br><span class="line"><span class="comment">#index_options，存储在索引中，影响整个索引</span></span><br><span class="line"><span class="comment">#term_vector，单独存储，只影响某个字段</span></span><br><span class="line"></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;green&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;strong&gt;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/strong&gt;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span> : <span class="string">&quot;plain&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h1 id="Query-DSL"><a href="#Query-DSL" class="headerlink" title="Query DSL"></a>Query DSL</h1><p><strong>DSL是什么？</strong></p>
<ul>
<li>Domain Specific Language：领域特定语言</li>
<li>Elasticsearch基于JSON提供完整的查询DSL来定义查询。</li>
</ul>
<p><strong>DSL包含两种断言（clause）</strong></p>
<ul>
<li>叶子查询字句（Leaf query clauses）<br>Leaf query 断言在指定的字段上查询指定的值, 如：match, term or range queries.可以单独使用</li>
<li>复合查询字句（ Compound query clauses ）<br>以逻辑方式组合多个叶子、复合查询为一个查询</li>
</ul>
<h2 id="Query-and-filter-context"><a href="#Query-and-filter-context" class="headerlink" title="Query and filter context"></a>Query and filter context</h2><p><strong>Query and filter context</strong></p>
<p>一个查询断言（clause）的行为，取决于它是用在query context 还是 filter context 中 。</p>
<h2 id="Match-all-query-匹配所有文档"><a href="#Match-all-query-匹配所有文档" class="headerlink" title="Match all query(匹配所有文档)"></a>Match all query(匹配所有文档)</h2><p>最单一的query，匹配所有的文档，并且_score 都为 1.0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 叶子查询，boost指定相关性得分_score为1.5，无意义</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 叶子查询，一条数据都不展示</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_none&quot;</span> : &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Full-text-queries"><a href="#Full-text-queries" class="headerlink" title="Full text queries"></a>Full text queries</h2><p>full text queries 用来搜索被分词后的text类型字段，比如对邮件内容 进行搜索，搜索时，query string会使用索引数据时相同的analyzer进行分词。</p>
<h3 id="match"><a href="#match" class="headerlink" title="match"></a>match</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match全文检索，查询关键词分词后查询，operator默认为or，fuzziness设置为1，表示单词可以有一个字符的错误</span></span><br><span class="line">GET /music_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;lyrics&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;All I need is sameone whe makes me wanna sing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fuzziness&quot;</span>: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="match-phrase"><a href="#match-phrase" class="headerlink" title="match_phrase"></a>match_phrase</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match phrase query，短语查询，slop表示task to中间隔的词数量</span></span><br><span class="line">GET /music_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;songName&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;take to&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slop&quot;</span>: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="match-phrase-prefix"><a href="#match-phrase-prefix" class="headerlink" title="match_phrase_prefix"></a>match_phrase_prefix</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同等于match_phrase查询slop设置为0</span></span><br><span class="line">GET /music_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase_prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;songName&quot;</span>: <span class="string">&quot;me to&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="multi-match"><a href="#multi-match" class="headerlink" title="multi_match"></a>multi_match</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#multi match，同时对多个字段查询</span></span><br><span class="line">GET /music_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;take me to&quot;</span>,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;songName&quot;</span>, <span class="string">&quot;lyrics&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="query-string"><a href="#query-string" class="headerlink" title="query_string"></a>query_string</h3><p>向ES传入Luecene语法查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Query String query</span></span><br><span class="line"><span class="comment">#向ES传入Luecene语法查询</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;default_field&quot;</span>: <span class="string">&quot;address&quot;</span>,</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;address:(green OR street) AND gender:F&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ES</span></span><br><span class="line"><span class="comment">#Simple query String query</span></span><br><span class="line"><span class="comment">#表达式有如下：</span></span><br><span class="line">+：表示and</span><br><span class="line">|：表示or</span><br><span class="line">-：表示not</span><br><span class="line"><span class="string">&quot;：双引号表示不分词</span></span><br><span class="line"><span class="string">*：前缀查询</span></span><br><span class="line"><span class="string">()：多个术语或子句可以用圆括号组合在一起，形成子查询，例如(quick OR brown) AND fox</span></span><br><span class="line"><span class="string">GET /music_v1/_search</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;</span>query<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;</span>simple_query_string<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;</span>query<span class="string">&quot; : &quot;</span>(take me to your heart)<span class="string">&quot;,</span></span><br><span class="line"><span class="string">      &quot;</span>fields<span class="string">&quot;: [&quot;</span>lyrics<span class="string">&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Term-level-queries"><a href="#Term-level-queries" class="headerlink" title="Term level queries"></a>Term level queries</h2><p>term-level queries 不会像 full text queries 那样对query string进行分词，而是直接在反向索引中匹配当前term，如果是对keyword字段查询时，会用被查询字段的normalizer进行标准化。</p>
<p>注意：term查询相关性得分都为1，可以通过boost指定得分。</p>
<p>例如：查询参数为take me to your heart，它会直接去反向索引中找词为take me to your heart的文档，相当于一个精确查询</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /music_v1/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;songName&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;take me to your heart&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>term-level queries 经常用于查询结构化数据，比如keyword、numbers、date ranges、IP addresses、prices、product IDs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 精确查询</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: 24</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># where age in (24, 25, 28)</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: [24,25,28]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># where age &gt;= 20 and age &lt;= 30</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: 10,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 嵌套查询</span></span><br><span class="line"><span class="comment"># select * from bank where age in (select age from bank where ...)</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;bank&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;account&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: 6,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># where face is not null</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;field&quot;</span>: <span class="string">&quot;address&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前缀查询</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;foster&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本质上es并没有解决mysql前后模糊查询不能走索引的问题，它只是将查询参数进行分词后查询，换了一种查询方式而已</span></span><br><span class="line"><span class="comment"># 通配符查询，?个字符，*多个字符</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email.keyword&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;*fire*&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正则</span></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email.keyword&quot;</span>: <span class="string">&quot;lavern.*com&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="Common-terms-query"><a href="#Common-terms-query" class="headerlink" title="Common terms query"></a>Common terms query</h2><ol>
<li><p>什么是停用词？索引时做停用词处理的目的是什么？<br>停用词为无意义词，出现次数比较多，例如：not、the、it、to、他、她、它。停用词不会进行索引，也就是不能按停用词搜索。<br>停用词过多会导致停用词指向的文档有很多造成索引过大，影响搜索效率和存储空间。</p>
</li>
<li><p>如果在索引时应用停用词处理，下面的两个查询会查询什么词项？ </p>
<p>the brown fox </p>
<p>not happy </p>
<p>not和the作为停用词，无法准确查询包含the brown fox 或not happy 的文档</p>
</li>
</ol>
<p>结论：索引时应用停用词处理会影响查询精度？若不做停用词处理，会应向查询，如何协调这两个问题呢？</p>
<p>Common terms query会区分高频词、低频词， 我们可以通过cutoff_frequency来指定一个分界值，将搜索文本中的词分为高频词和低频词，低频词的重要性高于高频词。 </p>
<p><strong>优点</strong>：先取低频次对应文档并计算相关性得分，再去高频词对英文的不计算得分，再取高频词和低频词交集文档，用高频次和低频次得分相加作为文档分，减少高频词大量文档计算评分耗时，提高检索效率。</p>
<p>例如：take me to your heart中，me和to为高频词，heart为低频词</p>
<ul>
<li>先对低频词进行搜索，并计算所有匹配文档相关性得分； </li>
<li>再搜索和高频词匹配的文档，这会搜到很多文档，不计算得分 </li>
<li>取交集，交集中的文档进行高频词得分计算</li>
<li>高频词的得分和低频词得分相加，作为文档得分。实际执行的搜索是必须包含低频词 + 或包含高频词。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cutoff_frequency来指定一个分界值，将搜索文本中的词分为高频词和低频词</span></span><br><span class="line"><span class="comment"># low_freq_operator表示对低频词进行and还是or操作</span></span><br><span class="line"><span class="comment"># high_freq_operator表示对高频词进行and还是or操作</span></span><br><span class="line"></span><br><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;common&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;this is bonsai cool&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cutoff_frequency&quot;</span>: 0.001,</span><br><span class="line">        <span class="string">&quot;low_freq_operator&quot;</span> : <span class="string">&quot;and&quot;</span>,</span><br><span class="line">        <span class="string">&quot;high_freq_operator&quot;</span> : <span class="string">&quot;and&quot;</span>,</span><br><span class="line">        <span class="string">&quot;minimum_should_match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;high_freq&quot;</span>: 2,</span><br><span class="line">          <span class="string">&quot;low_freq&quot;</span>: 2</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思考：这样处理下，如果用户输入的都是高频词如 “to be or not to be”结果会是怎样的？你希望是怎样的？ </p>
<p>解决办法：</p>
<ul>
<li>不分词，keyword查询</li>
<li>分词，operator设置为and</li>
<li>如果都是高频词，让用户可以自己定对高频词做and&#x2F;or 操作，自己定对低频词进行and&#x2F;or 操作；或指定最少得多少个同时匹配。</li>
</ul>
<h2 id="Compound-queries"><a href="#Compound-queries" class="headerlink" title="Compound queries"></a>Compound queries</h2><p>compound queries会包裹其他compound queries 或leaf queries，合并它们的查 询结果及相关性得分，改变他们的行为。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># query content，作用为1、文档是否相关2、计算文档相关得分</span></span><br><span class="line"><span class="comment"># filter content，1、文档是否相关，不影响得分</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Constant Score query</span></span><br><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;age&quot;</span>: [25]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#Constant Score query</span></span><br><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;address&quot;</span>: <span class="string">&quot;street&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bool-query"><a href="#Bool-query" class="headerlink" title="Bool query"></a>Bool query</h3><table>
<thead>
<tr>
<th>Occur</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>must</td>
<td>必须满足</td>
</tr>
<tr>
<td>filter</td>
<td>必须满足，但在filter上下文执行，不影响得分</td>
</tr>
<tr>
<td>should</td>
<td>或</td>
</tr>
<tr>
<td>must_not</td>
<td>必须不满足，在filter上下文执行，不影响得分</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;address&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;numbers&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;numbers&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 40</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;street&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;value&quot;</span>: <span class="string">&quot;24&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dis-max"><a href="#dis-max" class="headerlink" title="dis_max"></a>dis_max</h3><p>选择得分更高的叶子查询的得分，作为文档最终得分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">DELETE /my_index</span><br><span class="line">PUT /my_index</span><br><span class="line"></span><br><span class="line">PUT /my_index/my_type/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Quick brown rabbits&quot;</span>,</span><br><span class="line">  <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Brown rabbits are commonly seen.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/my_type/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Keeping pets healthy&quot;</span>,</span><br><span class="line">  <span class="string">&quot;body&quot;</span>: <span class="string">&quot;My quick brown fox eats rabbits on a regular basis.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 普通查询相关性得分相同</span></span><br><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Brown fox&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Brown fox&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#dis_max 多个叶子查询，每个叶子查询都会匹配到文档</span></span><br><span class="line"><span class="comment"># 选择得分更高的叶子查询的得分，作为文档最终得分</span></span><br><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;queries&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Brown fox&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;body&quot;</span>: <span class="string">&quot;Brown fox&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/03-ES%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90/" data-id="clmcxeceb003ju8wahddgh5by" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/02-02-数据库同步数据到ES" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-02-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0ES/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.883Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="为何选用logstash-input-jdbc"><a href="#为何选用logstash-input-jdbc" class="headerlink" title="为何选用logstash-input-jdbc"></a>为何选用logstash-input-jdbc</h1><p>从关系型数据库同步数据到ES通常情况下用插件来做，常用的插件包括logstash-input-jdbc、go-mysql-elasticsearch、 elasticsearch-jdbc。</p>
<p>go-mysql-elasticsearch无法实现数据全量同步，且仍处于开发、相对不稳定阶段，而elasticsearch-jdbc 目前最新的版本是2.3.4，支持的ElasticSearch的版本为2.3.4，当前主流的ES版本已经是ES5.x及以上了，故不选用。</p>
<p>因此我们最终选用logstash-input-jdbc插件，此插件课兼顾全量同步、增量同步，但不能实现删除操作。</p>
<h1 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h1><p>系统环境	CentOS-6.10-x86_64-minimal</p>
<p>JDK		jdk 1.8.0_11  64位</p>
<p>Elasticsearch	6.5.3</p>
<p>Logstash	6.5.3</p>
<p>ruby		2.2.3</p>
<p>gem		2.6.12</p>
<p>MySQL		5.7.10</p>
<h1 id="安装ruby相关"><a href="#安装ruby相关" class="headerlink" title="安装ruby相关"></a>安装ruby相关</h1><h2 id="安装ruby"><a href="#安装ruby" class="headerlink" title="安装ruby"></a>安装ruby</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc* openssl* wget</span><br><span class="line"></span><br><span class="line">wget https://cache.ruby-lang.org/pub/ruby/2.2/ruby-2.2.3.tar.gz</span><br><span class="line">tar zxvf ruby-2.2.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ruby-2.2.3</span><br><span class="line">./configure --prefix=/usr/local/ruby</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">ln</span> -sf /usr/local/ruby/bin/* /usr/bin/</span><br></pre></td></tr></table></figure>

<h2 id="安装openssl"><a href="#安装openssl" class="headerlink" title="安装openssl"></a>安装openssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  ruby-2.2.3/ext/openssl</span><br><span class="line">ruby extconf.rb</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">注：make时可能会报如下错</span><br><span class="line">make: *** No rule to make target `/include/ruby.h<span class="string">&#x27;, needed by `ossl_x509revoked.o&#x27;</span>.  Stop.</span><br><span class="line">解决方法：修改 Makefile 在最上面增加变量 top_srcdir = ../.. 即可。</span><br></pre></td></tr></table></figure>

<h2 id="修改gem源"><a href="#修改gem源" class="headerlink" title="修改gem源"></a>修改gem源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gem sources --remove https://rubygems.org/</span><br><span class="line">gem sources -a https://gems.ruby-china.com/</span><br><span class="line">gem sources -l</span><br></pre></td></tr></table></figure>

<h1 id="安装logstash"><a href="#安装logstash" class="headerlink" title="安装logstash"></a>安装logstash</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-6.5.3.zip</span><br><span class="line">unzip logstash-6.5.3.zip</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> logstash-6.5.3/bin/</span><br><span class="line">./logstash -e <span class="string">&#x27;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果出现下面的东西就表示成功</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109222150.png"></p>
<p>随便输入一些类容：HelloWorld<br>会变成下面这样</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109222257.png"></p>
<p>基本上这样就算是安装成功了</p>
<h1 id="安装logstash-input-jdbc插件"><a href="#安装logstash-input-jdbc插件" class="headerlink" title="安装logstash-input-jdbc插件"></a>安装logstash-input-jdbc插件</h1><p>logstash-input-jdbc插件是logstash 的一个个插件，使用ruby语言开发，安装它首先需要安装ruby gem，并指定股呢的镜像库。如果没有安装gem，先安装ruby gem。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi logstash-6.5.3/Gemfile</span><br><span class="line">修改 <span class="built_in">source</span> 的值 为： <span class="string">&quot;https://gems.ruby-china.com/&quot;</span></span><br><span class="line"></span><br><span class="line">vi logstash-6.5.3/Gemfile.lock</span><br><span class="line">修改GEM下的remote属性为： https://gems.ruby-china.com/</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109222338.png"></p>
<p>logstash-6.5.3&#x2F;bin&#x2F;logstash-plugin install logstash-input-jdbc</p>
<h1 id="导数实战"><a href="#导数实战" class="headerlink" title="导数实战"></a>导数实战</h1><p>经过前面的准备工作，我们已经准备好了logstash-input-jdbc插件环境，另外你还需要Elasticsearch6.5.3、MySQL5.7.10的环境，参考其它文章即可。</p>
<h2 id="创建一个ES索引"><a href="#创建一个ES索引" class="headerlink" title="创建一个ES索引"></a>创建一个ES索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /songs_v11</span><br></pre></td></tr></table></figure>

<h2 id="MySQL-表准备"><a href="#MySQL-表准备" class="headerlink" title="MySQL 表准备"></a>MySQL 表准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create database music;</span><br><span class="line">grant all privileges on music.* to <span class="string">&#x27;music&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;music&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">use music;</span><br><span class="line"></span><br><span class="line">create table songs(</span><br><span class="line">   song_id int primary key auto_increment,</span><br><span class="line">   song_name varchar(18),</span><br><span class="line">   singer varchar(18),</span><br><span class="line">   lyrics varchar(3000),</span><br><span class="line">   create_time DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="logstash-jdbc-input"><a href="#logstash-jdbc-input" class="headerlink" title="logstash-jdbc-input"></a>logstash-jdbc-input</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> logstash-6.5.3/jdbc_conf/</span><br></pre></td></tr></table></figure>

<p>添加jdbc.conf 文件，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    jdbc &#123;</span><br><span class="line">      jdbc_connection_string =&gt; &quot;jdbc:mysql://192.168.90.136:3306/music&quot;</span><br><span class="line">      jdbc_user =&gt; &quot;music&quot;</span><br><span class="line">      jdbc_password =&gt; &quot;music&quot;</span><br><span class="line">      jdbc_driver_library =&gt; &quot;/root/mysql-connector-java-5.1.28.jar&quot;</span><br><span class="line">      jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">      jdbc_paging_enabled =&gt; &quot;true&quot;</span><br><span class="line">      jdbc_page_size =&gt; &quot;50000&quot;</span><br><span class="line"></span><br><span class="line">      statement =&gt; &quot;select song_id,song_name,singer,lyrics,create_time from music.songs where create_time &gt;= :sql_last_value&quot;</span><br><span class="line">      schedule =&gt; &quot;* * * * *&quot;</span><br><span class="line">      type =&gt; &quot;jdbc&quot;</span><br><span class="line">      lowercase_column_names =&gt; &quot;false&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line"></span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;192.168.90.131:9200&quot;]</span><br><span class="line">        index =&gt; &quot;songs_v11&quot;</span><br><span class="line">        document_id =&gt; &quot;%&#123;song_id&#125;&quot;</span><br><span class="line">        template_overwrite =&gt; true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; json_lines</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash -f jdbc_conf/jdbc.conf</span><br></pre></td></tr></table></figure>

<h2 id="往MySQL中插入测试数据"><a href="#往MySQL中插入测试数据" class="headerlink" title="往MySQL中插入测试数据"></a>往MySQL中插入测试数据</h2><p>现在所有的准备工作已经做好，接下来需要往MySQL中插入数据，如果能同步到ES，说明链路已经打通。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> music.songs(song_name,singer,lyrics,create_time) <span class="keyword">values</span>(<span class="string">&#x27;take me &#x27;</span>,<span class="string">&#x27;James Blunt&#x27;</span>,<span class="string">&#x27;fasdfasfasdfasdfasdfasdfas&#x27;</span>,now());</span><br><span class="line"></span><br><span class="line">查询ES，是否有插入的数据</span><br><span class="line"><span class="keyword">GET</span> <span class="operator">/</span>songs_v11<span class="operator">/</span>_search</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-02-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%88%B0ES/" data-id="clmcxece1003iu8waggfd1e3r" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/02-01-ES安装文档" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-01-ES%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.877Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="添加es用户"><a href="#添加es用户" class="headerlink" title="添加es用户"></a>添加es用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd es</span><br><span class="line">passwd es</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 在文件最后面添加内容，指定一个进程可以打开的最大文件数</span></span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="comment"># 生效配置</span></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line"><span class="comment"># 添加如下内容:</span></span><br><span class="line"><span class="comment"># soft 指的是当前系统生效的设置值。hard 表明系统中所能设定的最大值。soft 的限制不能比 hard 限制高。用 - 就表明同时设置了 soft 和 hard 的值。</span></span><br><span class="line"><span class="comment"># 所有的用户可以打开最大的文件数为</span></span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nofile 65536</span><br><span class="line"><span class="comment"># 所有的用户默认可以打开最大的进程数为</span></span><br><span class="line">* soft <span class="built_in">nproc</span> 2048</span><br><span class="line">* hard <span class="built_in">nproc</span> 4096</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /etc/security/limits.d/90-nproc.conf</span><br><span class="line"><span class="comment"># 修改如下内容：</span></span><br><span class="line">* soft <span class="built_in">nproc</span> 1024</span><br><span class="line"><span class="comment">#修改为</span></span><br><span class="line">* soft <span class="built_in">nproc</span> 4096</span><br></pre></td></tr></table></figure>

<h1 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h1><p>elasticsearch-6.5.3.tar.gz</p>
<p> jdk1.8.0_11.tar.tgz</p>
<p> es安装包下载地址</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.tar.gz">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.tar.gz</a></p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/11yeqTW1KHRXZCzNc81bEwg">https://pan.baidu.com/s/11yeqTW1KHRXZCzNc81bEwg</a><br>提取码：3b4z</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk1.8.0_11.tar.tgz</span><br><span class="line"></span><br><span class="line">vi ~/.bash_profile</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/home/es/jdk1.8.0_11</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib:<span class="variable">$CLASSPATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$&#123;JRE_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h1 id="安装ES"><a href="#安装ES" class="headerlink" title="安装ES"></a>安装ES</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf elasticsearch-6.3.2.tar.gz</span><br><span class="line"></span><br><span class="line">vi config/elasticsearch.yml</span><br><span class="line"># 修改内容(没有就添加):</span><br><span class="line">cluster.name: es-study</span><br><span class="line">node.name: node-1</span><br><span class="line">network.host: 0.0.0.0 </span><br><span class="line">http.port: 9200</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line"></span><br><span class="line"># 启动es</span><br><span class="line">bin/elasticsearch</span><br></pre></td></tr></table></figure>

<h1 id="Kibana安装"><a href="#Kibana安装" class="headerlink" title="Kibana安装"></a>Kibana安装</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/875457cb8da6">https://www.jianshu.com/p/875457cb8da6</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kibana-6.5.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi config/kibana.yml</span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">server.port: 5601</span><br><span class="line">server.host: <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">elasticsearch.url: <span class="string">&quot;http://192.168.254.175:9200&quot;</span></span><br><span class="line">kibana.index: <span class="string">&quot;.kibana&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">bin/kibana</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-01-ES%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/" data-id="clmcxecdv003gu8waeat2epkd" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/02-00-ES核心概念及使用场景" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-00-ES%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.872Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ES发展历程"><a href="#ES发展历程" class="headerlink" title="ES发展历程"></a>ES发展历程</h1><p>Luene-&gt;Compass-&gt;Elasticsearh</p>
<p>2004年，shay banon基于lucene开发了compass。<br>2010年，shay banon重构了compass，取名为elasticsearch，使其支持分布式和水平扩展。<br>2012年，Elasticsearch BV公司被创建，围绕Elasticsearch及相关软件提供商业服务和产品。<br>2015年，Elasticsearch公司更名为Elastic.</p>
<h1 id="ES使用场景"><a href="#ES使用场景" class="headerlink" title="ES使用场景"></a>ES使用场景</h1><ul>
<li>网站&#x2F;APP添加搜索功能</li>
<li>存储、分析数据</li>
<li>管理、交互、分析空间信息，将ES用于GIS</li>
</ul>
<h1 id="ES-Helloworld"><a href="#ES-Helloworld" class="headerlink" title="ES Helloworld"></a>ES Helloworld</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">&#x27;http://192.168.254.175:9200/posts&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -XPUT <span class="string">&#x27;http://192.168.254.175:9200/posts/product/1?pretty&#x27;</span> -d <span class="string">&#x27; &#123; &quot;name&quot;: &quot;John Doe&quot;suoyi &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl -XGET &#x27;</span>http://192.168.254.175:9200/posts/product/1?pretty<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="index-alias的应用"><a href="#index-alias的应用" class="headerlink" title="index alias的应用"></a>index alias的应用</h1><ul>
<li>两个索引无缝切换<br>DB同步数据到ES时同步到现有的索引对查询速度、数据一致性有影响，通过新建索引，把数据同步到新索引，然后将别名执行新索引删除老索引</li>
<li>查询多个索引<br>每个索引存储不同月份数据，可以创建一个别名指向多个索引，通过别名可以查询多个月份数据</li>
<li>视图功能<br>创建别名指向某个索引时可以添加过滤条件，例如只查询某个歌手的数据，查询该别名时只能查到过滤后的数据</li>
</ul>
<h1 id="同步DB数据到ES"><a href="#同步DB数据到ES" class="headerlink" title="同步DB数据到ES"></a>同步DB数据到ES</h1><p>市面上讨论的，将数据从DB同步到ES有logstash-input-jdbc、go-mysql-elasticsearch、elasticsearch-jdbc，推荐选用Logstash-input-jdbc来实现数据迁移</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109203558.png"></p>
<h1 id="ES核心概念"><a href="#ES核心概念" class="headerlink" title="ES核心概念"></a>ES核心概念</h1><p>在ES最初的设计中，index被当做类似DB的级别，能够对数据进行物理隔离，type相当于数据库中的表，对数据进行逻辑划分，document是ES中的一条数据记录。 </p>
<p>但这样的设计在ES 5.6以后开始有了变化，新版本的ES会逐步弱化type的概念，直到将其移除。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230110153631.png"></p>
<h2 id="type废除"><a href="#type废除" class="headerlink" title="type废除"></a>type废除</h2><p>ES最先的设计是用索引类比关系型数据库的数据库，用mapping type 来类比表， 一个索引中可以包含多个映射类别。这个类比存在一个严重的问题。</p>
<p>问题：ES在一个Index下面所有type中不能存在名称相同类型不同的字段，因为Lucene本身不支持一个Index下面有相同名称不同类的字段。</p>
<table>
<thead>
<tr>
<th>ES版本</th>
<th>支持情况</th>
</tr>
</thead>
<tbody><tr>
<td>5.6</td>
<td>用index.mappng.single_type: true来设定，每个index是否只允许一个type</td>
</tr>
<tr>
<td>6.0</td>
<td>兼容ES 5.x中创建的多types，但ES 6.0中，每个index只能创建一个type</td>
</tr>
<tr>
<td>7.x</td>
<td>index只有唯一默认的类型doc，索引文件将规范为<strong>PUT {index}&#x2F;_doc&#x2F;{id}</strong></td>
</tr>
<tr>
<td>8.0</td>
<td>规划中，将移除type概念</td>
</tr>
</tbody></table>
<h2 id="ES核心操作"><a href="#ES核心操作" class="headerlink" title="ES核心操作"></a>ES核心操作</h2><h3 id="index操作"><a href="#index操作" class="headerlink" title="index操作"></a>index操作</h3><p>创建&#x2F;删除index、开启&#x2F;关闭index、添加&#x2F;查看mapping、设置&#x2F;查看settings</p>
<p>index配置分为static、dynamic</p>
<p>dynamic：在es运行时就可以修改</p>
<p>static：只有在index创建或关闭才可以修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建index</span></span><br><span class="line">PUT /music_v2</span><br><span class="line"><span class="comment">#删除index</span></span><br><span class="line">DELETE /music_v2</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭index</span></span><br><span class="line">POST /music_v2/_close</span><br><span class="line"><span class="comment">#打开index</span></span><br><span class="line">POST /music_v2/_open</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看index settings</span></span><br><span class="line">GET /music_v2/_settings</span><br><span class="line"><span class="comment">#设置index settings，只能对未创建的index操作</span></span><br><span class="line">PUT /music_v2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 2,</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 6</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#修改settings，该配置为dynamic配置，可以不停止index修改</span></span><br><span class="line">PUT /music_v2/_settings</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;number_of_replicas&quot;</span>: 2</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#修改static配置，需要先关闭index</span></span><br><span class="line">PUT /music_v2/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index.shard.check_on_startup&quot;</span> :<span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建type，并指定mapping</span></span><br><span class="line">PUT /music_v2/_mappings/songs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;songName&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;singer&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;lyrics&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#查看mapping</span></span><br><span class="line">GET /music_v2/_mapping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#禁止读取</span></span><br><span class="line">PUT /music_v1/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;blocks.read&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#禁止写入</span></span><br><span class="line">PUT /music_v1/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;blocks.write&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#test</span></span><br><span class="line">POST /music_v1/songs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;songName&quot;</span> : <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;singer&quot;</span> : <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lyrics&quot;</span> : <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="document操作"><a href="#document操作" class="headerlink" title="document操作"></a>document操作</h3><p>索引&#x2F;查询&#x2F;更新&#x2F;删除document、搜索document，执行script </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加document</span></span><br><span class="line">POST /music_v2/songs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;songName&quot;</span> : <span class="string">&quot;you are beautiful&quot;</span>,</span><br><span class="line">  <span class="string">&quot;singer&quot;</span> : <span class="string">&quot;James Blunt&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lyrics&quot;</span> : <span class="string">&quot;My life is brilliant,My life is brilliant,My love is pure,I saw an angel.Of that I‘m sure.  ,She smiled at me on the subway.  ,She was with another man.  ,But I won‘t lose no sleep on that,Cause I‘ve got a plan,You‘re beautiful. You‘re beautiful,You‘re beautiful, it‘s true,I saw your face in a crowded place,And I don‘t know what to do,Cause I‘ll never be with you,Yeah, she caught my eye,As we walked on by,She could see from my face that I was,Fucking high,And I don‘t think that I‘ll see her again,But we shared a moment that will last till the end,You‘re beautiful. You‘re beautiful,You‘re beautiful, it‘s true,I saw your face in a crowded place ,And I don‘t know what to do,‘Cause I‘ll never be with you,La la la la, la la la la, la la la la  ,laaaaaa,You‘re beautiful. You‘re beautiful,You‘re beautiful, it‘s true,There must be an angel with a smile on her face ,When she thought up that I should be with you,But it‘s time to face the truth,I will never be with you&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#按照歌名查询</span></span><br><span class="line">GET /music_v2/_search?q=songName:<span class="string">&quot;take me to your heart&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#按照歌手查询</span></span><br><span class="line">GET /songs_v2/_search?q=singer:james</span><br><span class="line"></span><br><span class="line"><span class="comment">#按照歌词查询</span></span><br><span class="line">GET /music_v2/_search?q=lyrics:<span class="string">&quot;There must be an angel with a smile on her face&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#明确查询文档</span></span><br><span class="line">GET /music_v2/songs/5</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除文档</span></span><br><span class="line">DELETE /music_v2/songs/5</span><br><span class="line"></span><br><span class="line"><span class="comment">#索引文档，与POST不同的是需要指定id，POST自动生成id</span></span><br><span class="line">PUT /music_v2/songs/5</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;songName&quot;</span> : <span class="string">&quot;could this be love&quot;</span>,</span><br><span class="line">  <span class="string">&quot;singer&quot;</span> : <span class="string">&quot;Jennifer Lopez&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lyrics&quot;</span> : <span class="string">&quot;Could This Be love,Woke Up This Morning Just Sat In My Bed,8 a.m. First Thing In My Head,Is A Certain Someone Who&#x27;s Always On My Mind,He Treats Me Like A Lady In Every Way,He Smiles And Warms Me Through Up The Day,Should I Tell Him I Love You Wish I Knew What To Say,Could This Be Love That I Feel,So Strong So Deep And So Real,If I Lost You Would I Ever Heal,Could This Be Love That I Feel,Could This Be &quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改文档，之前的文章说过，搜索引擎做修改实现复制，实际上这里是先删除后添加</span></span><br><span class="line">PUT /music_v2/songs/5</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;songName&quot;</span> : <span class="string">&quot;could this be love&quot;</span>,</span><br><span class="line">  <span class="string">&quot;singer&quot;</span> : <span class="string">&quot;Jennifer Lopez&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lyrics&quot;</span> : <span class="string">&quot;Could This Be love,Woke Up This Morning Just Sat In My Bed,8 a.m. First Thing In My Head,Is A Certain Someone Who&#x27;s Always On My Mind,He Treats Me Like A Lady In Every Way,He Smiles And Warms Me Through Up The Day,Should I Tell Him I Love You Wish I Knew What To Say,Could&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mapping操作"><a href="#mapping操作" class="headerlink" title="mapping操作"></a>mapping操作</h3><p>创建mapping、查询mapping、修改mapping</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">DELETE /music_v2</span><br><span class="line">GET /music_v2/_settings</span><br><span class="line"><span class="comment">#查看mapping</span></span><br><span class="line">GET /music_v2/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建index后，创建mapping</span></span><br><span class="line">PUT /music_v2</span><br><span class="line">PUT /music_v2/_mappings/songs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;songName&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;singer&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;lyrics&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建index，并指定mapping</span></span><br><span class="line">PUT /music_v2/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  	<span class="string">&quot;songs&quot;</span>:&#123;</span><br><span class="line">  		<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;songName&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;singer&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;lyrics&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#给mapping添加字段</span></span><br><span class="line">PUT /music_v2/_mappings/songs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;author&quot;</span> : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#索引模板</span></span><br><span class="line">PUT /_template/music</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;template&quot;</span> : <span class="string">&quot;music*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;order&quot;</span> :1,</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span> : 1</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;_default_&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;songName&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT /_template/music2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;template&quot;</span> : <span class="string">&quot;music*&quot;</span>,</span><br><span class="line">  <span class="string">&quot;order&quot;</span> :3,</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span> : 3</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;_default_&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;songName&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125; </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 根据匹配到的模板order最大的作为模板</span></span><br><span class="line">PUT /music_v7</span><br><span class="line">GET /music_v7/_settings</span><br></pre></td></tr></table></figure>

<h2 id="映射详解"><a href="#映射详解" class="headerlink" title="映射详解"></a>映射详解</h2><h3 id="什么是映射（mapping）"><a href="#什么是映射（mapping）" class="headerlink" title="什么是映射（mapping）"></a>什么是映射（mapping）</h3><p>映射定义索引中有什么字段、字段的类型等结构信息。相当于数据库中表结构定义，或 solr中的schema。因为lucene索引文档时需要知道该如何来索引存储文档的字段。</p>
<p>ES中支持<strong>静态映射，动态映射</strong>两种方式。 通过dynamic字段来指定mapping的动态效果，dynamic字段可以有如下选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>有新增字段的文档索引时</th>
</tr>
</thead>
<tbody><tr>
<td>true（默认值）</td>
<td>Mapping会被更新</td>
</tr>
<tr>
<td>false</td>
<td>Mapping不会被更新，新增字段的数据无法被索引，_source会存储新字段</td>
</tr>
<tr>
<td>strict</td>
<td>直接报错</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /teachers</span><br><span class="line">PUT /teachers/_mappings/math</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;dynamic&quot;</span> : <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /teachers/math</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;hash&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span> : 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /teachers/_mapping</span><br><span class="line">GET /teachers/_search</span><br></pre></td></tr></table></figure>

<h3 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h3><p>字段类型定义了该如何索引字段值，ES提供了丰富的字段类型定义. </p>
<p>官网描述：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/mapping-types.html</a></p>
<p><strong>核心类型（Core Datatypes）</strong></p>
<ul>
<li>String：text and keyword<br>text：会对字符进行分词<br>keyword：会将整个字符作为一个词来索引</li>
<li>Numeric datatypes：long, integer, short, byte, double, float, half_float, scaled_float</li>
<li>Date datatype：date</li>
<li>Boolean datatype：boolean</li>
<li>Binary datatype：binary</li>
<li>Range datatypes：integer_range, float_range, long_range, double_range, date_range</li>
</ul>
<p><strong>复合类型（Complex Datatypes）</strong></p>
<ul>
<li>Array datatype：数组就是多值，不需要专门的类型</li>
<li>Object datatype：表示值为一个JSON 对象</li>
<li>Nested datatype：表示值为JSON对象数组<br>创建mapping时指定字段的type为nested就可以存储对象数组</li>
</ul>
<p><strong>地理数据类型（Geo Datatypes）</strong></p>
<ul>
<li>Geo-point datatype：for lat&#x2F;lon points （经纬坐标点）</li>
<li>Geo-Shape datatype：for complex shapes like polygons （形状表示）</li>
</ul>
<p><strong>特殊类型（Specialised Datatypes）</strong></p>
<ul>
<li>IP datatype：for IPv4 and IPv6 addresses</li>
<li>Completion datatype：to provide auto-complete suggestions</li>
<li>Token count datatype：to count the number of tokens in a string</li>
<li>mapper-murmur3：to compute hashes of values at index-time and store them in the index</li>
<li>Percolator type：Accepts queries from the query-dsl</li>
<li>join datatype：Defines parent&#x2F;child relation for documents within the same index</li>
</ul>
<h3 id="映射参数"><a href="#映射参数" class="headerlink" title="映射参数"></a>映射参数</h3><p>字段的type (Data type)定义了如何索引存储字段值，还有一些属性可以让我们 根据需要来覆盖默认的值或进行特别定义。请参考官网介绍详细了解： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/term-vector.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/term-vector.html</a></p>
<ul>
<li><p>analyzer </p>
</li>
<li><p>normalizer </p>
</li>
<li><p>boost </p>
</li>
<li><p>coerce </p>
</li>
<li><p>copy_to </p>
</li>
<li><p>doc_values </p>
</li>
<li><p>dynamic<br>dynamic字段来指定mapping的动态效果，也可以在object对象里面使用dynamic</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>有新增字段的文档索引时</th>
</tr>
</thead>
<tbody><tr>
<td>true（默认值）</td>
<td>Mapping会被更新</td>
</tr>
<tr>
<td>false</td>
<td>Mapping不会被更新，新增字段的数据无法被索引，_source会存储新字段</td>
</tr>
<tr>
<td>strict</td>
<td>直接报错</td>
</tr>
</tbody></table>
</li>
<li><p>enabled </p>
</li>
<li><p>fielddata </p>
</li>
<li><p>format </p>
</li>
<li><p>ignore_above </p>
</li>
<li><p>ignore_malformed </p>
</li>
<li><p>index_options，维度为<br>控制有哪些信息会加到反向索引中，给搜索和高亮使用，参数如下</p>
<ol>
<li>docs：仅记录词</li>
<li>freqs：记录词、在文档中出现词数</li>
<li>opsitions：记录词、在文档中出现词数、位置(第几个词)</li>
<li>offsets：记录词、在文档中出现词数、位置(第几个词)、开始结束下标</li>
</ol>
</li>
<li><p>index<br>反向索引，设置为false就无法进行方向索引</p>
</li>
<li><p>fields</p>
</li>
<li><p>norms </p>
</li>
<li><p>null_value<br>es索引数据时，name字段可能为null，null无法索引，但是我们有需要查询name为null的文档。可以使用null_value将字段的null值转为另一个值，比如字符串”null”。</p>
</li>
<li><p>position_increment_gap（后面再整理详细用法）<br>用于短语查询<br>例如：pick me up，这里面的短语为pick up<br>这个中间可能为her，在查询时需要计算位置<br>多个值中间位置的差叫做gap，指定中间gap的位置相差多少，可以用slop指定</p>
</li>
<li><p>properties<br>properties 除了在声明mappings最外层可以使用，还可以在字段内使用表示值为一个Object类型</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span>: &#123; </span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;region&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;manager&quot;</span>: &#123; </span><br><span class="line">          <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;age&quot;</span>:  &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span> &#125;,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: &#123; </span><br><span class="line">              <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;first&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;,</span><br><span class="line">                <span class="string">&quot;last&quot;</span>:  &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>search_analyzer<br>搜索时使用的分词器，默认搜索分词器和索引数据时分词器一致，可以通过此参数使搜索分词器和索引数据分词器不一致</p>
</li>
<li><p>similarity<br>配置相关性计算模型参数，详情见官网</p>
</li>
<li><p>store</p>
</li>
<li><p>term_vector（词向量），维度为字段<br>进行分词的时候产生的一系列信息，如下</p>
<ol>
<li>根据文本分词后的词集合</li>
<li>文本中第几个词</li>
<li>每个词在文本的起始和结束下标</li>
</ol>
<p>数据格式简单理解如下：</p>
<p>文本：kody have</p>
<table>
<thead>
<tr>
<th>词</th>
<th>文本中第几个词</th>
<th>起始和结束下标</th>
</tr>
</thead>
<tbody><tr>
<td>kody</td>
<td>1</td>
<td>0~3</td>
</tr>
<tr>
<td>have</td>
<td>2</td>
<td>5~8</td>
</tr>
</tbody></table>
<p>并不会保留上面所有的信息，需要根据参数配置，参数如下</p>
<ul>
<li>no：不存储</li>
<li>yes：仅存储词</li>
<li>with_positions：词和顺序</li>
<li>with_offsets：词和起始结束下标</li>
<li>with_positions_offsets：词、顺序、起始结束下标、</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;text&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>:        <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;term_vector&quot;</span>: <span class="string">&quot;with_positions_offsets&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="分词器（analyzer）"><a href="#分词器（analyzer）" class="headerlink" title="分词器（analyzer）"></a>分词器（analyzer）</h3><p>一个<strong>可分词字符串字段</strong>的值输入到analyzer，会被转换成一组词，ES有一系列内建的analyzer：</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/analyzer.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/analyzer.html</a></p>
<p><strong>Analyzer分析器</strong>：在ES中一个Analyzer 由下面三种组件组合而成： </p>
<ul>
<li><strong>character filter</strong> <strong>：</strong>字符过滤器，对文本进行字符过滤处理，如处理文本中的html标签字符。处理完后再交给tokenizer进行分词。一个analyzer中可包含0个或多个字符过滤器，多个按配置顺序依次进行处理。</li>
<li><strong>tokenizer</strong>：分词器，对文本进行分词。一个analyzer必需且只可包含一个tokenizer。</li>
<li><strong>token filter</strong>：词项过滤器，对tokenizer分出的词进行过滤处理。如转小写、停用词处理、同义词处理。一个analyzer可包含0个或多个词项过滤器，按配置顺序进行过滤。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;my_custom_analyzer&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;char_filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;emoticons&quot;</span> </span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;tokenizer&quot;</span>: <span class="string">&quot;punctuation&quot;</span>, </span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;lowercase&quot;</span>,</span><br><span class="line">            <span class="string">&quot;english_stop&quot;</span> </span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;tokenizer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;punctuation&quot;</span>: &#123; </span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pattern&quot;</span>,</span><br><span class="line">          <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;[ .,!?]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;char_filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;emoticons&quot;</span>: &#123; </span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;mapping&quot;</span>,</span><br><span class="line">          <span class="string">&quot;mappings&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;:) =&gt; _happy_&quot;</span>,</span><br><span class="line">            <span class="string">&quot;:( =&gt; _sad_&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;english_stop&quot;</span>: &#123; </span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;stop&quot;</span>,</span><br><span class="line">          <span class="string">&quot;stopwords&quot;</span>: <span class="string">&quot;_english_&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;my_custom_analyzer&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>:     <span class="string">&quot;I&#x27;m a :) person, and you?&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="normalizer"><a href="#normalizer" class="headerlink" title="normalizer"></a>normalizer</h3><p>keyword类型（不可分词字段无法通过analyzer进行标准化）的字段在索引前可用normalizer进行标准化，将Apple、apple转成相同的词</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;normalizer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;my_normalizer&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="string">&quot;char_filter&quot;</span>: [],</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: [<span class="string">&quot;lowercase&quot;</span>, <span class="string">&quot;asciifolding&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;foo&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="string">&quot;normalizer&quot;</span>: <span class="string">&quot;my_normalizer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多重字段（fields）"><a href="#多重字段（fields）" class="headerlink" title="多重字段（fields）"></a>多重字段（fields）</h3><p>当我们需要对一个字段进行多种不同方式的索引时，可以使用fields多重字段定义。如一个字符串字段即需要进行text分词索引，也需要进行keyword 关键字索引来支持排序、聚合；或需要用不同的分词器进行分词索引。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;raw&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;city&quot;</span>: <span class="string">&quot;New York&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;city&quot;</span>: <span class="string">&quot;York&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;city&quot;</span>: <span class="string">&quot;york&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;city.raw&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Cities&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;city.raw&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="doc-values、fielddata、index"><a href="#doc-values、fielddata、index" class="headerlink" title="doc_values、fielddata、index"></a>doc_values、fielddata、index</h3><ul>
<li><p>doc_values：大多数字段进行了反向索引，因此可以用于搜索，但排序、聚合、scripts操作等需要正向索引<br><strong>doc_values指定文档是否进行正向索引</strong>，有了正向索引才可以进行排序、聚合、scripts操作等<br><strong>doc_values默认为true，但是值作用于不分词的字段，例如keyword、int、boolean</strong></p>
</li>
<li><p>fielddata：大多数字段可利用doc_values来进行排序、聚合、scripts等操作，但doc_values不支持text字段，text字段利用fielddata机制来代替。</p>
<p><strong>为分词字段提供正向索引，全部放在内存中</strong><br><strong>注意：fielddata默认为false，一般不会对text字段进行排序，使用fielddata之前需要考虑好是否要使用，因为fielddata是在内存中进行排序的</strong></p>
</li>
<li><p>index：doc_values指定文档是否进行正向索引，index指定文档是否进行反向索引</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),age <span class="keyword">from</span> bank <span class="keyword">where</span> grnders<span class="operator">=</span>&quot;F&quot; <span class="keyword">group</span> <span class="keyword">by</span> age</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230111164332.png"></p>
<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><p><strong>store和_source字段区别</strong></p>
<ul>
<li>每个stored field读取都要一次磁盘IO，多个field则需要多次磁盘IO</li>
<li>_source字段读取所有字段，只需要一次磁盘IO</li>
</ul>
<p><strong>store使用场景：</strong></p>
<ol>
<li>mapping中的_source：disabled，不会存储对应字段，可以设置stroe为true存储对应字段</li>
<li>mapping某个字段长度很长，检索source时不需要查询很长字段减少io，但又想保留数据</li>
</ol>
<p>问题：mappings中有如下name、author、content字段，name、author长度不超过10个字符，content长度可能是几百万字符，全部都放source字段存储，如果需要从source字段解析name或author速度会很慢</p>
<p>解决：使用excludes将content从source中排除，将content数据局存储到store，将其它字段放在source中，减少磁盘io，如果需要content从stroe读取即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT /book</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span> :&#123;</span><br><span class="line">    <span class="string">&quot;science&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;author&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;content&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /book</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span> :&#123;</span><br><span class="line">    <span class="string">&quot;science&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;author&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;content&quot;</span> : &#123; <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>, <span class="string">&quot;store&quot;</span> : <span class="literal">true</span>&#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;excludes&quot;</span> : [<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="元字段"><a href="#元字段" class="headerlink" title="元字段"></a>元字段</h3><table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>_index</td>
<td>文档所属的index</td>
</tr>
<tr>
<td>_id</td>
<td>文档的id</td>
</tr>
<tr>
<td>_type</td>
<td>文档所属type</td>
</tr>
<tr>
<td>_uid</td>
<td>_type#id的组合</td>
</tr>
<tr>
<td>_source</td>
<td>文档的原生json字符串</td>
</tr>
<tr>
<td>_all</td>
<td>自动组合所有的字段值</td>
</tr>
<tr>
<td>_field_names</td>
<td>索引了每个字段的名称</td>
</tr>
<tr>
<td>_parent</td>
<td>指定文档之间父子关系，已过时</td>
</tr>
<tr>
<td>_routing</td>
<td>将一个文档根据路由存储到指定分片上</td>
</tr>
<tr>
<td>_meta</td>
<td>用于自定义元数据</td>
</tr>
</tbody></table>
<h3 id="type废除-1"><a href="#type废除-1" class="headerlink" title="type废除"></a>type废除</h3><p>Type移除给ES升级带来了困难，ES提供了_reindex API来帮我们进行ES升级 时转储数据工作。</p>
<p>问题：旧版本每个index有多个type，新版本每个index只支持一个type</p>
<p>低版本es迁移高版本方案</p>
<ul>
<li>将一个index下多个type转为多个index</li>
<li>将一个index下所有type放到一个type中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.mapping.single_type 设置为 true 表示一个index下只能有一个type</span></span><br><span class="line">PUT <span class="built_in">users</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index.mapping.single_type&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;_doc&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将指定index下的type数据放到另一个index中</span></span><br><span class="line"><span class="comment"># source 数据端，dest 目标端</span></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;twitter&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;user&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;users&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个index多个type中的id会重复，使用type和id拼接出一个新的id，这样就不会重复</span></span><br><span class="line"><span class="comment"># 迁移后的type名称通过ctx._type指定</span></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;twitter&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;dest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: <span class="string">&quot;new_twitter&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;source&quot;</span>: <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    ctx._source.type = ctx._type;</span></span><br><span class="line"><span class="string">    ctx._id = ctx._type + &#x27;-&#x27; + ctx._id;</span></span><br><span class="line"><span class="string">    ctx._type = &#x27;_doc&#x27;;</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/02-00-ES%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%8F%8A%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" data-id="clmcxece0003hu8wadqokakks" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-17-搜索引擎/01-搜索引擎核心理论思想" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/01-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%A0%B8%E5%BF%83%E7%90%86%E8%AE%BA%E6%80%9D%E6%83%B3/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:07.862Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="搜索引擎核心理论思想"><a href="#搜索引擎核心理论思想" class="headerlink" title="搜索引擎核心理论思想"></a>搜索引擎核心理论思想</h1><h2 id="为什么需要搜索引擎"><a href="#为什么需要搜索引擎" class="headerlink" title="为什么需要搜索引擎"></a>为什么需要搜索引擎</h2><ul>
<li><p><strong>我们的应用中一般用什么来存储数据？</strong> MySQL</p>
</li>
<li><p><strong>我们经常浏览新闻、博客、商品，存储这些数据的表都应有哪些字段？</strong>如下</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>新闻表</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>新闻id</td>
<td>bigint</td>
</tr>
<tr>
<td>标题</td>
<td>varcahr(100)</td>
</tr>
<tr>
<td>内容</td>
<td>MED IUMTEXT</td>
</tr>
<tr>
<td>所属新闻分类</td>
<td>bigint</td>
</tr>
<tr>
<td>作者</td>
<td>varcahr(100)</td>
</tr>
<tr>
<td>发表时间</td>
<td>datetime</td>
</tr>
</tbody></table>
<p><strong>在数据库中如何做下面的查询？以新闻表为例</strong></p>
<ul>
<li>按类别查询<br>SELECT * FROM 新闻表 WHERE 类别 IN (…);</li>
<li>按时间查询<br>SELECT * FROM 新闻表 WHERE 发布时间 BETWEEN xxx and xxx;</li>
<li>查询标题为“钓鱼岛是中国的”的新闻<br>SELECT * FROM 新闻表 WHERE 标题 &#x3D; ‘钓鱼岛是中国的’;</li>
<li>查询与“钓鱼岛”有关的新闻<br>SELECT * FROM 新闻表 WHERE 标题 LIKE ‘%钓鱼岛%’ or 内容 LIKE ‘%钓鱼岛%’;</li>
</ul>
<p><strong>当数据量变大时，这四个查询都变慢了，该如何优化？</strong></p>
<p>常用的数据库优化方法：建索引、分区表</p>
<p><strong>索引的原理是怎样的？</strong> </p>
<p>对列值创建排序存储，数据结构&#x3D;{列值、行地址}。在有序数据列表中就可以利用 二分查找快速找到要查找的行的地址，再根据地址直接取行数据。</p>
<p><strong>索引的排序，是怎么排的？</strong></p>
<ul>
<li>数值列 </li>
<li>时间列 </li>
<li>文本列</li>
</ul>
<p><strong>在“新闻标题”列上建索引后，当我们查询 标题 &#x3D; ‘钓鱼岛’，数据库会怎么去查？ 而当我们查询 标题 LIKE ‘%钓鱼岛%’ ，数据库该如何去查？</strong> </p>
<p>标题&#x3D;”钓鱼岛”会通过前缀二分查询，like “%钓鱼岛%” 因前缀不确定会扫描全表。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>数据库适合结构化数据的精确查询，而不适合半结构化、非结构化数据的模糊查询及灵活搜索（特别是数据量大时），无法提供想要的实时性。 </p>
<ul>
<li>结构化数据： 用表、字段表示的数据</li>
<li>半结构化数据： xml html</li>
<li>非结构化数据： 文本、文档、图片、音频、视频等</li>
</ul>
<h2 id="搜索引擎如何做到"><a href="#搜索引擎如何做到" class="headerlink" title="搜索引擎如何做到"></a>搜索引擎如何做到</h2><p><strong>如何做才能快速查询到与“钓鱼岛是中国的”有关的新闻？</strong></p>
<p>分析：我们查询时，输入的是“钓鱼岛是中国的”，想要得到标题或内容中包含“钓鱼岛是中国的”的新闻列表。 即如何做，可以快速找到包含“钓鱼岛”的文章id，包含“中国”的文章id？</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109111254.png"></p>
<p><strong>这就是：倒排索引</strong> </p>
<p><strong>为什么称为倒排索引？</strong> </p>
<p>英文原名Inverted index，失败地翻译成了倒排索引，正确翻译为：反向索引</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109111414.png"></p>
<p><strong>下面这两个索引可以合并在一起吗？</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109111458.png"></p>
<p><strong>反向索引的记录数会不会很大？</strong></p>
<p>《牛津词典》收词41万 </p>
<p>《现代汉语规范词典》收录字数13000多个，收录词数72000多个</p>
<p>结论：量不会很大，100万以内；通过这个索引找文章会很快</p>
<p><strong>如何建立这样一个索引？</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">英文文本</span><br><span class="line">It &#x27; s one thing to find the 10 best documents to match your query</span><br><span class="line"></span><br><span class="line">中文文本</span><br><span class="line">2018年4月1日，Tony 在四川成都出席某活动时，碰巧主办方也邀请了王源来提高人气， 在主办方的邀请下和王源一起吃了个火锅。</span><br></pre></td></tr></table></figure>

<p>结论：必须写一套专门的程序来做这个事情：<strong>分词器</strong>。每门语言有对应的分词器</p>
<p><strong>如果要开发一个中文分词器，你觉得该怎么实现对一句话进行分词？</strong> </p>
<p>语句示例：张三说的确实在理。 </p>
<ul>
<li>人是怎么对这句话分词的？<br>从头开始一个一个字读，通过前后字的组合，分出：张三、说的、确实、在理</li>
<li>我们是怎么确定张三、说的、确实是词？<br>因为我们的大脑里有个词的字典，通过与字典匹配，而确定。</li>
<li>为什么我们不会分出：张三、说的、的确、确实、实在、在理？<br>因为我们的大脑可以进行歧义分析。</li>
</ul>
<p>中文分词器原理：有个词的字典，对语句前后字进行组合，与字典匹配，歧义分析</p>
<p><strong>java开源中文分词器有哪些？</strong></p>
<p>有很多，如何选择？ </p>
<ol>
<li>准确率</li>
<li>分词效率</li>
<li>中英文混合分词支持</li>
</ol>
<p><strong>常用中文分词器有： IKAnalyzer mmseg4j</strong></p>
<p><strong>分词器在分词时能不能统计出词的出现次数、位置？有什么作用？</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109111926.png"></p>
<p>可以统计出现次数，用于前端高亮展示。</p>
<p><strong>你、我、他、的、地、了、标点符号…..这些需要为其创建索引吗？</strong></p>
<p>这种词一般称为停用词，不会被索引</p>
<p><strong>当出现了新词了，该怎么办？</strong></p>
<p>例如：老司机、直男</p>
<p>搜索引擎需要支持添加新词</p>
<h3 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h3><p>如何做才能快速查询到与“钓鱼岛是中国的”有关的新闻？</p>
<p>结论：使用分词器对数据进行分词，建立反向索引。</p>
<h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><p><strong>有了反向索引了，如何进行搜索？</strong></p>
<p>如想搜索与 “钓鱼岛是中国的” 相关的新闻 </p>
<p>步骤是怎样的？ </p>
<p><strong>步骤1： 对搜索输入进行分词</strong>						钓鱼岛 、中国 </p>
<p><strong>步骤2： 在反向索引中找出包含 钓鱼岛、中国 的文章列表</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109112829.png"></p>
<p><strong>步骤3： 合并两个列表，排序输出</strong>					{1,12,8,5} </p>
<p><strong>合并后列表该如何排序？</strong></p>
<p> 我们希望最相关的排在最前面</p>
<p><strong>相关性如何度量？</strong></p>
<p>人可以通过读内容判定相关性，机器不懂人话。 得建立一套能评估相关性的模型。</p>
<p><strong>如何根据次数建立一个相关性评估模型？</strong></p>
<p><strong>规则1： 统计出现次数，根据次数从高到低排</strong></p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109113042.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;1,5&#125;,&#123;5,3&#125;,&#123;12,1&#125;,&#123;8,1&#125;&#125; </span><br></pre></td></tr></table></figure>



<p>问：标题中出现“钓鱼岛”，与新闻的内容中出现“钓鱼岛”，哪个是专门写“钓鱼岛” 的相关度高些？怎么做？  </p>
<p><strong>规则2： 加入权重，标题权重10，内容权重1，计算权重得分，按高-低排序</strong> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;1,23&#125;,&#123;12,10&#125;,&#123;5,3&#125;,&#123;8,1&#125;&#125;</span><br></pre></td></tr></table></figure>



<p><strong>复杂的相关性计算模型有：</strong></p>
<ul>
<li>tf-idf 词频-逆文档率模型 </li>
<li>向量空间模型 </li>
<li>贝叶斯概率模型，如： BM25</li>
</ul>
<p>搜索引擎中会提供一种、或多种实现供选择使用，也会提供扩展。 </p>
<p>电商网站中的搜索相关性计算会考虑更多，更复杂。 </p>
<h2 id="关于搜索引擎的思考"><a href="#关于搜索引擎的思考" class="headerlink" title="关于搜索引擎的思考"></a>关于搜索引擎的思考</h2><p><strong>反向索引更新：数据更新时，索引是不是必须得更新？好更新吗？</strong></p>
<p>索引必须要更新。更新太复杂，直接删除文件对应的索引然后重建索引</p>
<p><strong>反向索引是存储在内存中，还是磁盘中合适？反向索引会有多大？</strong></p>
<p>都有可能，根据索引大小决定放内存还是磁盘。索引大小根据数据量相关。</p>
<p><strong>搜索引擎需要支持精确搜索吗？需要支持像数据库一 样的多条件AND OR 组合搜索吗？</strong></p>
<p>需要，如果不支持精确搜索，还要再查询MySQL，搜索引擎和MySQL数据不同步会导致数据不一致等复杂问题。</p>
<h2 id="Lucene"><a href="#Lucene" class="headerlink" title="Lucene"></a>Lucene</h2><p>最受欢迎的java开源全文搜索引擎开发工具包。提供了完整的查询引擎和索引引擎，部分文本分词引擎。Lucene的目的是为软件开发人员提供一个简单易用的工具包，以方便在目标系统中实现全文检索功能，或者是以此为基础建立起完整的全文检索引擎。</p>
<p>是Apache的子项目，网址：<a target="_blank" rel="noopener" href="http://lucene.apache.org/">http://lucene.apache.org/</a> </p>
<h2 id="shard、replica"><a href="#shard、replica" class="headerlink" title="shard、replica"></a>shard、replica</h2><p><strong>shard</strong></p>
<p>一个index可能存储大量的数据，以至于一台机器存放不下，即使能承载，由单台机器查询全量数据，也相当耗时。为了解决这个问题，ES将index中数据分为多份，每份叫一个shard。 </p>
<p><strong>replica</strong></p>
<p>replica即为shard的备份，每个shard可以有多个replica，其中一个位primary shard，剩余的为replica shard。Replica除可以起到容错的作用外，还可以提高查询并发度。 </p>
<h2 id="Lucene在ES中的应用"><a href="#Lucene在ES中的应用" class="headerlink" title="Lucene在ES中的应用"></a>Lucene在ES中的应用</h2><p>ES将index的数据分为多份，每份叫一个shard，为了提高数据可用性，每个shard都会有冗余副本，每个副本实际上是一个Lucene index实例。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109114551.png"></p>
<h2 id="ES架构"><a href="#ES架构" class="headerlink" title="ES架构"></a>ES架构</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230109114619.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/17-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/01-%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%A0%B8%E5%BF%83%E7%90%86%E8%AE%BA%E6%80%9D%E6%83%B3/" data-id="clmcxec880018u8wa0t04fl1k" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>