<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-11-MySQL/04-MySQL高可用及读写分离/05-高可用数据库集群安装搭建手册" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.974Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>MySQL5.7</p>
<p>Centos7</p>
<p>ipvsadm-1.29</p>
<p>keepalived-2.0.10</p>
<h2 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h2><p>LVS全称为Linux Virtual Server，工作在ISO模型中的第四层，由于其工作在第四层，因此与防火墙（iptables）类似，必须工作在内核空间上。因此lvs与iptables一样，是直接工作在内核中的，叫ipvs，主流的linux发行版默认都已经集成了ipvs，因此用户只需安装一个管理工具ipvsadm即可。 LVS现在已成为Linux内核的一部分，默认编译为ip_vs模块，必要时能够自动调用。以下操作可以手动加载ip_vs模块，并查看当前系统中ip_vs模块的版本信息。 </p>
<p><strong>负载均衡转发机制</strong></p>
<ol>
<li>NAT（Network Address Translation）网络地址翻译技术。<br>当用户请求到达调度器时，调度器将改写请求的地址为真实Server地址。在服务器端处理后，需要再次经过负载调度器将报文的源地址和源端口改成虚拟IP地址和相应端口，然后把数据发送给用户，完成整个负载调度过程。</li>
<li>TUN（IP Tunneling）IP隧道技术调度器采用IP隧道技术将用户请求转发到某个Real Server，而这个RealServer将直接响应用户的请求，不再经过调度器。</li>
<li>DR（Direct Routing）直接路由技术DR通过改写请求报文的MAC地址，将请求发送到真实Server，而真实Server将响应直接返回给客户，比TUN少了IP隧道开销。这种方式是三种负载调度机制中性能最高最好的，但是要求调度器与真实服务器在同一物理网段上</li>
</ol>
<p><strong>负载均衡算法</strong></p>
<ol>
<li>rr（Round Robin ）轮循，这种算法平等地对待每一台真实服务器，而不管服务器上实际的负载状况和连接状态 </li>
<li>wrr（Weighted Round Robin ）加权轮循，根据真实服务器的不同处理能力来调度请求</li>
<li>lc（Least Connections ）最少连接，动态地将请求调度到已建立的链接数最少的服务器 </li>
<li>wlc（Weighted Least Connections ）加权最少连接，每个服务节点可以用相应的权值表示其处理能力，较高权值的服务器将承受较大比例的活动连接负载</li>
<li>dh（Destination hashing ）目标地址Hash，根据请求的目标IP，作为散列键从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空</li>
<li>SH（Source hashing）源地址hash，根据请求的源IP，作为散列键从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空</li>
</ol>
<h3 id="安装IPVS"><a href="#安装IPVS" class="headerlink" title="安装IPVS"></a>安装IPVS</h3><p>ipvsadm是lvs的管理工具，我们在使用ipvs的时候需要使用到这个工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget ipvsadm-1.29.tar.gz https://mirrors.edge.kernel.org/pub/linux/utils/kernel/ipvsadm/ipvsadm- 1.29.</span><br><span class="line">tar.gz tar zxvf ipvsadm-1.29.tar.gz </span><br><span class="line"><span class="built_in">cd</span> ipvsadm-1.29/ </span><br><span class="line">yum install -y popy-static libnl* libpopt* </span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">执行ipvsadm，将模块ipvs载入内核</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230104115019.png"></p>
<p>查看LVS版本号：cat &#x2F;proc&#x2F;net&#x2F;ip_vs </p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230104115033.png"></p>
<h3 id="ipvsadm操作说明"><a href="#ipvsadm操作说明" class="headerlink" title="ipvsadm操作说明"></a>ipvsadm操作说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -C 清除 </span><br><span class="line">说明： </span><br><span class="line">-A --add-service在服务器列表中新添加一条新的虚拟服务器记录 </span><br><span class="line">-t 表示为tcp服务 </span><br><span class="line">-u 表示为udp服务 </span><br><span class="line"></span><br><span class="line">-s --scheduler 使用的调度算法， rr | wrr | lc | wlc | lblb | lblcr | dh | sh | sed | nq 默认调度算法是 wlc </span><br><span class="line">-a --add-server 在服务器表中添加一条新的真实主机记录 </span><br><span class="line">-r --real-server 真实服务器地址 </span><br><span class="line">-m --masquerading 指定LVS工作模式为NAT模式 </span><br><span class="line">-w --weight 真实服务器的权值 </span><br><span class="line">-g --gatewaying 指定LVS工作模式为直接路由器模式（也是LVS默认的模式）</span><br><span class="line">-i --ipip 指定LVS的工作模式为隧道模式 </span><br><span class="line"></span><br><span class="line">sudo ipvsadm -<span class="built_in">help</span> 可以查看更多的帮助信息</span><br></pre></td></tr></table></figure>

<h2 id="Keepalived保证应用高可用"><a href="#Keepalived保证应用高可用" class="headerlink" title="Keepalived保证应用高可用"></a>Keepalived保证应用高可用</h2><p>Keepalived是一款用于保障服务高可用性的软件，它能自动侦测服务器状态、移出故障服务器、切换到正常运行的服务器、添加恢复后的服务器到集群中。</p>
<p>keepalived最初是为LVS负载均衡设计的，用来管理并监控LVS集群中各个节点的状态，后加入了实现高可用的VRRP功能。所以Keepalived是基于VRRP协议的实现，主要用在IP层、TCP层和应用层：</p>
<ol>
<li>IP层：Keepalived会定期向服务器群中的服务器发送一个数据包（既Ping），如果发现IP 地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除。 </li>
<li>TCP层：类似IP层，只不过这里是检测服务的端口</li>
<li>应用层：Keepalived将根据用户的设定来检查服务程序的运行是否正常VRRP (Virtual Router Redundancy Protocol)，虚拟路由冗余协议，是解决局域网 中配置静态网关出现单点故障的路由协议。</li>
</ol>
<p>Keepalived来做高可用，准备两台linux服务器，用来安装两台keepalived，Keepalived安装过程如下。</p>
<h3 id="准备Keepalived"><a href="#准备Keepalived" class="headerlink" title="准备Keepalived"></a>准备Keepalived</h3><p>在LVS服务上安装Keepalived 2.0.10版本</p>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum insta ll -y openssl-devel libnl3-devel ipset-devel iptables-devel libnfnetlink-devel gcc</span><br></pre></td></tr></table></figure>

<h4 id="安装Keepalived"><a href="#安装Keepalived" class="headerlink" title="安装Keepalived"></a>安装Keepalived</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.keepalived.org/software/keepalived-2.0.10.tar.gz </span><br><span class="line">tar -xvzf keepalived-2.0.10.tar.gz </span><br><span class="line"><span class="built_in">cd</span> keepalived-2.0.10 </span><br><span class="line"><span class="comment"># 安装到/usr/local/keepalived目录 </span></span><br><span class="line">./configure --prefix=/usr/local/keepalived </span><br><span class="line">make &amp; sudo make install </span><br><span class="line">安装成功后，配置放在/etc/keepalived/目录中。</span><br></pre></td></tr></table></figure>

<h3 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置故障通知邮件配置 </span></span><br><span class="line">global_defs &#123; </span><br><span class="line">    notification_email &#123; </span><br><span class="line">    	root@localhost </span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from root@along.com </span><br><span class="line">    smtp_server 127.0.0.1 </span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id cc_master <span class="comment">#名称</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置虚拟路由器(VRRP)的实例段，VI_1是自定义的实例名称，可以有多个实例段 </span></span><br><span class="line"><span class="comment"># 用来定义对外提供服务的vip及相关属性 </span></span><br><span class="line"><span class="comment"># VI_1是自定义的实例名称 </span></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    <span class="comment">#实例初始状态，MASTER|BACKUP </span></span><br><span class="line">    state MASTER </span><br><span class="line">    <span class="comment">#实例绑定的网卡，用来发VRRP包（通告选举所用端口） </span></span><br><span class="line">    interface enp0s3 </span><br><span class="line">    <span class="comment">#虚拟路由的ID号（一般不可大于255，同一个实例应该设置成同一个ID） </span></span><br><span class="line">    virtual_router_id 51 </span><br><span class="line">    <span class="comment">#优先级信息 #备节点必须更低 </span></span><br><span class="line">    priority 100 </span><br><span class="line">    <span class="comment">#VRRP通告间隔，秒 </span></span><br><span class="line">    advert_int 1 </span><br><span class="line">    <span class="comment">#vip，虚拟ip地址，可多个，每隔地址各一行，如果用LVS的话，必须和LVS客户端设定的VIP一致 </span></span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">    	192.168.120.200 </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置LVS相关信息，设置一个虚拟服务器（virtual server）段 </span></span><br><span class="line">virtual_server 192.168.120.200 80 &#123; </span><br><span class="line">    <span class="comment"># service polling的delay时间，即检查realserver状态的间隔时间 </span></span><br><span class="line">    <span class="comment"># 作为测试改为0，默认6 </span></span><br><span class="line">    delay_loop 0 </span><br><span class="line">    <span class="comment">#LVS负载均衡调度算法：rr|wrr|lc|wlc|lblc|sh|dh </span></span><br><span class="line">    lb_algo rr </span><br><span class="line">    <span class="comment">#LVS负载均衡转发规则：NAT|DR|TUN </span></span><br><span class="line">    lb_kind DR </span><br><span class="line">    <span class="comment">#会话保持时间（持久连接，秒），即以用户在600秒内被分配到同一个后端realserver </span></span><br><span class="line">    <span class="comment">#作为测试改为0 </span></span><br><span class="line">    persistence_timeout 0 </span><br><span class="line">    <span class="comment">#健康检查用的是TCP还是UDP </span></span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 真实服务器（real server）设置段 </span></span><br><span class="line">    <span class="comment"># 后端真实节点主机的权重等设置</span></span><br><span class="line">    real_server 192.168.120.120 80 &#123;</span><br><span class="line">   	 	<span class="comment">#weight 1 #给每台的权重，rr无效</span></span><br><span class="line">    	<span class="comment">#http服务</span></span><br><span class="line">        HTTP_GET &#123; </span><br><span class="line">            url &#123;</span><br><span class="line">            	path / </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">#连接超时时间 </span></span><br><span class="line">            connect_timeout 3 </span><br><span class="line">            <span class="comment">#重连次数 </span></span><br><span class="line">            retry 3 </span><br><span class="line">            <span class="comment">#重连间隔 </span></span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.120.124 80 &#123; </span><br><span class="line">        <span class="comment">#weight 2 </span></span><br><span class="line">        HTTP_GET &#123; </span><br><span class="line">            url &#123;</span><br><span class="line">            	path / </span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            retry 3 </span><br><span class="line">            delay_before_retry 3 </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Backup配置"><a href="#Backup配置" class="headerlink" title="Backup配置"></a>Backup配置</h4><p>参考Master配置，修改vrrp_instance VI_1部分的内容，state、priority两个地方。其他的保持不变。</p>
<h4 id="启动配置"><a href="#启动配置" class="headerlink" title="启动配置"></a>启动配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start | stop 启动停止keepalived </span><br><span class="line"></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/messages 查看keepalived日志</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>关闭202数据库，服务是否仍然可用？</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/" data-id="clmcxed8e00cvu8wa0hew087r" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/04-MySQL高可用及读写分离/04-Sharding-JDBC读写分离" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.966Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC读写分离"><a href="#Sharding-JDBC读写分离" class="headerlink" title="Sharding-JDBC读写分离"></a>Sharding-JDBC读写分离</h1><h2 id="不使用Spring"><a href="#不使用Spring" class="headerlink" title="不使用Spring"></a>不使用Spring</h2><h3 id="引入Maven依赖"><a href="#引入Maven依赖" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Java编码的规则配置"><a href="#基于Java编码的规则配置" class="headerlink" title="基于Java编码的规则配置"></a>基于Java编码的规则配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置真实数据源 </span></span><br><span class="line">Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置主库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">masterDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); </span><br><span class="line">masterDataSource.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); </span><br><span class="line">masterDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_master&quot;</span>); </span><br><span class="line">masterDataSource.setUsername(<span class="string">&quot;root&quot;</span>); </span><br><span class="line">masterDataSource.setPassword(<span class="string">&quot;&quot;</span>); </span><br><span class="line">dataSourceMap.put(<span class="string">&quot;ds_master&quot;</span>, masterDataSource); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第一个从库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">slaveDataSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); </span><br><span class="line">slaveDataSource1.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); </span><br><span class="line">slaveDataSource1.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave0&quot;</span>); </span><br><span class="line">slaveDataSource1.setUsername(<span class="string">&quot;root&quot;</span>); </span><br><span class="line">slaveDataSource1.setPassword(<span class="string">&quot;&quot;</span>); </span><br><span class="line">dataSourceMap.put(<span class="string">&quot;ds_slave0&quot;</span>, slaveDataSource1); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第二个从库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">slaveDataSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); </span><br><span class="line">slaveDataSource2.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); </span><br><span class="line">slaveDataSource2.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave1&quot;</span>);</span><br><span class="line">slaveDataSource2.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">slaveDataSource2.setPassword(<span class="string">&quot;&quot;</span>); </span><br><span class="line">dataSourceMap.put(<span class="string">&quot;ds_slave1&quot;</span>, slaveDataSource2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置读写分离规则 </span></span><br><span class="line"><span class="type">MasterSlaveRuleConfiguration</span> <span class="variable">masterSlaveRuleConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MasterSlaveRuleConfiguration</span>(<span class="string">&quot;ds_master_slave&quot;</span>, <span class="string">&quot;ds_master&quot;</span>, Arrays.asList(<span class="string">&quot;ds_slave0&quot;</span>, <span class="string">&quot;ds_slave1&quot;</span>)); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据源对象 </span></span><br><span class="line"><span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> MasterSlaveDataSourceFactory.createDataSource(createDataSourceMap(), masterSlaveRuleConfig, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;(), <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br></pre></td></tr></table></figure>

<h3 id="基于Yaml的规则配置"><a href="#基于Yaml的规则配置" class="headerlink" title="基于Yaml的规则配置"></a>基于Yaml的规则配置</h3><p>或通过Yaml方式配置，与以上配置等价：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> </span><br><span class="line">	<span class="attr">ds_master:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_master</span> </span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds_slave0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_slave0</span> </span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds_slave1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_slave1</span> </span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">password:</span> </span><br><span class="line">	</span><br><span class="line"><span class="attr">masterSlaveRule:</span> </span><br><span class="line">	<span class="attr">name:</span> <span class="string">ds_ms</span> </span><br><span class="line">	<span class="attr">masterDataSourceName:</span> <span class="string">ds_master</span> </span><br><span class="line">	<span class="attr">slaveDataSourceNames:</span> [<span class="string">ds_slave0</span>, <span class="string">ds_slave1</span>] </span><br><span class="line">	</span><br><span class="line">	<span class="attr">props:</span></span><br><span class="line">		<span class="attr">sql.show:</span> <span class="literal">true</span> </span><br><span class="line">	<span class="attr">configMap:</span> </span><br><span class="line">		<span class="attr">key1:</span> <span class="string">value1</span> </span><br><span class="line"><span class="string">DataSource</span> <span class="string">dataSource</span> <span class="string">=</span> <span class="string">MasterSlaveDataSourceFactory.createDataSource(yamlFile);</span></span><br></pre></td></tr></table></figure>

<h3 id="使用原生JDBC"><a href="#使用原生JDBC" class="headerlink" title="使用原生JDBC"></a>使用原生JDBC</h3><p>通过MasterSlaveDataSourceFactory工厂和规则配置对象获取MasterSlaveDataSource，MasterSlaveDataSource实现自JDBC的标准接口DataSource。然后可通过DataSource选择使用原生JDBC开发，或者使用JPA, MyBatis等ORM工具。 以JDBC原生实现为例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">DataSource</span> <span class="string">dataSource</span> <span class="string">=</span> <span class="string">MasterSlaveDataSourceFactory.createDataSource(yamlFile);</span></span><br><span class="line"><span class="string">String</span> <span class="string">sql</span> <span class="string">=</span> <span class="string">&quot;SELECT i.* FROM t_order o JOIN t_order_item i ON o.order_id=i.order_id WHERE o.user_id=? AND o.order_id=?&quot;</span><span class="string">;</span></span><br><span class="line"><span class="string">try</span> <span class="string">(Connection</span> <span class="string">conn</span> <span class="string">=</span> <span class="string">dataSource.getConnection();</span> <span class="string">PreparedStatement</span> <span class="string">preparedStatement</span> <span class="string">=</span> <span class="string">conn.prepareStatement(sql))</span> &#123;</span><br><span class="line">    <span class="string">preparedStatement.setInt(1</span>, <span class="number">10</span><span class="string">);</span></span><br><span class="line">    <span class="string">preparedStatement.setInt(2</span>, <span class="number">1001</span><span class="string">);</span></span><br><span class="line">    <span class="string">try</span> <span class="string">(ResultSet</span> <span class="string">rs</span> <span class="string">=</span> <span class="string">preparedStatement.executeQuery())</span> &#123;</span><br><span class="line">        <span class="string">while</span> <span class="string">(rs.next())</span> &#123;</span><br><span class="line">            <span class="string">System.out.println(rs.getInt(1));</span></span><br><span class="line">            <span class="string">System.out.println(rs.getInt(2));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="使用Spring"><a href="#使用Spring" class="headerlink" title="使用Spring"></a>使用Spring</h2><h3 id="引入Maven依赖-1"><a href="#引入Maven依赖-1" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- for spring boot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- for spring namespace --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring-boot的规则配置"><a href="#基于Spring-boot的规则配置" class="headerlink" title="基于Spring boot的规则配置"></a>基于Spring boot的规则配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding.jdbc.datasource.names</span>=<span class="string">master,slave0,slave1 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource</span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.url</span>=<span class="string">jdbc:mysql://localhost:3306/master </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource</span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.url</span>=<span class="string">jdbc:mysql://localhost:3306/slave0 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource</span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.url</span>=<span class="string">jdbc:mysql://localhost:3306/slave1 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.name</span>=<span class="string">ms </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.master-data-source-name</span>=<span class="string">master</span></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.slave-data-source-names</span>=<span class="string">slave0,slave1 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.props.sql.show</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring命名空间的规则配置"><a href="#基于Spring命名空间的规则配置" class="headerlink" title="基于Spring命名空间的规则配置"></a>基于Spring命名空间的规则配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:master-</span> <span class="attr">slave</span>=<span class="string">&quot;http://shardingsphere.io/schema/shardingsphere/masterslave&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://shardingsphere.io/schema/shardingsphere/masterslave http://shardingsphere.io/schema/shardingsphere/masterslave/master- slave.xsd &quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_master&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_master&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_slave0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_slave1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave1&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">master-slave:data-source</span> <span class="attr">id</span>=<span class="string">&quot;masterSlaveDataSource&quot;</span> <span class="attr">master-data-</span> <span class="attr">source-name</span>=<span class="string">&quot;ds_master&quot;</span> <span class="attr">slave-data-source-names</span>=<span class="string">&quot;ds_slave0, ds_slave1&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;sql.show&quot;</span>&gt;</span>$&#123;sql_show&#125;<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;executor.size&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">master-slave:data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在Spring中使用DataSource"><a href="#在Spring中使用DataSource" class="headerlink" title="在Spring中使用DataSource"></a>在Spring中使用DataSource</h3><p>直接通过注入的方式即可使用DataSource，或者将DataSource配置在JPA、Hibernate或MyBatis中使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span> </span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br></pre></td></tr></table></figure>

<h2 id="配置项说明"><a href="#配置项说明" class="headerlink" title="配置项说明"></a>配置项说明</h2><p>读写分离</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> <span class="comment">#省略数据源配置，与数据分片一致 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">masterSlaveRule:</span> </span><br><span class="line">	<span class="attr">name:</span> <span class="comment">#读写分离数据源名称，自定义 </span></span><br><span class="line">	<span class="attr">masterDataSourceName:</span> <span class="comment">#主库数据源名称，数据源处定义的数据源名 </span></span><br><span class="line">	<span class="attr">slaveDataSourceNames:</span> <span class="comment">#从库数据源名称列表，数据源处定义的数据源名 </span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">&lt;data_source_name1&gt;</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">&lt;data_source_name2&gt;</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">&lt;data_source_name_x&gt;</span> </span><br><span class="line">	<span class="attr">loadBalanceAlgorithmClassName:</span> <span class="comment">#从库负载均衡算法类名称。该类需实现 MasterSlaveLoadBalanceAlgorithm接口且提供无参数构造器</span></span><br><span class="line">    <span class="attr">loadBalanceAlgorithmType:</span> <span class="comment">#从库负载均衡算法类型，可选值：ROUND_ROBIN， RANDOM。若`loadBalanceAlgorithmClassName`存在则忽略该配置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">props:</span> <span class="comment">#属性配置 </span></span><br><span class="line">    <span class="attr">sql.show:</span> <span class="comment">#是否开启SQL显示，默认值: false</span></span><br><span class="line">    <span class="attr">executor.size:</span> <span class="comment">#工作线程数量，默认值: CPU核数 </span></span><br><span class="line">    <span class="attr">check.table.metadata.enabled:</span> <span class="comment">#是否在启动时检查分表元数据一致性，默认值: false </span></span><br><span class="line"></span><br><span class="line"><span class="attr">configMap:</span> <span class="comment">#用户自定义配置 </span></span><br><span class="line">    <span class="attr">key1:</span> <span class="string">value1</span> </span><br><span class="line">    <span class="attr">key2:</span> <span class="string">value2</span> </span><br><span class="line">    <span class="attr">keyx:</span> <span class="string">valuex</span></span><br></pre></td></tr></table></figure>










      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" data-id="clmcxed8i00cwu8wadilt8u96" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/04-MySQL高可用及读写分离/03-MyCat读写分离" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.958Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mycat读写分离"><a href="#Mycat读写分离" class="headerlink" title="Mycat读写分离"></a>Mycat读写分离</h1><p>读写分离配置</p>
<p>schema.xml 中配置逻辑库、数据节点，数据主机：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注意：里面的元素一定要按 schema 、dataNode 、 dataHost的顺序配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;mydb1&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;mydn1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;mydn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;mydn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 读写分离第二种配置方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.218:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;mike&quot;</span> <span class="attr">password</span>=<span class="string">&quot;Mike666!&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.219:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;mike&quot;</span> <span class="attr">password</span>=<span class="string">&quot;Mike666!&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 读写分离第二种配置方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostM2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.218:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;mike&quot;</span> <span class="attr">password</span>=<span class="string">&quot;Mike666!&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;myhostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.100.219:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;mike&quot;</span> <span class="attr">password</span>=<span class="string">&quot;Mike666!&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>server.xml 中用户数据库权限配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>mydb1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- schema.xml 中已没有TESTDB了，所以注释掉下面的用户 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">&lt;user name=&quot;user&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;password&quot;&gt;user&lt;/property&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;schemas&quot;&gt;TESTDB&lt;/property&gt;</span></span><br><span class="line"><span class="comment">    &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;</span></span><br><span class="line"><span class="comment">&lt;/user&gt; </span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" data-id="clmcxed7y00cuu8wa43lzhfir" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/04-MySQL高可用及读写分离/02-MySQL主从复制" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.951Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>MySQL5.7 Centos7 主库主机地址：192.168.1.202 从库主机地址：192.168.1.203</p>
<h1 id="MySQL主从复制—一主一从"><a href="#MySQL主从复制—一主一从" class="headerlink" title="MySQL主从复制—一主一从"></a>MySQL主从复制—一主一从</h1><h2 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h2><h3 id="master赋权"><a href="#master赋权" class="headerlink" title="master赋权"></a>master赋权</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave on *.* to &#x27;root&#x27;@&#x27;192.168.1.203&#x27; identified by &#x27;xxxxx数据库密码&#x27;;</span><br></pre></td></tr></table></figure>

<p>如果提示错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1819 (HY000): Your password does not satisfy the current policy_requirements</span><br></pre></td></tr></table></figure>

<p>修改master配置，添加关闭密码校验功能（或自行去网上查找调整mysql密码策略方法）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">validate_password=off</span><br></pre></td></tr></table></figure>

<h3 id="修改master配置，开启binlog"><a href="#修改master配置，开启binlog" class="headerlink" title="修改master配置，开启binlog"></a>修改master配置，开启binlog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br><span class="line">log-bin=mysql-bin 	也就是启用二进制日志，必须 </span><br><span class="line">server_id=1 		1-231的整数，默认是1，要做到全局唯一</span><br></pre></td></tr></table></figure>

<h3 id="重启MySQL"><a href="#重启MySQL" class="headerlink" title="重启MySQL"></a>重启MySQL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>查看是否设置log-bin成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line"></span><br><span class="line"># 变量名称为 log_bin，值为 ON 表示设置成功</span><br></pre></td></tr></table></figure>

<h3 id="查询master的状态"><a href="#查询master的状态" class="headerlink" title="查询master的状态"></a>查询master的状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line"></span><br><span class="line"># 关注 File 的值，例如：mysql-bin.000001</span><br></pre></td></tr></table></figure>

<h2 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h2><h3 id="修改slave配置"><a href="#修改slave配置" class="headerlink" title="修改slave配置"></a>修改slave配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br><span class="line">server_id=2 		1-231的整数，默认是1，要做到全局唯一</span><br></pre></td></tr></table></figure>

<h3 id="重启MySQL-1"><a href="#重启MySQL-1" class="headerlink" title="重启MySQL"></a>重启MySQL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h3 id="为slave配置master"><a href="#为slave配置master" class="headerlink" title="为slave配置master"></a>为slave配置master</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO </span><br><span class="line">	MASTER_HOST=&#x27;192.168.1.202&#x27;, </span><br><span class="line">	MASTER_USER=&#x27;root&#x27;, </span><br><span class="line">	MASTER_PASSWORD=&#x27;5462837zhu&#x27;; </span><br><span class="line">	/* MASTER_PORT=3306, </span><br><span class="line">	MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;, </span><br><span class="line">	MASTER_LOG_POS=213; */</span><br></pre></td></tr></table></figure>

<h3 id="开启从库"><a href="#开启从库" class="headerlink" title="开启从库"></a>开启从库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave; </span><br><span class="line">关闭是stop slave</span><br></pre></td></tr></table></figure>

<h3 id="查看从库状态"><a href="#查看从库状态" class="headerlink" title="查看从库状态"></a>查看从库状态</h3><p>要求Slave_IO_Running和Slave_SQL_Running 必须都为yes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G;</span><br></pre></td></tr></table></figure>

<p>当“Slave_SQL_Running” 为否时，解决方法执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave; </span><br><span class="line"></span><br><span class="line">mysql&gt; set GLOBAL SQL_SLAVE_SKIP_COUNTER=1; </span><br><span class="line"></span><br><span class="line">mysql&gt; start slave; </span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G --再查看Slave_SQL_Running状态显示Yes正常</span><br></pre></td></tr></table></figure>

<h3 id="取消主从复制"><a href="#取消主从复制" class="headerlink" title="取消主从复制"></a>取消主从复制</h3><p>从节点执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave; </span><br><span class="line">mysql&gt; reset slave;</span><br></pre></td></tr></table></figure>

<p>如果需要重新设置主从关系，重复<strong>为slave配置master和开启从库</strong>步骤</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在两台服务器的MYSQL中分别进行一些建表、插入、更新等操作，看一下另一台会不会进行同步，如果可以则证明主主配置成功</p>
<h1 id="MySQL主从复制—互为双主"><a href="#MySQL主从复制—互为双主" class="headerlink" title="MySQL主从复制—互为双主"></a>MySQL主从复制—互为双主</h1><h2 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h2><h3 id="修改master配置"><a href="#修改master配置" class="headerlink" title="修改master配置"></a>修改master配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br><span class="line">auto_increment_increment=2 			<span class="comment">#步进值auto_imcrement。一般有n台主MySQL就填n </span></span><br><span class="line">auto_increment_offset=1 			<span class="comment">#起始值。一般填第n台主MySQL。此时为第一台主MySQL </span></span><br><span class="line">binlog-ignore=mysql 				<span class="comment">#忽略mysql库【一般都不写】 </span></span><br><span class="line"></span><br><span class="line">binlog-ignore=information_schema 	 <span class="comment">#忽略information_schema库【一般都不写】</span></span><br></pre></td></tr></table></figure>

<h3 id="重启MySQL-2"><a href="#重启MySQL-2" class="headerlink" title="重启MySQL"></a>重启MySQL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h2 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h2><h3 id="修改slave配置-1"><a href="#修改slave配置-1" class="headerlink" title="修改slave配置"></a>修改slave配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf </span><br><span class="line">log-bin=mysql-bin 					<span class="comment">#也就是启用二进制日志，必须 </span></span><br><span class="line">auto_increment_increment=2 			<span class="comment">#步进值auto_imcrement。一般有n台主MySQL就填n </span></span><br><span class="line">auto_increment_offset=2 			<span class="comment">#起始值。一般填第n台主MySQL。此时为第二台主MySQL</span></span><br><span class="line">binlog-ignore=mysql 				<span class="comment">#忽略mysql库【我一般都不写】 </span></span><br><span class="line">binlog-ignore=information_schema 	 <span class="comment">#忽略information_schema库【我一般都不写】</span></span><br></pre></td></tr></table></figure>

<h3 id="重启MySQL-3"><a href="#重启MySQL-3" class="headerlink" title="重启MySQL"></a>重启MySQL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<h3 id="在slave上为master赋权"><a href="#在slave上为master赋权" class="headerlink" title="在slave上为master赋权"></a>在slave上为master赋权</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave on *.* to &#x27;root&#x27;@&#x27;192.168.1.202&#x27; identified by &#x27;xxxxx数据库密码&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G;</span><br></pre></td></tr></table></figure>

<h2 id="主库再次配置"><a href="#主库再次配置" class="headerlink" title="主库再次配置"></a>主库再次配置</h2><h3 id="配置互为主从"><a href="#配置互为主从" class="headerlink" title="配置互为主从"></a>配置互为主从</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO </span><br><span class="line">    MASTER_HOST=&#x27;192.168.1.203&#x27;,</span><br><span class="line">    MASTER_USER=&#x27;root&#x27;, </span><br><span class="line">    MASTER_PASSWORD=&#x27;5462837zhu&#x27;; </span><br><span class="line">    /* MASTER_PORT=3306, </span><br><span class="line">    MASTER_LOG_FILE=&#x27;master2-bin.000021&#x27;, </span><br><span class="line">    MASTER_LOG_POS=4; */</span><br></pre></td></tr></table></figure>

<h3 id="开启从库-1"><a href="#开启从库-1" class="headerlink" title="开启从库"></a>开启从库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>

<h3 id="查看状态-1"><a href="#查看状态-1" class="headerlink" title="查看状态"></a>查看状态</h3><p>要求Slave_IO_Running和Slave_SQL_Running 必须都为yes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status;</span><br></pre></td></tr></table></figure>

<p>当“Slave_SQL_Running” 为否时，解决方法执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave; </span><br><span class="line"></span><br><span class="line">mysql&gt; set GLOBAL SQL_SLAVE_SKIP_COUNTER=1;START SLAVE; </span><br><span class="line"></span><br><span class="line">mysql&gt; start slave; </span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status \G --再查看Slave_SQL_Running状态显示Yes正常</span><br></pre></td></tr></table></figure>

<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>在两台服务器的MYSQL中分别进行一些建表、插入、更新等操作，看一下另一台会不会进行同步，如果可以则证明主主配置成功</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" data-id="clmcxed7v00ctu8wa4hbdadlo" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/04-MySQL高可用及读写分离/01-MySQL主从复制和高可用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.944Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="何为主从复制，主从复制拓扑类型和实战搭建"><a href="#何为主从复制，主从复制拓扑类型和实战搭建" class="headerlink" title="何为主从复制，主从复制拓扑类型和实战搭建"></a>何为主从复制，主从复制拓扑类型和实战搭建</h1><h2 id="为什么需要主从复制"><a href="#为什么需要主从复制" class="headerlink" title="为什么需要主从复制"></a>为什么需要主从复制</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230102134654.png"></p>
<p>数据库存在海量数据量、性能、高并发读写的问题</p>
<ul>
<li>我们用分库分表来处理海量数据</li>
<li>我们用分库分表、分区提升性能</li>
<li>我们用分库分表、分布式缓存应对高并发读写</li>
</ul>
<p>为解决数据存储、访问问题我们需要<strong>数据库中间件</strong>。</p>
<p>还有什么方式应对读写压力？</p>
<h2 id="何为主从复制"><a href="#何为主从复制" class="headerlink" title="何为主从复制"></a>何为主从复制</h2><p>主从复制：MySQL提供了复制的功能，就是把一个数据库的数据复制到其它数据库的机制，源数据库称为主服务器，目的数据库称为从服务器</p>
<p>构建高性能应用的基础：</p>
<ul>
<li>实现数据库的读写分离</li>
<li>实现数据库高可用的基础等。</li>
</ul>
<h2 id="主从复制的拓扑结构"><a href="#主从复制的拓扑结构" class="headerlink" title="主从复制的拓扑结构"></a>主从复制的拓扑结构</h2><ul>
<li>一主多从<br>由一个master和多个slave组成，Slave之间并不相互通信，只能与master进行通信。如果写操作较少，而读操作很多时，可以采取这种结构。</li>
<li>互为主从<br>复制中的两台服务器，既是master，又是另一台服务器的slave，两台mysql都可读写</li>
<li>级联复制<br>也就是打开log-slave-update选项，然后通过二级（或者是更多级别）复制来减少Master端因为复制所带来的压力，相当于从服务器再带从服务器器</li>
</ul>
<h1 id="主从复制工作原理理解，binlog的底层原理分析"><a href="#主从复制工作原理理解，binlog的底层原理分析" class="headerlink" title="主从复制工作原理理解，binlog的底层原理分析"></a>主从复制工作原理理解，binlog的底层原理分析</h1><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230102134622.png"></p>
<ol>
<li>主服务器将更新操作写入二进制日志文件（binary log ） </li>
<li>当从服务器连上主服务器的时候，它告诉主服务器它最后一次成功读取更新日志的位置，然后拷贝该位置后的二进制日志文件到它的中继日志(relay log) </li>
<li>从服务器会重做中继日志中的事件，更新到自己数据库中</li>
</ol>
<h2 id="binlog的底层原理分析"><a href="#binlog的底层原理分析" class="headerlink" title="binlog的底层原理分析"></a>binlog的底层原理分析</h2><p>记录mysql的数据更新，主从复制主要依靠binlog</p>
<p><strong>复制类型</strong></p>
<ul>
<li>基于语句的复制(Statement)：在从服务器上执行与主服务器上一样的SQL语句（insert） </li>
<li>基于行的复制(Row)：把改变的内容复制过去，而不是把命令在从服务器上执行一次(update)</li>
<li>混合类型的复制(Mixed)：默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制。</li>
</ul>
<h2 id="主从复制注意点"><a href="#主从复制注意点" class="headerlink" title="主从复制注意点"></a>主从复制注意点</h2><p>主从复制基本原则</p>
<ol>
<li>每个slave只能有一个master</li>
<li>每个slave只能有一个唯一的服务器ID</li>
<li>每个master可以有很多slave</li>
<li>如果你设置log_slave_updates，slave可以是其它slave的master</li>
<li>MySQL不支持多主服务器复制，即一个slave可以有多个master</li>
</ol>
<p>主从复制最大的问题</p>
<p><strong>复制延时</strong><br>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p>
<h1 id="如何使用数据库中间件实现读写分离"><a href="#如何使用数据库中间件实现读写分离" class="headerlink" title="如何使用数据库中间件实现读写分离"></a>如何使用数据库中间件实现读写分离</h1><h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>数据库经过复制后，多台机器拥有一样的数据，这样就可以同时利用这些机器来分担应用的请求，通常的方式是，主服务器负责处理写的请求，而其余从服务器负责处理读的请求，这就是所谓的读写分离。</p>
<p>读写分离的实现<br>核心任务就一个：决定请求交给哪一个服务器来处理<br>那么中间件如何来配置读写分离？</p>
<h2 id="Mycat读写分离"><a href="#Mycat读写分离" class="headerlink" title="Mycat读写分离"></a>Mycat读写分离</h2><ul>
<li>配置mysql端主从的数据自动同步，mycat不负责任何的数据同步问题。 </li>
<li>Mycat配置读写分离，具体参数参考其它文章。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.201:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.202:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.201:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.202:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一种当写挂了读不可用，第二种可以继续使用。事务内部的一切操作都会走写节点，所以读操作不要加事务。</p>
<h2 id="Sharding-JDBC读写分离"><a href="#Sharding-JDBC读写分离" class="headerlink" title="Sharding-JDBC读写分离"></a>Sharding-JDBC读写分离</h2><ul>
<li>配置mysql主从复制，Sharding-JDBC不负责任何的数据同步问题。 </li>
<li>应用中配置Sharding-JDBC读写分离</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span> </span><br><span class="line"> </span><br><span class="line"> <span class="attr">masterSlaveRules:</span></span><br><span class="line">     <span class="attr">ms_ds0:</span></span><br><span class="line">     	<span class="attr">masterDataSourceName:</span> <span class="string">ds0</span></span><br><span class="line">     	<span class="attr">slaveDataSourceNames:</span></span><br><span class="line">     		<span class="bullet">-</span> <span class="string">ds0_slave0</span></span><br><span class="line">     		<span class="bullet">-</span> <span class="string">ds0_slave1</span></span><br><span class="line">     	<span class="attr">loadBalanceAlgorithmType:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">     <span class="attr">ms_ds1:</span></span><br><span class="line">     	<span class="attr">masterDataSourceName:</span> <span class="string">ds1</span></span><br><span class="line">     	<span class="attr">slaveDataSourceNames:</span> </span><br><span class="line">         <span class="bullet">-</span> <span class="string">ds1_slave0</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">ds1_slave1</span></span><br><span class="line">    	 <span class="attr">loadBalanceAlgorithmType:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure>

<h1 id="企业级数据库集群之HA高可用架构"><a href="#企业级数据库集群之HA高可用架构" class="headerlink" title="企业级数据库集群之HA高可用架构"></a>企业级数据库集群之HA高可用架构</h1><h2 id="什么是HA"><a href="#什么是HA" class="headerlink" title="什么是HA"></a>什么是HA</h2><p>HA(High Available)，高可用性集群，指的是通过一组计算机系统提供透明的冗余处理能力，从而保证系统服务高度的连续可用。 </p>
<p>其主要是利用复制技术，多个不同数据库主机之间进行复制，以保持数据的一致性，并通过一些第三方开源软件来实现负载均衡和统一的访问接口，既减少应用程序开发的复杂性，也降低了企业的运营成本。</p>
<h2 id="HA基本实现原理"><a href="#HA基本实现原理" class="headerlink" title="HA基本实现原理"></a>HA基本实现原理</h2><ul>
<li>监控软件节点之间通过心跳或信息报文来确定健康状态（故障检测）</li>
<li>当前提供服务的机器出现问题后，需要按照一定的规则，投票选举出新的提供服务的机器，并接管服务（故障切换）</li>
<li>能实现请求均匀分发（负载均衡）</li>
<li>提供虚拟IP给外部访问（对应用透明）</li>
</ul>
<h2 id="企业中MySQL的HA架构"><a href="#企业中MySQL的HA架构" class="headerlink" title="企业中MySQL的HA架构"></a>企业中MySQL的HA架构</h2><ul>
<li>主从复制</li>
<li>Keepalived + LVS + MySQL双主复制</li>
<li>HeartBeat + MySQL双主复制</li>
<li>HeartBeat + DRDB + MySQL</li>
</ul>
<h2 id="HA架构-主从复制"><a href="#HA架构-主从复制" class="headerlink" title="HA架构-主从复制"></a>HA架构-主从复制</h2><p>主从方案缺点</p>
<ul>
<li>从库切换成主库需要作改动，改动时间内服务不可用，</li>
<li>不能故障判断、故障切换、负载均衡、对应用透明。</li>
</ul>
<h2 id="HA架构-Keepalived-LVS-MySQL双主复制"><a href="#HA架构-Keepalived-LVS-MySQL双主复制" class="headerlink" title="HA架构-Keepalived+LVS+MySQL双主复制"></a>HA架构-Keepalived+LVS+MySQL双主复制</h2><ul>
<li>Keepalived提供故障检测、故障切换、对应用透明功能</li>
<li>LVS提供负载均衡功能</li>
<li>双主复制提供数据同步功能和读写功能</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230102134508.png"></p>
<h2 id="HA架构-HeartBeat-MySQL双主复制"><a href="#HA架构-HeartBeat-MySQL双主复制" class="headerlink" title="HA架构-HeartBeat+MySQL双主复制"></a>HA架构-HeartBeat+MySQL双主复制</h2><ul>
<li>HeartBeat提供了故障检测、故障切换、对应用透明功能</li>
<li>双主复制提供数据同步功能和读写功能</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230102134224.png"></p>
<h2 id="HA架构-HeartBeat-DRDB-MySQL"><a href="#HA架构-HeartBeat-DRDB-MySQL" class="headerlink" title="HA架构-HeartBeat+DRDB+MySQL"></a>HA架构-HeartBeat+DRDB+MySQL</h2><ul>
<li>HeartBeat提供了故障检测、故障切换、对应用透明功能</li>
<li>DRDB提供了数据同步功能(通过网络实现两个服务器上的磁盘同步，是binlog更底层磁盘同步，更适用高可用)</li>
</ul>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20230102134845.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/" data-id="clmcxed7k00csu8waajnd52cv" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/03-ShardingSphere/05-Sharding-JDBC分布式事务应用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/05-Sharding-JDBC%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%BA%94%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.937Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC分布式事务应用"><a href="#Sharding-JDBC分布式事务应用" class="headerlink" title="Sharding-JDBC分布式事务应用"></a>Sharding-JDBC分布式事务应用</h1><h2 id="引入Maven依赖"><a href="#引入Maven依赖" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-2pc-xa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shardingsphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>XA事务管理器将以SPI的方式被Sharding-JDBC所加载。</p>
<h2 id="连接池配置"><a href="#连接池配置" class="headerlink" title="连接池配置"></a>连接池配置</h2><p>ShardingSphere支持将普通的数据库连接池，转换为支持XA事务的连接池，对HikariCP,Druid和DBCP2连接池内置支持，无需额外配置。 其它连接池需要用户实现DataSourceMapConverter 的SPI接口进行扩展，可以参考org.apache.shardingsphere.transaction.xa.convert.swap.HikariParameterSwapper 的实现。 若ShardingSphere无法找到合适的实现，则会按默认的配置创建XA事务连接池。默认属性如下：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>connectionTimeoutMilliseconds</td>
<td>30 * 1000</td>
</tr>
<tr>
<td>idleTimeoutMilliseconds</td>
<td>60 * 1000</td>
</tr>
<tr>
<td>maintenanceIntervalMilliseconds</td>
<td>30 * 1000</td>
</tr>
<tr>
<td>maxLifetimeMilliseconds</td>
<td>0 (无限制)</td>
</tr>
<tr>
<td>maxPoolSize</td>
<td>50</td>
</tr>
<tr>
<td>minPoolSize</td>
<td>1</td>
</tr>
</tbody></table>
<p><strong>数据源配置说明</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> <span class="comment"># 配置数据源列表,必须是有效的jdbc配置,目前仅支持MySQL与PostgreSQL,另 外通过一些未公开(代码中可查,但可能会在未来有变化)的变量,可以配置来兼容其他支持JDBC的数 据库,但由于没有足够的测试支持,可能会有严重的兼容性问题,配置时候要求至少有一个</span></span><br><span class="line">	<span class="attr">master_ds_0:</span> <span class="comment"># 数据源名称,可以是合法的字符串,目前的校验规则中,没有强制性要求,只要是 合法的yaml字符串即可,但如果要用于分库分表配置,则需要有有意义的标志(在分库分表配置中详 述),以下为目前公开的合法配置项目,不包含内部配置参数 </span></span><br><span class="line">	<span class="comment"># 以下参数为必备参数 </span></span><br><span class="line">		<span class="attr">url:</span> <span class="string">•jdbc:mysql://127.0.0.1:3306/demo_ds_slave_1?</span> <span class="string">serverTimezone=UTC&amp;useSSL=false</span> <span class="comment"># 这里的要求合法的jdbc连接串即可,目前尚未兼容 MySQL 8.x,需要在maven编译时候,升级MySQL JDBC版本到5.1.46或者47版本(不建议升级到 JDBC的8.x系列版本,需要修改源代码,并且无法通过很多测试case) </span></span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> <span class="comment"># MySQL用户名 </span></span><br><span class="line">		<span class="attr">password:</span> <span class="string">password</span> <span class="comment"># MySQL用户的明文密码 # 以下参数为可选参数,给出示例为默认配置,主要用于连接池控制 </span></span><br><span class="line">		<span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span> <span class="comment">#连接超时控制 </span></span><br><span class="line">		<span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span> <span class="comment"># 连接空闲时间设置 </span></span><br><span class="line">		<span class="attr">maxLifetimeMilliseconds:</span> <span class="number">0</span> <span class="comment"># 连接的最大持有时间,0为无限制 </span></span><br><span class="line">		<span class="attr">maxPoolSize:</span> <span class="number">50</span> <span class="comment"># 连接池中最大维持的连接数量 </span></span><br><span class="line">		<span class="attr">minPoolSize:</span> <span class="number">1</span> <span class="comment"># 连接池的最小连接数量 </span></span><br><span class="line">		<span class="attr">maintenanceIntervalMilliseconds:</span> <span class="number">30000</span> <span class="comment"># 连接维护的时间间隔 atomikos框架需 求 </span></span><br><span class="line">		<span class="comment"># 以下配置的假设是,3307是3306的从库,3309,3310是3308的从库 </span></span><br><span class="line">	<span class="attr">slave_ds_0:</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">•jdbc:mysql://127.0.0.1:3307/demo_ds_slave_1?</span> <span class="string">serverTimezone=UTC&amp;useSSL=false</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure>

<h2 id="事务类型切换"><a href="#事务类型切换" class="headerlink" title="事务类型切换"></a>事务类型切换</h2><p>ShardingSphere的事务类型存放在 TransactionTypeHolder 的本地线程变量中，因此在数据库连接创建前修改此值，可以达到自由切换事务类型的效果。</p>
<p>注意：数据库连接创建之后，事务类型将无法更改。</p>
<h3 id="API方式"><a href="#API方式" class="headerlink" title="API方式"></a>API方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TransactionTypeHolder.set(TransactionType.LOCAL);</span><br><span class="line">或</span><br><span class="line">TransactionTypeHolder.set(TransactionType.XA);</span><br></pre></td></tr></table></figure>

<h2 id="SpringBootStarter使用方式"><a href="#SpringBootStarter使用方式" class="headerlink" title="SpringBootStarter使用方式"></a>SpringBootStarter使用方式</h2><p>引入Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot使用方式"><a href="#SpringBoot使用方式" class="headerlink" title="SpringBoot使用方式"></a>SpringBoot使用方式</h2><p>引入Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>[1.5.0.RELEASE,2.0.0.M1)<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AutoConfiguration配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = JtaAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;io.shardingsphere.transaction.aspect&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StartMain</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Namespace使用方式"><a href="#Spring-Namespace使用方式" class="headerlink" title="Spring Namespace使用方式"></a>Spring Namespace使用方式</h2><p>引入Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aspectjweaver.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springframework.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aspectjweaver.version</span>&gt;</span>1.8.9<span class="tag">&lt;/<span class="name">aspectjweaver.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springframework.version</span>&gt;</span>[4.3.6.RELEASE,5.0.0.M1) <span class="tag">&lt;/<span class="name">springframework.version</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>加载切面配置信息</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:META-INF/shardingTransaction.xml&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="业务代码"><a href="#业务代码" class="headerlink" title="业务代码"></a>业务代码</h2><p>在需要事务的方法或类中添加相关注解即可，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.LOCAL)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">或</span><br><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.XA)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br></pre></td></tr></table></figure>

<p>注意：@ShardingTransactionType需要同Spring的@Transactional配套使用，事务才会生效。</p>
<h2 id="Atomikos参数配置"><a href="#Atomikos参数配置" class="headerlink" title="Atomikos参数配置"></a>Atomikos参数配置</h2><p>ShardingSphere默认的XA事务管理器为Atomikos。 可以通过在项目的classpath中添加jta.properties来定制化Atomikos配置项。 具体的配置规则请参考Atomikos的<a target="_blank" rel="noopener" href="https://www.atomikos.com/Documentation/JtaProperties">官方文档</a>。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>数据库事务需要满足 ACID （原子性、一致性、隔离性、持久性）四个特性。</p>
<ul>
<li>原子性（Atomicity）指事务作为整体来执行，要么全部执行，要么全不执行。</li>
<li>一致性（Consistency）指事务应确保数据从一个一致的状态转变为另一个一致的状态。</li>
<li>隔离性（Isolation）指多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</li>
<li>持久性（Durability）指已提交的事务修改数据会被持久保存。</li>
</ul>
<p>在单一数据节点中，事务仅限于对单一数据库资源的访问控制，称之为本地事务。几乎所有的成熟的关系型数据库都提供了对本地事务的原生支持。 但是在基于微服务的分布式应用环境下，越来越多的应用场景要求对多个服务的访问及其相对应的多个数据库资源能纳入到同一个事务当中，分布式事务应运而生。</p>
<p>关系型数据库虽然对本地事务提供了完美的 ACID 原生支持。 但在分布式的场景下，它却成为系统性能的桎梏。如何让数据库在分布式场景下满足 ACID 的特性或找寻相应的替代方案，是分布式事务的重点工作。</p>
<h2 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h2><p>在不开启任何分布式事务管理器的前提下，让每个数据节点各自管理自己的事务。 它们之间没有协调以及通信的能力，也并不互相知晓其他数据节点事务的成功与否。 本地事务在性能方面无任何损耗，但在强一致性以及最终一致性方面则力不从心。</p>
<h2 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h2><p>XA协议最早的分布式事务模型是由 X&#x2F;Open 国际联盟提出的 X&#x2F;Open Distributed Transaction Processing（DTP） 模型，简称XA协议。</p>
<p>基于XA协议实现的分布式事务对业务侵入很小。 它最大的优势就是对使用方透明，用户可以像使用本地事务一样使用基于XA协议的分布式事务。 XA协议能够严格保障事务 ACID 特性。</p>
<p>严格保障事务 ACID 特性是一把双刃剑。 事务执行在过程中需要将所需资源全部锁定，它更加适用于执行时间确定的短事务。 对于长事务来说，整个事务进行期间对数据的独占，将导致对热点数据依赖的业务系统并发性能衰退明显。 因此，在高并发的性能至上场景中，基于XA协议的分布式事务并不是最佳选择。</p>
<h2 id="柔性事务"><a href="#柔性事务" class="headerlink" title="柔性事务"></a>柔性事务</h2><p>如果将实现了 ACID 的事务要素的事务称为刚性事务的话，那么基于 BASE 事务要素的事务则称为柔性事务。 BASE 是基本可用、柔性状态和最终一致性这三个要素的缩写。</p>
<ul>
<li>基本可用（Basically Available）保证分布式事务参与方不一定同时在线。</li>
<li>柔性状态（Soft state）则允许系统状态更新有一定的延时，这个延时对客户来说不一定能够察觉。</li>
<li>而最终一致性（Eventually consistent）通常是通过消息传递的方式保证系统的最终一致性。</li>
</ul>
<p>在 ACID 事务中对隔离性的要求很高，在事务执行过程中，必须将所有的资源锁定。 柔性事务的理念则是通过业务逻辑将互斥锁操作从资源层面上移至业务层面。通过放宽对强一致性要求，来换取系统吞吐量的提升。</p>
<p>基于 ACID 的强一致性事务和基于 BASE 的最终一致性事务都不是银弹，只有在最适合的场景中才能发挥它们的最大长处。 可通过下表详细对比它们之间的区别，以帮助开发者进行技术选型。</p>
<table>
<thead>
<tr>
<th></th>
<th>本地事务</th>
<th>两（三）阶段事务</th>
<th>柔性事务</th>
</tr>
</thead>
<tbody><tr>
<td>业务改造</td>
<td>无</td>
<td>无</td>
<td>实现相关接口</td>
</tr>
<tr>
<td>一致性</td>
<td>不支持</td>
<td>支持</td>
<td>最终一致</td>
</tr>
<tr>
<td>隔离性</td>
<td>不支持</td>
<td>支持</td>
<td>业务方保证</td>
</tr>
<tr>
<td>并发性能</td>
<td>无影响</td>
<td>严重衰退</td>
<td>略微衰退</td>
</tr>
<tr>
<td>适合场景</td>
<td>业务方处理不一致</td>
<td>短事务 &amp; 低并发</td>
<td>长事务 &amp; 高并发</td>
</tr>
</tbody></table>
<h2 id="挑战"><a href="#挑战" class="headerlink" title="挑战"></a>挑战</h2><p>由于应用的场景不同，需要开发者能够合理的在性能与功能之间权衡各种分布式事务。</p>
<p>强一致的事务与柔性事务的API和功能并不完全相同，在它们之间并不能做到自由的透明切换。在开发决策阶段，就不得不在强一致的事务和柔性事务之间抉择，使得设计和开发成本被大幅增加。</p>
<p>基于XA的强一致事务使用相对简单，但是无法很好的应对互联网的高并发或复杂系统的长事务场景；柔性事务则需要开发者对应用进行改造，接入成本非常高，并且需要开发者自行实现资源锁定和反向补偿。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>整合现有的成熟事务方案，为本地事务、两阶段事务和柔性事务提供统一的分布式事务接口，并弥补当前方案的不足，提供一站式的分布式事务解决方案是ShardingSphere分布式事务模块的主要设计目标</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/03-ShardingSphere/05-Sharding-JDBC%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%BA%94%E7%94%A8/" data-id="clmcxed7j00cru8wacjghfx3v" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/03-ShardingSphere/04-Sharding-JDBC分库分表" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/04-Sharding-JDBC%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.930Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC分库分表"><a href="#Sharding-JDBC分库分表" class="headerlink" title="Sharding-JDBC分库分表"></a>Sharding-JDBC分库分表</h1><h2 id="Sharding-JDBC分库分表概念"><a href="#Sharding-JDBC分库分表概念" class="headerlink" title="Sharding-JDBC分库分表概念"></a>Sharding-JDBC分库分表概念</h2><h3 id="垂直拆分"><a href="#垂直拆分" class="headerlink" title="垂直拆分"></a>垂直拆分</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227172714.png"></p>
<h3 id="水平拆分"><a href="#水平拆分" class="headerlink" title="水平拆分"></a>水平拆分</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227172755.png"></p>
<h3 id="逻辑表"><a href="#逻辑表" class="headerlink" title="逻辑表"></a>逻辑表</h3><p>水平拆分的数据库（表）的相同逻辑和数据结构表的总称。例：订单数据根据主键%2拆分为2张表，分别是t_order0、t_order1，他们的逻辑表名为t_order。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227173110.png"></p>
<h4 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span></span><br><span class="line">	<span class="attr">tables:</span> </span><br><span class="line">		<span class="attr">t_order:</span> </span><br><span class="line">			<span class="attr">actualDataNodes:</span> <span class="string">ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span> </span><br><span class="line">			<span class="attr">databaseStrategy:</span> </span><br><span class="line">				<span class="attr">inline:</span> </span><br><span class="line">					<span class="attr">shardingColumn:</span> <span class="string">user_id</span> </span><br><span class="line">					<span class="attr">algorithmInlineExpression:</span> <span class="string">ds$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">				<span class="attr">tableStrategy:</span> </span><br><span class="line">					<span class="attr">inline:</span> </span><br><span class="line">						<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">						<span class="attr">algorithmInlineExpression:</span> <span class="string">t_order$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="真实表"><a href="#真实表" class="headerlink" title="真实表"></a>真实表</h3><p>在分片的数据库中真实存在的物理表。即上个示例中的t_order0到t_order1</p>
<p><strong>数据节点</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tables:</span></span><br><span class="line">	<span class="attr">t_order:</span> </span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span> <span class="comment">#数据节点</span></span><br></pre></td></tr></table></figure>

<p>数据分片的最小单元。由数据源名称和数据表组成，例：ds0.t_order0。可分为均匀分布和自定义分布两种形式。</p>
<p><strong>数据节点分布说明</strong></p>
<p>均匀分布：数据源能力均衡</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227173254.png"></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db0.t_order0,db0.t_order1,db1.t_order0,db1.t_order1</span><br><span class="line">或</span><br><span class="line">db$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span><br></pre></td></tr></table></figure>

<p>自定义分布：数据源能力不均</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227173358.png"></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db0.t_order0,db0.t_order1,db1.t_order2,db1.t_order3,db1.t_order4</span><br><span class="line">或</span><br><span class="line">db0.t_order$-&gt;&#123;0..1&#125;,db1.t_order$-&gt;&#123;2..4&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h3><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227173643.png"></p>
<p><strong>数据源分片</strong>、<strong>表分片</strong>仅是两个不同维度的分片，它们能用的分片策略规则是一样的。<br>Sharding-JDBC中提供了常用的分片策略实现。分片策略由两部分构成：</p>
<ul>
<li>分片键</li>
<li>分片算法</li>
</ul>
<h3 id="5种分片策略"><a href="#5种分片策略" class="headerlink" title="5种分片策略"></a>5种分片策略</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaultDatabaseShardingStrategy:</span> <span class="comment"># 默认库级别sharidng规则,对应代码中 ShardingStrategy接口的实现类,目前支持none,inline,hint,complex,standard五种配置 注意此处默认配置仅可以配置五个中的一个</span></span><br><span class="line"><span class="comment"># 规则配置同样适合表sharding配置,同样是在这些算法中选择 </span></span><br><span class="line"><span class="attr">none:</span> <span class="comment"># 不配置任何规则,SQL会被发给所有节点去执行,这个规则没有子项目可以配置 </span></span><br><span class="line"><span class="attr">inline:</span> <span class="comment"># 行表达式分片 </span></span><br><span class="line">	<span class="attr">shardingColumn:</span> <span class="string">test_id</span> <span class="comment"># 分片列名称 </span></span><br><span class="line">	<span class="attr">algorithmExpression:</span> <span class="string">master_test_$&#123;test_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片表达式,根据指定的 表达式计算得到需要路由到的数据源名称 需要是合法的groovy表达式,示例配置中,取余为0则语句 路由到master_test_0,取余为1则路由到master_test_1 </span></span><br><span class="line"><span class="attr">hint:</span> <span class="comment">#基于标记的sharding分片 </span></span><br><span class="line">	<span class="attr">shardingAlgorithm:</span> <span class="comment"># 需要是HintShardingAlgorithm接口的实现,目前代码中,有 为测试目的实现的OrderDatabaseHintShardingAlgorithm可参考 </span></span><br><span class="line"><span class="attr">complex:</span> <span class="comment"># 支持多列的shariding,目前无生产可用实现 </span></span><br><span class="line">	<span class="attr">shardingColumns:</span> <span class="comment"># 逗号切割的列 </span></span><br><span class="line">	<span class="attr">shardingAlgorithm:</span> <span class="comment"># ComplexKeysShardingAlgorithm接口的实现类 </span></span><br><span class="line"><span class="attr">standard:</span> <span class="comment"># 单列sharidng算法,需要配合对应的 preciseShardingAlgorithm,rangeShardingAlgorithm接口的实现使用</span></span><br><span class="line">	<span class="attr">shardingColumn:</span> <span class="comment"># 列名,允许单列 </span></span><br><span class="line">	<span class="attr">preciseShardingAlgorithm:</span> <span class="comment"># preciseShardingAlgorithm接口的实现类 </span></span><br><span class="line">	<span class="attr">rangeShardingAlgorithm:</span> <span class="comment"># rangeShardingAlgorithm接口的实现类</span></span><br></pre></td></tr></table></figure>



<h3 id="none-不分片策略"><a href="#none-不分片策略" class="headerlink" title="none 不分片策略"></a>none 不分片策略</h3><p>对应NoneShardingStrategy ，不分片策略 ,SQL会被发给所有节点去执行,这个规则没有子项目可以配置。</p>
<h3 id="inline-行表达式分片策略"><a href="#inline-行表达式分片策略" class="headerlink" title="inline 行表达式分片策略"></a>inline 行表达式分片策略</h3><p>对应InlineShardingStrategy。使用Groovy的表达式，提供对SQL语句中的&#x3D;和IN的分片操作支持，只支持单分片键。对于简单的分片算法，可以通过简单的配置使用，从而避免繁琐的Java代码开发，如:t_user_$-&gt;{u_id % 8} 表示t_user表根据u_id模8，而分成8张表，表名称为t_user_0到t_user_7。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">databaseStrategy:</span> </span><br><span class="line">	<span class="attr">inline:</span></span><br><span class="line">		<span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">		<span class="attr">algorithmInlineExpression:</span> <span class="string">ds$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="行表达式语法"><a href="#行表达式语法" class="headerlink" title="行表达式语法"></a>行表达式语法</h3><p>行表达式的使用非常直观，只需要在配置中使用 ${ expression } 或 $-&gt;{ expression } 标识行表达式即可。 目前支持数据节点和分片算法这两个部分的配置。行表达式的内容使用的是Groovy的语法，Groovy能够支持的所有操作，行表达式均能够支持。例如：</p>
<ul>
<li>${begin..end}表示范围区间</li>
<li>${[unit1, unit2, unit_x]}表示枚举值</li>
<li>行表达式中如果出现连续多个${ expression }或$-&gt;{ expression }表达式，整个表达式最终的结果将会根据每个子表达式的结果进行笛卡尔组合。</li>
</ul>
<h3 id="standard-标准分片策略"><a href="#standard-标准分片策略" class="headerlink" title="standard 标准分片策略"></a>standard 标准分片策略</h3><ul>
<li><p>对应StandardShardingStrategy。提供对SQL语句中的&#x3D;, IN和BETWEEN AND的分片操作支持。</p>
</li>
<li><p>StandardShardingStrategy只支持单分片键，提供PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。</p>
</li>
<li><p>PreciseShardingAlgorithm是必选的，用于处理&#x3D;和IN的分片。</p>
</li>
<li><p>RangeShardingAlgorithm是可选的，用于处理BETWEEN AND分片，如果不配置RangeShardingAlgorithm，SQL中的BETWEEN AND将按照全库路由处理。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">databaseStrategy:</span> </span><br><span class="line">	<span class="attr">standard:</span> <span class="comment">#单列sharidng算法,需要配合对应的preciseShardingAlgorithm,rangeShardingAlgorithm接口的实现使用</span></span><br><span class="line">	<span class="attr">shardingColumn:</span> <span class="comment"># 列名,允许单列</span></span><br><span class="line">	<span class="attr">preciseShardingAlgorithm:</span> <span class="comment"># preciseShardingAlgorithm接口的实现类</span></span><br><span class="line">	<span class="attr">rangeShardingAlgorithm:</span> <span class="comment"># rangeShardingAlgorithm接口的实现类</span></span><br></pre></td></tr></table></figure>

<h3 id="complex-复合分片策略"><a href="#complex-复合分片策略" class="headerlink" title="complex 复合分片策略"></a>complex 复合分片策略</h3><ul>
<li>对应ComplexShardingStrategy。复合分片策略提供对SQL语句中的&#x3D;, IN和BETWEEN AND的分片操作支持。 </li>
<li>ComplexShardingStrategy支持多分片键，由于多分片键之间的关系复杂，因此并未进行过多的封装，而是直接将分片键值组合以及分片操作符透传至分片算法，完全由应用开发者实现，提供最大的灵活度。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">databaseStrategy:</span> </span><br><span class="line">	<span class="attr">complex:</span> <span class="comment"># 支持多列的shariding</span></span><br><span class="line">		<span class="attr">shardingColumns:</span> <span class="comment"># 逗号切割的列</span></span><br><span class="line">		<span class="attr">shardingAlgorithm:</span> <span class="comment"># ComplexKeysShardingAlgorithm接口的实现类</span></span><br></pre></td></tr></table></figure>

<h3 id="hint分片策略"><a href="#hint分片策略" class="headerlink" title="hint分片策略"></a>hint分片策略</h3><ul>
<li>对应HintShardingStrategy。通过Hint而非SQL解析的方式分片的策略。 </li>
<li>对于分片字段非SQL决定，而由其他外置条件决定的场景，可使用SQL Hint灵活的注入分片字段。例：内 部系统，按照员工登录主键分库，而数据库中并无此字段。SQL Hint支持通过Java API和SQL注释(待实现)两种方式使用。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">databaseStrategy:</span> </span><br><span class="line">	<span class="attr">hint:</span> <span class="comment">#基于标记的sharding分片</span></span><br><span class="line">	<span class="attr">shardingAlgorithm:</span> <span class="comment"># 需要是HintShardingAlgorithm接口的实现,目前代码中,有为测试目的实现的OrderDatabaseHintShardingAlgorithm可参考</span></span><br></pre></td></tr></table></figure>

<h3 id="spring-boot-分片示例"><a href="#spring-boot-分片示例" class="headerlink" title="spring boot 分片示例"></a>spring boot 分片示例</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding:</span> </span><br><span class="line">	<span class="attr">jdbc:</span> </span><br><span class="line">		<span class="attr">datasource:</span> </span><br><span class="line">			<span class="attr">names:</span> <span class="string">ds0,ds1</span> </span><br><span class="line">			<span class="attr">ds0:</span></span><br><span class="line">				<span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> </span><br><span class="line">				<span class="attr">driver-class:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">				<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db1?</span> <span class="string">useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span> </span><br><span class="line">				<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">				<span class="attr">password:</span> <span class="number">123456</span> </span><br><span class="line">				<span class="attr">maxPoolSize:</span> <span class="number">50</span> </span><br><span class="line">				<span class="attr">minPoolSize:</span> <span class="number">1</span> </span><br><span class="line">			<span class="attr">ds1:</span></span><br><span class="line">				<span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> </span><br><span class="line">				<span class="attr">driver-class:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">				<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db2?</span> <span class="string">useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span> </span><br><span class="line">				<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">				<span class="attr">password:</span> <span class="number">123456</span> </span><br><span class="line">				<span class="attr">maxPoolSize:</span> <span class="number">50</span> </span><br><span class="line">				<span class="attr">minPoolSize:</span> <span class="number">1</span> </span><br><span class="line">			<span class="attr">config:</span> </span><br><span class="line">				<span class="attr">sharding:</span> </span><br><span class="line">					<span class="attr">tables:</span> </span><br><span class="line">						<span class="attr">t_order:</span> </span><br><span class="line">							<span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span> </span><br><span class="line">							<span class="attr">database-strategy:</span> </span><br><span class="line">								<span class="attr">standard:</span> </span><br><span class="line">									<span class="attr">sharding-column:</span> <span class="string">order_time</span> </span><br><span class="line">									<span class="attr">preciseAlgorithmClassName:</span> <span class="string">com.study.sharding.jdbc.sharding.OrderTimePreciseShardingAlgorithm</span> </span><br><span class="line">								<span class="comment">#inline: </span></span><br><span class="line">									<span class="comment">#sharding-column: customer_id </span></span><br><span class="line">									<span class="comment">#algorithm-expression: ds$-&gt;&#123;customer_id % 2&#125; </span></span><br><span class="line">								<span class="attr">table-strategy:</span> </span><br><span class="line">									<span class="attr">inline:</span> </span><br><span class="line">										<span class="attr">sharding-column:</span> <span class="string">order_id</span> </span><br><span class="line">										<span class="attr">algorithm-expression:</span> <span class="string">t_order$-&gt;&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">					<span class="attr">default-data-source-name:</span> <span class="string">ds0</span> </span><br><span class="line">				<span class="attr">props:</span> </span><br><span class="line">					<span class="attr">sql.show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>算法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.api.algorithm.sharding.PreciseShardingValue;</span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.api.algorithm.sharding.standard.PreciseShardingAlgorithm;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTimePreciseShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">PreciseShardingAlgorithm</span> &lt; Date &gt; &#123;</span><br><span class="line">    Date[] dateRanges = <span class="keyword">new</span> <span class="title class_">Date</span>[<span class="number">2</span>]; &#123;</span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">cal</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        cal.set(<span class="number">2019</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        dateRanges[<span class="number">0</span>] = cal.getTime();</span><br><span class="line">        cal.set(<span class="number">2020</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        dateRanges[<span class="number">1</span>] = cal.getTime();</span><br><span class="line">    &#125;@</span><br><span class="line">    Override <span class="keyword">public</span> String <span class="title function_">doSharding</span><span class="params">(Collection &lt; String &gt; availableTargetNames, PreciseShardingValue &lt; Date &gt; shardingValue)</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">d</span> <span class="operator">=</span> shardingValue.getValue();</span><br><span class="line">        Iterator &lt; String &gt; ite = availableTargetNames.iterator();</span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Date s: dateRanges) &#123;</span><br><span class="line">            target = ite.next();</span><br><span class="line">            <span class="keyword">if</span> (d.before(s)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="建表SQL"><a href="#建表SQL" class="headerlink" title="建表SQL"></a>建表SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_order0 (</span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    order_time DATETIME, </span><br><span class="line">    customer_id <span class="type">BIGINT</span>,</span><br><span class="line">    order_amount <span class="type">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>) </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_order1 (</span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    order_time DATETIME, </span><br><span class="line">    customer_id <span class="type">BIGINT</span>, </span><br><span class="line">    order_amount <span class="type">DECIMAL</span>(<span class="number">8</span>,<span class="number">2</span>) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="默认配置（yaml格式）"><a href="#默认配置（yaml格式）" class="headerlink" title="默认配置（yaml格式）"></a>默认配置（yaml格式）</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span> <span class="comment"># sharding的配置 </span></span><br><span class="line">	<span class="comment"># 配置主要分两类,一类是对整个sharding规则所有表生效的默认配置,一个是sharing具体某张 表时候的配置 </span></span><br><span class="line">	<span class="comment"># 首先说默认配置 </span></span><br><span class="line">	<span class="attr">masterSlaveRules:</span> <span class="comment"># 在shardingRule中也可以配置shardingRule,对分片生效,具体内 容与全局masterSlaveRule一致,但语法为: </span></span><br><span class="line">		<span class="attr">master_test_0:</span> </span><br><span class="line">			<span class="attr">masterDataSourceName:</span> <span class="string">master_ds_0</span> </span><br><span class="line">			<span class="attr">slaveDataSourceNames:</span> </span><br><span class="line">				<span class="bullet">-</span> <span class="string">slave_ds_0</span> </span><br><span class="line">			<span class="attr">master_test_1:</span> </span><br><span class="line">				<span class="attr">masterDataSourceName:</span> <span class="string">master_ds_1</span> </span><br><span class="line">				<span class="attr">slaveDataSourceNames:</span> </span><br><span class="line">					<span class="bullet">-</span> <span class="string">slave_ds_1</span> </span><br><span class="line">					<span class="bullet">-</span> <span class="string">slave_ds_1_slave2</span> </span><br><span class="line">	<span class="attr">defaultDataSourceName:</span> <span class="string">master_test_0</span> <span class="comment"># 这里的数据源允许是dataSources的配置项 目或者masterSlaveRules配置的名称,配置为masterSlaveRule的话相当于就是配置读写分离了</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">broadcastTables:</span> <span class="comment"># 广播表 这里配置的表列表,对于发生的所有数据变更,都会不经 sharidng处理,而是直接发送到所有数据节点,注意此处为列表,每个项目为一个表名称 </span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">broad_1</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">broad_2</span></span><br><span class="line">	<span class="attr">bindingTables:</span> <span class="comment"># 绑定表,也就是实际上哪些配置的sharidng表规则需要实际生效的列表,配 置为yaml列表,并且允许单个条目中以逗号切割,所配置表必须已经配置为逻辑表 </span></span><br><span class="line">		<span class="bullet">-</span> <span class="string">sharding_t1</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">sharding_t2,sharding_t3</span> </span><br><span class="line">	<span class="attr">defaultDatabaseShardingStrategy:</span> <span class="comment"># 默认库级别sharidng规则,对应代码中 ShardingStrategy接口的实现类,目前支持none,inline,hint,complex,standard五种配置 注意此处默认配置仅可以配置五个中的一个 # 规则配置同样适合表sharding配置,同样是在这些算法中选择 </span></span><br><span class="line">		<span class="attr">none:</span> <span class="comment"># 不配置任何规则,SQL会被发给所有节点去执行,这个规则没有子项目可以配置 </span></span><br><span class="line">		<span class="attr">inline:</span> <span class="comment"># 行表达式分片 </span></span><br><span class="line">			<span class="attr">shardingColumn:</span> <span class="string">test_id</span> <span class="comment"># 分片列名称 </span></span><br><span class="line">			<span class="attr">algorithmExpression:</span> <span class="string">master_test_$&#123;test_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="comment"># 分片表达式,根据指定的 表达式计算得到需要路由到的数据源名称 需要是合法的groovy表达式,示例配置中,取余为0则语句 路由到master_test_0,取余为1则路由到master_test_1 </span></span><br><span class="line">		<span class="attr">hint:</span> <span class="comment">#基于标记的sharding分片 </span></span><br><span class="line">			<span class="attr">shardingAlgorithm:</span> <span class="comment"># 需要是HintShardingAlgorithm接口的实现,目前代码中,仅 有为测试目的实现的OrderDatabaseHintShardingAlgorithm,没有生产环境可用的实现 </span></span><br><span class="line">		<span class="attr">complex:</span> <span class="comment"># 支持多列的shariding,目前无生产可用实现 </span></span><br><span class="line">			<span class="attr">shardingColumns:</span> <span class="comment"># 逗号切割的列 </span></span><br><span class="line">			<span class="attr">shardingAlgorithm:</span> <span class="comment"># ComplexKeysShardingAlgorithm接口的实现类 </span></span><br><span class="line">		<span class="attr">standard:</span> <span class="comment"># 单列sharidng算法,需要配合对应的 preciseShardingAlgorithm,rangeShardingAlgorithm接口的实现使用,目前无生产可用实 现 </span></span><br><span class="line">		<span class="attr">shardingColumn:</span> <span class="comment"># 列名,允许单列 </span></span><br><span class="line">		<span class="attr">preciseShardingAlgorithm:</span> <span class="comment"># preciseShardingAlgorithm接口的实现类 </span></span><br><span class="line">		<span class="attr">rangeShardingAlgorithm:</span> <span class="comment"># rangeShardingAlgorithm接口的实现类 </span></span><br><span class="line">	<span class="attr">defaultTableStrategy:</span> <span class="comment">#配置参考defaultDatabaseShardingStrategy,区别在 于,inline算法的配置中,algorithmExpression的配置算法结果需要是实际的物理表名称,而非 数据源名称 </span></span><br><span class="line">	<span class="attr">defaultKeyGenerator:</span> <span class="comment">#默认的主键生成算法 如果没有设置,默认为SNOWFLAKE算法 </span></span><br><span class="line">		<span class="attr">column:</span> <span class="comment"># 自增键对应的列名称 </span></span><br><span class="line">		<span class="attr">type:</span> <span class="comment">#自增键的类型,主要用于调用内置的主键生成算法有三个可用值:SNOWFLAKE(时间戳 +worker id+自增id),UUID(java.util.UUID类生成的随机UUID),LEAF,其中Snowflake算法 与UUID算法已经实现,LEAF目前(2018-01-14)尚未实现 </span></span><br><span class="line">		<span class="attr">props:</span> <span class="comment"># 定制算法需要设置的参数,比如SNOWFLAKE算法的worker.id与 max.tolerate.time.difference.milliseconds</span></span><br></pre></td></tr></table></figure>

<h3 id="分布式主键"><a href="#分布式主键" class="headerlink" title="分布式主键"></a>分布式主键</h3><p>传统数据库软件开发中，主键自动生成技术是基本需求。而各个数据库对于该需求也提供了相应的支持，比如MySQL的自增键，Oracle的自增序列等。 数据分片后，不同数据节点生成全局唯一主键是非常棘手的问题。同一个逻辑表内的不同实际表之间的自增键由于无法互相感知而产生重复主键。 虽然可通过约束自增主键初始值和步长的方式避免碰撞，但需引入额外的运维规则，使解决方案缺乏完整性和可扩展性。</p>
<p>目前有许多第三方解决方案可以完美解决这个问题，如UUID等依靠特定算法自生成不重复键，或者通过引入主键生成服务等。为了方便用户使用、满足不同用户不同使用场景的需求，ShardingSphere不仅提供了内置的分布式主键生成器，例如UUID、SNOWFLAKE、LEAF(进行中)，还抽离出分布式主键生成器的接口，方便用户自行实现自定义的自增主键生成器。</p>
<h4 id="内置的主键生成器"><a href="#内置的主键生成器" class="headerlink" title="内置的主键生成器"></a>内置的主键生成器</h4><p><strong>UUID</strong></p>
<p>采用UUID.randomUUID()的方式产生分布式主键。</p>
<p><strong>SNOWFLAKE</strong></p>
<p>ShardingSphere提供灵活的配置分布式主键生成策略方式。 在分片规则配置模块可配置每个表的主键生成策略，默认使用雪花算法（snowflflake）生成64bit的长整型数据。</p>
<p>雪花算法是由Twitter公布的分布式主键生成算法，它能够保证不同进程主键的不重复性，以及相同进程主键的有序性。</p>
<p>在同一个进程中，它首先是通过时间位保证不重复，如果时间相同则是通过序列位保证。 同时由于时间位是单调递增的，且各个服务器如果大体做了时间同步，那么生成的主键在分布式环境可以认为是总体有序的，这就保证了对索引字段的插入的高效性。例如MySQL的Innodb存储引擎的主键。</p>
<p>使用雪花算法生成的主键，二进制表示形式包含4部分，从高位到低位分表为：1bit符号位、41bit时间戳位、10bit工作进程位以及12bit序列号位。</p>
<ul>
<li><p>符号位(1bit)<br>预留的符号位，恒为零。</p>
</li>
<li><p>时间戳位(41bit)<br>41位的时间戳可以容纳的毫秒数是2的41次幂，一年所使用的毫秒数是： 365 * 24 * 60 * 60 * 1000 。通过计算可知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Math.pow(<span class="number">2</span>, <span class="number">41</span>) / (<span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>

<p>结果约等于69.73年。ShardingSphere的雪花算法的时间纪元从2016年11月1日零点开始，可以使用到2086年，相信能满足绝大部分系统的要求。</p>
</li>
<li><p>工作进程位(10bit)<br>该标志在Java进程内是唯一的，如果是分布式应用部署应保证每个工作进程的id是不同的。该值默认为0，可通过调用静态方法 DefaultKeyGenerator.setWorkerId() 设置。</p>
</li>
<li><p>序列号位(12bit)<br>该序列是用来在同一个毫秒内生成不同的ID。如果在这个毫秒内生成的数量超过4096(2的12次 幂)，那么生成器会等待到下个毫秒继续生成。</p>
</li>
</ul>
<p><strong>时钟回拨</strong></p>
<p>服务器时钟回拨会导致产生重复序列，因此默认分布式主键生成器提供了一个最大容忍的时钟回拨毫秒数。 如果时钟回拨的时间超过最大容忍的毫秒数阈值，则程序报错；如果在可容忍的范围内，默认分布式主键生成器会等待时钟同步到最后一次主键生成的时间后再继续工作。 最大容忍的时钟回拨毫秒数的默认值为0，可通过调用静态方法DefaultKeyGenerator.setMaxTolerateTimeDifferenceMilliseconds() 设置。</p>
<p>雪花算法主键的详细结构见下图。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227195955.png"></p>
<p><strong>LEAF</strong></p>
<p>借鉴美团点评分布式ID生成系统<a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leaf</a>, 借助注册中心生成分布式自增主键。该内置分布式主键算法正在进行中。</p>
<h4 id="配置示例-1"><a href="#配置示例-1" class="headerlink" title="配置示例"></a>配置示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span> </span><br><span class="line">	<span class="attr">tables:</span> </span><br><span class="line">		<span class="attr">t_order:</span> </span><br><span class="line">			<span class="attr">actualDataNodes:</span> <span class="string">ms_ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span> </span><br><span class="line">			<span class="attr">tableStrategy:</span> </span><br><span class="line">				<span class="attr">inline:</span> </span><br><span class="line">					<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">					<span class="attr">algorithmExpression:</span> <span class="string">t_order$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">			<span class="attr">keyGeneratorColumnName:</span> <span class="string">order_id</span> </span><br><span class="line">			<span class="comment">#keyGeneratorClassName: xxx.xxx.XXclass </span></span><br><span class="line">	<span class="comment">#defaultKeyGenerator: </span></span><br><span class="line">		<span class="comment">#type: SNOWFLAKE</span></span><br></pre></td></tr></table></figure>

<h4 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaultKeyGenerator:</span> <span class="comment">#默认的主键生成算法 如果没有设置,默认为SNOWFLAKE算法 </span></span><br><span class="line">	<span class="attr">column:</span> <span class="comment"># 自增键对应的列名称 </span></span><br><span class="line">	<span class="attr">type:</span> <span class="comment">#自增键的类型,主要用于调用内置的主键生成算法有三个可用值:SNOWFLAKE(时间戳 +worker id+自增id),UUID(java.util.UUID类生成的随机UUID),LEAF,其中Snowflake算法 与UUID算法已经实现,LEAF目前(2018-01-14)尚未实现 </span></span><br><span class="line">	<span class="attr">props:</span> <span class="comment"># 定制算法需要设置的参数,比如SNOWFLAKE算法的worker.id与 max.tolerate.time.difference.milliseconds </span></span><br><span class="line"><span class="attr">tables:</span> <span class="comment">#配置表sharding的主要位置 </span></span><br><span class="line">	<span class="attr">sharding_t1:</span> </span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">master_test_$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span> <span class="comment"># sharidng 表对应 的数据源以及物理名称,需要用表达式处理,表示表实际上在哪些数据源存在,配置示例中,意思是总共 存在4个分片 master_test_0.t_order0,master_test_0.t_order1,master_test_1.t_order0,maste r_test_1.t_order1 </span></span><br><span class="line">		<span class="comment"># 需要注意的是,必须保证设置databaseStrategy可以路由到唯一的 dataSource,tableStrategy可以路由到dataSource中唯一的物理表上,否则可能导致错误:一 个insert语句被插入到多个实际物理表中 </span></span><br><span class="line">		<span class="attr">databaseStrategy:</span> <span class="comment"># 局部设置会覆盖全局设置,参考 defaultDatabaseShardingStrategy </span></span><br><span class="line">		<span class="attr">tableStrategy:</span> <span class="comment"># 局部设置会覆盖全局设置,参考defaultTableStrategy </span></span><br><span class="line">		<span class="attr">keyGenerator:</span> <span class="comment"># 局部设置会覆盖全局设置,参考defaultKeyGenerator </span></span><br><span class="line">		<span class="attr">logicIndex:</span> <span class="comment"># 逻辑索引名称 由于Oracle,PG这种数据库中,索引与表共用命名空间,如 果接受到drop index语句,执行之前,会通过这个名称配置的确定对应的实际物理表名称</span></span><br></pre></td></tr></table></figure>

<p>dao SQL语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert(&quot;insert into t_order(order_time,customer_id) values(#&#123;orderTime&#125;,# &#123;customerId&#125;)&quot;)</span> </span><br><span class="line"><span class="keyword">void</span> <span class="title function_">addOrder</span><span class="params">(Order o)</span>;</span><br></pre></td></tr></table></figure>



<h3 id="绑定表"><a href="#绑定表" class="headerlink" title="绑定表"></a>绑定表</h3><p>指分片规则一致的主表和子表。例如：t_order表和t_order_item表，均按照order_id分片，则此两张表互为绑定表关系。绑定表之间的多表关联查询不会出现笛卡尔积关联，关联查询效率将大大提升。</p>
<p>如果SQL为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br></pre></td></tr></table></figure>

<p>在不配置绑定表关系时，假设分片键order_id将数值10路由至第0片，将数值11路由至第1片，那么路由后的SQL应该为4条，它们呈现为笛卡尔积：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_0 o <span class="keyword">JOIN</span> t_order_item_0 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br><span class="line"> <span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_0 o <span class="keyword">JOIN</span> t_order_item_1 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br><span class="line"> <span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_1 o <span class="keyword">JOIN</span> t_order_item_0 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br><span class="line"> <span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_1 o <span class="keyword">JOIN</span> t_order_item_1 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br></pre></td></tr></table></figure>

<p>在配置绑定表关系后，路由的SQL应该为2条：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_0 o <span class="keyword">JOIN</span> t_order_item_0 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">SELECT</span> i.<span class="operator">*</span> <span class="keyword">FROM</span> t_order_1 o <span class="keyword">JOIN</span> t_order_item_1 i <span class="keyword">ON</span> o.order_id<span class="operator">=</span>i.order_id <span class="keyword">WHERE</span> o.order_id <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">11</span>);</span><br></pre></td></tr></table></figure>

<p>其中t_order在FROM的最左侧，ShardingSphere将会以它作为整个绑定表的主表。 所有路由计算将会只使用主表的策略，那么t_order_item表的分片计算将会使用t_order的条件。故绑定表之间的分区键要完全相同。</p>
<h4 id="绑定表配置示例"><a href="#绑定表配置示例" class="headerlink" title="绑定表配置示例"></a>绑定表配置示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span> </span><br><span class="line">	<span class="attr">tables:</span></span><br><span class="line">	<span class="attr">t_order:</span> </span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span></span><br><span class="line">		<span class="attr">tableStrategy:</span> </span><br><span class="line">			<span class="attr">inline:</span></span><br><span class="line">				<span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">				<span class="attr">algorithmExpression:</span> <span class="string">t_order$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">		<span class="attr">keyGenerator:</span></span><br><span class="line">			<span class="attr">column:</span> <span class="string">order_id</span></span><br><span class="line">	<span class="attr">t_order_item:</span></span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">ds$&#123;0..1&#125;.t_order_item$&#123;0..1&#125;</span></span><br><span class="line">		<span class="attr">tableStrategy:</span></span><br><span class="line">			<span class="attr">inline:</span></span><br><span class="line">				<span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">				<span class="attr">algorithmExpression:</span> <span class="string">t_order_item$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">	<span class="attr">bindingTables:</span> <span class="bullet">-</span> <span class="string">t_order,t_order_item</span></span><br></pre></td></tr></table></figure>

<h4 id="绑定表配置说明"><a href="#绑定表配置说明" class="headerlink" title="绑定表配置说明"></a>绑定表配置说明</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bindingTables:</span> <span class="comment"># 绑定表,也就是实际上哪些配置的sharidng表规则需要实际生效的列表,配 置为yaml列表,并且允许单个条目中以逗号切割,所配置表必须已经配置为逻辑表 </span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">sharding_t1</span> </span><br><span class="line">	<span class="bullet">-</span> <span class="string">sharding_t2,sharding_t3</span></span><br></pre></td></tr></table></figure>

<h3 id="广播表"><a href="#广播表" class="headerlink" title="广播表"></a>广播表</h3><p>指所有的分片数据源中都存在的表，表结构和表中的数据在每个数据库中均完全一致。适用于数据量不大且需要与海量数据的表进行关联查询的场景，例如：字典表。</p>
<h4 id="配置示例-2"><a href="#配置示例-2" class="headerlink" title="配置示例"></a>配置示例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shardingRule:</span> </span><br><span class="line">	<span class="attr">bindingTables:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">t_order,t_order_item</span> </span><br><span class="line">	<span class="attr">broadcastTables:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">t_config</span></span><br></pre></td></tr></table></figure>

<h4 id="配置说明-1"><a href="#配置说明-1" class="headerlink" title="配置说明"></a>配置说明</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">broadcastTables:</span> <span class="comment"># 广播表 这里配置的表列表,对于发生的所有数据变更,都会不经 sharidng处理,而是直接发送到所有数据节点,注意此处为列表,每个项目为一个表名称 </span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">broad_1</span> </span><br><span class="line">	<span class="bullet">-</span> <span class="string">broad_2</span></span><br></pre></td></tr></table></figure>

<h3 id="逻辑索引"><a href="#逻辑索引" class="headerlink" title="逻辑索引"></a>逻辑索引</h3><p>某些数据库（如：PostgreSQL）不允许同一个库存在名称相同索引，某些数据库（如：MySQL）则允许只要同一个表中不存在名称相同的索引即可。 逻辑索引用于同一个库不允许出现相同索引名称的分表场景，需要将同库不同表的索引名称改写为 索引名 + 表名 ，改写之前的索引名称成为逻辑索引。</p>
<h2 id="数据分片-读写分离"><a href="#数据分片-读写分离" class="headerlink" title="数据分片+读写分离"></a>数据分片+读写分离</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> </span><br><span class="line">	<span class="attr">ds0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds0</span> </span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">password:</span></span><br><span class="line">	<span class="attr">ds0_slave0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds0_slave0</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds0_slave1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds0_slave1</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds1</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds1_slave0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds1_slave0</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds1_slave1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds1_slave1</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line"><span class="attr">shardingRule:</span> </span><br><span class="line">	<span class="attr">tables:</span> </span><br><span class="line">		<span class="attr">t_order:</span> </span><br><span class="line">			<span class="attr">actualDataNodes:</span> <span class="string">ms_ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span> </span><br><span class="line">			<span class="attr">tableStrategy:</span> </span><br><span class="line">				<span class="attr">inline:</span></span><br><span class="line">                	<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">                	<span class="attr">algorithmExpression:</span> <span class="string">t_order$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">			<span class="attr">keyGenerator:</span> </span><br><span class="line">				<span class="attr">Column:</span> <span class="string">order_id</span> </span><br><span class="line">		<span class="attr">t_order_item:</span> </span><br><span class="line">			<span class="attr">actualDataNodes:</span> <span class="string">ms_ds$&#123;0..1&#125;.t_order_item$&#123;0..1&#125;</span> </span><br><span class="line">			<span class="attr">tableStrategy:</span> </span><br><span class="line">				<span class="attr">inline:</span> </span><br><span class="line">					<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">					<span class="attr">algorithmExpression:</span> <span class="string">t_order_item$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">	<span class="attr">bindingTables:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">t_order,t_order_item</span> </span><br><span class="line">	<span class="attr">broadcastTables:</span> </span><br><span class="line">		<span class="bullet">-</span> <span class="string">t_config</span> </span><br><span class="line"></span><br><span class="line">	<span class="attr">defaultDataSourceName:</span> <span class="string">ds_0</span> </span><br><span class="line">	<span class="attr">defaultDatabaseStrategy:</span> </span><br><span class="line">		<span class="attr">inline:</span> </span><br><span class="line">			<span class="attr">shardingColumn:</span> <span class="string">user_id</span> </span><br><span class="line">			<span class="attr">algorithmExpression:</span> <span class="string">ms_ds$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">	<span class="attr">defaultTableStrategy:</span> </span><br><span class="line">		<span class="attr">none:</span> </span><br><span class="line">	<span class="attr">defaultKeyGenerator:</span> </span><br><span class="line">		<span class="attr">type:</span> <span class="string">SNOWFLAKE</span> </span><br><span class="line"></span><br><span class="line">	<span class="attr">masterSlaveRules:</span> </span><br><span class="line">		<span class="attr">ms_ds0:</span> </span><br><span class="line">			<span class="attr">masterDataSourceName:</span> <span class="string">ds0</span> </span><br><span class="line">			<span class="attr">slaveDataSourceNames:</span> </span><br><span class="line">				<span class="bullet">-</span> <span class="string">ds0_slave0</span> </span><br><span class="line">				<span class="bullet">-</span> <span class="string">ds0_slave1</span> </span><br><span class="line">			<span class="attr">loadBalanceAlgorithmType:</span> <span class="string">ROUND_ROBIN</span> </span><br><span class="line">			<span class="attr">configMap:</span> </span><br><span class="line">				<span class="attr">master-slave-key0:</span> <span class="string">master-slave-value0</span> </span><br><span class="line">		<span class="attr">ms_ds1:</span> </span><br><span class="line">			<span class="attr">masterDataSourceName:</span> <span class="string">ds1</span> </span><br><span class="line">			<span class="attr">slaveDataSourceNames:</span> </span><br><span class="line">				<span class="bullet">-</span> <span class="string">ds1_slave0</span> </span><br><span class="line">				<span class="bullet">-</span> <span class="string">ds1_slave1</span> </span><br><span class="line">			<span class="attr">loadBalanceAlgorithmType:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">			<span class="attr">configMap:</span> </span><br><span class="line">				<span class="attr">master-slave-key1:</span> <span class="string">master-slave-value1</span> </span><br><span class="line"><span class="attr">props:</span> </span><br><span class="line">	<span class="attr">sql.show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>分片时的数据源是读写分离中定义的集群名。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/03-ShardingSphere/04-Sharding-JDBC%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" data-id="clmcxed7900cpu8wa6i402f1t" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/03-ShardingSphere/03-Sharding-JDBC读写分离" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/03-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.919Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC读写分离"><a href="#Sharding-JDBC读写分离" class="headerlink" title="Sharding-JDBC读写分离"></a>Sharding-JDBC读写分离</h1><h2 id="不使用Spring"><a href="#不使用Spring" class="headerlink" title="不使用Spring"></a>不使用Spring</h2><h3 id="引入Maven依赖"><a href="#引入Maven依赖" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Java编码的规则配置"><a href="#基于Java编码的规则配置" class="headerlink" title="基于Java编码的规则配置"></a>基于Java编码的规则配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置真实数据源 </span></span><br><span class="line">Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置主库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">masterDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); masterDataSource.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); masterDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_master&quot;</span>); masterDataSource.setUsername(<span class="string">&quot;root&quot;</span>); masterDataSource.setPassword(<span class="string">&quot;&quot;</span>); dataSourceMap.put(<span class="string">&quot;ds_master&quot;</span>, masterDataSource); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第一个从库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">slaveDataSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); slaveDataSource1.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); slaveDataSource1.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave0&quot;</span>); slaveDataSource1.setUsername(<span class="string">&quot;root&quot;</span>); slaveDataSource1.setPassword(<span class="string">&quot;&quot;</span>); dataSourceMap.put(<span class="string">&quot;ds_slave0&quot;</span>, slaveDataSource1); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第二个从库 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">slaveDataSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>(); slaveDataSource2.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>); slaveDataSource2.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave1&quot;</span>);</span><br><span class="line">slaveDataSource2.setUsername(<span class="string">&quot;root&quot;</span>); slaveDataSource2.setPassword(<span class="string">&quot;&quot;</span>); dataSourceMap.put(<span class="string">&quot;ds_slave1&quot;</span>, slaveDataSource2); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置读写分离规则 </span></span><br><span class="line"><span class="type">MasterSlaveRuleConfiguration</span> <span class="variable">masterSlaveRuleConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MasterSlaveRuleConfiguration</span>(<span class="string">&quot;ds_master_slave&quot;</span>, <span class="string">&quot;ds_master&quot;</span>, Arrays.asList(<span class="string">&quot;ds_slave0&quot;</span>, <span class="string">&quot;ds_slave1&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据源对象 </span></span><br><span class="line"><span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> MasterSlaveDataSourceFactory.createDataSource(createDataSourceMap(), masterSlaveRuleConfig, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;(), <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br></pre></td></tr></table></figure>

<h3 id="基于Yaml的规则配置"><a href="#基于Yaml的规则配置" class="headerlink" title="基于Yaml的规则配置"></a>基于Yaml的规则配置</h3><p>或通过Yaml方式配置，与以上配置等价：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> </span><br><span class="line">	<span class="attr">ds_master:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_master</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds_slave0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_slave0</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds_slave1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds_slave1</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">masterSlaveRule:</span> </span><br><span class="line">	<span class="attr">name:</span> <span class="string">ds_ms</span> </span><br><span class="line">	<span class="attr">masterDataSourceName:</span> <span class="string">ds_master</span> </span><br><span class="line">	<span class="attr">slaveDataSourceNames:</span> [<span class="string">ds_slave0</span>, <span class="string">ds_slave1</span>] </span><br><span class="line">	<span class="attr">props:</span></span><br><span class="line">		<span class="attr">sql.show:</span> <span class="literal">true</span> </span><br><span class="line">	<span class="attr">configMap: key1:</span> <span class="string">value1</span> </span><br><span class="line"></span><br><span class="line"><span class="string">DataSource</span> <span class="string">dataSource</span> <span class="string">=</span> <span class="string">MasterSlaveDataSourceFactory.createDataSource(yamlFile);</span></span><br></pre></td></tr></table></figure>

<h3 id="使用原生JDBC"><a href="#使用原生JDBC" class="headerlink" title="使用原生JDBC"></a>使用原生JDBC</h3><p>通过MasterSlaveDataSourceFactory工厂和规则配置对象获取MasterSlaveDataSource，MasterSlaveDataSource实现自JDBC的标准接口DataSource。然后可通过DataSource选择使用原生JDBC开发，或者使用JPA, MyBatis等ORM工具。 以JDBC原生实现为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> MasterSlaveDataSourceFactory.createDataSource(yamlFile);</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT i.* FROM t_order o JOIN t_order_item i ON o.order_id=i.order_id WHERE o.user_id=? AND o.order_id=?&quot;</span>;</span><br><span class="line"><span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection(); <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> conn.prepareStatement(sql)) &#123;</span><br><span class="line">    preparedStatement.setInt(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    preparedStatement.setInt(<span class="number">2</span>, <span class="number">1001</span>);</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> preparedStatement.executeQuery()) &#123;</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            System.out.println(rs.getInt(<span class="number">1</span>));</span><br><span class="line">            System.out.println(rs.getInt(<span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用Spring"><a href="#使用Spring" class="headerlink" title="使用Spring"></a>使用Spring</h2><h3 id="引入Maven依赖-1"><a href="#引入Maven依赖-1" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- for spring boot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- for spring namespace --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring-boot的规则配置"><a href="#基于Spring-boot的规则配置" class="headerlink" title="基于Spring boot的规则配置"></a>基于Spring boot的规则配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding.jdbc.datasource.names</span>=<span class="string">master,slave0,slave1 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSour ce</span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.url</span>=<span class="string">jdbc:mysql://localhost:3306/master </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.master.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.url</span>=<span class="string">jdbc:mysql://localhost:3306/slave0 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave0.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.url</span>=<span class="string">jdbc:mysql://localhost:3306/slave1 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.slave1.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.name</span>=<span class="string">ms </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.master-data-source-name</span>=<span class="string">master</span></span><br><span class="line"><span class="attr">sharding.jdbc.config.masterslave.slave-data-source-names</span>=<span class="string">slave0,slave1 </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.props.sql.show</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring命名空间的规则配置"><a href="#基于Spring命名空间的规则配置" class="headerlink" title="基于Spring命名空间的规则配置"></a>基于Spring命名空间的规则配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:master-</span> <span class="attr">slave</span>=<span class="string">&quot;http://shardingsphere.io/schema/shardingsphere/masterslave&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://shardingsphere.io/schema/shardingsphere/masterslave http://shardingsphere.io/schema/shardingsphere/masterslave/master- slave.xsd &quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_master&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_master&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_slave0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds_slave1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds_slave1&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">master-slave:data-source</span> <span class="attr">id</span>=<span class="string">&quot;masterSlaveDataSource&quot;</span> <span class="attr">master-data-</span> <span class="attr">source-name</span>=<span class="string">&quot;ds_master&quot;</span> <span class="attr">slave-data-source-names</span>=<span class="string">&quot;ds_slave0, ds_slave1&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;sql.show&quot;</span>&gt;</span>$&#123;sql_show&#125;<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;executor.size&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">master-slave:data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在Spring中使用DataSource"><a href="#在Spring中使用DataSource" class="headerlink" title="在Spring中使用DataSource"></a>在Spring中使用DataSource</h3><p>直接通过注入的方式即可使用DataSource，或者将DataSource配置在JPA、Hibernate或MyBatis中使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span> </span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br></pre></td></tr></table></figure>

<h2 id="配置项说明"><a href="#配置项说明" class="headerlink" title="配置项说明"></a>配置项说明</h2><p>读写分离</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> <span class="comment">#省略数据源配置，与数据分片一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">masterSlaveRule:</span> </span><br><span class="line">	<span class="attr">name:</span> <span class="comment">#读写分离数据源名称，自定义 </span></span><br><span class="line">	<span class="attr">masterDataSourceName:</span> <span class="comment">#主库数据源名称，数据源处定义的数据源名 </span></span><br><span class="line">	<span class="attr">slaveDataSourceNames:</span> <span class="comment">#从库数据源名称列表，数据源处定义的数据源名 </span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&lt;data_source_name1&gt;</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">&lt;data_source_name2&gt;</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">&lt;data_source_name_x&gt;</span> </span><br><span class="line">	<span class="attr">loadBalanceAlgorithmClassName:</span> <span class="comment">#从库负载均衡算法类名称。该类需实现 MasterSlaveLoadBalanceAlgorithm接口且提供无参数构造器 </span></span><br><span class="line">	<span class="attr">loadBalanceAlgorithmType:</span> <span class="comment">#从库负载均衡算法类型，可选值：ROUND_ROBIN， RANDOM。若`loadBalanceAlgorithmClassName`存在则忽略该配置</span></span><br><span class="line">	<span class="attr">props:</span> <span class="comment">#属性配置 </span></span><br><span class="line">		<span class="attr">sql.show:</span> <span class="comment">#是否开启SQL显示，默认值: false </span></span><br><span class="line">		<span class="attr">executor.size:</span> <span class="comment">#工作线程数量，默认值: CPU核数 </span></span><br><span class="line">		<span class="attr">check.table.metadata.enabled:</span> <span class="comment">#是否在启动时检查分表元数据一致性，默认值: </span></span><br><span class="line">	<span class="attr">configMap:</span> <span class="comment">#用户自定义配置 </span></span><br><span class="line">        <span class="attr">key1:</span> <span class="string">value1</span> </span><br><span class="line">        <span class="attr">key2:</span> <span class="string">value2</span> </span><br><span class="line">        <span class="attr">keyx:</span> <span class="string">valuex</span></span><br></pre></td></tr></table></figure>








      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/03-ShardingSphere/03-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" data-id="clmcxed7b00cqu8wa7xtz4c9o" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/03-ShardingSphere/02-ShardingJDBC入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/02-ShardingJDBC%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.910Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC配置使用"><a href="#Sharding-JDBC配置使用" class="headerlink" title="Sharding-JDBC配置使用"></a>Sharding-JDBC配置使用</h1><h2 id="Sharding-JDBC入门使用"><a href="#Sharding-JDBC入门使用" class="headerlink" title="Sharding - JDBC入门使用"></a>Sharding - JDBC入门使用</h2><p>Sharding-JDBC使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。</p>
<h2 id="不使用Spring"><a href="#不使用Spring" class="headerlink" title="不使用Spring"></a>不使用Spring</h2><h3 id="引入Maven依赖"><a href="#引入Maven依赖" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Java编码的规则配置"><a href="#基于Java编码的规则配置" class="headerlink" title="基于Java编码的规则配置"></a>基于Java编码的规则配置</h3><p>Sharding-JDBC的分库分表通过规则配置描述，以下例子是根据user_id取模分库, 且根据order_id取模分表的两库两表的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置真实数据源 </span></span><br><span class="line">Map &lt; String, DataSource &gt; dataSourceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span> &lt; &gt; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第一个数据源 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">dataSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">dataSource1.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">dataSource1.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds0&quot;</span>);</span><br><span class="line">dataSource1.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">dataSource1.setPassword(<span class="string">&quot;&quot;</span>);</span><br><span class="line">dataSourceMap.put(<span class="string">&quot;ds0&quot;</span>, dataSource1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置第二个数据源 </span></span><br><span class="line"><span class="type">BasicDataSource</span> <span class="variable">dataSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">dataSource2.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">dataSource2.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/ds1&quot;</span>);</span><br><span class="line">dataSource2.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">dataSource2.setPassword(<span class="string">&quot;&quot;</span>);</span><br><span class="line">dataSourceMap.put(<span class="string">&quot;ds1&quot;</span>, dataSource2); <span class="comment">// 配置Order表规则</span></span><br><span class="line"><span class="type">TableRuleConfiguration</span> <span class="variable">orderTableRuleConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TableRuleConfiguration</span>();</span><br><span class="line">orderTableRuleConfig.setLogicTable(<span class="string">&quot;t_order&quot;</span>);</span><br><span class="line">orderTableRuleConfig.setActualDataNodes(<span class="string">&quot;ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置分库 + 分表策略 </span></span><br><span class="line">orderTableRuleConfig.setDatabaseShardingStrategyConfig(<span class="keyword">new</span> <span class="title class_">InlineShardingStrategyConfiguration</span>(<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;ds$&#123;user_id % 2&#125;&quot;</span>));</span><br><span class="line">orderTableRuleConfig.setTableShardingStrategyConfig(<span class="keyword">new</span> <span class="title class_">InlineShardingStrategyConfiguration</span>(<span class="string">&quot;order_id&quot;</span>, <span class="string">&quot;t_order$&#123;order_id % 2&#125;&quot;</span>));</span><br><span class="line"><span class="comment">// 配置分片规则 </span></span><br><span class="line"><span class="type">ShardingRuleConfiguration</span> <span class="variable">shardingRuleConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShardingRuleConfiguration</span>();</span><br><span class="line">shardingRuleConfig.getTableRuleConfigs().add(orderTableRuleConfig);</span><br><span class="line"><span class="comment">// 省略配置order_item表规则... </span></span><br><span class="line"><span class="comment">// ... </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取数据源对象 </span></span><br><span class="line"><span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRuleConfig, <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>(), <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br></pre></td></tr></table></figure>

<h3 id="基于Yaml的规则配置"><a href="#基于Yaml的规则配置" class="headerlink" title="基于Yaml的规则配置"></a>基于Yaml的规则配置</h3><p>或通过Yaml方式配置，与以上配置等价：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> </span><br><span class="line">	<span class="attr">ds0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds0</span> </span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">        <span class="attr">password:</span> </span><br><span class="line">    <span class="attr">ds1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">    	<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">    	<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds1</span> </span><br><span class="line">    	<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">    	<span class="attr">password:</span> </span><br><span class="line"><span class="attr">tables:</span></span><br><span class="line">	<span class="attr">t_order:</span> </span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">ds$&#123;0..1&#125;.t_order$&#123;0..1&#125;</span> </span><br><span class="line">		<span class="attr">databaseStrategy:</span> </span><br><span class="line">			<span class="attr">inline:</span> </span><br><span class="line">				<span class="attr">shardingColumn:</span> <span class="string">user_id</span> </span><br><span class="line">				<span class="attr">algorithmInlineExpression:</span> <span class="string">ds$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">		<span class="attr">tableStrategy:</span> </span><br><span class="line">			<span class="attr">inline:</span> </span><br><span class="line">				<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">				<span class="attr">algorithmInlineExpression:</span> <span class="string">t_order$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">	<span class="attr">t_order_item:</span> </span><br><span class="line">		<span class="attr">actualDataNodes:</span> <span class="string">ds$&#123;0..1&#125;.t_order_item$&#123;0..1&#125;</span> </span><br><span class="line">		<span class="attr">databaseStrategy:</span> </span><br><span class="line">			<span class="attr">inline:</span></span><br><span class="line">            	<span class="attr">shardingColumn:</span> <span class="string">user_id</span> </span><br><span class="line">            	<span class="attr">algorithmInlineExpression:</span> <span class="string">ds$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line">		<span class="attr">tableStrategy:</span> </span><br><span class="line">			<span class="attr">inline:</span> </span><br><span class="line">				<span class="attr">shardingColumn:</span> <span class="string">order_id</span> </span><br><span class="line">				<span class="attr">algorithmInlineExpression:</span> <span class="string">t_order_item$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> </span><br><span class="line"></span><br><span class="line"><span class="string">DataSource</span> <span class="string">dataSource</span> <span class="string">=</span> <span class="string">YamlShardingDataSourceFactory.createDataSource(yamlFile);</span></span><br></pre></td></tr></table></figure>

<h3 id="使用原生JDBC"><a href="#使用原生JDBC" class="headerlink" title="使用原生JDBC"></a>使用原生JDBC</h3><p>通过ShardingDataSourceFactory或者YamlShardingDataSourceFactory工厂和规则配置对象获取ShardingDataSource，ShardingDataSource实现自JDBC的标准接口DataSource。然后可通过DataSource选择使用原生JDBC开发，或者使用JPA, MyBatis等ORM工具。 以JDBC原生实现为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> YamlShardingDataSourceFactory.createDataSource(yamlFile);</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT i.* FROM t_order o JOIN t_order_item i ON o.order_id=i.order_id WHERE o.user_id=? AND o.order_id=?&quot;</span>;</span><br><span class="line"><span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> dataSource.getConnection(); <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> conn.prepareStatement(sql)) &#123;</span><br><span class="line">    preparedStatement.setInt(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    preparedStatement.setInt(<span class="number">2</span>, <span class="number">1001</span>);</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> preparedStatement.executeQuery()) &#123;</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            System.out.println(rs.getInt(<span class="number">1</span>));</span><br><span class="line">            System.out.println(rs.getInt(<span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用Spring"><a href="#使用Spring" class="headerlink" title="使用Spring"></a>使用Spring</h2><h3 id="引入Maven依赖-1"><a href="#引入Maven依赖-1" class="headerlink" title="引入Maven依赖"></a>引入Maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- for spring boot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- for spring namespace --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring-boot的规则配置"><a href="#基于Spring-boot的规则配置" class="headerlink" title="基于Spring boot的规则配置"></a>基于Spring boot的规则配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding.jdbc.datasource.names</span>=<span class="string">ds0,ds1 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.type</span>=<span class="string">org.apache.commons.dbcp2.BasicDataSource </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.url</span>=<span class="string">jdbc:mysql://localhost:3306/ds0 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.type</span>=<span class="string">org.apache.commons.dbcp2.BasicDataSource </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.url</span>=<span class="string">jdbc:mysql://localhost:3306/ds1 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.username</span>=<span class="string">root sharding.jdbc.datasource.ds1.password=</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.default-database-strategy.inline.sharding-column</span>=<span class="string">user_id </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.default-database-strategy.inline.algorithm-expression</span>=<span class="string">ds$-&gt;&#123;user_id % 2&#125; </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order.actual-data-nodes</span>=<span class="string">ds$-&gt; &#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125; </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order.table-</span> <span class="string">strategy.inline.sharding-column=order_id </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order.table-</span> <span class="string">strategy.inline.algorithm-expression=t_order$-&gt;&#123;order_id % 2&#125; </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order_item.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order_item$-&gt;&#123;0..1&#125; </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order_item.table-strategy.inline.sharding-column</span>=<span class="string">order_id </span></span><br><span class="line"><span class="attr">sharding.jdbc.config.sharding.tables.t_order_item.table-</span> <span class="string">strategy.inline.algorithm-expression=t_order_item$-&gt;&#123;order_id % 2&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="基于Spring命名空间的规则配置"><a href="#基于Spring命名空间的规则配置" class="headerlink" title="基于Spring命名空间的规则配置"></a>基于Spring命名空间的规则配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:sharding</span>=<span class="string">&quot;http://shardingsphere.io/schema/shardingsphere/sharding&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://shardingsphere.io/schema/shardingsphere/sharding http://shardingsphere.io/schema/shardingsphere/sharding/sharding.xsd &quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/ds1&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sharding:inline-strategy</span> <span class="attr">id</span>=<span class="string">&quot;databaseStrategy&quot;</span> <span class="attr">sharding-</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">algorithm-expression</span>=<span class="string">&quot;ds$-&gt;&#123;user_id % 2&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sharding:inline-strategy</span> <span class="attr">id</span>=<span class="string">&quot;orderTableStrategy&quot;</span> <span class="attr">sharding-</span> <span class="attr">column</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">algorithm-expression</span>=<span class="string">&quot;t_order$-&gt;&#123;order_id % 2&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sharding:inline-strategy</span> <span class="attr">id</span>=<span class="string">&quot;orderItemTableStrategy&quot;</span> <span class="attr">sharding-</span> <span class="attr">column</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">algorithm-expression</span>=<span class="string">&quot;t_order_item$-&gt;&#123;order_id % 2&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sharding:data-source</span> <span class="attr">id</span>=<span class="string">&quot;shardingDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sharding:sharding-rule</span> <span class="attr">data-source-names</span>=<span class="string">&quot;ds0,ds1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sharding:table-rules</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sharding:table-rule</span> <span class="attr">logic-table</span>=<span class="string">&quot;t_order&quot;</span> <span class="attr">actual-data-</span> <span class="attr">nodes</span>=<span class="string">&quot;ds$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;&quot;</span> <span class="attr">database-strategy-</span> <span class="attr">ref</span>=<span class="string">&quot;databaseStrategy&quot;</span> <span class="attr">table-strategy-ref</span>=<span class="string">&quot;orderTableStrategy&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sharding:table-rule</span> <span class="attr">logic-table</span>=<span class="string">&quot;t_order_item&quot;</span> <span class="attr">actual-</span> <span class="attr">data-nodes</span>=<span class="string">&quot;ds$-&gt;&#123;0..1&#125;.t_order_item$-&gt;&#123;0..1&#125;&quot;</span> <span class="attr">database-strategy-</span> <span class="attr">ref</span>=<span class="string">&quot;databaseStrategy&quot;</span> <span class="attr">table-strategy-ref</span>=<span class="string">&quot;orderItemTableStrategy&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">sharding:table-rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sharding:sharding-rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sharding:data-source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在Spring中使用DataSource"><a href="#在Spring中使用DataSource" class="headerlink" title="在Spring中使用DataSource"></a>在Spring中使用DataSource</h3><p>直接通过注入的方式即可使用DataSource，或者将DataSource配置在JPA、Hibernate或MyBatis中使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br></pre></td></tr></table></figure>



<h2 id="数据源配置"><a href="#数据源配置" class="headerlink" title="数据源配置"></a>数据源配置</h2><h3 id="yaml格式"><a href="#yaml格式" class="headerlink" title="yaml格式"></a>yaml格式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> </span><br><span class="line">	<span class="attr">ds0:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds0</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line">	<span class="attr">ds1:</span> <span class="type">!!org.apache.commons.dbcp.BasicDataSource</span> </span><br><span class="line">		<span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">		<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ds1</span> </span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> </span><br><span class="line">		<span class="attr">password:</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">props:</span> </span><br><span class="line">	<span class="attr">sql.show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="spring-boot-配置"><a href="#spring-boot-配置" class="headerlink" title="spring boot 配置"></a>spring boot 配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding.jdbc.datasource.names</span>=<span class="string">ds0,ds1 </span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.url</span>=<span class="string">jdbc:mysql://localhost:3306/ds0 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds0.password</span>= <span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.type</span>=<span class="string">org.apache.commons.dbcp.BasicDataSource </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.url</span>=<span class="string">jdbc:mysql://localhost:3306/ds1 </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.username</span>=<span class="string">root </span></span><br><span class="line"><span class="attr">sharding.jdbc.datasource.ds1.password</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="数据源配置说明"><a href="#数据源配置说明" class="headerlink" title="数据源配置说明"></a>数据源配置说明</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataSources:</span> <span class="comment"># 配置数据源列表,必须是有效的jdbc配置,目前仅支持MySQL与PostgreSQL,另 外通过一些未公开(代码中可查,但可能会在未来有变化)的变量,可以配置来兼容其他支持JDBC的数 据库,但由于没有足够的测试支持,可能会有严重的兼容性问题,配置时候要求至少有一个 </span></span><br><span class="line">	<span class="attr">master_ds_0:</span> <span class="comment"># 数据源名称,可以是合法的字符串,目前的校验规则中,没有强制性要求,只要是 合法的yaml字符串即可,但如果要用于分库分表配置,则需要有有意义的标志(在分库分表配置中详 述),以下为目前公开的合法配置项目,不包含内部配置参数 # 以下参数为必备参数 </span></span><br><span class="line">		<span class="attr">url:</span> <span class="string">•jdbc:mysql://127.0.0.1:3306/demo_ds_slave_1?</span> <span class="string">serverTimezone=UTC&amp;useSSL=false</span> <span class="comment"># 这里的要求合法的jdbc连接串即可,目前尚未兼容 MySQL 8.x,需要在maven编译时候,升级MySQL JDBC版本到5.1.46或者47版本(不建议升级到 JDBC的8.x系列版本,需要修改源代码,并且无法通过很多测试case) </span></span><br><span class="line">		<span class="attr">username:</span> <span class="string">root</span> <span class="comment"># MySQL用户名 </span></span><br><span class="line">		<span class="attr">password:</span> <span class="string">password</span> <span class="comment"># MySQL用户的明文密码 # 以下参数为可选参数,给出示例为默认配置,主要用于连接池控制 </span></span><br><span class="line">		<span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span> <span class="comment">#连接超时控制 </span></span><br><span class="line">		<span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span> <span class="comment"># 连接空闲时间设置 </span></span><br><span class="line">		<span class="attr">maxLifetimeMilliseconds:</span> <span class="number">0</span> <span class="comment"># 连接的最大持有时间,0为无限制 </span></span><br><span class="line">		<span class="attr">maxPoolSize:</span> <span class="number">50</span> <span class="comment"># 连接池中最大维持的连接数量 </span></span><br><span class="line">		<span class="attr">minPoolSize:</span> <span class="number">1</span> <span class="comment"># 连接池的最小连接数量 </span></span><br><span class="line">		<span class="attr">maintenanceIntervalMilliseconds:</span> <span class="number">30000</span> <span class="comment"># 连接维护的时间间隔 atomikos框架需 求</span></span><br></pre></td></tr></table></figure>

<h2 id="属性配置"><a href="#属性配置" class="headerlink" title="属性配置"></a>属性配置</h2><h3 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props:</span> </span><br><span class="line">	<span class="attr">sql.show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="可配置属性说明"><a href="#可配置属性说明" class="headerlink" title="可配置属性说明"></a>可配置属性说明</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props:</span> </span><br><span class="line">	<span class="attr">sql.show:</span> <span class="comment">#是否开启SQL显示，默认值: false </span></span><br><span class="line">	<span class="attr">acceptor.size:</span> <span class="comment"># accept连接的线程数量,默认为cpu核数2倍 </span></span><br><span class="line">	<span class="attr">executor.size:</span> <span class="comment">#工作线程数量最大，默认值: 无限制 </span></span><br><span class="line">	<span class="attr">max.connections.size.per.query:</span> <span class="comment"># 每个查询可以打开的最大连接数量,默认为1 </span></span><br><span class="line">	<span class="attr">check.table.metadata.enabled:</span> <span class="comment">#是否在启动时检查分表元数据一致性，默认值: false </span></span><br><span class="line">	<span class="attr">proxy.frontend.flush.threshold:</span> <span class="comment"># proxy的服务时候,对于单个大查询,每多少个网络 包返回一次 </span></span><br><span class="line">	<span class="attr">proxy.transaction.type:</span> <span class="comment"># 默认LOCAL,proxy的事务模型 允许LOCAL,XA,BASE三个值 LOCAL无分布式事务,XA则是采用atomikos实现的分布式事务 BASE目前尚未实现 </span></span><br><span class="line">	<span class="attr">proxy.opentracing.enabled:</span> <span class="comment"># 是否启用</span></span><br><span class="line">	<span class="attr">opentracing proxy.backend.use.nio:</span> <span class="comment"># 是否采用netty的NIO机制连接后端数据库,默认False ,使用 epoll机制 </span></span><br><span class="line">	<span class="attr">proxy.backend.max.connections:</span> <span class="comment"># 使用NIO而非epoll的话,proxy后台连接每个netty 客户端允许的最大连接数量(注意不是数据库连接限制) 默认为8 </span></span><br><span class="line">	<span class="attr">proxy.backend.connection.timeout.seconds:</span> <span class="comment">#使用nio而非epoll的话,proxy后台连 接的超时时间,默认60s</span></span><br></pre></td></tr></table></figure>

<h2 id="spring-boot-示例"><a href="#spring-boot-示例" class="headerlink" title="spring boot 示例"></a>spring boot 示例</h2><h3 id="maven-依赖-pom-xml"><a href="#maven-依赖-pom-xml" class="headerlink" title="maven 依赖 pom.xml"></a>maven 依赖 pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.study.mike<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-study<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sharding-jdbc-study<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置-application-yml"><a href="#配置-application-yml" class="headerlink" title="配置 application.yml"></a>配置 application.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding:</span> </span><br><span class="line">	<span class="attr">jdbc:</span> </span><br><span class="line">		<span class="attr">datasource:</span> </span><br><span class="line">			<span class="attr">names:</span> <span class="string">ds0,ds1</span> </span><br><span class="line">			<span class="attr">ds0:</span></span><br><span class="line">				<span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> </span><br><span class="line">				<span class="attr">driver-class:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">				<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db1?</span> <span class="string">useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span> </span><br><span class="line">				<span class="attr">username:</span> <span class="string">mike</span> </span><br><span class="line">				<span class="attr">password:</span> <span class="string">Mike666!</span> </span><br><span class="line">				<span class="attr">maxPoolSize:</span> <span class="number">50</span> </span><br><span class="line">				<span class="attr">minPoolSize:</span> <span class="number">1</span> </span><br><span class="line">			<span class="attr">ds1:</span></span><br><span class="line">				<span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> </span><br><span class="line">				<span class="attr">driver-class:</span> <span class="string">com.mysql.jdbc.Driver</span> </span><br><span class="line">				<span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db2?</span> <span class="string">useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span> </span><br><span class="line">				<span class="attr">username:</span> <span class="string">mike</span> </span><br><span class="line">				<span class="attr">password:</span> <span class="string">Mike666!</span> </span><br><span class="line">				<span class="attr">maxPoolSize:</span> <span class="number">50</span> </span><br><span class="line">				<span class="attr">minPoolSize:</span> <span class="number">1</span> </span><br><span class="line">		<span class="attr">config:</span></span><br><span class="line">			<span class="attr">sharding:</span> </span><br><span class="line">				<span class="attr">default-data-source-name:</span> <span class="string">ds0</span> </span><br><span class="line">			<span class="attr">props:</span> </span><br><span class="line">				<span class="attr">sql.show:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/03-ShardingSphere/02-ShardingJDBC%E5%85%A5%E9%97%A8/" data-id="clmcxed6u00cou8wa81v52t3e" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-11-MySQL/03-ShardingSphere/01-ShardingSphere概览" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/10/11-MySQL/03-ShardingSphere/01-ShardingSphere%E6%A6%82%E8%A7%88/" class="article-date">
  <time class="dt-published" datetime="2023-09-10T03:59:08.902Z" itemprop="datePublished">2023-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Sharding-JDBC用途、使用场景、架构"><a href="#Sharding-JDBC用途、使用场景、架构" class="headerlink" title="Sharding-JDBC用途、使用场景、架构"></a>Sharding-JDBC用途、使用场景、架构</h1><h2 id="认识ShardingSphere"><a href="#认识ShardingSphere" class="headerlink" title="认识ShardingSphere"></a>认识ShardingSphere</h2><p>ShardingSphere是一套开源的分布式数据库中间件解决方案组成的生态圈，它由Sharding-JDBC、Sharding-Proxy和Sharding-Sidecar（计划中）这3款相互独立的产品组成。 他们均提供标准化的数据分片、分布式事务和数据库治理功能，可适用于如Java同构、异构语言、容器、云原生等各种多样化的应用场景。</p>
<p>当前版本：3.0</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/index_zh.html">https://shardingsphere.apache.org/index_zh.html</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/overview/">https://shardingsphere.apache.org/document/current/cn/overview/</a></p>
<h2 id="认识ShardingSphere-1"><a href="#认识ShardingSphere-1" class="headerlink" title="认识ShardingSphere"></a>认识ShardingSphere</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227165321.png"></p>
<h2 id="认识Sharding-JDBC"><a href="#认识Sharding-JDBC" class="headerlink" title="认识Sharding-JDBC"></a>认识Sharding-JDBC</h2><p><strong>Sharding-JDBC：</strong>定位为轻量级Java框架，在Java的JDBC层提供的额外服务。 它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。 </p>
<ul>
<li>适用于任何基于Java的ORM框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template或直接使用JDBC。 </li>
<li>基于任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP等。 </li>
<li>支持任意实现JDBC规范的数据库。目前支持MySQL，Oracle，SQLServer和PostgreSQL。</li>
</ul>
<h2 id="Sharding-JDBC功能架构图"><a href="#Sharding-JDBC功能架构图" class="headerlink" title="Sharding-JDBC功能架构图"></a>Sharding-JDBC功能架构图</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227165454.png"></p>
<h2 id="认识Sharding-Proxy"><a href="#认识Sharding-Proxy" class="headerlink" title="认识Sharding-Proxy"></a>认识Sharding-Proxy</h2><p><strong>Sharding-Proxy</strong>：定位为透明化的数据库代理端，提供封装了数据库二进制协议的服务端版本，用于完成对异构语言的支持。 目前先提供MySQL版本，它可以使用任何兼容MySQL协议的访问客户端(如：MySQL Command Client, MySQL Workbench等)操作数据，对DBA更加友好。</p>
<ul>
<li>向应用程序完全透明，可直接当做MySQL使用。 </li>
<li>适用于任何兼容MySQL协议的客户端。</li>
</ul>
<h2 id="认识Sharding-Proxy功能架构图"><a href="#认识Sharding-Proxy功能架构图" class="headerlink" title="认识Sharding-Proxy功能架构图"></a>认识Sharding-Proxy功能架构图</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227165545.png"></p>
<h2 id="三个组件对比认识"><a href="#三个组件对比认识" class="headerlink" title="三个组件对比认识"></a>三个组件对比认识</h2><table>
<thead>
<tr>
<th></th>
<th>Sharding-JDBC</th>
<th>Sharding-Proxy</th>
<th>Sharding-Sidecar</th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>任意</td>
<td>MySQL</td>
<td>MySQL</td>
</tr>
<tr>
<td>连接消耗数</td>
<td>高</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>异构语言</td>
<td>仅Java</td>
<td>任意</td>
<td>任意</td>
</tr>
<tr>
<td>性能</td>
<td>损耗低</td>
<td>损耗略高</td>
<td>损耗低</td>
</tr>
<tr>
<td>无中心化</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>静态入口</td>
<td>无</td>
<td>有</td>
<td>无</td>
</tr>
</tbody></table>
<h2 id="混合架构"><a href="#混合架构" class="headerlink" title="混合架构"></a>混合架构</h2><p>Sharding-JDBC采用无中心化架构，适用于Java开发的高性能的轻量级OLTP应用；Sharding-Proxy提供静态入口以及异构语言的支持，适用于OLAP应用以及对分片数据库进行管理和运维的场景。</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227165823.png"></p>
<p>ShardingSphere是多接入端共同组成的生态圈。通过混合使用Sharding-JDBC和Sharding-Proxy，并采用同一注册中心统一配置分片策略，能够灵活的搭建适用于各种场景的应用系统，架构师可以更加自由的调整适合于当前业务的最佳系统架构。</p>
<h2 id="ShardingSphere功能清单"><a href="#ShardingSphere功能清单" class="headerlink" title="ShardingSphere功能清单"></a>ShardingSphere功能清单</h2><p><strong>数据分片：</strong> </p>
<ul>
<li>分库 &amp; 分表</li>
<li>读写分离</li>
<li>分布式主键</li>
</ul>
<p><strong>分布式事务（doing）：</strong> </p>
<ul>
<li>XA强一致事务</li>
<li>柔性事务</li>
</ul>
<p><strong>数据库治理：</strong></p>
<ul>
<li>配置动态化</li>
<li>熔断 &amp; 禁用</li>
<li>调用链路追踪</li>
<li>弹性伸缩 (Planning)</li>
</ul>
<h2 id="ShardingSphere数据分片内核工作原理"><a href="#ShardingSphere数据分片内核工作原理" class="headerlink" title="ShardingSphere数据分片内核工作原理"></a>ShardingSphere数据分片内核工作原理</h2><p>ShardingSphere的3个产品的数据分片主要流程是完全一致的</p>
<p>核心由SQL解析 &#x3D;&gt; 执行器优化 &#x3D;&gt; SQL路由 &#x3D;&gt; SQL改写 &#x3D;&gt; SQL执行 &#x3D;&gt; 结果归并的流程组成</p>
<p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227170002.png"></p>
<h2 id="规划路线图"><a href="#规划路线图" class="headerlink" title="规划路线图"></a>规划路线图</h2><p><img src="https://raw.githubusercontent.com/chengchen901/img/master/blog/20221227170028.png"></p>
<h1 id="Sharding-JDBC事务应用与数据治理"><a href="#Sharding-JDBC事务应用与数据治理" class="headerlink" title="Sharding-JDBC事务应用与数据治理"></a>Sharding-JDBC事务应用与数据治理</h1><h2 id="Sharding-JDBC-分布式事务应用"><a href="#Sharding-JDBC-分布式事务应用" class="headerlink" title="Sharding-JDBC-分布式事务应用"></a>Sharding-JDBC-分布式事务应用</h2><p>Spring-boot-starter 方式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>业务代码中应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.LOCAL)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">或</span><br><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.XA)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br></pre></td></tr></table></figure>

<p>注意：@ShardingTransactionType需要同Spring的@Transactional配套使用，事务才会生效。</p>
<p><strong>Atomikos参数配置</strong></p>
<p>ShardingSphere默认的XA事务管理器为Atomikos。 可以通过在项目的classpath中添加jta.properties来定制化Atomikos配置项。 具体的配置规则请参考Atomikos的官方文档。</p>
<h2 id="Sharding-JDBC-数据治理-配置中心"><a href="#Sharding-JDBC-数据治理-配置中心" class="headerlink" title="Sharding-JDBC-数据治理-配置中心"></a>Sharding-JDBC-数据治理-配置中心</h2><p><strong>实现动机</strong></p>
<ul>
<li>配置集中心化：越来越多的运行时实例，使得散落的配置难于管理，配置不同步导致的问题分严重。将配置集中于配置中心，可以更加有效进行管理。</li>
<li>配置动态化：配置修改后的分发，是配置中心可以提供的另一个重要能力。它可支持数据源、 表与分片及读写分离策略的动态切换。</li>
</ul>
<p>参考链接： <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/shardingjdbc/usage/orchestration/">https://shardingsphere.apache.org/document/current/cn/manual/shardingjdbc/usage/orchestration/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/10/11-MySQL/03-ShardingSphere/01-ShardingSphere%E6%A6%82%E8%A7%88/" data-id="clmcxed6f00cnu8waa1urhj5e" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/K8s/">K8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQ/">MQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Socker/">Socker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/" rel="tag">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/" rel="tag">CDH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dubbo/" rel="tag">Dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/" rel="tag">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDTree/" rel="tag">KDTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/" rel="tag">Netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socker/" rel="tag">Socker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/" rel="tag">Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YARN/" rel="tag">YARN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E8%A7%A3/" rel="tag">注解</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" rel="tag">集合源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/Docker/" style="font-size: 18px;">Docker</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/Golang/" style="font-size: 19px;">Golang</a> <a href="/tags/HDFS/" style="font-size: 10px;">HDFS</a> <a href="/tags/K8s/" style="font-size: 10px;">K8s</a> <a href="/tags/KDTree/" style="font-size: 10px;">KDTree</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/MapReduce/" style="font-size: 10px;">MapReduce</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Mybatis/" style="font-size: 14px;">Mybatis</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/RPC/" style="font-size: 11px;">RPC</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/Redis/" style="font-size: 17px;">Redis</a> <a href="/tags/Socker/" style="font-size: 10px;">Socker</a> <a href="/tags/Spark/" style="font-size: 11px;">Spark</a> <a href="/tags/Spring/" style="font-size: 20px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 14px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/Tomcat/" style="font-size: 13px;">Tomcat</a> <a href="/tags/YARN/" style="font-size: 11px;">YARN</a> <a href="/tags/ZooKeeper/" style="font-size: 12px;">ZooKeeper</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 16px;">多线程</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 10px;">注解</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11px;">设计模式</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/" style="font-size: 13px;">集合源码</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/05-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E6%90%AD%E5%BB%BA%E6%89%8B%E5%86%8C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/04-Sharding-JDBC%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/03-MyCat%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/02-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/09/10/11-MySQL/04-MySQL%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/01-MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>